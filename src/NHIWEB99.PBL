.----------------------------------------------------------------------
. Program       : NHIWEB99
.
. Function      : NHI/MWS Update Interface
.
. Modifications : 
.----------------------------------------------------------------------
. V12.00.03 04/09/2025  Zumin Yu  TSK 0939593
.           Added update type display tag - RESI0160
. V12.00.02 30.05.2025  DA Sarkies      TSK 0955096
.            Updated for Alpha-Numeric Visit Number
. V11.05.01 21/11/2024  Bella Turco    TSK 0911922
.           Don't blank out Preferred Given Name when double updating NHI
.           details and not altering Preferred radio button (UPDNHI20)
. V11.04.07 31/10/2024  Bella Turco    TSK 0911922
.           Blank out Preferred Given Name when Preferred name indicator set to
.           Given 1st & 'Save to Local' checkbox functionality (UPDNHI20)
. V11.04.06 28/10/2024  Ebon Clements  TSK 0948906
.           Recompiled for NSHISWIO - GETMWS AE2034 Unrecoverable read error
. V11.04.05 16/10/2024  Alina Bhari    TSK 0938763
.           Recompiled for PATCOMN2 changes
. V11.04.04 11/10/2024  Alina Bhari    TSK 0946636
.           Recompiled for UPDUR changes
. V11.04.03 03/10/2024  Alina Bhari    TSK 0938763
.           Recompiled for PATCOMN2 changes
. V11.04.02 30/09/2024  Alina Bhari    TSK 0938763
.           Changed the error message  - XVALUR90                          
.           Recompiled for PATCOMN2 changes                                
. V11.04.01 23/11/2023  Ebon Clements  TSK 0939309
.           Uppercase NHMASURN, NHMAGIV1, NHMAGIV2 and NHMAGIV3 in FORNAM00
.           before alias test and creation
. V11.02.09 26/05/2022  Sunny          TSK 0899628
.           Added VSXPST00 - update visit extension with postcode (if changed)
. V11.02.08 07.04.2022  DA Sarkies     TSK 0887346
.           Added function to check DHB Facility code and to display the name
.           that relates to the code
. V11.02.07 01/04/2022  Thanh T        TSK 0903453
.           Added SPPXUCC4, SPPXUCC5, SPPXATF1 and SPPXATF2 for
.           DEATHAUD changes         
. V11.02.06 03/03/2022  Jill Parkinson Task 0907862
.           Added uppercase of name and address fields in ADDLOC00
.           and UPDLOC00. This is when retrieving national details
. V11.02.05 01/02/2022  Thanh T        TSK 0877055
.           Changed DEATHA00 to write out pmsaudaf for name and address
.           changes
. V11.02.04 10/02/2022  Thanh T        TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.03 03/02/2022  Thanh T        TSK 0877055
.           Recompiled as DEATHAUD changes
. V11.02.02 01/02/2022  Thanh T        TSK 0877055
.           Changed DEATHA00 to write out pmsaudaf for name and address
.           changes
. V11.02.01 28/01/2022  Thanh T        TSK 0877055
.           Changed DEATHA00 to write out pmsaudaf for name and address
.           changes
. V11.01.03 17/12/2021  Thanh T        TSK 0877055
.           Added DEATHA00 to write out pmsaudaf for Ethicity and
.           residency changes
. V11.01.02 15/09/2021  Thanh T        TSK 0889595             
.           Recompiled for PMSDAUFD/DEATHAUD changes                     
. V11.01.01 28.06.2021  DA SARKIES     TSK 0898410
.           Recompiled for UPDUR changes 
. V11.00.10 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.09 16/10/2020  Jill Parkinson Task 0896869
.           More changes on returning sex from national using hdp
. V11.00.08 07/10/2020  Jill Parkinson Task 0896869
.           Mods to select sex bought back from national using hdp
. V11.00.07 05/10/2020  Jill Parkinson Task 0896869
.           Corrected to use NZIBSEX instead of NHIBSEX
. V11.00.06 07/07/2020  Davin          TSK 0864683
.           Write audit to pmsdauaf for NHI MWS Local Edits (WRTDAU00)
. V11.00.05 30/06/2020  Jill Parkinson Task 0891932
.           Removed code to change PSEX=O to be U
. V11.00.04 23/06/2020  Peter Vela     Task 0878550
.           Recompiled for DEATHAUD
. V11.00.03 10/06/2020  Peter Vela     Task 0878550
.           Recompiled for DEATHAUD
. V11.00.02 27/04/2020  Jill Parkinson Task 0879163
.           Mods to return gender from nhi when registering only
. V11.00.01 27/03/2020  Jill Parkinson Task 0879163
.           Recompiled for NHIMASTM - Sex now using category G
.           Added use of Category G HDP for sex in NHI update/read
. V10.15.04 20/02/2020  Peter Vela      TSK 0887845
.           Recompiled for NZHISWIO
.           20/02/2020  Thanh T        TSK 0887600
.           Added Gender Diversity functionality. Changed SETPMI00 to
.           oevrride PSEX with 'U' if it is 'O'
. V10.15.03 17/12/2019  Nicole Torrisi TSK 0853899
.           Changed to exit on error after CONNECT calls
. V10.15.02 25/11/2019  Ebon Clements  TSK 0860142
.           Recompiled for NSHISWIO - GETMWS AE2034 Unrecoverable read error
. V10.15.01 04/10/2019  Peter Vela     TSK 0875417
.           Added tags for save variables local address nhimasaf
. V10.14.04 17/06/2019  Ebon Clements  TSK 0859728
.           Added cpmiskey cgi and tag
.           13/06/2019  Peter Vela     Task 0871798
.           Recompiled for DEATHAUD
. V10.14.03 11/06/2019  Nicole Torrisi TSK 0853899
.           Added handling of error 2034 - Unrecoverable read error
. V10.14.02 30/05/2019  Thanh T.        TSK 0872539
.           Recompiled for NZHISWIO changes
. V10.14.01 19/02/2019  Ebon Clements TSK 0867703
.           Changed NHI ethnicity file reads to use KEY5
. V10.13.02 24/10/2018  Steve Armstrong TSK 0863512
.           Recompiled for changes to DGCLICAE.
. V10.13.01 13/08/2018  Peter Vela      Task 0845218
.           Recompiled for DEATHAUD
.--------------------------------------------------------
. V10.12.02 11/07/2018  Peter Vela      TSK 0845218
.           Recompiled for DEATHAUD
. V10.12.01 17/04/2018  Thanh T.        TSK 0848444
.           Added Display Duplicate Warning on UPDHCU
. V10.11.04 28/12/2017  Ania P           TSK 0848601
.           Recompiled for changes to DGCLICAE
. V10.11.03 20/12/2017  Peter Vela     TSK 0848730
.           Added error 1002 validation PTDET510
. V10.11.02 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.01 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.--------------------------------------------------------
. V10.10.01 01/06/2017  Ebon Clements  TSK 0839510
.           Added hospital file tags to report 1 - ERRM0500
. V10.08.01 07/06/2016  Jill Parkinson TSK 0820003
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.07.02 13/10/2015  Peter Vela        CAR 315217
.           Changed to get NZIBFACC from Health Department Code in
.           pathspaf if multihospital
. V10.07.01 13/10/2015  Steve Armstrong   CAR 320785
.           Added trigger (5) for A04 message in EMRREG00
.--------------------------------------------------------
. V10.06.13 21/09/2015  Davin             CAR 313906
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.06.12 01/09/2015  Ebon Clements CAR 319970
.           Recompiled for UPDUR  - Previous GP audit
. V10.06.11 26/08/2015  Jill Parkinson CAR 318680
.           Recompiled for changes to NZHISWIO
. V10.06.10 25/08/2015  Jill Parkinson CAR 320905
.           Recompiled for changes to NZHISWIO
. V10.06.09 24/08/2015 Ebon Clements     CAR 319970
.           Recompiled for UPDUR - Previous GP
. V10.06.08 24/06/2015 Ebon Clements     CAR 313314
.           Added error functionality for NEWHCU when using pre allocated
.           NHI numbers - UPDERR00
. V10.06.07 23/06/2015 Ebon Clements     CAR 313314
.           Added PALLCNHI cgi for allocate pre existing nhi number in NEWHCU
. V10.06.06 16/06/2015  Ania P           CAR 313313
.           Added SUPERLEV
. V10.06.05 01/06/2015  Ania P           CAR 313313
.           Added PMRSSTDN
. V10.06.04 25/05/2015 Ebon Clements  CAR 313314
.           Added ASPRENHI cgi for allocate pre existing nhi number in NEWHCU
.           Added report 5 remote scripts
. V10.06.03 18/05/2015 Patrick Adair  CAR 208170
.           Recompiled for changes to UPDUR
. V10.06.02 15/04/2015  Peter Vela     CAR 312723
.           Recompiled for DEATHAUD
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed reference to PATCGPFD (No Longer in use)
.--------------------------------------------------------
. V10.04.05 09/05/2014  Don Nguyen     CAR 300097
.           Fixed SETMWD00 to clear CDAY, CCENT, CYEAR and MTHNAM3 for '0' vals
. V10.04.04 11/03/2014 Patrick Adair   CAR 297158
.           Corrected pop frame redirection for UPDERR90 and added CLSNX000
. V10.04.03 07/04/2014  Peter Vela     CAR 286258
.           Recompiled for PATMASTM
. V10.04.02 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.01 04/02/2014  Jill Parkinson CAR 284761
.           Mods to set NZIBENTM before calling UPDMWS in ADDMWS00
.--------------------------------------------------------
. V10.03.17 26/11/2013  J.Tan          CAR 284761
.           Mods to set PTMWLUPD at ADDMWS20
. V10.03.16 22/11/2013  Ebon Clements  CAR 282621
.           Added PopUpFrame1 test to UPDERR90
. V10.03.15 15/10/2013  Ebon Clements  CAR 251166
.           Added call to EMRREG00 to PTDET200 to update ED visit with U/R
. V10.03.14 26/09/2013  Jill Parkinson CAR 291691
.           Recompiled for NZHISWIO - over 15 medical warnings looping
. V10.03.13 26/07/2013  Steve Armstrong  CAR 287787
.           Recompiled for changes to DGCLICUA.
. V10.03.12 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.11 18/07/2013  Jill Parkinson CAR 288525
.           Recompiled for NZHISWIO
. V10.03.10 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.09 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.08 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.07 19/03/2013 J.Tan
.           Mods to set Update/Create date for pmsresaf file
. V10.03.06 23/07/2012 Patrick Adair     CAR 269159
.           Recompiled for changes to PATCOMN2
. V10.03.05 19/07/2012  Steve Armstrong  CAR 268870
.           Recompiled for changes to PATCOMN2 & UPDUR
. V10.03.04 09/07/2012  Steve Armstrong  CAR 267675
.           Recompiled for changes to PATCOMN2.
. V10.03.03 16/05/2012  Steve Armstrong  CAR 256322
.           Added DGCLICUP triggers for Medical Warnings
. V10.03.02 29/11/2011  Jill Parkinson    CAR 249362
.           Changed keys for alert tables
. V10.03.01 09/11/2011  Steve Armstrong   CAR 254774
.           Recompiled for changes to UPDUR.
.--------------------------------------------------------
. V10.02.05 04/08/2011  Steve Armstrong   CAR 247627
.           Added DGCLICUP trigger for patalrtf.
.           Also removed call to HL7ALERT
. V10.02.04 20/07/2011  J.Tan             CAR 239592
.           Mods to pmsresaf file
. V10.02.03 13/07/2011  Steve Armstrong   CAR 240722
.           Further mods to cater for second given name as
.           part of PATGSRFD keys
. V10.02.02 22/06/2011  Steve Armstrong   CAR 240722
.           Recompiled for changes to PMSLOCFD
.           Recompiled for changes to PMSCURFD
.           Mods to cater for changes to PATGSRFD:
.                  - GSRSNAM & GSRGNAM extended to 30 chars.
.                  - PTGSGNM2 added.
.                  - all indexes changed in length.
. V10.02.01 10/05/2011  J.Tan          CAR 239588
.           Created CLPMSRES - clear patient Residency file
.--------------------------------------------------------
. V10.01.01 02/02/2011  Steve Armstrong   CAR 237520
.           Mods to remove Detente interface (PATDETNT)
.--------------------------------------------------------
. V10.00.01 09/04/2010 Steve Armstrong   CAR 219045
.           Recompiled for changes PATMRGFD.
.--------------------------------------------------------
. V9.12.02  22/10/2009  Jill Parkinson CAR 208479
.           Mods to check TCINDC4 for alerts indicator (ptmxsin1)
. V9.12.01  14/08/2009  Davin         CAR 192477
.           Added reads on pmspx2 after patma1 reads
. V9.11.04  07/04/2009  Peter Vela    CAR 183976
.           Moved spaces to PMVXPILC before WRPMVX11
. V9.11.03  17/02/2009  Peter Vela    CAR 183976
.           Moved spaces to PMVXPOEC before WRPMVX11
. V9.11.02  17/12/2008  Jill Habasque CAR 185250
.           Fixed CHKMED00 to match to ptmwurno after reading patmwsaf
. V9.11.01  05/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.10.01  22/05/2008  Jill Habasque CAR 168367
.           Fixed incorrect update of pmi variables when NHI is down
. V9.09.03  27/08/2007  Peter Vela   CAR 147747
.           Added variables for PATCOMN2 Cabrini Health UR format
. V9.09.02  20/08/2007  Steve Armstrong CAR 147953
.           Recompiled for changes to HL7ALERT.
. V9.09.01  18/07/2007 Jill Habasque  CAR 102427   
.           Changed MVDNR000 to be pack with spaces (instead of moves)
.--------------------------------------------------------
. V9.08.08  28/03/2007 Janet George   CAR 121079   
.           Added EMERFLAG to indicate from emergency screen
. V9.08.07  28/02/2007 Jill Habasque  CAR 120461   
.           Added call to DEFMAS00
. V9.08.06  13/02/2007 Janet George         114378
.           Populated web user id field pmpxwbid (pmspx2af)
. V9.08.05  25/01/2007  Peter Vela CAR 127930
.           Recompiled for MRTMASFD
. V9.08.04  31/01/2007  Peter Vela    CAR 127930
.           Recompled for MRTCONFD
. V9.08.03  16/11/2006  Jill Habasque CAR 124909         
.           Changed setpar for nhmas014 to not be hard coded
. V9.08.02  11/11/2006  Jill Habasque CAR 124705         
.           Added error message with redirect - NHRER000
. V9.08.01  28/09/2006  Ebon Clements     CAR 107243
.           Added Deleted alert functionality
.--------------------------------------------------------
. V9.07.03  08/09/2006  Steve Armstrong   CAR 107632
.           Added call to HL7ALERT                
. V9.07.02  12/07/2006  Ebon Clements     CAR 103365
.           Added adm expected payor functionality
. V9.07.01  07/07/2006  Ebon Clements     CAR 103365
.           Added expected payor functionality to pmi add/update
. V9.06.01  08/06/2006  Steve Armstrong    CAR 108060
.           Recompiled for changes to UPDUR
.--------------------------------------------------------
. V9.05.03  11/04/2006 Mike Laming        CAR 101145
.           Correct field name (to NHRERCD) in match stmt at RELSEL10
. V9.05.02  22/03/2006  Ebon Clements     CAR 94905
.           Added visa number to pmsresaf
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
.--------------------------------------------------------
. V9.04.10  21/11/2005  Jill Habasque    CAR 84770
.           Added CHKMED00 when deleting medical warnings
. V9.04.09  05/10/2005  Jill Habasque    CAR 75952
.           Added update of PTYPE if resident is Yes
. V9.04.08  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.07  21/03/2005 Ebon Clements CAR 58443
.           Changed program to allow for PTMXSIN1 = 2 (S)security patient alerts
. V9.04.06  08/03/2005 Guomin Fu     CAR 52883
.           Added substitution of " in patient name and address line
. V9.04.05  07/03/2005  Steve Armstrong    CAR 59137
.           Recompiled for changes to CISINADT, HL7CISIN & HL7CISVR
. V9.04.04  06/10/2004 Jill Habasque CAR 49617
.           Fixed branch on ovrcd to UPDNHI10 instead of UPDNHI05
. V9.04.03  29/09/2004 Peter Vela    CAR 49647
.           Recompiled for UPDUR
. V9.04.02  24/09/2004 Jill Habasque CAR 49617
.           Checks for error 2033 - NHI Down
.           17/09/2004 Jill Habasque
.           Checks for error 2097 - NHI Down
. V9.04.01  27/09/2004  Ebon Clements            CAR 53266
.           Multi hospital changes for ADDVIS00 - medical record link
. V9.03.25  28/06/2004  Steve Armstrong      CAR 51167
.           Recompiled for changes to HL7CISIN
. V9.03.24  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.23  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.22  13/05/2004  Steve Armstrong      CAR 49679
.           PAS-CIS Product Integration
.           Recompiled for WRTUR in PATCOMN2 (added call to CISA28BR)
.           Recompiled for UPDUR (added call to CISA31BR)
. V9.03.21  26/03/2004 Peter Vela    CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.20  24/03/2004 Jill Habasque CAR 48045
.           Added output of nziblast and nhmadat           
. V9.03.19  12/03/2004 Jill Habasque CAR 48158
.           Changed to unlock master and nhi records after an error
. V9.03.18  10/03/2004 Guomin Fu  CAR 47828
.           Recompiled for UPDUR
. V9.03.17  23/01/2004 Ebon Clements CAR 38490 and 46979
.           Recompiled for MRTVISCD - Auto create medical records
. V9.03.16  11/12/2003  Jill Habasque 44765
.           Added emergency registration
. V9.03.15  29/10/2003 Sandra Barcham    43783
.           Recompiled for NZHISWIO and NZHISWUP
. V9.03.14  15/10/2003 Jill Habasque CAR 44202
.           Added error description to override message
. V9.03.13  15/10/2003 Jill Habasque CAR 44202    
.           Recompiled for PATMASTM
. V9.03.12  14/10/2003 Jill Habasque CAR 44202    
.           Mods to display overide options in update     
. V9.03.11  10/10/2003 Jill Habasque CAR 43985    
.           Changed to call VALHCU0
. V9.03.10  08/10/2003 Jill Habasque CAR 44072    
.           Added set of NZIBDUPL before calling UPDHCU
.           Removed waits on locked records
. V9.03.09  26/09/2003 Jill Habasque CAR 43707
.           Added open of nhiaudma       
. V9.03.08  03/09/2003 Jill Habasque
.           Added call to SETMED00
. V9.03.07  03/09/2003 Jill Habasque
.           Fixed write to patmwsaf
. V9.03.06  20/08/2003 Jill Habasque SRF 42890
.           Recompiled for NZHISWIO
. V9.03.05  20/08/2003 Jill Habasque SRF 42557
.           Removed single quotes from baby name and added mothers given name
. V9.03.04  23/07/2003 Jill Habasque SRF 41758
.           Mods to clear national donor details (CLRNDR00)
. V9.03.03  15/07/2003 Jill Habasque SRF 40611
.           Mods to confirm message for Duplicate registration error
. V9.03.02  10/07/2003 Jill Habasque SRF 38462
.           Recompiled for UPDUR - update previous address file
. V9.03.01  22/06/2003 Jill Habasque SRF 41121
.           Mods to override message 
. V9.02.14  06/05/2003 Jill Habasque SRF 38460
.           Fixed chkhcu on new registration
. V9.02.13  21/03/2003 Jill Habasque SRF 36883
.           Added read of PTCNNHTM
. V9.02.12  21/02/2003 Jill Habasque SRF 36626
.           Added call to CHKHCU in PTDET600
. V9.02.11  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.10  28/01/2003 Jill Habasque
.           Fixed branch after calling wincls00                     
. V9.02.09  05/12/2002 Lina Vo       SRF 22709   
.           Added OPNOUT00 to open outpatient file                  
. V9.02.08  22/11/2002 Jill Habasque SRF 22690   
.           Added update of PTMXSIN1 when adding a medical warning  
.           12/11/2002 Katie Nelson SRF 22690    
.           Added ICD10 to the hardcoded coding system values       
. V9.02.07  09/10/2002  Peter Vela     SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.06  07/10/2002  Jill Habasque  SRF 22541
.           Moved IBAWEBDF and NZHISIFD to fix I*N  
. V9.02.05  15/08/2002  Steve Downing  SRF 14635
.           Added ETHDES1-3 for changes to PATDETNT
. V9.02.04  05/07/2002  Jill Habasque SRF 19273
.           Recompiled for PATCOMN2
. V9.02.03  20.11.2001  B.G.Ackland                                    *
.           Remove pi's from Program
. V9.02.02  08/11/2001  Mike Laming       
.           Rename DGCLIUPM to DGCLICUP 
. V9.02.01  08/09/2001  Glenn Saunders                                        
.           Changes keys for reads to patgsrn to reflect enhanced indexes.
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.001 14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B06 13.07.2001 Sandra Barcham
.           Replaced GP with HCP
. V9.00.B05 3/04/2001  Glenn Saunders                         
.           Remove access to PTCNSNDX and associated processing
.           Remove all references to PATSUR file (old surnames)
.           Replace WEBEMCM2 with PATCOMN2 (now web-verted)    
. V9.00.B04 03.04.2001 Ebon Clements
.           Recompiled for PMSPX2FD layout changes    
. V9.00.B03 23.03.2001 Ebon Clements
.           Added write to PMSPX2FD master extn2 file
. V9.00.B02 22.03.2001 B.G.Ackland
.           Include Admission No in Redirect
.           Clear Domicile for Scrubbing
. V9.00.B03 03/01/2001  J.Tan
.           Added DOB and sex to patgsrnf file
.           09.01.2001 Katie Nelson
.           Added control cache header
.--------------------------------------------------------
.  V5.08.11 14.11.2000 B.G.Ackland
.                          New Redirect for Add
.                 V5.08.10 10.11.2000 B.G.Ackland
.                          Clear Master File Variables
.                          Fix Resident Status
.                 V5.08.09 08.11.2000 B.G.Ackland
.                          Remove "' from NHI Error Messages
.                 V5.08.08 08.11.2000 B.G.Ackland
.                          Remove "' from NHI Error Messages
.                 V5.08.07 28/09/2000 Bronko Sosic  
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.08.06 05/09/2000  Tonii
.                          Mods to accept Unknown and Indeterminate as valid
.                          patient sex description
.                 V5.08.05  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.04 22/08/2000  Jill Habasque
.                          Added variables for patdetnt             
.                 V5.08.03 06/07/2000  Greg Horvat
.                          Moved the parameter PTCNEDID to PTCNNZED
.                 V5.08.02 26/06/2000 Katie Nelson 
.                          Removed double quotes from NHI error returned
.                          19/06/2000 Bronko Sosic
.                          Set search criteria to default from local search
.                 V5.08.01 07/06/2000 Bronko Sosic
.                          Recompiled for PATMASTM
.----------------------------------------------------------------------
.                 V5.07.04 02/02/2000 Steven Watkins
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.03 28.01.2000 B.G.Ackland 
.                          Complete Programming             
.                 V5.07.02 20.12.1999 K.C.Nelson  
.                          Recompiled for IBAWEBDF/IBAWEBCD
.                 V5.07.01 04.10.1999 K.C.Nelson  
.                          Added another call to Connect 
.                 V5.07.00 28.07.1999 K.C.Nelson  
.                          Created Program
.
.----------------------------------------------------------------------
.
          INC       IBAWEBDF    
.
          INC       NEWBORTD/INC
          INC       APSMASFD/INC
          INC       BOKRC1FD/INC
          INC       DEATHATD/INC
          INC       EMRCONFD/INC
          INC       EMRVISFD/INC
          INC       EMRUNKFD/INC
          INC       MEHLERFD/INC
          INC       MRTCONFD/INC
          INC       MRTMASFD/INC
          INC       MRTVISFD/INC
          INC       NHIDCDFD/INC
          INC       NHIDNRFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       NHIMCCFD/INC
          INC       NHIRELFD/INC
          INC       NZHISIFD/INC
          INC       OUTCLIFD/INC
          INC       OUTPREFD/INC
          INC       OUTSITFD/INC
          INC       PATAK1FD/INC 
          INC       PATALRFD/INC
          INC       PATAM1FD/INC
          INC       PATCALAG/INC
          INC       PMSBRQFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATDHEAD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATFN1FD/INC
          INC       PATGSRFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATLOCFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATMRGFD/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATPA1FD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATTRNFD/INC
          INC       PATURAFD/INC
          INC       PATVADFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSCEXFD/INC
          INC       PMSNEWFD/INC
          INC       PMSALAFD/INC
          INC       PMSALNFD/INC
          INC       PMSCURFD/INC
          INC       PMSDAUFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSPAYFD/INC
          INC       PMSPX2FD/INC
          INC       PMSRESFD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1FD/INC
          INC       RESLNKFD/INC
          INC       TMPALIFD/INC
          INC       PATHSPFD/INC
          INC       MRTLOCFD/INC
          INC       EMRSITFD/INC
          INC       VISPAYFD/INC
.
ACC       DIM       2
ACTION    DIM       1
ADD       DIM       2
ADDRWARN  DIM       1
AMM       DIM       2
AYY       DIM       2
ASPRENHI  DIM       8
.
BABDDESC  DIM       30                      * Default baby name for NHI Reg
.
CFILEPRE  DIM       3
CLINDESC  DIM       20
CLRDOMCF  FORM      1
CONTTYPE  DIM       1
COUNT     FORM      2
CPMISKEY  DIM       25                      * Confirm PMI OP session redirect
.
DETNTREC  FORM      2
DIM4      DIM       4
DIM8      DIM       8
DIM10     DIM       10
DIM20     DIM       20
DNRCOD01  DIM       1 * Scr 02 Fld    21
DNRCOD02  DIM       1 * Scr 02 Fld    22
DNRCOD03  DIM       1 * Scr 02 Fld    23
DNRCOD04  DIM       1 * Scr 02 Fld    24
DNRCOD05  DIM       1 * Scr 02 Fld    25
DNRCOD06  DIM       1 * Scr 02 Fld    26
DNRCOD07  DIM       1 * Scr 02 Fld    27
DNRCOD08  DIM       1 * Scr 02 Fld    28
DNRCOD09  DIM       1 * Scr 02 Fld    29
DNRCOD10  DIM       1 * Scr 02 Fld    30
DNRDES01  DIM       25 * Scr 02 Fld    31
DNRDES02  DIM       25 * Scr 02 Fld    32
DNRDES03  DIM       25 * Scr 02 Fld    33
DNRDES04  DIM       25 * Scr 02 Fld    34
DNRDES05  DIM       25 * Scr 02 Fld    35
DNRDES06  DIM       25 * Scr 02 Fld    36
DNRDES07  DIM       25 * Scr 02 Fld    37
DNRDES08  DIM       25 * Scr 02 Fld    38
DNRDES09  DIM       25 * Scr 02 Fld    39
DNRDES10  DIM       25 * Scr 02 Fld    40
DOCTCODE  DIM       6
DUPLWARN  DIM       1
.
ERRTYPE   DIM       3
ETHNICIT  DIM       5
EXPDATE   DATE      8
.
FLDVALUE  DIM       127
FORM3     FORM      3
FORM5     FORM      5
FORM8     FORM      8
.
LOCALFLG  FORM      1
LOCKCNT   FORM      5
EMERFLAG  DIM       1                      * Emergency Flag(1-From Emr screen)
.
MURNUMBR  DIM       8
NEWREG    FORM      1
NEXTPAGE  DIM       1
.
NHALI001  DIM       25                      * Alias - Surname
NHALI002  DIM       20                      * Alias - Given Name 1
NHALI003  DIM       20                      * Alias - Given Name 2
NHALI004  DIM       20                      * Alias - Given Name 3
NHALI005  DIM       1                       * Alias - Preferred Given Name Indi
NHALIKEY  DIM       11                      * Alias - Key
NHDNR001  DIM       10                      * Donor Details Summary String
NHDNR002  DIM       25                      * Contact - Surname            
NHDNR003  DIM       20                      * Contact - Given Name 1
NHDNR004  DIM       20                      * Contact - Given Name 2
NHDNR005  DIM       20                      * Contact - Given Name 3
NHDNR006  DIM       1                       * Contact - Preferred Given Name 
NHDNR007  DIM       35                      * Contact - Address Line 1
NHDNR008  DIM       30                      * Contact - Address Line 2
NHDNR009  DIM       30                      * Contact - Suburb
NHDNR010  DIM       30                      * Contact - City/Town  
NHDNR011  DIM       30                      * Contact - Country    
NHDNR012  DIM       2                       * Contact - Relationship 
NHDNR013  DIM       25                      * Contact - Work Phone 
NHDNR014  DIM       25                      * Contact - After Hours Phone
NHDNRLUP  DIM       16                      * Last Update Key
NHIHCUID  DIM       7
NHMAS002  DIM       20                      * Given Name 1
NHMAS003  DIM       20                      * Given Name 2
NHMAS004  DIM       20                      * Given Name 3
NHMAS005  DIM       1                       * Preferred Given Name Indicator 
NHMAS006  DIM       35                      * Address Line 1
NHMAS007  DIM       30                      * Address Line 2
NHMAS008  DIM       30                      * Suburb         
NHMAS009  DIM       30                      * City/Town    
NHMAS010  DIM       30                      * Country      
NHMAS011  DIM       8                       * Date of Birth 
NHMAS012  DIM       8                       * Date of Death 
NHMAS013  DIM       4                       * Domicile Code    
NHMAS014  DIM       1                       * Residence Status (Y/N) (0=N,1=Y)  
NHMAS015  DIM       1                       * Gender (M or F)
NHMAS016  DIM       2                       * 1st Ethnicity
NHMAS017  DIM       2                       * 2nd Ethnicity
NHMAS018  DIM       2                       * 3rd Ethnicity
NHMAS019  FORM      1                       * Save Alias 0=No 1=Yes
NHMASLUP  DIM       16                      * Last Update Key
NHMAS001  DIM       25                      * Surname
NHMWS001  DIM       3                       * Severity of Warning      
NHMWS002  DIM       11                      * Date of Onset
NHMWS003  DIM       70                      * Text Description        
NHMWS004  DIM       5                       * National Doctor Code    
NHMWS005  DIM       2                       * Coding System          
NHMWS006  DIM       9                       * Code for Warning        
NHMWSKEY  DIM       14                      * Key for Medical Warning
NHMWSLUP  DIM       14                      * Last Update Date & Time 
NMPNUMB   DIM       20
NZARADD1  DIM       35[15]   * Address Line 1
NZARADD2  DIM       30[15]   * Address Line 2
NZARCTRY  DIM       30[15]   * Country
NZARCITY  DIM       30[15]   * City
NZARDDTH  DIM       8[15]    * Date of Death
NZARDOB   DIM       8[15]    * Date of Birth
NZARDOMC  DIM       4[15]    * Domicile code
NZARETHN  DIM       2[15]    * Ethnicity
NZARETH2  DIM       2[15]    * Ethnicity
NZARETH3  DIM       2[15]    * Ethnicity
NZARGIV1  DIM       20[15]   * Given Name 1
NZARGIV2  DIM       20[15]   * Given Name 2
NZARGIV3  DIM       20[15]   * Given Name 3
NZARNMPI  DIM       7[15]    * NMPI No.
NZARPRNM  DIM       1[15]    * preferred name indicator
NZARRESI  DIM       1[15]    * Resident Status
NZARSEX   DIM       1[15]    * Sex/Gender
NZARSURN  DIM       25[15]   * Surname/Family name
NZARSUBR  DIM       30[15]   * Suburb
.
OPERCODE  DIM       4
OVERRIDE  DIM       3
.
PALLCNHI  DIM       8
PMRES001  DIM       3
PMRES002  DIM       8
PMRES003  DIM       8
PMRES004  DIM       127
PMRES005  DIM       10
PMRES014  DIM       20
PTMAS019  DIM       3
PTMAS021  DIM       3
.
ALIASSTS  DIM       1
SAVEUSR1  DIM       3
.
SAVEADD1  DIM       35
SAVEADD2  DIM       30
SAVESUBR  DIM       30
SAVECITY  DIM       30
SAVECTRY  DIM       30
SAVEDOMC  DIM       4
.
SAVEALIA  FORM      1
SAVEERRD  DIM       80
SAVEERRN  DIM       4
SAVKEY16  DIM       16
SAVKEY19  DIM       19
SAVEPCTR  DIM       2
SAVEPHCP  DIM       10
SAVEPRAC  DIM       10
.
SAVESNAM  DIM       40
SAVEXFNM  DIM       40
SAVEXSNM  DIM       40
SAVETITL  DIM       4
SAVEPSEX  DIM       1
SAVEPDOB  DIM       8
SAVEPFGN  DIM       25
SAVEPMST  DIM       3
SAVEPREG  DIM       3
SAVEPCNT  DIM       3
SAVEPTYP  DIM       3
SAVEABRG  DIM       3
SAVEUSR7  DIM       3
SAVEMEDI  DIM       10
SAVEMCCD  DIM       2
SAVEMEDC  DIM       8
SAVECONP  DIM       1
SAVEUPRF  DIM       3
SAVEINTR  DIM       1
SAVELNG1  DIM       3
SAVEPRVI  DIM       3
SAVEFLDR  DIM       3
SAVESN16  DIM       1
SPPXUCC4  DIM       3
SPPXUCC5  DIM       3
SPPXATF1  DIM       80
SPPXATF2  DIM       80
SAVECUID  DIM       8
SAVECDAT  DIM       8
SAVECTIM  DIM       8
.
SAVEMWAC  DIM       20
SAVEMWDT  DIM       8
SAVEMWDS  DIM       70
.
SEVRDESC  DIM       20
SAVPFUND  DIM       6
SRCHGNAM  DIM       25
SRCHPAGE  DIM       3
SRCHPDOB  DIM       8
SRCHPSEX  DIM       1
SRCHSNAM  DIM       20
SUPERLEV  DIM       1
SURSYST   FORM      1
.
SNMAETH   DIM       5
SNMAETH2  DIM       5  
SNMAETH3  DIM       5
SNMASURN  DIM       25 
SNMAGIV1  DIM       20 
SNMAGIV2  DIM       20 
SNMAGIV3  DIM       20 
SNMASEX   DIM       1 
SNMADOB   DIM       8
SNMAADD1  DIM       35
SNMAADD2  DIM       30
SNMAADD3  DIM       30
SNMAADD4  DIM       30
SNMAADD5  DIM       30
SPRSCONT  DIM       3
SPRSTEXP  DIM       8
SPRSVISN  DIM       10  
SPRSSTDN  DIM       20
SPRSCOMM  DIM       127 
.
TODAY     DIM       8
TOTALALI  FORM      3
.
UPDHH     DIM       2
UPDKWARN  DIM       1
SAVELOCL  DIM       1
UPDMM     DIM       2
UPDSS     DIM       2
UPDTTYPE  DIM       1
UPERRMSG  DIM       127
URCHKDGT  FORM      4
URWTARAY  INIT      "234567"
URNLNGTH  FORM      2
URCHKPRD  FORM      2
URNOWGHT  FORM      1
USERNAME  DIM       10
.
WARNMES   DIM       30
.
.
. PROGRAM CONSTANTS
. -----------------
.
BABDDSC0  INIT      "Son of or Daughter of "
BABDDSC1  INIT      "Baby of "
CATTC     INIT      "tc"
CLINSYS0  INIT      "No coding system"
CLINSYS1  INIT      "ICD-9           "
CLINSYS2  INIT      "ICD-9-CM        "
CLINSYS3  INIT      "RCC5 (READ)     "
CLINSYS4  INIT      "ICPC            "
CLINSYS5  INIT      "PAXUS AMR codes "
CLINSYS6  INIT      "ICD-9-CM-A      "
CLNSYS10  INIT      "ICD10 version 1 "
CLNSYS11  INIT      "ICD10 version 2 "
SEC1      FORM      "00001"
.
.
.------------------------------------------------------------------------------
PRGID     INIT      "NHIWEB99"
VERSION   INIT      "V12.00.03"
PRGNAM    INIT      "NHI/MWS Update Interface"
.------------------------------------------------------------------------------
.
.
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
          CALL      CONNECT        * DO Connect to NHI
          BRANCH    EXIT,MAIN9999
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      DISCNNCT
          CALL      CONNECT                 * Basic Patient Details 
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400:
                             MAIN1500
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      PTDET000                * Basic Patient Details 
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN1200  CALL      DCDET000                * Donor & Contact Details 
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN1300  CALL      ALDET000                * Alaises
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN1400  CALL      MWDET000                * Medical Warnings
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN1500  CALL      REMOTE00                * Remote Scripts 
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50,NXTPAG60:
                    NXTPAG70,NXTPAG80,NXTPAG90
.
          MOVE      ZERO,EXIT    * Output Template Specified
          GOTO      NXTPAG99
.
NXTPAG10  CALL      WINCLS00    * Close Window/Frame and Reload Parent
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG20  CALL      RDIREC00    * Redirect to URL
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG30  CALL      NBRED000    * Redirect to URL
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG40  CLEAR     DIM127
          STRIP     REDIRECT
          APPEND    REDIRECT,DIM127
          APPEND    "&urnumber=",DIM127
          MOVE      URNUMBER,KEY8
          REP       " +",KEY8
          APPEND    KEY8,DIM127
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            APPEND    "&admissno=",DIM127
            MOVE      ADMISSNO,KEY8
            REP       " +",KEY8
            APPEND    KEY8,DIM127
          ENDIF
          RESET     DIM127
          MOVE      DIM127,REDIRECT
          CALL      RDIREC00    * Redirect to URL
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG50  CLEAR     DIM127
          STRIP     REDIRECT
          APPEND    REDIRECT,DIM127
          APPEND    "&urnumber=",DIM127
          MOVE      URNUMBER,KEY8
          REP       " +",KEY8
          APPEND    KEY8,DIM127
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            APPEND    "&admissno=",DIM127
            MOVE      ADMISSNO,KEY8
            REP       " +",KEY8
            APPEND    KEY8,DIM127
          ENDIF
          RESET     DIM127
          MOVE      DIM127,REDIRECT
          CALL      WINNX000    * Close Window/Frame and Reload Parent
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG60  CLEAR     DIM127
          STRIP     REDIRECT
          APPEND    REDIRECT,DIM127
          APPEND    "&urnumber=",DIM127
          MOVE      URNUMBER,KEY8
          REP       " +",KEY8
          APPEND    KEY8,DIM127
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            APPEND    "&admissno=",DIM127
            MOVE      ADMISSNO,KEY8
            REP       " +",KEY8
            APPEND    KEY8,DIM127
          ENDIF
          RESET     DIM127
          MOVE      DIM127,REDIRECT
          CALL      PREDIR00    * Redirect to URL
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG70  CALL      PREDIR00
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG80  CLEAR     DIM127
          STRIP     REDIRECT
          APPEND    REDIRECT,DIM127
          APPEND    "&urnumber=",DIM127
          MOVE      URNUMBER,KEY8
          REP       " +",KEY8
          APPEND    KEY8,DIM127
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            APPEND    "&admissno=",DIM127
            MOVE      ADMISSNO,KEY8
            REP       " +",KEY8
            APPEND    KEY8,DIM127
          ENDIF
          RESET     DIM127
          MOVE      DIM127,REDIRECT
          CALL      CLSNX000    * Close Window/Frame and Reload Parent Parent
          MOVE      ONE,EXIT
          GOTO      NXTPAG99
.
NXTPAG90  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------
. Refresh Parent and Close Window
.------------------------------------------------------------
WINNX000  CALL      OPENHTML
          BRANCH    EXIT,WINNX999
          SFORMAT   VAR,127
          STRIP     REDIRECT
          MOVELPTR  REDIRECT,LENGTH
          COMPARE   ZERO,LENGTH
          IF        @EQUAL
            SFORMAT   VAR,1
          ELSE
            SFORMAT   VAR,LENGTH
          ENDIF
          MOVE      REDIRECT,VAR
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "  redirectParentFrame(#"",VAR,"#");}":
                             " else { ":
                             "  opener.location.href=#"",VAR,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          SFORMAT   VAR,127
WINNX999  RETURN
.------------------------------------------------------------
. Refresh Parent and Close Window
.------------------------------------------------------------
CLSNX000  CALL      OPENHTML
          BRANCH    EXIT,CLSNX999
          SFORMAT   VAR,127
          STRIP     REDIRECT
          MOVELPTR  REDIRECT,LENGTH
          COMPARE   ZERO,LENGTH
          IF        @EQUAL
            SFORMAT   VAR,1
          ELSE
            SFORMAT   VAR,LENGTH
          ENDIF
          MOVE      REDIRECT,VAR
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "  redirectParentFrame(#"",VAR,"#");}":
                             " else { ":
                             " parent.parent.location.href=#"",VAR,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          SFORMAT   VAR,127
CLSNX999  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    OVRCD,PREDIR90
.
          WRITE     HTMLFILE;"Content-Type: text/html",012:
                             "Cache-Control: no-cache",012,012:
                             "<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CLOSE     HTMLFILE
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.----------------------------------------------------------------------------
.  Redirect URL with baby's UR
.----------------------------------------------------------------------------
NBRED000  CALL      OPENHTML
          BRANCH    EXIT,NBRED900
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&babyurno=",REDIRECT
          REP       " +",URNUMBER
          APPEND    URNUMBER,REDIRECT
          RESET     REDIRECT
.
          WRITE     HTMLFILE;"Content-Type: text/html",012:
                             "Cache-Control: no-cache",012,012:
                             "<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      NBRED999
.
NBRED900  DISPLAY   "*** Fifo Not Found ***"
.
NBRED999  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      PMSALNA1,"pmsalnaf"
          OPEN      PMSALAA1,"pmsalaaf"
          OPEN      PMSNEWA1,"pmsnewaf"
          OPEN      PMSNEWA2,"pmsnewaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSCURA1,"pmscuraf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRUNKA1,"emrunkaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATPA1A1,"patpa1af"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      NHIMASA1,"nhimasaf"
          OPEN      NHIMASA2,"nhimasaf"
          OPEN      NHIDNRA1,"nhidnraf"
          OPEN      NHIETHA1,"nhiethaf"
          OPEN      NHIETHA2,"nhiethaf"
          OPEN      NHIDCDA1,"nhidcdaf"
          OPEN      NHIRELA1,"nhirelaf"
          OPEN      NHIMCCA1,"nhimccaf"
          OPEN      PATALRT1,"patalrtf"
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATLOCA1,"patlocaf"
          OPEN      PATMWSA1,"patmwsaf"
          OPEN      PATMRGG1,"patmrgaf"
          OPEN      PATNIDA1,"patnidaf"
          OPEN      PATVADA3,"patvadaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      TMPALIA1,"tmpaliaf"
          OPEN      PMSPAYA1,"pmspayaf"
          OPEN      PMSPAYA2,"pmspayaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSRESA1,"pmsresaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISPAYA2,"vispayaf"
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,TEN9;*75,CCNOTES
          READ      CONTROLF,FIFTY9;*132,CALRDESC,*231,PTCNRGNS
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND10;*248,PTCNEPAY
          READ      CONTROLF,TEN;*250,CAUDA1
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND24;*215,PTCNDHCU
.
          IF        CAUDA1<>1
            OPEN      PATAUDAL,"pataudal"
            OPEN      PATAUDA2,"pataudal"
            OPEN      PMSAUDAN,"pmsaudan"
            OPEN      PMSAUDA2,"pmsaudan"
          ENDIF
.
          OPEN      PATGSRN1,"patgsrnf"     * surname & given name
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          OPEN      PATAM1A1,"patam1af"
.
          MOVE      "   80",AUDTSECT
          MOVE      "140",AUDTPOST
          READ      CONTROLF,AUDTSECT;*AUDTPOST,AUDTFLAG
          IF        AUDTFLAG=1
            OPEN      NHIAUDMA,"nhiaudma"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
          CALL      REDCON00
.
          RETURN
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          OPEN      OUTCLIA1,CFNAME    
          RETURN
.-------------------------------------------------------
. Read Control File
.-------------------------------------------------------
REDCON00  READ      CONTROLF,SEVENTY7;*45,PTCNNZED
          READ      CONTROLF,SEVENTY9;*33,PTCNSEND
          READ      CONTROLF,EIGHTY;*138,PTCNNZUR,PTCNNUMH,PTCNANMA,PTCNANDN:
                                     PTCNDOMF,*223,PTCNNXTT
.
          MOVE      ONE,CNEWDS              * New Question Mark Option
          MOVE      "11111111",ALRTMASK
.
          READ      CONTROLF,TEN;*164,CSPECCO,*196,CGENRUR,*213,CAUDM:
                    *244,CHOSPNUM
          READ      CONTROLF,TEN3;*244,CHCS
          READ      CONTROLF,EIGHTY8;*116,CHCSDTE
          READ      CONTROLF,TEN5;*191,CMUSR1,CMUSDS1,CMUSR2,CMUSDS2,CMUSR3:
                    CMUSDS3,CMUSMAN1,CMUSMAN2,CMUSMAN3
          READ      CONTROLF,TEN8;*246,CMAXAGE
          READ      CONTROLF,TEN9;*75,CCNOTES,CRUSR1,CRDESC1,*97,CRMAN1,CRUSR2:
                    CRDESC2,*119,CRMAN2,CRUSR3,CRDESC3:
                    *141,CRMAN3,CHUSR1,CHDESC1,*163,CHMAN1,CHUSR2:
                    CHDESC2,*185,CHMAN2,CHUSR3,CHDESC3:
                    *207,CHMAN3,CPMIAD
          READ      CONTROLF,TWENTY;*186,PTCNUCSL,*225,PTCNNMDX,*238,PTCNURCO
.
          READ      CONTROLF,TWENTY1;*1,PTCNBABD:
                             *13,PTCNUNAK,*56,PTCNDEFT,*119,PTCNRPIK:
                             *138,PTCNNHII,PTCNNHID,PTCNDONR,PTCNMEDW,PTCNUDNG:
                                  PTCNNSCA,PTCNMPTR,PTCNCDRS,PTCNLNCD,PTCNLP01:
                             *174,PTCNDONR,PTCNMEDW,PTCNUDNG,PTCNNSCA,PTCNMPTR:
                             *187,PTCNVP32,PTCNVM21,PTCNUONL,PTCNPCON,PTCNNHIF:
                             *204,PTCNAWRN:
                             *213,PTCNNZCD:
                             *226,PTCNMWAD:
                             *237,PTCNPAOF,PTCNAGEC,PTCNEDIF
.
          READ      CONTROLF,TWENTY2;*30,STCNIPPM
          READ      CONTROLF,FIFTY9;*37,CTYPCHG,*64,CUSENOTE,*79,CYRESMAN:
                    CBIRTHCN,*86,CDETENTE,*92,CDETPATH:
                    *132,CALRDESC,*216,PTPRVALS,*234,PTCNNMPI:
                    *237,PTCNLDOC
          READ      CONTROLF,SEVENTY7;*240,PTCNAXEU
          READ      CONTROLF,EIGHTY;*240,PTCNDORP,PTCNUCGP
          MOVE      PTCNRPIK,CREGOPT      * set to allow (R) if using it
          STRIP     PTCNNMDX
          READ      CONTROLF,HUND09;*177,PTCNNHTM
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,NHIHCUID
          MOVE      SP70,ADMISSNO
          MOVE      SP70,EMERFLAG 
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,UPERRMSG
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,MURNUMBR
          MOVE      SP70,SUPERLEV
.
          MOVE      SP70,NZIBPANO
          MOVE      SP70,PALLCNHI
          MOVE      Z70,ASPRENHI
.
          MOVE      SP70,NHMASLUP
          MOVE      SP70,NHDNRLUP
          MOVE      SP70,NHALIKEY
          MOVE      SP70,NHMWSKEY
.
          MOVE      SP70,NHMAS001  
          MOVE      SP70,NHMAS002  
          MOVE      SP70,NHMAS003  
          MOVE      SP70,NHMAS004  
          MOVE      SP70,NHMAS005  
          MOVE      SP70,NHMAS006  
          MOVE      SP70,NHMAS007  
          MOVE      SP70,NHMAS008  
          MOVE      SP70,NHMAS009  
          MOVE      SP70,NHMAS010  
          MOVE      SP70,NHMAS011 
          MOVE      SP70,NHMAS012
          MOVE      SP70,NHMAS013
          MOVE      "N",NHMAS014  
          MOVE      SP70,NHMAS015  
          MOVE      SP70,NHMAS016  
          MOVE      SP70,NHMAS017  
          MOVE      SP70,NHMAS018  
          MOVE      ZERO,NHMAS019  
          MOVE      ZERO,SAVEALIA
.
          MOVE      SP70,NHDNRLUP  
          MOVE      SP70,NHDNR001  
          CLEAR     NHDNR001  
          MOVE      SP70,NHDNR002  
          MOVE      SP70,NHDNR003  
          MOVE      SP70,NHDNR004  
          MOVE      SP70,NHDNR005  
          MOVE      SP70,NHDNR006  
          MOVE      SP70,NHDNR007  
          MOVE      SP70,NHDNR008  
          MOVE      SP70,NHDNR009  
          MOVE      SP70,NHDNR010  
          MOVE      SP70,NHDNR011  
          MOVE      SP70,NHDNR012  
          MOVE      SP70,NHDNR013  
          MOVE      SP70,NHDNR014  

          MOVE      SP70,NHALIKEY  
          MOVE      SP70,NHALI001  
          MOVE      SP70,NHALI002  
          MOVE      SP70,NHALI003  
          MOVE      SP70,NHALI004  
          MOVE      SP70,NHALI005  
.
          MOVE      SP70,NHMWSKEY  
          MOVE      SP70,NHMWSLUP  
          MOVE      SP70,NHMWS001  
          MOVE      SP70,NHMWS002  
          MOVE      SP70,NHMWS003  
          MOVE      SP70,NHMWS004  
          MOVE      SP70,NHMWS005  
          MOVE      SP70,NHMWS006  
.
          MOVE      SP70,SRCHSNAM
          MOVE      SP70,SRCHGNAM
          MOVE      SP70,SRCHPSEX
          MOVE      SP70,SRCHPAGE
          MOVE      SP70,SRCHPDOB
          MOVE      SP70,OVERRIDE
          MOVE      SP70,ADDRWARN
          MOVE      SP70,DUPLWARN
          MOVE      SP70,UPDKWARN
          MOVE      SP70,SAVELOCL
.
          CALL      CVPMI000                * clear mast ext2 details
.
          MOVE      "30",TMOTFRST
          MOVE      "30",TMOTNEXT
.
          PACK      PTMAS019,Z70
          PACK      PTMAS021,Z70
          PACK      PMRES001,Z70
          PACK      PMRES002,Z70
          PACK      PMRES003,Z70
          PACK      PMRES004,Z70
          PACK      PMRES005,Z70
          PACK      PMRES014,Z70
          MOVE      SP70,CPMISKEY
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "override=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRIDE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nhihcuid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NHIHCUID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emerflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMERFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "murnumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MURNUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nhmaslup=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NHMASLUP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nhdnrlup=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NHDNRLUP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nhalikey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NHALIKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nhmwskey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NHMWSKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nhmas",QRYNAME
          IF        @EQUAL
            CALL      SPMAS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "nhdnr",QRYNAME
          IF        @EQUAL
            CALL      SPDNR000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "nhali",QRYNAME
          IF        @EQUAL
            CALL      SPALI000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "nhmws",QRYNAME
          IF        @EQUAL
            CALL      SPMWS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "srchsnam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHSNAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchgnam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHGNAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchpdob=",QRYNAME
          IF        @EQUAL
            MATCH      SP70,QRYDATA
            GOTO       SETPAR99 IF EQUAL
            GOTO       SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      SRCHPDOB,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchpsex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHPSEX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addrwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDRWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updkwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDKWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savelocl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVELOCL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "duplwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DUPLWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmas019=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS019
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmas021=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS021
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmres001=",QRYNAME
          IF        @EQUAL
            PACK      PMRES001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmres002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        @EQUAL|@EOS
              PACK      PMRES002,QRYDATA,SP70
              GOTO      SETPAR99
            ENDIF
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PMRES002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmres003=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      PMRES003,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmres004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMRES004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmres005=",QRYNAME
          IF        @EQUAL
            PACK      PMRES005,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmres014=",QRYNAME
          IF        @EQUAL
            PACK      PMRES014,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "asprenhi=",QRYNAME
          IF        @EQUAL
            PACK      ASPRENHI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pallcnhi=",QRYNAME
          IF        @EQUAL
            PACK      PALLCNHI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpmiskey",QRYNAME
          IF        @EQUAL
            PACK      CPMISKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Set NHMAS cgi parameters
.------------------------------------------------------------
SPMAS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          PACK      QRYDATA,QRYDATA,SP70
          MOVE      KEY3,F3
          BRANCH    F3,SPMAS010,SPMAS020,SPMAS030,SPMAS040,SPMAS050:
                       SPMAS060,SPMAS070,SPMAS080,SPMAS090,SPMAS100:
                       SPMAS110,SPMAS120,SPMAS130,SPMAS140,SPMAS150:
                       SPMAS160,SPMAS170,SPMAS180,SPMAS190
.
          MOVE      ONE,EXIT 
          GOTO      SPMAS999    
.
SPMAS010  MOVE      QRYDATA,NHMAS001
          GOTO      SPMAS999
.
SPMAS020  MOVE      QRYDATA,NHMAS002
          GOTO      SPMAS999
.
SPMAS030  MOVE      QRYDATA,NHMAS003
          GOTO      SPMAS999
.
SPMAS040  MOVE      QRYDATA,NHMAS004
          GOTO      SPMAS999
.
SPMAS050  MOVE      QRYDATA,NHMAS005
          GOTO      SPMAS999
.
SPMAS060  MOVE      QRYDATA,NHMAS006
          GOTO      SPMAS999
.
SPMAS070  MOVE      QRYDATA,NHMAS007
          GOTO      SPMAS999
.
SPMAS080  MOVE      QRYDATA,NHMAS008
          GOTO      SPMAS999
.
SPMAS090  MOVE      QRYDATA,NHMAS009
          GOTO      SPMAS999
.
SPMAS100  MOVE      QRYDATA,NHMAS010
          GOTO      SPMAS999
.
SPMAS110  MOVE      QRYDATA,KEY11      * Date format changed back to 0000,00,00
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      NHMAS011,CCENT,CYEAR,CMON,CDAY
            REP       " 0",NHMAS011
          ENDIF
          GOTO      SPMAS999
.
SPMAS120  MOVE      QRYDATA,KEY11      * Date format changed back to 0000,00,00
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      NHMAS012,CCENT,CYEAR,CMON,CDAY
            REP       " 0",NHMAS012
          ENDIF
          GOTO      SPMAS999
.
SPMAS130  MOVE      QRYDATA,NHMAS013
          GOTO      SPMAS999
.
SPMAS140  PACK      NHMAS014,QRYDATA,SP70
...SQUEEZE   QRYDATA
...          MOVE      QRYDATA,KEY1
...          MOVE      KEY1,NHMAS014
...          MATCH     SP70,NHMAS014
...          IF        @EQUAL
...            MOVE      "N",NHMAS014
...          ELSE
...            MOVE      "Y",NHMAS014
...          ENDIF
          GOTO      SPMAS999
.
SPMAS150  MOVE      QRYDATA,NHMAS015
          GOTO      SPMAS999
.
SPMAS160  MOVE      QRYDATA,NHMAS016
          GOTO      SPMAS999
.
SPMAS170  MOVE      QRYDATA,NHMAS017
          GOTO      SPMAS999
.
SPMAS180  MOVE      QRYDATA,NHMAS018
          GOTO      SPMAS999
.
SPMAS190  MOVE      QRYDATA,KEY1
          MOVE      KEY1,NHMAS019
          MOVE      KEY1,SAVEALIA
          GOTO      SPMAS999
.
SPMAS999  RETURN
.------------------------------------------------------------
. Set NHDNR cgi parameters
.------------------------------------------------------------
SPDNR000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPDNR010,SPDNR020,SPDNR030,SPDNR040,SPDNR050:
                       SPDNR060,SPDNR070,SPDNR080,SPDNR090,SPDNR100:
                       SPDNR110,SPDNR120,SPDNR130,SPDNR140
.
          MOVE      ONE,EXIT 
          GOTO      SPDNR999    
.
SPDNR010  MOVE      QRYDATA,KEY1
          ENDSET    NHDNR001
          APPEND    KEY1,NHDNR001
          RESET     NHDNR001
          GOTO      SPDNR999
.
SPDNR020  MOVE      QRYDATA,NHDNR002
          GOTO      SPDNR999
.
SPDNR030  MOVE      QRYDATA,NHDNR003
          GOTO      SPDNR999
.
SPDNR040  MOVE      QRYDATA,NHDNR004
          GOTO      SPDNR999
.
SPDNR050  MOVE      QRYDATA,NHDNR005
          GOTO      SPDNR999
.
SPDNR060  MOVE      QRYDATA,NHDNR006
          GOTO      SPDNR999
.
SPDNR070  MOVE      QRYDATA,NHDNR007
          GOTO      SPDNR999
.
SPDNR080  MOVE      QRYDATA,NHDNR008
          GOTO      SPDNR999
.
SPDNR090  MOVE      QRYDATA,NHDNR009
          GOTO      SPDNR999
.
SPDNR100  MOVE      QRYDATA,NHDNR010
          GOTO      SPDNR999
.
SPDNR110  MOVE      QRYDATA,NHDNR011
          GOTO      SPDNR999
.
SPDNR120  MOVE      QRYDATA,NHDNR012
          GOTO      SPDNR999
.
SPDNR130  MOVE      QRYDATA,NHDNR013
          GOTO      SPDNR999
.
SPDNR140  MOVE      QRYDATA,NHDNR014
          GOTO      SPDNR999
.
SPDNR999  RETURN
.------------------------------------------------------------
. Set NHALI cgi parameters
.------------------------------------------------------------
SPALI000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPALI010,SPALI020,SPALI030,SPALI040,SPALI050
.
          MOVE      ONE,EXIT 
          GOTO      SPALI999    
.
SPALI010  PACK      NHALI001,QRYDATA,SP70
          GOTO      SPALI999
.
SPALI020  PACK      NHALI002,QRYDATA,SP70
          GOTO      SPALI999
.
SPALI030  PACK      NHALI003,QRYDATA,SP70
          GOTO      SPALI999
.
SPALI040  PACK      NHALI004,QRYDATA,SP70
          GOTO      SPALI999
.
SPALI050  MOVE      QRYDATA,NHALI005
          GOTO      SPALI999
.
SPALI999  RETURN
.------------------------------------------------------------
. Set NHMWS cgi parameters
.------------------------------------------------------------
SPMWS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMWS010,SPMWS020,SPMWS030,SPMWS040,SPMWS050:
                       SPMWS060
.
          MOVE      ONE,EXIT 
          GOTO      SPMWS999    
.
SPMWS010  PACK      NHMWS001,QRYDATA,SP70
          GOTO      SPMWS999
.
SPMWS020  MOVE      QRYDATA,KEY11      * Date format changed back to 0000,00,00
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      NHMWS002,CCENT,CYEAR,CMON,CDAY
            REP       " 0",NHMWS002
          ENDIF
          GOTO      SPMWS999
.
SPMWS030  PACK      NHMWS003,QRYDATA,SP70
          GOTO      SPMWS999
.
SPMWS040  PACK      NHMWS004,QRYDATA,SP70
          GOTO      SPMWS999
.
SPMWS050  MOVE      QRYDATA,NHMWS005
          GOTO      SPMWS999
.
SPMWS060  MOVE      QRYDATA,NHMWS006
          GOTO      SPMWS999
.
SPMWS999  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      NMAS0000
          GOTO      PROFLD99
.
PROFLD13  CALL      ERRM0000
          GOTO      PROFLD99
.
PROFLD14  CALL      RESI0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      NMAS0000
          GOTO      PROFLD99
.
PROFLD23  CALL      NDNR0000
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      NMAS0000
          GOTO      PROFLD99
.
PROFLD33  CALL      NALI0000
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD42  CALL      NMAS0000
          GOTO      PROFLD99
.
PROFLD43  CALL      NMWS0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
.  NHI Basic Patient Details
.------------------------------------------------------------
NMAS0000  BRANCH    FLDITMNO,NMAS0010,NMAS0020,NMAS0030,NMAS0040,NMAS0050:
                             NMAS0060,NMAS0070,NMAS0080,NMAS0090,NMAS0100:
                             NMAS0110,NMAS0120,NMAS0130,NMAS0140,NMAS0150:
                             NMAS0160,NMAS0170,NMAS0180,NMAS0190,NMAS0200:
                             NMAS0210,NMAS0220,NMAS0230,NMAS0240,NMAS0250:
                             NMAS0260,NMAS0270,NMAS0280,NMAS0290,NMAS0300:
                             NMAS0310,NMAS0320,NMAS0330,NMAS0340,NMAS0350:
                             NMAS0360,NMAS0370,NMAS0380,NMAS0390,NMAS0400:
                             NMAS0410,NMAS0420,NMAS0430,NMAS0440,NMAS0450:
                             NMAS0460,NMAS0470,NMAS0480,NMAS0490,NMAS0500:
                             NMAS0510,NMAS0520
          GOTO      NMAS9999
.
NMAS0010  MATCH     SP70,NZIBSURN
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBSURN
          WRITE     HTMLFILE;NZIBSURN;
          GOTO      NMAS9999
.
NMAS0020  MATCH     SP70,NZIBGIV1
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBGIV1
          WRITE     HTMLFILE;NZIBGIV1;
          GOTO      NMAS9999
.
NMAS0030  MATCH     SP70,NZIBGIV2
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBGIV2
          REP       "* ",NZIBGIV2
          WRITE     HTMLFILE;NZIBGIV2;
          GOTO      NMAS9999
.
NMAS0040  MATCH     SP70,NZIBGIV3
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBGIV3
          REP       "* ",NZIBGIV3
          WRITE     HTMLFILE;NZIBGIV3;
          GOTO      NMAS9999
.
NMAS0050  MATCH     SP70,NZIBPRNM
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBPRNM
          REP       "* ",NZIBPRNM
          WRITE     HTMLFILE;NZIBPRNM;
          GOTO      NMAS9999
.
NMAS0060  MATCH     SP70,NZIBADD1
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBADD1
          WRITE     HTMLFILE;NZIBADD1;
          GOTO      NMAS9999
.
NMAS0070  MATCH     SP70,NZIBADD2
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBADD2
          WRITE     HTMLFILE;NZIBADD2;
          GOTO      NMAS9999
.
NMAS0080  MATCH     SP70,NZIBSUBR
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBSUBR
          WRITE     HTMLFILE;NZIBSUBR;
          GOTO      NMAS9999
.
NMAS0090  MATCH     SP70,NZIBCITY
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NZIBCITY
          WRITE     HTMLFILE;NZIBCITY;
          GOTO      NMAS9999
.
NMAS0100  MATCH     SP70,NZIBCTRY
          GOTO      NMAS9999 IF EQUAL
          WRITE     HTMLFILE;NZIBCTRY;
          GOTO      NMAS9999
.
NMAS0110  MATCH     SP70,NZIBDOB
          GOTO      NMAS9999 IF EQUAL
          UNPACK    NZIBDOB,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMAS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMAS9999
.
NMAS0120  MATCH     SP70,NZIBDDTH
          GOTO      NMAS9999 IF EQUAL
          UNPACK    NZIBDDTH,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMAS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMAS9999
.
NMAS0130  MATCH     SP70,NZIBDOMC
          GOTO      NMAS9999 IF EQUAL
          WRITE     HTMLFILE;NZIBDOMC;
          GOTO      NMAS9999
.
NMAS0140  MATCH     SP70,NZIBRESI
          GOTO      NMAS9999 IF EQUAL
          WRITE     HTMLFILE;NZIBRESI;
          GOTO      NMAS9999
.
NMAS0150  MOVE      NZIBETHN,ETHNICIT 
          CALL      ETHITM00                * Ethnicity Selection List
          GOTO      NMAS9999
.
NMAS0160  MOVE      NZIBETH2,ETHNICIT 
          CALL      ETHITM00                * Ethinicity Selection List
          GOTO      NMAS9999
.
NMAS0170  MOVE      NZIBETH3,ETHNICIT 
          CALL      ETHITM00                * Ethnicity Selection List
          GOTO      NMAS9999
.
NMAS0180  WRITE     HTMLFILE;NZIBSEX;
          GOTO      NMAS9999
.
NMAS0190  PACK      KEY16,NHMADAT,NHMATIM 
          REP       " 0",KEY16
          WRITE     HTMLFILE;KEY16;
          GOTO      NMAS9999
.
NMAS0200  WRITE     HTMLFILE;;
          GOTO      NMAS9999
.
NMAS0210  MATCH     SP70,NHMASURN
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMASURN
          WRITE     HTMLFILE;NHMASURN;
          GOTO      NMAS9999
.
NMAS0220  MATCH     SP70,NHMAGIV1
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAGIV1
          WRITE     HTMLFILE;NHMAGIV1;
          GOTO      NMAS9999
.
NMAS0230  MATCH     SP70,NHMAGIV2
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAGIV2
          WRITE     HTMLFILE;NHMAGIV2;
          GOTO      NMAS9999
.
NMAS0240  MATCH     SP70,NHMAGIV3
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAGIV3
          WRITE     HTMLFILE;NHMAGIV3;
          GOTO      NMAS9999
.
NMAS0250  WRITE     HTMLFILE;NHMAPREI;
          GOTO      NMAS9999
.
NMAS0260  MATCH     SP70,NHMAADD1
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAADD1
          WRITE     HTMLFILE;NHMAADD1;
          GOTO      NMAS9999
.
NMAS0270  MATCH     SP70,NHMAADD2
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAADD2
          WRITE     HTMLFILE;NHMAADD2;
          GOTO      NMAS9999
.
NMAS0280  MATCH     SP70,NHMAADD3
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAADD3
          WRITE     HTMLFILE;NHMAADD3;
          GOTO      NMAS9999
.
NMAS0290  MATCH     SP70,NHMAADD4
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAADD4
          WRITE     HTMLFILE;NHMAADD4;
          GOTO      NMAS9999
.
NMAS0300  MATCH     SP70,NHMAADD5
          GOTO      NMAS9999 IF EQUAL
          REP       "#" ",NHMAADD5
          WRITE     HTMLFILE;NHMAADD5;
          GOTO      NMAS9999
.
NMAS0310  MATCH     SP70,NHMADOB
          GOTO      NMAS9999 IF EQUAL
          UNPACK    NHMADOB,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMAS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMAS9999
.
NMAS0320  MATCH     SP70,NHMADDTH
          GOTO      NMAS9999 IF EQUAL
          UNPACK    NHMADDTH,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMAS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMAS9999
.
NMAS0330  MATCH     SP70,NHMADOMC
          GOTO      NMAS9999 IF EQUAL
          WRITE     HTMLFILE;NHMADOMC;
          GOTO      NMAS9999
.
NMAS0340  WRITE     HTMLFILE;NHMARES;
          GOTO      NMAS9999
.
NMAS0350  MOVE      NHMAETH,ETHNICIT 
          CALL      ETHITM00                * Ethnicity Selection List
          GOTO      NMAS9999
.
NMAS0360  MOVE      NHMAETH2,ETHNICIT
          CALL      ETHITM00                * Ethnicity Selection List
          GOTO      NMAS9999
.
NMAS0370  MOVE      NHMAETH3,ETHNICIT 
          CALL      ETHITM00                * Ethnicity Selection List
          GOTO      NMAS9999
.
NMAS0380  WRITE     HTMLFILE;NHMASEX;
          GOTO      NMAS9999
.
NMAS0390  WRITE     HTMLFILE;NZIBNMPI;
          GOTO      NMAS9999
.
NMAS0400  REP       "#" ",PGNAME  
          WRITE     HTMLFILE;PGNAME;
          GOTO      NMAS9999
.
NMAS0410  REP       "#" ",PADD1   
          WRITE     HTMLFILE;PADD1;
          GOTO      NMAS9999
.
NMAS0420  REP       "#" ",PADD2
          WRITE     HTMLFILE;PADD2;
          GOTO      NMAS9999
.
NMAS0430  REP       "#" ",PSUBRB
          WRITE     HTMLFILE;PSUBRB;
          GOTO      NMAS9999
.
NMAS0440  REP       "#" ",PADD4
          WRITE     HTMLFILE;PADD4;
          GOTO      NMAS9999
.
NMAS0450  MATCH     SP70,UPERRMSG
          GOTO      NMAS9999 IF EQUAL
          WRITE     HTMLFILE;UPERRMSG;
          GOTO      NMAS9999
.
NMAS0460  WRITE     HTMLFILE;NZIBNMPI;
          GOTO      NMAS9999
.
NMAS0470  MOVE      BABDDSC0,BABDDESC
          LOAD      BABDDESC,PTCNBABD,BABDDSC1
          ENDSET    BABDDESC
          APPEND    NZIBGIV1,BABDDESC
          RESET     BABDDESC
          WRITE     HTMLFILE;BABDDESC            *Baby Name Description
          GOTO      NMAS9999
.
NMAS0480  MATCH     SP70,NZIBLAST
          GOTO      NMAS9999 IF EQUAL
          UNPACK    NZIBLAST,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMAS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMAS9999
.
NMAS0490  MATCH     SP70,NHMADAT
          GOTO      NMAS9999 IF EQUAL
          UNPACK    NHMADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMAS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMAS9999
.
NMAS0500  WRITE     HTMLFILE;CPMISKEY;
          GOTO      NMAS9999
.
NMAS0510  MOVE      "G ",CATEGORY
          MOVE      NZIBSEX,CODE
          CALL      CODITM00
          GOTO      NMAS9999
.
NMAS0520  MOVE      "G ",CATEGORY
          MOVE      NHMASEX,CODE
          CALL      CODITM00
          GOTO      NMAS9999
.
NMAS9999  RETURN
.------------------------------------------------------------
.  Ethnicity Code Output
.------------------------------------------------------------
ETHITM00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ETHITM10,ETHITM20
          MATCH     SP70,ETHNICIT
          GOTO      ETHITM99 IF EQUAL
.
          MOVE      ETHNICIT,KEY5
          CALL      RDNHETH1
          BRANCH    OVRCD,ETHITM99
.
          WRITE     HTMLFILE;NHETDES;
          GOTO      ETHITM99
.
ETHITM10  MATCH     SP70,ETHNICIT
          GOTO      ETHITM99 IF EQUAL
          WRITE     HTMLFILE;ETHNICIT;
          GOTO      ETHITM99
.
ETHITM20  CALL      ETHSEL00
.
ETHITM99  RETURN
.------------------------------------------------------------
.  Ethnicity Selection List
.------------------------------------------------------------
ETHSEL00  PACK      KEY5,SP70
          CALL      RSNHETH1
ETHSEL10  CALL      RKNHETH1 
          BRANCH    OVRCD,ETHSEL99
.
          MATCH     ETHNICIT,NHETECD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",NHETECD," selected>(":
                               NHETECD,") ",NHETDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",NHETECD,">(":
                               NHETECD,") ",NHETDES,"</option>"
          ENDIF
          GOTO      ETHSEL10
.
ETHSEL99  RETURN                                      
.------------------------------------------------------------
.  Relationship Code Output
.------------------------------------------------------------
RELITM00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,RELITM10,RELITM20
          MATCH     SP70,NZIBRELC
          GOTO      RELITM99 IF EQUAL
.
          MOVE      NZIBRELC,KEY2
          CALL      RDNHREL1
          BRANCH    OVRCD,RELITM99
.
          WRITE     HTMLFILE;NHREDES;
          GOTO      RELITM99
.
RELITM10  MATCH     SP70,NZIBRELC
          GOTO      RELITM99 IF EQUAL
          WRITE     HTMLFILE;NZIBRELC;
          GOTO      RELITM99
.
RELITM20  CALL      RELSEL00
.
RELITM99  RETURN
.------------------------------------------------------------
.  Relationship Selection List
.------------------------------------------------------------
RELSEL00  PACK      KEY2,SP70
          CALL      RSNHREL1
RELSEL10  CALL      RKNHREL1 
          BRANCH    OVRCD,RELSEL99
.
          MATCH     NZIBRELC,NHRERCD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",NHRERCD," selected>":
                               NHREDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",NHRERCD,">":
                               NHREDES,"</option>"
          ENDIF
          GOTO      RELSEL10
.
RELSEL99  RETURN                                      
.------------------------------------------------------------
.  Residency details
.------------------------------------------------------------
RESI0000  BRANCH    FLDITMNO,RESI0010,RESI0020,RESI0030,RESI0040,RESI0050:
                             RESI0060,RESI0070,RESI0080,RESI0090,RESI0100:
                             RESI0110,RESI0120,RESI0130,RESI0140,RESI0150:
                             RESI0160
.
RESI0010  MOVE      "C ",CATEGORY
          MOVE      PMRSCONT,CODE
          CALL      CODITM00
          GOTO      RESI9999
.
RESI0020  MATCH     SP70,PMRSTEXP
          GOTO      RESI9999 IF EQUAL
          UNPACK    PMRSTEXP,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESI9999
.
RESI0030  MATCH     SP70,PMRSGRDT
          GOTO      RESI9999 IF EQUAL
          UNPACK    PMRSGRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESI9999
.
RESI0040  WRITE     HTMLFILE;PMRSCOMM;
          GOTO      RESI9999
.
RESI0050  CALL      CHKRES00             * Check for residency expiry
          WRITE     HTMLFILE;EXIT;
          GOTO      RESI9999
.
RESI0060  MATCH     SP70,PMRSVISN
          GOTO      RESI9999 IF EQUAL
.
          WRITE     HTMLFILE;PMRSVISN;
          GOTO      RESI9999
.
RESI0070  WRITE     HTMLFILE;EMERFLAG;
          GOTO      RESI9999
. 
RESI0080  WRITE     HTMLFILE;PMRSSTDN;
          GOTO      RESI9999
.
RESI0090  WRITE     HTMLFILE;SUPERLEV;
          GOTO      RESI9999
.
RESI0100  WRITE     HTMLFILE;SAVEADD1;
          GOTO      RESI9999
.
RESI0110  WRITE     HTMLFILE;SAVEADD2;
          GOTO      RESI9999
.
RESI0120  WRITE     HTMLFILE;SAVESUBR;
          GOTO      RESI9999
.
RESI0130  WRITE     HTMLFILE;SAVECITY;
          GOTO      RESI9999
.
RESI0140  WRITE     HTMLFILE;SAVECTRY;
          GOTO      RESI9999
.
RESI0150  WRITE     HTMLFILE;SAVEDOMC;
          GOTO      RESI9999
.
RESI0160  WRITE     HTMLFILE;UPDTTYPE;
          GOTO      RESI9999
.
RESI9999  RETURN
.------------------------------------------------------------
.  Basic Patient Details 
.------------------------------------------------------------
PTDET000  MOVE      ZERO,NEWREG
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PTDET500 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      PTDET100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      PTDET200 IF EQUAL
.
          MATCH     "S",UPDTTYPE            * Show National & Local Details
          GOTO      PTDET500 IF EQUAL
.
          GOTO      PTDET910               
.
PTDET100  CALL      ADDNHI00                * Reg. New NHI Basic Patient Details
          BRANCH    EXIT,PTDET999
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            CALL      EMRREG00
          ENDIF
.
          GOTO      PTDET400
.
PTDET200  CALL      UPDNHI00                * Update NHI Basic Patient Details
          BRANCH    EXIT,PTDET999
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            CALL      EMRREG00
          ENDIF
.
          GOTO      PTDET400
.
PTDET400  CALL      NXTPAG00
          BRANCH    EXIT,PTDET999
.
PTDET500  MOVE      ZERO,LOCALFLG           * Flag Local Record
.
          MOVE      SP70,SAVEADD1
          MOVE      SP70,SAVEADD2
          MOVE      SP70,SAVESUBR
          MOVE      SP70,SAVECITY
          MOVE      SP70,SAVECTRY
          MOVE      SP70,SAVEDOMC
.
          CALL      CLRNZIB0                * Clear National details
          CALL      CLNHIMAS                * Clear Local details
          CALL      CLPATMAS
          CALL      CLPMSRES
          MATCH     SP70,URNUMBER           * Registration Form if Blank
          GOTO      PTDET510 IF NOT EQUAL   * Process Form
          MATCH     SP70,NHIHCUID           * Registration Form if Blank
          IF        @EQUAL
            MOVE      ONE,NEWREG
            GOTO      PTDET600              * Process Form
          ENDIF
.
          MOVE      NHIHCUID,KEY7
          MOVE      NHIHCUID,NZIBNMPI
          CALL      CONNECT
          BRANCH    EXIT,PTDET999
          CALL      GETHCU                  * Read National Details
          IF        OVRCD<>1
            GOTO      PTDET505
          ENDIF
.
          MATCH     "2097",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      PTDET505
          ENDIF
.
          MATCH     "2033",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      PTDET505
          ENDIF
.
          MATCH     "2034",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      PTDET505
          ENDIF
.
          GOTO      PTDET900
.
PTDET505  PACK      KEY7,NHIHCUID,SP70
          CALL      RDNHMAS1                * Read Local NHI Details
          IF        OVRCD=0
            MOVE      NHMANMPI,NHIHCUID
            MOVE      NHMAURNO,URNUMBER
.
            MOVE      NHMAADD1,SAVEADD1
            MOVE      NHMAADD2,SAVEADD2
            MOVE      NHMAADD3,SAVESUBR
            MOVE      NHMAADD4,SAVECITY
            MOVE      NHMAADD5,SAVECTRY
            MOVE      NHMADOMC,SAVEDOMC
.
            MOVE      NHMAURNO,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,PTDET920
            MATCH     SP70,NZIBMWST
            IF        !@EQUAL
              MATCH     "2",PTMXSIN1
              IF        !@EQUAL
                MATCH     SP70,PTMXSIN1
                IF        @EQUAL
                  MOVE      "1",PTMXSIN1
                  CALL      UPMAST1
                ENDIF
              ENDIF
            ENDIF
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            PACK      KEY8,PURNO,SP70
            CALL      RDPMRES1
            IF        OVRCD=1
              CALL      CLPMSRES
            ENDIF
          ELSE
            MOVE      ONE,LOCALFLG          * Not on Local database flag
            CALL      NTOL0000
          ENDIF
.
          GOTO       PTDET520               
.
PTDET510  PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          IF        OVRCD=0
            MOVE      NHMANMPI,NHIHCUID
            MOVE      NHMANMPI,NZIBNMPI
.
            MOVE      NHMAADD1,SAVEADD1
            MOVE      NHMAADD2,SAVEADD2
            MOVE      NHMAADD3,SAVESUBR
            MOVE      NHMAADD4,SAVECITY
            MOVE      NHMAADD5,SAVECTRY
            MOVE      NHMADOMC,SAVEDOMC
.
          ELSE
            MOVE      URNUMBER,NZIBNMPI
          ENDIF
          CALL      CONNECT
          BRANCH    EXIT,PTDET999
          CALL      GETHCU                  * Read National Details
          IF        OVRCD<>1
            GOTO      PTDET515
          ENDIF
.
          MATCH     "2097",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            GOTO      PTDET515
          ENDIF
.
          MATCH     "2033",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            GOTO      PTDET515
          ENDIF
.
          MATCH     "2034",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            GOTO      PTDET515
          ENDIF
.
.          MATCH     "2034",NZIBERRN
.          IF        @EQUAL
.            CLEAR     WEBTITLE
.            APPEND    NZIBERRN,WEBTITLE
.            APPEND    "- ",WEBTITLE
.            REP       "#" ",NZIBERRD
.            REP       "' ",NZIBERRD
.            APPEND    NZIBERRD,WEBTITLE
.            RESET     WEBTITLE
..
.            CALL      GOBACK00
.            MOVE      ONE,EXIT
.            GOTO      PTDET999
.          ENDIF
.
          MATCH     "1002",NZIBERRN
          IF        @EQUAL
            CLEAR     WEBTITLE
            APPEND    NZIBERRN,WEBTITLE
            APPEND    "- ",WEBTITLE
            REP       "#" ",NZIBERRD
            REP       "' ",NZIBERRD
            APPEND    NZIBERRD,WEBTITLE
            RESET     WEBTITLE
.
            CALL      GOBACK00
            MOVE      ONE,EXIT
            GOTO      PTDET999
          ENDIF
.
          GOTO      PTDET900
.
PTDET515  PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          IF        OVRCD=0
            MOVE      NHMANMPI,NHIHCUID
.
            MOVE      NHMAADD1,SAVEADD1
            MOVE      NHMAADD2,SAVEADD2
            MOVE      NHMAADD3,SAVESUBR
            MOVE      NHMAADD4,SAVECITY
            MOVE      NHMAADD5,SAVECTRY
            MOVE      NHMADOMC,SAVEDOMC
.
            MOVE      NHMAURNO,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,PTDET920
            MATCH     SP70,NZIBMWST
            IF        !@EQUAL
              MATCH     "2",PTMXSIN1
              IF        !@EQUAL
                MATCH     SP70,PTMXSIN1
                IF        @EQUAL
                  MOVE      "1",PTMXSIN1
                  CALL      UPMAST1
                ENDIF
              ENDIF
            ENDIF
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            PACK      KEY8,PURNO,SP70
            CALL      RDPMRES1
            IF        OVRCD=1
              CALL      CLPMSRES
            ENDIF
          ELSE
            MOVE      ONE,LOCALFLG          * Not on Local database flag
            CALL      NTOL0000
          ENDIF
.
PTDET520  MATCH     "S",UPDTTYPE            * Show National & Local Details
          IF        @EQUAL
            IF         LOCALFLG=1
              MOVE      "Patient NOT on Local Database",WEBTITLE
              CALL      WEBERR00
              MOVE      ONE,EXIT
              GOTO      PTDET999
            ENDIF
          ELSE
            MATCH     "2097",NZIBERRN
            IF        !@EQUAL
              MATCH     "2033",NZIBERRN
              IF        !@EQUAL
                MATCH     "2034",NZIBERRN
                IF        !@EQUAL
                  CALL      NTOL0000
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CALL      FORGIV00        * Format Given Name
          CALL      FORADD00        * Format Address
.
PTDET600  MOVE      "NHI/MWS Patient Details",WEBTITLE
          CALL      WEBHED00    * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PTDET999
.
          CALL      WEBBOD00    * Process Web Body
          IF        NEWREG=0 & LOCALFLG<>1
            MATCH     "2097",NZIBERRN
            IF        !@EQUAL
              MATCH     "2033",NZIBERRN
              IF        !@EQUAL
                MATCH     "2034",NZIBERRN
                IF        !@EQUAL
                  CALL      VALHCU00
                  BRANCH    EXIT,PTDET999
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CALL      WEBEND00    * Process End of HTML File 
          MOVE      ZERO,EXIT
          GOTO      PTDET999
.
PTDET900  CALL      NHERR000                * display error message
          MOVE      ONE,EXIT
          GOTO      PTDET999
.
PTDET910  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTDET999
.
PTDET920  MOVE      "Invalid Patient Master Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTDET999
.
PTDET999  RETURN
.------------------------------------------------------------
. Add NHI Basic Patient Details
.------------------------------------------------------------
ADDNHI00  MATCH     URNUMBER,SP70
          GOTO      ADDNHI98 IF NOT EQUAL
          CALL      CLNHIMAS                * Clear Local details
          CALL      CLPATMAS                * Clear Local details
          CALL      CLPMSPX2                * clear mast ext2 details
.
          MATCH     SP70,MURNUMBR
          IF        @EQUAL
            GOTO      ADDNHI05
          ENDIF
.
          PACK      KEY8,MURNUMBR,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
            CALL      CLPMSPX2
            GOTO      ADDNHI05
          ENDIF
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,MURNUMBR,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          IF        OVRCD=1
            CALL      CLNHIMAS
          ENDIF
          CALL      SVMTHMAS                * save mothers pmi details
          CALL      CLPATMAS                * clear master detils
          CALL      CLPMSPX2                * clear mast ext2 details
          CALL      CLNHIMAS
          CALL      DEFMAS00                * default master details
.
ADDNHI05  CALL      MVNHI000                * Move nhi parameters to local vars
.
          CALL      LOCNHI00                * Move Local to National
.
          REP       "* ",NZIBETH2
          REP       "* ",NZIBETH3
          REP       "* ",NZIBGIV2
          REP       "* ",NZIBGIV3
          REP       "* ",NZIBADD2
          REP       "* ",NZIBSUBR
          REP       "* ",NZIBCITY
          REP       "* ",NZIBCTRY
          REP       "* ",NZIBDDTH
          MOVE      " ",NZIBSCRB  * Clear Overide Flags
          MOVE      " ",NZIBDUPL
          MOVE      " ",NZIBUPDT
.
          MATCH     "1",ASPRENHI            * Assign pre allocated NHI
          IF        @EQUAL
            SQUEEZE    PALLCNHI             * Remove all white space
            PACK       NZIBPANO,PALLCNHI,SP70
          ELSE
            MOVE       SP70,NZIBPANO
          ENDIF
.
ADDNHI10  MATCH     SP70,OVERRIDE
          CALL      OVRRID00 IF NOT EQUAL
          CALL      NEWHCU
          IF        OVRCD=1
            MATCH     "2097",NZIBERRN
            IF        @EQUAL
              CALL      GATUR000
            ELSE
              MATCH     "2033",NZIBERRN
              IF        @EQUAL
                CALL      GATUR000
              ELSE
                MATCH     "2034",NZIBERRN
                IF        @EQUAL
                  CALL      GATUR000
                ELSE
                  GOTO      ADDNHI95
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CALL      RETUP000       * Move Changed Fields back to NHMA Fields
.
          MOVE      NZIBNMPI,KEY7
          MOVE      NZIBNMPI,NHMANMPI
          IF        PTCNNZUR=1
            PACK      NHMAURNO,SP1,NZIBNMPI
          ELSE
            CALL      LOCUR000
            MOVE      PURNO,NHMAURNO
          ENDIF
.
          PACK      KEY8,NHMAURNO,SP70
          CALL      RANHMAS2
          IF        OVRCD=0
            CLEAR     WEBTITLE
            APPEND    "ERROR: Local UR ",WEBTITLE
            APPEND    KEY8,WEBTITLE
            APPEND    " Already Exists. - ",WEBTITLE
            RESET     WEBTITLE
            CALL      WEBERR00
            GOTO      ADDNHI90
          ENDIF
.
          CALL      RANHMAS1
          IF        OVRCD=1
            CALL      IBACLOCK
            CLOCK     TIME,NHMATIM
            PACK      NHMADAT,CCC,CYY,CMM,CDD
            REP       " 0",NHMADAT
            CALL      WRNHMAS1      * Got there now write the record.
            MOVE      ONE,AUDTTYPE
            CALL      WANHMA00
          ELSE
            CLEAR     WEBTITLE
            APPEND    "ERROR: NHI HCU ID ",WEBTITLE
            APPEND    KEY7,WEBTITLE
            APPEND    " Already Exists. - ",WEBTITLE
            RESET     WEBTITLE
            CALL      WEBERR00
          ENDIF
.
          CALL      SETPMI00              * Setup PMI Variables
          CALL      UPVPMI00                * Move mast ext2 parm into file vars
          MOVE      WBSEHOSP,PMPXIHOS
          MOVE      WBSEUID,PMPXWBID
          CALL      WRTUR                 * Write PMI Details
          MOVE      PURNO,URNUMBER
          CALL      UPRES000
          CALL      WEXP0000              * Write expected payor details
.
ADDNHI90  MOVE      PURNO,URNUMBER
          MOVE      ZERO,EXIT             * New Record Created OK
          GOTO      ADDNHI99
.
.
ADDNHI95  CALL      UPDERR00              * Display Error on New Record
          MOVE      ONE,EXIT              * Return to Input Screen
          GOTO      ADDNHI99
.
ADDNHI98  MOVE      "Error: U/R Number Set",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDNHI99
.   
ADDNHI99  RETURN
.
.------------------------------------------------------------
. Save previous data before update
.------------------------------------------------------------
SAVPRV00  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2
          IF        OVRCD=1
            CALL      CLNHIMAS
          ENDIF
.
          MOVE      NHMAETH,SNMAETH
          MOVE      NHMAETH2,SNMAETH2
          MOVE      NHMAETH3,SNMAETH3
          MOVE      NHMASURN,SNMASURN
          MOVE      NHMAGIV1,SNMAGIV1
          MOVE      NHMAGIV2,SNMAGIV2
          MOVE      NHMAGIV3,SNMAGIV3
          MOVE      NHMASEX,SNMASEX
          MOVE      NHMADOB,SNMADOB
          MOVE      NHMAADD1,SNMAADD1
          MOVE      NHMAADD2,SNMAADD2
          MOVE      NHMAADD3,SNMAADD3
          MOVE      NHMAADD4,SNMAADD4
          MOVE      NHMAADD5,SNMAADD5
.
          MOVE      PMRSCONT,SPRSCONT
          MOVE      PMRSTEXP,SPRSTEXP
          MOVE      PMRSVISN,SPRSVISN
          MOVE      PMRSSTDN,SPRSSTDN
          MOVE      PMRSCOMM,SPRSCOMM
. 
          MOVE      PTYPE,SPTYPE  
.
SAVPRV99  RETURN
.
.------------------------------------------------------------
. Write out pmsdauaf for changes details
.------------------------------------------------------------
DEATHA00  
.
. Type 009
.
          MOVE      ZERO,FORM2
.
          MATCH     NHMAS016,SNMAETH
          IF        @EQUAL
            MOVE      SP70,PNHETHN1
          ELSE
            MOVE      SNMAETH,PNHETHN1
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     NHMAS017,SNMAETH2
          IF        @EQUAL
            MOVE      SP70,PNHETHN2
          ELSE
            MOVE      SNMAETH2,PNHETHN2
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     NHMAS018,SNMAETH3
          IF        @EQUAL
            MOVE      SP70,PNHETHN3
          ELSE
            MOVE      SNMAETH3,PNHETHN3
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE    ZERO,FORM2
          IF         @EQUAL
            GOTO       DEATHA10
          ENDIF
.
          MOVE       "009",D3
          CALL       WDAU0000
.
. Type 010
.
DEATHA10  MOVE      ZERO,FORM2
.
          MATCH     PMRES001,SPRSCONT
          IF        @EQUAL
            MOVE      SP70,PPRSCONT
          ELSE
            MOVE      SPRSCONT,PPRSCONT
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PTMAS021,SPTYPE
          IF        @EQUAL
            MOVE      SP70,PPTYPE
          ELSE
            MOVE      SPTYPE,PPTYPE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PMRES002,SPRSTEXP
          IF        @EQUAL
            MOVE      SP70,PPRSTEXP
          ELSE
            MOVE      SPRSTEXP,PPRSTEXP
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PMRES005,SPRSVISN
          IF        @EQUAL
            MOVE      SP70,PPRSVISN
          ELSE
            MOVE      SPRSVISN,PPRSVISN
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PMRES014,SPRSSTDN
          IF        @EQUAL
            MOVE      SP70,PPRSSTDN
          ELSE
            MOVE      SPRSSTDN,PPRSSTDN
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PMRES004,SPRSCOMM
          IF        @EQUAL
            MOVE      SP70,PPRSCOMM
          ELSE
            MOVE      SPRSCOMM,PPRSCOMM
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE    ZERO,FORM2
          IF         @EQUAL
            GOTO       DEATHA20
          ENDIF
.
          MOVE       "010",D3
          CALL       WDAU0000
.
. Type 005
.
DEATHA20  MOVE      ZERO,FORM2
.
          MATCH     NHMAS001,SNMASURN
          IF        @EQUAL
            MOVE      SP70,SAVESNAM
          ELSE
            MOVE      SNMASURN,SAVESNAM
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     NHMAS002,SNMAGIV1
          IF        @EQUAL
            MOVE      SP70,SAVEXFNM
          ELSE
            MOVE      SNMAGIV1,SAVEXFNM
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     NHMAS003,SNMAGIV2
          IF        @EQUAL
            MOVE      SP70,SAVEXSNM
          ELSE
            MOVE      SNMAGIV2,SAVEXSNM
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     NHMAS015,SNMASEX
          IF        @EQUAL
            MOVE      SP70,SAVEPSEX
          ELSE
            MOVE      SNMASEX,SAVEPSEX
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     NHMAS011,SNMADOB
          IF        @EQUAL
            MOVE      SP70,SAVEPDOB
          ELSE
            MOVE      SNMADOB,SAVEPDOB
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE    ZERO,FORM2
          IF         @EQUAL
            GOTO       DEATHA99
          ENDIF
.
          MOVE       "005",D3
          CALL       WDAU0000
.
DEATHA99  RETURN
.
.------------------------------------------------------------
.  Move NHI parameters to local variables
.------------------------------------------------------------
MVNHI000  MOVE      NHMAS001,NHMASURN
          MOVE      NHMAS002,NHMAGIV1
          MOVE      NHMAS003,NHMAGIV2
          MOVE      NHMAS004,NHMAGIV3
          MOVE      NHMAS005,NHMAPREI
          MOVE      NHMAS006,NHMAADD1 
          MOVE      NHMAS007,NHMAADD2 
          MOVE      NHMAS008,NHMAADD3 
          MOVE      NHMAS009,NHMAADD4 
          MOVE      NHMAS010,NHMAADD5 
          MOVE      NHMAS011,NHMADOB 
          MOVE      NHMAS012,NHMADDTH 
          MOVE      NHMAS013,NHMADOMC 
          MOVE      NHMAS014,NHMARES 
          MOVE      NHMAS015,NHMASEX 
          MOVE      NHMAS016,NHMAETH 
          MOVE      NHMAS017,NHMAETH2
          MOVE      NHMAS018,NHMAETH3
.
MVNHI999  RETURN
.------------------------------------------------------------
. Move Local Variable to National for UPDHCU or NEWHCU
. Routine from IBANHI01
.----------------------------------------------------------------
LOCNHI00  MOVE     NHMASURN,NZIBSURN
          MOVE     NHMAGIV1,NZIBGIV1
.
          MATCH    SP70,NHMAGIV2
          IF       @EQUAL
            MOVE     "*",NZIBGIV2
          ELSE
            MOVE     NHMAGIV2,NZIBGIV2
          ENDIF
.
          MATCH    SP70,NHMAGIV3
          IF       @EQUAL
            MOVE     "*",NZIBGIV3
          ELSE
            MOVE     NHMAGIV3,NZIBGIV3
          ENDIF
.
          MATCH    SP70,NHMAETH2
          IF       @EQUAL
            MOVE     "*",NZIBETH2
          ELSE
            MOVE     NHMAETH2,NZIBETH2
          ENDIF
.
          MATCH    SP70,NHMAETH3
          IF       @EQUAL
            MOVE     "*",NZIBETH3
          ELSE
            MOVE     NHMAETH3,NZIBETH3
          ENDIF
.
          MOVE     NHMAPREI,NZIBPRNM
          MOVE     NHMAADD1,NZIBADD1
.
          MATCH    SP70,NHMAADD2
          IF       @EQUAL
            MOVE     "*",NZIBADD2
          ELSE
            MOVE     NHMAADD2,NZIBADD2
          ENDIF
.
          MATCH    SP70,NHMAADD3
          IF       @EQUAL
            MOVE     "*",NZIBSUBR
          ELSE
            MOVE     NHMAADD3,NZIBSUBR
          ENDIF
.
          MATCH    SP70,NHMAADD4
          IF       @EQUAL
            MOVE     "*",NZIBCITY
          ELSE
            MOVE     NHMAADD4,NZIBCITY
          ENDIF
.
          MATCH    SP70,NHMAADD5
          IF       @EQUAL
            MOVE     "*",NZIBCTRY
          ELSE
            MOVE     NHMAADD5,NZIBCTRY
          ENDIF
.
          MOVE     NHMADOB,NZIBDOB
.
          MATCH    SP70,NHMADDTH
          GOTO     LOCNHI10 IF NOT EQUAL
          MATCH    SP70,NZIBDDTH
          GOTO     LOCNHI10 IF EQUAL
          MOVE     "*",NZIBDDTH
          GOTO     LOCNHI20
.
LOCNHI10  MOVE     NHMADDTH,NZIBDDTH
LOCNHI20  MOVE     NHMADOMC,NZIBDOMC
          MOVE     NHMARES,NZIBRESI
          MOVE     NHMAETH,NZIBETHN
          PACK     ACODE,NHMASEX,SP70
          CALL     GGHDP000 * Get gender HDP
          PACK     NZIBSEX,THCSCOD
.
. Not Using Alias Facility on NEWHCU SO Clear all Fields
.
          MOVE     ZERO,NZIBACNT      * assume no aliases

          MOVE     SP70,NZIBALSR[1]
          MOVE     SP70,NZIBALG1[1]
          MOVE     SP70,NZIBALG2[1]
          MOVE     SP70,NZIBALG3[1]
          MOVE     SP70,NZIBALPN[1]
          MOVE     SP70,NZIBALSR[2]
          MOVE     SP70,NZIBALG1[2]
          MOVE     SP70,NZIBALG2[2]
          MOVE     SP70,NZIBALG3[2]
          MOVE     SP70,NZIBALPN[2]
          MOVE     SP70,NZIBALSR[3]
          MOVE     SP70,NZIBALG1[3]
          MOVE     SP70,NZIBALG2[3]
          MOVE     SP70,NZIBALG3[3]
          MOVE     SP70,NZIBALPN[3]
          MOVE     SP70,NZIBALSR[4]
          MOVE     SP70,NZIBALG1[4]
          MOVE     SP70,NZIBALG2[4]
          MOVE     SP70,NZIBALG3[4]
          MOVE     SP70,NZIBALPN[4]
.
LOCNHI99  RETURN
CLRAST00  REP       "* ",NZIBETH2
          REP       "* ",NZIBETH3
          REP       "* ",NZIBGIV2
          REP       "* ",NZIBGIV3
          REP       "* ",NZIBADD2
          REP       "* ",NZIBSUBR
          REP       "* ",NZIBCITY
          REP       "* ",NZIBCTRY
          REP       "* ",NZIBDDTH
RETURN
.------------------------------------------------------------
. Get Local U/R if Not Using National Number
. Routine from IBANHI01
. Computer generate U/R Number
.----------------------------------------------------------------------
LOCUR000  MOVE      THREE,CPSYSTEM             * Get the next inpatient U/R
          CALL      GNXTUR                     * Get next U/R Number
          MOVE      ZERO,PSTAT                 * A valid U/R
.
LOCUR999  RETURN
.------------------------------------------------------------
. GATUR000 - Generate Temporary U/R when NHI/MWS is Unavailable
.---------------------------------------------------------------------
GATUR000  MOVE      " 80",PRXCODE   * System Lock Sector 80
          CALL      GETSLK00        * Get System Lock of Sector 80
          READ      CONTROLF,EIGHTY;*223,PTCNNXTT   * Next temp NMPI
          ADD       ONE,PTCNNXTT                    * increment
          WRITAB    CONTROLF,EIGHTY;*223,PTCNNXTT   * write back to controlf
          CALL      RELSLK00        * Release System Lock of Sector 88
          MOVE      PTCNNXTT,FORM5
          MOVE      FORM5,KEY5
          REP       " 0",KEY5
          MOVE      "T-",KEY2            * Temp NHI Number Prefix with a #
          PACK      KEY7,KEY2,KEY5
          CALL      RANHMAS1            * Check for Temp Number on National
          COMPARE   ZERO,OVRCD
          GOTO      GATUR000 IF EQUAL   * U/R already exists
.
          MOVE      KEY7,NZIBNMPI
.
. Temporary new ur error was here
.
GATUR999  RETURN
.------------------------------------------------------------
. Routine from IBANHI01
. Move National Variable to Local after UPDHCU or NEWHCU
.---------------------------------------------------------------
. This will set local variables after domicile coding and
. Name and address scrubbing has occured on the NHI.
.----------------------------------------------------------------
RETUP000  MOVE     NZIBSURN,NHMASURN
          MOVE     NZIBGIV1,NHMAGIV1
          MATCH    "*",NZIBGIV2
          IF       !@EQUAL
            MOVE     NZIBGIV2,NHMAGIV2
          ENDIF
          MATCH    "*",NZIBGIV3
          IF       !@EQUAL
            MOVE     NZIBGIV3,NHMAGIV3
          ENDIF
.
          MOVE     NZIBPRNM,NHMAPREI
          MOVE     NZIBADD1,NHMAADD1
.
          MATCH    "*",NZIBADD2
          IF       !@EQUAL
            MOVE     NZIBADD2,NHMAADD2
          ENDIF
.
          MATCH    "*",NZIBSUBR
          IF       !@EQUAL
            MOVE     NZIBSUBR,NHMAADD3
          ENDIF
.
          MATCH    "*",NZIBCITY
          IF       !@EQUAL
            MOVE     NZIBCITY,NHMAADD4
          ENDIF
.
          MATCH    "*",NZIBCTRY
          IF       !@EQUAL
            MOVE     NZIBCTRY,NHMAADD5
          ENDIF
.
          MOVE     NZIBDOMC,NHMADOMC
          MOVE     NZIBETHN,NHMAETH
.
          MATCH    "*",NZIBETH2
          IF       !@EQUAL
            MOVE     NZIBETH2,NHMAETH2
          ENDIF
.
          MATCH    "*",NZIBETH3
          IF       !@EQUAL
            MOVE     NZIBETH3,NHMAETH3
          ENDIF
.
          MATCH    "*",NZIBSEX
          GOTO     RETUP999 IF EQUAL
.
. if gender HDP is equal to NHI, do not change gender
          MATCH     NZIBSEX,NHMASEX
          GOTO      RETUP999 IF EQUAL
.
          PACK      KEY5,ANSG,SP1,NHMASEX,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     THCSCOD,NZIBSEX
            GOTO      RETUP999 IF EQUAL
          ENDIF
.
          MATCH     ANSM,NZIBSEX
          GOTO      RETUP900 IF EQUAL
.
          MATCH     ANSF,NZIBSEX
          GOTO      RETUP900 IF EQUAL
.
          MATCH     ANSU,NZIBSEX
          GOTO      RETUP900 IF EQUAL
.
          MATCH     ANSO,NZIBSEX
          GOTO      RETUP900 IF EQUAL
.
          MOVE     SP70,NHMASEX
          GOTO     RETUP999
.
RETUP900  MOVE     NZIBSEX,NHMASEX
.
RETUP999  RETURN
.------------------------------------------------------------
. Format Local Given Name from National Given Names
. Routine from IBANHI01
.------------------------------------------------------------
FORGIV00  REP       UPPLOW,NHMASURN
          REP       UPPLOW,NHMAGIV1
          REP       UPPLOW,NHMAGIV2
          REP       UPPLOW,NHMAGIV3
.
          CLEAR     PGNAME                  * load PGNAME
          MOVE      NHMAGIV1,KEY20
          STRIP     KEY20
          APPEND    KEY20,PGNAME
          MATCH     SP20,NHMAGIV2
          IF        !@EQUAL
            MOVE      NHMAGIV2,KEY20
            STRIP     KEY20
            APPEND    SP1,PGNAME
            APPEND    KEY20,PGNAME
          ENDIF
          MATCH     SP20,NHMAGIV3
          IF        !@EQUAL
            MOVE      NHMAGIV3,KEY20
            STRIP     KEY20 
            APPEND    SP1,PGNAME
            APPEND    KEY20,PGNAME
          ENDIF
          APPEND    SP70,PGNAME
          RESET     PGNAME
.
.         Load New given name fields
.
          PACK      PMPXFNAM,NHMAGIV1,SP70
          MOVE      NHMAGIV2,PMPXSNAM
          MATCH     SP20,NHMAGIV3
          IF        !@EQUAL
            STRIP     PMPXSNAM
            ENDSET    PMPXSNAM
            APPEND    SP1,PMPXSNAM
            APPEND    NHMAGIV3,PMPXSNAM
            RESET     PMPXSNAM
          ENDIF
          PACK      PMPXSNAM,PMPXSNAM,SP70
.
          RETURN
.-----------------------------------------------------------------
. Format Local Address from National Address
. Routine from IBANHI01
.-----------------------------------------------------------------
FORADD00  UNPACK    SP70,PADD1,PADD2
          UNPACK    SP70,PSUBRB,PADD4
.
          REP       UPPLOW,NHMAADD1
          REP       UPPLOW,NHMAADD2
          REP       UPPLOW,NHMAADD3
          REP       UPPLOW,NHMAADD4
          REP       UPPLOW,NHMAADD5
.
          PACK      PADD1,NHMAADD1,SP70
          PACK      PADD2,NHMAADD2,SP70
          PACK      PSUBRB,NHMAADD3,SP70
          PACK      PADD4,NHMAADD4,SP70
          MATCH     SP70,NHMAADD5
          IF        !@EQUAL
            MATCH     SP70,PADD4
            IF        @EQUAL
              PACK      PADD4,NHMAADD5,SP70
            ELSE
              STRIP     PADD4
              PACK      PADD4,PADD4,COMMA,SP1,NHMAADD5
            ENDIF
          ENDIF
.
FORADD99  RETURN
.------------------------------------------------------------
. Update Patient Masterfile
.----------------------------------------------------------------------
SETPMI00  CALL      FORGIV00        * Format Given Name
          CALL      FORADD00        * Format Address
          MOVE      NHMASURN,PSNAME
          PACK      PTMASNAM,NHMASURN,SP70
          UNPACK    NHMADOB,CCENT,CYEAR,CMON,CDAY
          PACK      PBDATE,CCENT,CYEAR,CMON,CDAY
.
          MATCH     SP20,NHMADDTH
          IF        !@EQUAL
            MOVE      ONE,PCEASE
            MOVE      NHMADDTH,PDECDTE
          ENDIF
          MOVE      NHMADOMC,PPOST
.
          RESET     ADMISSNO
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            CALL      VSXPST00     * update visit extension with postcode
          ENDIF
.
          MOVE      NHMASEX,PSEX
... commented out for 0891932
...       MATCH     ANSO,PSEX
...       IF        @EQUAL
...         MOVE      ANSU,PSEX
...       ENDIF
.
          MOVE      NHMAURNO,PURNO
          MATCH     PTMAS019,Z70
          IF        !@EQUAL
            MOVE      PTMAS019,PCONT
          ENDIF
          MATCH     PTMAS021,Z70
          IF        !@EQUAL
            MOVE      PTMAS021,PTYPE
          ENDIF
.
          RETURN
.-------------------------------------------------------------------------
. VSXPST00 - Update Visit extension file with postcode if it has changed
.-------------------------------------------------------------------------
VSXPST00  PACK      KEY8,ADMISSNO,SP70     * Read Visit Extension File?
          CALL      RDPMVX11
          BRANCH    OVRCD,VSXPST99
.
          MOVE      NHMADOMC,PMVXPOST
.
          CALL      IBACLOCK
          MOVE      WBSEUID,PMVXWEBU
          PACK      PMVXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMVXLUPD
          CLOCK     TIME,PMVXLUPT
.
          CALL      UPPMVX11
          GOTO      VSXPST99
.
VSXPST99  RETURN
.------------------------------------------------------------
.   Clear nhi details
.------------------------------------------------------------
CLRNZIB0  MOVE     SP70,NZIBSURN
          MOVE     SP70,NZIBGIV1
          MOVE     SP70,NZIBGIV2
          MOVE     SP70,NZIBGIV3
          MOVE     SP70,NZIBPRNM
          MOVE     SP70,NZIBADD1
          MOVE     SP70,NZIBADD2
          MOVE     SP70,NZIBSUBR
          MOVE     SP70,NZIBCITY
          MOVE     SP70,NZIBCTRY
          MOVE     SP70,NZIBDOB
          MOVE     SP70,NZIBDDTH
          MOVE     SP70,NZIBDOMC
          MOVE     SP70,NZIBRESI
          MOVE     SP70,NZIBETHN
          MOVE     SP70,NZIBETH2
          MOVE     SP70,NZIBETH3
          MOVE     SP70,NZIBSEX
.
.         Setting up default values
.
          MOVE      SRCHSNAM,NZIBSURN
          MOVE      SRCHGNAM,NZIBGIV1
          MOVE      SRCHPDOB,NZIBDOB
          MOVE      SRCHPSEX,NZIBSEX
          MATCH     "u",NZIBSEX
          IF        @EQUAL
            PACK     NZIBSEX,SP70
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Clear Local Donor Details
.------------------------------------------------------------
CLRDNR00  MOVE       SP70,NHDNNMPI
          MOVE       SP70,NHDNDONR
          MOVE       SP70,NHDNCNSU
          MOVE       SP70,NHDNCNG1
          MOVE       SP70,NHDNCNG2
          MOVE       SP70,NHDNCNG3
          MOVE       SP70,NHDNCNPI
          MOVE       SP70,NHDNCNA1
          MOVE       SP70,NHDNCNA2
          MOVE       SP70,NHDNCNA3
          MOVE       SP70,NHDNCNA4
          MOVE       SP70,NHDNCNA5
          MOVE       SP70,NHDNCREL
          MOVE       SP70,NHDNCWPH
          MOVE       SP70,NHDNCAPH
          MOVE       SP70,NHDNDAT
          MOVE       SP70,NHDNTIM
          MOVE       SP70,NHDNSPA
          RETURN
.------------------------------------------------------------
. Clear National Donor Details
.------------------------------------------------------------
CLRNDR00  MOVE       SP70,NZIBSTSU
          MOVE       SP70,NZIBPCSN
          MOVE       SP70,NZIBPCG1
          MOVE       SP70,NZIBPCG2
          MOVE       SP70,NZIBPCG3
          MOVE       SP70,CONTNAME
          MOVE       SP70,NZIBPRNM
          MOVE       SP70,NZIBPCA1
          MOVE       SP70,NZIBPCA2
          MOVE       SP70,NZIBPCSB
          MOVE       SP70,NZIBPCTW
          MOVE       SP70,NZIBPCCT
          MOVE       SP70,NZIBWKPH
          MOVE       SP70,NZIBAHPH
          MOVE       SP70,NZIBRELC
          MOVE       SP70,NZIBDTLU
          RETURN
.------------------------------------------------------------
. Clear Local NHI Details
.------------------------------------------------------------
CLNHIMAS  MOVE      SP70,NHMASURN
          MOVE      SP70,NHMAGIV1
          MOVE      SP70,NHMAGIV2
          MOVE      SP70,NHMAGIV3
          MOVE      SP70,NHMAPREI
          MOVE      SP70,NHMAADD1
          MOVE      SP70,NHMAADD2
          MOVE      SP70,NHMAADD3
          MOVE      SP70,NHMAADD4
          MOVE      SP70,NHMAADD5
          MOVE      SP70,NHMADOB
          MOVE      SP70,NHMADDTH
          MOVE      SP70,NHMADOMC
          MOVE      SP70,NHMARES
          MOVE      SP70,NHMAETH
          MOVE      SP70,NHMAETH2
          MOVE      SP70,NHMAETH3
          MOVE      SP70,NHMASEX
          PACK      NHMADAT,CCC,CYY,CMM,CDD
          CLOCK     TIME,NHMATIM
          MOVE      SP70,NHMASPA
.
          RETURN
.---------------------------------------------------------------------
. Move National Fields to Local Fields
.---------------------------------------------------------------------
NTOL0000  PACK      PURNO,SP1,NHIHCUID
          PACK      NHMASURN,NZIBSURN,SP70
          PACK      NHMAGIV1,NZIBGIV1,SP70
          PACK      NHMAGIV2,NZIBGIV2,SP70
          PACK      NHMAGIV3,NZIBGIV3,SP70
          PACK      NHMAPREI,NZIBPRNM,SP70
          PACK      NHMAADD1,NZIBADD1,SP70
          PACK      NHMAADD2,NZIBADD2,SP70
          PACK      NHMAADD3,NZIBSUBR,SP70
          PACK      NHMAADD4,NZIBCITY,SP70
          PACK      NHMAADD5,NZIBCTRY,SP70
          PACK      NHMADOB,NZIBDOB,SP70
          PACK      NHMADDTH,NZIBDDTH,SP70
          PACK      NHMADOMC,NZIBDOMC,SP70
          PACK      NHMARES,NZIBRESI,SP70
          PACK      NHMAETH,NZIBETHN,SP70
          PACK      NHMAETH2,NZIBETH2,SP70
          PACK      NHMAETH3,NZIBETH3,SP70
. if gender HDP not equal to NHI, use gender from the national
          PACK      KEY5,ANSG,SP1,NHMASEX,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     THCSCOD,NZIBSEX
            GOTO      NTOL1000 IF EQUAL
          ENDIF
.
          MATCH     ANSM,NZIBSEX
          GOTO      NTOL0900 IF EQUAL
.
          MATCH     ANSF,NZIBSEX
          GOTO      NTOL0900 IF EQUAL
.
          MATCH     ANSU,NZIBSEX
          GOTO      NTOL0900 IF EQUAL
.
          MATCH     ANSO,NZIBSEX
          GOTO      NTOL0900 IF EQUAL
.
          MOVE      SP70,NHMASEX
          MOVE      SP70,PSEX
          GOTO      NTOL1000
.
NTOL0900  PACK      NHMASEX,NZIBSEX,SP70   
.
NTOL1000  MOVE      SP70,NHMASPA
          MOVE      NZIBSEX,PSEX
.
          MOVE      NZIBSURN,PSNAME
          PACK      PTMASNAM,NHMASURN,SP70
          UNPACK    NZIBDOB,CCENT,CYEAR,CMON,CDAY
          PACK      PBDATE,CCENT,CYEAR,CMON,CDAY
.
          MATCH     SP20,NZIBDDTH
          IF        !@EQUAL
            MOVE      ONE,PCEASE
            MOVE      NZIBDDTH,PDECDTE
          ENDIF
          MOVE      NZIBDOMC,PPOST
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          RETURN
.------------------------------------------------------------
. UPERRM00 : Update Error Message
.------------------------------------------------------------
UPERRM00  CLEAR     UPERRMSG
          APPEND    NZIBERRN,UPERRMSG
          APPEND    "-",UPERRMSG
          REP       "#" ",NZIBERRD
          REP       "' ",NZIBERRD
          APPEND    NZIBERRD,UPERRMSG
          RESET     UPERRMSG
          MOVE      UPERRMSG,WEBTITLE
          CALL      DISALT00
          RETURN
.------------------------------------------------------------
. NHERR000 : Display error message
.------------------------------------------------------------
NHERR000  CLEAR     WEBTITLE
          APPEND    NZIBERRN,WEBTITLE
          APPEND    "-",WEBTITLE
          REP       "#" ",NZIBERRD
          REP       "' ",NZIBERRD
          APPEND    NZIBERRD,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
NHERR999  RETURN
.
.------------------------------------------------------------
. NHRER000 : Display error message and redirect
.------------------------------------------------------------
NHRER000  CLEAR     WEBTITLE
          APPEND    NZIBERRN,WEBTITLE
          APPEND    "-",WEBTITLE
          REP       "#" ",NZIBERRD
          REP       "' ",NZIBERRD
          APPEND    NZIBERRD,WEBTITLE
          RESET     WEBTITLE
.
          CALL      OPENHTML
          BRANCH    OVRCD,NHRER900
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CLOSE     HTMLFILE
          GOTO      NHRER900
.
NHRER900  DISPLAY   "*** Fifo Not Found ***"
.
NHRER999  RETURN
.
ERRM0000  BRANCH    FLDITMNO,ERRM0100,ERRM0200,ERRM0300,ERRM0400,ERRM0500
          GOTO      ERRM9999
.
ERRM0100  WRITE     HTMLFILE;SAVEERRN;
          GOTO      ERRM9999
.
ERRM0200  WRITE     HTMLFILE;SAVEERRD;
          GOTO      ERRM9999
.
ERRM0300  CALL      TABHED00                 * Display List of Matches
          GOTO      ERRM9999
.
ERRM0400  CALL      TABROW00                 * Display List of Matches
          GOTO      ERRM9999
.
ERRM0500  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      ZERO,FLDITMNO
          MOVE      KEY3,FLDITMNO
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Read logged in user id
          IF        OVRCD=1
            MOVE      SP70,WBSEHOSP
          ENDIF
.
          IF        IBCNMHOS=1
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1              * Read logged in hospital id
            IF        OVRCD=1
              CALL      CLPATHSP            * Clear hospital file vars
            ENDIF
          ELSE
            MOVE      SP70,WBSEHOSP         * Not multi hospital
            CALL      CLPATHSP              * Clear hospital file vars
          ENDIF
.
          CALL      HSPD0000                * Hospital file tags
          GOTO      ERRM9999
.
ERRM9999  RETURN
.------------------------------------------------------------
. Error Returned from NEWHCU
.------------------------------------------------------------
UPDERR00  MOVE      NZIBERRD,ERRTYPE
          MOVE      SP70,WARNMES
          MATCH     "MSM",ERRTYPE        * Name and Address Integrity
          IF        @EQUAL
            MOVE      ANSY,ADDRWARN
            MOVE      "Name and Address Warning",WARNMES
            GOTO      UPDERR80
          ENDIF
.
          MATCH     "ADC",ERRTYPE        * Automated Domicile Code Warning
          IF        @EQUAL
            MOVE      ANSY,ADDRWARN
            MOVE      "Domicile Code Warning",WARNMES
            GOTO      UPDERR80
          ENDIF
          MATCH     "DUP",ERRTYPE        * Duplicate Checking
          IF        @EQUAL
            MOVE      ANSY,DUPLWARN
            MOVE      "Duplicate Registration Warning",WARNMES
            GOTO      UPDERR90
          ENDIF
          MATCH     "UPD",ERRTYPE        * Update Key Fields Checking
          IF        @EQUAL
            MOVE      ANSY,UPDKWARN
            MOVE      "Update Key Fields Warning",WARNMES
            GOTO      UPDERR80
          ENDIF
.
          MATCH     "1002",NZIBERRN       * Message format invalid
          IF        @EQUAL
            MOVE      NZIBERRD,WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      UPDERR99
          ENDIF
.
          CALL      NHRER000
          GOTO      UPDERR99
.
UPDERR80  CALL      OPENHTML
          BRANCH    EXIT,UPDERR99
          REP       "#" ",NZIBERRD
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                   "  var undefined;":
                   "  if (confirm(#"",WARNMES,"\n",NZIBERRD:
                   "\nClick Ok if you want to":
                   " Override Warning.#")) {":
                   "    parent.NHIUpdate.override.value=#"",ERRTYPE,"#"; ":
                   "    parent.NHIUpdate.addrwarn.value=#"",ADDRWARN,"#"; ":
                   "    parent.NHIUpdate.duplwarn.value=#"",DUPLWARN,"#"; ":
                   "    parent.NHIUpdate.updkwarn.value=#"",UPDKWARN,"#"; ":
                   "    parent.NHIUpdate.target=#"PopUpFrame#"; ":
                   "    parent.NHIUpdate.submit(); }":
                   "  else {":
     " parent.document.getElementById('PopUpScreen').style.display='none';  }":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      UPDERR99
.
UPDERR90  CALL      OPENHTML
          BRANCH    EXIT,UPDERR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                   "src=#"../js/Standard.js#"></script>":
                   "<script type=#"text/javascript#" ":
                   "src=#"../js/Custom.js#"></script>":
                   "<script type=#"text/javascript#"> {":
                   "  var undefined;":
                   "  if (confirm(#"",WARNMES,"\nClick Ok if you want to":
                   " Override Warning, Cancel to view duplicates.#")) {":
                   "    parent.NHIUpdate.override.value=#"",ERRTYPE,"#"; ":
                   "    parent.NHIUpdate.addrwarn.value=#"",ADDRWARN,"#"; ":
                   "    parent.NHIUpdate.duplwarn.value=#"",DUPLWARN,"#"; ":
                   "    parent.NHIUpdate.updkwarn.value=#"",UPDKWARN,"#"; ":
                   " if (self.name.match(/PopUpFrame1/)) {":
.                   "      parent.NHIUpdate.target=#"PopUpFrame1#"; ":
                   "      parent.NHIUpdate.target=''; DFrameExit();":
                   "    } else {":
                   "      parent.NHIUpdate.target=#"PopUpFrame#"; ":
                   "    }":
                   "    parent.NHIUpdate.submit(); }":
                   "  else {":
                   " if (self.name.match(/PopUpFrame1/)) {":
.                   "    parent.NHIUpdate.target=#"PopUpFrame1#"; ":
                   "     parent.NHIUpdate.target='';":
                   "  } else {":
                   "     parent.NHIUpdate.target=#"PopUpFrame#"; ":
                   "  }":
                   "  parent.submitSearch(); }":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      UPDERR99
.
UPDERR99  RETURN
.------------------------------------------------------------
. Setup Search Criteria
.------------------------------------------------------------
SETSRH00  MOVE      "6",NZIBSTYP             * Search Type Range of Ages
          MOVE      NZIBDOB,SRCHDOB          * Calculate Age for Search
          UNPACK    SRCHDOB,CCENT,CYEAR,CMON,CDAY
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          MOVE      KEY4,FORM4AA
          PACK      KEY4,CCC,CYY
          REP       " 0",KEY4
          MOVE      KEY4,FORM4CUR
          ASSIGN    FORM4CUR-FORM4AA,JHOLD
          IF        CMM<IMON
            SUB       ONE,JHOLD
          ENDIF
          MOVE      JHOLD,SRCHAGE
          MOVE      SP30,NZIBMDOB            * Clear Date of Birth
          MOVE      SRCHAGE,NZIBMAGE         * Set up Age Field
          REP       " 0",NZIBMAGE
          MOVE      "05",NZIBMPAG            * Set Range to +/- 5 years
          REP       " 0",NZIBMPAG
.
          MOVE      PTCNMPTR,NZIBRLIM        * reply limit
          REP       " 0",NZIBRLIM
          MOVE      NZIBSEX,NZIBMGEN         * Gender
          MOVE      ANSM,NZIBNSTY            * Name Srch Typ Direct Match
          PACK      NZIBADD1,SP30,SP5        * Clear Fields Not in Search
          MOVE      SP30,NZIBADD2
          MOVE      SP30,NZIBSUBR
          MOVE      SP30,NZIBCITY
          MOVE      SP30,NZIBCTRY
          MOVE      SP1,NZIBASTY
          MOVE      "1",NZIBPRNM
          MOVE      SP30,NZIBGIV2
          MOVE      SP30,NZIBGIV3
          RETURN
.------------------------------------------------------------
. Set Override Flag
.------------------------------------------------------------
OVRRID00  MOVE      ONE,EXIT
.
          MOVE      ADDRWARN,NZIBSCRB
          MOVE      DUPLWARN,NZIBDUPL
          MOVE      UPDKWARN,NZIBUPDT
.
          MATCH     "MSM",OVERRIDE     * Name and Address Integrity
          IF        @EQUAL
            MOVE      "Y",NZIBSCRB
          ENDIF
          MATCH     "ADC",OVERRIDE     * Automated Domicile Code Warning
          IF        @EQUAL
            MATCH     SP70,NHMADOMC
            IF        @EQUAL
              BEEP
              MOVE      "Domicile Code must be entered for Override",WEBTITLE
              CALL      WEBERR00
              MOVE      ONE,EXIT       * Allow Mods to Fields
              GOTO      OVRRID99
            ENDIF
            MOVE      "Y",NZIBSCRB
          ENDIF
          MATCH     "DUP",OVERRIDE     * Duplicate Checking
          IF        @EQUAL
            MOVE      "Y",NZIBDUPL
          ENDIF
          MATCH     "UPD",OVERRIDE     * Update Key Fields Checking
          IF        @EQUAL
            MOVE      "Y",NZIBUPDT
          ENDIF
.
OVRRID99  RETURN
.------------------------------------------------------------
GETSVAR   RETURN
.------------------------------------------------------------
.  ACTMSAV: save master variables
.------------------------------------------------------------
ACTMSAV   MOVE      PMICRO,SPMICRO
          MOVE      PUSR1,SPUSR1
          MOVE      PUSR2,SPUSR2
          MOVE      PUSR3,SPUSR3
          MOVE      PUSR4,SPUSR4
          MOVE      PUSR5,SPUSR5
          MOVE      PUSR6,SPUSR6
          MOVE      PUYN1,SPUYN1
          MOVE      PUYN2,SPUYN2
          MOVE      PUYN3,SPUYN3
.
          MOVE      PURNO,SPURNO
          MOVE      PTITL,SPTITL
          MOVE      PSNAME,SPSNAME
          MOVE      PGNAME,SPGNAME
          MOVE      PPSNAME,SPPSNAME
          MOVE      PSMOK,SPSMOK
          MOVE      PSEX,SPSEX
          MOVE      PMSTAT,SPMSTAT
          MOVE      PBDATE,SPBDATE
          MOVE      PSAGE,SPSAGE
          MOVE      PCONT,SPCONT
          MOVE      PREG,SPREG
          MOVE      PTYPE,SPTYPE
          MOVE      POCCUP,SPOCCUP
          MOVE      PMEDI,SPMEDI
          MOVE      PPENNO,SPPENNO
          MOVE      PPNDTE,SPPNDTE
          MOVE      PREPAT,SPREPAT
          MOVE      PCHGDTE,SPCHGDTE
          MOVE      PLOCDOC,SPLOCDOC
          MOVE      PCEASE,SPCEASE
.
          MOVE      PNKNAME,SPNKNAME
          MOVE      PNKADD1,SPNKADD1
          MOVE      PNKADD2,SPNKADD2
          MOVE      PNKSUBR,SPNKSUBR
          MOVE      PNKADD4,SPNKADD4
          MOVE      PNKPOST,SPNKPOST
          MOVE      PNKTELP,SPNKTELP
          MOVE      PNKTELB,SPNKTELB
          MOVE      PNKRELP,SPNKRELP
.
          MOVE      PADD1,SPADD1
          MOVE      PADD2,SPADD2
          MOVE      PSUBRB,SPSUBRB
          MOVE      PADD4,SPADD4
          MOVE      PPOST,SPPOST
          MOVE      PTELEP,SPTELEP
          MOVE      PTELEB,SPTELEB
          MOVE      PTMXDOFR,SPDOR
          MOVE      PMPXRHC1,SPREGP
          MOVE      PMPXRH1G,SPGPPC
          MOVE      PMPXR1GC,SPGPPT
.
          MOVE      PHIGH1,SPHIGH1
          MOVE      PHIGH2,SPHIGH2
          MOVE      PHIGH3,SPHIGH3
          MOVE      PAUTOPY,SPAUTOPY
          MOVE      PDECDTE,SPDECDTE
          MOVE      PYRRES,SPYRRES
.
.-------- Save Community Card Details ---------------------------------
.
          MOVE      PTMXCARD,SPCARD
          MOVE      PTMXCEXP,SPCEXP
          MOVE      PTMXCXMP,SPCXMP
          MOVE      PTMXFMLY,SPFMLY
.
          RETURN
.------------------------------------------------------------
. Update NHI Basic Patient Details
.------------------------------------------------------------
UPDNHI00  MOVE      ZERO,LOCALFLG           * patient is on the local database
          MOVE      ZERO,LOCKCNT
.
          CALL      SAVPRV00
.
          CALL      CHRCHK00                * check for illegal characters
          BRANCH    EXIT,UPDNHI98
.
          MATCH     SP70,URNUMBER           * Registration Form if Blank
          GOTO      UPDNHI05 IF NOT EQUAL   * Process Form
          MATCH     SP70,NHIHCUID           * Registration Form if Blank
          GOTO      UPDNHI90 IF EQUAL       * Process Form
.
          MOVE      NHIHCUID,KEY7
          MOVE      NHIHCUID,NZIBNMPI
          CALL      CONNECT
          BRANCH    EXIT,UPDNHI99
          CALL      GETHCU                  * Read National Details
          IF        OVRCD<>1
            GOTO      UPDNHI10
          ENDIF
.
          MATCH     "2097",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      UPDNHI10
          ENDIF
          MATCH     "2033",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      UPDNHI10
          ENDIF
          MATCH     "2034",NZIBERRN
          IF        @EQUAL
            MOVE      NHIHCUID,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      UPDNHI10
          ENDIF
.
          GOTO      UPDNHI90
.
UPDNHI05  PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          IF        OVRCD=0
            MOVE      NHMANMPI,NZIBNMPI
          ELSE
            MOVE      URNUMBER,NZIBNMPI
            CALL      CLPATMAS
            CALL      CLPMSPX2                * clear mast ext2 details
          ENDIF
          CALL      CONNECT
          BRANCH    EXIT,UPDNHI99
          CALL      GETHCU
          IF        OVRCD<>1
            GOTO      UPDNHI10
          ENDIF
.
          MATCH     "2097",NZIBERRN
          IF        @EQUAL
            UNPACK    URNUMBER,KEY1,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      UPDNHI10
          ENDIF
.
          MATCH     "2033",NZIBERRN
          IF        @EQUAL
            UNPACK    URNUMBER,KEY1,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      UPDNHI10
          ENDIF
.
          MATCH     "2034",NZIBERRN
          IF        @EQUAL
            UNPACK    URNUMBER,KEY1,NZIBNMPI
            CALL      LOCNHI00
            CALL      CLRAST00
            GOTO      UPDNHI10
          ENDIF
.
          GOTO      UPDNHI90
.
UPDNHI10  MOVE      NZIBNMPI,KEY7
          CALL      RLNHMAS1
          BRANCH    OVRCD,UPDNHI30,UPDNHI40
.
          MOVE      TWO,AUDTTYPE           * Before Change Type
          CALL      WANHMA00               * Write Audit Record
.
          MATCH     NHMASLUP,SP70
          GOTO      UPDNHI91 IF EQUAL
          PACK      KEY16,NHMADAT,NHMATIM
          REP       " 0",KEY16
          MATCH     NHMASLUP,KEY16
          GOTO      UPDNHI92 IF NOT EQUAL
.
UPDNHI20  MOVE      NHMAURNO,KEY8
          CALL      RLPTMAS1                     * NHI Master Field Selected
          BRANCH    OVRCD,UPDNHI93,UPDNHI45
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     "1",NHMAPREI          * previous Pref Given Name selection
          IF        !@EQUAL
            MATCH     "1",NHMAS005
            IF        @EQUAL
              MOVE      SP70,PMPXPFGN
            ENDIF
          ENDIF
.
          MATCH     "Y",SAVELOCL           * Save to Local checkbox
          IF        @EQUAL
            MATCH     "2",NHMAS005
            IF        @EQUAL
              PACK      PMPXPFGN,NHMAS003,SP70
            ENDIF
            MATCH     "3",NHMAS005
            IF        @EQUAL
              PACK      PMPXPFGN,NHMAS004,SP70
            ENDIF
          ENDIF
.
          CALL      SVMAS000                      * Save Variables for UPDUR
          CALL      SURNAM00                      * Soundex & Surname files
.
          GOTO      UPDNHI50
.
UPDNHI30  CALL      CLNHIMAS               * clear local nhi variables
          CALL      CLPATMAS               * clear local nhi variables
          CALL      CLPMSPX2                * clear mast ext2 details
          MOVE      ONE,LOCALFLG           * Not on the local database
          PACK      URNUMBER,SP1,NHIHCUID  * Use the urnumber if no nhimas
          GOTO      UPDNHI50
.
UPDNHI40  
...DISPLAY   *W,"NHI Master Locked Waiting",LOCKCNT
...       ADD       ONE,LOCKCNT
...       IF        LOCKCNT<10
...         GOTO      UPDNHI10
...       ENDIF
          MOVE      "Can't Lock NHI Master Record. Update Failed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDNHI98
.
UPDNHI45  
...DISPLAY   *W,"Patient Master Locked Waiting",LOCKCNT
...       ADD       ONE,LOCKCNT
...       IF        LOCKCNT<10
...         GOTO      UPDNHI20
...       ENDIF
          MOVE      "Can't Lock Patient Master Record. Update Failed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDNHI98
.
UPDNHI50  CALL      MVNHI000                * Move nhi parameters to local vars
.
          CALL      UPDNAT00                * Update National System
          BRANCH    EXIT,UPDNHI98
.
          IF        LOCALFLG=0
            CALL      UPDLOC00              * Update the local and NHI
          ELSE
            CALL      ADDLOC00              * Update National Add to local 
            BRANCH    EXIT,UPDNHI98
          ENDIF
          MOVE      URNUMBER,KEY7
          CALL      UUNHMAS1
          MOVE      NHMAURNO,KEY8
          CALL      UUPTMAS1                     * NHI Master Field Selected
.
          CALL      DEATHA00
.
          MOVE      ZERO,EXIT
          GOTO      UPDNHI99

UPDNHI90  CALL      NHRER000
          MOVE      ONE,EXIT
          GOTO      UPDNHI98
.
UPDNHI91  MOVE      "Last Update Key Blank",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDNHI98
.
UPDNHI92  CLEAR     WEBTITLE
          APPEND    "Another Update has occured try again.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      UPDNHI98
.
UPDNHI93  CLEAR     WEBTITLE
          APPEND    "Invalid Patient Local U/R Number.(",WEBTITLE
          APPEND    KEY8,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      UPDNHI98
.
UPDNHI98  MATCH     "2097",NZIBERRN
          IF        @EQUAL
            UNPACK    URNUMBER,KEY1,KEY7
            CALL      RDNHMAS1
            BRANCH    OVRCD,UPDNHI99
            UNPACK    URNUMBER,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,UPDNHI99
            CALL      RDPMPX21
            CALL      MVNHI000
            CALL      UPDLOC00
          ENDIF
          MATCH     "2033",NZIBERRN
          IF        @EQUAL
            UNPACK    URNUMBER,KEY1,KEY7
            CALL      RDNHMAS1
            BRANCH    OVRCD,UPDNHI99
            UNPACK    URNUMBER,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,UPDNHI99
            CALL      RDPMPX21
            CALL      MVNHI000
            CALL      UPDLOC00
          ENDIF
          MATCH     "2034",NZIBERRN
          IF        @EQUAL
            UNPACK    URNUMBER,KEY1,KEY7
            CALL      RDNHMAS1
            BRANCH    OVRCD,UPDNHI99
            UNPACK    URNUMBER,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,UPDNHI99
            CALL      RDPMPX21
            CALL      MVNHI000
            CALL      UPDLOC00
          ENDIF
          MOVE      URNUMBER,KEY7
          CALL      UUNHMAS1
          MOVE      NHMAURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
.
UPDNHI99  RETURN
.
.------------------------------------------------------------
. New Local Patient Registration & Update National If Required
.------------------------------------------------------------
ADDLOC00  MOVE      NZIBNMPI,KEY7
          MOVE      NZIBNMPI,NHMANMPI
          REP       UPPLOW,NHMASURN
          REP       UPPLOW,NHMAGIV1
          REP       UPPLOW,NHMAGIV2
          REP       UPPLOW,NHMAGIV3
.
          REP       UPPLOW,NHMAADD1
          REP       UPPLOW,NHMAADD2
          REP       UPPLOW,NHMAADD3
          REP       UPPLOW,NHMAADD4
          REP       UPPLOW,NHMAADD5
.
          IF        PTCNNZUR=1
            PACK      NHMAURNO,SP1,NZIBNMPI
          ELSE
            CALL      LOCUR000
            MOVE      PURNO,NHMAURNO
          ENDIF
.
          PACK      KEY8,NHMAURNO,SP70
          CALL      RANHMAS2
          IF        OVRCD=0
            CLEAR     WEBTITLE
            APPEND    "ERROR: Local UR ",WEBTITLE
            APPEND    KEY8,WEBTITLE
            APPEND    " Already Exists.",WEBTITLE
            RESET     WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      ADDLOC99
          ENDIF
.
          MOVE      NZIBNMPI,KEY7
          CALL      RANHMAS1
          IF        OVRCD=1
            CALL      IBACLOCK
            CLOCK     TIME,NHMATIM
            PACK      NHMADAT,CCC,CYY,CMM,CDD
            REP       " 0",NHMADAT
            CALL      WRNHMAS1      * Got there now write the record.
            MOVE      ONE,AUDTTYPE
            CALL      WANHMA00
          ELSE
            CLEAR     WEBTITLE
            APPEND    "ERROR: NHI HCU ID ",WEBTITLE
            APPEND    KEY7,WEBTITLE
            APPEND    " Already Exists.",WEBTITLE
            RESET     WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      ADDLOC99
          ENDIF
.
          CALL      SETPMI00              * Setup PMI Variables
          CALL      UPVPMI00                * Move mast ext2 parm into file vars
          MOVE      WBSEHOSP,PMPXIHOS
          MOVE      WBSEUID,PMPXWBID
          CALL      WRTUR                 * Write PMI Details
          MOVE      PURNO,URNUMBER
          CALL      UPRES000
          CALL      WEXP0000              * Write expected payor details
          MOVE      ZERO,EXIT
.
ADDLOC99  RETURN
.------------------------------------------------------------
.  Update the local and NHI
.------------------------------------------------------------
UPDLOC00  CALL      IBACLOCK
          REP       UPPLOW,NHMASURN
          REP       UPPLOW,NHMAGIV1
          REP       UPPLOW,NHMAGIV2
          REP       UPPLOW,NHMAGIV3
.
          REP       UPPLOW,NHMAADD1
          REP       UPPLOW,NHMAADD2
          REP       UPPLOW,NHMAADD3
          REP       UPPLOW,NHMAADD4
          REP       UPPLOW,NHMAADD5
.
          CLOCK     TIME,NHMATIM
          PACK      NHMADAT,CCC,CYY,CMM,CDD
          REP       " 0",NHMADAT
          CALL      UPNHMAS1            * Update Changes
          MOVE      THREE,AUDTTYPE      * After Change Type
          CALL      WANHMA00            * Write Audit Record
.
          CALL      SETPMI00            * Setup PMI Variables
          CALL      UPDUR               * Update PMI Details
          CALL      UPRES000
.
UPDLOC99  RETURN
.------------------------------------------------------------
. Check And Update National System if Changed
.----------------------------------------------------------------------
UPDNAT00  MOVE     ZERO,EXIT
          MATCH    "$",NHMANMPI           * No Update for Temporary Numbers
          GOTO     UPDNAT99 IF EQUAL      * Old Temporary Numbers
          MATCH    "T-",NHMANMPI          * No Update for Temporary Numbers
          GOTO     UPDNAT99 IF EQUAL      * New Temporary Numbers
          MOVE      "2",NZIBNMCF
          MOVE     ANSY,ANS               * If Surname or 1st Given Change
          MATCH    NHMASURN,NZIBSURN      * Then default Save Alias as Yes
          GOTO     UPDNAT40 IF NOT EQUAL
          MATCH    NHMAGIV1,NZIBGIV1
          GOTO     UPDNAT40 IF NOT EQUAL
          MOVE     ANSN,ANS
          MATCH    NHMAGIV2,NZIBGIV2      * If other names or pref. indicator
          GOTO     UPDNAT40 IF NOT EQUAL  * Then Default as NO
          MATCH    NHMAGIV3,NZIBGIV3
          GOTO     UPDNAT40 IF NOT EQUAL
          MATCH    NHMAPREI,NZIBPRNM
          GOTO     UPDNAT40 IF NOT EQUAL
          MATCH    NHMAADD1,NZIBADD1
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMAADD2,NZIBADD2
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMAADD3,NZIBSUBR
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMAADD4,NZIBCITY
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMAADD5,NZIBCTRY
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMADOB,NZIBDOB
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMADOMC,NZIBDOMC
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMARES,NZIBRESI
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMAETH,NZIBETHN
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMAETH2,NZIBETH2
          GOTO     UPDNAT50 IF NOT EQUAL
          MATCH    NHMAETH3,NZIBETH3
          GOTO     UPDNAT50 IF NOT EQUAL
.
          PACK     ACODE,NHMASEX
          CALL     GGHDP000
          MATCH    THCSCOD,NZIBSEX
          GOTO     UPDNAT50 IF NOT EQUAL
.
          GOTO     UPDNAT99        * Nothing Changed
.
UPDNAT40  MOVE      "2",NZIBNMCF          * DONT save old name as alias
          COMPARE  ZERO,NHMAS019
          GOTO     UPDNAT50 IF EQUAL
          MOVE      "1",NZIBNMCF          * Save old name as alias
.
UPDNAT50  CALL     CHKADD00
          CALL     LOCNHI00         * Move Variables
          IF       CLRDOMCF=1
            MOVE     SP70,NZIBDOMC
            MOVE     SP70,NHMADOMC
          ENDIF
.
          MOVE     " ",NZIBSCRB     * Clear Overide Flags
          MOVE     " ",NZIBDUPL
          MOVE     " ",NZIBUPDT
.
UPDNAT60  MOVE     "Y",NZIBDUPL
          MATCH    SP70,OVERRIDE
          IF       @EQUAL
            MATCH    "1",PTCNDHCU           * Check show dupl warning flag
            IF       @EQUAL
              MOVE     " ",NZIBDUPL         * show duplicate warning
            ELSE
              MOVE     ANSY,NZIBDUPL        * do not show duplicate warning
            ENDIF
          ELSE
            CALL     OVRRID00 IF NOT EQUAL
          ENDIF
.
          CALL     UPDHCU
          BRANCH   OVRCD,UPDNAT90
.
          CALL     RETUP000        * Return Scrubbed Fields to NHI Fields
.
          REP       "* ",NZIBGIV1
          REP       "* ",NZIBGIV2
          REP       "* ",NZIBGIV3
          REP       "* ",NZIBSURN
          CALL     FORNAM00         * Format New Names
.
          MATCH    "1",NZIBNMCF
          IF       @EQUAL
            CALL     SURNAM00       * Post Alias
          ENDIF
          MOVE     ZERO,EXIT
          GOTO     UPDNAT99
.
UPDNAT90  
...CALL     UPERRM00         * Set up Update Error
          CALL     UPDERR00
          MOVE     ONE,EXIT
.
UPDNAT99  RETURN
.
CHKADD00  MOVE     ONE,CLRDOMCF
          MATCH    NHMAADD1,NZIBADD1
          GOTO     CHKADD99 IF NOT EQUAL
          MATCH    NHMAADD2,NZIBADD2
          GOTO     CHKADD99 IF NOT EQUAL
          MATCH    NHMAADD3,NZIBSUBR
          GOTO     CHKADD99 IF NOT EQUAL
          MATCH    NHMAADD4,NZIBCITY
          GOTO     CHKADD99 IF NOT EQUAL
          MATCH    NHMAADD5,NZIBCTRY
          GOTO     CHKADD99 IF NOT EQUAL
          MOVE     ZERO,CLRDOMCF
CHKADD99  RETURN
.------------------------------------------------------------
. Save Soundex Alias Details
. Routine from IBANHI01
.----------------------------------------------------------------------
SURNAM00  MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
          MOVE      ZERO,GSRSYS
          CALL      SOUNDEX                  * get soundex key for surname
          CALL      SOUNDX2                  * get soundex key for given names
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1                 * check if its already there
          IF        OVRCD=1
            CALL      WRPTGSR1
          ENDIF
          GOTO      SURNAM99
.
SURNAM99  RETURN
.------------------------------------------------------------
. Format Old Name for Alias Save
. Routine from IBANHI01
.------------------------------------------------------------
FORNAM00  REP       UPPLOW,NZIBSURN
          REP       UPPLOW,NZIBGIV1
          REP       UPPLOW,NZIBGIV2
          REP       UPPLOW,NZIBGIV3
.
          REP       UPPLOW,NHMASURN
          REP       UPPLOW,NHMAGIV1
          REP       UPPLOW,NHMAGIV2
          REP       UPPLOW,NHMAGIV3
.
          PACK      PSNAME,NZIBSURN
          PACK      PTMASNAM,NHMASURN,SP70
.
          CLEAR     PGNAME
          MOVE      NZIBGIV1,KEY20
          STRIP     KEY20
          APPEND    KEY20,PGNAME
          MATCH     SP20,NZIBGIV2
          IF        !@EQUAL
            MOVE      NZIBGIV2,KEY20
            STRIP     KEY20
            APPEND    SP1,PGNAME
            APPEND    KEY20,PGNAME
          ENDIF
          MATCH     SP20,NZIBGIV3
          IF        !@EQUAL
            MOVE      NZIBGIV3,KEY20
            STRIP     KEY20
            APPEND    SP1,PGNAME
            APPEND    KEY20,PGNAME
          ENDIF
          APPEND    SP70,PGNAME
          RESET     PGNAME
.
.         Load New given name fields
.
          PACK      PMPXFNAM,NHMAGIV1,SP70
          MOVE      NHMAGIV2,PMPXSNAM
          MATCH     SP20,NHMAGIV3
          IF        !@EQUAL
            STRIP     PMPXSNAM
            ENDSET    PMPXSNAM
            APPEND    SP1,PMPXSNAM
            APPEND    NHMAGIV3,PMPXSNAM
            RESET     PMPXSNAM
          ENDIF
          PACK      PMPXSNAM,PMPXSNAM,SP70
.
FORNAM99  RETURN
.------------------------------------------------------------
.  Donor & Contact Patient Details 
.------------------------------------------------------------
DCDET000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      DCDET500 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      DCDET100 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      DCDET200 IF EQUAL
.
          GOTO      DCDET910               
.
DCDET100  PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          BRANCH    OVRCD,DCDET920
          MOVE      NHMANMPI,NZIBNMPI
          CALL      CONNECT
          BRANCH    EXIT,DCDET999
          CALL      GETHCU                  * Read National Details
          BRANCH    OVRCD,DCDET900
          CALL      PCON0000                * Update Contact/Donor Details
          BRANCH    EXIT,DCDET999
          GOTO      DCDET400
.
DCDET200  PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          BRANCH    OVRCD,DCDET920
          MOVE      NHMANMPI,NZIBNMPI
          CALL      CONNECT
          BRANCH    EXIT,DCDET999
          CALL      GETHCU                  * Read National Details
          BRANCH    OVRCD,DCDET900
          CALL      DCON0000                * Update Contact/Donor Details
          BRANCH    EXIT,DCDET999
          GOTO      DCDET400
.
DCDET400  CALL      NXTPAG00
          BRANCH    EXIT,DCDET999
.
DCDET500  MOVE      ZERO,LOCALFLG           * Flag Local Record
          CALL      CLRNZIB0                * Clear National details
          CALL      CLRDNR00                * Clear Donor details
          CALL      CLRNDR00                * Clear National donor details
          CALL      CLNHIMAS                * Clear Local details
.
          MATCH     SP70,URNUMBER           * Must have a UR Number
          GOTO      DCDET920 IF EQUAL       * Error
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          BRANCH    OVRCD,DCDET920
          MOVE      NHMANMPI,NZIBNMPI
.
          CALL      CONNECT
          BRANCH    EXIT,DCDET999
          CALL      GETHCU                  * Read National Details
          BRANCH    OVRCD,DCDET900
.
          CALL      SETCON00                * Read National Donor Details
          BRANCH    EXIT,DCDET900
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,DCDET920
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          PACK      KEY8,PURNO,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          CALL      FORGIV00        * Format Given Name
          CALL      FORADD00        * Format Address
.
          MOVE      "NHI/MWS Contact/Donor Details",WEBTITLE
          CALL      WEBHED00    * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DCDET999
          CALL      WEBBOD00    * Process Web Body
          CALL      WEBEND00    * Process End of HTML File 
          MOVE      ZERO,EXIT
          GOTO      DCDET999
.
DCDET900  CALL      NHERR000                * display error message
          MOVE      ONE,EXIT
          GOTO      DCDET999
.
DCDET910  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCDET999
.
DCDET920  MOVE      "Invalid Patient Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DCDET999
.
DCDET999  RETURN
.------------------------------------------------------------
. Set up Donor Details for Display
.------------------------------------------------------------
SETCON00  CALL     CLRDNR00
          CALL     CLRNDR00                * Clear National donor details
.
          MATCH    ANSY,NZIBMWDN
          GOTO     SETCON50 IF NOT EQUAL
.
          MOVE     NHMANMPI,NZIBNMPI
          CALL     GETDNR                   * Read National Database
          BRANCH   OVRCD,SETCON90
.
          MOVE     NZIBSTSU,NHDNDONR
          MOVE     NZIBSTSU,NHDNDONR
          UNPACK   NZIBSTSU,DNRCOD01,DNRCOD02,DNRCOD03,DNRCOD04,DNRCOD05:
                            DNRCOD06,DNRCOD07,DNRCOD08,DNRCOD09,DNRCOD10
.
          MOVE     ZERO,F2
SETCON15  ADD      ONE,F2
          LOAD     KEY1,F2,DNRCOD01,DNRCOD02,DNRCOD03,DNRCOD04,DNRCOD05:
                           DNRCOD06,DNRCOD07,DNRCOD08,DNRCOD09,DNRCOD10
          MATCH    SP1,KEY1
          IF       !@EQUAL
            CALL     RDNHDCD1
            IF       OVRCD=0
              STORE    NHDCDES,F2,DNRDES01,DNRDES02,DNRDES03,DNRDES04,DNRDES05:
                                  DNRDES06,DNRDES07,DNRDES08,DNRDES09,DNRDES10
            ENDIF
          ENDIF
          COMPARE  "10",F2
          GOTO     SETCON15 IF NOT EQUAL
.
          MOVE     NHMANMPI,NHDNNMPI
          MOVE     NZIBPCSN,NHDNCNSU
          MOVE     NZIBPCG1,NHDNCNG1
          MOVE     NZIBPCG2,NHDNCNG2
          MOVE     NZIBPCG3,NHDNCNG3
          MOVE     NZIBPRNM,NHDNCNPI
          MOVE     NZIBPCA1,NHDNCNA1
          MOVE     NZIBPCA2,NHDNCNA2
          MOVE     NZIBPCSB,NHDNCNA3
          MOVE     NZIBPCTW,NHDNCNA4
          MOVE     NZIBPCCT,NHDNCNA5
          MOVE     NZIBWKPH,NHDNCWPH
          MOVE     NZIBAHPH,NHDNCAPH
          MOVE     NZIBRELC,NHDNCREL
          MOVE     NHDNCREL,KEY2
          CALL     RDNHREL1
          IF       OVRCD=1
            MOVE     SP70,NHREDES
          ENDIF
          PACK     KEY7,NHDNNMPI
          CALL     RANHDNR1
          IF       OVRCD=0
            CALL     UPNHDNR1
          ELSE
            CALL     WRNHDNR1
          ENDIF
          MOVE     ZERO,EXIT
          GOTO     SETCON99
.
SETCON50  MOVE     ZERO,EXIT
          GOTO     SETCON99
.
SETCON90  MOVE     ONE,EXIT
          GOTO     SETCON99
SETCON99  RETURN
.
.------------------------------------------------------------
. Post Contact Information
.------------------------------------------------------------
PCON0000  CALL      MVDNR000
          MATCH     SP70,NHDNCNSU
          GOTO      PCON0100 IF NOT EQUAL
          MATCH     SP70,NHDNCNG1
          IF        !@EQUAL
            MOVE      "Surname Name Must Be Entered - ",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      PCON9999
          ENDIF
.
          MOVE      SP70,NHDNCNPI     * Surname & Given Name Blank so
          MOVE      SP70,NHDNCNG2     * Clear Remaining Name Fields
          MOVE      SP70,NHDNCNG3
          GOTO      PCON0500
.
. Surname Specified So Given Name Mandatory
.
PCON0100  MATCH     SP70,NHDNCNG1
          GOTO      PCON0200 IF NOT EQUAL
          MOVE      "Given Name Must Be Entered - ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PCON9999
PCON0200  MATCH     SP70,NHDNCREL
          GOTO      PCON0500 IF NOT EQUAL
          MOVE      "Relationship Code Must Be Entered - ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PCON9999
.
. Name OK So COntinue
.
PCON0500  CLOCK     TIME,NHDNTIM
          CALL      IBACLOCK
          PACK      NHDNDAT,CCC,CYY,CMM,CDD
          REP       " 0",NHDNDAT
.
          MOVE      NHMANMPI,NHDNNMPI
          MOVE      NHDNNMPI,KEY7
          CALL      RANHDNR1
          IF        OVRCD=0
            CALL      UPNHDNR1
          ELSE
            CALL      WRNHDNR1
          ENDIF
.
          MATCH    ANSY,NZIBMWDN
          IF       @EQUAL
            MOVE      "M",NZIBUACT
          ELSE
            MOVE      "C",NZIBUACT
          ENDIF
.
          MATCH     NHDNDONR,NZIBSTSU
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNSU,NZIBPCSN
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNG1,NZIBPCG1
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNG2,NZIBPCG2
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNG3,NZIBPCG3
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNPI,NZIBPRNM
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNA1,NZIBPCA1
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNA2,NZIBPCA2
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNA3,NZIBPCSB
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNA4,NZIBPCTW
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCNA5,NZIBPCCT
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCREL,NZIBRELC
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCWPH,NZIBWKPH
          GOTO      PCON1000 IF NOT EQUAL
          MATCH     NHDNCAPH,NZIBAHPH
          GOTO      PCON1000 IF NOT EQUAL
          GOTO      PCON9000   * Nothing Changed
.
PCON1000  CALL      CONCLR00
          MOVE      NHDNDONR,NZIBSTSU
          MOVE      NHDNCNSU,NZIBPCSN
          MOVE      NHDNCNG1,NZIBPCG1
          MOVE      NHDNCNG2,NZIBPCG2
          MOVE      NHDNCNG3,NZIBPCG3
          MOVE      NHDNCNPI,NZIBPRNM
          MOVE      NHDNCNA1,NZIBPCA1
          MOVE      NHDNCNA2,NZIBPCA2
          MOVE      NHDNCNA3,NZIBPCSB
          MOVE      NHDNCNA4,NZIBPCTW
          MOVE      NHDNCNA5,NZIBPCCT
          MOVE      NHDNCREL,NZIBRELC
          MOVE      NHDNCWPH,NZIBWKPH
          MOVE      NHDNCAPH,NZIBAHPH
.
          CALL      UPDDNR
          COMPARE   ZERO,OVRCD
          GOTO      PCON9000 IF EQUAL
          CALL      NZHISERR
          MOVE      ONE,EXIT
          GOTO      PCON9999
.
PCON9000  MOVE      ZERO,EXIT
.
PCON9999  RETURN
.
CONCLR00  MATCH     "C",NZIBUACT
          GOTO      CONCLR99 IF EQUAL
.
          MATCH     SP70,NHDNCNSU
          GOTO      CONCLR05 IF NOT EQUAL
          MOVE      "*",NHDNCNSU
.
CONCLR05  MATCH     SP70,NHDNCNG1
          GOTO      CONCLR10 IF NOT EQUAL
          MOVE      "*",NHDNCNG1
.
CONCLR10  MATCH     SP70,NHDNCNG2
          GOTO      CONCLR15 IF NOT EQUAL
          MOVE      "*",NHDNCNG2
.
CONCLR15  MATCH     SP70,NHDNCNG3
          GOTO      CONCLR20 IF NOT EQUAL
          MOVE      "*",NHDNCNG3
.
CONCLR20  MATCH     SP70,NHDNCNA1
          GOTO      CONCLR25 IF NOT EQUAL
          MOVE      "*",NHDNCNA1
.
CONCLR25  MATCH     SP70,NHDNCNA2
          GOTO      CONCLR30 IF NOT EQUAL
          MOVE      "*",NHDNCNA2
.
CONCLR30  MATCH     SP70,NHDNCNA3
          GOTO      CONCLR35 IF NOT EQUAL
          MOVE      "*",NHDNCNA3
.
CONCLR35  MATCH     SP70,NHDNCNA4
          GOTO      CONCLR40 IF NOT EQUAL
          MOVE      "*",NHDNCNA4
.
CONCLR40  MATCH     SP70,NHDNCNA5
          GOTO      CONCLR45 IF NOT EQUAL
          MOVE      "*",NHDNCNA5
.
CONCLR45  MATCH     SP70,NHDNCREL
          GOTO      CONCLR50 IF NOT EQUAL
          MOVE      "*",NHDNCREL
.
CONCLR50  MATCH     SP70,NHDNCWPH
          GOTO      CONCLR55 IF NOT EQUAL
          MOVE      "*",NHDNCWPH
.
CONCLR55  MATCH     SP70,NHDNCAPH
          GOTO      CONCLR60 IF NOT EQUAL
          MOVE      "*",NHDNCAPH
CONCLR60
CONCLR99  RETURN
.------------------------------------------------------------
. Delete Contact Information
.------------------------------------------------------------
DCON0000  PACK      KEY7,NHDNNMPI,SP70
          CALL      RANHDNR1
          IF        OVRCD=0
            CALL      DENHDNR1         * Delete from Temp File
            MOVE      "D",NZIBUACT
            CALL      UPDDNR
            COMPARE   ZERO,OVRCD
            CALL      NZHISERR IF NOT EQUAL
          ENDIF
.
DCON9999  RETURN
.------------------------------------------------------------
.  NHI Basic Patient Details
.------------------------------------------------------------
NDNR0000  BRANCH    FLDITMNO,NDNR0010,NDNR0020,NDNR0030,NDNR0040,NDNR0050:
                             NDNR0060,NDNR0070,NDNR0080,NDNR0090,NDNR0100:
                             NDNR0110,NDNR0120,NDNR0130,NDNR0140,NDNR0150:
                             NDNR0160,NDNR0170,NDNR0180,NDNR0190,NDNR0200:
                             NDNR0210,NDNR0220,NDNR0230,NDNR0240,NDNR0250:
                             NDNR0260
          GOTO      NDNR9999
.
NDNR0010  MATCH     SP70,NZIBPCSN
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCSN;
          GOTO      NDNR9999
.
NDNR0020  MATCH     SP70,NZIBPCG1
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCG1;
          GOTO      NDNR9999
.
NDNR0030  MATCH     SP70,NZIBPCG2
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCG2;
          GOTO      NDNR9999
.
NDNR0040  MATCH     SP70,NZIBPCG3
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCG3;
          GOTO      NDNR9999
.
NDNR0050  MATCH     SP70,NZIBPRNM
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPRNM;
          GOTO      NDNR9999
.
NDNR0060  MATCH     SP70,NZIBPCA1
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCA1;
          GOTO      NDNR9999
.
NDNR0070  MATCH     SP70,NZIBPCA2
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCA2;
          GOTO      NDNR9999
.
NDNR0080  MATCH     SP70,NZIBPCSB
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCSB;
          GOTO      NDNR9999
.
NDNR0090  MATCH     SP70,NZIBPCTW
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCTW;
          GOTO      NDNR9999
.
NDNR0100  MATCH     SP70,NZIBPCCT
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBPCCT;
          GOTO      NDNR9999
.
NDNR0110  CALL      RELITM00
          GOTO      NDNR9999
.
NDNR0120  MATCH     SP70,NZIBWKPH
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBWKPH;
          GOTO      NDNR9999
.
NDNR0130  MATCH     SP70,NZIBAHPH
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBAHPH;
          GOTO      NDNR9999
.
NDNR0140  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD01
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES01;
          ELSE
            WRITE     HTMLFILE;DNRCOD01;
          ENDIF
          GOTO      NDNR9999
.
NDNR0150  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD02
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES02;
          ELSE
            WRITE     HTMLFILE;DNRCOD02;
          ENDIF
          GOTO      NDNR9999
.
NDNR0160  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD03
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES03;
          ELSE
            WRITE     HTMLFILE;DNRCOD03;
          ENDIF
          GOTO      NDNR9999
.
NDNR0170  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD04
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES04;
          ELSE
            WRITE     HTMLFILE;DNRCOD04;
          ENDIF
          GOTO      NDNR9999
.
NDNR0180  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD05
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES05;
          ELSE
            WRITE     HTMLFILE;DNRCOD05;
          ENDIF
          GOTO      NDNR9999
.
NDNR0190  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD06
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES06;
          ELSE
            WRITE     HTMLFILE;DNRCOD06;
          ENDIF
          GOTO      NDNR9999
.
NDNR0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD07
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES07;
          ELSE
            WRITE     HTMLFILE;DNRCOD07;
          ENDIF
          GOTO      NDNR9999
.
NDNR0210  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD08
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES08;
          ELSE
            WRITE     HTMLFILE;DNRCOD08;
          ENDIF
          GOTO      NDNR9999
.
NDNR0220  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD09
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES09;
          ELSE
            WRITE     HTMLFILE;DNRCOD09;
          ENDIF
          GOTO      NDNR9999
.
NDNR0230  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,DNRCOD10
          GOTO      NDNR9999 IF EQUAL
          IF        F1=0
            WRITE     HTMLFILE;DNRDES10;
          ELSE
            WRITE     HTMLFILE;DNRCOD10;
          ENDIF
          GOTO      NDNR9999
.
NDNR0240  MATCH     SP70,NZIBSTSU
          GOTO      NDNR9999 IF EQUAL
          WRITE     HTMLFILE;NZIBSTSU;
          GOTO      NDNR9999
.
NDNR0250  PACK      KEY16,NHMADAT,NHMATIM 
          REP       " 0",KEY16
          WRITE     HTMLFILE;KEY16;
          GOTO      NDNR9999
.
NDNR0260  MATCH     SP70,NZIBDTLU
          GOTO      NDNR9999 IF EQUAL
          UNPACK    NZIBDTLU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NDNR9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NDNR9999
.
NDNR9999  RETURN
.------------------------------------------------------------
.  Move NHI parameters to local variables
.------------------------------------------------------------
MVDNR000 PACK      NHDNDONR,NHDNR001,SP70  * Donor Details Summary String
         PACK      NHDNCNSU,NHDNR002,SP70  * Contact - Surname
         PACK      NHDNCNG1,NHDNR003,SP70  * Contact - Given Name 1
         PACK      NHDNCNG2,NHDNR004,SP70  * Contact - Given Name 2
         PACK      NHDNCNG3,NHDNR005,SP70  * Contact - Given Name 3
         PACK      NHDNCNPI,NHDNR006,SP70  * Contact - Preferred Given Name
         PACK      NHDNCNA1,NHDNR007,SP70  * Contact - Address Line 1
         PACK      NHDNCNA2,NHDNR008,SP70  * Contact - Address Line 2
         PACK      NHDNCNA3,NHDNR009,SP70  * Contact - Suburb
         PACK      NHDNCNA4,NHDNR010,SP70  * Contact - City/Town
         PACK      NHDNCNA5,NHDNR011,SP70  * Contact - Country
         PACK      NHDNCREL,NHDNR012,SP70  * Contact - Relationship
         PACK      NHDNCWPH,NHDNR013,SP70  * Contact - Work Phone
         PACK      NHDNCAPH,NHDNR014,SP70  * Contact - After Hours Phone
         PACK      NHDNDAT,CCC,CYY,CMM,CDD
         CLOCK     TIME,NHDNTIM
         MOVE      SP70,NHDNSPA
         RETURN
.------------------------------------------------------------
.  Alaises
.------------------------------------------------------------
ALDET000  RESET     UPDTTYPE
          CALL      CLRNZIB0                * Clear National details
          CALL      CLRDNR00                * Clear donor details
          CALL      CLRNDR00                * Clear National donor details
          CALL      CLNHIMAS                * Clear Local details
.
          MATCH     SP70,URNUMBER           * Must have a UR Number
          GOTO      ALDET920 IF EQUAL       * Error
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ALDET920
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          PACK      KEY8,PURNO,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          BRANCH    OVRCD,ALDET920
          MOVE      NHMANMPI,NZIBNMPI
          CALL      CONNECT
          BRANCH    EXIT,ALDET999
          CALL      GETHCU                  * Read National Details
          BRANCH    OVRCD,ALDET900
.
          MATCH     "$",NHMANMPI      * Old Temp Number Prefix
          GOTO      ALDET930 IF EQUAL
          MATCH     "T-",NHMANMPI     * New Temp Number Prefix
          GOTO      ALDET930 IF EQUAL
.
          MATCH     SP1,UPDTTYPE
          GOTO      ALDET500 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      ALDET100 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      ALDET200 IF EQUAL
.
          GOTO      ALDET910               
. Add
ALDET100  MATCH     SP70,NHALI001
          GOTO      ALDET950 IF EQUAL
          MATCH     SP70,NHALI002
          GOTO      ALDET950 IF EQUAL
          MOVE      ONE,F3
          MOVE      F3,TMALLIN
          PACK      KEY11,NHMAURNO,Z70
          CALL      RSTMAL1
          CALL      RPTMAL1
          BRANCH    OVRCD,ALDET110
          MATCH     TMALURNO,NHMAURNO
          GOTO      ALDET110 IF NOT EQUAL
          MOVE      TMALLIN,F3
          ADD       ONE,F3
ALDET110  MOVE      F3,TMALLIN
          MOVE      NHMAURNO,TMALURNO
          PACK      KEY11,TMALURNO,TMALLIN
          CALL      RATMAL1
          COMPARE   ZERO,OVRCD
          GOTO      ALDET100 IF EQUAL
          MOVE      NHALI001,TMALSUR
          MOVE      NHALI002,TMALGV1
          MOVE      NHALI003,TMALGV2
          MOVE      NHALI004,TMALGV3
          MOVE      NHALI005,TMALPRE
          CALL      WRTMAL1
.
          CALL      MAKALI00                  * Add New Alias National
          CALL      MAKLAL00                  * Local
.
          GOTO      ALDET400
. Delete
ALDET200  PACK      KEY11,NHALIKEY,SP70
          CALL      RDTMAL1
          BRANCH    OVRCD,ALDET940
          CALL      DETMAL1          * Delete from Temp File
.
          MOVE      TMALSUR,NZIBSURN
          MOVE      TMALGV1,NZIBGIV1
          MOVE      TMALGV2,NZIBGIV2
          MOVE      TMALGV3,NZIBGIV3
          MOVE      TMALPRE,NZIBPRNM
.
          CALL      REMALI00         * Remove Alias National
          CALL      REMLAL00         * Remove Alias Local
.
          GOTO      ALDET400
.
ALDET400  CALL      NXTPAG00
          BRANCH    EXIT,ALDET999
.
ALDET500  MOVE      ZERO,LOCALFLG           * Flag Local Record
          PROC      SETALI00
          BRANCH    EXIT,ALDET900,ALDET900   * Exit=2 Abort Exit=1 Cant Read NHI
.
          CALL      FORGIV00        * Format Given Name
          CALL      FORADD00        * Format Address
.
          MOVE      "NHI/MWS Alias Details",WEBTITLE
          CALL      WEBHED00    * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALDET999
          CALL      WEBBOD00    * Process Web Body
          CALL      WEBEND00    * Process End of HTML File 
          MOVE      ZERO,EXIT
          GOTO      ALDET999
.
ALDET900  CALL      NHERR000                * display error message
          MOVE      ONE,EXIT
          GOTO      ALDET999
.
ALDET910  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALDET999
.
ALDET920  MOVE      "Invalid Patient Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
ALDET930  MOVE      "Patient has a Temporary HCU.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALDET999
.
ALDET940  MOVE      "Invalid Alias Key.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALDET999
.
ALDET950  MOVE      "Mandatory Field Missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALDET999
.
ALDET999  RETURN
.----------------------------------------------------
. Remove Old Alias from National System
.----------------------------------------------------
REMALI00  MOVE      "3",NZIBNMCF
          MOVE      SP70,NZIBADD1
          MOVE      SP70,NZIBADD2
          MOVE      SP70,NZIBSUBR
          MOVE      SP70,NZIBCITY
          MOVE      SP70,NZIBCTRY
          MOVE      SP70,NZIBDOB
          MOVE      SP70,NZIBDDTH
          MOVE      SP70,NZIBDOMC
          MOVE      SP70,NZIBRESI
          MOVE      SP70,NZIBETHN
          MOVE      SP70,NZIBETH2
          MOVE      SP70,NZIBETH3
          MOVE      SP70,NZIBSEX
          MOVE      "Y",NZIBDUPL
          CALL      UPDHCU
          IF        OVRCD=1
            CALL      NZHISERR
          ENDIF
REMALI99  RETURN
.---------------------------------------------
. Remove Local Alias
.---------------------------------------------
REMLAL00  MOVE      PURNO,GSRURNO            * U/R number
          MOVE      ZERO,GSRBILL             * billing number
          MOVE      ZERO,GSRSYS              * system
          PACK      GSRSNAM,NZIBSURN,SP70
          PACK      GSRGNAM,NZIBGIV1,SP70
          CALL      ALIGIV00
.
REMLAL50  CALL      SOUNDEX                  * get surname soundex
          CALL      SOUNDX2                  * get given name soundex
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          OPEN      PATGSRN1,"patgsrnf"
          CALL      RDPTGSR1
          IF        OVRCD=0
            CALL      DEPTGSR1
          ENDIF
.
REMLAL99  RETURN
.------------------------------------------------------------
. Format Local Given Name from National Given Names
.------------------------------------------------------------
ALIGIV00  CLEAR     PTGSGNM2
          MOVE      NZIBGIV2,KEY20
          STRIP     KEY20
          APPEND    KEY20,PTGSGNM2
          MATCH     SP20,NZIBGIV3
          IF        !@EQUAL
            MOVE      NZIBGIV3,KEY20
            STRIP     KEY20
            APPEND    SP1,PTGSGNM2
            APPEND    KEY20,PTGSGNM2
          ENDIF
          APPEND    SP70,PTGSGNM2
          RESET     PTGSGNM2
          RETURN
.------------------------------------------------------------
. National Alais Records
.------------------------------------------------------------
NALI0000  BRANCH    FLDITMNO,NALI0010,NALI0020,NALI0030,NALI0040,NALI0050:
                             NALI0060
          GOTO      NALI9999
.
NALI0010  MATCH     SP70,TMALSUR
          GOTO      NALI9999 IF EQUAL
          WRITE     HTMLFILE;TMALSUR;
          GOTO      NALI9999
.
NALI0020  MATCH     SP70,TMALGV1
          GOTO      NALI9999 IF EQUAL
          WRITE     HTMLFILE;TMALGV1;
          GOTO      NALI9999
.
NALI0030  MATCH     SP70,TMALGV2
          GOTO      NALI9999 IF EQUAL
          WRITE     HTMLFILE;TMALGV2;
          GOTO      NALI9999
.
NALI0040  MATCH     SP70,TMALGV3
          GOTO      NALI9999 IF EQUAL
          WRITE     HTMLFILE;TMALGV3;
          GOTO      NALI9999
.
NALI0050  MATCH     SP70,TMALPRE
          GOTO      NALI9999 IF EQUAL
          WRITE     HTMLFILE;TMALPRE;
          GOTO      NALI9999
.
NALI0060  CALL      TABALI00
          GOTO      NALI9999
.
NALI9999  RETURN
.
TABALI00  PACK      KEY11,URNUMBER,SP70
          CALL      RSTMAL1
TABALI10  CALL      RKTMAL1
          BRANCH    OVRCD,TABALI99
          MATCH     URNUMBER,TMALURNO
          GOTO      TABALI99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td>",TMALSUR,"</td>":
                                 "<td>",TMALGV1,"</td>":
                                 "<td>",TMALGV2,"</td>":
                                 "<td>",TMALGV3,"</td>":
                                 "<td>",TMALPRE,"</td>":
                                 "<td><input type=button class=button ":
                                 "value=#"Delete#" onclick='":
                                 "DeleteAlias(#"",TMALURNO,TMALLIN,"#");'>":
                                 "</td></tr>"
          GOTO      TABALI10
.
TABALI99  RETURN
.--------------------------------------------------
. Add Alias to National System
.--------------------------------------------------
MAKALI00  MOVE      TMALSUR,NZIBSURN
          MOVE      TMALGV1,NZIBGIV1
          MOVE      TMALGV2,NZIBGIV2
          MOVE      TMALGV3,NZIBGIV3
          MOVE      TMALPRE,NZIBPRNM
          MOVE      "4",NZIBNMCF
          MOVE      SP70,NZIBADD1
          MOVE      SP70,NZIBADD2
          MOVE      SP70,NZIBSUBR
          MOVE      SP70,NZIBCITY
          MOVE      SP70,NZIBCTRY
          MOVE      SP70,NZIBDOB
          MOVE      SP70,NZIBDDTH
          MOVE      SP70,NZIBDOMC
          MOVE      SP70,NZIBRESI
          MOVE      SP70,NZIBETHN
          MOVE      SP70,NZIBETH2
          MOVE      SP70,NZIBETH3
          MOVE      SP70,NZIBSEX
          MOVE      "Y",NZIBDUPL
          CALL      UPDHCU
          IF        OVRCD=1
            CALL      NZHISERR
          ENDIF
          MOVE      TMALSUR,NZIBSURN
          MOVE      TMALGV1,NZIBGIV1
          MOVE      TMALGV2,NZIBGIV2
          MOVE      TMALGV3,NZIBGIV3
          MOVE      TMALPRE,NZIBPRNM
          RETURN
.---------------------------------------------
. New Local Alias Write
.---------------------------------------------
MAKLAL00  MOVE      PURNO,GSRURNO            * U/R number
          MOVE      ZERO,GSRBILL             * billing number
          MOVE      ZERO,GSRSYS              * system
          PACK      GSRSNAM,NZIBSURN,SP70
          PACK      GSRGNAM,NZIBGIV1,SP70
          CALL      ALIGIV00
.
MAKLAL50  MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          CALL      SOUNDEX                  * get surname soundex
          CALL      SOUNDX2                  * get given name soundex
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          OPEN      PATGSRN1,"patgsrnf"
          CALL      RDPTGSR1
          IF        OVRCD=1
            CALL      WRPTGSR1
          ENDIF
.
MAKLAL99  RETURN

.------------------------------------------------------------
.  Medical Warnings
.------------------------------------------------------------
MWDET000  RESET     UPDTTYPE
          CALL      CLRNZIB0                * Clear National details
          CALL      CLRDNR00                * Clear National details
          CALL      CLRNDR00                * Clear National donor details
          CALL      CLNHIMAS                * Clear Local details
.
          MATCH     SP70,URNUMBER           * Must have a UR Number
          GOTO      MWDET920 IF EQUAL       * Error
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MWDET920
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          PACK      KEY8,PURNO,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          BRANCH    OVRCD,MWDET920
          MOVE      NHMANMPI,NZIBNMPI
          CALL      CONNECT
          BRANCH    EXIT,MWDET999
          CALL      GETHCU                  * Read National Details
          BRANCH    OVRCD,MWDET900
.
          MATCH     "$",NHMANMPI      * Old Temp Number Prefix
          GOTO      MWDET930 IF EQUAL
          MATCH     "T-",NHMANMPI     * New Temp Number Prefix
          GOTO      MWDET930 IF EQUAL
.
          MATCH     SP1,UPDTTYPE
          GOTO      MWDET500 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      MWDET100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Udpate
          GOTO      MWDET200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      MWDET300 IF EQUAL
.
          GOTO      MWDET910               
. Add
MWDET100  MATCH     SP70,NHMWS001
          GOTO      MWDET950 IF EQUAL
          MATCH     SP70,NHMWS002
          GOTO      MWDET950 IF EQUAL
          MATCH     SP70,NHMWS003
          GOTO      MWDET950 IF EQUAL
.
          CALL      ADDMWS00
          BRANCH    EXIT,MWDET999
.         CALL      WINCLS00
          GOTO      MWDET400
.
. Update
MWDET200  PACK      KEY14,NHMWSKEY,SP70
          CALL      RDPTMWS1
          BRANCH    OVRCD,MWDET940
          CALL      UPDMWS00
          BRANCH    EXIT,MWDET999
          GOTO      MWDET400
. Delete
MWDET300  PACK      KEY14,NHMWSKEY,SP70
          CALL      RDPTMWS1
          BRANCH    OVRCD,MWDET940
          CALL      DELMWS00
          BRANCH    EXIT,MWDET999
          GOTO      MWDET400
.
MWDET400  CALL      CHKMED00
          CALL      NXTPAG00
          BRANCH    EXIT,MWDET999
.
MWDET500  MOVE      ZERO,LOCALFLG           * Flag Local Record
          PROC      SETMED00
          BRANCH    EXIT,MWDET900,MWDET900   * Exit=2 Abort Exit=1 Cant Read NHI
          MATCH     SP70,NHMWSKEY
          IF        !@EQUAL
            MOVE      NHMWSKEY,KEY14
            CALL      RDPTMWS1
          ENDIF
.
          CALL      FORGIV00        * Format Given Name
          CALL      FORADD00        * Format Address
.
          MOVE      "NHI/MWS Medical Warnings",WEBTITLE
          CALL      WEBHED00    * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MWDET999
          CALL      WEBBOD00    * Process Web Body
          CALL      WEBEND00    * Process End of HTML File 
          MOVE      ZERO,EXIT
          GOTO      MWDET999
.
MWDET900  CALL      NHERR000                * display error message
          MOVE      ONE,EXIT
          GOTO      MWDET999
.
MWDET910  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWDET999
.
MWDET920  MOVE      "Invalid Patient Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
MWDET930  MOVE      "Patient has a Temporary HCU.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWDET999
.
MWDET940  MOVE      "Invalid Medical Warning Key.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWDET999
.
MWDET950  MOVE      "Mandatory Fields Missing.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MWDET999
.
MWDET999  RETURN
.------------------------------------------------------------
. Write a Medical Warning audit record
.------------------------------------------------------------
WRTDAU00  OPEN      PMSDAUA1,"pmsdauaf"
          CALL      CLPMSDAU
          MOVE      URNUMBER,PMDEURNO
          MOVE      "012",PMDERTYP
.
WRTDAU10  CALL      IBACLOCK
          PACK      PMDECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDECDAT
          PACK      PMDECTIM,CTIMEIS
.
          PACK      KEY27,URNUMBER,PMDECDAT,PMDECTIM,PMDERTYP,SP70
          CALL      RDPMDAU1
          COMPARE   ZERO,OVRCD
          GOTO      WRTDAU10 IF EQUAL
.
          PACK      PMDEFL01,SAVEMWAC,SP70,SP70       * Warning Add/Upd/Del
          PACK      PMDEFL02,SAVEMWDT,SP70,SP70       * Warning Onset Date
          PACK      PMDEFL03,SAVEMWDS,SP70,SP70       * Warning Description
.
WRTDAU90  PACK      USERNAME,USERNAME,SP70            * Write Audit Record
          MATCH     SP70,USERNAME
          IF        @EQUAL
            PACK      PMDECUID,WBSEUID,SP70
          ELSE
            PACK      PMDECUID,USERNAME,SP70
          ENDIF
.
WRTDAU95  CALL      WRPMDAU1
.
WRTDAU98  CLOSE     PMSDAUA1
.
WRTDAU99  RETURN
+
.------------------------------------------------------------
. Update a Medical Warning to National & Local Systems
.------------------------------------------------------------
UPDMWS00  PACK      KEY14,NHMWSKEY,SP70
          CALL      RDPTMWS1
          BRANCH    OVRCD,UPDMWS99
.
          MOVE      "Update MWS Warning",SAVEMWAC     * save for audit
          MOVE      PTMWDATE,SAVEMWDT                 * previous value
          MOVE      PTMWTEXT,SAVEMWDS                 * previous value
.
          MOVE      NHMWS001,PTMWCLSS
          MOVE      NHMWS002,PTMWDATE
          MOVE      NHMWS003,PTMWTEXT
          MOVE      NHMWS004,PTMWDOCT
          MOVE      NHMWS005,PTMWSYS
          MOVE      NHMWS006,PTMWCODE
          CALL      UPPTMWS1         
.
          CALL      WRTDAU00                     * Write Medical Warning audit
.
          CALL      PMIGTNID                     * broadcast A31 message
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP
.
          MOVE      PTMWCODE,NZIBMWCD
          MOVE      PTMWLUPD,NZIBENTM
          MOVE      PTMWCLSS,NZIBSEVR
          MOVE      PTMWDATE,NZIBDTON
          MOVE      PTMWTEXT,NZIBWTXT
          MOVE      PTMWMARC,NZIBMARC
          MOVE      PTMWHOSP,NZIBFACC
          MOVE      PTMWDOCT,NZIBDOCC
          MOVE      PTMWSYS,NZIBSYSI
          REP       " 0",NZIBSYSI
          MATCH     "00",NZIBSYSI
          IF        @EQUAL
            MOVE      SP20,NZIBSYSI
          ENDIF
          MOVE      PTMWCODE,NZIBMWCD
.
          MOVE      "M",NZIBUACT
          CALL      UPDMWS
          COMPARE   ZERO,OVRCD
          GOTO      UPDMWS90 IF EQUAL
          CALL      NZHISERR
          MOVE      ONE,EXIT
          GOTO      UPDMWS99
.
UPDMWS90  MOVE      ZERO,EXIT
.
UPDMWS99  RETURN
.------------------------------------------------------------
. Add a Medical Warning to National & Local Systems
.------------------------------------------------------------
ADDMWS00  MOVE      NHMWS001,NZIBSEVR
          MOVE      NHMWS002,NZIBDTON
          MOVE      NHMWS003,NZIBWTXT
          MOVE      SP70,NZIBMARC
.
          READ      CONTROLF,TEN;*54,CFILENO
          PACK      NZIBFACC,CFILENO,SP70
.
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHOSP
            IF        !@EQUAL
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MATCH     SP70,PTHSHDPC
                IF        !@EQUAL
                  PACK      NZIBFACC,PTHSHDPC,SP70
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      NHMWS004,NZIBDOCC
          MOVE      NHMWS005,NZIBSYSI
          REP       " 0",NZIBSYSI
          MATCH     "00",NZIBSYSI
          IF        @EQUAL
            MOVE      SP20,NZIBSYSI
          ENDIF
          MOVE      NHMWS006,NZIBMWCD
          MOVE      NHMANMPI,NZIBNMPI
          CALL      IBACLOCK
          UNPACK    CTIMEIS,UPDHH,ANS,UPDMM,ANS,UPDSS
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      NZIBENTM,KEY8,UPDHH,UPDMM,UPDSS,SP70
          MOVE      "C",NZIBUACT
          CALL      UPDMWS
.
          COMPARE   ZERO,OVRCD
          GOTO      ADDMWS10 IF EQUAL
          MATCH     "2097",NZIBERRN
          GOTO      ADDMWS10 IF EQUAL
          MATCH     "2033",NZIBERRN
          GOTO      ADDMWS10 IF EQUAL
          MATCH     "2034",NZIBERRN
          GOTO      ADDMWS10 IF EQUAL
          CALL      NZHISERR
          MOVE      ONE,EXIT
          GOTO      ADDMWS99
.
ADDMWS10  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,NHMWS001,Z70
          CALL      RSPTMWS1
          CALL      RPPTMWS1
          BRANCH    OVRCD,ADDMWS20
          MATCH     URNUMBER,PTMWURNO 
          GOTO      ADDMWS20 IF NOT EQUAL
          MATCH     NHMWS001,PTMWCLSS 
          GOTO      ADDMWS20 IF NOT EQUAL
.
          MOVE      PTMWCNT,F3
.
ADDMWS20  ADD       ONE,F3
          MOVE      URNUMBER,PTMWURNO
          MOVE      NHMWS001,PTMWCLSS
          MOVE      NHMWS002,PTMWDATE
          MOVE      NHMWS003,PTMWTEXT
          MOVE      NHMWS004,PTMWDOCT
          MOVE      NHMWS005,PTMWSYS 
          MOVE      NHMWS006,PTMWCODE
          MOVE      NZIBFACC,PTMWHOSP
          MOVE      NZIBENTM,PTMWLUPD
          MOVE      SP70,PTMWMARC
          MOVE      F3,PTMWCNT
.
          PACK      KEY14,PTMWURNO,PTMWCLSS,F3
          CALL      WRPTMWS1
.
          MOVE      "Add MWS Warning",SAVEMWAC   * save for audit
          MOVE      SP70,SAVEMWDT                * previous value
          MOVE      SP70,SAVEMWDS                * previous value
.
          CALL      WRTDAU00                     * Write Medical Warning audit
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ADDMWS99
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     "2",PTMXSIN1
          IF        !@EQUAL
            MATCH     SP70,PTMXSIN1
            IF        @EQUAL
              MOVE      "1",PTMXSIN1
              CALL      UPMAST1
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                     * broadcast A31 message
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP
.
          MOVE      ZERO,EXIT
.
ADDMWS99  RETURN
.------------------------------------------------------------
. Delete Medical Warning
.------------------------------------------------------------
DELMWS00  PACK      KEY14,NHMWSKEY,SP70
          CALL      RDPTMWS1
          BRANCH    OVRCD,DELMWS99
.
          MOVE      "Delete MWS Warning",SAVEMWAC     * save for audit
          MOVE      PTMWDATE,SAVEMWDT                 * previous value
          MOVE      PTMWTEXT,SAVEMWDS                 * previous value
.
          CALL      DEPTMWS1
.
          CALL      WRTDAU00                     * Write Medical Warning audit
.
          CALL      PMIGTNID                     * broadcast A31 message
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP
.
          MOVE      PTMWCLSS,NZIBSEVR
          MOVE      PTMWDATE,NZIBDTON
          MOVE      PTMWTEXT,NZIBWTXT
          MOVE      PTMWMARC,NZIBMARC
          MOVE      PTMWHOSP,NZIBFACC
          MOVE      PTMWDOCT,NZIBDOCC
          MOVE      PTMWSYS,NZIBSYSI
          MOVE      PTMWCODE,NZIBMWCD
          MOVE      PTMWLUPD,NZIBENTM
.
          MOVE      "D",NZIBUACT
          REP       " 0",NZIBSYSI
          MATCH     "00",NZIBSYSI
          IF        @EQUAL
            MOVE      SP20,NZIBSYSI
          ENDIF
          CALL      UPDMWS
          BRANCH    OVRCD,DELMWS90
          MOVE      ZERO,EXIT
          GOTO      DELMWS99
.
DELMWS90  CALL      NZHISERR 
          MOVE      ONE,EXIT
.
DELMWS99  RETURN
.------------------------------------------------------------
. National Medical Warning System
.------------------------------------------------------------
NMWS0000  BRANCH    FLDITMNO,NMWS0010,NMWS0020,NMWS0030,NMWS0040,NMWS0050:
                             NMWS0060,NMWS0070,NMWS0080,NMWS0090,NMWS0100:
                             NMWS0110,NMWS0120,NMWS0130
          GOTO      NMWS9999
.
NMWS0010  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,PTMWCLSS
          GOTO      NMWS9999 IF EQUAL
.
          MOVE      PTMWCLSS,ANS
          MOVE      "Danger",SEVRDESC
          MATCH     ANSD,ANS
          GOTO      NMWS0015 IF EQUAL
          MOVE      "Warning",SEVRDESC
          MATCH     ANSW,ANS
          GOTO      NMWS0015 IF EQUAL
          MOVE      "Other",SEVRDESC
.
NMWS0015  IF        F1=0
            WRITE     HTMLFILE;SEVRDESC;
          ELSE
            WRITE     HTMLFILE;PTMWCLSS;
          ENDIF
          GOTO      NMWS9999
.
NMWS0020  MATCH     SP70,PTMWDATE
          GOTO      NMWS9999 IF EQUAL
          UNPACK    PTMWDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMWS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMWS9999
.
NMWS0030  MATCH     SP70,PTMWTEXT
          GOTO      NMWS9999 IF EQUAL
          WRITE     HTMLFILE;PTMWTEXT;
          GOTO      NMWS9999
.
NMWS0040  MOVE      PTMWDOCT,DOCTCODE
          CALL      DOCDET00
          GOTO      NMWS9999
.
NMWS0050  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      CLINSYS0,CLINDESC
          LOAD      CLINDESC,PTMWSYS,CLINSYS1,CLINSYS2,CLINSYS3,CLINSYS4:
                                     CLINSYS5,CLINSYS6,CLINSYS0,CLINSYS0:
                                     CLINSYS0,CLINSYS0,CLNSYS10,CLNSYS11
          IF        F1=0
            WRITE     HTMLFILE;CLINDESC;
          ELSE
            WRITE     HTMLFILE;PTMWCLSS;
          ENDIF
          GOTO      NMWS9999 IF EQUAL
.
NMWS0060  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,PTMWCODE
          GOTO      NMWS9999 IF EQUAL
          MOVE      PTMWSYS,F1
          PACK      KEY7,F1,PTMWCODE
          CALL      RDNHMC1
          IF        OVRCD=1
            MOVE      SP70,NHMCDES
          ENDIF
          IF        F1=0
            WRITE     HTMLFILE;NHMCDES;
          ELSE
            WRITE     HTMLFILE;PTMWCODE;
          ENDIF
          GOTO      NMWS9999
.
NMWS0070  CALL      TABMWR00
          GOTO      NMWS9999
.
NMWS0080  MATCH     SP70,PTMWMARC
          GOTO      NMWS9999 IF EQUAL
          UNPACK    PTMWMARC,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMWS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMWS9999
.
NMWS0090  MATCH     SP70,PTMWHOSP
          GOTO      NMWS9999 IF EQUAL
          WRITE     HTMLFILE;PTMWHOSP;
          GOTO      NMWS9999
.
NMWS0100  MATCH     SP70,PTMWLUPD
          GOTO      NMWS9999 IF EQUAL
          UNPACK    PTMWLUPD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      NMWS9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NMWS9999
.
NMWS0110  MATCH     SP70,PTMWLUPD
          GOTO      NMWS9999 IF EQUAL
          UNPACK    PTMWLUPD,KEY8,UPDHH,UPDMM,UPDSS
          WRITE     HTMLFILE;UPDHH,":",UPDMM,":",UPDSS;
          GOTO      NMWS9999
.
NMWS0120  PACK      KEY14,PTMWURNO,PTMWCLSS,PTMWCNT
          WRITE     HTMLFILE;KEY14;
          GOTO      NMWS9999
.
NMWS0130  PACK      KEY9,PTMWHOSP,SP70
          CALL      RSPTVAD3
          CALL      RKPTVAD3
          BRANCH    OVRCD,NMWS9999
          MATCH     PTMWHOSP,PTVANHSC
          GOTO      NMWS9999 IF NOT EQUAL
          WRITE     HTMLFILE;PTVADESC;
          GOTO      NMWS9999
.
NMWS9999  RETURN
.------------------------------------------------------------
. Table of Medical Warning Details
.------------------------------------------------------------
TABMWR00  PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
          CALL      RKPTMWS1
          BRANCH    OVRCD,TABMWR99
          MATCH     PTMWURNO,URNUMBER
          GOTO      TABMWR99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Severity</td>":
                                "<td class=HeadingCell>Date</td>":
                                "<td class=HeadingCell>Description</td></tr>"
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
TABMWR10  CALL      RKPTMWS1
          BRANCH    OVRCD,TABMWR99
          MATCH     PTMWURNO,URNUMBER
          GOTO      TABMWR99 IF NOT EQUAL
.
          MOVE      PTMWCLSS,ANS
          MOVE      "Danger",SEVRDESC
          MATCH     ANSD,ANS
          GOTO      TABMWR20 IF EQUAL
          MOVE      "Warning",SEVRDESC
          MATCH     ANSW,ANS
          GOTO      TABMWR20 IF EQUAL
          MOVE      "Other",SEVRDESC
.
TABMWR20  CALL      SETMWD00
          PACK      KEY14,PTMWURNO,PTMWCLSS,PTMWCNT,SP70
          WRITE     HTMLFILE;"<tr><td><img src=../images/MWSIcon.gif border=0 ":
                             "hspace=4 align=absmiddle ":
                             "onclick='UpdateMWS(#"",KEY14,"#")'>":
                             SEVRDESC,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",PTMWTEXT,"</td></tr>"
          GOTO      TABMWR10
.
TABMWR99  RETURN
.------------------------------------------------------------
. Set Medical Warning Date
.------------------------------------------------------------
SETMWD00  REP       " 0",PTMWDATE
          UNPACK    PTMWDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     "00",CDAY
          IF        @EQUAL
            MOVE      SP70,CDAY
          ENDIF
          MATCH     "00",CMON
          IF        @EQUAL
            MOVE      SP70,MTHNAM3
          ENDIF
          PACK      KEY4,CCENT,CYEAR
          MATCH     "0000",KEY4
          IF        @EQUAL
            MOVE      SP70,CCENT
            MOVE      SP70,CYEAR
          ENDIF
          RETURN
.------------------------------------------------------------
. Table Heading Row
.------------------------------------------------------------
TABHED00  WRITE     HTMLFILE;"<tr>":
                             "<td class=TableCol1><b> NMPI No </b></td>": 
                             "<td class=TableCol2><b> Patient </b></td>": 
                             "<td class=TableCol3><b> Sex </b></td>": 
                             "<td class=TableCol4><b> D.O.B </b></td>": 
                             "</tr>"
TABHED99  RETURN
.------------------------------------------------------------
. Table Details Row
.------------------------------------------------------------
TABROW00  SQUEEZE   NZIBNMRP
          MOVE      NZIBNMRP,FORM2
          COMPARE   ZERO,FORM2                    * a match found?
          GOTO      TABROW95 IF EQUAL
.
. loop until records are finished displaying
.
          SQUEEZE   NZIBNMRP
          MOVE      NZIBNMRP,NZFORM3B                rf 643903
          MOVE      ONE,TOTALCNT                  * initialise total counter
          WHILE     TOTALCNT<=NZFORM3B
            CALL      OUTROW00
            ADD       ONE,TOTALCNT
          DO
          GOTO      TABROW99
.
TABROW95  WRITE     HTMLFILE;"<tr>":
                        "<td colspan=4 align=center>":
                        "<b>NO RECORDS FOUND</td></tr>"
          GOTO      TABROW99
.
TABROW99  RETURN
.
. Output Table Row
.
OUTROW00  UNPACK    NZARDOB[TOTALCNT],CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      "      ",DISPSEX
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      NZARSEX[TOTALCNT],DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          MOVE      SP70,NHMAURNO
          MOVE      NZARNMPI[TOTALCNT],NHMANMPI
          MOVE      NZARNMPI[TOTALCNT],KEY7
          CALL      RDNHMAS1
          WRITE     HTMLFILE;"<tr valign=middle>":
                      "<td class=TableCol1>":
                      "<img src=../images/patdet.gif border=0 hspace=4 ":
                      "align=absmiddle onClick='PatientSelected(#"":
                      NHMANMPI,"#",#"",NHMAURNO,"#",#"",OVRCD,"#")'>":
                      NZARNMPI[TOTALCNT],"</td>": 
                      "<td class=TableCol2><b>":
                      NZARSURN[TOTALCNT],"</b>",", ":
                      NZARGIV1[TOTALCNT];
          MATCH     SP70,NZARGIV2[TOTALCNT]
          IF        !@EQUAL
            WRITE     HTMLFILE;", ",NZARGIV2[TOTALCNT];
          ENDIF
          MATCH     SP70,NZARGIV3[TOTALCNT]
          IF        !@EQUAL
            WRITE     HTMLFILE;", ",NZARGIV3[TOTALCNT];
          ENDIF
          WRITE     HTMLFILE;"<br>":
                      NZARADD1[TOTALCNT],NZARADD2[TOTALCNT]:
                      NZARSUBR[TOTALCNT],NZARCITY[TOTALCNT]:
                      NZARCTRY[TOTALCNT],NZARDOMC[TOTALCNT],"</td>": 
                      "<td class=TableCol3>":
                       DISPSEX,"</td>": 
                      "<td class=TableCol4>":
                       CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td></tr>"
          RETURN
.------------------------------------------------------------
.************************************************************************
.*  EMRREG00:  New registration with an emergency visit                 *
.************************************************************************
EMRREG00  PACK      KEY8,ADMISSNO
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRREG99
.
          PACK      KEY8,ADMISSNO
          CALL      DEEMVIS1           * Delete record
.
          MOVE      PURNO,EMVIURNO     * Associate the new urnumber to visit
          PACK      KEY8,ADMISSNO      * Write record with new key
          CALL      WREMVIS1
.
          PACK      KEY8,ADMISSNO,SP70   * need to delete unknown record
          CALL      RDEMUNK1
          IF        OVRCD=0
            CALL      DEEMUNK1                   * delete emrunkaf record
          ENDIF
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMCUR1
          IF        OVRCD=0
            MOVE      PURNO,PMCUURNO
            CALL      UPPMCUR1
          ENDIF
          CALL      UPPMCU00                     * update current patients
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          COMPARE   ZERO,OVRCD
          GOTO      EMRREG99 IF EQUAL
.
          MOVE      PURNO,PVIURNO
          MOVE      EMVIDATE,PVIDATE
          MOVE      DEMVIADM,PVIBILL
          MOVE      "1",PVITYPE
          MOVE      EMVIDOCT,PVIDOCT
          MOVE      "2",PVISTAT
          MOVE      "1",PVITRAN
          MOVE      WBSESIT,PVISITE
          MOVE      ADMISSNO,DPVIBILL
          CALL      WRPTVIS1              * Write to the patvisaf file
.
          MOVE      ADMISSNO,PMVXVISN     * Write to Visit extension table
          MOVE      EMVIDATE,PMVXVSDT
          MOVE      EMVIDOCT,PMVXDOCA
          MOVE      "0",PMVXCSNR
          MOVE      PPOST,PMVXPOST
          MOVE      "0",PMVXCFSG
          MOVE      "0",PMVXINGP
          MOVE      "0",PMVXHCP1
          MOVE      "0",PMVXHCP2
          MOVE      "0",PMVXHCP3
          MOVE      "0",PMVXHCP4
          MOVE      SP70,PMVXRHC1
          MOVE      SP70,PMVXRH1G
          MOVE      "1",PMVXRH1C
          MOVE      "0",PMVXPSTY
          MOVE      "0",PMVXVALW
          MOVE      "0",PMVXPALW
          MOVE      "0",PMVXINDC
          MOVE      "0",PMVXHOME
          MOVE      PMPXABRG,PMVXABRG
          MOVE      PMPXINTR,PMVXINTR      * Interpreter required
          MOVE      PMPXLNG1,PMVXLNG1      * Preferred Language 1
          CALL      IBACLOCK
          PACK      PMVXCDTE,CCC,CYY,CMM,CDD * current date
          REP       " 0",PMVXCDTE
          MOVE      CTIMEIS,PMVXCTIM
          MOVE      WBSEUID,PMVXWEBC
          MOVE      SP70,PMVXASGC
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXPGID
          MOVE      SP70,PMVXPILC
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          IF        OVRCD<>1
            PACK      PMVXMHOS,EMSTHSNO,SP70
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAPMVX11                * write to the Visit Extenson file
          IF        OVRCD=1
            CALL      WRPMVX11              * write to the Visit Extenson file
          ENDIF
          CALL      ADDALR00                * Add Alerts to EMR Patient
          CALL      ADDVIS00                * Adds a record to MR Visit Link
.
.         Write an A04 to register the patient in ED now that the U/R
.         has been assigned
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FIVE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAE                * trigger A04 registration message
.
EMRREG99  RETURN
.------------------------------------------------------------
. Add Alerts to EMR Patient
.------------------------------------------------------------
ADDALR00  PACK      KEY16,ADMISSNO,SP70      * Key is ADMISSNO number
          CALL      RSPTALT1                 * Read alerts code file
ADDALR10  CALL      RKPTALT1                 * Read next record
          BRANCH    OVRCD,ADDALR90           * no more alerts ?
.
          MATCH     ADMISSNO,PTALURNO        * For this patient ?
          GOTO      ADDALR90 IF NOT EQUAL    * no, read all alerts
.
          MOVE      PURNO,PTALURNO
          PACK      KEY16,PURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RAPTALR1
          IF        OVRCD=1
            CALL      WRPTALR1
.
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                   * trigger PMI update message
          ENDIF
.
          PACK      KEY16,ADMISSNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      DEPTALT1
          GOTO      ADDALR10
.
ADDALR90  CALL      ALCMA000
.
ADDALR99  RETURN
.------------------------------------------------------------
. Update Alert Comments Admisson number based
.------------------------------------------------------------
ALCMA000  PACK      KEY19,ADMISSNO,SP70
          CALL      RSPMALA1
ALCMA100  CALL      RKPMALA1
          BRANCH    OVRCD,ALCMA999          * end of file
.
          MATCH     ADMISSNO,PMANURNO       * same U/R Number?
          GOTO      ALCMA999 IF NOT EQUAL
.
          PACK      SAVKEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      ADDNEW00
.
          PACK      KEY19,SAVKEY19,SP70
          CALL      DEPMALA1
          PACK      KEY19,SAVKEY19,SP70
          CALL      RSPMALA1
          GOTO      ALCMA100
.
ALCMA999  RETURN
.---------------------------------------------------------------------.
.         now write the new comments back
.----------------------------------------------------------------------.
ADDNEW00  MOVE      PURNO,PMANURNO          * set U/R Number
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      RAPMALN1
          IF        OVRCD=1
            CALL      WRPMALN1
          ENDIF
.
ADDNEW99  RETURN
.************************************************************************
.*  SRHHCU  :  Initiate a Surname search on the National database       *
.************************************************************************
SRHHCU    MOVE      "5 ",NZIBACTN                 * action identifier
          CALL      FIFHD000                      * set up header details
.
          MOVE      "294",WRLNGTH                 * FIFO record length (write)
          WRITE     NZWFIFA1;NZIBSTX,NZIBACTN,NZIBUSER,NZIBVDU,NZIBRFIF:
                          NZIBSTYP,NZIBSTIM,NZIBRLIM:
                          NZIBSURN,NZIBGIV1,NZIBGIV2,NZIBGIV3,NZIBPRNM,NZIBNSTY:
                          NZIBADD1,NZIBADD2,NZIBSUBR,NZIBCITY,NZIBCTRY:
                          NZIBASTY,NZIBMGEN,NZIBMDOB,NZIBMAGE,NZIBMPAG;
.
. now get the reply (firstly checking for an error)
.
          MOVE      "116",RDLNGTH                * FIFO record length (reply)
          READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZIBAPPC,NZIBERRN,NZIBERRD:
                             NZIBNMFN,NZIBNMRE,NZIBNMRP,NZIBCPTR;
.
          MATCH     "AA",NZIBAPPC                 * valid read?
          GOTO      SRHCU900 IF NOT EQUAL         * error
.
          MOVE      "280",RDLNGTH                * FIFO record length (reply)
          MOVE      ONE,NZIBCNT
.
          SQUEEZE   NZIBNMRP
          MOVE      NZIBNMRP,FORM2
          WHILE     NZIBCNT <= FORM2
            READ      NZRFIFA1,RDLNGTH,PTCNNHTM;NZARNMPI[NZIBCNT]:
                               NZARSURN[NZIBCNT]:
                               NZARGIV1[NZIBCNT],NZARGIV2[NZIBCNT]:
                               NZARGIV3[NZIBCNT],NZARPRNM[NZIBCNT]:
                               NZARADD1[NZIBCNT],NZARADD2[NZIBCNT]:
                               NZARSUBR[NZIBCNT],NZARCITY[NZIBCNT]:
                               NZARCTRY[NZIBCNT],NZARDOB[NZIBCNT]:
                               NZARDDTH[NZIBCNT],NZARDOMC[NZIBCNT]:
                               NZARRESI[NZIBCNT],NZARETHN[NZIBCNT]:
                               NZARETH2[NZIBCNT],NZARETH3[NZIBCNT]:
                               NZARSEX[NZIBCNT]:
                               NZIBALNM,NZIBMWDN,NZIBMWST,NZIBMERG;
            ADD       ONE,NZIBCNT
          DO
.
          MOVE      ZERO,OVRCD                    * valid read
          GOTO      SRHCU999
.
SRHCU900  MOVE      ONE,OVRCD                     * an error was encountered
.
SRHCU999  RETURN
+
.******************************************************************************
.*                           CHKRES00                                         *
.*            Check if expiry warning is required                             *
.******************************************************************************
.
CHKRES00  MOVE      ZERO,EXIT
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MATCH     SP70,PTYPE
          GOTO      CHKRES99 IF EQUAL
.
          PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKRES99
.
          MATCH     ANST,TCINDC3
          GOTO      CHKRES99 IF NOT EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          BRANCH    OVRCD,CHKRES99
.
          MATCH     TODAY,PMRSTEXP
          IF        @LESS
             MOVE     TWO,EXIT
             GOTO     CHKRES99
          ENDIF
.
          MOVE      PMRSTEXP,EXPDATE
          SUB       TCFORM6,EXPDATE
.
          MATCH     TODAY,EXPDATE
          IF        @LESS
          ENDIF
.
CHKRES99  RETURN
+
.******************************************************************************
.*                           UPRES000                    Called by : UPMAD000 *
.*            Update/write residency details                                  *
.******************************************************************************
.
UPRES000  PACK      KEY8,URNUMBER,SP70
.
          CALL      RDPMRES1
          BRANCH    OVRCD,UPRES100
.
          CALL      MVPMSRES
          PACK      PMRSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRSUDAT
          CLOCK     TIME,PMRSUTIM
          MOVE      USERID,PMRSUUID
          CALL      UPPMRES1
          GOTO      UPRES999
.
UPRES100  CALL      CLPMSRES
          CALL      MVPMSRES
          PACK      PMRSCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRSCDAT
          CLOCK     TIME,PMRSCTIM
          MOVE      USERID,PMRSCUID
.
          PACK      KEY8,URNUMBER,SP70
          CALL      WRPMRES1
.
UPRES999  RETURN
+
.------------------------------------------------------------
. Update master file if no medical warnings
.------------------------------------------------------------
.---Update master if all alerts for the patient are deleted---
CHKMED00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKMED99
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      SP70,PTMXSIN1
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPTALR1
CHKMED20  CALL      RKPTALR1
          BRANCH    OVRCD,CHKMED25          * No alerts
.
          MATCH     PTALURNO,URNUMBER       * Same ur
          GOTO      CHKMED25 IF NOT EQUAL
.
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKMED20
.
          REP       "S2 1",TCINDC4
.
          MATCH     "2",TCINDC4
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4       * Yes security alert for this ur
            GOTO      CHKMED40
          ENDIF
.
          MATCH     PTMXSIN1,TCINDC4
          IF        @LESS
            PACK      PTMXSIN1,TCINDC4
          ENDIF
.
          GOTO      CHKMED20
.
CHKMED25  MATCH     SP70,PTMXSIN1
          GOTO      CHKMED40 IF NOT EQUAL
.
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
          CALL      RKPTMWS1
          BRANCH    OVRCD,CHKMED40          * No alerts
.
          MATCH     PTMWURNO,URNUMBER       * Same ur
          GOTO      CHKMED40 IF NOT EQUAL
.
          MOVE      "1",PTMXSIN1            * Yes alers for this ur
.
CHKMED40  BRANCH    CAUDA1,CHKMED60         * Using alert audits
.
          MATCH     "0",PTMXSIN1            * Any current alerts
          IF        !@EQUAL
            MATCH     " ",PTMXSIN1          * Any current alerts
            GOTO      CHKMED60 IF NOT EQUAL
          ENDIF
.
          PACK      KEY27,URNUMBER,SP70
          CALL      ASPTALR2
CHKMED45  CALL      AKPTALR2
          BRANCH    OVRCD,CHKMED60
.
          MATCH     URNUMBER,PTALURNO
          GOTO      CHKMED60 IF NOT EQUAL
.
          MATCH     ANSD,PTALAUDR           * Delete
          GOTO      CHKMED45 IF NOT EQUAL
.
          MOVE      "3",PTMXSIN1            * Yes there are deleted alerts
.
CHKMED60  CALL      UPMAST1
.
CHKMED99  RETURN
.------------------------------------------------------------------------------
MVPMSRES  PACK      PMRSURNO,URNUMBER,SP70
          MATCH     Z70,PMRES001
          IF        !@EQUAL
            PACK      PMRSCONT,PMRES001,SP70
          ENDIF
          MATCH     Z70,PMRES002
          IF        !@EQUAL
            PACK      PMRSTEXP,PMRES002,SP70
          ENDIF
          MATCH     Z70,PMRES003
          IF        !@EQUAL
            PACK      PMRSGRDT,PMRES003,SP70
          ENDIF
          MATCH     Z70,PMRES004
          IF        !@EQUAL
            PACK      PMRSCOMM,PMRES004,SP70,SP70
          ENDIF
          MATCH     Z70,PMRES005
          IF        !@EQUAL
            PACK      PMRSVISN,PMRES005,SP70
          ENDIF
          MATCH     Z70,PMRES014
          IF        !@EQUAL
            PACK      PMRSSTDN,PMRES014,SP70,SP70
          ENDIF
.
          RETURN
.
.------------------------------------------------------------------------------
.                    REMOTE SCRIPTING FUNCTION
.------------------------------------------------------------------------------
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
REMOTE05  MOVE      ZERO,F1
          MOVE      UPDTTYPE,F1
          BRANCH    F1,REMOTE10
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE90
.
REMOTE10  CALL      XVALUR00      * Check U/R Number format
          GOTO      REMOTE90    
.
REMOTE90  CALL      XMLEND00
.
REMOTE99  RETURN
.
.------------------------------------------------------------------------------
. Remote script U/R number format validation    
.------------------------------------------------------------------------------
XVALUR00  PACK      PURNO,URNUMBER,SP70
.
          CALL      VALDUR                  * Validate the format of the U/R
          BRANCH    EXIT,XVALUR90           * Invalid U/R Number
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE:                          * Valid U/R format
                             "</RETURN_VALUE>"
.
          GOTO      XVALUR99
.
XVALUR90  IF        PTCNHDPS=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "HCU Id does not pass check digit":
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               " INVALID U/R Number Entered ":
                               "</RETURN_VALUE>"
          ENDIF
.
XVALUR99  RETURN
.
.*******************************************************************************
.                         Get Gender HDP  
.*******************************************************************************
GGHDP000  PACK      KEY5,ANSG,SP1,ACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GGHDP900
.
          GOTO      GGHDP999
.
GGHDP900  MOVE      SP70,THCSCOD
.
GGHDP999  RETURN
+
.*******************************************************************************
.                         Goes back 1 page
.*******************************************************************************
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    history.go(-2);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.*****************************************************************************
.         I/O Includes
.*****************************************************************************
.
          INC       IBAWEBCD
.
          INC       CALCAGE
          INC       CLMRTMAS
          INC       CLPATMAS
          INC       CLPATHSP
          INC       CLPMSCEX
          INC       CLPMSDAU
          INC       CLPMSPX2
          INC       CLPMSPAY
          INC       CLVISPAY
          INC       CLPMSRES
          INC       DEATHAUD
          INC       DGCLICAE
          INC       DGCLICUP                                           *C-90202
          INC       EXPPAYCD
          INC       MRTVISCD
          INC       NAMSTRCD
          INC       NZHISWIO
          INC       NZHISWUP
          INC       PATCOMN2                * Copy of WECOMN2
          INC       PATDOCCD
          INC       PATDOCTM
          INC       PATHSPTM
          INC       PATMASTM
          INC       PATMSXTM
          INC       PMSCEXCD
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PMSPX2TM
          INC       NEWBNMAS
          INC       UPDUR
.
          INC       APSMASIO/INC
          INC       BOKRC1IO/INC
          INC       EMRVISIO/INC
          INC       EMRUNKIO/INC
          INC       MRTMASIO/INC
          INC       MRTVISIO/INC
          INC       NHIDCDIO/INC
          INC       NHIDNRIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       NHIMCCIO/INC
          INC       NHIRELIO/INC
          INC       OUTCLIIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
          INC       PATALRIO/INC
          INC       PATAM1IO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATFN1IO/INC
          INC       PATGSRIO/INC
          INC       PATINVIO/INC
          INC       PATIN1IO/INC
          INC       PATLOCIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATMRGIO/INC
          INC       PATNIDIO/INC
          INC       PATPA1IO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATTRNIO/INC
          INC       PATURAIO/INC
          INC       PATVADIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSALAIO/INC
          INC       PMSALNIO/INC
          INC       PMSCEXIO/INC
          INC       PMSCURIO/INC
          INC       PMSDAUIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSNEWIO/INC
          INC       PMSPAYIO/INC
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PMSRESIO/INC
          INC       RESLNKIO/INC
          INC       TMPALIIO/INC
          INC       PATHSPIO/INC
          INC       MRTLOCIO/INC
          INC       EMRSITIO/INC
          INC       VISPAYIO/INC
