.******************************************************************************
. Program        : ALLWEB03
.
. Function       : Allied Health (ALLWEB03) Web Server
.
. Modifications  :
.------------------------------------------------------------------------------
. V12.00.05 11/08/2025  Zumin Y         TSK 0965397
.           Recompiled for ACONTACT - Contact date/time error message
. V12.00.04 04/08/2025  Zumin Y         TSK 0964781
.           Recompiled for ACONTACT - Date error message.
. V12.00.03 24/05/2025  Nikitha B       TSK 0959690
.           Recompiled for ABFRFINV-Added NWAU Calculations for VINAH
. V12.00.02 30.05.2025  DA Sarkies      TSK 0955096
.            Updated for Alpha-Numeric Visit Number
. V12.00.01 13/05/2025  Ebon Clements   TSK 0955096
.            Added alpanumeric visit number generation - NXTA0000 - GENANVIS
. V11.05.02 07/05/2025  Nikitha B       TSK 0959601
.           Recomplied for PATMISTM.
. V11.05.01 11/02/2025  Nikitha B        TSK 0953087
.           Recomplied for IBAWEBCD.
. V11.04.09 16/09/2024 PJ Le Febour   TSK 0951542
.           AREF3001 - moved test of PTCOACTV if ACTIVE 
.           after MATCH ALRECONT(allencaf )and ALCCCONT(allcctaf)
. V11.04.08 15/07/2024 Alina Bhari    TSK 0947847
.           Recompiled for ALLENCTM                                    
. V11.04.07 15/04/2024 Alina Bhari    TSK 0936285
.           Properly displayed Prev and Next data for show HCP filter
.           - PREVGR00, NEXTGR00                                        
. V11.04.06 08/04/2024 Alina Bhari    TSK 0936285
.           Displayed contacts that are only for the given HCP in the filter
.           selections on the contact lists                                  
.           - FILTRHCP,ABRF1010,BENC1010,ALGP1010
. V11.04.05 08/02/2024 Thanh T        TSK 0903618
.           Changed AREF2900 and AREF3000 to fix issue with incorrect
.           contract list
. V11.04.04 19/01/2024 Thanh T        TSK 0903618
.           Recompiled for ALLCCTFD changes
. V11.04.03 09/01/2024 Thanh T           TSK 0936263
.           Added CLPMSQPX to clear pmsqpxaf table variables
. V11.04.02 18/12/2023 Thanh T        TSK 0932089
.           Recompiled for PRIHREFD changes
. V11.04.01 27/11/2023 Thanh T        TSK 0903618
.           Recompiled for ALLCCTFD changes
. V11.03.15 09/10/2023 Jacob Jackson  TSK 0887580
.           Replace STARTNUM tag with uncalculated version (SRTNUMBL)
. V11.03.14 22/09/2023 Jacob Jackson  TSK 0887580
.           Addition of new tags for creating URLs for moving through
.           pages of records
. V11.03.13 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes
. V11.03.12 10/07/2023  J.Tan          TSK 0923703
.           Recompiled for ABFRFINV - Hospital remoteness
. V11.03.11 09/06/2023  J.Tan          TSK 0923703
.           Recompiled for ABF new calculations
. V11.03.10 05.06.2023  Ebon Clements TSK 0928369
.           NDIS card number of 999999999 is not valid so prompt warning
.           to collect a valid card number -  NDIS0000
. V11.03.09 17.05.2023  DA Sarkies    TSK 0928369
.           Added function to display whether valid NDIS card is present.
.           Updated remote scripts to retrieve NDIS card details.
. V11.03.08 01/05/2023  J.Tan         TSK 0930981
.           Recompiled for ABFVARS  - removed REFENCNT
. V11.03.07 21/04/2023  J.Tan         TSK 0930981
.           Recompiled for ABFRFINV - increased array variables
. V11.03.06 21/04/2023  J.Tan         TSK 0930981
.           Recompiled for ABFRFINV - fixed monthly encounter
. V11.03.05 19/04/2023  J.Tan         TSK 0930981
.           Recompiled for ABFRFINV - fixed monthly encounter
. V11.03.04 09/03/2023  Sunny         TSK 0927478
.           Recompiled for ACONTACT - Fixed check for ALREF006 in NEWENC00
. V11.03.03 11/01/2023  J.Tan         TSK 0906597
.           Recompiled for ABFRFDET - changed Referral ABF formula
. V11.03.02 24/11/2022 J.Tan    TSK 0906597
.           Recompiled for ABFRFINV - Monthly referral to charge monthly
. V11.03.01 15/11/2022 J.Tan           TSK 0906597
.           Recompiled ABFRFINV - setting effective date for Monthly referral
. V11.02.05 11/10/2022 J.Tan           TSK 0906597
.           Mod for Referral NWAU Calculations
. V11.02.04 22/07/2022  Ebon Clements    TSK 0921629
.           Added write of EDWARD OP visit update trigger after addition
.           of an encounter - WEDT0000
. V11.02.03 14/02/2022  Ebon Clements    TSK 0864233
.           Added no check in time edit cat CG ind 28 test - CHKODT00
. V11.02.02  09/02/2022  Thanh T       TSK 0905641
.            Recompiled as OUTHEDFD/OUTMA1FD/WATTR1FD changes
. V11.02.01  07/02/2022  Thanh T       TSK 0896905
.            Recompiled for ALLDEPFD changes
. V11.01.06 23/11/2021  Ebon Clements    TSK 0913624
.           Set AGEDATE to deceased date if deceased
. V11.01.05 22.11.2021  DA Sarkies       TSK 0912909
.           Recompiled for ALLENCTM - Fixed occassion of service code      
. V11.01.04 17.11.2021  DA Sarkies       TSK 0912909
.           Recompiled for ALLENCTM - Added goto line to correct section   
. V11.01.03 04.11.2021  DA Sarkies       TSK 0912909
.           Added third variable to SRVSEL10 to retrive avlues to determine
.           whether Family/Whanau is set
. V11.01.02 29/09/2021  Ebon Clements    TSK 0899729
.           Added keep alive to bulk encounter list - BENC0000
. V11.01.01 31/03/2021  Sunny            TSK 0872513
.           Changed error message display in CDUEN900 
. V11.00.03 09/12/2020  Thanh T          TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.02 19/05/2020  Ebon Clements    TSK 0891242
.           Only delete items when updating/cancelling a referral if items are
.           received from the screen - UITM0000 - UPDITEMS
. V11.00.01 06/05/2020  Ebon Clements    TSK 0888438
.           Added IP visit type edit to linked IP admissions - LNKINP00
. V10.15.05 20/02/2020  Tracey Nguyen    TSK 0881801
.           Added check for Next Review Date to update allrefaf - ALLREF10
. V10.15.04 03/02/2020  Tracey Nguyen    TSK 0881801
.           Added check for Next Review Date to update allrefaf - CANENC80
. V10.15.03 19/11/2019  Ebon Clements    TSK 0872933
.           Added VINAH triag status/priority tags - MISC3400 MISC3500
. V10.15.02 07/11/2019  Tracey Nguyen    TSK 0865480
.           Added MULTILRF flag for CPRI0000 to replace the use of the common
.           EXIT flag to fix potential premature end of script headers error
. V10.15.01 07/10/2019  Tracey Nguyen   TSK 0865480
.           Added functionality to automatically close a Primary referral 
.           from a linked referral - ALLREF10, ACLOS000, CPRI0000, ADDB1000
.------------------------------------------------------------------------------
. V10.14.16 13/09/2019  Ebon Clements   TSK 0880123
.           Added ALCNSDOC - Don't update OP booking seen by doctor
. V10.14.15 27/08/2019  Thanh T         TSK 0879640
.           Changed LNKINP00 to call AMAS0000 to activate a waiting master
.           referral if the linked internal referral is active  
. V10.14.14 06/08/2019  Peter Vela      TSK 0876649
.           Recompiled for ALLENCTM
. V10.14.13 24/07/2019  Peter Vela      TSK 0858824
.           Added Additional HCPs functionality
. V10.14.12 24/07/2019  Ebon Clements   TSK 0877522
.           Added linked OP appointment status tag - MISC3300
. V10.14.11 16/07/2019  Ebon Clements   TSK 0877986
.           Added 20 zero test to PTCNNSSI using EDWARD
. V10.14.10 11/07/2019  Ebon Clements   TSK 0877549
.           Only update OP booking actual doctor seen in bulk encounter 
.           if blank - ADDB0000
. V10.14.09 10/07/2019  Ebon Clements   TSK 0877824
.           Added VINAH audit trigger flags VINAHFLG, EPAUDFLG, RIAUDFLG and
.           VINAHREF to CLRPAR00
. V10.14.08 28/06/2019  Ebon Clements   TSK 0875554
.           Added linked OP booking slot time tag - MISC3100
.           Added linked OP booking slot duration tag - MISC3200
. V10.14.07 29/05/2019  Steve Armstrong TSK 0869966
.           Recompiled for changes to VINAHDEF
.           06/06/2019  Thanh T.        TSK 0870674
.           Changed ALLRAD10 to add LNKINP00 to check that the admission date
.           is equal or greater than the referral date, If it is not, show
.           error message. Otherwise, Update the status of referral from
.           Waiting to Active
. V10.14.06 29/05/2019  Steve Armstrong TSK 0869966
.           Recompiled for changes to ACONTACT
. V10.14.05 24/05/2019  Ebon Clements   TSK 0868837
.           Recompiled for VINAHDEF - Episode patient ready for care date clear
. V10.14.04 14/05/2019  Thanh T.        TSK 0868837
.           Added MISC2800, MISC2900 and MISC3000 tags 
.           13/05/2019  Steve Armstrong TSK 0869966
.           Recompiled for changes to VINAHDEF.
. V10.14.03 29/04/2019  Ebon Clements   TSK 0873275
.           Don't populate departure time for non EDWARD sites - CDEP0000
.           18/04/2019  Thanh T.        TSK 0868837
.           Added PROFLD45 for AREF0000 tag
. V10.14.02 12/03/2019  Tracey Nguyen   TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.01 21/02/2019  Ken Bell       TSK 0869548
.           Update/Recompiled for PATCLMTM - Diagnosis Codes for NZ templates
.------------------------------------------------------------------------------
. V10.13.17 13/12/2018  Ebon Clements   TSK 0867421
.           Removed linked visit contact update write - WEDE0000
. V10.13.16 28/11/2018  Richa Phogat    TSK 0867092
.           Updated departure time to set it to 23:59 when it is > than 23:59
. V10.13.15 28/11/2018  Richa Phogat    TSK 0867092
.           Updated CDEP0000 to calculate upto 10 hours for departure time
. V10.13.14 07/11/2018  Ebon Clements   TSK 0862246
.           Added clinic doctor and slot duration tags - MISC2600, MISC2700
. V10.13.13 24/10/2018  Ebon Clements  TSK 0815359
.           Don't allow IP contacts on pre admission - IPCONT00
. V10.13.12 17/10/2018  Steve Armstrong TSK 0845563
.           Recompiled for changes to ACONTACT
. V10.13.11 08/10/2018  Ebon Clements   TSK 0862246
.           Added Linked OP booking visit type tag - ABNR4100
. V10.13.10 12/09/2018  Ebon Clements   TSK 0862246
.           Fixed departure time population - OTBB7000
. V10.13.09 12/09/2018  Ebon Clements   TSK 0862246
.           Added encounter linked to OP visit tag - MISC2400
. V10.13.08 11/09/2018  Ebon Clements   TSK 0862246
.           Update OP booking actual doctor seen in bulk encounter - ADDB0000
. V10.13.07 05/09/2018  Ebon Clements   TSK 0862246
.           Added edward alterations table encounter update write - WEDE0000
. V10.13.06 04/09/2018  Ebon Clements   TSK 0862246
.           Added update encounter items - UITM0000
. V10.13.05 21/08/2018  J.Tan           TSK 0859742
.           Mod to use CLPRIHTR - added Hospital Indicator
. V10.13.04 07/08/2018  Ebon Clements   TSK 0861031
.           Added RA before prihreff write - ALLBIL24
.           26/07/2018  J.Tan            TSK 0848506
.           Changed PP Doctor from DIM6 to DIM10
. V10.13.03 31/07/2018  Thanh T         TSK 0845563
.           Recompiled for ALLAUDFD
. V10.13.02 30/07/2018  Ebon Clements   TSK 0815359
.           Don't display IP department in selection lists
. V10.13.01 25/07/2018  Ebon Clements   TSK 0815359
.           Added report 18 - Inpatient Allied Health Contacts
. V10.12.05 25/05/2018  Tracey Nguyen   TSK 0844584
.           Added closing script in CDUEN900 
. V10.12.04 24/05/2018  Tracey Nguyen   TSK 0844584
.           Added CDUEN000 in ALLREF10,ALLREF20 and NEWBEN10 to check for 
.           duplicate encounters
. V10.12.03 15/05/2018  Nicole Torrisi  TSK 0856727
.           Added save of Next Review Date (ALREDREV) to LASTEN00 
. V10.12.02 23/03/2018  Thanh T.        TSK 0854273
.           Recompiled as ALLENCTM changed
. V10.12.01 13/02/2018  Peter Vela      TSK 0845330
.           Added post and display functionality for addcndat
. V10.11.08 18/12/2017  Ebon Clements  TSK 0846952
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.07 14/12/2017  Richa Phogat   TSK  0849632
.           Added "&deptcode=" to the url in ALDP0000 & ALGP0000
. V10.11.06 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.05 04/08/2017  Ebon Clements  TSK 0843265
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.04 02/08/2017  J.Tan          TSK 0837619
.           Added CLPRIHRE - clear prihreaf fields
. V10.11.03 01/08/2017  Richa Phogat   TSK 0842780
.           Rcompiled for ALLACTTM - CGI variables for ALLACTFD
. V10.11.02 28/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 21/07/2017  Ebon Clements   TSK
.           Recompiled for VINAHDEF - Program referral triage status
. V10.10.05 23/05/2017  Ebon Clements  TSK 0828866
.           Recompiled for VINAHDEF - Date referral accepted
. V10.10.04 23/05/2017  Richa Phogat   TSK 0319734
.           Updated Closure Date & Time for NZ only by adding 'Direct Minutes' 
.           to Start Date & Time
. V10.10.03 22/05/2017  Ebon Clements  TSK 0836853
.           Recompiled for ACONTACT - VINAH defaults
. V10.10.02 18/05/2017  Ebon Clements  TSK 0838800
.           Increased WEBWARNG array from 10 to 99 for bulk encounters.
.           Added validation for 95 warnings in CHKODT00
. V10.10.01 10/04/2017  Ebon Clements  TSK 0822225
.           Added last contact functionality to encounters  not using referrals
.           ALLNRF00
. V10.09.03 27/01/2017  Ebon Clements  TSK 0828785
.           Recompiled for ALLREFTM - OP Site selection list security test
. V10.09.02 11/01/2017  Ebon Clements  TSK 0828256
.           Fixed OP check in time to AH contact time edit - CHKODT00
. V10.09.01 13/12/2016  Jill Parkinson TSK 0822329
.           Added definition of ACCPORDN    
. V10.08.08 15/11/2016  Nicole Torrisi TSK 0815159
.           Recompiled for ALLENCTM/ALLENCTD
. V10.08.07 14/10/2016  Ebon Clements  TSK 0817582
.           Recompiled for VINAHDEF - Notified of first appointment default
. V10.08.06 09/08/2016  Ebon Clements  TSK 0817427
.           Added contact to OP check in time edit - BVLIDT00
. V10.08.05 05/08/2016  Peter Vela     TSK 0820438
.           Comment out spaces validation in CANENC80 for outcome
. V10.08.04 27/07/2016  Nicole Torrisi TSK 0819642
.           Recompiled for ALLACTTM
. V10.08.03 08/07/2016  Jill Parkinson TSK 0822002
.           Recompiled for PATMASTM
. V10.08.02 14/06/2016  Ebon Clements  TSK 0246291
.           Added contact date to Relink() - EVTR0000
. V10.08.01 18/04/2016  Peter Vela        CAR 0294177
.           Changed read to prihdb to KEY27
. V10.07.02 12/11/2015  Don Nguyen     CAR 320393
.           Added PROFLD57 - MISC0000 tag output
.           Modified NEWBEN00 - moved cgi vars into ALENC122 & ALENC125
.           Added TRNSFSRC - Transfer Source Code
.           Added MISC1900 - Outcome selection list using ALENOUTC (Encounter)
. V10.07.01 06/10/2015  Ebon Clements  CAR 316633
.           Added link waiting list to referral functionality
. V10.06.10 16/09/2015  Ebon Clements  CAR 309118
.           Added UR : title to urnumber tag at MISC1700
. V10.06.09 27/08/2015  Peter Vela     CAR 314808
.           Removed MASF0000 from PROFL130
.           Added tags for Patient Name and URNumber in MISC0000
. V10.06.08 24/08/2015  J.Tan          CAR 316626
.           Mods to include Cancelled appointment on Contact list for nz
. V10.06.07 12/08/2015  Peter Vela     CAR 314808
.           Added MASF0000 to PROFL130
.           11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
.           11/08/2015  Don Nguyen        CAR 308621 
.           Recompiled for PATVISTM - Added VISS6100
. V10.06.06 14/07/2015  J.Tan             CAR 317921
.           Recompiled for PMSEXTTM - checking for inactive Insurance code
. V10.06.05 07/07/2015  Don Nguyen        CAR 318844
.           Added AREF3000 - Contract Codes for Encounter/Contact of department
. V10.06.04 25/06/2015  Don Nguyen        CAR 318209
.           Modified AREF2900 to default the Referral Contract code (Cat gb)
. V10.06.03 12/05/2015  Ebon Clements     CAR 303890
.           Added ALLPROFD and open
. V10.06.02 29/04/2015  Don Nguyen        CAR 315661
.           Added AREF2900 - Contract Codes for a Referral Department
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer in use
.------------------------------------------------------------------------------
. V10.05.07 04/02/2015  Don Nguyen        CAR 311790
.           Added UPENCF00 - Get current update date/time/userid values
. V10.05.06 08/12/2014  Ebon Clements     CAR 305618
.           Added VINAHDEF - Default VINAH field functionality
. V10.05.05 14/11/2014  Ebon Clements     CAR 292656
.           Added ability to link/unlink cancelled OP visit to a referral
. V10.05.04 29/10/2014  Ebon Clements     CAR 270080
.           Changed linked OP visits to display in date order - LINKT000
.           Changed group bookings to display in date order - LGRP0000
.           21/10/2014  Nicole Torrisi    CAR 246291
.           Fixed to not display re-link button on cancelled referrals
. V10.05.03 16/10/2014  Ebon Clements     CAR 300396
.           Allow DNA and booked OP booking as valid visits in VALVIS00
. V10.05.02 21/09/2014  Nicole Torrisi    CAR 246291
.           Added relink button to linked visits
. V10.05.01 13/08/2014  Peter Vela        CAR 304860
.           Recompiled for PMSVX1TM
. V10.04.13 04/07/2014  Ebon Clements     CAR 302902
.           Added nonvinah to NEXT0000 and PREV0000
. V10.04.12 01/07/2014  Ebon Clements     CAR 302902
.           Added nonvinah test to allow use of enc not using referrals for
.           non vinah contacts if the department is using referrals - ENCNEW20
. V10.04.11 21/05/2014  Davin             CAR 292355
.           Created common code to add contact/encounter
.           Moved the following routines to ACONTACT.PBL:
.           AMAS0000,NEWENC00,VALIDT00,CHKBIL00,ADDENC00,WRCPAT00,AEMHI000,
.           URMHI000,FAPD0000,WLSTEN00,WRTRSH00,WRTRAU00
. V10.04.10 13/05/2014  Ebon Clements     CAR 298138
.           Added edit check for future linked OP visits if closing a referral
.           using bulk contacts - CHKOUT00
. V10.04.09 05/05/2014  Ebon Clements     CAR 289649
.           Clear encounter file vars at end of PRVENC00
. V10.04.08 17/04/2014  Peter Vela        CAR 300206
.           Changed ALDEDT00 to check DIM3 for a value
. V10.04.07 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.06 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.05 09/12/2013  Nicole Torrisi    CAR 289975
.           Replaced spaces with zeroes before all uses of XCDATE
.           25/03/2014  Patrick Adair     CAR 226788
.           recompiled for changes to ALLSUPTM & ALLSUPTD
.           28/01/2014  Patrick Adair     CAR 265844
.           new fields for PRA State and Mobile phone - (PRIHREFD)
. V10.04.04 14/03/2014  Don Nguyen        CAR 285773
.           Recompiled for changes to ALLENCTM
. V10.04.03 06/02/2013  Peter Vela       CAR 295606
.           Added ALCNDAMR to AMAS0000
. V10.04.02 21/01/2014  Peter Vela        CAR 294608
.           Added read of allrefaf in BULKEN70
. V10.04.01 21/01/2014  Peter Vela        CAR 294608
.           Added return of ALREUDT1 and ALREDACT in VALREF00
.------------------------------------------------------------------------------
. V10.03.39 04/12/2013  Ania P            CAR 294708
.           Changed KEY3 pack in ALDEDT00 to use correct value.
. V10.03.38 25/11/2013  Ebon Clements     CAR 231730
.           Cleared encounter fields in ADDB0000 to fix redirect if no
.           encounter is added due to a web error - BULKEN10
. V10.03.37 21/11/2013  Patrick Adair     CAR 256107
.           Added Claim Code to Encounter list - EVTH0000 & EVTR0000
. V10.03.36 16/10/2013  Ebon Clements  CAR 289649
.           Changed PRVENC90 to return spaces when no previous contact
. V10.03.35 09/10/2013  Ebon Clements  CAR 275205
.           Added EBS unknown U/R edits to limit U/R usage
. V10.03.34 02/10/2013  Peter Vela        CAR 291757
.           Recompiled for ALLREFTM
. V10.03.33 06/09/2013  Don Nguyen        CAR 285773
.           Recompiled for changes to ALLENCTM
. V10.03.32 30/08/2013  Don Nguyen        CAR 273426
.           Added checks in ENCNEW00 and MAKREF00 for a Non-VINAH referral.
.           Added NONVINAH cgi variable.
.           Recompiled for changes to ALLREFFD and ALLREFIO (added ALRENVIN).
. V10.03.31 12/08/2013  Ebon Clements     CAR 286042
.           Recompiled for ALLREFTM - Problems/Other factors affecting health
. V10.03.30 09.09.2013 B.G.Ackland
.           Flag XFORMAT passed to WRSE0000 to change output format
.           Enable JSON Type Output of Encounters
. V10.03.29 08/08/2013  Ebon Clements     CAR 289850
.           Added replace space with zero to ALDEUAHP tag - ALDEDT12
. V10.03.28 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.27 15/07/2013  Nicole Torrisi    CAR 267255
.           Changed VALVIS00 allow referrals as linked visits (parameter)
. V10.03.26 11/07/2013  Ebon Clements     CAR 287021
.           Added group code edit back to clinic type list - REFCTY00
. V10.03.25 04/07/2013  Ebon Clements     CAR 287021
.           Expand clinic type list to all. Removed group code  edit - REFCTY00 
. V10.03.24 30/06/2013  Davin             CAR 279183
.           Recompiled for changes to hl7 messaging (allquefd)
. V10.03.23 21/06/2013  Ania P            CAR 285833
.           Added use of ALLACTKY/ALREDEPT if DEPTCODE blank for ALDEDT00
. V10.03.22 04/06/2013  Ania P            CAR 285833
.           Added output for ALLDEPFD.ALDEUAHP
. V10.03.21 15/05/2013  Ebon Clements     CAR 284882
.           Recompiled for PATCODTM Include/Exclude selection list with default
. V10.03.20 29/04/2013  Ebon Clements     CAR 284280
.           Added future contact date/time edit to ENCNEW00
. V10.03.19 15/04/2013  Ebon Clements  CAR 283204
.           Populate OP booking time seem when adding encounters -  ADDB0000
. V10.03.18 25/03/2013  Ebon Clements  CAR 279575
.           Added record OP outcome on encounter functionality
. V10.03.17 20/03/2013  Peter Vela     CAR 279686
.           Added AREF0000 to PROFLD REPORTNO 13
. V10.03.16 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.15 06/06/2013  Peter Vela      CAR 279686
.           Added tag for linked outpatient visit clinic type
. V10.03.14 12/10/2012  Patrick Adair   CAR 273294
.           Recompiled for PATCLMTM
. V10.03.13 17/09/2012  Peter Vela        CAR 270586
.           Added update to reason for closure in allrefaf @ NEWENC00
.           Added supplies indicator tag
.           Added interventions indicator tag
.           Added medications indicator tag
. V10.03.12 13/09/2012  Peter Vela        CAR 270586
.           Added Capture Contact Details
.           Added update to ALRERCLO in NEWBEN00
. V10.03.11 31/07/2012  Peter Vela        CAR 267856
.           Added admissno tag in ABNR0000
. V10.03.10 04/06/2012  Don Nguyen        CAR 264682
.           Removed check on OVRCD after a write (WRALEMD1)
. V10.03.09 23/05/2012  Don Nguyen        CAR 264682
.           Added processing for other encounter details tags (AREF0000)
. V10.03.08 11.05.2012  Ebon Clements     CAR 264331
.           Added clear of referral and encounter file vars - BULKEN70
. V10.03.07 26.04.2012  Ebon Clements     CAR 261277
.           Populate first appointment booked on SOP int referral - FAPD0000
. V10.03.06 12.04.2012  Ebon Clements     CAR 261277
.           Auto activate master referral if internal is activated  - AMAS0000
. V10.03.05 19/01/2012  Nicole Torrisi   CAR 254742
.           Added MISC0000 for processing miscellaneous fields
. V10.03.04 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.03 20/12/2011  Ebon Clements   CAR 257419
.           Recompiled for IBAWEBCD - Hospital security redirect
. V10.03.02 20/12/2011  Ebon Clements   CAR 257419
.           Recompiled for IBAWEBCD - Hospital security redirect
. V10.03.01 17/11/2011  Mike Laming     CAR 240184
.           Changes to IBAPOSTF Post Code table - added State to Keys
. V10.02.08 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.07 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.06 29.08.2011  Saroeun Soeur     CAR 245255
.           added ABNR3400 - display indicators of visit types
. V10.02.05 22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PMSCURFD:
.                - PMCUSURN & PMCUGNAM extended to 40 chars.
.                - PMCUGNM2 added.
. V10.02.04 29/06/2011  Ebon Clements     CAR 243794
.           Recompiled for ALLREFFD - added referred to hospital
. V10.02.03 15/06/2011  J.Tan             CAR 239592
.           Mods to extra compensable file (pmxextaf)
. V10.02.02 03/05/2011  Ebon Clements     CAR 239576
.           Changed wording of encounter to contact in web errors
. V10.02.01 22/03/2011  Jill Parkinson    CAR 239574
.           Increased size of SCHDPRNT
.------------------------------------------------------------------------------
. V10.01.03 13/01/2011  Ebon Clements     CAR 236087
.           Recompiled for PATCLMTM - Defence force
. V10.01.02 05/01/2011  Davin Sloan       CAR 235668
.           Added read on pmi when adding tac encounters (tacenc00)
.           Added read on pmi when adding dva encounters (vetenc00)
.           Added read on pmi when adding wco encounters (wccenc00)
. V10.01.01 02/12/2010  Ebon Clements     CAR 234378
.           Fixed add of non ur activity invalid form action error - ALLNUR00
. V10.00.18 13/10/2010  Ebon Clements     CAR 231599
.           Fixed clinic id description - LINKT000
. V10.00.17 21/09/2010  Ebon Clements     CAR 227078
.           Clear enc service description if service code blank - WRSE0000
. V10.00.16 24/08/2010  Mike Laming       CAR 195158
.           Recompiled for PATMASTM - Legal Status Icon changes
. V10.00.15 23/08/2010  Steve Armstrong   CAR 228847
.           Recompiled for PATIN1IO
. V10.00.14 18/08/2010  Davin             CAR 223805
.           Recompiled for PATVISTM
. V10.00.13 06/08/2010 Saroeun Soeur     CAR 227373
.           added removeLink to RADM0000 subroutine at label RADM1100
. V10.00.12 30/07/2010 Ebon Clements     CAR 225859
.           Fixed display of presenting complaint for OP booking - LINKT000
. V10.00.11 15/07/2010 Ebon Clements     CAR 200158
.           Added ENCOUTK2 cgi
. V10.00.10 07/07/2010 Peter Vela        CAR 223954
.           Removed class=ListIcon from EVTR0000
. V10.00.09 06/07/2010 J.Tan             CAR 225191
.           Fixed I*D on prihtraf file
. V10.00.08 02/07/2010 Ebon Clements     CAR 200158
.           Added SHWUPDAT tag to ABRN3200
. V10.00.07 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.06 16/06/2010  Ebon Clements     CAR 223938
.           Fixed site prefix open of the clinic file
. V10.00.05 02/06/2010  Ebon Clements     CAR 187975
.           Added supervisor update enc date edit to CANENC00
. V10.00.04 27/05/2010  Ebon Clements     CAR 222241
.           Fixed border display on encounter list notes column - EVTR0000
. V10.00.03 25/05/2010  Mike Laming       CAR 169939
.           Added test for "Active" flag (Insurance Co.) at AREF0600
. V10.00.02 05/05/2010  Ebon Clements     CAR 220289
.           Added don't allow encounter on primary referrals test
. V10.00.01 25/03/2010  Ebon Clements     CAR 208232
.           Added ALSPQNTY and ALSPPRCE to CLRSUP00
.           02/02/2010  Steve Armstrong   CAR 135505
.           Added DGCLII12, DGCLII13 and DGCLICEU triggers
.           Also added HL7TRGID & HL7INCLD setting for all broadcast messages
.------------------------------------------------------------------------------
. V9.12.11  25/01/2010  Peter Vela    CAR 211798
.           Fixed referral time / encounter time validation in VALIDT00
. V9.12.10  08/01/2010  Ebon Clements CAR 206814
.           Added case team filter to ALGP0000 and ALDP0000
. V9.12.09  07/12/2009  Peter Vela    CAR 211798
.           Added referral time / encounter time validation in VALIDT00 
. V9.12.08  03/12/2009  Peter Vela    CAR 211557
.           Check for cancelled pre admissions / admissions @ RADM1000
. V9.12.07  12/10/2009  Ebon Clements CAR 194061
.           Added bulkenck to NXTGRP00 and PRVGRP00
. V9.12.06  01/10/2009  WeeLee Koo    CAR 202511
.           Changed Default ERC label printing from 6 to 2. (SELPAT30)
. V9.12.05  25/09/2009  Mike Laming   CAR 173274
.           Add Med, Intervention & Supply Icons to Encounter List in ALLENCTM
. V9.12.04  17/08/2009  Ebon Clements CAR 193151
.           NZ bulk encounter changes
. V9.12.03  11/08/2009  Saroeun Soeur CAR 186621
.           VALREF50 - added ALRECONT
. V9.12.02  28/07/2009  Ebon Clements CAR 200155
.           Fixed bulk encounter edits as the errors where behaving as warnings
.           BVLIDT00
. V9.12.01  01/07/2009  Ebon Clements CAR 200058
.           Fixed syntax error in WEBWAR20 redirect
. V9.11.10  22/04/2009  Saroeun Soeur CAR 194808
.           fixed  residential discharge date
. V9.11.09  07/04/2009  Peter Vela   CAR 183976
.           Move spaces to PMVXPILC before WRPMVX11
. V9.11.08  06/04/2009  Mike Laming  CAR 191906
.           Recompiled for ALLENCTD & ALLENCTM - Changed ALENC011/14 to DIM 6
. V9.11.07  26/02/2009 Ebon Clements CAR 190244
.           Added calls to SACR0000 - SACS/Primary referrral closure edits
. V9.11.06  25/02/2009 Ebon Clements CAR 187703
.           Added hospital security tests to department selection lists
.           ARFD0000
. V9.11.05  16/02/2009  Peter Vela     CAR 183976
.           Move spaces to PMVXPOEC before WRPMVX11
. V9.11.04  29/01/2009  Mike Laming    CAR 187626
.           Add "Occasion of Service" for NZ Bulk Episode List at BENC1030
. V9.11.03  16/01/2009  Ebon Clements  CAR 186256
.           Added department default from user id to report 4 and 5
. V9.11.02  31/10/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.01  16/10/2008  Peter Vela    CAR 179155
.           Recompiled for ALLITVTM
.           Recompiled for ALLEMDTM
.           Recompiled for ALLSUPTM
. V9.10.08  02/10/2008  Mike Laming   CAR 180113
.           Correct to List Encounters if Unsent or Sent at WRSE0010
. V9.10.07  22/09/2008  Mike Laming   CAR 152286
.           Remove extra "</tr>" in routine EVTR0030               
. V9.10.06  25/07/2008  Mike Laming   CAR 174378
.           Added indicator  INCOCATE (Calalog Code format)  and
.           re-compile for ALLSUPTM - Added tag for INCOCATE (Calalog Code type)
. V9.10.05  21/07/2008  Ebon Clements CAR 173815
.           Added clear of Enc file to dispay function - ALLREF00
. V9.10.04  03/07/2008  Ebon Clements CAR 172386
.           Populate cgi URNUMBER with ALREURNO if URNUMBER is blank in
.           report 14,15,16 and 17
. V9.10.03  02/07/2008  Ebon Clements CAR 172386
.           Added read of pmi details to report 14,15,16 and 17
. V9.10.02  15/05/2008  Mike Laming  CAR 152286
.           Recompiled for ALLREFTD & ALLREFTM - RCH Edu.Institute changes
. V9.10.01  05/05/2008  Ebon Clements CAR 167666
.           Added Z70 match to MAKREF00 cgi variable moves
. V9.09.15  22/04/2008  Mike Laming   CAR 152286
.           Added file ALLMDTFD/IO A/H Encounter Noted. Recompiled for ALLENCTM
.           Added Notes Icon to EOC List at EVTR0030
. V9.09.14  26/02/2008  Ebon Clements CAR 162584
.           Fixed double entry of encounters - ALLREF10 when using last enc
. V9.09.13  25/02/2008  Ebon Clements CAR 161998
.           Changed CANENC00 to process updates on all encounter fields
. V9.09.12  12/02/2008  J.Tan         CAR 135498
.           Mods for MHINC Extract
. V9.09.11  07/01/2008  Ebon Clements CAR 147229
.           Fixed can't add enc to cancelled referral error message
. V9.09.10  10/10/2007  J.Tan         CAR 135498
.           Mods to ignore deleted record status for NZ MHINC Extract
. V9.09.09  18/09/2007  Ebon Clements CAR 149442
.           Added billing functionality to bulk encounters - NEWBEN00
. V9.09.08  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
. V9.09.07  07/09/2007  Davin         CAR 149192
.           Display 'No more Encounters' at the bottom of nz encounter lists
. V9.09.06  04/09/2007  Ebon Clements CAR 149442
.           Computer generated billing was duplicating items - ALLBIL00
. V9.09.05  24/08/2007  Ebon Clements CAR 133923
.           Changed department selection lists to be in alphabetical order
. V9.09.04  21/08/2007  Ebon Clements  CAR 127820
.           Fixed cgi name for checkbx1 in SETPAR00
. V9.09.03  02/08/2007  Ebon Clements  CAR 139644
.           Added adsacflg cgi
. V9.09.02  23/07/2007  Ebon Clements  CAR 140983
.           Added ALCNACTW - Auto activate a single waiting referral
.           for the same department when closing a referral
. V9.09.01  11/07/2007  Ebon Clements  CAR 135536
.           Changed VALREF00 to not edit the department if VALDDEPT is blank
.           Added group contacts list by referral tag AREF1700
. V9.08.11  17/05/2007  Ebon Clements  CAR 140983
.           Added event program to the referral file 
. V9.08.10  14/05/2007 Ebon Clements   CAR  140438
.           Added bulk encounter key tag at AREF1600
. V9.08.09  18/04/2007  Ebon Clements  CAR 135532
.           Commented out append of AADMNO to redirect at WEBWAR20
. V9.08.08  17/04/2007  Ebon Clements  CAR 135532
.           Added LINKT000 - Linked outpatient visit tag
. V9.08.07  17/04/2007  Ebon Clements  CAR 135532
.           Added BENC000 - Bulk encounter list            
. V9.08.06  12/04/2007  Jill Habasque  CAR 135532
.           Added report option 17 - Supplies Maintenance  
. V9.08.05  05/04/2007  Jill Habasque  CAR 135535
.           Added report option 16 - Residential Admissions
. V9.08.04  27/03/2007  Jill Habasque  CAR 135532
.           Added report option 14 - Medication details
. V9.08.03  02/02/2007  Ebon Clements  CAR 132483
.           Added date edit check to VALIDT00 for rejected referrals
. V9.08.02  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.09.01  15/12/2006 Sandra Barcham      105328
.           Changed sort order for service type to description for allweb0304002
. V9.07.05  11/09/2006  Peter Vela     CAR 118226
.           Recompiled for PATCLMTM
. V9.07.04  16/08/2006  Ebon Clements  CAR 110311
.           Added case referral field to encounter file
. V9.07.03  15/08/2006  Ebon Clements  CAR 112175
.           Allow multi hospital A/H department with a blank hospital
. V9.07.02  02/08/2006  Ebon Clements  CAR 113925
.           Added case review date to the referral and encounter file
. V9.07.01  17/07/2006  Ebon Clements        CAR 112929
.           Changed length of KEYENCTR from 11 to 16
. V9.06.03  09/06/2006  Sandeep Chakravarthi CAR 105328 
.           Opened OUTCTYA4 for sorting based on Clinic type Description
. V9.06.02  31/05/2006  Sandeep Chakraavrthi
.           Opened ALLSERA2 for using index 2, to sort based on Description
. V9.06.01  12/05/2006  Ebon Clements CAR 105049
.           Added multi hospital test to ARFD0000 - department selection list
. V9.05.03  12/04/2006  Mike Laming   CAR 100944
.           Correct OVRCD coding at VALPUR00
. V9.05.02  31/03/2006  Ebon Clements CAR 78527
.           Added hospital to current patients
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B07 20/02/2006  Ebon Clements  76341
.           added referral and encounter file audits
. V9.05.B06 14/02/2006  Peter Vela CAR 83006
.           Fixed validation for ALDEREFE "Using Referrals" ENCNEW00
. V9.05.B05 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B04 25/01/2005 Ebon Clements CAR 76341
.           Added linked to SACS referral tag - AREF1200
. V9.05.B03 19/01/2005 Ebon Clements CAR 76341
.           Added Separate SACS episode for encounters
. V9.05.B02 17/01/2005 Ebon Clements CAR 76341
.           Added bulk encounter functionality for outpatients
. V9.05.B01 19/12/2005 Ebon Clements CAR 76341
.           Mods for encounter change from DIM 3 to DIM 8
. V9.04.12  03/10/2005  J.Tan    CAR 81410
.           Recompiled without patsusaf file
. V9.04.11  02/11/2005  Ebon Clements  CAR 76135
.           Changed ALENCOMT from 100 to 160 characters
. V9.04.10  27/10/2005  J.Tan          CAR 81410
.           Mods checking for parameter PRCNRDOC - Ref.doctor on transac.screen
. V9.04.09  07/09/2005  Ebon Clements  CAR 73702
.           Added active status check to d selection list ARFD0000
. V9.04.08  08/08/2005  Mike Laming   CAR 60242
.           Add REPs for XCDATE to eliminate embedded blanks
. V9.04.07  08.06.2005  J.Tan          CAR 56701
.           Added HIC item key to prihtraf file
. V9.04.06  23.05.2005  Ebon Clements  CAR 62018
.           Recompiled for ALLRITFD - Added provider usage
. V9.04.05  25/10/2004  Peter Vela    CAR 41539
.           Added tags for previous visit TAC Claim Details
. V9.04.04  31.01.2005  Guomin Fu      CAR 37051
.           Mods to allow users from the selected department to be able to
.           drill down to view and amend patient data. For details of security
.           setting for different scenario, refer to doc attached in touchpaper
. V9.04.03  22.11.2004  Ebon Clements  CAR 55239
.           Recompiled for ALLREFTM
.           09.11.2004  Peter Vela     CAR 53371
.           Recompiled for PATVISTM
. V9.04.02  31.08.2004  Ebon Clements  CAR 53089
.           Populate hospital id in referral and visit extn when
.           creating new referrals
. V9.04.01  18.08.2004  Lina Vo        CAR 52746
.           Added open of pathspaf and included PATHSPFD & IO for PATVISTM
. V9.03.17  26/07/2004  Ebon Clements CAR 50745                    
.           Write computer generated billing items to allitmaf
. V9.03.16  01/07/2004  Ebon Clements CAR 51243                    
.           Do not set the referral status to active when adding encounters     
.           unless the referral status is waiting
. V9.03.15  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.14  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.13  26/03/2004 Peter Vela     CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.12  02/04/2004 Ebon Clements  CAR 19985 46515
.           Added referral and encounter number to billing
.           Added the outpatient site code to the referral file
. V9.03.11  10/02/2004 Ebon Clements  CAR 47349
.           Recompiled for ALLERCFD - Changed ALERNDIM to ALERNDIG
. V9.03.10  11/12/2003 Peter Vela     CAR 40355
.           Recompiled for PATNAMCD
.           15/12/2003 Ebon Clements  CAR 45481
.           Mods for PMSCURFD file change - added outpatient site
. V9.03.09  30/09/2003 Ebon Clements  CAR 43674
.           Close files before opening in OPNOUT00
. V9.03.08  24/09/2003 Davin  CAR 40812
.           Changed to only send CED broadcast when EOC is cancelled
. V9.03.07  08/09/2003 Peter Vela  CAR 41918
.           Changed WRSE0000 encounter list to not loop back to start when 999
.           encounter limit has been reached.
.           Changed F3 -> F5, KEY3 -> KEY5
. V9.03.06  29/07/2003 Peter Vela  CAR 41918
.           Added No more visits message
. V9.03.05  22/07/2003 Ebon Clements  CAR 41658
.           Added an error message when the 999 encounter limit has been reached
.           Changed WRSE0000 encounter list to have Next and Prev buttons
. V9.03.04  14/07/2003 Davin          CAR 37388
.           Recompiled for changes to ALLERCTM
.           14/07/2003 Tracey Nguyen  CAR 40986
.           Recompiled for ALLREFTM.PBL
.           26/06/2003 Ebon Clements  CAR 39154
.           Removed suppress spaces in VALPHT00 remote script
.           17/06/2003 Tracey Nguyen  CAR 40299
.           Added RDPMPX21 after each RDMAST1
. V9.03.03  29/05/2003 Lina Vo        CAR 37504
.           Write SLA/ASGC code from ibapostf to visit extension table for
.           add referral for encounters.
. V9.03.02  20/05/2003 Ebon Clements  CAR 39014
.           Changed deceased error to a warning for encounters not using
.           referrals. (allweb0304002)
. V9.03.01  16/05/2003 Ebon Clements  CAR 39154
.           Changed VALPHT00 to not return spaces in ALERSTFF
.------------------------------------------------------------------------------
. V9.02.57  04/04/2003 Ebon Clements  SRF 37705
.           Changed NXTA0000 to read the vist file when generating visit numbers
. V9.02.56  11/03/2003 Lina Vo        SRF 37177
.           Changed deceased patient msg to warning only.
.           Set WINCLFLG=1 when REDIRECT is empty for WEBWAR00 for Bulk Patient
.           Encounter Input (allweb0305002).
. V9.02.55  28/01/2003 Tracey Nguyen  SRF 22693
.           Added PTCNUEOC
.           29/01/2003 Ebon Clements  SRF 35799
.           Mods to VALVIS00 to exclude referrals from valid linked visits
. V9.02.54  21/01/2003 Tonii  CAR 35428
.           Mods to the printing rule for ERC labels, program to only print
.           6 standard slides + Number of Transparencies
. V9.02.53  17/12/2002 J.Tan         
.           Mods TAC encounter with zero billing units 
. V9.02.52  05/12/2002 Lina Vo                        SRF 22709
.           Added CALL OPNOUT00 in INIT0000 and removed duplicate open of
.           outpatient files.
. V9.02.51  25/10/2002 Lina Vo                        SRF 23710
.           Recompile for ALLREFTM
. V9.02.50  03/10/2002 Peter Vela                     SRF 17693
.           Recompiled for PATVISTM - Admitting Point
. V9.02.49  17/09/2002 Ebon Clements                  SRF 20174 
.           Fixed clear of visit type description - PATNDESC in ABPENR00.
.           18/09/2002 Ebon Clements                  SRF 20189 
.           Changed HL7 messages for TAC/VET/WORK COVER EOC's to post when
.           the second EOC screen in updated not when the ECO is created 
. V9.02.48  03/09/2002 Pat Dirito                     SRF 21753 
.           Field FREETXT7 was not cleared.
. V9.02.47  25/07/2002 J.Tan                     
.           Mods to set claim number in prihre for TAC, work cover
. V9.02.46  19/07/2002 Ebon Clements SRF 19805
.           Fixed WRSE0000 limit reached error for call stack overflow   
. V9.02.45  16/07/2002 Ebon Clements SRF 19530
.           Fixed PHOT0000 to search for multiple encounters per referral
. V9.02.44  11/07/2002 Ebon Clements SRF 19530
.           Added new book out photo report number
. V9.02.43  02/07/2002 Jill Habasque SRF 18879 19273
.           Added check for PTCNCPAH - write to current patient search
. V9.02.42  28/06/2002 Ebon Clements SRF 19105
.           Recompiled for sigpipe trap
. V9.02.41  17/06/2002 Ebon Clements SRF 18675   
.           Changed WRSE0000 to display encouters by date range
. V9.02.40  06/06/2002 Ebon Clements SRF 18401   
.           Fixed keys in ALIT0000 for I * D 
.           Delete all records in allitmaf when an encounter is deleted DELENC00
. V9.02.39  28/05/2002 Ebon Clements SRF 18065   
.           Added error to ENCNEW00 if the encounter date is before the 
.           referral date
. V9.02.38  27/05/2002 Ebon Clements SRF 17796
.           Added edit check to allow encounters not using referrals to be added
.           to a deceased patient before the date of death
.           Changed MAKREF00 to make to visit date the encounter date
. V9.02.37  24/05/2002 Jill Habasque
.           Added branch on exit after calling WEBHED00
. V9.02.36  18/05/2002 Ebon Clements 17796
.           Added edit checks to allow encounters to be added
.           to a deceased patient before the date of death
. V9.02.35  14/05/2002 Ebon Clements 17468
.           Removed checks for label types in SELPAT00 so ERC and CAR labels
.           can be printed for all ERC encounters
. V9.02.34  30/04/2002 J.Tan         
.           Mods to update accident date to prihdbaf file
. V9.02.33  16/04/2002 Ebon Clements 
.           Pack key with PRIHTRFD variables in ALLTUP00 to fix I * D    
.           Added deptcode to linkur in WRSE0000 encounter list
.           Added ALREURNO as a return variable in VALREF00
. V9.02.32  03/04/2002 Ebon Clements 
.           Added outpatient events to GETALL00 for default linked visit
. V9.02.31  20/03/2002 J.Tan
.           Added bulk billing claim number
.           Added surname to mother and father responsiblity name
. V9.02.30  13/03/2002 Ebon Clements         
.           Recompiled for ALLREFTM - selection list orders               
. V9.02.29  05/03/2002 Jill Habasque  3266
.           Changed to only write to pmscuraf if it is the current date  
. V9.02.28  19/02/2002 Ebon Clements 
.           Added JAVNAM00 to referral number search                     
. V9.02.27  13/02/2002 Ebon Clements 
.           Fixed I * D in allitmaf                                      
. V9.02.26  10/02/2002 Ebon Clements 
.           Mods to display for security                                      
. V9.02.25  08/02/2002 Ebon Clements 
.           Pack variables in ALLTUP00 to correct length before read and write
.           to PRIHTRFD
. V9.02.24  06/02/2002 Ebon Clements 
.           Set value of ALREDEPT from deptcode cgi for template map
. V9.02.23  02/02/2002 Ebon Clements 
.           Recompiled for ALLENCTM - display inactive services
. V9.02.22  24/01/2002 J.Habasque   
.           Mods to write of current patient file
. V9.02.21  16/01/2002 J.Tan        
.           Mods to check for the usual PRFA 
. V9.02.20  24/12/2001 Ebon Clements
.           Recompiled for ALLENCTM to display items on update Encounter screen
. V9.02.19  21/12/2001 Jill Habasque
.           Added write to the current patient table
. V9.02.18  14/12/2001 Ebon Clements
.           Set AGEDATE before calcage is called
. V9.02.17  04/12/2001 Ebon Clements
.           Mods to allied health billing
. V9.02.16  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.15  28.11.2001  Ebon Clements                                  *
.           Changed webtitle for report 5
. V9.02.14  20.11.2001  B.G.Ackland                                    *
.           Remove pi's from Program
. V9.02.13  13/11/2001 Ebon Clements             
.           Recompiled for ALLREFTM - job number ALREUNO2           
. V9.02.12  09/11/2001 Ebon Clements             
.           Fixed selection list for clinic type for report 5       
. V9.02.11  05/11/2001 Ebon Clements             
.           Fixed description for type on bulk entry list display  
.           Add remote scripting for visit number validation
.           Added patient name to referral search list
. V9.02.10  22/10/2001 Ebon Clements             
.           Recompiled for ALLENCTM for fix to service type length
. V9.02.09  09/10/2001 Ebon Clements             
.           Fixed equipment display details
. V9.02.08  02/10/2001 Ebon Clements             
.           Added ALLITMFD for rch to have 10 items on billing for encounters
. V9.02.07  21/09/2001 Ebon Clements             
.           Added return of the linked visit number with the referral search
. V9.02.06  14/09/2001 Mike Laming  RCH/SVHM    
.           Activate new Datagate APIs (see below)       
. V9.02.05  13/09/2001 Ebon Clements            
.           Added department filter to bulk entry screens
. V9.02.04  10/09/2001 Ebon Clements            
.           Fixed output tags for encounters                                  
. V9.02.03  08/09/2001 Ebon Clements            
.           Fixed output tag for department description                       
. V9.02.02  29/08/2001 Mike Laming   RCH/SVHM
.           Add Datagate APIs for Create & Delete Allied Health Encounters
.           DGCLICEA and DGCLICED                                         
. V9.02.01  22.08.2001 Ebon Clements
.           Fixed clinic type selection list
. V9.01.01  14.08.2001 Ebon Clements
.           Fixed close encounter when last encounter is selected
. V9.00.04  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.03  13/08/2001 Ebon Clements
.           Recompiled for ALLREFTM and report mods            
. V9.00.02  13/08/2001 Ebon Clements
.           Added code to print CAR Lables
. V9.00.01  08/08/2001 Ebon Clements
.           Added code to maintain the ERC labels file for encounters and print
. V9.00.B10 25.07.2001 HPS
.            Modification in Tag  
. V9.00.B09 24.07.2001 HPS
.           Defect 90 R1 fix
. V9.00.B08 24.07.2001 HPS
.	    Recompiled for PMSHCPTM file
. V9.00.B07 19.07.2001 HPS
.           Defect no.s (45, 72, 87, 109, 110)
. V9.00.B06 18.07.2001 HPS
.           Defect no.s (28 59 61 90)
. V9.00.B05 15.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B01 28/5/2001 HPS
.                  Created Program
.*******************************************************************************
          INC       IBAWEBDF
          INC       TFILEVAR/INC
.
          INC       ABFVARS/INC
          INC       ACCDIAFD/INC            * AE Diagnosis
          INC       ALLAEFFD/INC
          INC       ALLCONFD/INC            * Control-f                *I-90202
          INC       ALLCASFD/INC
          INC       ALLCCTFD/INC            * Department Contract Codes
          INC       ALLLNKFD/INC
          INC       ALLREFFD/INC            * referral table
          INC       ALLRITFD/INC                                       *I-41539
          INC       ALLRSAFD/INC                                       *I-41539
          INC       ALLRLNFD/INC
          INC       ALLAUDFD/INC            * audit table
          INC       ALLDEPFD/INC            * department table
          INC       ALLDIAFD/INC
          INC       ALLGPAFD/INC
          INC       ALLGREFD/INC
          INC       ALLGROFD/INC
          INC       ALLLINFD/INC            * clinical documentation link table
          INC       ALLPROFD/INC
          INC       ALLPRRFD/INC            * department  problem table
          INC       ALLSERFD/INC            * department service table
          INC       ALLSTSFD/INC
          INC       ALLTMPFD/INC            * Template table
          INC       APSMASFD/INC            * <SB-CHANGES17.07.2001>
          INC       EMRICDFD/INC            * AE Diagnosis Codes
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       OUTCANFD/INC            * Cancelled booking table
          INC       OUTCTYFD/INC            * Clinic type table
          INC       OUTBOAFD/INC            * Outpatient booking table a
          INC       OUTBB1FD/INC            * Outpatient booking table b
          INC       OUTPREFD/INC            * Outpatient pre attendance
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       OUTMA1FD/INC
          INC       PATABFFD/INC
          INC       PATASFFD/INC
          INC       PATCONFD/INC            * Control file
          INC       PATCMCFD/INC
          INC       PATDO1FD/INC            * patient doctor table
          INC       PATEORFD/INC            * External organisation table
          INC       PATHSPFD/INC            * patient hospital table
          INC       PATITMFD/INC
          INC       PATMA1FD/INC            * patient master
          INC       PATMISTD/INC
          INC       PATNIDFD/INC
          INC       PATVISFD/INC            * patient visit table
          INC       PMSHCGFD/INC            * used in ALLREFTM.PBL
          INC       PMSHCPFD/INC            * HCP table
          INC       PMSVX1FD/INC            * visit extesion table
          INC       PMSCURFD/INC            * current patient table
          INC       ALLQUEFD/INC
          INC       ALLREFTD/INC            * For ALLREFTM.PBL
          INC       IBALPCFD/INC
          INC       IBAPOSFD/INC
          INC       ALLITMFD/INC            * Allied Health Item file
          INC       PMSADWFD/INC
          INC       PMSEVTFD/INC            * Event File
.******************************************************************************
.*                    Files Included for PATMASTM.PBL starts here             *
.******************************************************************************
          INC       PATCALAG/INC
          INC       OUTCLIFD/INC                                       *I-41539
          INC       OUTSITFD/INC            * outpatient site table
          INC       PATALRFD/INC
          INC       PATDADFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATMI1FD/INC
          INC       PATPR1FD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       MLTSECFD/INC
          INC       MLTSITFD/INC
          INC       MRTMASFD/INC
          INC       PATDHEAD/INC
          INC       ALLERCFD/INC            * ERC Table
          INC       ALLENCFD/INC            * encounter details file
          INC       ALLEMDFD/INC            * medication details file
          INC       ALLMEDFD/INC            * medication details file
          INC       ALLMDTFD/INC            * a/h encounter notes     
          INC       ALLEMDTD/INC
          INC       ALLITVFD/INC            * intervention details file
          INC       ALLSUPFD/INC            * supplies details file
          INC       ALLINCFD/INC            * intervention details file
          INC       ALLITVTD/INC
          INC       ALLSUPTD/INC
          INC       ALLENCTD/INC            * for ALLENCTM.PBL
          INC       ALLBILFD/INC            * billing table
          INC       ALLWLNFD/INC
          INC       OBSPCOFD/INC            * Clinic Notes table
          INC       PATIN1FD/INC            * patient insurance table
          INC       PATDGWFD/INC
          INC       PMSENCTD/INC
          INC       PMSENCFD/INC
          INC       PMSEXTFD/INC
          INC       PMSEXTTD/INC
          INC       PRIHDBFD/INC            * private practice holding header
          INC       PRIHREFD/INC            * private practice holding doctor
          INC       PRIBULFD/INC            * private practice bulk billing
          INC       PRIINVFD/INC            * private practice invoice
          INC       PRIHTRFD/INC            * private practice holding
          INC       PRIITMFD/INC            * private practice item table
          INC       PRIMABFD/INC            * private parctice vehicle accident
          INC       PRIVAFFD/INC            * private practice veteran affairs
          INC       PRIWCOFD/INC            * private practice work cover tbl
          INC       PMSVX1TD/INC
          INC       ALLACTTD/INC            * for Non-U/R activity tm
          INC       ALLERCTD/INC
          INC       ALLACTFD/INC            * Non-U/R activity table
          INC       PATRE1FD/INC            * Person Responsible For Account
          INC       PRICONFD/INC
          INC       WEBDATDF
          INC       PATDSCFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
.
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSQPTFD/INC
.<SB-CHANGES17.07.2001>
.          INC       PMSHCGFD/INC            * used in ALLREFTM.PBL
          INC       PMSHCLFD/INC
.          INC       PMSHCPFD/INC            * HCP table
          INC       PMSHCGTD/INC            * used in ALLREFTM.PBL
          INC       PMSHCLTD/INC
          INC       PMSHCPTD/INC            * HCP table
.         INC       PATGPCFD/INC
.         INC       PATGPPFD/INC
.<SB-CHANGES17.07.2001>
.
          INC       PATWMAFD/INC            * TAC Claim Details I-41539
          INC       PATWC1FD/INC
          INC       PATWVEFD/INC
          INC       PMSWX1FD/INC
          INC       PMSCTCFD/INC
          INC       PMSCCDFD/INC            * Concession Card Details
          INC       SINCIAFD/INC
          INC       PATVADFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       WATTR1FD/INC
.
.******************************************************************************
.*                      CGI Parameters                                        *
.******************************************************************************
ACCPORDN  DIM       20
AUDITKEY  DIM       24                      * Audit Key
ADSACFLG  DIM       1
ALRSA001  DIM       8
ALRSA002  DIM       8
ATYPDESC  DIM       25
ALLDEPD3  DIM       3
.------ *T0865480-start
AUTOCPRF  FORM      1             * Auto Copy/Close Referral
.                                   1 = Copy Primary ref to linked ref
.                                   2 = Close Primary ref from linked ref
.------ *T0865480-end

BOOKSTAT  DIM       9
BULKEEND  FORM      2                       * Bulk encounter referral count
BULKEKEY  DIM       16[45]                  * Bulk encounter referral numbers
BULKENCK  DIM       16
CANCFLAG  FORM      1
CATCG     INIT      "CG"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATTS     INIT      "ts"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATGY     INIT      "gy"
CATD1     INIT      "D1"
CHECKREF  DIM       8                       * Auto activate internal referral
CATZA     INIT      "za"
CATgb     INIT      "gb"
CISMFLAG  FORM      1                       * for HL7 messaging
CMDLINE   DIM       127
COUNT     FORM      3
COUNTBOK  FORM      2
DBOOKED   INIT     "Booked"
DUBOOKED  INIT     "UnBooked"
DATTEND   INIT     "Attended"
DNOATTN   INIT     "DNA"
ENKYDM16  DIM       16
ENCTREDR  DIM       1
FORM3     FORM      3
IBAMFLAG  FORM      1                       * for HL7 messaging
NEXTPAGE  DIM       1                       * Nextpage parameter CGI parameter
NZLAYOUT  FORM      1
UNITDESC  DIM       20
UPDATETY  DIM       1                       * Update Type
UPDITEMS  FORM      1                       * Items received from the page
CONTRCID  DIM       6
CANCEL    DIM       1                       * Cancel Value
DISCDATE  DIM       12
DISPOUTC  DIM       20
DISPUC01  DIM       20
ENCOUTKY  DIM       16                      * Encounter Key
ENCOUTK2  DIM       16                      * Encounter Key
FILTTEAM  DIM       10                      * HCP Case team code filter
TRNSFSRC  DIM       5        * Transfer Source Code (patdadaf)
.
GRPFILNM  DIM       8
GRPFILKY  INIT      " 33 UC1-8,9-16,17-24,25-32"
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
.
.---------------------------------------------------------------------
.  Group booking print order temp file
.---------------------------------------------------------------------
TEMPGRP1  IFILE     SQL, FIXED=33, KEY="U1-8,9-16,17-24,25-32"
.
.NAME     TYPE     LENGTH  PHYSICAL START DESCRIPTION
.----     ----     ------  -------- ----- -----------
XXXXGDTE  DIM       8      8        1     Group Contact Date (CCYYMMDD)
XXXXGTIM  DIM       8      8        9     Group Contact Time (HH:MM:SS)
XXXXREFN  DIM       8      8        17    Referral Number (allrefaf)
XXXXCONT  DIM       8      8        25    Contact Number
.
.                  end of record   33
.
NMPNUMB   DIM       20
MASTREFN  DIM       8                       * Master referral number
MBSDESC   DIM       40
MESSAGID  DIM       20
MIN       DIM       2
MINUTES   FORM      3
MINTIME   FORM      2
HOUR      FORM      2
TIME      FORM      3
PRIMARYE  DIM       1                       * Allow enc in primary ref
PRVAF001  DIM       20                      * Claim Number
DEPTCODE  DIM       3                       * Allied Health Department Code (CG)
DEPLDESC  DIM       50
SAVADMNO  DIM       8
SAVCKBX2  DIM       1                       * Save checkbx 2
SAVEDEPT  DIM       3                      
SAVEURNO  DIM       8
SAVEVISN  DIM       8
SAVIADAT  DIM       8                       * Save internal ref date active
SAVVPRTY  DIM       3
SAVVREFN  DIM       8
SAVVTRGS  DIM       3
SHWUPDAT  FORM      1
SINGENC   DIM       1                       * Single encounter flag
SRCHDEPT  DIM       3                       * Search Department Code (CG)
SUPRDATE  DIM       1                       * Supervisor date update
VALDDEPT  DIM       3                       * Search Department Code (CG)
VINAHREF  DIM       8
DOCTCODE  DIM       10                      * Doctor Code
DOCFNAM3  DIM       50
DOCFNAM4  DIM       50
DOCFNAM5  DIM       50
DOCFNAM6  DIM       50
DOCINDIC  DIM       1
DEFEDATE  DIM       8
DEFETIME  DIM       8
DEFEDOCT  DIM       6
ENDRMNTH  FORM      6
FILTRHCP  FORM      1
FORM6     FORM      6
FORM8     FORM      8
FORM10P4  FORM      10.4
FORM12P2  FORM      12.2
FRMDATE   DIM       8
ITEMNUMB  DIM       9                       * Item Number
ITEMN001  DIM       9                       * Item Number 1
ITEMN002  DIM       9                       * Item Number 2
ITEMN003  DIM       9                       * Item Number 3
ITEMN004  DIM       9                       * Item Number 4
ITEMN005  DIM       9                       * Item Number 5
ITEMN006  DIM       9                       * Item Number 6
ITEMN007  DIM       9                       * Item Number 7
ITEMN008  DIM       9                       * Item Number 8
ITEMN009  DIM       9                       * Item Number 9
ITEMN010  DIM       9                       * Item Number 10
VISITNO   DIM       8                       * Visit Number
IVAL      DIM       3                       * Iteration Value
ALLACTKY  DIM       29                      * allact key
NONVINAH  DIM       1                       * Non-VINAH referrals only? 1=YES
OUTADMIS  DIM       8                       * outpatient visit number
OUTBB035  DIM       3                       * Outcome    (CAT OZ) 
PRMAB001  DIM       20                      * M.A.B. Reference Number
PRMAB002  DIM       20                      * Police StationAccident Reported To
PRMAB003  DIM       30                      * Solictor Name
PRMAB004  DIM       25                      * Solicitor address line 1
PRMAB005  DIM       25                      * Solicitor address line 2
PRMAB006  DIM       25                      * Solicitor address line 3
PRMAB007  DIM       4                       * Solicitor postcode
PRMAB008  DIM       12                      * Solicitor Telephone
PRMAB009  DIM       36                      * Car Registration Numbers Involved
PRMAB010  DIM       40                      * Accident Location
PRMAB011  DIM       5                       * Accident Time
PRMAB012  DIM       20                      * While Engaged In
PRMAB013  DIM       30                      * Patient Injured When
PRMAB014  DIM       3                       * User Defined Field 1 (Category MO)
PRMAB015  DIM       3                       * User Defined Field 2 (Category MP)
PRMAB016  DIM       30                      * Mechanism of Severist Injury
PRMAB017  DIM       20                      * Region of Severist Injury
PRMAB018  DIM       30                      * Other Driver Details Line 1
PRMAB019  DIM       30                      * Other Driver Details Line 2
PRMAB020  DIM       30                      * Other Driver Details Line 3
CFILEPRE  DIM       3                       * Open File Prefix forOutpatnt Files
CHECKBX1  DIM       1                       * Stay on Waiting List 
CHECKBX2  DIM       1                       * Last Encounter  
PRWCO001  DIM       30                      * Employer Name
PRWCO002  DIM       25                      * Employer Address Line 1
PRWCO003  DIM       25                      * Employer Address Line 2
PRWCO004  DIM       25                      * Employer Address Line 3
PRWCO005  DIM       4                       * Employer Postcode
PRWCO006  DIM       12                      * Employer Telephone
PRWCO007  FORM      1                       * Accepted By Insurance(1=No,0=Yes)
PRWCO008  DIM       6                       * Insurance Company Code
PRWCO009  DIM       20                      * Insurance Claim Number
PRWCO010  DIM       5                       * Accident time
PRWCO011  DIM       40                      * Comments Line 1
PRWCO012  DIM       40                      * Comments Line 2
ACCIDENT  DIM       8                       * Accident Date
SITECODE  DIM       6
STARTKEY  DIM       8                       * Starting Key
SKEY26    DIM       26
SELECTYP  FORM      1                       * Print Normal or CAR ERC Labels
DESCLOCN  DIM       20
DESCSTAT  DIM       20
DESCSEST  DIM       20
DTYPEDES  DIM       25
.
DOCTNAME  DIM       30                      * Doct name
DEFDOCNM  DIM       30                      * Doct name
DIM3      DIM       3                       * Store department code
DIM20     DIM       20
.
EPAUDFLG  FORM      1             * Episode audit flag
.                                    0 = no audits written
.                                    1 = before audit written
.
PHOTONUM  DIM       8                       * ERC Labels Photo Number
PHOTONFR  DIM       8                       * ERC Labels Photo Number From
PHOTONTO  DIM       8                       * ERC Labels Photo Numbr To
VALDCODE  DIM       70                      * Validation Code
VALDURNO  DIM       8                       * Validation U/R Number
VALDDATE  DIM       8                       * Validation Date 
VINAHFLG  FORM      1             * VINAH Flag
.                                   0 = writing audits in VINAHDEF
.                                   1 = not writing audits in VINAHDEF
RETURNFM  FORM      1                       * Return Format 0=Default
RIAUDFLG  FORM      1             * Referral In audit flag
.                                    0 = no audits written
.                                    1 = before audit written
.
.******************************************************************************
.*                       Program Variables                                    *
.******************************************************************************
ADDCNDAT  DIM       8
CONTDESC  DIM       20         * Contract Description
INCOCATE  FORM      1          * Catalog Code Format used for 'sinciaaf'
INVPFLAG  FORM      1          * Reset invoice printed flag indicator
WEBWARNG  DIM       70[99]
WARCOUNT  FORM      2
WAITST01  INIT      "Unscheduled  "
WAITST02  INIT      "Scheduled    "
WAITST03  INIT      "Pre-Admitted "
WAITST04  INIT      "Admitted     "
WAITST05  INIT      "Discharged   "
WAITST06  INIT      "Removed      "
WAITST07  INIT      "Performed    "
WAITST08  INIT      "Not Performed"
WAITST09  INIT      "Cancelled Booking"
DISPDATE  DIM       11         * Display date
DISPDAT1  DIM       11         * Display date
DISPDAT2  DIM       11         * Display date
VTYPFLAG  FORM      1          * Last Visit Type Required 1=Discharged Inpatient
FMTYRS    INIT      " yrs"
FMTMTHS   INIT      " mths"
FMTWKS    INIT      " wks"
FMTDAYS   INIT      " days"
FMTAGE    DIM       10
FMTSEX    DIM       8
JAVGNAME  DIM       25
JAVFNAME  DIM       70
JAVSNAME  DIM       20
ENDNAME   DIM       70
STRTNAME  DIM       70
DOBDATE   DIM       11
LASTVTYP  DIM       15
LASTVDAT  DIM       11
LASTVIST  DIM       8
LINKEDOP  DIM       8                       * Encounters linked OP visit number
LINKOPCT  DIM       5                       * Save linked OP visit check in time
LINKVTYP  DIM       3                       * Linked visit type
LINKSKEY  DIM       25                      * Linked session key
LOOPCNTR  FORM      3
TODAYVST  DIM       8
VT1       INIT      "Emergency"
VT2       INIT      "Outpatient"
VT3       INIT      "Inpatient"
VT4       INIT      "Other Financial"
VT5       INIT      "Day Centre"
VT6       INIT      "Community"
VT7       INIT      "Ward Attendee"
VT8       INIT      "Adhoc Attendee"
VT91      INIT      "Events Coding"
VT92      INIT      "Allied Health"
ERCYEAR   DIM       2                       * ERC Labels year
ERCNUMB   DIM       6                       * ERC Photo number
CURRDATE  DIM       8                       * Todays Date
CLOSEDTE  DIM       8                       * Calculated Closure Date
CLOSETME  DIM       5                       * Calculated Closure Time
CLOSTIME  DIM       8                       * Calculated Closure Time
ADJTIME   FORM      5
CSEC      DIM       2                       
DISENDAT  DIM       10                                               *C-0844584
FORM4B    FORM      4                       * used in time calculations
TOTALREC  FORM      4                       * counter for billing table
ULRESTAT  FORM      1                       * status
NLENENCT  FORM      3                       * encounter number
NLERPHOT  FORM      8                       * photo number
URNOTEMP  DIM       8                       * temparery U/R number
URTEMP    DIM       1                       * Temperory UR No Test code
TOTALTIM  FORM      4                       * total time of encounter
UNIQID    DIM       8                       * unique ID
UDBILL    FORM      6                       * direct billable units
UIBILL    FORM      6                       * indirect billable units
ULSRLENG  FORM      2                       * miniutes per unit
BKEY      DIM       16                      * Key for billing
NUMBITEM  DIM       9                       * item number
NTRANNUM  FORM      3                       * transaction number
ITEMDESC  DIM       30                      * item description
NLBITIME  FORM      4                       * time range to
BILLFLAG  DIM       1                       * billing flag
KEYENCTR  DIM       16                      * Key for encounter
ENCTR     INIT      "Encounter"             * encounter
CATGCODE  DIM       2                       * Category Code
ADMSLAST  DIM       8                       * Additional Admission Value
FRDATEDY  FORM      6                       * Days betweenFrom and current date
TODATEDY  FORM      6                       * Days betweenTo date& current date
DEPTDESC  DIM       20                      * Department Description
LOCNDESC  DIM       20                      * Location of Service Description
SHOWFLAG  FORM      1                       * I CAR 41918 Flag for no more vis
STRIKETG  DIM       10                      * Strike tag
STRENDTG  DIM       11                      * Strike end tag
ALLACTKE  DIM       21                      * pack of deptcode,doctcode,date
DEPDESC   DIM       20                      * Department Description
COUNTER   FORM      3                       * Counter For Dynamic Table
ALENCOMT  DIM       160                     * Encounter Comments
LOSERDES  DIM       20                      * Location Of Service
ESTATUS   DIM       6                       * Record Status
DIRUNTS   DIM       6                       * Direct Units
INDRUNTS  DIM       6                       * Indirect Units
DRBLUNTS  DIM       6                       * Direct Billable Units
INDBLUNTS DIM       6                       * Indirect Billable Units
RECFNFLG  INIT      "ZERO"                  * Record Status Flag
PATNTYPE  DIM       2                       * Patient Category Code
PATNDESC  DIM       20                      * Patient Type Desc
LOCNTYPE  DIM       2                       * Location Category Code
ENCTCOMM  DIM       120                     * Encounter Comments
DEFHCPNM  DIM       50                      * HCP Description
OVERRIDE  FORM      1                       * Override Warning Message
.
RACTVFLG  FORM      1
REFSTAT   DIM       10                      * referral status
RELINK    FORM      1
STATDESC  DIM       7
STATDES2  DIM       20
STRTNUM5  FORM      5                       * I CAR 41918
.
SCHDCOPY  FORM      3       * No of Copies
SCHDPRNT  DIM       6       * Printer No
SUBSYSKY  DIM       50
LABELTYP  DIM       11
STATNCOD  DIM       6
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
FRSTREAD  FORM      1
SERVFLAG  FORM      1                       * Flag for service type list
DUPCOUNT  FORM      1                                           *C-0844584-start
SVENCTNO  DIM       8                                                      
SVHCPD10  DIM       10                                               
SVVISND8  DIM       8                                           *C-0844584-end
UPDTTYPE  DIM       2
WAHEALTH  FORM      1
WINCLFLG  FORM      1                       * Flag for window close      
VISITTYP  DIM       3
NDISVALD  DIM       1
TMPURNMB  DIM       8
XFORMAT   FORM      1
.------ *T0865480-start
MULTILRF  FORM      1             * Multi Linked Referral found flag
SAVPRIRF  DIM       8             * Saved Primary referral
.------ *T0865480-end
RECNUMAL  FORM      5
SRTNUMBL  FORM      5

.******************************************************************************
PRGID     INIT      "ALLWEB03"                                                
VERSION   INIT      "V12.00.05"
PRGNAM    INIT      "Allied Health Encounter Information Server"              
.******************************************************************************
          CALL      WEBINT00                * Initialise FIFO Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      WEBRED00                * Read FIFO WEBPID and USERID
          COMPARE   "999",REPORTNO          * ReadSvrProcess onReport Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      GETMAP00                * Get Template Mapping
          CALL      OUTFIL00                * Ck Correct Files Open & Valid Site
          BRANCH    EXIT,MAIN1000
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00                * Create Output&Write HTMLFileHeader
          GOTO      MAIN1000
.
MAIN1100  CALL      ALLREF00                *  for patient with referral
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      ALLNRF00                * for patient with no referral
          BRANCH    EXIT,MAIN1000
          MATCH     "0",NEXTPAGE
          IF        @EQUAL
            CALL      WINPAR00
          ELSE
            MOVE      ONE,WINCLFLG          * Display warning messages
            CALL      WEBWAR00
          ENDIF
          GOTO      MAIN1000
.
MAIN1300  CALL      ALLNUR00                * for Non U/R activities
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      ALLBNR00                * for bulk encounters no referral
          BRANCH    EXIT,MAIN1000
          MATCH     "0",NEXTPAGE
          IF        @EQUAL
            CALL      WINPAR00
          ELSE
            CALL      WINCLS00
          ENDIF
          GOTO      MAIN1000
.
MAIN1500  CALL      ALLBRF00                * for bulk encounters with referral
          BRANCH    EXIT,MAIN1000
          MATCH     "0",NEXTPAGE
          IF        @EQUAL
            CALL      WINPAR00
          ELSE
            CALL      WINCLS00
          ENDIF
          GOTO      MAIN1000
.
MAIN1600  CALL      SELPAT00                * Select ERC Labels patient 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  MOVE      ZERO,VTYPFLAG
          CALL      VALPUR00
          GOTO      MAIN1000
.
MAIN1800  CALL      ALLARF00                * All Encounters By Dept or HCP
          BRANCH    EXIT,MAIN1000
          MATCH     "0",NEXTPAGE
          IF        @EQUAL
            CALL      WINPAR00
          ELSE
            CALL      WINCLS00
          ENDIF
          GOTO      MAIN1000
.
MAIN1900  CALL      VALREF00
          GOTO      MAIN1000
.
MAIN2000  CALL      VALVIS00
          GOTO      MAIN1000
.
MAIN2100  CALL      VALPHT00
          GOTO      MAIN1000
.
MAIN2200  CALL      UPDCAR00                * Update label sent data
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      BULKEN00                * Bulk Encounters
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      ALLMED00                * Medication for encounters
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      ALLINT00                * Interventions for encounters
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2600  CALL      ALLRAD00                * Residential Adms for referrals
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2700  CALL      ALLSUP00                * Supplies for encounters
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2800  CALL      IPCONT00                * Inpatient Contacts
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.*****************************************************************************
.*        Close Window or Frame and Goto New Location                         *
.******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>";
          CALL      CLOSHTML
.
WINPAR99  RETURN
.
.******************************************************************************
.*                      Check Correct Files are Open for System               *
.******************************************************************************
OUTFIL00  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE        * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Outpatient Files
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.******************************************************************************
.*                       Open Outpateint Files                                *
.******************************************************************************
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCTYA1
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME         * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA2
          CLOSE     OUTCTYA2
          OPEN      OUTCTYA2,CFNAME         * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA3
          CLOSE     OUTCTYA3
          OPEN      OUTCTYA3,CFNAME         * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA4
          CLOSE     OUTCTYA4
          OPEN      OUTCTYA4,CFNAME         * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME         * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME         * Open the file
.
          CLOSE     OUTBOKA1
          PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          OPEN      OUTBOKA1,CFNAME
.
          CLOSE     OUTBOKA6
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          OPEN      OUTBOKA6,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCANA1  * Get the name of the CANA1 file
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1  * Get the name of the MA1A1 file
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME           * Open the file
.
          GOTO      OPNOUT99
.
OPNOUT99  RETURN
.******************************************************************************
.*                       Output Next Page Based on CGI Parameter nextpage      *
.******************************************************************************
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00                * Redirect Page
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00                * Go Back 1 Html page

          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000                * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00                * Redirect Content Page
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINPAR00                * Redirect DFrame
          GOTO      NXTPAG99
.
NXTPAG60  CALL      TOPDIR00                * Redirect Top Content Page
          GOTO      NXTPAG99
.
NXTPAG70  CALL      PPREDI00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.*****************************************************************************
. Redirect Content URL 
.*****************************************************************************
TOPDIR00  CALL      OPENHTML
          BRANCH    EXIT,TOPDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " redirectTopContent(#"",REDIRECT,"#");":
                             "</script>"

          CALL      CLOSHTML
.
          GOTO      TOPDIR99
.
TOPDIR90  DISPLAY   "*** Fifo Not Found ***"
.
TOPDIR99  RETURN
.******************************************************************************
.*                      Redirect Content URL                                  *
.******************************************************************************
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                              " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.******************************************************************************
.*                      Goes back 1 page                                      *
.******************************************************************************
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "          alert(#"",WEBTITLE,"#");":
                             "          self.close();":
                             "          opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
.
GOBACK99  RETURN
.******************************************************************************
.*                      Open Files and Initialise variables                   *
.******************************************************************************
INIT0000  CALL      INTMAS00
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      ALLTMPA1,"alltmpaf"            * for template mapping
          OPEN      ALLAUDA1,"allaudaf"
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      ALLLNKA3,"alllnkaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLENCA2,"allencaf"
          OPEN      ALLENCA4,"allencaf"
          OPEN      ALLENCA5,"allencaf"
          OPEN      ALLENCA6,"allencaf"
          OPEN      ALLEMDA1,"allemdaf"
          OPEN      ALLITVA1,"allitvaf"
          OPEN      ALLSUPA1,"allsupaf"
          OPEN      ALLINCA1,"allincaf"
          OPEN      ALLERCA1,"allercaf"
          OPEN      ALLERCA2,"allercaf"
          OPEN      ALLMEDA1,"allmedaf"
          OPEN      ALLMDTA1,"allmdtaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLRITA1,"allritaf"                                *I-41539
          OPEN      ALLRSAA1,"allrsaaf"                                *I-41539
          OPEN      ALLDEPA1,"alldepaf"
          OPEN      ALLLINA1,"alllinaf"
          OPEN      ALLPRRA1,"allprraf"
          OPEN      ALLPRRA2,"allprraf"
          OPEN      ALLPROA1,"allproaf"
          OPEN      ALLPROA2,"allproaf"
          OPEN      ALLSERA1,"allseraf"
          OPEN      ALLSERA2,"allseraf"
          OPEN      ALLREFA2,"allrefaf"
          OPEN      ALLWLNA2,"allwlnaf"
          OPEN      CONTROLF,"controlf"
          OPEN      MLTSITA1,"mltsitaf"
          OPEN      PRIHDBT2,"prihdbtf"     * private practiceholding header
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATCMCA1,"patcmcaf"
          OPEN      PATRE1A1,"patre1af"     * PRFA
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PRIITEM1,"priitemf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSENCA1,"pmsencaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSCURA1,"pmscuraf"
          OPEN      ALLSTSA1,"allstsaf"
          OPEN      PMSHCPA1,"pmshcpaf"     * for service provider
          OPEN      PMSHCPA2,"pmshcpaf"
          OPEN      ALLACTA1,"allactaf"     * for all Non U/R Activities
          OPEN      ALLACTA2,"allactaf"     * for all Non U/R Activities
          OPEN      WEBSECA1,"websecaf"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLDIAA2,"alldiaaf"
          OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIMABD1,"primabdf"
          OPEN      PRIVAFD1,"privafdf"
          OPEN      PRIWCOM1,"priwcomf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATWMAB2,"patwmabf"     * I-41539
          OPEN      PRIHREF1,"prihreff"
          OPEN      PRIHTRA1,"prihtraf"
          OPEN      PRIINVO4,"priinvof"
          OPEN      PRIBULK3,"pribulkf"
          OPEN      ALLBILA1,"allbilaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBAPOST1,"ibapostf"
          OPEN      ALLITMA1,"allitmaf" 
          OPEN      PMSADWA1,"pmsadwaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLRLNA1,"allrlnaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      SINCIAA1,"sinciaaf"                                *I-41539
          OPEN      PATVADA1,"patvadaf"
          OPEN      ALLCCTA1,"allcctaf"     * Department Contract Codes
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      ACCDIAA1,"accdiaaf"     * AE Diagnosis
          OPEN      EMRICDA1,"emricdaf"     * AE Diagnosis Codes
          OPEN      PMSCCDA1,"pmsccdaf"
.
          READ      CONTROLF,HUND05;*202,PTCNCPAH,*210,PTCNLCLM
.
          READ      CONTROLF,SIXTY3;*67,INCOCATE
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,THIRTY3;*200,PRCNRDOC
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD,*201,ALCNACTW:
                                    *203,ALCNMDES
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND12;*101,PTCNUFFR
          READ      CONTROLF,HUND21;*101,ALCNDAMR,*127,ALCNSDOC
          READ      CONTROLF,HUND25;*93,PTCNNSSI
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTSECA1,"mltsecaf"
          ENDIF
.
          MATCH     "1",ALCNRAUD
          IF        @EQUAL
            OPEN      ALLAUDRE,"allaudre"
          ENDIF
.
          MATCH     "1",ALCNEAUD
          IF        @EQUAL
            OPEN      ALLAUDEN,"allauden"
            OPEN      ALLAUDEA,"allauden"
          ENDIF
.
          OPEN      OUTPREA1,"outpreaf"
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
          CALL      TFILENAM               * Group booking display order temp
          MOVE      TFILNAME,GRPFILNM      * file
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no
.
INIT9999  RETURN
.******************************************************************************
.*                      Determine Template from Mapping Table                 *
.******************************************************************************
GETMAP00  MOVE      REPORTNO,F2
          MOVE      F2,ALTMMPRP
          REP       " 0",ALTMMPRP
          MOVE      TEMPLATE,F3
          MOVE      F3,ALTMMPTP
          REP       " 0",ALTMMPTP
          PACK      KEY16,ALREDEPT,PRGID,ALTMMPRP,ALTMMPTP,SP70
          CALL      RDALTMP1
          IF        OVRCD=0
            MOVE     ALTMMPTT,TEMPLATE
          ENDIF
          RETURN
.******************************************************************************
.                       Clear Parameters                                      *
.******************************************************************************
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDATETY
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,CHECKBX1
          MOVE      ZERO,CHECKBX2
          MOVE      SP70,DEPTCODE
          MOVE      SP70,SRCHDEPT
          MOVE      SP70,VALDDEPT
          MOVE      SP70,ITEMNUMB
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,CANCEL
          MOVE      SP70,PRVAF001
          MOVE      SP70,ACCIDENT
          MOVE      SP70,DOCTCODE
          MOVE      SP70,DEFEDATE
          MOVE      SP70,DEFETIME
          MOVE      SP70,DEFEDOCT
          MOVE      SP70,ALLACTKE
          MOVE      SP70,ALLACTKY
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,ADDCNDAT
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,DOCTNAME
          MOVE      SP70,DOCINDIC
          MOVE      ZERO,FILTRHCP
          MOVE      SP70,ENCOUTKY
          MOVE      SP70,ENCOUTK2
          MOVE      SP70,STARTKEY
          MOVE      ZERO,NORECORD
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,STRTNUM5   * I CAR 41918
          MOVE      SP70,PHOTONFR
          MOVE      SP70,PHOTONUM
          MOVE      SP70,PHOTONTO
          MOVE      SP70,LABELTYP   * Label type
          MOVE      SP70,STATNCOD  
          MOVE      SP70,SCHDPRNT  
          MOVE      ZERO,SELECTYP   * ERC Labels type (Normal or CAR)
          MOVE      SP70,VALDCODE
          MOVE      SP70,VALDURNO
          MOVE      SP70,VALDDATE
          MOVE      SP70,BULKENCK
          MOVE      ZERO,RETURNFM
          MOVE      ZERO,SHWUPDAT
          MOVE      ZERO,OVERRIDE
          MOVE      SP70,ADSACFLG
          MOVE      SP70,ENCTREDR
          MOVE      ZERO,RACTVFLG
          MOVE      SP70,FILTTEAM
.
          MOVE      SP70,ALRSA001
          MOVE      SP70,ALRSA002
          MOVE      SP70,ITEMN001
          MOVE      SP70,ITEMN002
          MOVE      SP70,ITEMN003
          MOVE      SP70,ITEMN004
          MOVE      SP70,ITEMN005
          MOVE      SP70,ITEMN006
          MOVE      SP70,ITEMN007
          MOVE      SP70,ITEMN008
          MOVE      SP70,ITEMN009
          MOVE      SP70,ITEMN010
          MOVE      ZERO,WARCOUNT
          MOVE      Z70,OUTBB035
          MOVE      ZERO,PRIMARYE
          MOVE      SP70,SUPRDATE
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 45
            MOVE      SP70,BULKEKEY[COUNT]  * Clear bulk enc referral key array
            ADD       ONE,COUNT
          DO
          MOVE      ZERO,BULKEEND
.
          CALL      CPALCT00
          CALL      CLRTAC00
          CALL      CLRWCC00
          CALL      CPALEN00
          CALL      CPALRE00
          CALL      CPALER00
          CALL      CPALEM00
          CALL      CPALIV00
          CALL      CPALSP00
          CALL      CPPMEN00
.
          MOVE      SP70,NONVINAH
          MOVE      SP70,TRNSFSRC
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no
          MOVE      ZERO,AUTOCPRF            * Auto copy/close ref    *T0865480
          MOVE      ZERO,UPDITEMS
.
CLRPAR99  RETURN
.******************************************************************************
.*                      Set Parameters                                        *
.******************************************************************************
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            PACK      URNUMBER,QRYDATA,SP70
            MOVE      URNUMBER,URNOTEMP
            SQUEEZE   URNOTEMP
            MOVE      URNOTEMP,URTEMP
            REP       "+ ",URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            REP       "+ ",ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,NEXTPAGE
            GOTO    SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            PACK      REDIRECT,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alref",QRYNAME
          IF        @EQUAL
            CALL      SPALR000              * For referral table
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemn",QRYNAME
          IF        @EQUAL
            CALL      SPITM000              * For item code table
            MOVE      ONE,UPDITEMS          * Items received
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
           MOVE      QRYDATA,FRSTDATE
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "override=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRIDE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,LASTDATE
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "addcndat=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,ADDCNDAT
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "valddept=",QRYNAME
          IF        @EQUAL
            PACK      VALDDEPT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchdept=",QRYNAME
          IF        @EQUAL
            PACK      SRCHDEPT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptcode=",QRYNAME
          IF        @EQUAL
            PACK      DEPTCODE,QRYDATA,SP70
            MOVE      DEPTCODE,ALREDEPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrsa001=",QRYNAME
          IF        @EQUAL
            PACK      ALRSA001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrsa002=",QRYNAME
          IF        @EQUAL
            PACK      ALRSA002,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alenrsta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CANCEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "adsacflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADSACFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "enctredr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCTREDR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRVAF001
            GOTO      SETPAR99
          ENDIF

          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            PACK      DOCTCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defedate=",QRYNAME
          IF        @EQUAL
            PACK      DEFEDATE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defetime=",QRYNAME
          IF        @EQUAL
            PACK      DEFETIME,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defedoct=",QRYNAME
          IF        @EQUAL
            PACK      DEFEDOCT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allactke=",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,ALLACTKE
            GOTO    SETPAR99
          ENDIF
.
          MATCH     "alact",QRYNAME
          IF        @EQUAL
            CALL      STACT000              *set parameters of Non U/R activity
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
           MOVE      QRYDATA,VYEARMTH
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "doctname=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,DOCTNAME
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "filtrHCP=",QRYNAME
          IF        @EQUAL
            MOVE     QRYDATA,FILTRHCP
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "allactky=",QRYNAME
           IF       @EQUAL
            PACK     ALLACTKY,QRYDATA,SP70
            GOTO     SETPAR99
           ENDIF
.
          MATCH     "alenc",QRYNAME
          IF        @EQUAL
            CALL      SPALE000              * For encounter table
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alerc",QRYNAME
          IF        @EQUAL
            CALL      SPALER00              * For ERC table
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alemd",QRYNAME
          IF        @EQUAL
            CALL      SPALEM00              * For EMD table
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alitv",QRYNAME
          IF        @EQUAL
            CALL      SPALIV00              * For ITV table
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alsup",QRYNAME
          IF        @EQUAL
            CALL      SPALSP00              * For SUP table
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prmab",QRYNAME
          IF        @EQUAL
            CALL      SETTAC00              * Set Parameters for TAC Claim
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmenc",QRYNAME
          IF        @EQUAL
            CALL      SPMEN000              * Set Parameters IP Contacts
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "checkbx1",QRYNAME      * used for checkbox
          IF        @EQUAL
            MOVE      QRYDATA,CHECKBX1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "checkbx2",QRYNAME      * used for checkbox
          IF        @EQUAL
            MOVE      QRYDATA,CHECKBX2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prwco0",QRYNAME
          IF        @EQUAL
            CALL      SETWCC00              * Set Parameters for Work Cover
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accident=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * To Format Month
            PACK      ACCIDENT,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "encoutky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCOUTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "encoutk2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCOUTK2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ITEMNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            MOVE      QRYDATA,STRTNUM5         * I CAR 41918
            MOVE      QRYDATA,SRTNUMBL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "photonum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PHOTONUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "photonfr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PHOTONFR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "photonto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PHOTONTO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labeltyp",QRYNAME
          IF        @EQUAL
            PACK      LABELTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod",QRYNAME
          IF        @EQUAL
            PACK      STATNCOD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprnt",QRYNAME
          IF        @EQUAL
            PACK      SCHDPRNT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selectyp",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELECTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      VALDDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returnfm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNFM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdurno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDURNO
            PACK      VALDURNO,VALDURNO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bulkekey=",QRYNAME
          IF        @EQUAL
            COMPARE   FORTY5,BULKEEND
            GOTO      SETPAR99 IF NOT LESS
            ADD       ONE,BULKEEND
            PACK      BULKEKEY[BULKEEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bulkenck=",QRYNAME
          IF        @EQUAL
            PACK      BULKENCK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "shwupdat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHWUPDAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtteam=",QRYNAME
          IF        @EQUAL
            PACK      FILTTEAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suprdate=",QRYNAME
          IF        @EQUAL
            PACK      SUPRDATE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            PACK      VISITTYP,QRYDATA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outbb035=",QRYNAME
          IF        @EQUAL
            PACK      OUTBB035,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nonvinah=",QRYNAME
          IF        @EQUAL
            PACK      NONVINAH,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsfsrc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSFSRC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "autocprf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AUTOCPRF
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.******************************************************************************
.*                      Main Action Routine for patients with referral        *
.******************************************************************************
ALLREF00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ALLREF70 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Encounter
          GOTO      ALLREF10 IF EQUAL
.
          MATCH     "C",UPDATETY            * Cancel Encounter
          GOTO      ALLREF20 IF EQUAL
.
          MATCH     "T",UPDATETY            * TAC Claims
          GOTO      ALLREF30 IF EQUAL
.
          MATCH     "V",UPDATETY            * Veteran Affairs Claims
          GOTO      ALLREF40 IF EQUAL
.
          MATCH     "W",UPDATETY            * Work Cover Claims
          GOTO      ALLREF50 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Encounter for Cancel
          GOTO      ALLREF60 IF EQUAL       * of Second Screen.
.
          GOTO      ALLREF96
.
.     *********** ADD ENCOUNTER FOR A PATIENT WITH REFERRAL **********
.
ALLREF10  CALL      SACR0000                * Checks for SAC referral links
.
          MOVE      ADMISSNO,KEY8
          CALL      RDALREF1                * read the referral table
          BRANCH    OVRCD,ALLREF97
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ALLREF98
.
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MATCH     "1",ALDEPENC          * Don't allow enc on primary ref
            GOTO      ALLREF87 IF EQUAL
          ENDIF
.
          CALL      VALIDT00                * Check Date and Time
          BRANCH    EXIT,ALLREF99
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALLREF90
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLREF90
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      ALLREF86 IF EQUAL
.
          IF        PCEASE=1
            MATCH    SP70,PDECDTE
            IF       @EQUAL
              MOVE      "Patient is Deceased.",WEBTITLE
              ADD       ONE,WARCOUNT
              MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            ELSE 
.
              MATCH     Z70,ALENC005
              IF        !@EQUAL
                MATCH     ALENC005,PDECDTE         * Check encounter date
                IF       @LESS
                  MOVE      "Patient is Deceased.",WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                ENDIF
              ELSE
                PACK      CURRDATE,CCC,CYY,CMM,CDD
                MATCH     CURRDATE,PDECDTE         * check encounter date
                IF       @LESS
                  MOVE      "Patient is Deceased.",WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                ENDIF
              ENDIF
.
            ENDIF
          ENDIF
.
          MOVE      ZERO,WINCLFLG
          MATCH     SP70,REDIRECT    * check if redirect is set
          IF        @EQUAL
            MOVE    ONE,WINCLFLG     * if not do window close in WEBWAR00
          ENDIF
.
          MOVE      TRNSFSRC,ALENC122       * Referred to Hospital (patvadaf)
          MOVE      OUTBB035,ALENC125       * Outcome (Cat OZ)
.
          CALL      CDUEN000                * Check duplicate        *C-0844584
          BRANCH    EXIT,ALLREF99           * encounters
.
          CALL      NEWENC00
          BRANCH    EXIT,ALLREF99
.
.--------*T0881801 Update Next Review Date if populated
          MATCH     Z70,ALREF037          * Next Review Date
          IF        !@EQUAL
            MOVE      ALREF037,ALREDREV
            CALL      UPALREF1
          ENDIF
.
          MATCH     "1",ALDEUY1             * Using ERC Labels
          IF        @EQUAL
            CALL      NEWERC00              * Write record to ERC Table
            MOVE      "Photo Number - ",WEBTITLE
            ENDSET    WEBTITLE
            APPEND    ALERPHOT,WEBTITLE
            RESET     WEBTITLE
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            GOTO      ALLREF88
          ENDIF
.
          CALL      WEDT0000                * Write EDWARD OP visit alteration
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          MATCH     "1",CHECKBX2            * Last Encounter
          IF        @EQUAL
            CALL      ACTW0000              * Auto Activate waiting referral
          ENDIF
.
.--------*T0865480-Start
          CALL      ACLOS000                * Auto close Primary referral
.--------*T0865480-End

          MOVE      ZERO,EXIT
          MATCH     "1",ENCTREDR
          IF        @EQUAL
            CALL      ENCRED00
            GOTO      ALLREF99
          ELSE 
            GOTO      ALLREF88
          ENDIF
.
.        *********** CANCEL FORMACTION ******************
.
ALLREF20  UNPACK    ENCOUTKY,ADMISSNO,SVENCTNO                *C-0844584-Start   
          CALL      CDUEN000                * Check duplicate    
          BRANCH    EXIT,ALLREF99           * encounters      *C-0844584-End
.
          CALL      CANENC00      * Cancel/Update
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ALLREF99
.
          MATCH     "1",ALDEUY1             * Using ERC Labels
          IF        @EQUAL
            CALL      UPDERC00              * Update record in ERC Table
          ENDIF
.
          GOTO      ALLREF99
.
.        **********TAC CLAIMS ***********
.
ALLREF30  CALL      TACENC00
          GOTO      ALLREF99
.
.         ************ VETERAN AFFAIRS CLAIMS  *************
.
ALLREF40  CALL      VETENC00
          GOTO      ALLREF99
.
.        ************ WORK COVER CLAIMS  ************
.
ALLREF50  CALL      WCCENC00
          GOTO      ALLREF99
.
.  Delete Encounter
.
.
ALLREF60  CALL      DELENC00               * Delete Encounter
          GOTO      ALLREF99
.
.        *********** DISPLAY FORMACTION **********
.
ALLREF70  CLEAR     WEBTITLE
          MOVE      "Allied Health Referral Information",WEBTITLE
          RESET     WEBTITLE
.                                           * Webtitle for template=2
          CALL      CLOUTBB1                * Clear outbb1af fields
          MOVE      SP70,LINKEDOP           
          RESET     ENCOUTKY
          MATCH     SP70,ENCOUTKY
          IF        !@EQUAL
            UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
            MOVE      ADMISSNO,ALENVISN
            PACK      KEY16,ENCOUTKY,SP70
            CALL      RDALENC1
            IF        OVRCD = 1
              CALL      CLALLENC
            ENDIF
            MATCH     SP70,ALENLINK
            IF        !@EQUAL
              PACK      KEY8,ALENLINK,SP70    * Update OP appointment outcome
              CALL      RDBOKB1
              IF        OVRCD<>1
                MOVE      OBAOUTNO,LINKEDOP   * Save linked OP visit number
              ENDIF
            ENDIF
          ELSE 
            CALL      CLALLENC
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ELSE
            MOVE      ALREURNO,URNUMBER
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                      * Read department table
          IF        OVRCD=0
            MATCH     "1",ALREUYN4
            IF        @EQUAL
              MOVE      ALDEPENC,PRIMARYE
            ENDIF
          ENDIF
.
          PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      RSALERC2
          CALL      RPALERC2
          BRANCH    OVRCD,ALLREF74
          MATCH     ALENVISN,ALERVISN
          GOTO      ALLREF74 IF NOT EQUAL
          MATCH     ALENENCT,ALERENCT
          GOTO      ALLREF75 IF EQUAL
ALLREF74  CALL      CLALLERC
.
ALLREF75  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALLREF90
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLREF90
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      ALLREF86 IF EQUAL
.
          CALL      ALLTAC00                * I-41539 Read previous visits
.                                           * TAC Claim details (if any)
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,ALLREF99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
.
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF86  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF87  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Contact not allowed on ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referrals",WEBTITLE
          RESET     ALCNMDES
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF88  CALL      WEBWAR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF89  MOVE      "Patient is Deceased.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF90  MOVE      "U/R does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF91  MOVE      "Record does not exist in Contact table ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF92  MOVE      "Record does not exist in Referal table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF93  MOVE      "Record does not exist in Department Service table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF94  MOVE      "Record does not exist in Department table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF95  MOVE      "Accident Date must prior or equalto Contact Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF96  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF97  MOVE      "Invalid Referral Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF98  MOVE      "Department does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLREF99
.
ALLREF99  RETURN
+
.******************************************************************************
. Other Allied Health department details
.******************************************************************************
ALDEDT00  MATCH     SP70,DIM3
          IF        !@EQUAL & !@EOS
            PACK      KEY3,DIM3,SP70
          ELSE
            PACK      KEY3,ALACDEPT,SP70
          ENDIF
. 
          CALL      RDALDEP1
          IF        OVRCD=1
            PACK      KEY3,ALLACTKY,SP70
            CALL      RDALDEP1
          ENDIF
          BRANCH    OVRCD,ALDEDT99
.
          UNPACK    DIM127,D1,KEY2,DIM127
          MOVE      ZERO,F2
          MOVE      KEY2,F2
.
          BRANCH    F2,ALDEDT01,ALDEDT02,ALDEDT03,ALDEDT04,ALDEDT05:
                       ALDEDT06,ALDEDT07,ALDEDT08,ALDEDT09,ALDEDT10:
                       ALDEDT11,ALDEDT12
.
ALDEDT01  WRITE     HTMLFILE;ALDEUERF;      * Using External Referrals
          GOTO      ALDEDT99
.
ALDEDT02  WRITE     HTMLFILE;ALDEURAD;      * Using Residental Admission
          GOTO      ALDEDT99
.
ALDEDT03  WRITE     HTMLFILE;ALDEUASS;      * Using Assessments
          GOTO      ALDEDT99
.
ALDEDT04  WRITE     HTMLFILE;ALDEURAP;      * Using Request Appointments
          GOTO      ALDEDT99
.
ALDEDT05  WRITE     HTMLFILE;ALDEDLAS;      * Display Last 5 Contacts
          GOTO      ALDEDT99
.
ALDEDT06  WRITE     HTMLFILE;ALDEDCLI;      * Display Clinical Documentation
          GOTO      ALDEDT99
.
ALDEDT07  WRITE     HTMLFILE;ALDEDRAA;      * Display Referral Action Audit
          GOTO      ALDEDT99
.
ALDEDT08  WRITE     HTMLFILE;ALDEDLET;      * Display Letter History
          GOTO      ALDEDT99
.
ALDEDT09  WRITE     HTMLFILE;ALDEUEME;      * Using Encounter Medications
          GOTO      ALDEDT99
.
ALDEDT10  WRITE     HTMLFILE;ALDEUEIN;      * Using Encounter Interventions
          GOTO      ALDEDT99
.
ALDEDT11  WRITE     HTMLFILE;ALDEUESU;      * Using Encounter Supplies
          GOTO      ALDEDT99
.
ALDEDT12  REP       " 0",ALDEUAHP
          WRITE     HTMLFILE;ALDEUAHP;      * Using Additional HCPs
          GOTO      ALDEDT99
.
ALDEDT99  RETURN
.
+
.******************************************************************************
.         Get the current date/time/userid values for update fields (allencaf)
.******************************************************************************
UPENCF00  CALL      IBACLOCK
          PACK      ALENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALENUDAT
          MOVE      CTIMEIS,ALENUTIM
          MOVE      USERID,ALENUUID
.
UPENCF99  RETURN
+
.*****************************************************************************
. Veteran Affairs Claims                                                     *
.*****************************************************************************
VETENC00  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ADMISSNO,ALENVISN
.
          PACK      KEY16,ENCOUTKY,SP70     * Reading allencaf table
          CALL      RDALENC1
          BRANCH    OVRCD,VETENC91
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reading allref table
          BRANCH    OVRCD,VETENC92
.
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1                *  Reading allseraf table
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                * Reading Department table
          BRANCH    OVRCD,VETENC93
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,VETENC95
          CALL      RDPMPX21
          BRANCH    OVRCD,VETENC95
.
          CALL      ALLBIL00                * Calling Billing Routine
.
          PACK      KEY27,URNUMBER,DPRHDSCN,PRHDCLAM,PRHDACCD,PFUNDH,SP70
          CALL      RDPRHD1
          BRANCH    OVRCD,VETENC99
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALEN00
.
          MOVE      "       0",PRVAINVN
          MOVE      PRHDUNIQ,PRVAUNIQ
          MATCH     PRVAF001,Z70
          IF        !@EQUAL
            MOVE     PRVAF001,PRVACLAM
          ENDIF
.
          PACK      KEY16,PRVAINVN,PRVAUNIQ,SP70
          CALL      RDPRVA1
          IF        OVRCD=1
            CALL      WRPRVA1                 * Writing PRIVAFFD table
          ENDIF
.
          MOVE      PRHDUNIQ,ALENUNIQ
.
          CALL      UPENCF00                * Get update date/time/userid values
          CALL      UPALENC1                * Updating allencaf table
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALEN00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEA                * Pass New Encounter to DG *I-90202
.
          MOVE      ZERO,EXIT
.
          GOTO      VETENC99
.
VETENC90  MOVE      "Contact does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VETENC99
.
VETENC91  MOVE      "Record does not exist in Contact table ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VETENC99
.
VETENC92  MOVE      "Record does not exist in Referal table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VETENC99
.
VETENC93  MOVE      "Record does not exist in Department Service table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VETENC99
.
VETENC94  MOVE      "Record does not exist in Department table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VETENC99
.
VETENC95  MOVE      "U/R does not exist on PMI.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VETENC99
.
VETENC99  RETURN
.*****************************************************************************
. Worker Compensation Encounter Update                                       *
.*****************************************************************************
WCCENC00  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ADMISSNO,ALENVISN
.
          PACK      KEY16,ENCOUTKY,SP70
          CALL      RDALENC1                * Reading allencaf table
          BRANCH    OVRCD,WCCENC91
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reading allrefaf table
          BRANCH    OVRCD,WCCENC92
.
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1                *  Reading allseraf table
          BRANCH    OVRCD,WCCENC93
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                * Reading Department table
          BRANCH    OVRCD,WCCENC94
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WCCENC96
          CALL      RDPMPX21
          BRANCH    OVRCD,WCCENC96
.
          CALL      ALLBIL00                * Calling Billing Routine
.
          MATCH     ACCIDENT,ALENSDAT
          GOTO      WCCENC95 IF LESS
.
          MOVE      "       0",PRWCINVN
          PACK      KEY27,URNUMBER,DPRHDSCN,PRHDCLAM,PRHDACCD,PFUNDH,SP70
          CALL      RDPRHD1
          BRANCH    OVRCD,WCCENC99
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALEN00
.
          MOVE      "       0",PRWCINVN
          MOVE      PRHDUNIQ,PRWCUNIQ
          MOVE      SP70,PRWCNAME
          MOVE      SP70,PRWCADD1
          MOVE      SP70,PRWCADD2
          MOVE      SP70,PRWCADD3
          MOVE      SP70,PRWCPOST
          MOVE      SP70,PRWCTELE
          MOVE      SP70,PRWCACCP
          MOVE      SP70,PRWCICOD
          MOVE      SP70,PRWCCLMN
          MOVE      SP70,PRWCTIME
          MOVE      SP70,PRWCCOM1
          MOVE      SP70,PRWCCOM2
.
          CALL      MOVWCC00                * Moving the Variables
.
          PACK      KEY16,PRWCINVN,PRWCUNIQ,SP70
          CALL      RDPRWC1
          IF        OVRCD=1
            CALL      WRPRWC1                 * Writing into PRIWCOFD Table
          ENDIF
.
          MOVE      PRHDUNIQ,ALENUNIQ
.
          CALL      UPENCF00                * Get update date/time/userid values
          CALL      UPALENC1                * Updating allencaf table
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALEN00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEA                * Pass New Encounter to DG *I-90202
.
          MOVE      ZERO,EXIT
.
          GOTO      WCCENC99
.
WCCENC90  MOVE      "Contact does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WCCENC99
.
WCCENC91  MOVE      "Record does not exist in Contact table ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WCCENC99
.
WCCENC92  MOVE      "Record does not exist in Referal table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WCCENC99
.
WCCENC93  MOVE      "Record does not exist in Department Service table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WCCENC99
.
WCCENC94  MOVE      "Record does not exist in Department table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WCCENC99
.
WCCENC95  MOVE      "Accident Date must prior or equal to Contact.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WCCENC99
.
WCCENC96  MOVE      "U/R does not exist on PMI.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WCCENC99
.
WCCENC99  RETURN
.*****************************************************************************
.  Update TAC Claim & Billing Details                                        *
.*****************************************************************************
TACENC00  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ADMISSNO,ALENVISN
.
          PACK      KEY16,ENCOUTKY,SP70
          CALL      RDALENC1                * Reading allencaf table
          BRANCH    OVRCD,TACENC91
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reading allref table
          BRANCH    OVRCD,TACENC92
.
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1                *  Reading allseraf table
          BRANCH    OVRCD,TACENC93
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                * Reading Department table
          BRANCH    OVRCD,TACENC94
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,TACENC96
          CALL      RDPMPX21
          BRANCH    OVRCD,TACENC96
.
          CALL      ALLBIL00                * Calling Billing Routine
.
          MATCH     ACCIDENT,ALENSDAT
          GOTO      TACENC95 IF LESS
.
          PACK      KEY27,URNUMBER,DPRHDSCN,PRHDCLAM,PRHDACCD,PFUNDH,SP70
          CALL      RDPRHD1
          BRANCH    OVRCD,TACENC99
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALEN00
.
          MOVE      "       0",PRMAINVN
          MOVE      PRHDUNIQ,PRMAUNIQ
          MOVE      SP70,PRMAREFN
          MOVE      SP70,PRMAPOLS
          MOVE      SP70,PRMASOLN
          MOVE      SP70,PRMASAD1
          MOVE      SP70,PRMASAD2
          MOVE      SP70,PRMASAD3
          MOVE      SP70,PRMASPCD
          MOVE      SP70,PRMASOLT
          MOVE      SP70,PRMAREGO
          MOVE      SP70,PRMAALOC
          MOVE      SP70,PRMAATIM
          MOVE      SP70,PRMAENGD
          MOVE      SP70,PRMAINJD
          MOVE      SP70,PRMAUDF1
          MOVE      SP70,PRMAUDF2
          MOVE      SP70,PRMAMSEV
          MOVE      SP70,PRMARSEV
          MOVE      SP70,PRMAODD1
          MOVE      SP70,PRMAODD2
          MOVE      SP70,PRMAODD3
.
          CALL      MOVTAC00                * Moving the variables
.
          PACK      KEY16,PRMAINVN,PRMAUNIQ,SP70
          CALL      RDPRMA1
          IF        OVRCD=1
            CALL      WRPRMA1                 * Writing PRIMABFD table
          ENDIF
.
          MOVE      PRHDUNIQ,ALENUNIQ
.
          CALL      UPENCF00                * Get update date/time/userid values
          CALL      UPALENC1                * Updating allencaf table
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALEN00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEA                * Pass New Encounter to DG *I-90202
.
          MOVE      ZERO,EXIT
.
          GOTO      TACENC99
.
TACENC90  MOVE      "Contact does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TACENC99
.
TACENC91  MOVE      "Record does not exist in Contact table ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TACENC99
.
TACENC92  MOVE      "Record does not exist in Referal table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TACENC99
.
TACENC93  MOVE      "Record does not exist in Department Service table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TACENC99
.
TACENC94  MOVE      "Record does not exist in Department table",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TACENC99
.
TACENC95  MOVE      "Accident Date must prior or equal to Contact Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TACENC99
.
TACENC96  MOVE      "U/R does not exist on PMI.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TACENC99
.
TACENC99  RETURN
.*****************************************************************************
. Cancel Encounter                                                           *
.*****************************************************************************
CANENC00  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ADMISSNO,ALENVISN
          MATCH     SP8,ALENVISN            * Check If VisitNo is Blank
          GOTO      CANENC90 IF EQUAL
.
          MOVE      SP70,KEY11
          PACK      KEY16,ALENVISN,ALENENCT,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,CANENC90
.
          MATCH     "1",ALENMOHR
          GOTO      CANENC40 IF NOT EQUAL   * don't process "Sent"
.
          MATCH     "1",CANCEL
          GOTO      CANENC40 IF EQUAL       * Cancelling Encounter
.
          MATCH     ALENC007,Z70
          GOTO      CANENC40 IF EQUAL       * No change of Location
.
          MATCH     ALENC007,ALENLOCA
          GOTO      CANENC40 IF EQUAL       * Location hasn't changed
.
.         If this is updating, can only allow changing Location of Service
.         if MHINC is not sent.
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reading allref table
          BRANCH    OVRCD,CANENC40
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANENC40
.
          MATCH     "M",TCINDC4
          GOTO      CANENC40 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4               * Primary Referral?
          GOTO      CANENC92 IF EQUAL          * yes, MHINC already been sent
.
CANENC40  MATCH     "1",SUPRDATE            * Supervisor screen update date/time
          IF        @EQUAL
            CALL      VALIDT00              * Check Date and Time
            BRANCH    EXIT,CANENC99
          ENDIF
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALEN00
.
          MOVE      TRNSFSRC,ALENC122       * Referred to Hospital (patvadaf)
          MOVE      OUTBB035,ALENC125       * Outcome (Cat OZ)
          CALL      MVALEN00
.
          CALL      CEMHI000                * set MHINC indicator
.
          MOVE      CANCEL,ALENRSTA
          CALL      UPENCF00                * Get update date/time/userid values
          CALL      UPALENC1                * Updating the fields
.
          CALL      UITM0000                * Update items
          CALL      WEDE0000                * Write EDWARD visit alteration
.
.         Get Referral & PMI details prior to sending broadcast message
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * allrefaf record on file ?
          BRANCH    OVRCD,CANENC80          * no - don't send
.
          MOVE      ALREURNO,KEY8
          CALL      RDMAST1                 * PMI master record on file ?
          BRANCH    OVRCD,CANENC80          * no - don't send
.
          MOVE      ALREURNO,KEY8
          CALL      RDPMPX21                * PMI extension on file ?
          BRANCH    OVRCD,CANENC80          * no - don't send
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALEN00
.
          MATCH     "1",ALENRSTA
          IF        @EQUAL
            MOVE      FOUR,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICED              * Pass Delete to Datagate  *I-90202
          ELSE
            MOVE      FIVE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICEU              * broadcast HL7 A08 update message
          ENDIF
.
CANENC80  MATCH     Z70,ALREF006
          IF        !@EQUAL
            MOVE      ALREF006,ALRERCLO
            CALL      UPALREF1
          ENDIF
.
.--------*T0881801 Update Next Review Date if populated
          MATCH     Z70,ALREF037          * Next Review Date
          IF        !@EQUAL
            MOVE      ALREF037,ALREDREV
            CALL      UPALREF1
          ENDIF
.
          MATCH     SP70,ALENLINK
          GOTO      CANENC89 IF EQUAL
.
          PACK      KEY8,ALENLINK,SP70    * Update OP appointment outcome
          CALL      RDBOKB1
          BRANCH    OVRCD,CANENC89
.
          MATCH     Z70,OUTBB035
          IF        !@EQUAL
            MOVE      OUTBB035,OTBBOUTC
          ENDIF
.
          MATCH     Z70,ALENC004
          IF        !@EQUAL
            MATCH     "1",ALCNSDOC        * Don't update OP seen by Dr
            IF        !@EQUAL
              MOVE      ALENC004,OTBBADCS * Actual doctor seen
            ENDIF
          ENDIF
.
          MATCH     Z70,ALENC006
          IF        !@EQUAL
            MATCH     SP70,ALENC006
            IF        !@EQUAL
              MATCH     OTBBCITM,ALENC006        * Time Seen >= Check in time
              IF        !@LESS
                MOVE      ALENC006,OTBBASTM      * Update Time see
              ENDIF
            ENDIF
          ENDIF
.
          CALL      UPBOKB1
.
CANENC89  MOVE      ZERO,EXIT
          GOTO      CANENC99
.
CANENC90  MOVE      "Invalid Contact.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANENC99
.
CANENC92  CALL      OPENHTML
          BRANCH    EXIT,CANENC95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
             " var PopUpFrame = parent.document.getElementById('PopUpFrame');":
                    "  alert(#"":
                    "Location cannot be changed as the record has ":
                    "been sent to MHINC - it must be Cancelled ":
                    "and a new contact created.":
                    "#");":
                    "  if (window.name.substr(0,4)=='Hide') {":
                    "    self.close();} else {":
                    "  if (PopUpScreen) {":
                    "    PopUpScreen.style.display='none'; } else {":
                    "    history.go(-1); } }":
                    "}":
                    "</script>",012
.
          CALL      CLOSHTML     * End of Document
          GOTO      CANENC98
.
CANENC95  DISPLAY   "*** Fifo Not Found - ",FILNAM," ***"
.
CANENC98  MOVE      ONE,EXIT
CANENC99  RETURN
.------------------------------------------------------------
. Delete Encounter
.------------------------------------------------------------
DELENC00  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ADMISSNO,ALENVISN
          MATCH     SP8,ALENVISN            * Check If VisitNo is Blank
          GOTO      DELENC90 IF EQUAL
.
          MOVE      SP70,KEY11
          PACK      KEY16,ALENVISN,ALENENCT,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,DELENC90
.
          CALL      DEALENC1                * Updating the fields
.
          MOVE      FOUR,AUDTTYPE            * delete history record
          CALL      WAALEN00
.
DELENC20  MOVE      ALENVISN,ALITVISN
          MOVE      ALENENCT,ALITENCN
.
          PACK      KEY18,ALITVISN,ALITENCN,SP70
          CALL      RSALITM1
          CALL      RKALITM1
          BRANCH    OVRCD,DELENC40
.
          MATCH     ALENVISN,ALITVISN                * Same referral
          GOTO      DELENC40 IF NOT EQUAL      
. 
          MATCH     ALENENCT,ALITENCN                * Same Encounter Number
          GOTO      DELENC40 IF NOT EQUAL      
.
          PACK      KEY18,ALITVISN,ALITENCN,ALITITMC
          CALL      DEALITM1
          GOTO      DELENC20
.
DELENC40  MOVE      ZERO,EXIT
          GOTO      DELENC99
.
DELENC90  MOVE      "Invalid Contact.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELENC99
.
DELENC99  RETURN
.******************************************************************************
. Add New Encounter details to a ERC table                                    *
.******************************************************************************
NEWERC00  MOVE      ONE,F6
          MOVE      F6,ERCNUMB
          REP       " 0",ERCNUMB
          UNPACK    ALENSDAT,D2,ERCYEAR
          PACK      KEY8,ERCYEAR,Z70
          CALL      RSALERC1
          CALL      RPALERC1
          BRANCH    OVRCD,NEWERC50
.
          MATCH     ERCYEAR,ALERPHOT
          GOTO      NEWERC50 IF NOT EQUAL
.
          UNPACK    ALERPHOT,D2,ERCNUMB
          MOVE      ERCNUMB,F6
          ADD       ONE,F6
          MOVE      F6,ERCNUMB
          REP       " 0",ERCNUMB
.
NEWERC50  CALL      CLALLERC
          CALL      MVALER00
.
          PACK      ALERPHOT,ERCYEAR,ERCNUMB
          MOVE      ALENVISN,ALERVISN
          MOVE      ALENENCT,ALERENCT
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,ALERCDAT
          MOVE      CTIMEIS,ALERCTIM
          MOVE      USERID,ALERCUID
          MOVE      SP70,ALERUDAT
          MOVE      SP70,ALERUTIM
          MOVE      SP70,ALERUUID
.
          PACK      KEY8,ALERPHOT
          CALL      WRALERC1
.
NEWERC99  RETURN
.*****************************************************************************
. Update Encounter details in ERC table                                      *
.*****************************************************************************
UPDERC00  PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      RSALERC2
          CALL      RPALERC2
          BRANCH    OVRCD,NEWERC99
.
          MATCH     ALENVISN,ALERVISN
          GOTO      UPDERC99 IF NOT EQUAL
.
          MATCH     ALENENCT,ALERENCT
          GOTO      UPDERC99 IF NOT EQUAL
.
.-------- Check duplicates indicator for service codes -----------   *C-0844584
          
.
UPDERC50  CALL      MVALER00
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,ALERUDAT
          MOVE      CTIMEIS,ALERUTIM
          MOVE      USERID,ALERUUID
.
          CALL      UPALERC2
.
UPDERC99  RETURN
.******************************************************************************
.*                      ADD LAST ENCOUNTER WITH REFERRAL                      *
.******************************************************************************
LASTEN00  MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MOVE      "2",ALRESTAT
          MOVE      ALREF006,ALRERCLO       * Reason For Closure
.
          IF        PTCNHDPS=1      
            MATCH     Z70,ALENC011
            GOTO      LASTEN10 IF EQUAL
.
            MOVE      ZERO,ADJTIME
            MOVE      ALENC011,ADJTIME
            COMPARE   ZERO,ADJTIME          * Check Direct Minutes for NZ only 
            GOTO      LASTEN10 IF EQUAL
.
            MOVE      ALENC005,CLOSEDTE
            CALL      CLCLOS00              * Calculate closure Date & Time
.
            MOVE      CLOSEDTE,ALREDCLO     * Date Of Closure
            MOVE      CLOSTIME,ALRETCLO     * Time Of Closure
            GOTO      LASTEN20       
          ENDIF
.
LASTEN10  MOVE      ALENC005,ALREDCLO       * Date Of Closure
          MOVE      ALENC006,ALRETCLO       * Time of Closure
.
LASTEN20  MATCH     Z70,ALREF072
          IF        !@EQUAL
            MOVE      ALREF072,ALREUC33     * Program completion reason
          ENDIF
.
          MATCH     Z70,ALREF136
          IF        !@EQUAL
            MOVE      ALREF136,ALREUDT6     * Case End Date
          ENDIF
.
          MATCH     Z70,ALREF137
          IF        !@EQUAL
            MOVE      ALREF137,ALREUTM6     * Case End Time
          ENDIF
.
          MATCH     Z70,ALREF037
          IF        !@EQUAL
            MOVE      ALREF037,ALREDREV     * Date of Next Review
          ENDIF
.
          REP       " 0",XCDATE                                        *I-60242
          MOVE      XCDATE,ALREUDAT         * Date Record Updated(System Date)
          MOVE      CTIMEIS,ALREUTIM        * Time Record Updated(System Time)
          MOVE      USERID,ALREUUID         * Userid
          CALL      URMHI000                * Set MHINC indicator
          CALL      UPALREF1                * Update Record
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      EIGHT,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.                                           * Update Status History Table
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      ADMISSNO,ALSTVISN
          MOVE      "2",ALSTSTAT
          MOVE      ALENC005,ALSTSDAT
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT,SP70
          CALL      RDALSTS1
.                                           * Record does not exist
          IF        OVRCD=1
            REP       " 0",XCDATE
            MOVE      XCDATE,ALSTCDAT
            MOVE      CTIMEIS,ALSTCTIM
            MOVE      USERID,ALSTCUID
            CALL      WRALSTS1              * write record to history table
          ELSE
            REP       " 0",XCDATE
            MOVE      XCDATE,ALSTUDAT
            MOVE      CTIMEIS,ALSTUTIM
            MOVE      USERID,ALSTUUID
            CALL      UPALSTS1              *update record history table
          ENDIF
.
          MOVE      ADMISSNO,ALAUVISN
          REP       " 0",XCDATE
          MOVE      XCDATE,ALAUADAT
          MOVE      CTIMEIS,ALAUATIM
          PACK      KEY24,ALAUVISN,ALAUADAT,ALAUATIM
          CALL      RDALAUD1
          MOVE      USERID,ALAUAUID
          MOVE      SP70,ALAUACTI
          MOVE      "C",ALAUUPDT
          MOVE      SP70,ALAUCOMM
          IF        OVRCD=0
            CALL      UPALAUD1
          ELSE
            CALL      WRALAUD1
          ENDIF
          GOTO      LASTEN99
.
LASTEN99  RETURN
+
.
.******************************************************************************
.CLCLOS00 - Claculate Closure Date and Time
.******************************************************************************
CLCLOS00  UNPACK    ALENC006,CHOUR,ANS,CMIN,ANS,CSEC * unpack the start time
          MOVE      CMIN,FORM2              * minutes as a form2
          MOVE      FORM2,FORM4A            * set up work variable
          ADD       ADJTIME,FORM4A          * the total minutes to add
.
CLCLOS20  COMPARE   ZERO,FORM4A
          GOTO      CLCLOS30 IF NOT LESS    * positve amount
.
          ADD       "60",FORM4A             * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
          GOTO      CLCLOS20
.
CLCLOS30  MOVE      FORM4A,FORM4B           * save the minutes
.
          DIV       "60",FORM4A             * the total hours to add
          MOVE      CHOUR,FORM2             * hours as a form
          ADD       FORM4A,FORM2            * add the hours
.
CLCLOS40  COMPARE   "24",FORM2
          GOTO      CLCLOS50 IF LESS        * below 24 hours
.
          SUB       "24",FORM2              * get back to 24 hour time
.
          UNPACK    ALENC005,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      CLOSEDTE,CCENT,CYEAR,CMON,CDAY
.
          GOTO      CLCLOS40
.
CLCLOS50  MOVE      FORM2,CHOUR             * set up the hours
.
          MULT      "60",FORM4A             * the total minutes added
          SUB       FORM4A,FORM4B           * the minutes to add
          MOVE      FORM4B,FORM2            * get minutes as form2
.
          COMPARE   ZERO,FORM2
          GOTO      CLCLOS80 IF NOT LESS    * not negative
.
          ADD       "60",FORM2              * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
.
CLCLOS80  MOVE      FORM2,CMIN              * the minutes
.
          PACK      CLOSTIME,CHOUR,COLON,CMIN,COLON,CSEC * the end time
          REP       " 0",CLOSTIME
.
CLCLOS99  RETURN
.
.******************************************************************************
.*                      Main Action Routine for patients with no referral     *
.******************************************************************************
ALLNRF00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ALLNRF20 IF EQUAL
          MATCH     "A",UPDATETY            * Add Encounter
          GOTO      ALLNRF10 IF EQUAL
          GOTO      ALLNRF95
.
.******************************************************************************
.*                      ADD FORMATION                                         *
.******************************************************************************
ALLNRF10  MATCH     SP3,DEPTCODE            * Checking for blank dept
          GOTO      ALLNRF96 IF EQUAL
          MATCH     SP8,URNUMBER            * Checking for blank U/R no
          GOTO      ALLNRF97 IF EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ALLNRF97
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21 
          BRANCH    OVRCD,ALLNRF97
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      ALLNRF89 IF EQUAL
.
          IF        PCEASE=1
            MATCH    SP70,PDECDTE
            IF       @EQUAL
              MOVE      "Patient is Deceased.",WEBTITLE
              ADD       ONE,WARCOUNT
              MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            ELSE
              MATCH     Z70,ALENC005
              IF        !@EQUAL
                MATCH     ALENC005,PDECDTE         * Check encounter date
                IF       @LESS
                  MOVE      "Patient is Deceased.",WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                ENDIF
              ELSE
                PACK      CURRDATE,CCC,CYY,CMM,CDD
                MATCH     CURRDATE,PDECDTE         * check encounter date
                IF       @LESS
                  MOVE      "Patient is Deceased.",WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "T-",URNUMBER
          GOTO      ALLNRF98 IF EQUAL
.
          PACK      KEY3,DEPTCODE
          CALL      RDALDEP1
          BRANCH    OVRCD,ALLNRF96
.         MATCH     "1",ALDEREFE
.         GOTO      ALLNRF93 IF EQUAL
.
          CALL      ENCNEW00        * New Encounter No Existing Referral
          BRANCH    EXIT,ALLNRF99
.
          CALL      SACR0000    * Checks for SAC referral links
          CALL      CHKOUT00    * Check for future OP visit for close referral
.
          MATCH     "1",CHECKBX2
          IF        @EQUAL
            CALL      LASTEN00             * Add Last Encounter
          ENDIF
.
          GOTO      ALLNRF99
.
.******************************************************************************
.*                      DISPLAY FORMACTION                                    *
.******************************************************************************
ALLNRF20  CLEAR     WEBTITLE
          MOVE      "Allied Health Contacts",WEBTITLE
          RESET     WEBTITLE
.
          MOVE       TEMPLATE,F1            * Setting the title for the frame
          IF        F1=2
            CLEAR     WEBTITLE
            MOVE      "CG",CATEGORY
            PACK      KEY5,CATEGORY,DEPTCODE,SP70
            CALL      RDCODE1
            PACK      WEBTITLE,TDESC,SP1,ENCTR,SP70
            RESET     WEBTITLE
          ENDIF
.
          MATCH     SP8,URNUMBER            * Reading for PATMASTM
          GOTO      ALLNRF97 IF EQUAL
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALLNRF99
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21 
          BRANCH    OVRCD,ALLNRF99
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      ALLNRF89 IF EQUAL
.
          MATCH     SP8,ADMISSNO            * Reading for referral
          IF        !@EQUAL
            PACK      KEY16,URNUMBER,ADMISSNO,SP70
            CALL      RDALREF2
            BRANCH    OVRCD,ALLNRF99
          ENDIF
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Reading For Web User's deptcode
          BRANCH    OVRCD,ALLNRF99
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                * Reading For Department Security
          BRANCH    OVRCD,ALLNRF99
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      ALLNRF94 IF NOT EQUAL
          ENDIF
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,ALLNRF99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
.******************************************************************************
.*                      ERROR HANDLING                                        *
.******************************************************************************
ALLNRF89  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF90  MOVE      "Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF91  MOVE      "Patient Must have a Referral for this Department",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF93  MOVE      "Must have a Referral for this Department",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF94  MOVE      "Invalid Security.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF96  MOVE      "Department Code can't be blank",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF97  MOVE      "U/R Number can't be blank",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF98  MOVE      "You must have a valid U/R and this to be merged",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNRF99
.
ALLNRF99  RETURN
.******************************************************************************
. New Encounter without Referral                                              *
.******************************************************************************
ENCNEW00  CLOCK     TIME,CTIMEIS
          PACK      CDATE,CCC,CYY,CMM,CDD
          REP       " 0",CDATE
          MOVE      ZERO,EXIT
.
          MATCH     ALENC005,CDATE          * Error if contact date/time is
          GOTO      ENCNEW94 IF LESS        * in the future
.
          MATCH     ALENC005,CDATE
          IF        @EQUAL
            MATCH     ALENC006,CTIMEIS
            GOTO      ENCNEW94 IF LESS
          ENDIF
.
          PACK      KEY16,URNUMBER,Z70
          CALL      RSALREF2
ENCNEW10  CALL      RPALREF2                * checking the referral if exists ??
          BRANCH    OVRCD,ENCNEW20
.
          MATCH     URNUMBER,ALREURNO
          GOTO      ENCNEW20 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT
          GOTO      ENCNEW10 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT
          GOTO      ENCNEW10 IF NOT EQUAL
.
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MATCH     "1",ALDEPENC          * Don't allow enc on primary ref
            GOTO      ENCNEW10 IF EQUAL
          ENDIF 
.
.         Non-VINAH referrals only?
.
          MATCH     "1",NONVINAH            * Non-VINAH referrals only?
          IF        @EQUAL
            MATCH     "1",ALRENVIN          * Is it a Non-VINAH referral?
            GOTO      ENCNEW10 IF NOT EQUAL * No; get next
          ENDIF
.
          MOVE      ALREVISN,ADMISSNO       * Add encounter to existing referral
          GOTO      ENCNEW30                * Update referral
.
ENCNEW20  MATCH     "1",NONVINAH            * Non-VINAH referral?
          IF        !@EQUAL
            MATCH     "1",ALDEREFE          * Ignore using referrals test if
            GOTO      ENCNEW93 IF EQUAL     * adding a non vinah contact
          ENDIF
.
          MATCH     "1",ADSACFLG            * Must have a referral if adding
          GOTO      ENCNEW93 IF EQUAL       * a sacs encounter
.
          CALL      NXTA0000                * Reading the control file
.
          CALL      MAKREF00                * Create New Referral
.
ENCNEW30  MATCH     Z70,ALENC005
          IF        !@EQUAL
            MATCH     ALRERDAT,ALENC005        * Check encounter and referral
            GOTO      ENCNEW91 IF LESS
          ELSE
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            MATCH     ALRERDAT,CURRDATE        * check encounter and referral
            GOTO      ENCNEW91 IF LESS
          ENDIF 
.
          CALL      ADDENC00                * Adding to encounter table
          BRANCH    EXIT,ENCNEW92
.
          CALL      CHKBIL00
          BRANCH    EXIT,ENCNEW90
.
          CALL      ALLBIL00                * For Billing
.
          PACK      KEY16,ALENVISN,ALENENCT,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,ALLBIL99
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALEN00
.
          MOVE      PRHDUNIQ,ALENUNIQ
          CALL      UPENCF00                * Get update date/time/userid values
          CALL      UPALENC1                * Updating encounter table
.
          MOVE      THREE,AUDTTYPE           * after history record
          CALL      WAALEN00
.         
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN1,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEU                * write message to broadcast queue
.
ENCNEW90  MOVE      ZERO,EXIT
          PACK      REDIRECT,REDIRECT,SP70,SP70
          STRIP     REDIRECT
          ENDSET    REDIRECT
          PACK      KEYENCTR,ALENVISN,ALENENCT,SP70
          REP       " +",KEYENCTR
          APPEND    "&encoutky=",REDIRECT
          APPEND    KEYENCTR,REDIRECT
.
          RESET     REDIRECT
          GOTO      ENCNEW99
.
ENCNEW91  MOVE      "Contact date must be after the referral date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNEW99
.
ENCNEW92  CLEAR     WEBTITLE
          APPEND    "Contact limit of 999 has been reached. ",WEBTITLE
          APPEND    "Please close this referral.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNEW99
.
ENCNEW93  MOVE      "Must have a Referral for this Department",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNEW99
.
ENCNEW94  MOVE      "Contact date/time should not be in future ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNEW99
.
ENCNEW99  RETURN
.*****************************************************************************
. Make a New Referral for a Encounter                                        *
.*****************************************************************************
MAKREF00  CALL      CLPATVIS
          MOVE      URNUMBER,PVIURNO
.
          MATCH     ALENC005,Z70
          IF        !@EQUAL
            MOVE      ALENC005,PVIDATE
          ELSE
            PACK      PVIDATE,CCC,CYY,CMM,CDD
          ENDIF
.
          REP       " 0",PVIDATE
          MOVE      ADMISSNO,PVIBILL
          MOVE      "9",PVITYPE
          MOVE      " 2",PVISYST
          MOVE      ALENC004,PVIDOCT
          MOVE      "2",PVISTAT
          MOVE      "1",PVITRAN
          MOVE      WBSESIT,PVISITE
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDAVISA1
          IF        OVRCD=1
            CALL      WRVISA1                 * Writes to visit table
          ENDIF
.
          CALL      CLPMSVX1
          MOVE      ADMISSNO,PMVXVISN
          MOVE      PVIDATE,PMVXVSDT
.
          MATCH     Z70,ALENC004
          IF        !@EQUAL
            MOVE      ALENC004,PMVXDOCA
          ENDIF
.
          MOVE      "0",PMVXCSNR
          MOVE      PPOST,PMVXPOST
          MOVE      "0",PMVXCFSG
          MOVE      "0",PMVXINGP
          MOVE      "0",PMVXHCP1
          MOVE      "0",PMVXHCP2
          MOVE      "0",PMVXHCP3
          MOVE      "0",PMVXHCP4
.
          MATCH     Z70,ALENC004
          IF        !@EQUAL
            MOVE      ALENC004,PMVXRHC1
          ENDIF
.
          MOVE      ALDEPRAC,PMVXRH1G
          MOVE      "1",PMVXRH1C
          MOVE      "0",PMVXPSTY
          MOVE      "0",PMVXVALW
          MOVE      "0",PMVXPALW
          MOVE      "0",PMVXINDC
          MOVE      "0",PMVXHOME
          MOVE      PVIDATE,PMVXCDTE
          CLOCK     TIME,PMVXCTIM
          MOVE      USERID,PMVXWEBC
          MOVE      ALDEHOSP,PMVXMHOS
          CALL      GTASGC00                * get SLA/ASGC code
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXPILC
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAPMVX11                * Writes to visit extesion table
          IF        OVRCD=1
            CALL      WRPMVX11                * Writes to visit extesion table
          ENDIF
.
          CALL      CLALLREF
          MOVE      ADMISSNO,ALREVISN
          MOVE      URNUMBER,ALREURNO
          MOVE      "1",ALRESTAT
          MOVE      PVIDATE,ALREDACT
          MOVE      PVIDATE,ALRERDAT
          MOVE      DEPTCODE,ALRERDEP
          MOVE      DEPTCODE,ALREDEPT
.
          MATCH     Z70,ALENC115
          IF        !@EQUAL
            MOVE      ALENC115,ALRECOMP
          ENDIF
.
          MATCH     Z70,ALENC004
          IF        !@EQUAL
            MOVE      ALENC004,ALREHCP
          ENDIF
.
          MOVE      PVIDATE,ALREDREC
.
          MATCH     Z70,ALENC003
          IF        !@EQUAL
            MOVE      ALENC003,ALRECTYP
          ENDIF
.
          MOVE      PVIDATE,ALRECDAT
          CLOCK     TIME,ALRECTIM
          MOVE      USERID,ALRECUID
          MOVE      ALDEHOSP,ALREHOSN
.
          CALL      ALJOBN00                * Check if a job number is needed
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAALREF2                
          IF        OVRCD=1
            CALL      ARMHI000              * Set to 'Unsent' - MHINC extract
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN2,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII12              * broadcast Add Referral (REF^I12)
.
.           Non-VINAH referrals only?
.
            MATCH     "1",NONVINAH
            IF        @EQUAL
              MOVE      ONE,ALRENVIN
            ENDIF
.
            CALL      WRALREF2              * Writes to referral table
          ENDIF
.
          CALL      CLALLSTS
          MOVE      ADMISSNO,ALSTVISN
          MOVE      "1",ALSTSTAT
          MOVE      PVIDATE,ALSTSDAT
          MOVE      PVIDATE,ALSTCDAT
          CLOCK     TIME,ALSTCTIM
          MOVE      USERID,ALSTCUID
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT,SP70
          CALL      RAALSTS1              * Writes to referral status history
          IF        OVRCD=1
            CALL      WRALSTS1            * Writes to referral status history
          ENDIF
.
          CALL      CLALLAUD
          MOVE      ADMISSNO,ALAUVISN
          MOVE      PVIDATE,ALAUADAT
          CLOCK     TIME,ALAUATIM
          MOVE      USERID,ALAUAUID
          MOVE      SP70,ALAUACTI
          MOVE      "A",ALAUUPDT
          MOVE      SP70,ALAUCOMM
          PACK      KEY24,ADMISSNO,ALAUADAT,ALAUATIM,SP70
          CALL      RAALAUD1                * Writes to referral audit table
          IF        OVRCD=1
            CALL      WRALAUD1                * Writes to referral audit table
          ENDIF
.
          MOVE      ONE,AUDTTYPE            * write history record
          CALL      WAALRE00
.
          RETURN
.------------------------------------------------------------
. Get SLA/ASGC code from ibapostf
.------------------------------------------------------------
GTASGC00  MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,GTASGC99
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
GTASGC99  RETURN
.******************************************************************************
.*                      Main Action Routine for Non U/R Activities            *
.******************************************************************************
ALLNUR00  MATCH     SP70,UPDATETY
          GOTO      ALLNUR40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add non U/R Activity
          GOTO      ALLNUR10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update U/R activity
          GOTO      ALLNUR20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete U/R activity
          GOTO      ALLNUR30 IF EQUAL
.
          GOTO      ALLNUR95
.
.        *************ADD FORMACTION*************
.
ALLNUR10  CALL      CLRACT00                * clearing all file variables
          CALL      SAVACT00                * moving cgi var to file variables
          UNPACK    ALLACTKE,ALACDEPT,ALACDOCT,ALACCODT
.
          PACK      KEY29,ALACDEPT,ALACCODT,ALACT004,ALACDOCT
          CALL      RDALACT1
          COMPARE   ONE,OVRCD
          GOTO      ALLNUR97 IF NOT EQUAL
.
          MOVE      "0",ALACSTAT
          MOVE      CTIMEIS,ALACCTIM
          REP       " 0",XCDATE
          MOVE      XCDATE,ALACCDAT
          MOVE      USERID,ALACCUID
.
          CALL      WRALACT1                * writing record into allactaf
.
          MOVE      ZERO,EXIT
          GOTO      ALLNUR99
.
.       *************UPDATE FORMACTION******************
.
ALLNUR20  PACK      KEY29,ALLACTKY,SP70
          CALL      RDALACT1                * reading the record to update
          BRANCH    OVRCD,ALLNUR96
.
          CALL      SAVACT00                * moving cgi var to file variables
.
          UNPACK    ALLACTKY,ALACDEPT,ALACCODT,ALACCOTM,ALACDOCT
          MOVE      CTIMEIS,ALACUTIM
          REP       " 0",XCDATE
          MOVE      XCDATE,ALACUDAT
          MOVE      CTIMEIS,ALACUTIM
          MOVE      USERID,ALACUUID
.
          CALL      UPALACT1                * calling update routine
.
          MOVE      ZERO,EXIT
          GOTO      ALLNUR99
.
.        ************DELETE FORMACTION***************
.
ALLNUR30  PACK      KEY29,ALLACTKY,SP70     * packing key29 to delete
          CALL      DEALACT1                * deleting the redord
.
          MOVE      ZERO,EXIT
          GOTO      ALLNUR99
.
.       ***************DISPLAY FORMACTION***************
.
ALLNUR40  CALL      CLALLACT
          MOVE      DEPTCODE,ALACDEPT
          MOVE      DOCTCODE,ALACDOCT
          MOVE      LASTDATE,ALACCODT
          MOVE      SP70,ALACLOCA
          MOVE      SP70,ALACSERV
          MATCH     ALLACTKY,SP70
          GOTO      ALLNUR50 IF EQUAL
.
          MOVE      ALLACTKY,KEY29
          CALL      RDALACT1
          BRANCH    OVRCD,ALLNUR96
.
ALLNUR50  CLEAR     WEBTITLE
          MOVE      "Allied Health Referral Information",WEBTITLE
          RESET     WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00
.
. Following Requires Clarification from SB
.          MATCH     SP70,DOCTCODE
.          IF        @EQUAL
.            MOVE      WBSEDOCT,DOCTCODE
.          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        @EQUAL
            MOVE      WBSEDALL,DEPTCODE
          ENDIF
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,ALLNUR99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLNUR99
.
.        *********** ERROR MESSAGES **************
.
ALLNUR95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNUR99
.
ALLNUR96  MOVE      "Record does not exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNUR99
.
ALLNUR97  CLEAR     WEBTITLE
          APPEND    "Record already exists for this service ",WEBTITLE
          APPEND    "provider, date and time.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLNUR99
.
ALLNUR99  RETURN
.
.******************************************************************************
.*            Main Action Routine for bulk encounters without referral        *
.******************************************************************************
ALLBNR00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ALLBNR20 IF EQUAL
          GOTO      ALLBNR95
.
.       ************Display Bulk Encounters With No Referral***********
.
ALLBNR20  CALL      CURPER00
          CALL      CALCDT00
.
          MATCH     SP70,DEPTCODE
          IF        @EQUAL
            MOVE      WBSEDALL,DEPTCODE
          ENDIF
.
          MOVE      "Allied Health Contacts",WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,ALLNRF99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLBNR99
.
.      ************ERROR HANDLING************
.
ALLBNR93  MOVE      "Must have a referral for this department",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBNR99
.
ALLBNR94  MOVE      "Invalid Security.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBNR99
.
ALLBNR95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBNR99
.
ALLBNR96  MOVE      "Department Code can't be blank",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBNR99
.
ALLBNR97  MOVE      "U/R Number can't be blank",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBNR99
.
ALLBNR98  MOVE      "You must have a valid U/R and this to be merged",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBNR99
.
ALLBNR99  RETURN
.
.******************************************************************************
.*                 Main Action Routine for bulk encounters without referral    *
.******************************************************************************
ALLBRF00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ALLBRF20 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Encounter
          GOTO      ALLBRF10 IF EQUAL
.
.******************************************************************************
.*         Add Bulk Encounters With Referral
.******************************************************************************
ALLBRF10
          GOTO      ALLBRF99
.
.******************************************************************************
.*         Display Bulk Encounters With Referral
.******************************************************************************
ALLBRF20  CLEAR     WEBTITLE
          RESET     WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00
.
          MOVE       TEMPLATE,F1            * Setting the title for the frame
          IF        F1=2
           MOVE      "CG",KEY2
           PACK      KEY5,KEY2,DEPTCODE,SP70
           CALL      RDCODE1
           BRANCH    OVRCD,ALLREF99
           MOVE      "EOC",KEY9
           CLEAR     WEBTITLE
           PACK      WEBTITLE,TDESC,SP1,KEY9
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        @EQUAL
            MOVE      WBSEDALL,DEPTCODE
          ENDIF
.
          MOVE      TEMPLATE,F1             * Add bulk enc NZ only
          IF        F1=5 & PTCNHDPS=1
            MATCH     SP70,DOCTCODE
            IF        @EQUAL
              MOVE      WBSEDOC,DOCTCODE
            ENDIF    
          ENDIF     
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,ALLBRF99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLBRF99
.
ALLBRF99  RETURN
.
.******************************************************************************
.*                      Generating The Visit Number                           *
.
.******************************************************************************
NXTA0000  READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,AADMNO
          ELSE
            MOVE      " 10",PRXCODE   * System Lock Sector 10
            CALL      GETSLK00        * Get System Lock of Sector 10
            READ      CONTROLF,TEN;*1,FORM8V
            ADD       ONE,FORM8V
            WRITAB    CONTROLF,TEN;*1,FORM8V
            CALL      RELSLK00        * Release System Lock of Sector 10
            SUB       ONE,FORM8V
            MOVE      FORM8V,AADMNO
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDAVISA1
          COMPARE   ZERO,OVRCD
          GOTO      NXTA0000 IF EQUAL       * get the next Admission Number 
.
          PACK      KEY8,AADMNO
          CALL      RAALREF1
          COMPARE   ZERO,OVRCD
          GOTO      NXTA0000 IF EQUAL
          MOVE      AADMNO,ADMISSNO
.
NXTA9999  RETURN
.
.******************************************************************************
.*                       Generating Unique Identifier(PRHDUNQ not existing)   *
.******************************************************************************
NXTU0000  MOVE      " 33",PRXCODE   * System Lock Sector 33
          CALL      GETSLK00        * Get System Lock of Sector 33
          READ      CONTROLF,THIRTY3;*172,PRCNUNIQ
          ADD       ONE,PRCNUNIQ
          WRITAB    CONTROLF,THIRTY3;*172,PRCNUNIQ
          CALL      RELSLK00        * Release System Lock of Sector 33
          SUB       ONE,PRCNUNIQ
          MOVE      PRCNUNIQ,UNIQID
          GOTO      NXTU9999
.
NXTU0010  READ      CONTROLF,THIRTY3;*150,PRCNMABI
          GOTO      NXTU9999
.
NXTU0020  READ      CONTROLF,THIRTY3;*144,PRCNWCOM
          GOTO      NXTU9999
.
NXTU0030  READ      CONTROLF,THIRTY3;*156,PRCNVAIN
          GOTO      NXTU9999
.
NXTU0040  MOVE      " 33",PRXCODE   * System Lock Sector 33
          CALL      GETSLK00        * Get System Lock of Sector 33
          READ      CONTROLF,THIRTY3;*182,PRCNUNCL
          ADD       ONE,PRCNUNCL
          WRITAB    CONTROLF,THIRTY3;*182,PRCNUNCL
          CALL      RELSLK00        * Release System Lock of Sector 33
          SUB       ONE,PRCNUNCL
          MOVE      PRCNUNCL,PRHRUNCL
          GOTO      NXTU9999
.
NXTU9999  RETURN
.
.******************************************************************************
.*                      Process Fields in Body of HTML Template               *
.******************************************************************************
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD99,PROFLD99,PROFLD80,PROFLD99,PROFLD99:
                             PROFLD99,PROFLD99,PROFL130,PROFL140,PROFL150:
                             PROFL160,PROFL170,PROFL180
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18,PROFLD19,PROFL191
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFLD13  CALL      ALEN0000
          GOTO      PROFLD99
.
PROFLD14  CALL      AREF0000
          GOTO      PROFLD99
.
PROFLD15  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD16  CALL      VXTF0000
          GOTO      PROFLD99
.
PROFLD17  CALL      ALER0000
          GOTO      PROFLD99
.
PROFLD18  CALL      CLAMB000
          GOTO      PROFLD99
.
PROFLD19  CALL      CLMF0000           * I-41539 TAC Claim Details
          GOTO      PROFLD99
.
PROFL191  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23,PROFLD24,PROFLD25:
                             PROFLD26
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD23  CALL      ALEN0000
          GOTO      PROFLD99
.
PROFLD24  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD25  CALL      VXTF0000
          GOTO      PROFLD99
.
PROFLD26   CALL     ANRF0000
           GOTO     PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34
          GOTO      PROFLD99
.
PROFLD31  CALL      ANUR0000                * calling the routine to get flds
          GOTO      PROFLD99
.
PROFLD32  CALL      ALAC0000                * calling the common tm routine
          GOTO      PROFLD99
.
PROFLD33  CALL      DOCF0000
          GOTO      PROFLD99
.
PROFLD34  PACK      DIM3,DEPTCODE,SP70
          CALL      ALDEDT00
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44,PROFLD45:
                             PROFLD46
          GOTO      PROFLD99
.
PROFLD41  CALL      ABNR0000
          GOTO      PROFLD99
.
PROFLD42  CALL      ALEN0000
          GOTO      PROFLD99
.
PROFLD43  MOVE      DEPTCODE,ALACDEPT
          CALL      ALAC0000
          GOTO      PROFLD99
.
PROFLD44  PACK      DIM3,ALREDEPT,SP70
          CALL      ALDEDT00
          GOTO      PROFLD99
.
PROFLD45  CALL      AREF0000
          GOTO      PROFLD99
.
PROFLD46  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53,PROFLD54,PROFLD55:
                             PROFLD56,PROFLD57
          GOTO      PROFLD99
.
PROFLD51  CALL      ABRF0000
          GOTO      PROFLD99
.
PROFLD52  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFLD53  CALL      ALEN0000
          GOTO      PROFLD99
.
PROFLD54  CALL      DOCF0000
          GOTO      PROFLD99
.
PROFLD55  PACK      DIM3,DEPTCODE,SP70
          CALL      ALDEDT00
          GOTO      PROFLD99
.
PROFLD56  CALL      AREF0000
          GOTO      PROFLD99
.
PROFLD57  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84
          GOTO      PROFLD99
.
PROFLD81  CALL      ABAF0000
          GOTO      PROFLD99
.
PROFLD82  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFLD83  CALL      ALEN0000
          GOTO      PROFLD99
.
PROFLD84  CALL      DOCF0000
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131,PROFL132,PROFL133,PROFL134,PROFL135:
                             PROFL136
          GOTO      PROFLD99
.
PROFL131  CALL      ABNR0000
          GOTO      PROFLD99
.
PROFL132  CALL      ALEN0000
          GOTO      PROFLD99
.
PROFL133  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL134  CALL      AREF0000
          GOTO      PROFLD99
.
PROFL135  PACK      DIM3,DEPTCODE,SP70
          CALL      ALDEDT00
          GOTO      PROFLD99
.
PROFL136  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142,PROFL143,PROFL144
          GOTO      PROFLD99
.
PROFL141  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL142  CALL      ALEM0000
          GOTO      PROFLD99
.
PROFL143  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFL144  CALL      AREF0000
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151,PROFL152,PROFL153,PROFL154
          GOTO      PROFLD99
.
PROFL151  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL152  CALL      ALIV0000
          GOTO      PROFLD99
.
PROFL153  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFL154  CALL      AREF0000
          GOTO      PROFLD99
.
PROFL160  BRANCH    FLDSETNO,PROFL161,PROFL162,PROFL163
          GOTO      PROFLD99
.
PROFL161  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL162  CALL      ALRA0000
          GOTO      PROFLD99
.
PROFL163  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL170  BRANCH    FLDSETNO,PROFL171,PROFL172,PROFL173,PROFL174
          GOTO      PROFLD99
.
PROFL171  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL172  CALL      ALSP0000
          GOTO      PROFLD99
.
PROFL173  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFL174  CALL      AREF0000
          GOTO      PROFLD99
.
PROFL180  BRANCH    FLDSETNO,PROFL181,PROFL182,PROFL183,PROFL184,PROFL185
          GOTO      PROFLD99
.
PROFL181  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL182  CALL      PMEN0000
          GOTO      PROFLD99
.
PROFL183  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL184  CALL      MISF0000
          GOTO      PROFLD99
.
PROFL185  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.******************************************************************************
.*        Miscellaneous processing code                                       *
.******************************************************************************
AREF0000  BRANCH    FLDITMNO,AREF0100,AREF0200,AREF0300,AREF0400,AREF0500:
                             AREF0600,AREF0700,AREF0800,AREF0900,AREF1000:
                             AREF1100,AREF1200,AREF1300,AREF1400,AREF1500:
                             AREF1600,AREF1700,AREF1800,AREF1900,AREF2000:
                             AREF2100,AREF2200,AREF2300,AREF2400,AREF2500:
                             AREF2600,AREF2700,AREF2800,AREF2900,AREF3000:
                             AREF3100,AREF3200,AREF3300,AREF3400,AREF3500:
                             AREF3600,AREF3700
.
          WRITE     HTMLFILE;"Invalid IBA Tag - AREF0000";
          GOTO      AREF9999
.
AREF0100  MOVE      ZERO,RELINK
          CALL      EVTH0000                * Event Table Output
          MOVE      ZERO,WAHEALTH           * set wahealth layout to no
          MOVE      ZERO,XFORMAT
          CALL      WRSE0000
          GOTO      AREF9999
.
AREF0200  PACK      KEY3,ALREDEPT
          CALL      RDALDEP1
          BRANCH    OVRCD,AREF9999
          WRITE     HTMLFILE;ALDEBILL;
          GOTO      AREF9999
.
AREF0300  WRITE     HTMLFILE;ALRESTAT;
          GOTO      AREF9999
.
AREF0400  WRITE     HTMLFILE;ENCOUTKY;
          GOTO      AREF9999
.
AREF0500  CALL      DLNVIS00                * Get Default Linked Visit Number
          GOTO      AREF9999
.
AREF0600  MOVE      SP70,KEY16
          CALL      RDSINSR1
AREF0601  CALL      RDKINSR1
          BRANCH    OVRCD,AREF9999
          MATCH     "1",PTINACTV            * (1=inactive)            *I-169939
          GOTO      AREF0601 IF EQUAL                                 *I-169939
          WRITE     HTMLFILE;"<option value=",ICODE," >":
                                  INAME,"</option>"
          GOTO      AREF0601
.
AREF0700  PACK      KEY3,ALREDEPT
          CALL      RDALDEP1
          BRANCH    OVRCD,AREF9999
          WRITE     HTMLFILE;ALDEUY1;       * Using ERC Labels
          GOTO      AREF9999
.
AREF0800  CALL      REFCTY00
          GOTO      AREF9999
.
AREF0900  WRITE     HTMLFILE;PTCNUEOC;      * Using episode of care
          GOTO      AREF9999
.
AREF1000  CALL      NXTGRP00
          GOTO      AREF9999
.
AREF1100  CALL      PRVGRP00
          GOTO      AREF9999
.
AREF1200  PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,AREF1205
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          GOTO      AREF1205 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALRLVISN;           * linked to a SACS referral
          GOTO      AREF9999
.
AREF1205  WRITE     HTMLFILE;SP1;          * Not linked to a SACS referral
          GOTO      AREF9999
.
AREF1300  CALL      RADM0000               * residential admission list
          GOTO      AREF9999
.
AREF1400  CALL      LINKT000               * Display linked outpatient visits
          GOTO      AREF9999
.
AREF1500  WRITE     HTMLFILE;SHWUPDAT;
          GOTO      AREF9999
.
AREF1600  WRITE     HTMLFILE;BULKENCK;
          GOTO      AREF9999
.
AREF1700  CALL      LGRP0000               * List group contacts by referral
          GOTO      AREF9999
.
AREF1800  PACK      KEY24,ENCOUTKY,Z70      * Medications
          CALL      ENCMED00                * see if any Medications
          WRITE     HTMLFILE;ENCMEDIC;      * set indicator
          GOTO      AREF9999
.
AREF1900  PACK      KEY24,ENCOUTKY,Z70      * Interventions
          CALL      ENCINT00                * see if any Interventions
          WRITE     HTMLFILE;ENCINTEV;
          GOTO      AREF9999
.
AREF2000  PACK      KEY24,ENCOUTKY,Z70      * Supplies
          CALL      ENCSUP00                * see if any Supplies
          WRITE     HTMLFILE;ENCSUPLY;
          GOTO      AREF9999
.
AREF2100  WRITE     HTMLFILE;PRIMARYE;
          GOTO      AREF9999
.
AREF2200  WRITE     HTMLFILE;ENCOUTK2;
          GOTO      AREF9999
.
AREF2300  MOVE      ONE,WAHEALTH            * wahealth layout
          MOVE      ZERO,XFORMAT
          MOVE      ZERO,RELINK
          CALL      WRSE0000                * Event Table Output
          GOTO      AREF9999
.
AREF2400  PACK      KEY3,ALREDEPT
          CALL      RDALDEP1
          BRANCH    OVRCD,AREF9999
.
          WRITE     HTMLFILE;ALDEUEME;      * Using Encounter Medications
          GOTO      AREF9999
.
AREF2500  PACK      KEY3,ALREDEPT
          CALL      RDALDEP1
          BRANCH    OVRCD,AREF9999
.
          WRITE     HTMLFILE;ALDEUEIN;      * Using Encounter Interventions
          GOTO      AREF9999
.
AREF2600  PACK      KEY3,ALREDEPT
          CALL      RDALDEP1
          BRANCH    OVRCD,AREF9999
.
          WRITE     HTMLFILE;ALDEUESU;      * Using Encounter Supplies
          GOTO      AREF9999
.
AREF2700  MOVE      ZERO,WAHEALTH           * wahealth layout = No
          MOVE      ONE,XFORMAT             * JSON Type Format t.addRow
          MOVE      ZERO,RELINK
          CALL      WRSE0000                * Event Table Output
          GOTO      AREF9999
.
AREF2800  MOVE      ONE,RELINK
          CALL      EVTH0000                * Event Table Output with relink
          MOVE      ZERO,WAHEALTH           * set wahealth layout to no
          MOVE      ZERO,XFORMAT
          CALL      WRSE0000
          GOTO      AREF9999
.
AREF2900  MOVE      ONE,FRSTREAD
          PACK      KEY8,ALREDEPT,CATgb,SP70
          CALL      RSALCCT1
AREF2901  CALL      RKALCCT1
          IF        OVRCD=1
            IF        FRSTREAD=1
              GOTO      AREF2902
            ELSE
              GOTO      AREF9999
            ENDIF
          ENDIF
.
          MATCH     ALREDEPT,ALCCDEPT
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      AREF2902
            ELSE
              GOTO      AREF9999
            ENDIF
          ENDIF
.
          MATCH     CATgb,ALCCTYPE
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      AREF2902
            ELSE
              GOTO      AREF9999
            ENDIF
          ENDIF
.
          PACK      KEY5,CATgb,ALCCCONT
          CALL      RDCODE1
.
          MATCH     "A",PTCOACTV
          GOTO      AREF2901 IF NOT EQUAL
.
          MATCH     ALRECONT,ALCCCONT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value='",ALCCCONT,"' selected>",TDESC,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",ALCCCONT,"'>",TDESC,"</option>";
          ENDIF
          MOVE      ZERO,FRSTREAD
          GOTO      AREF2901
.
AREF2902  MOVE      CATgb,CATEGORY
          MOVE      ALRECONT,CODE
          CALL      CODSEL00
          GOTO      AREF9999
.
AREF3000  MOVE      ONE,FRSTREAD
          PACK      KEY8,ALREDEPT,CATgb,SP70
          CALL      RSALCCT1
AREF3001  CALL      RKALCCT1
          IF        OVRCD=1
            IF        FRSTREAD=1
              GOTO      AREF3002
            ELSE
              GOTO      AREF9999
            ENDIF
          ENDIF
.
          MATCH     ALREDEPT,ALCCDEPT
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      AREF3002
            ELSE
              GOTO      AREF9999
            ENDIF
          ENDIF
.
          MATCH     CATgb,ALCCTYPE
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      AREF3002
            ELSE
              GOTO      AREF9999
            ENDIF
          ENDIF
.
          PACK      KEY5,CATgb,ALCCCONT
          CALL      RDCODE1
.
........  MATCH     "A",PTCOACTV                            * 0951542
.......   GOTO      AREF3001 IF NOT EQUAL                   * 0951542
.
          MATCH     ALENCONT,ALCCCONT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value='",ALCCCONT,"' selected>",TDESC,"</option>";
          ELSE
            MATCH     "A",PTCOACTV
            GOTO      AREF3001 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value='",ALCCCONT,"'>",TDESC,"</option>";
          ENDIF
          MOVE      ZERO,FRSTREAD
          GOTO      AREF3001
.
AREF3002  MOVE      CATgb,CATEGORY
          MOVE      ALENCONT,CODE
          CALL      CODSEL00
          GOTO      AREF9999
.
AREF3100  CALL      ABFH0000                * NWAU/ABF Header
          CALL      DIAB0000                * Output
          GOTO      AREF9999
.
AREF3200  CALL      DABF0000                * Display ABF/NWAU Calc.
          GOTO      AREF9999
.
AREF3300  CALL      NXTFVG00
          GOTO      AREF9999
.
AREF3400  CALL      LSTGRP00
          GOTO      AREF9999
.
AREF3500  CALL      PRVFVG00
          GOTO      AREF9999
.
AREF3600  CALL      PRVFIG00
          GOTO      AREF9999
.
AREF3700  WRITE     HTMLFILE;SRTNUMBL;
          GOTO      AREF9999
.
AREF9999  RETURN
+
.------------------------------------------------------------
. Bulk billing claim code       
.------------------------------------------------------------
CLAMB000  MOVE      SP10,PRBBCLAM
          PACK      PRHRPRAC,ALDEPRAC,SP70
          PACK      PRHRDOCT,ALENHCP,SP70
          PACK      PRHRPIND,ALENTYPE,SP70
          PACK      KEY27,ALENUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD=0
            BRANCH    PRHRPINV,CLAMB999       * Invoice to be printed
.
            PACK      KEY8,ALENUNIQ
            CALL      RDPRHD2                 * Reading prihdbtf
            BRANCH    OVRCD,CLAMB999
.
.           Get the last invoice 
.
            PACK      KEY26,PRHRPRAC,PRHRDOCT,PRHDDEBT,PRHDSCAN,SP20
            PACK      KEY34,KEY26,Z70
            CALL      RSPRIN4
            CALL      RPPRIN4
            BRANCH    OVRCD,CLAMB999
            PACK      SKEY26,PRINPRAC,PRINDOCT,PRINDEBT,PRINSCAN,SP20
            MATCH     KEY26,SKEY26
            GOTO      CLAMB999 IF NOT EQUAL
.
.           Read bulk billing record to get the claim number
.
            MOVE      ONE,PRBBSTAT
            PACK      KEY38,PRBBSTAT,PRHRBULK,PRHRBCOD,PRINNUMB,Z70
            CALL      RSPRBB3
            CALL      RPPRBB3
            BRANCH    OVRCD,CLAMB999
.
            COMPARE   ONE,PRBBSTAT
            GOTO      CLAMB999 IF NOT EQUAL    * not printed
            MATCH     PRHRBULK,PRBBBULK
            GOTO      CLAMB999 IF NOT EQUAL    * different bulk code
            MATCH     PRHRBCOD,PRBBCODE
            GOTO      CLAMB999 IF NOT EQUAL    * different insurance code
.
            WRITE     HTMLFILE;PRBBCLAM
          ENDIF
CLAMB999  RETURN
+
.------------------------------------------------------------
. Output Default Linked Visit No
.------------------------------------------------------------
DLNVIS00  MATCH     SP70,ALRELINK
          IF        !@EQUAL
            WRITE     HTMLFILE;ALRELINK;
            GOTO      DLNVIS99
          ENDIF
.                                            *  Read  Patient Visit Table
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY24,URNUMBER,KEY8,Z70
          CALL      RDSVISA2
DLNVIS10  CALL      RDPVISA2
          BRANCH    OVRCD,DLNVIS99
          MATCH     URNUMBER,PVIURNO
          GOTO      DLNVIS99 IF NOT EQUAL   * RECORD NOT FOUND
          BRANCH    PVITYPE,DLNVIS20,DLNVIS20,DLNVIS30
          GOTO      DLNVIS10
.
DLNVIS20  MATCH     PVIDATE,ALENC005
          GOTO      DLNVIS10 IF NOT EQUAL   * Date does not match
          WRITE     HTMLFILE;PVIBILL;
          GOTO      DLNVIS99
.
DLNVIS30  PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                 * Read Discharge Table
          BRANCH    OVRCD,DLNVIS99
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     PVIDATE,KEY8
          GOTO      DLNVIS10 IF LESS
          MATCH     DDATE,SP70              * Check  Patient is Not Discharged
          GOTO      DLNVIS40 IF EQUAL
          MATCH     KEY8,DDATE
          GOTO      DLNVIS10 IF LESS
.
DLNVIS40  WRITE     HTMLFILE;PVIBILL
          GOTO      DLNVIS99
.
DLNVIS99  RETURN

ANUR0000  BRANCH    FLDITMNO,ANUR0100,ANUR0200,ANUR0300,ANUR0400,ANUR0500:
                             ANUR0600,ANUR0700,ANUR0800,ANUR0900,ANUR1000:
                             ANUR1100,ANUR1200,ANUR1300,ANUR1400,ANUR1500:
                             ANUR1600,ANUR1700,ANUR1800
.
          WRITE     HTMLFILE;"Invalid Tag"
          GOTO      ANUR9999
.
ANUR0100  CALL      NEXT0000
          GOTO      ANUR9999
.
ANUR0200  CALL      PREV0000
          GOTO      ANUR9999
.
ANUR0300  CALL      CURSTD00
          GOTO      ANUR9999
.
ANUR0400  CALL      CUREND00
          GOTO      ANUR9999
.
ANUR0500  CALL      CURYR000
          GOTO      ANUR9999
.
ANUR0600  CALL      CURMON00
          GOTO      ANUR9999
.
ANUR0700  CALL      SELV0000
          GOTO      ANUR9999
.
ANUR0800  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ANUR9999
.
ANUR0900  CALL      ARFD0000
          GOTO      ANUR9999
.
ANUR1000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            CALL      ALACTB00    * Display Non U/R Activity Table by HCP
          ELSE
            MATCH     SP70,DEPTCODE
            IF        !@EQUAL
              CALL      ALBCTB00  * Display Non U/R Activity Table by Department
            ENDIF
          ENDIF
          GOTO      ANUR9999
.
ANUR1100  PACK      KEY21,DEPTCODE,DOCTCODE,LASTDATE
          WRITE     HTMLFILE;KEY21          * writing to html allactke
          GOTO      ANUR9999
.
ANUR1200  WRITE     HTMLFILE;ALLACTKY;      * writing to html allactky
          GOTO      ANUR9999
.
ANUR1300  WRITE     HTMLFILE;WBSENAM;
          GOTO      ANUR9999
.
ANUR1400  WRITE     HTMLFILE;DEPTCODE;
          GOTO      ANUR9999
.
ANUR1500  CALL      HCPCOD00
          GOTO      ANUR9999
.
ANUR1600  UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ANUR9999
.
ANUR1700  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          UNPACK    CURRDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ANUR9999
.
ANUR1800  MATCH     SP70,DEPTCODE
          GOTO      ANUR9999 IF EQUAL
          MOVE      "CG",CATEGORY
          PACK      KEY5,CATEGORY,DEPTCODE,SP70
          CALL      RDCODE1 
          BRANCH    OVRCD,ANUR9999
          WRITE     HTMLFILE;TDESC;
          GOTO      ANUR9999
.
ANUR9999  RETURN
.------------------------------------------------------------
. Output Code or Name of HCP for List Filter Display
.    Tag Parameter .0 = Code
.                  .1 = Formatted Name
.------------------------------------------------------------
HCPCOD00  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,HCPCOD10
          WRITE     HTMLFILE;DOCTCODE;
          GOTO      HCPCOD99
.
HCPCOD10  PACK      KEY10,DOCTCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,HCPCOD99
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
.
HCPCOD99  RETURN
.******************************************************************************
.*         Branching Routine for Bulk Encounter with No Referral              *
.******************************************************************************
ABNR0000  BRANCH    FLDITMNO,ABNR0100,ABNR0200,ABNR0300,ABNR0400,ABNR0500:
                             ABNR0600,ABNR0700,ABNR0800,ABNR0900,ABNR1000:
                             ABNR1100,ABNR1200,ABNR1300,ABNR1400,ABNR1500:
                             ABNR1600,ABNR1700,ABNR1800,ABNR1900,ABNR2000:
                             ABNR2100,ABNR2200,ABNR2300,ABNR2400,ABNR2500:
                             ABNR2600,ABNR2700,ABNR2800,ABNR2900,ABNR3000:
                             ABNR3100,ABNR3200,ABNR3300,ABNR3400,ABNR3500:
                             ABNR3600,ABNR3700,ABNR3800,ABNR3900,ABNR4000:
                             ABNR4100
.
          WRITE     HTMLFILE;"Invalid Tag"
          GOTO      ABNR9999
.
ABNR0100  CALL      NEXT0000
          GOTO      ABNR9999
.
ABNR0200  CALL      PREV0000
          GOTO      ABNR9999
.
ABNR0300  CALL      CURSTD00
          GOTO      ABNR9999
.
ABNR0400  CALL      CUREND00
          GOTO      ABNR9999
.
ABNR0500  CALL      CURYR000
          GOTO      ABNR9999
.
ABNR0600  CALL      CURMON00
          GOTO      ABNR9999
.
ABNR0700  CALL      SELV0000
          GOTO      ABNR9999
.
ABNR0800  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ABNR9999
.
ABNR0900  CALL      ARFD0000
          GOTO      ABNR9999
.
ABNR1000  CALL      ABPENR00                * Bulk Patient Enc. not using Ref.
          GOTO      ABNR9999
.
ABNR1100  PACK      KEY45,WBSESIT,DEPTCODE,SP70    * For Clinic type combo
          CALL      RDSCTYA4
ABNR1150  CALL      RDKCTYA4
          BRANCH    OVRCD,ABNR9999
.
          MATCH     WBSESIT,OCTSITE
          GOTO      ABNR9999 IF NOT EQUAL
.
          MATCH     OCTGRP,DEPTCODE
          GOTO      ABNR9999 IF NOT EQUAL
.
          MATCH     "1",OCTACT
          GOTO      ABNR1150 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=",OCTCTYP,">",OCTDESC,"</option>"
          GOTO      ABNR1150
.
ABNR1200  WRITE     HTMLFILE;DEPTCODE;       * Persisting deptcode
          GOTO      ANRF9999
.
ABNR1300  MOVE      "CL",CATEGORY           * Compensation code
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABNR9999
.
ABNR1400  MOVE      "GD",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABNR9999
.
ABNR1500  WRITE     HTMLFILE;URNUMBER;
          GOTO      ABNR9999
.
ABNR1600  UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ABNR9999
.
ABNR1700  MOVE      "CG",CATEGORY
          PACK      KEY5,CATEGORY,DEPTCODE,SP70
          CALL      RDCODE1
          WRITE     HTMLFILE;TDESC;
          GOTO      ABNR9999
.
ABNR1800  CALL      HCPCOD00
.          WRITE     HTMLFILE;DOCTCODE;
          GOTO      ABNR9999
.
ABNR1900  CALL      SRVSEL00
          GOTO      ABNR9999
.
ABNR2000  PACK      KEY10,DOCTCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ABNR9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME
          GOTO      ABNR9999
.
ABNR2100  MOVE      "GI",CATEGORY           * Patient type combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABNR9999
.
ABNR2200  CALL      IBACLOCK
          REP       " 0",XCDATE
          PACK      KEY24,URNUMBER,XCDATE,Z70
          CALL      RDSVISA2
ABNR2210  CALL      RDPVISA2
          BRANCH    OVRCD,ABNR9999
          MATCH     URNUMBER,PVIURNO
          GOTO      ABNR9999 IF NOT EQUAL   * Record Not Found
          BRANCH    PVITYPE,ABNR2211,ABNR2212,ABNR2213
          GOTO      ABNR2210
.
ABNR2211  GOTO      ABNR9999
.
ABNR2212  MATCH     PVIDATE,ALENC005
          GOTO      ABNR2210 IF NOT EQUAL   * Date Does'nt Match
          WRITE     HTMLFILE;PVIBILL;
          GOTO      ABNR9999
.
ABNR2213  PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                 * Read Discharge Table
          BRANCH    OVRCD,ABNR9999
          REP       " 0",XCDATE
          MATCH     PVIDATE,XCDATE
          GOTO      ABNR2210 IF LESS
          MATCH     DDATE,SP70              * Check  Patient is not Dischangred
          GOTO      ABNR2215 IF EQUAL
          MATCH     XCDATE,DDATE
          GOTO      ABNR2210 IF LESS
.
ABNR2215  WRITE     HTMLFILE;PVIBILL;
          GOTO      ABNR9999
.
ABNR2300  PACK      KEY3,DEPTCODE
          CALL      RDALDEP1
          BRANCH    OVRCD,ABNR9999
          WRITE     HTMLFILE;ALDEBILL;
          GOTO      ABNR9999
.
ABNR2400
          GOTO      ABNR9999
.
ABNR2500
          GOTO      ABNR9999
.
ABNR2600  CALL      NEXTGR00
          GOTO      ABNR9999
.
ABNR2700  CALL      PREVGR00
          GOTO      ABNR9999
.
ABNR2800
          GOTO      ABNR9999
.
ABNR2900
          GOTO      ABNR9999
.
ABNR3000  WRITE     HTMLFILE;BULKENCK;
          GOTO      ABNR9999
.
ABNR3100  PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ABNR9999
.
          WRITE     HTMLFILE;ALDEBILL;
          GOTO      ABNR9999
.
ABNR3200  WRITE     HTMLFILE;SHWUPDAT;
          GOTO      ABNR9999
.
ABNR3300  WRITE     HTMLFILE;ENCOUTKY;
          GOTO      ABNR9999
.
ABNR3400  MOVE      "CV",CATEGORY           
          MOVE      VISITTYP,CODE
          CALL      CODITM00
          GOTO      ABNR9999
.
ABNR3500  WRITE     HTMLFILE;ADMISSNO;
          GOTO      ABNR9999
.
ABNR3600  MOVE      "CG",CATEGORY
          MOVE      DEPTCODE,CODE
          CALL      CODITM00
          GOTO      ABNR9999
.
ABNR3700  WRITE     HTMLFILE;NONVINAH;
          GOTO      ABNR9999
.
ABNR3800  WRITE     HTMLFILE;LINKOPCT;  * Linked OP booking check in time
          GOTO      ABNR9999
.
ABNR3900  WRITE     HTMLFILE;LINKVTYP;  * Linked OP booking visit type
          GOTO      ABNR9999
.
ABNR4000  WRITE     HTMLFILE;LINKSKEY;  * Linked OP booking session key
          GOTO      ABNR9999
.
ABNR4100  MOVE      "CV",CATEGORY       * Linked OP booking visit type
          MOVE      LINKVTYP,CODE
          CALL      CODITM00
          GOTO      ABNR9999
ABNR9999  RETURN
.
.******************************************************************************
.*         Branching Routine for Bulk Encounter with  Referral.             *
.*******************************************************************************
ABRF0000  BRANCH    FLDITMNO,ABRF0100,ABRF0200,ABRF0300,ABRF0400,ABRF0500:
                             ABRF0600,ABRF0700,ABRF0800,ABRF0900,ABRF1000:
                             ABRF1100,ABRF1200,ABRF1300,ABRF1400,ABRF1500:
                             ABRF1600,ABRF1700,ABRF1800,ABRF1900,ABRF2000:
                             ABRF2100,ABRF2200,ABRF2300,ABRF2400,ABRF2500:
                             ABRF2600,ABRF2700,ABRF2800,ABRF2900,ABRF3000:
                             ABRF3100,ABRF3200,ABRF3300,ABRF3400,ABRF3500
.
          WRITE     HTMLFILE;"Invalid IBA Tag - ABRF0000"
          GOTO      ABRF9999
.
ABRF0100  CALL      NEXT0000
          GOTO      ABRF9999
.
ABRF0200  CALL      PREV0000
          GOTO      ABRF9999
.
ABRF0300  CALL      CURSTD00
          GOTO      ABRF9999
.
ABRF0400  CALL      CUREND00
          GOTO      ABRF9999
.
ABRF0500  CALL      CURYR000
          GOTO      ABRF9999
.
ABRF0600  CALL      CURMON00
          GOTO      ABRF9999
.
ABRF0700  CALL      SELV0000
          GOTO      ABRF9999
.
ABRF0800  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ABRF9999
.
ABRF0900  CALL      ARFD0000
          GOTO      ABRF9999
.
.   **************Display Patient Encounters Using Referal Table(5th rep)*******
.
ABRF1000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Number of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY42,USERID,LASTDATE,Z70 * Pack userid to read allencaf
          CALL      RSALENC5                * Call Positional read routine
ABRF1010  CALL      RPALENC5                * Call Sequential read
          BRANCH    OVRCD,ABRF9999
.
          MATCH     USERID,ALENCUID
          GOTO      ABRF9999 IF NOT EQUAL   * Exit if Web user id doesn't match
.
          MATCH     FRSTDATE,ALENSDAT       * Checks lastdate with Servicedate
          GOTO      ABRF9999 IF LESS
.
.         MATCH     SP70,DOCTCODE
.         IF        !@EQUAL
.           MATCH     DOCTCODE,ALENHCP        * Match HCP code
.           GOTO      ABRF1010 IF NOT EQUAL
.         ENDIF
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reads allrefaf to get UR no
          BRANCH    OVRCD,ABRF1010
.
          COMPARE   ONE,FILTRHCP
          IF        !@EQUAL
            CALL      INDHCP00
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALENHCP
              GOTO      ABRF1015 IF EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      ABRF1015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      ABRF1015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      ABRF1015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      ABRF1015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      ABRF1015 IF EQUAL
              GOTO      ABRF1010
            ELSE
              MATCH     DOCTCODE,ALENHCP        * Match HCP code
              GOTO      ABRF1010 IF NOT EQUAL
            ENDIF
          ENDIF
.
ABRF1015  MATCH     SP70,DEPTCODE             * Check Department
          IF        !@EQUAL
            MATCH     ALREDEPT,DEPTCODE
            GOTO      ABRF1010 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Reads patma1af to get patient Name
          BRANCH    OVRCD,ABRF1010
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21                
          BRANCH    OVRCD,ABRF1010
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * Returns formatted name(FORMATNM)
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO    ABRF1010                * If < than strt Rec then Read Next
          ENDIF
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1                * Read pmshcpaf file
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE       * Move Title
            MOVE      PMHCGNAM,FMTGNAME       * Move First Name
            MOVE      PMHCSNAM,FMTSNAME       * Move Last Name
            CALL      DOCNM000                * Returns Formatted name(DOCFNAME)
          ELSE
            MOVE      "Invalid HCP",DOCFNAME
          ENDIF
.
          MOVE      "GI",CATEGORY
          MOVE      ALENTYPE,CODE
          CALL      GETCOD00                * Get Patient type Description
          MOVE      TDESC,PATNDESC          * Patient Description
.
          MOVE      "LD",CATEGORY
          MOVE      ALACLOCA,CODE
          CALL      GETCOD00                * To get Locatin Desc(TDESC)
          MOVE      TDESC,LOCNDESC          * Location Description
.
          PACK      ENCOUTKY,ALENVISN,ALENENCT

          MATCH     "1",ALENRSTA
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<a HREF ='javascript:EncounterLink":
                             "(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&encoutky=",ENCOUTKY:
                             "#");'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALENSTIM,STRENDTG,"</td>";
.
                    MATCH     "1",DOCINDIC
                    IF        @EQUAL
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    DOCFNAME,"&nbsp","<br>",DOCFNAM3,"&nbsp","<br>",DOCFNAM4,"&nbsp","<br>",DOCFNAM5,"&nbsp","<br>",DOCFNAM6,"&nbsp",STRENDTG,"</td>";
                    ELSE
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    DOCFNAME,"&nbsp",STRENDTG,"</td>";
                    ENDIF
.
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    FORMATNM,"&nbsp",STRENDTG,"</td>":
                             "<td align=center>",STRIKETG:
                                    ALENVISN,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    PATNDESC,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDIUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDBUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENINUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENIBUN,"&nbsp",STRENDTG,"</td></tr>";
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          CALL      ABRF1010 IF NOT EQUAL
.
          GOTO      ABRF9999
.
ABRF1100  PACK      KEY15,WBSESIT,DEPTCODE,SP70
          CALL      RDSCTYA3
ABRF1150  CALL      RDKCTYA3
          BRANCH    OVRCD,ABRF9999
          MATCH     WBSESIT,OCTSITE
          GOTO      ABRF9999 IF NOT EQUAL
.
          MATCH     OCTGRP,DEPTCODE
          GOTO      ABRF9999 IF NOT EQUAL
.
          MATCH     "1",OCTACT
          GOTO      ABRF1150 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=",QUOTE,OCTCTYP,QUOTE,">",OCTDESC,"</option>"
          GOTO      ABRF1150
.
ABRF1200  MOVE      "GI",CATEGORY           * Patient Type Combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABRF9999
.
ABRF1300  MOVE      "CL",CATEGORY           * Compensation Code Combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABRF9999
.
ABRF1400  MOVE      "GD",CATEGORY           * Bulk Billing code combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABRF9999
.
ABRF1500  MOVE      "LL",CATEGORY           * Reason For Closure
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABRF9999
.
ABRF1600  UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ABRF9999
.
ABRF1700  WRITE     HTMLFILE;DEPTCODE;      * Department Code
          GOTO      ABRF9999
.
ABRF1800  MATCH     SP70,DEPTCODE
          GOTO      ABRF9999 IF EQUAL
          MOVE      "CG",KEY2               * Department Description
          PACK      KEY5,KEY2,DEPTCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ABRF9999
          WRITE     HTMLFILE;TDESC
          GOTO      ABRF9999
.
ABRF1900  PACK      KEY10,DOCTCODE,SP70     * Service Provider
          CALL      RDPMHCP1
          BRANCH    OVRCD,ABRF9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME
          GOTO      ABRF9999
.
ABRF2000  CALL      SRVSEL00
          GOTO      ABRF9999
.
ABRF2100  RESET     ALRELINK
          MATCH     ALRELINK,SP70
          GOTO      ABRF2150 IF NOT EQUAL
.                                            *  READ  PATIENT VISIT TABLE
          CALL      IBACLOCK
          REP       " 0",XCDATE
          PACK      KEY24,URNUMBER,XCDATE,Z70
          CALL      RDSVISA2
ABRF2110  CALL      RDPVISA2
          BRANCH    OVRCD,ABRF9999
          MATCH     URNUMBER,PVIURNO
          GOTO      ABRF9999 IF NOT EQUAL   * RECORD NOT FOUND
          BRANCH    PVITYPE,ABRF2111,ABRF2112,ABRF2113
          GOTO      ABRF2110
.
ABRF2111
ABRF2112  MATCH     PVIDATE,ALENC005
          GOTO      ABRF2110 IF NOT EQUAL   * DATE DOES'NT MATCH
          WRITE     HTMLFILE;PVIBILL
          GOTO      ABRF9999
.
ABRF2113  PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                 * READ DISCHARGE TABLE
          BRANCH    OVRCD,ABRF9999
          REP       " 0",XCDATE
          MATCH     PVIDATE,XCDATE
          GOTO      ABRF2110 IF LESS
          MATCH     DDATE,SP70              * CHECK  PATIENT IS NOT DISCHARGED
          GOTO      ABRF2115 IF EQUAL
          MATCH     XCDATE,DDATE
          GOTO      ABRF2110 IF LESS
ABRF2115  WRITE     HTMLFILE;PVIBILL
          GOTO      ABRF9999
.
ABRF2150  WRITE     HTMLFILE;ALRELINK
          GOTO      ABRF9999
.
ABRF2200  PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ABRF9999
          WRITE     HTMLFILE;ALDEBILL
          GOTO      ABRF9999
.
ABRF2300  CALL      REFN0000
          GOTO      ABRF9999
.
ABRF2400  CALL      PREVPR00
          GOTO      ABRF9999
.
ABRF2500  CALL      NEXTPR00
          GOTO      ABRF9999
.
ABRF2600  CALL      PHOT0000
          GOTO      ABRF9999
.
ABRF2700
          GOTO      ABRF9999
.
ABRF2800
          GOTO      ABRF9999
.
ABRF2900
          GOTO      ABRF9999
.
ABRF3000  CALL      PREVGR00
          GOTO      ABRF9999
.
ABRF3100  CALL      NEXTGR00
          GOTO      ABRF9999
.
ABRF3200  CALL      HCPCOD00
.          WRITE     HTMLFILE;DOCTCODE
          GOTO      ABRF9999
.
ABRF3300  MOVE      ZERO,NZLAYOUT
          CALL      BENC0000                * Bulk Enc List
          GOTO      ABRF9999
.
ABRF3400  MOVE      ONE,NZLAYOUT
          CALL      BENC0000                * Bulk Enc List
          GOTO      ABRF9999
.
ABRF3500  UNPACK    ADDCNDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ABRF9999
.
ABRF9999  RETURN
.*****************************************************************************
.*                    Process Miscellaneous fields                           *
.*****************************************************************************
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900,MISC1000:
                             MISC1100,MISC1200,MISC1300,MISC1400,MISC1500:
                             MISC1600,MISC1700,MISC1800,MISC1900,MISC2000:
                             MISC2100,MISC2200,MISC2300,MISC2400,MISC2500:
                             MISC2600,MISC2700,MISC2800,MISC2900,MISC3000:
                             MISC3100,MISC3200,MISC3300,MISC3400,MISC3500:
                             MISC3600
          GOTO      MISC9999
.
MISC0100  MATCH     SP70,DEPTCODE
          GOTO      MISC9999 IF EQUAL
.
          MOVE      "CG",CATEGORY
          MOVE      DEPTCODE,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC0200  PACK      KEY24,ALENVISN,ALENENCT,SP70
          CALL      RSALSUP1
          CALL      RKALSUP1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ALENVISN,ALSPVISN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ALENENCT,ALSPENCT
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
          GOTO      MISC9999
.
MISC0300  PACK      KEY24,ALENVISN,ALENENCT,SP70
          CALL      RSALITV1
          CALL      RKALITV1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ALENVISN,ALIVVISN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ALENENCT,ALIVENCT
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
          GOTO      MISC9999
.
MISC0400  PACK      KEY24,ALENVISN,ALENENCT,SP70
          CALL      RSALEMD1
          CALL      RKALEMD1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ALENVISN,ALEMVISN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ALENENCT,ALEMENCT
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
          GOTO      MISC9999
.
MISC0500  CALL      LNKCTY00
          GOTO      MISC9999
.
MISC0600  MOVE      ONE,FORM1
          CALL      PRVENC00
          GOTO      MISC9999
.
MISC0700  MOVE      TWO,FORM1
          CALL      PRVENC00
          GOTO      MISC9999
.
MISC0800  MOVE      THREE,FORM1
          CALL      PRVENC00
          GOTO      MISC9999
.
MISC0900  MOVE      FOUR,FORM1
          CALL      PRVENC00
          GOTO      MISC9999
.
MISC1000  MOVE      FIVE,FORM1
          CALL      PRVENC00
          GOTO      MISC9999
.
MISC1100  MOVE      SIX,FORM1
          CALL      PRVENC00
          GOTO      MISC9999
.
MISC1200  CALL      LNKVSO00
          GOTO      MISC9999
.
MISC1300  WRITE     HTMLFILE;LINKEDOP;
          GOTO      MISC9999
.
MISC1400  MOVE      "OZ",CATEGORY
          MOVE      OTBBOUTC,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC1500  PACK      DIM3,ALREDEPT,SP70
          CALL      ALDEDT00
          GOTO      MISC9999
.
MISC1600  MATCH     SP70,ALREURNO
          GOTO      MISC9999 IF EQUAL
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MISC9999
.
          CALL      PATNAM00
          WRITE     HTMLFILE;" - ",PATFNAME;
          GOTO      MISC9999
.
MISC1700  MATCH     SP70,ALREURNO
          GOTO      MISC9999 IF EQUAL
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;"UR: ",PURNO;
          GOTO      MISC9999
.
MISC1800  CALL      LINKW000                * Table of linked WL procedures
          GOTO      MISC9999
.
MISC1900  MOVE      "OZ",CATEGORY
          MOVE      ALENOUTC,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC2000  MATCH     SP70,DEFEDATE
          GOTO      MISC9999 IF EQUAL
          GOTO      MISC9999 IF EOS
.
          UNPACK    DEFEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC2100  WRITE     HTMLFILE;DEFETIME;
          GOTO      MISC9999
.
MISC2200  WRITE     HTMLFILE;DEFEDOCT;
          GOTO      MISC9999
.
MISC2300  CALL      ITAB0000                * IP Contact List
          GOTO      MISC9999
.
MISC2400  MATCH     SP70,ALENLINK
          GOTO      MISC9999 IF EQUAL
.
          PACK      KEY36,ALENLINK,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,MISC9999
.
          MATCH     DOBAOUTN,ALENLINK
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           * Enc linked to OP visit
          GOTO      MISC9999
.
MISC2500  PACK      KEY8,LINKEDOP,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;OBACOMP;           * Compensation Eligibility
          GOTO      MISC9999
.
MISC2600  UNPACK    DIM127,D1,KEY1,DIM127       * Default HCP Seen
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY25,LINKSKEY,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1
            IF        OVRCD<>1
              MATCH     OSESITE,OCASITE
              GOTO      MISC9999 IF NOT EQUAL
.
              MATCH     OSECLIN,OCACLIN
              GOTO      MISC9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY10,OCADOCT,SP70
.
          MATCH     SP70,OTMADEFD
          IF        !@EQUAL
            PACK      KEY10,OTMADEFD,SP70
          ENDIF
.
          MATCH     SP70,OTHEDEFD
          IF        !@EQUAL
            PACK      KEY10,OTHEDEFD,SP70
          ENDIF
.
          BRANCH    F1,MISC2610
          CALL      RDPMHCP1
          BRANCH    OVRCD,MISC9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      MISC9999
.
MISC2610  WRITE     HTMLFILE;KEY10;
          GOTO      MISC9999
.
MISC2700  PACK      KEY25,LINKSKEY,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;OTHEDURN;          * Slot duration
          GOTO      MISC9999
.
MISC2800  PACK      KEY8,LINKEDOP,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,MISC9999
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC2900  PACK      KEY8,LINKEDOP,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;OTBBASTM;           * Time Actually Seen
          GOTO      MISC9999
.
MISC3000  PACK      KEY8,LINKEDOP,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,MISC9999
.
          WRITE     HTMLFILE;OTBBDPTM;           * Time of Departure
          GOTO      MISC9999
.
MISC3100  PACK      KEY36,LINKEDOP,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,MISC9999
.
          MATCH     DOBAOUTN,LINKEDOP
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OBATIME;           * Link booking slot time
          GOTO      MISC9999
.
MISC3200  PACK      KEY36,LINKEDOP,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,MISC9999
.
          MATCH     DOBAOUTN,LINKEDOP
          GOTO      MISC9999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,MISC9999
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MISC9999
.
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
          ASSIGN    (TCFORM6 * OTHEDURN),F8
          MOVE      F8,D8
          SQUEEZE   D8
          WRITE     HTMLFILE;*+,D8;           * Link booking slot duration
          GOTO      MISC9999
.
MISC3300  PACK      KEY36,LINKEDOP,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,MISC9999
.
          MATCH     DOBAOUTN,LINKEDOP
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OBASTAT;         * Linked booking slot status
          GOTO      MISC9999
.
MISC3400  MATCH     SP70,ALREPRTY                * Check for waiting on triage
          GOTO      MISC9999 IF EQUAL            * priority
.
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ANST,TCINDC2                 * Waiting on triage
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;TDESC;
          GOTO      MISC9999
.
MISC3500  PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                     * Referral department
          BRANCH    OVRCD,MISC9999
.
          MATCH     "1",ALDEUTRS                 * Using triage status
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     SP70,ALRETRGS                * Blank triage status
          GOTO      MISC9999 IF EQUAL
.
          PACK      KEY5,CATTS,ALRETRGS,SP70
          CALL      RDCODE1                      * Read triage status
          BRANCH    OVRCD,MISC9999
.
          MATCH     "99",THCSCOD                 * Insufficient Info
          IF        !@EQUAL
            MATCH     "98",THCSCOD               * Waiting on triage
            GOTO      MISC9999 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;TDESC;
          GOTO      MISC9999
.
MISC3600  CALL      NDIS0000
.
          MATCH     "1",NDISVALD
          IF        @EQUAL
            WRITE     HTMLFILE;"1";
          ELSE
            WRITE     HTMLFILE;"0";
          ENDIF
.
          GOTO      MISC9999
.
MISC9999  RETURN
.
.*****************************************************************************
.*                           Referral Number Search                          *
.*****************************************************************************
REFN0000  CALL      RFHD0000                * Output Table Heading
          IF        NORECORD=0
            MOVE      "10",NORECORD         * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
          PACK      KEY16,STARTKEY,SP70
          CALL      RSALREF2                * Reading For the Visit No.
REFN0010  CALL      RKALREF2                * Reading From Referral Table
          BRANCH    OVRCD,REFN9999
          MATCH     ALREURNO,STARTKEY
          GOTO      REFN9999 IF NOT EQUAL
.
          MATCH     ALREDEPT,SRCHDEPT
          GOTO      REFN0010 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT           * Can only link encounters to an
          GOTO      REFN1000 IF EQUAL      * active or waiting referral
.
          MATCH     "1",ALRESTAT
          GOTO      REFN1000 IF EQUAL
.
          GOTO      REFN0010
. 
REFN1000  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      REFN0010
          ENDIF
.
          CALL      RFRW0000                * Display Of Rows
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      REFN0010 IF NOT EQUAL
.
REFN9999  RETURN
.
.*****************************************************************************
.*            Link to Next Group of Numbers (Referral Search)                *
.*****************************************************************************
NEXTPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
.
NEXTPR99  RETURN
.
.*****************************************************************************
.*             Link to Previous Group of Numbers(Referral Search)            *
.*****************************************************************************
PREVPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",STARTKEY
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
.
PREVPR99  RETURN
.
.*****************************************************************************
.*               Referral Number Search(Table Heading Formation)             *
.*****************************************************************************
RFHD0000  WRITE     HTMLFILE;"<tr align=center>":
                               "<td class=HeadingCell colspan=4>":
                               "You Searched for ":
                               STARTKEY,"</td>":
                               "</tr>":
                               "<tr>":
                               "<td class=HeadingCell width=15%>":
                               "<b>Referral Number</b></td>":
                               "<td class=HeadingCell width=45%>":
                               "<b>Patient</b></td>":
                               "<td class=HeadingCell width=15%>":
                               "<b>Status</b></td>":
                               "<td class=HeadingCell width=20%>":
                               "<b>Referral Date</b></td>":
                             "</tr>"
.
RFHD9999  RETURN
.
.*****************************************************************************
*                   Referral Number Search(Display Formation)                *
.*****************************************************************************
RFRW0000  MOVE      SP70,DISPDATE
.
          MATCH     ALRERDAT,SP70
          IF        @EQUAL
            GOTO     RFRW0500
          ENDIF
.
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
RFRW0500  PACK      KEY8,ALREURNO
          CALL      RDMAST1
          IF        OVRCD = 1
            PACK      PACFNAME,SP70,SP70
            MOVE      "Invalid U/R",PACFNAME
            GOTO      RFRW1000
          ENDIF
.
          PACK      KEY8,ALREURNO
          CALL      RDPMPX21
          IF        OVRCD = 1
            PACK      PACFNAME,SP70,SP70
            MOVE      "Invalid U/R",PACFNAME
            GOTO      RFRW1000
          ENDIF
.
.
          CALL      JAVNAM00
.
          MOVE      JAVSNAME,PACSNAME
          MOVE      JAVGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.          
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * Returns formatted name(FORMATNM)
.
          MOVE      SP70,STATDESC
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            MOVE      "Waiting",STATDESC
          ENDIF
          MATCH     "1",ALRESTAT
          IF        @EQUAL
            MOVE      "Active ",STATDESC
          ENDIF
.
RFRW1000  WRITE     HTMLFILE;"<tr valign=#"top#">":
                             "<td><a href=#"":
                         "javascript:updateParent('",ALREVISN:
                         "','",PACFNAME,"','",ALRELINK,"')#">",ALREVISN,"</a>":
                         "</td><td>",FORMATNM,"</td><td>":
                         STATDESC,"&nbsp;","</td><td>":
                         DISPDATE,"&nbsp;","</td>":
                         "</tr>"
.
RFRW9999  RETURN
.******************************************************************************
.*                      Display Of Header(Summary Encounter with referral)    *
.******************************************************************************
EVTH0000  IF        PTCNHDPS=1
         ENDIF
.
         WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=12%>":
                               "<b>Date & Time</b></td>":
                               "<td class=HeadingCell width=18%>":
                               "<b>Provider</b></td>":
                               "<td class=HeadingCell width=18%>":
                               "<b>Service</b></td>";
.
          PACK      DIM20,SP70
          IF        PTCNHDPS=1
            PACK      KEY5,ANSC,ANSL,SP20
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DIM20
            ENDIF
            WRITE     HTMLFILE;"<td class=HeadingCell width=18%>":
                                "<b>",DIM20,"</b></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=18%>":
                             "<b>Comment</b></td>":
                             "<td class=HeadingCell width=5%>":
                             "<b>Notes/Other</b></td>"
.
          IF         RELINK=1
            WRITE      HTMLFILE;"<td class=HeadingCell width=5%>":
                                "<b>Re-link</b></td>"
          ENDIF
.
          WRITE      HTMLFILE;"</tr>"
.
EVTH9999  RETURN
.
.******************************************************************************
.*                       Next Day, Week, Month                                *
.******************************************************************************
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",DEPTCODE
          REP       " +",DOCTNAME
          REP       " +",FILTTEAM
          REP       " +",NONVINAH
          WRITE     HTMLFILE;"allweb03.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&deptcode=",DEPTCODE:
                             "&doctcode=",DOCTCODE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtteam=",FILTTEAM:
                             "&nonvinah=",NONVINAH;
          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTNAME
          REP       "+ ",FILTTEAM
          REP       "+ ",NONVINAH
.
NEXT9999  RETURN
.
.******************************************************************************
.*                      Previous Day, Week, Month                             *
.******************************************************************************
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          REP       " 0",KEY2
          REP       " +",DEPTCODE
          REP       " +",DOCTNAME
          REP       " +",FILTTEAM
          REP       " +",NONVINAH
          WRITE            HTMLFILE;"allweb03.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&deptcode=",DEPTCODE:
                             "&doctcode=",DOCTCODE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtteam=",FILTTEAM:
                             "&nonvinah=",NONVINAH;
          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTNAME
          REP       "+ ",FILTTEAM
          REP       "+ ",NONVINAH
.
PREV9999  RETURN
.******************************************************************************
.*      Bulk Patient Encounters Not Using Referrals List %ALLWEB03.04.010     *
.******************************************************************************
ABPENR00  IF        NORECORD=0
            MOVE    "10",NORECORD           * Number of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY42,USERID,LASTDATE,Z70
          CALL      RSALENC5
ABPENR10  CALL      RPALENC5
          BRANCH    OVRCD,ABPENR90
.
          MATCH     USERID,ALENCUID
          GOTO      ABPENR90 IF NOT EQUAL
.
          MATCH     FRSTDATE,ALENSDAT         * Checks lastdate with contactdate
          GOTO      ABPENR90 IF LESS
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     DOCTCODE,ALENHCP        * Check HCP
            GOTO      ABPENR10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ALENVISN,SP70        * Patient Name
          CALL      RDALREF1
          BRANCH    OVRCD,ABPENR10
.
          MATCH     SP70,DEPTCODE             * Check Department
          IF        !@EQUAL
            MATCH     ALREDEPT,DEPTCODE
            GOTO      ABPENR10 IF NOT EQUAL
          ENDIF
.
.         Non-VINAH referrals only?
.
          MATCH     "1",NONVINAH            * Include Non-VINAH only?
          IF        @EQUAL
            MATCH     "1",ALRENVIN          * Is it a Non-VINAH referral?
            GOTO      ABPENR10 IF NOT EQUAL * No; get next
          ENDIF         
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ABPENR10
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21 
          BRANCH    OVRCD,ABPENR10
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO    ABPENR10                * If < than strt Rec then Read Next
          ENDIF
.
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1                * Read pmshcpaf file
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE       * Move Title
            MOVE      PMHCGNAM,FMTGNAME       * Move First Name
            MOVE      PMHCSNAM,FMTSNAME       * Move Surname
            CALL      DOCNM000                * Returns Formatted name(DOCFNAME)
          ELSE
            MOVE      "Invalid HCP",DOCFNAME
          ENDIF
.
          MOVE      SP70,PATNDESC
          MATCH     SP70,ALENLINK
          IF        @EQUAL
            GOTO     ABPENR20
          ENDIF
.
          PACK     KEY8,ALENLINK,SP70
          CALL     RDVISA1                       * Get linked visit type
          BRANCH   OVRCD,ABPENR20
.
          LOAD      PATNDESC,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
          IF        PVITYPE = 9
            MATCH     " 1",PVISYST
            IF        @EQUAL
              MOVE      VT91,PATNDESC
            ENDIF
            MATCH     " 2",PVISYST
            IF        @EQUAL
              MOVE      VT92,PATNDESC
            ENDIF
          ENDIF
.
ABPENR20  MOVE      "LD",CATEGORY           * Patient Type
          MOVE      ALENLOCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,LOCNDESC
.
          PACK      ENCTCOMM,ALENCMT1,ALENCMT2    * Encounter Comments
.
          MATCH     "1",ALENRSTA            * Strike Out when rec stat = 1
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          PACK      ENCOUTKY,ALENVISN,ALENENCT,SP70
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          REP       " +",ENCOUTKY
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<a HREF ='javascript:EncounterLink":
                             "(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&encoutky=",ENCOUTKY:
                             "#");'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALENSTIM,STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    DOCFNAME,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    FORMATNM,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    PATNDESC,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDIUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDBUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENINUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENIBUN,"&nbsp",STRENDTG,"</td></tr>";
          REP       "+ ",ENCOUTKY
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          CALL      ABPENR10 IF NOT EQUAL
.
ABPENR90
          RETURN
.******************************************************************************
.*                 Link to Next Group of Patients of Encounters               *
.******************************************************************************
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",DOCTCODE
          REP       " +",FRSTDATE
          REP       " +",LASTDATE
          REP       " +",FILTTEAM
.
          COMPARE   ONE,FILTRHCP
          IF        @EQUAL
            WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&doctcode=",DOCTCODE:
                                 "&deptcode=",DEPTCODE:
                                 "&frstdate=",FRSTDATE:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&filtteam=",FILTTEAM:
                                 "&filtrHCP=",FILTRHCP:
                                 "&nonvinah=",NONVINAH;
          ELSE
.
            WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&doctcode=",DOCTCODE:
                                 "&deptcode=",DEPTCODE:
                                 "&frstdate=",FRSTDATE:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&filtteam=",FILTTEAM:
                                 "&nonvinah=",NONVINAH;
          ENDIF
.
          REP       "+ ",DOCTCODE
          REP       "+ ",FRSTDATE
          REP       "+ ",LASTDATE
          REP       "+ ",FILTTEAM
.
NEXTGR99  RETURN
.
.******************************************************************************
.*                 Link to Previous Group of Encounters                       *
.******************************************************************************
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",DOCTCODE
          REP       " +",FRSTDATE
          REP       " +",LASTDATE
          REP       " +",FILTTEAM
.
          COMPARE   ONE,FILTRHCP
          IF        @EQUAL
            WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&doctcode=",DOCTCODE:
                                 "&deptcode=",DEPTCODE:
                                 "&frstdate=",FRSTDATE:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&filtteam=",FILTTEAM:
                                 "&filtrHCP=",FILTRHCP:
                                 "&nonvinah=",NONVINAH;
          ELSE 
            WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&doctcode=",DOCTCODE:
                                 "&deptcode=",DEPTCODE:
                                 "&frstdate=",FRSTDATE:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&filtteam=",FILTTEAM:
                                 "&nonvinah=",NONVINAH;
          ENDIF 
.
          REP       "+ ",DOCTCODE
          REP       "+ ",DOCTNAME
          REP       "+ ",FRSTDATE
          REP       "+ ",LASTDATE
          REP       "+ ",FILTTEAM
.
PREVGR99  RETURN
.
.******************************************************************************
.*                       Billing for Allied Health                             *
.******************************************************************************
ALLBIL00  PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1                * To get number of minutes/unit
          BRANCH    OVRCD,ALLBIL99
.
          MOVE      ALENDBUN,UDBILL
          MOVE      ALENIBUN,UIBILL
          SQUEEZE   ALSRLENG                * Remove spaces so move works
          MOVE      ALSRLENG,ULSRLENG
.
          MOVE      ZERO,INVPFLAG
          MOVE      ZERO,TOTALTIM
          ADD       UDBILL,TOTALTIM
          ADD       UIBILL,TOTALTIM
          MULTIPLY  ULSRLENG,TOTALTIM       * TOTALTIM is now total time
.
          MOVE      URNUMBER,PRHDDEBT
          MOVE      "1",PRHDSCAN
          PACK      PRHDCLAM,ALENCOMP,SP70
          MOVE      SP70,PRHDACCD
          MOVE      ACCIDENT,PRHDACCD
.
          PACK      KEY27,PRHDDEBT,PRHDSCAN,PRHDCLAM,PRHDACCD,PFUNDH,SP70
          CALL      RDPRHD1                 * Reading prihdbtf
          IF        OVRCD=1
            GOTO      ALLBIL10
          ENDIF
.
          MOVE      PRHDUNIQ,UNIQID
          GOTO      ALLBIL11
.
.******************************************************************************
ALLBIL10  
          CALL      NXTU0000                * Generating PRHDUNIQ
          PACK      KEY8,UNIQID,SP70
          CALL      RDPRHD2
          IF        OVRCD=0
            GOTO      ALLBIL10
          ENDIF
.
          MOVE      URNUMBER,PRHDDEBT
          MOVE      "1",PRHDSCAN
          PACK      PRHDCLAM,ALENCOMP,SP70
          MOVE      SP70,PRHDACCD
          MOVE      ACCIDENT,PRHDACCD
          MOVE      UNIQID,PRHDUNIQ
          PACK      PRHDHFND,PFUNDH,SP70
.
          CALL      WRPRHD1                 * Writing to prihdbtf
.
.******************************************************************************
ALLBIL11  CALL      CLPRIHRE
.
          MOVE      UNIQID,PRHRUNIQ
          PACK      PRHRPRAC,ALDEPRAC,SP70
          PACK      PRHRDOCT,ALENHCP,SP70
          PACK      PRHRPIND,ALENTYPE,SP70
          PACK      KEY27,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,ALLBIL12
.
          IF        PRHRPINV = 0
            MOVE      ONE,INVPFLAG        * Set PRHRPINV to 1 if any items
          ENDIF                           * are added to prihtraf
.
          GOTO      ALLBIL30
.
.******************************************************************************
ALLBIL12  MATCH     "A",UPDATETY            * Routine for different apps
          GOTO      ALLBIL16 IF EQUAL       * using billing
.
          MATCH     "V",UPDATETY
          IF        @EQUAL
            CALL      VTRBIL00              * Veteran affairs billing
            GOTO      ALLBIL24
          ENDIF
.
          MATCH     "T",UPDATETY
          IF        @EQUAL
            CALL      TACBIL00              * TAC billing
            GOTO      ALLBIL24
          ENDIF
.
          MATCH     "W",UPDATETY
          IF        @EQUAL
            CALL      WCCBIL00              * Work cover billing
            GOTO      ALLBIL24
          ENDIF
.
.******************************************************************************
ALLBIL16  PACK      PRHRREFD,ALRERHCP,SP70
          PACK      PRHRRDAT,ALRERDAT,SP70
          MOVE      ONE,PRHRPINV
          PACK      PRHRBULK,ALENBULK,SP70
.
          MATCH     SP70,ALENC015           * Check for Bulk Billing code entry
          GOTO      ALLBIL18 IF EQUAL
.
          MOVE      "CL",CATEGORY
          MOVE      ALENCOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
            UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          ENDIF
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      "C",KEY5
          GOTO      ALLBIL22 IF EQUAL
.                                           * Routine for PRFA starts here
.******************************************************************************
ALLBIL18  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLBIL20
          MATCH     SP1,PMPXCONP            * Check the usual PRFA
          GOTO      ALLBIL20 IF EQUAL
.
.         Check which contact details for the PRFA
.
          MOVE      ZERO,FORM1
          MOVE      PMPXCONP,FORM1
          COMPARE   ZERO,FORM1
          GOTO      ALLBIL23 IF EQUAL       * Use patient details
.
.
          LOAD      PRHRNAME,FORM1,PMPXMGNA,PMPXFGNA,PNKNAME,PTMXECNM,PTMXNRNM
.
          IF        FORM1=1
            MOVE      PMPXMTLE,PACTITLE
            MOVE      PMPXMGNA,PACGNAME
            MOVE      PMPXMSNA,PACSNAME
            MOVE      ONE,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,PRHRNAME
          ELSE
            IF        FORM1=2
              MOVE      PMPXFTLE,PACTITLE
              MOVE      PMPXFGNA,PACGNAME
              MOVE      PMPXFSNA,PACSNAME
              MOVE      ONE,PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,PRHRNAME
            ENDIF
          ENDIF
.
ALLBIL19  LOAD      PRHRADD1,FORM1,PMPXMAD1,PMPXFAD1,PNKADD1,PTMXECA1,PTMXNRA1
          LOAD      PRHRADD2,FORM1,PMPXMAD2,PMPXFAD2,PNKADD2,PTMXECA2,PTMXNRA2
          LOAD      PRHRADD3,FORM1,PMPXMAD3,PMPXFAD3,PNKSUBR,PTMXECA3,PTMXNRA3
          LOAD      PRHRADD4,FORM1,PMPXMAD4,PMPXFAD4,PNKSUBR,PTMXECA4,PTMXNRA4
          LOAD      PRHRPOST,FORM1,PMPXMPOS,PMPXFPOS,PNKPOST,PTMXECPC,PTMXNRPC
          LOAD      PRHRTELP,FORM1,PMPXMPNO,PMPXFPNO,PNKTELP,PTMXECPP,PTMXNRPP
          LOAD      PRHRTELB,FORM1,PMPXMBNO,PMPXFBNO,PNKTELB,PTMXECBP,PTMXNRBP
          LOAD      PRHRMPHN,FORM1,PMPXMMNO,PMPXFMNO,SP20,SP20,SP20
          LOAD      PRHRRELP,FORM1,PMPXMREL,PMPXFREL,PNKRELP,PTMXECRE,PTMXNRRE
          MOVE      SP70,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
          GOTO      ALLBIL24
.
ALLBIL20  PACK      KEY8,ALENC008,SP70      * Linked visit number is packed
          CALL      RDRESP1
          BRANCH    OVRCD,ALLBIL23
.
          MOVE      PKNAME,PRHRNAME
          MOVE      PKADD1,PRHRADD1
          MOVE      PKADD2,PRHRADD2
          MOVE      PKSUBR,PRHRADD3
          MOVE      PKADD4,PRHRADD4
          MOVE      PKPOST,PRHRPOST
          MOVE      PKTELEP,PRHRTELP
          MOVE      PTREMOBL,PRHRMPHN
          MOVE      PKRELP,PRHRRELP
          MOVE      SP70,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
          GOTO      ALLBIL24
.
.******************************************************************************
ALLBIL22  MOVE      "Medicare",PRHRNAME
          MOVE      SP70,PRHRADD1
          MOVE      SP70,PRHRADD2
          MOVE      SP70,PRHRADD3
          MOVE      SP70,PRHRADD4
          MOVE      SP70,PRHRPOST
          MOVE      SP70,PRHRTELP
          MOVE      SP70,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      SP70,PRHRRELP
          MOVE      SP70,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
          GOTO      ALLBIL24
.
.******************************************************************************
ALLBIL23  PACK      KEY8,URNUMBER,SP70      * Read from patient master
          CALL      RDMAST1
          BRANCH    OVRCD,ALLBIL99
          PACK      KEY8,URNUMBER,SP70      
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLBIL99
.
          MOVE      PGNAME,PRHRNAME
          MOVE      PADD1,PRHRADD1
          MOVE      PADD2,PRHRADD2
          MOVE      PSUBRB,PRHRADD3
          MOVE      PADD4,PRHRADD4
          MOVE      PPOST,PRHRPOST
          MOVE      PTELEP,PRHRTELP
          MOVE      PTELEB,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      SP70,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
.
.******************************************************************************
ALLBIL24  PACK      KEY27,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RAPRHR1
          IF        OVRCD=1
            CALL      WRPRHR1               * Writing to prihreff
          ENDIF
.
.******************************************************************************
ALLBIL30  MOVE      "CL",CATEGORY           * For Billing Transaction Table
          MOVE      ALENCOMP,CODE
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE       SP70,ACODE
            MOVE       SP70,TDESC
            UNPACK     SP70,TCINDC11
          ENDIF
.
          MATCH     "C",TCINDC11            * Computer generated
          GOTO      ALLBIL35 IF EQUAL
.
          MATCH     "E",TCINDC11            * Not computer generated
          GOTO      ALLBIL60 IF EQUAL
.
          GOTO      ALLBIL99
. 
.******************************************************************************
ALLBIL35  PACK      KEY18,ALENVISN,ALENENCT,SP70
          CALL      RSALITM1
ALLBIL36  CALL      RKALITM1
          BRANCH    OVRCD,ALLBIL40
.
          MATCH     ALENVISN,ALITVISN
          GOTO      ALLBIL40 IF NOT EQUAL
.
          MATCH     ALENENCT,ALITENCN
          GOTO      ALLBIL40 IF NOT EQUAL
.
          MOVE      ALITITMN,ITEMNUMB
.
          PACK      KEY22,SP1,ZERO,ITEMNUMB,SP3,ALENSDAT,SP70
          CALL      RDPRIT1
          IF        OVRCD=1
            PACK      KEY22,SP1,ZERO,ITEMNUMB,SP3,Z70
            CALL      RSPRIT1
            CALL      RPPRIT1
            BRANCH    OVRCD,ALLBIL95
            PACK      KEY14,PRITFLAG,PRITITMN,PRITSUBN,SP70
            MATCH     KEY14,KEY22
            GOTO      ALLBIL95 IF NOT EQUAL
          ENDIF
.
          PACK      NUMBITEM,ITEMNUMB,SP70
.
          CALL       ALLTUP00           * Write details to the transaction file
          BRANCH     EXIT,ALLBIL95
.
          GOTO       ALLBIL36
.
ALLBIL40  PACK      KEY16,ALREDEPT,ALENCOMP,ALENSERV,TOTALTIM,SP70
          CALL      RDALBIL1
          IF        OVRCD=0
            PACK      NUMBITEM,ALBIITEM,SP70
            CALL      ALLTUP00         * Write details to the item file
            BRANCH    EXIT,ALLBIL95
.
            CALL      CITM0000         * Write items to allitmaf
.
            GOTO      ALLBIL99
          ENDIF
.
.******************************************************************************
ALLBIL41  PACK      KEY16,ALREDEPT,ALENCOMP,ALENSERV,TOTALTIM,Z70
          CALL      RSALBIL1
ALLBIL42  CALL      RPALBIL1
          BRANCH    OVRCD,ALLBIL45
.
          MATCH     ALREDEPT,ALBIDEPT
          GOTO      ALLBIL45 IF NOT EQUAL
.
          MATCH     ALENCOMP,ALBICOMP
          GOTO      ALLBIL45 IF NOT EQUAL
.
          MATCH     ALENSERV,ALBISERV
          GOTO      ALLBIL45 IF NOT EQUAL
.
          PACK      NUMBITEM,ALBIITEM,SP70
          CALL      ALLTUP00         * Write details to the item file
          BRANCH    EXIT,ALLBIL95
.
          CALL      CITM0000         * Write items to allitmaf
.
          MOVE      ALBITIME,NLBITIME
          SUB       NLBITIME,TOTALTIM
          GOTO      ALLBIL40
.
.******************************************************************************
ALLBIL45  COMPARE   ZERO,TOTALTIM                * No time to bill
          GOTO      ALLBIL99 IF EQUAL
.
          IF        TOTALTIM > ZERO
            PACK      KEY16,ALREDEPT,ALENCOMP,ALENSERV,TOTALTIM,SP70
            CALL      RSALBIL1
            CALL      RKALBIL1
            BRANCH    OVRCD,ALLBIL96
.
            MATCH     ALREDEPT,ALBIDEPT
            GOTO      ALLBIL96 IF NOT EQUAL
.
            MATCH     ALENCOMP,ALBICOMP
            GOTO      ALLBIL96 IF NOT EQUAL
.
            MATCH     ALENSERV,ALBISERV
            GOTO      ALLBIL96 IF NOT EQUAL
.
            PACK      NUMBITEM,ALBIITEM,SP70
            CALL      ALLTUP00         * Write details to the item file
            BRANCH    EXIT,ALLBIL96
.
            CALL      CITM0000         * Write items to allitmaf
.
          ENDIF
          GOTO      ALLBIL99
.
.******************************************************************************
ALLBIL60  PACK      KEY18,ALENVISN,ALENENCT,SP70
          CALL      RSALITM1
ALLBIL61  CALL      RKALITM1
          BRANCH    OVRCD,ALLBIL99
.
          MATCH     ALENVISN,ALITVISN
          GOTO      ALLBIL99 IF NOT EQUAL
.
          MATCH     ALENENCT,ALITENCN
          GOTO      ALLBIL99 IF NOT EQUAL
.
          MOVE      ALITITMN,ITEMNUMB
.
          PACK      KEY22,SP1,ZERO,ITEMNUMB,SP3,ALENSDAT,SP70
          CALL      RDPRIT1
          IF        OVRCD=1
            PACK      KEY22,SP1,ZERO,ITEMNUMB,SP3,Z70
            CALL      RSPRIT1
            CALL      RPPRIT1
            BRANCH    OVRCD,ALLBIL95
            PACK      KEY14,PRITFLAG,PRITITMN,PRITSUBN,SP70
            MATCH     KEY14,KEY22
            GOTO      ALLBIL95 IF NOT EQUAL
          ENDIF
.
          PACK      NUMBITEM,ITEMNUMB,SP70
.
          CALL       ALLTUP00           * Write details to the transaction file
          BRANCH     EXIT,ALLBIL95
.
ALLBIL70  GOTO       ALLBIL61
.
.******************************************************************************
ALLBIL95  MOVE      "Invalid Item Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBIL99
.
ALLBIL96  MOVE      "Error - Billing details not set up.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBIL99
.
ALLBIL99  RETURN
.
.*******************************************************************************
. Common routine to the time and item billing loop to update the prihtraf file
.*******************************************************************************
ALLTUP00  MOVE      ZERO,EXIT
          MOVE      ONE,PRHTNUMB
          MOVE      SP70,PRHTSUBN
.
ALLTUP10  PACK      PRHTDOCT,ALENHCP,SP70
          PACK      PRHTPRAC,ALDEPRAC,SP70
          PACK      PRHTPIND,ALENTYPE,SP70
.
          PACK      PRHTREFD,ALRERHCP,SP70
          PACK      PRHTRDAT,ALRERDAT,SP70
.
          MOVE      PRHDUNIQ,PRHTUNIQ
          MOVE      ZERO,PRHTFLAG
          MOVE      NUMBITEM,PRHTITMN
.
          IF        PRCNRDOC <> 1
            PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
            CALL      RDPRHR1
            IF        OVRCD=0
              MOVE      PRHRREFD,PRHTREFD
              MOVE      PRHRRDAT,PRHTRDAT
            ENDIF
          ENDIF
.
          PACK      KEY62,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD:
                          PRHTRDAT:
                          PRHTFLAG,PRHTITMN,PRHTSUBN,PRHTNUMB,SP70
          CALL      RDPRHT1
          IF        OVRCD=0
            ADD       ONE,PRHTNUMB
            GOTO      ALLTUP10
          ENDIF
.
          CALL      CLPRIHTR
          UNPACK    KEY62,DPRHTUNQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD:
                          PRHTRDAT:
                          DPRHTFLG,PRHTITMN,PRHTSUBN,DPRHTNUM
          MOVE      DPRHTUNQ,PRHTUNIQ
          MOVE      DPRHTFLG,PRHTFLAG
          MOVE      DPRHTNUM,PRHTNUMB
.
          MOVE      SP70,ITEMDESC
          PACK      KEY22,SP1,ZERO,NUMBITEM,SP3,ALENSDAT,SP70
          CALL      RDPRIT1                 * For getting item description
          COMPARE   ONE,OVRCD
          GOTO      ALLTUP60 IF NOT EQUAL
.
          PACK      KEY22,SP1,ZERO,NUMBITEM,SP3,ALENSDAT,Z70
          CALL      RSPRIT1
ALLTUP50  CALL      RPPRIT1                  * For getting item description
          BRANCH    OVRCD,ALLTUP95
.
          COMPARE   ZERO,PRITFLAG
          GOTO      ALLTUP95 IF NOT EQUAL
.
          MATCH     NUMBITEM,PRITITMN
          GOTO      ALLTUP95 IF NOT EQUAL
.
ALLTUP60  PACK      ITEMDESC,PRITDESC,SP70
.
ALLTUP70  MOVE      PRHDUNIQ,PRHTUNIQ
          PACK      PRHTPRAC,ALDEPRAC,SP70
          PACK      PRHTDOCT,ALENHCP,SP70
          PACK      PRHTPIND,ALENTYPE,SP70
          PACK      PRHTREFD,ALRERHCP,SP70
          PACK      PRHTRDAT,ALRERDAT,SP70
          MOVE      ZERO,PRHTFLAG
          MOVE      NUMBITEM,PRHTITMN
          MOVE      SP70,PRHTSUBN
          MOVE      ALENSDAT,PRHTDATE
          MOVE      ALENSTIM,PRHTTIME
.
          MOVE      ONE,PRHTSERN
          CALL      CHKBIL00
          IF        EXIT=1
            MOVE      ZERO,PRHTSERN
            MOVE      ZERO,EXIT
          ENDIF
          MOVE      ITEMDESC,PRHTIDES        * For item description
          MOVE      PRITSFEE,PRHTIAMT
          MOVE      SP70,PRHTHICI
          MOVE      ZERO,PRHTS4B3
          MOVE      SP70,PRHTMEDA
.
          MOVE      PRITGSTA,PRHTGSTA       * Related to item description
          MOVE      PRITGSTC,PRHTGSTC
          MOVE      ALENVISN,PRHTREFN
          MOVE      ALENENCT,PRHTENCN
.
          IF        PRCNRDOC<>1
            PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
            CALL      RDPRHR1
            IF        OVRCD=0
              MOVE      PRHRREFD,PRHTREFD
              MOVE      PRHRRDAT,PRHTRDAT
            ENDIF
          ENDIF
.
          PACK      KEY62,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD:
                          PRHTRDAT:
                          PRHTFLAG,PRHTITMN,PRHTSUBN,PRHTNUMB,SP70
          CALL      WRPRHT1                 * Writing to prihtrf
.
          IF        INVPFLAG = 1
            PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
            CALL      RDPRHR1
            BRANCH    OVRCD,ALLTUP99
.
            MOVE      ONE,PRHRPINV               * Set invoive to be printed 
            CALL     UPPRHR1                     * to yes
          ENDIF
.
          GOTO      ALLTUP99
.
ALLTUP95  MOVE      ONE,EXIT                * An invalid item number found
.
ALLTUP99  RETURN
.
.*******************************************************************************
. Veterans affairs billing
.*******************************************************************************
VTRBIL00  PACK      PRHRREFD,ALRERHCP,SP70
          PACK      PRHRRDAT,ALRERDAT,SP70
          MOVE      ONE,PRHRPINV
          PACK      PRHRBULK,ALENBULK,SP70
.
          MOVE      "CL",CATEGORY
          MOVE      ALENCOMP,CODE
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
            UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          ENDIF
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      "V",KEY5
          GOTO      VTRBIL12 IF  EQUAL
.
VTRBIL11  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,VTRBIL99
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,VTRBIL99
.
          MOVE      PGNAME,PRHRNAME
          MOVE      PADD1,PRHRADD1
          MOVE      PADD2,PRHRADD2
          MOVE      PSUBRB,PRHRADD3
          MOVE      PADD4,PRHRADD4
          MOVE      PPOST,PRHRPOST
          MOVE      PTELEP,PRHRTELP
          MOVE      PTELEB,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      SP70,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
          GOTO      VTRBIL90
.
VTRBIL12  CALL      NXTU0030                * Reading Control Table
.
          PACK      KEY6,PRCNVAIN,SP70      * Reading Patient Insurance Table
          CALL      RDINSR1
          BRANCH    OVRCD,VTRBIL11
.
          MOVE      INAME,PRHRNAME
          MOVE      IADD1,PRHRADD1
          MOVE      IADD2,PRHRADD2
          MOVE      IADD3,PRHRADD3
          MOVE      IADD4,PRHRADD4
          MOVE      IPOST,PRHRPOST
          MOVE      ITELEB,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      PRCNVAIN,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
.
VTRBIL90  CALL      NXTU0040
.
VTRBIL99  RETURN
.
.******************************************************************************
. TAC billing 
.******************************************************************************
TACBIL00  PACK      PRHRREFD,ALRERHCP,SP70
          PACK      PRHRRDAT,ALRERDAT,SP70
          MOVE      ONE,PRHRPINV
          PACK      PRHRBULK,ALENBULK,SP70
.
          MOVE      "CL",CATEGORY
          MOVE      ALENCOMP,CODE
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
            UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          ENDIF
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      "M",KEY5
          GOTO      TACBIL12 IF  EQUAL
.
TACBIL11  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,TACBIL99
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,TACBIL99
.
          MOVE      PGNAME,PRHRNAME
          MOVE      PADD1,PRHRADD1
          MOVE      PADD2,PRHRADD2
          MOVE      PSUBRB,PRHRADD3
          MOVE      PADD4,PRHRADD4
          MOVE      PPOST,PRHRPOST
          MOVE      PTELEP,PRHRTELP
          MOVE      PTELEB,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      SP70,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
          GOTO      TACBIL90
.
TACBIL12  CALL      NXTU0010                * Reading Control Table
.
          PACK      KEY6,PRCNMABI,SP70
          CALL      RDINSR1                 * Reading Patient Insurance Table
          BRANCH    OVRCD,TACBIL11
.
          MOVE      INAME,PRHRNAME
          MOVE      IADD1,PRHRADD1
          MOVE      IADD2,PRHRADD2
          MOVE      IADD3,PRHRADD3
          MOVE      IADD4,PRHRADD4
          MOVE      IPOST,PRHRPOST
          MOVE      ITELEB,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      PRCNMABI,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
.
TACBIL90  CALL      NXTU0040
.
TACBIL99  RETURN
.
.******************************************************************************
. Work Cover Billing
.******************************************************************************
WCCBIL00  PACK      PRHRREFD,ALRERHCP,SP70
          PACK      PRHRRDAT,ALRERDAT,SP70
          MOVE      ONE,PRHRPINV
          PACK      PRHRBULK,ALENBULK,SP70
.
          MOVE      "CL",CATEGORY
          MOVE      ALENCOMP,CODE
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
            UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          ENDIF
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      "W",KEY5
          GOTO      WCCBIL12 IF  EQUAL
.
WCCBIL11  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WCCBIL99
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,WCCBIL99
.
          MOVE      PGNAME,PRHRNAME
          MOVE      PADD1,PRHRADD1
          MOVE      PADD2,PRHRADD2
          MOVE      PSUBRB,PRHRADD3
          MOVE      PADD4,PRHRADD4
          MOVE      PPOST,PRHRPOST
          MOVE      PTELEP,PRHRTELP
          MOVE      PTELEB,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      SP70,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
          GOTO      WCCBIL90
.
WCCBIL12  CALL      NXTU0020                * Reading Control Table
.
          PACK      KEY6,PRCNWCOM,SP70
          CALL      RDINSR1                 * Reading Patient Insurance Table
          BRANCH    OVRCD,WCCBIL11
.
          MOVE      INAME,PRHRNAME
          MOVE      IADD1,PRHRADD1
          MOVE      IADD2,PRHRADD2
          MOVE      IADD3,PRHRADD3
          MOVE      IADD4,PRHRADD4
          MOVE      IPOST,PRHRPOST
          MOVE      ITELEB,PRHRTELB
          MOVE      SP70,PRHRMPHN
          MOVE      PRCNWCOM,PRHRBCOD
          MOVE      ZERO,PRHRUNCL
.
WCCBIL90  CALL      NXTU0040
.
WCCBIL99  RETURN
.
ANRF0000  BRANCH    FLDITMNO,ANRF0100,ANRF0200,ANRF0300,ANRF0400,ANRF0500:
                             ANRF0600,ANRF0700,ANRF0800,ANRF0900,ANRF1000:
                             ANRF1100,ANRF1200,ANRF1300,ANRF1400,ANRF1500:
                             ANRF1600,ANRF1700,ANRF1800,ANRF1900
.
          WRITE     HTMLFILE;"Invalid IBA Tag - ANRF0000";
.
ANRF0100  CALL      ANRS0000
          GOTO      ANRF9999
.
ANRF0200  PACK      KEY3,DEPTCODE
          CALL      RDALDEP1
          BRANCH    OVRCD,ANRF9999
          WRITE     HTMLFILE;ALDEBILL
          GOTO      ANRF9999
.
ANRF0300  MOVE      "GI",CATEGORY           * for patient type combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ANRF9999
.
ANRF0400  WRITE     HTMLFILE;USERID
          GOTO      ANRF9999
.
ANRF0500  WRITE     HTMLFILE;DEPTCODE;
          GOTO      ANRF9999
.
ANRF0600  CALL      IBACLOCK
          REP       " 0",XCDATE
          PACK      KEY24,URNUMBER,XCDATE,Z70
          CALL      RDSVISA2
ANRF0610  CALL      RDPVISA2
          BRANCH    OVRCD,ANRF9999
          MATCH     URNUMBER,PVIURNO
          GOTO      ANRF9999 IF NOT EQUAL   * Record Not Found
          BRANCH    PVITYPE,ANRF0611,ANRF0612,ANRF0613
          GOTO      ANRF0610
.
ANRF0611  GOTO      ANRF9999
.
ANRF0612  MATCH     PVIDATE,ALENC005
          GOTO      ANRF0610 IF NOT EQUAL   * Date Does'nt Match
          WRITE     HTMLFILE;PVIBILL
          GOTO      ANRF9999
.
ANRF0613  PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                 * Read Discharge Table
          BRANCH    OVRCD,ANRF9999
          REP       " 0",XCDATE
          MATCH     PVIDATE,XCDATE
          GOTO      ANRF0610 IF LESS
          MATCH     DDATE,SP70              * Check  Patient is not Dischangred
          GOTO      ANRF0615 IF EQUAL
          MATCH     XCDATE,DDATE
          GOTO      ANRF0610 IF LESS
.
ANRF0615  WRITE     HTMLFILE;PVIBILL
          GOTO      ANRF9999
.
ANRF0700  WRITE     HTMLFILE;URNUMBER
          GOTO      ANRF9999
.
ANRF0800  GOTO      ANRF9999
.
ANRF0900  GOTO      ANRF9999
.
ANRF1000  CALL      SRVSEL00       * Service Select List
          GOTO      ANRF9999
.
ANRF1100  PACK      KEY15,WBSESIT,DEPTCODE,SP70
          CALL      RDSCTYA3
ANRF1150  CALL      RDKCTYA3
          BRANCH    OVRCD,ANRF9999
          MATCH     WBSESIT,OCTSITE
          GOTO      ANRF9999 IF NOT EQUAL
.
          MATCH     OCTGRP,DEPTCODE
          GOTO      ANRF9999 IF NOT EQUAL
.
          MATCH     "1",OCTACT
          GOTO      ANRF1150 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=",OCTCTYP,">",OCTDESC,"</option>"
          GOTO      ANRF1150
.
ANRF1200
.
ANRF1300  MOVE      "CL",CATEGORY           * for compensation code
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ANRF9999
.
ANRF1400  MOVE      "GD",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ANRF9999
.
ANRF1500  MOVE      "LL",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ANRF9999
.
ANRF1600  CALL      IBACLOCK
          REP       " 0",XCDATE
          UNPACK    XCDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ANRF9999
.
ANRF1700
.
ANRF1800
.
ANRF1900

ANRF9999  RETURN
.******************************************************************************
.*                      Summary Encounter Without Refrral                     *
.******************************************************************************
ANRS0000  CLEAR     HTMLLINK
          MOVE      ZERO,COUNTER
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Reading For the Visit No.
ANRS0010  CALL      RKALREF2                * Reading From Referral Table
          BRANCH    OVRCD,ANRS9999
          MATCH     ALREURNO,URNUMBER
          GOTO      ANRS9999 IF NOT EQUAL
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1                * Reading From Encounter Table
ANRS0011  CALL      RKALENC1
          BRANCH    OVRCD,ANRS0010
          MATCH     ALENVISN,ALREVISN
          GOTO      ANRS0010 IF NOT EQUAL
          GOTO      ANRS0012
ANRS0012  PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                * Reading For Department Security
          BRANCH    OVRCD,ANRS9999
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Reading For Web Security ID
          BRANCH    OVRCD,ANRS9999
          MATCH     "0",ALDESECU            * I-37051
          GOTO      ANRS0016 IF EQUAL       * I-37051
          MATCH     "1",ALDESECU
.... C-37051
          IF        @EQUAL
             MATCH     WBSEDALL,ALREDEPT
             GOTO      ANRS0016 IF EQUAL
             GOTO      ANRS0015
          ELSE
             MATCH     WBSEDALL,ALREDEPT
             GOTO      ANRS0016 IF EQUAL
             GOTO      ANRS0011
          ENDIF
.
ANRS0015  CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "alert('",HTMLLINK
          APPEND    "Invalid Security",HTMLLINK
          APPEND    "')",HTMLLINK
          GOTO      ANRS0017
.
ANRS0016  CLEAR     HTMLLINK
          PACK      ENCOUTKY,ALENVISN,ALENENCT,SP70
          APPEND    "javascript:",HTMLLINK
          APPEND    "EncounterLink('",HTMLLINK
          APPEND    ENCOUTKY,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
ANRS0017  MOVE      "CG",CATEGORY           * Reading For Departments
          MOVE      ALREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DEPDESC
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1                * Reading For Service Type
          IF        OVRCD=1
           MOVE     SP70,ALSRDESC
          ENDIF
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1                * Reading For HCP
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME       * Reading For Service Provider
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          MATCH     "1",ALENRSTA            * Checking For The Record Status
          IF        @EQUAL
            MOVE    "Cancel",ESTATUS
          ELSE
            MOVE    "Active",ESTATUS
          ENDIF
          PACK      KEY12,WBSESIT,ALENCLIN,SP70
          CALL      RDCTYA1                * Reading For Clinic Description
          MOVE      "LD",CATEGORY
          MOVE      ALENLOCA,CODE          * Reading For Location Of Service
          CALL      GETCOD00
          MOVE      TDESC,LOSERDES
          CLEAR     ALENCOMT
          APPEND    ALENCMT1,ALENCOMT      * To Concatenate Comments
          APPEND    ALENCMT2,ALENCOMT
          RESET     ALENCOMT
.
          ADD       ONE,COUNTER
          IF        COUNTER>100
             WRITE    HTMLFILE;"alert(#"Table exceeds 100 records. Records ":
                                     "beyond 100 will not be displayed#");";
             GOTO     ANRS9999
          ENDIF
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",ALENSDAT,"#",":
                             "#"",DEPDESC,"#",":
                             "#"",ALSRDESC,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ESTATUS,"#",":
                             "#"",ALENVISN,"#",":
                             "#"",ALENENCT,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",ALENSTIM,"#",":
                             "#"",LOSERDES,"#",":
                             "#"",ALENLINK,"#",":
                             "#"",ALENCOMT,"#"":
                              ");";
          GOTO      ANRS0011
.
ANRS9999  RETURN
.******************************************************************************
.*                  List Encounters With Refrral                              *
.******************************************************************************
WRSE0000  MOVE      ONE,SHOWFLAG          * I CAR 41918
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.         
          CLEAR     HTMLLINK
          MOVE      ZERO,COUNTER
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY32,ADMISSNO,Z70
          CALL      RSALENC6                * positional read
WRSE0010  CALL      RPALENC6                * read a record
.         BRANCH    OVRCD,WRSE9999          * D CAR 41918
          BRANCH    OVRCD,WRSE9995          * I CAR 41918
          MATCH     ALENVISN,ADMISSNO       * if the referral/visit matches
.         GOTO      WRSE9999 IF NOT EQUAL   * D CAR 41918
          GOTO      WRSE9995 IF NOT EQUAL   * I CAR 41918
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reading From Referral Table
          IF        OVRCD=1
            GOTO      WRSE0010
          ENDIF
.
          MATCH     "2",ALENMOHR            * only process "Unsent" & "Sent"
          GOTO      WRSE0010 IF EQUAL       * Ignore
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Reading For Web Security Id
          PACK      ENCOUTKY,ALENVISN,ALENENCT,SP70
          MATCH     "0",ALDESECU
          IF        @EQUAL
            GOTO      WRSE0016
          ENDIF
          MATCH     "1",ALDESECU
.
          IF        @EQUAL
             MATCH     WBSEDALL,ALREDEPT
             GOTO      WRSE0016 IF EQUAL
             GOTO      WRSE0015
          ELSE
             MATCH     WBSEDALL,ALREDEPT
             GOTO      WRSE0016 IF EQUAL
             GOTO      WRSE0010
          ENDIF
.
.
WRSE0015  ADD       ONE,RECNUMB
          IF        STRTNUM5>=RECNUMB
            GOTO      WRSE0010                       * C CAR 41918
          ENDIF
.
          IF        XFORMAT=0
            WRITE     HTMLFILE;"<tr>":
                      "<td nowrap>":
                      "<a HREF ='javascript:alert":
                      "(#"Invalid Security#");'>";
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"INVALID#",";
          ENDIF
          GOTO      WRSE0017
.
WRSE0016  ADD       ONE,RECNUMB
          IF        STRTNUM5>=RECNUMB
            GOTO      WRSE0010                       * C CAR 41918
          ENDIF
.
          IF        XFORMAT=0
            WRITE     HTMLFILE;"<tr>":
                      "<td nowrap>":
                      "<a HREF ='javascript:EnctrLink":
                      "(#"",LINKPRG:
                      ".pbl?reportno=",LINKREP:
                      "&template=",LINKTEM:
                      "&startnum=",STARTNUM:
                      "&deptcode=",ALREDEPT:
                      "&encoutky=",ENCOUTKY,"#");'>";
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"":
                               "&deptcode=",ALREDEPT:
                               "&encoutky=",ENCOUTKY,"#",";
          ENDIF
.
WRSE0017  MOVE      SP70,DOCFNAME
          PACK      KEY10,ALENHCP,SP70      * To get HCP name
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME     * To get the Service Provider
            CALL      DOCNM000
          ENDIF
.
          CLEAR     ALENCOMT
          APPEND    ALENCMT1,ALENCOMT       * To Concatenate Comments
          APPEND    ALENCMT2,ALENCOMT
          RESET     ALENCOMT
.
          MOVE      SP70,ALSRDESC
          MATCH     SP70,ALENSDEP
          IF        !@EQUAL
            PACK      KEY9,ALENSDEP,ALENSERV,SP70
          ELSE
            PACK      KEY9,ALREDEPT,ALENSERV,SP70
          ENDIF
          CALL      RDALSER1                * To get the Service Type
.          BRANCH    OVRCD,WRSE9999
.
          PACK      KEY12,WBSESIT,ALENCLIN,SP70
          CALL      RDCTYA1                 * Reading For Clinic Description
.          BRANCH    OVRCD,WRSE9999
.
          MOVE      "LD",CATEGORY
          MOVE      ALENLOCA,CODE           * Reading For Location Of Service
          CALL      GETCOD00
          MOVE      TDESC,LOSERDES
.
          PACK      DIM20,SP20
          IF        PTCNHDPS=1
            MATCH     "   ",ALENCOMP
            IF        !@EQUAL
              PACK      KEY5,ANSC,ANSL,ALENCOMP,SP20
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TDESC,DIM20
              ENDIF
           ENDIF
         ENDIF
.                                           * set Notes Icon if linked Notes
WRSE0020  MOVE      "0",KEY1
          MOVE      "001",KEY3
          PACK      KEY25,ALENVISN,ALENENCT,KEY3,SP70
          CALL      ENCNOT00                * see if Notes exist
.
          PACK      KEY24,ENCOUTKY,Z70      * (ENCOUTKY=ALENVISN,ALENENCT)
          CALL      ENCINT00                * see if Interventions exist
.
          CALL      ENCMED00                * see if Medications exist
.
          CALL      ENCSUP00                * see if Supplies exist
.
WRSE0030  IF        XFORMAT=0
            CALL      EVTR0000
          ELSE
            WRITE     HTMLFILE;"#"",ALENSDAT,ALENSTIM,"#",":
                               "#"",ALENRSTA,"#",":
                               "#"",DOCFNAME,"#",":
                               "#"",ALSRDESC,"#",":
                               "#"",ALENCOMT,"#",":
                               "#"",ENCNOTES,"#",":
                               "#"",ENCMEDIC,"#",":
                               "#"",ENCINTEV,"#",":
                               "#"",ENCSUPLY,"#");"
          ENDIF
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      WRSE0010 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG              * I CAR 41918
.
WRSE9995  IF        XFORMAT=0
            CALL      NOMORE00                   * I CAR 41918
          ENDIF
.
WRSE9999  RETURN
.
.******************************************************************************
.*    Reading The Last Admission Number for a Corresponding UR-Number         *
.******************************************************************************
ANLT0000  MOVE      ZERO,OVRCD
          PACK      KEY24,URNUMBER,Z70
          CALL      RSPTVIS2                * Positional Read
          CALL      RPPTVIS2                * Sequential Read
          MOVE      DPVIBILL,ADMSLAST
          BRANCH    OVRCD,ANLT9999
ANLT9999  RETURN
.
.******************************************************************************
.*                      Validate NDIS Card                                    *
.******************************************************************************
.
NDIS0000  MOVE      SP70,NDISVALD
          CALL      IBACLOCK                          * Get Current Date
          PACK      XDATE,CC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          PACK      KEY19,URNUMBER,SP70               * Get Concession Cards
          CALL      RSPMCCD1
NDIS0010  CALL      RKPMCCD1
          BRANCH    OVRCD,NDIS0090
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      NDIS0090 IF NOT EQUAL
.
          MOVE      "ct",DIM2 
          PACK      KEY5,DIM2,PMCDCTYP,SP70          *Get concession Card Type
          CALL      RDCODE1
          BRANCH    OVRCD,NDIS0010
.
          MATCH     "7",TCINDC1
          GOTO      NDIS0010 IF NOT EQUAL
.
          MATCH     "999999999",PMCDCNUM              * Invalid Card number
          GOTO      NDIS0010 IF EQUAL
.
          MATCH     SP70,PMCDEXDT                     *Is expiry blank?
          IF        @EQUAL
            GOTO      NDIS0085
          ELSE
            MATCH     XDATE,PMCDEXDT                  *Has Concession Expired?
            IF        @LESS
              GOTO      NDIS0010
            ENDIF
          ENDIF
.
NDIS0085  MOVE      "1",NDISVALD                      *Valid Concession
          GOTO      NDIS0095
.        
NDIS0090  MOVE      "0",NDISVALD                      *Not Valid Concession
. 
NDIS0095  RETURN
.
.******************************************************************************
.*                      Display Of Event Row                                  *
.******************************************************************************
EVTR0000  MOVE      SP70,DISPOUTC           * Outcome description
          MATCH     SP70,ALENOUTC
          IF        !@EQUAL
            PACK      KEY5,ANSO,ANSZ,ALENOUTC,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALENOUTC,TDESC
            ENDIF
            MOVE      TDESC,DISPOUTC
          ENDIF
.
          MOVE      SP70,DISPUC01           * ALENUC01 description (cat za)
          MATCH     SP70,ALENUC01
          IF        !@EQUAL
            PACK      KEY5,CATZA,ALENUC01,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALENUC01,TDESC
            ENDIF
            MOVE      TDESC,DISPUC01
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,ALENUDT2           * User defined date 2
          IF        !@EQUAL
            UNPACK    ALENUDT2,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",ALENRSTA            * Record status (0=Active 1=Cancel)
          IF        @EQUAL
            GOTO    EVTR0020
          ELSE
            GOTO    EVTR0010
          ENDIF
.
EVTR0010  UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          REP       " +",VISITNO
          WRITE     HTMLFILE;"<img src=../images/MaintenanceIcon.gif":
                    " ></a>":
                    CDAY,"&nbsp;",MTHNAM3,"&nbsp;",CCENT:
                    CYEAR,"&nbsp;",ALENSTIM,"</td>":
                    "<td>","&nbsp;",DOCFNAME,"</td>":
                    "<td>","&nbsp;",ALSRDESC,"</td>";
.
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;"<td>&nbsp;",DIM20,"</td>";
          ENDIF
.
          IF         WAHEALTH=1
            WRITE      HTMLFILE;"<td>","&nbsp;",ALENUFF1,"</td>";
            WRITE      HTMLFILE;"<td>","&nbsp;",DISPUC01,"</td>";
            WRITE      HTMLFILE;"<td>","&nbsp;",DISPOUTC,"</td>";
            WRITE      HTMLFILE;"<td>","&nbsp;",DISPDATE,SP1,ALENUTM2,"</td>";
          ELSE
            WRITE      HTMLFILE;"<td>","&nbsp;",ALENCOMT,"</td>";
          ENDIF
          REP        "+ ",VISITNO
          GOTO       EVTR0030
.
EVTR0020  MOVE      ALENVISN,VISITNO
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          REP       " +",VISITNO
          WRITE     HTMLFILE;"<img src=../images/MaintenanceIcon.gif ":
                    "></a>":
                    "&nbsp;","<strike>",CDAY,"&nbsp;",MTHNAM3,"&nbsp;":
                    CCENT,CYEAR,"&nbsp;",ALENSTIM,"</strike>","</td>":
                    "<td>","<strike>","&nbsp;",DOCFNAME,"</strike>","</td>":
                    "<td>","<strike>","&nbsp;",ALSRDESC,"</strike>","</td>";
.
          IF        PTCNHDPS=1
            MATCH     DIM20,SP70
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td><strike>&nbsp;",DIM20,"</strike></td>";
            ENDIF
          ENDIF
.
          IF         WAHEALTH=1
            WRITE      HTMLFILE;"<td>","<strike>","&nbsp;",ALENUFF1:
                                "</strike>","</td>";
            WRITE      HTMLFILE;"<td>","<strike>","&nbsp;",DISPUC01:
                                "</strike>","</td>";
            WRITE      HTMLFILE;"<td>","<strike>","&nbsp;",DISPOUTC:
                                "</strike>","</td>";
            WRITE      HTMLFILE;"<td>","<strike>","&nbsp;":
                                DISPDATE,SP1,ALENUTM2:
                                "</strike>","</td>";
          ELSE
            WRITE      HTMLFILE;"<td>","<strike>","&nbsp;",ALENCOMT:
                                "</strike>","</td>";
          ENDIF
.
EVTR0030  MOVE      "1",KEY1                * are Information Icons required?
          WRITE     HTMLFILE;"<td nowrap>";
          IF        ENCNOTES = 1
            WRITE     HTMLFILE;"<img src=../images/CommentIcon.gif":
                      " alt=#"Notes#">";
          ENDIF
          IF        ENCMEDIC = 1
            WRITE     HTMLFILE;"<img src=../images/medication.gif":
                      " alt=#"Medications#">";
          ENDIF
          IF        ENCINTEV = 1
            WRITE     HTMLFILE;"<img src=../images/int.gif":
                      " alt=#"Interventions#">";
          ENDIF
          IF        ENCSUPLY = 1
            WRITE     HTMLFILE;"<img src=../images/supplies.gif":
                      " alt=#"Supplies#">";
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td>"
.
. CAR 246291 - Add relink button
.
          IF       RELINK=1
            WRITE    HTMLFILE;"<td>"
.
            MATCH   "1",ALENRSTA
            GOTO    EVTR0050 IF EQUAL
.
            PACK     KEY8,ALENLINK,SP70
            CALL     RDVISA1                       * Get linked visit type
            BRANCH   OVRCD,EVTR0040
.
            MATCH    ALENLINK,DPVIBILL
            GOTO     EVTR0040 IF NOT EQUAL
.
            COMPARE   TWO,PVITYPE
            GOTO      EVTR0050 IF EQUAL
.
EVTR0040    UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            WRITE     HTMLFILE;"<img src=../images/ViewIcon.gif ":
                                   "alt='Quick re-link' ":
                                   "onclick='Relink(#"":
                                   URNUMBER,"#",#"":
                                   ADMISSNO,"#",#"":
                                   ENCOUTKY,"#",#"":
                                   DISPDAT2,"#");'>";
.
EVTR0050    WRITE     HTMLFILE;"&nbsp;</td>";
.
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
          REP        "+ ",VISITNO
.
EVTR9999  RETURN
+
.******************************************************************************
.*        Display Of Header(ABF/NWAU Referral Contact List)                   *
.******************************************************************************
ABFH0000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=12%>":
                               "<b>Date & Time</b></td>":
                               "<td class=HeadingCell width=5%>":
                               "<b>Encounter No.</b></td>":
                               "<td class=HeadingCell width=18%>":
                               "<b>Provider</b></td>":
                               "<td class=HeadingCell width=18%>":
                               "<b>Service</b></td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=18%>":
                             "<b>Comment</b></td>":
                             "<td class=HeadingCell width=5%>":
                             "<b>Notes/Other</b></td>"
.
          WRITE      HTMLFILE;"</tr>"
.
ABFH9999  RETURN
+
.******************************************************************************
.*                  List ABF/NWAU Referral
.******************************************************************************
DIAB0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATABFA1,"patabfaf"
          TRAPCLR   IO
          BRANCH    OVRCD,DIAB9999
.
          MOVE      ONE,SHOWFLAG
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          CLEAR     HTMLLINK
          MOVE      ZERO,COUNTER
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Reading From Referral Table
          BRANCH    OVRCD,DIAB9999
.
          CALL      CMRF0000               * Calendar Month referral ?
.
          CALL      ABFRFINV               * Process ABF/NWAU Calc
.
          BRANCH    MREFFLAG,DIAB2000      * Calendar month referral
.
.         Check if each the Contact encounter of the visit has a record in 
.         ABF/NWAU Calc.table
.
          PACK      KEY32,ADMISSNO,Z70
          CALL      RSALENC6                * positional read
DIAB1000  CALL      RPALENC6                * read a record
          BRANCH    OVRCD,DIAB9300
          MATCH     ALENVISN,ADMISSNO       * if the referral/visit matches
          GOTO      DIAB9300 IF NOT EQUAL
.
          PACK      ENCOUTKY,ALENVISN,ALENENCT,SP70   * save Admission/Encounter
          MOVE      SP70,PTABINVN
          PACK      KEY27,ALENVISN,ALENENCT,PTABINVN,ZERO,FIFTY3
          CALL      RDPTABF1                * read a record
          BRANCH    OVRCD,DIAB1000
.
          GOTO      DIAB3000
.
.         Calendar month referral 
.
DIAB2000  MOVE      SP70,PTABINVN
          PACK      KEY27,ALREVISN,ANSM,Z70
          CALL      RSPTABF1
DIAB2200  CALL      RPPTABF1
          BRANCH    OVRCD,DIAB9300
.
          MATCH     PTABADMN,ALREVISN
          GOTO      DIAB9300 IF NOT EQUAL
.
          CALL      CLALLENC
          MOVE      ZERO,ENCNOTES
          MOVE      ZERO,ENCINTEV
          MOVE      ZERO,ENCMEDIC
          MOVE      ZERO,ENCSUPLY
          PACK      ENCOUTKY,PTABADMN,PTABENCT,SP70   * save Admission/Encounter
.
DIAB3000  ADD       ONE,RECNUMB
          IF        STRTNUM5>=RECNUMB
            GOTO      DIAB9000
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                    "<td nowrap>":
                    "<a HREF ='javascript:ABFLink":
                    "(#"",LINKPRG:
                    ".pbl?reportno=",LINKREP:
                    "&template=",LINKTEM:
                    "&deptcode=",ALREDEPT:
                    "&encoutky=",ENCOUTKY,"#");'>";
.
          MOVE      SP70,DOCFNAME
          MOVE      SP70,ALSRDESC
          PACK      ALENCOMT,SP70,SP70
.
          MOVE      ALREHCP,KEY10                    * Default to Ref.HCP
          BRANCH    MREFFLAG,DIAB6000
.
.        set Notes Icon if linked Notes
.
          MOVE      "0",KEY1
          MOVE      "001",KEY3
          PACK      KEY25,ALENVISN,ALENENCT,KEY3,SP70
          CALL      ENCNOT00                * see if Notes exist
.
          PACK      KEY24,ENCOUTKY,Z70      * (ENCOUTKY=ALENVISN,ALENENCT)
          CALL      ENCINT00                * see if Interventions exist
.
          CALL      ENCMED00                * see if Medications exist
.
          CALL      ENCSUP00                * see if Supplies exist
.
          CLEAR     ALENCOMT
          MATCH     SP70,ALENCMT1
          IF        !@EQUAL
            APPEND    ALENCMT1,ALENCOMT       * To Concatenate Comments
          ENDIF
          MATCH     SP70,ALENCMT2
          IF        !@EQUAL
            APPEND    ALENCMT2,ALENCOMT
          ENDIF
          RESET     ALENCOMT
.
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          MATCH     SP70,ALENSDEP
          IF        !@EQUAL
            PACK      KEY9,ALENSDEP,ALENSERV,SP70
          ENDIF
          CALL      RDALSER1                * To get the Service Type
.
          MOVE      ALENHCP,KEY10           * Service doctor
.
DIAB6000  MATCH     SP70,KEY10
          IF        !@EQUAL
            PACK      KEY10,KEY10,SP70      * To get HCP name
            CALL      RDPMHCP1
            IF        OVRCD = 0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME     * To get the Service Provider
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          CALL      DROW0000                * Display record
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      DIAB9200 IF EQUAL
.
DIAB9000  IF        MREFFLAG=1
            PACK      KEY27,PTABADMN,PTABENCT,SP70
            CALL      RSPTABF1
            GOTO      DIAB2200
          ENDIF
          GOTO      DIAB1000
.
DIAB9200  MOVE      ZERO,SHOWFLAG
.
DIAB9300  CALL      NOMORE00
DIAB9999  RETURN
+
.******************************************************************************
.*                      Display Of ABF/NWAU Row                               *
.******************************************************************************
DROW0000  IF        MREFFLAG=1
            MOVE      SP70,ALENSTIM
            MOVE      PTABENCT,ALENENCT
            UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          ELSE
            UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<img src=../images/MaintenanceIcon.gif":
                    " class=ListIcon ></a>":
                    CDAY,"&nbsp;",MTHNAM3,"&nbsp;",CCENT:
                    CYEAR,"&nbsp;",ALENSTIM,"</td>":
                    "<td>","&nbsp;",ALENENCT,"</td>":
                    "<td>","&nbsp;",DOCFNAME,"</td>":
                    "<td>","&nbsp;",ALSRDESC,"</td>";
.
          WRITE      HTMLFILE;"<td>","&nbsp;",ALENCOMT,"</td>";
.
          WRITE     HTMLFILE;"<td nowrap>";
          IF        ENCNOTES = 1
            WRITE     HTMLFILE;"<img src=../images/CommentIcon.gif":
                      " alt=#"Notes#">";
          ENDIF
          IF        ENCMEDIC = 1
            WRITE     HTMLFILE;"<img src=../images/medication.gif":
                      " alt=#"Medications#">";
          ENDIF
          IF        ENCINTEV = 1
            WRITE     HTMLFILE;"<img src=../images/int.gif":
                      " alt=#"Interventions#">";
          ENDIF
          IF        ENCSUPLY = 1
            WRITE     HTMLFILE;"<img src=../images/supplies.gif":
                      " alt=#"Supplies#">";
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td>"
.
          WRITE     HTMLFILE;"</tr>";
.
DROW9999  RETURN
+
.******************************************************************************
.*        Display ABF/NWAU Calculations for a selected contact encounter      *
.******************************************************************************
DABF0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATABFA1,"patabfaf"
          TRAPCLR   IO
          BRANCH    OVRCD,DABF9999
          OPEN      PATABFA2,"patabfaf"
.
          PACK      ENCOUTKY,ENCOUTKY,SP70
          UNPACK    ENCOUTKY,PTABADMN,PTABENCT
.
          PACK      KEY8,PTABADMN
          CALL      RDALREF1
          BRANCH    OVRCD,DABF9999
.
          CALL      CMRF0000               * Calendar Month referral ?
          CALL      ABFRFINV               * Process ABF/NWAU Calc
.
          UNPACK    ENCOUTKY,PTABADMN,PTABENCT
.
.         Check for ABF/NWAU calculations records
.
          MOVE      ZERO,MREFFLAG
          PACK      KEY27,ENCOUTKY,SP70
          CALL      RSPTABF1                * positional read
          CALL      RKPTABF1                * read a record
          BRANCH    OVRCD,DABF2000
.
          PACK      KEY16,PTABADMN,PTABENCT
          MATCH     ENCOUTKY,KEY16
          GOTO      DABF2000 IF NOT EQUAL
.
          MATCH     "M",PTABENCT
          IF        @EQUAL
            MOVE      ONE,MREFFLAG          * Calendar Month referral
            CALL      CLALLENC
          ELSE
            PACK      KEY16,ENCOUTKY,SP70
            CALL      RDALENC1
            BRANCH    OVRCD,DABF2000
            MOVE      ALENCOMP,ALRECOMP
            MOVE      ALENSDAT,ALRERDAT
          ENDIF
.
          CALL      ABFRFDET                * Display ABF/NWAU Calculations
          GOTO      DABF9999
.
DABF2000  WRITE     HTMLFILE;"<tr><center><b>":
                        "ABF/NWAU Details are not applicable to this Contact":
                        "</b></center></tr>";

          GOTO      DABF9999
.
DABF9999  RETURN
+
.******************************************************************************
.*                      Dynamic Title Display for Referral Tables            *
.******************************************************************************.
WEBF0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Get Dept Code From Allrefaf
          BRANCH    OVRCD,WEBF9999
          MOVE      "CG",CATGCODE
          PACK      KEY5,CATGCODE,ALREDEPT,SP70
          CALL      RDCODE1                 * Get Dept Desc From Patcodes
          WRITE     HTMLFILE;TDESC
.
WEBF9999  RETURN
.******************************************************************************
.*                      Move in  Details for TAC Claim Variables              *
.******************************************************************************
MOVTAC00  MATCH     PRMAB001,Z70
          IF        !@EQUAL
            MOVE      PRMAB001,PRMAREFN
          ENDIF
.
          MATCH     PRMAB002,Z70
          IF        !@EQUAL
            MOVE      PRMAB002,PRMAPOLS
          ENDIF
.
          MATCH     PRMAB003,Z70
          IF        !@EQUAL
            MOVE      PRMAB003,PRMASOLN
          ENDIF
.
          MATCH     PRMAB004,Z70
          IF        !@EQUAL
            MOVE      PRMAB004,PRMASAD1
          ENDIF
.
          MATCH     PRMAB005,Z70
          IF        !@EQUAL
            MOVE      PRMAB005,PRMASAD2
          ENDIF
.
          MATCH     PRMAB006,Z70
          IF        !@EQUAL
            MOVE      PRMAB006,PRMASAD3
          ENDIF
.
          MATCH     PRMAB007,Z70
          IF        !@EQUAL
            MOVE      PRMAB007,PRMASPCD
          ENDIF
.
          MATCH     PRMAB008,Z70
          IF        !@EQUAL
            MOVE      PRMAB008,PRMASOLT
          ENDIF
.
          MATCH     PRMAB009,Z70
          IF        !@EQUAL
            MOVE      PRMAB009,PRMAREGO
          ENDIF
.
          MATCH     PRMAB010,Z70
          IF        !@EQUAL
            MOVE      PRMAB010,PRMAALOC
          ENDIF
.
          MATCH     PRMAB011,Z70
          IF        !@EQUAL
            MOVE      PRMAB011,PRMAATIM
          ENDIF
.
          MATCH     PRMAB012,Z70
          IF        !@EQUAL
            MOVE      PRMAB012,PRMAENGD
          ENDIF
.
          MATCH     PRMAB013,Z70
          IF        !@EQUAL
            MOVE      PRMAB013,PRMAINJD
          ENDIF
.
          MATCH     PRMAB014,Z70
          IF        !@EQUAL
            MOVE      PRMAB014,PRMAUDF1
          ENDIF
.
          MATCH     PRMAB015,Z70
          IF        !@EQUAL
            MOVE      PRMAB015,PRMAUDF2
          ENDIF
.
          MATCH     PRMAB016,Z70
          IF        !@EQUAL
            MOVE      PRMAB016,PRMAMSEV
          ENDIF
.
          MATCH     PRMAB017,Z70
          IF        !@EQUAL
            MOVE      PRMAB017,PRMARSEV
          ENDIF
.
          MATCH     PRMAB018,Z70
          IF        !@EQUAL
            MOVE      PRMAB018,PRMAODD1
          ENDIF
.
          MATCH     PRMAB019,Z70
          IF        !@EQUAL
            MOVE      PRMAB019,PRMAODD2
          ENDIF
.
          MATCH     PRMAB020,Z70
          IF        !@EQUAL
            MOVE      PRMAB020,PRMAODD3
          ENDIF
.
          RETURN
.******************************************************************************
.*                      Set Parameters for TAC Claim Variables                *
.******************************************************************************
SETTAC00  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          STORE     QRYDATA,F3,PRMAB001,PRMAB002,PRMAB003,PRMAB004,PRMAB005:
                               PRMAB006,PRMAB007,PRMAB008,PRMAB009,PRMAB010:
                               PRMAB011,PRMAB012,PRMAB013,PRMAB014,PRMAB015:
                               PRMAB016,PRMAB017,PRMAB018,PRMAB019,PRMAB020
          RETURN
.
CLRTAC00  MOVE      Z70,PRMAB001            * Clearing TAC Claim Variables
          MOVE      Z70,PRMAB002
          MOVE      Z70,PRMAB003
          MOVE      Z70,PRMAB004
          MOVE      Z70,PRMAB005
          MOVE      Z70,PRMAB006
          MOVE      Z70,PRMAB007
          MOVE      Z70,PRMAB008
          MOVE      Z70,PRMAB009
          MOVE      Z70,PRMAB010
          MOVE      Z70,PRMAB011
          MOVE      Z70,PRMAB012
          MOVE      Z70,PRMAB013
          MOVE      Z70,PRMAB014
          MOVE      Z70,PRMAB015
          MOVE      Z70,PRMAB016
          MOVE      Z70,PRMAB017
          MOVE      Z70,PRMAB018
          MOVE      Z70,PRMAB019
          MOVE      Z70,PRMAB020
          RETURN
.
.******************************************************************************
.*                      Move in  Details for Work Cover Claim Variables       *
.******************************************************************************
MOVWCC00  MATCH     PRWCO001,Z70
          IF        !@EQUAL
            MOVE      PRWCO001,PRWCNAME
          ENDIF
.
          MATCH     PRWCO002,Z70
          IF        !@EQUAL
            MOVE      PRWCO002,PRWCADD1
          ENDIF
.
          MATCH     PRWCO003,Z70
          IF        !@EQUAL
            MOVE      PRWCO003,PRWCADD2
          ENDIF
.
          MATCH     PRWCO004,Z70
          IF        !@EQUAL
            MOVE      PRWCO004,PRWCADD3
          ENDIF
.
          MATCH     PRWCO005,Z70
          IF        !@EQUAL
            MOVE      PRWCO005,PRWCPOST
          ENDIF
.
          MATCH     PRWCO006,Z70
          IF        !@EQUAL
            MOVE      PRWCO006,PRWCTELE
          ENDIF
.
          COMPARE   PRWCO007,ZERO
          IF        !@EQUAL
            MOVE      PRWCO007,PRWCACCP
          ENDIF
.
          MATCH     PRWCO008,Z70
          IF        !@EQUAL
            MOVE      PRWCO008,PRWCICOD
          ENDIF
.
          MATCH     PRWCO009,Z70
          IF        !@EQUAL
            MOVE      PRWCO009,PRWCCLMN
          ENDIF
.
          MATCH     PRWCO010,Z70
          IF        !@EQUAL
            MOVE      PRWCO010,PRWCTIME
          ENDIF
.
          MATCH     PRWCO011,Z70
          IF        !@EQUAL
            MOVE      PRWCO011,PRWCCOM1
          ENDIF
.
          MATCH     PRWCO012,Z70
          IF        !@EQUAL
            MOVE      PRWCO012,PRWCCOM2
          ENDIF
.
          RETURN
.******************************************************************************
.*                      Set Parameters for WCC Variables                      *
.******************************************************************************
SETWCC00  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          STORE     QRYDATA,F3,PRWCO001,PRWCO002,PRWCO003,PRWCO004,PRWCO005:
                               PRWCO006,PRWCO007,PRWCO008,PRWCO009,PRWCO010:
                               PRWCO011,PRWCO012
          RETURN
CLRWCC00  MOVE      Z70,PRWCO001            * Clearing the WCC Variables
          MOVE      Z70,PRWCO002
          MOVE      Z70,PRWCO003
          MOVE      Z70,PRWCO004
          MOVE      Z70,PRWCO005
          MOVE      Z70,PRWCO006
          MOVE      ZERO,PRWCO007
          MOVE      Z70,PRWCO008
          MOVE      Z70,PRWCO009
          MOVE      Z70,PRWCO010
          MOVE      Z70,PRWCO011
          MOVE      Z70,PRWCO012
          RETURN
.
.------------------------------------------------------------
. Routine to display the Allied Health Departments List
.------------------------------------------------------------
ARFD0000  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
ARFD0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,ARFD9999
.
          MATCH     "CG",TCODE
          GOTO      ARFD9999 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP departments
          GOTO      ARFD0100 IF EQUAL
.
          PACK      KEY3,ACODE,SP70         
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,ARFD0100
. 
          MATCH     "1",ALDEACTV
          GOTO      ARFD0100 IF EQUAL       * Skip Inactive

          MATCH     DEPTCODE,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ALDEDEPT," selected>":
                             TDESC:
                             "</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     SP70,ALDEHOSP
              IF        !@EQUAL
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  IF        OVRCD=1
                    MATCH     WBSEHOSP,ALDEHOSP
                    GOTO      ARFD0100 IF NOT EQUAL
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=",ALDEDEPT,">":
                             TDESC:
                             "</option>"
          ENDIF
          GOTO      ARFD0100
ARFD9999  RETURN
.------------------------------------------------------------
. Service Code Selection for a given Department (DEPTCODE)
. SERVFLAG: 0 = U/R Related
.           1 = Non U/R Related
.           2 = All
.------------------------------------------------------------
SRVSEL00  MOVE      SP70,KEY1 
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      TWO,SERVFLAG
          MOVE      KEY1,SERVFLAG
.
          PACK      KEY9,DEPTCODE,SP70
          CALL      RSALSER1
SRVSEL10  CALL      RKALSER1
          BRANCH    OVRCD,SRVSEL99
.
          MATCH     ALSRDEPT,DEPTCODE
          GOTO      SRVSEL99 IF NOT EQUAL
.
          MATCH     "1",ALSRACTV
          GOTO      SRVSEL10 IF NOT EQUAL
.
          IF        SERVFLAG = 0
            MATCH     "1",ALSRNURA
            GOTO      SRVSEL10 IF EQUAL
          ENDIF
.
          IF        SERVFLAG = 1        
            MATCH     "1",ALSRNURA
            GOTO      SRVSEL10 IF NOT EQUAL
          ENDIF
.
.         Add VACS Flag
          MOVE      SP70,KEY15
          PACK      KEY15,QUOTE,ALSRSERV,ALSRVACS,SP1,ALSRMHDP,QUOTE  
.
          WRITE     HTMLFILE;"<option value=",KEY15,">",ALSRDESC,"</option>"
          GOTO      SRVSEL10
SRVSEL99  RETURN
.------------------------------------------------------------
.------------------------------------------------------------
. Table by HCP
.------------------------------------------------------------
ALACTB00  PACK      KEY10,DOCTCODE,SP70
          CALL      RDPMHCP1                * Read pmshcpaf file
          BRANCH    OVRCD,ALACTB99
.
          MOVE      PMHCTITL,FMTTITLE       * Move Title
          MOVE      PMHCGNAM,FMTGNAME       * Move First Name
          MOVE      PMHCSNAM,FMTSNAME       * Move Surname
          CALL      DOCNM000                * Returns Formatted name(DOCFNAME)
.
          PACK      KEY29,DOCTCODE,LASTDATE,Z70 * Pack to read allactaf
          CALL      RSALACT2                * Call Positional read routine
ALACTB10  CALL      RPALACT2                * Call Sequential read
          BRANCH    OVRCD,ALACTB99
.
          MATCH     DOCTCODE,ALACDOCT       * Do HCPfilter only if dept is empty
          GOTO      ALACTB99 IF NOT EQUAL
.
          MATCH     FRSTDATE,ALACCODT       * Checks lastdate with contactdate
          GOTO      ALACTB99 IF LESS
.
          MATCH     SP70,DEPTCODE           * Check for empty deptcode
          IF        !@EQUAL
            MATCH     DEPTCODE,ALACDEPT
            GOTO      ALACTB10 IF NOT EQUAL
          ENDIF
.                                           * Does dept & doct code filtering
          MOVE      "CG",CATEGORY
          MOVE      ALACDEPT,CODE
          CALL      GETCOD00                * Get Deptcode Description
          MOVE      TDESC,DEPTDESC          * Dept Description
          PACK      KEY9,ALACDEPT,ALACSERV,SP70
          CALL      RDALSER1
          MOVE      "LD",CATEGORY
          MOVE      ALACLOCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,LOCNDESC          * Location Description
          PACK      ALLACTKY,ALACDEPT,ALACCODT,ALACCOTM,ALACDOCT,SP70
          MATCH     "1",ALACSTAT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
          UNPACK    ALACCODT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<img src=../images/MaintenanceIcon.gif ":
                             "class=ListIcon ":
                             "onclick='NonURLLink(#"",ALLACTKY,"#");'>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALACCOTM,STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    DEPTDESC,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    ALSRDESC,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    ALACUNIT,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    ALACCOMM,"&nbsp",STRENDTG,"</td></tr>";
          GOTO      ALACTB10
.
ALACTB99  RETURN
.
.------------------------------------------------------------
. Table by Depaartment
.------------------------------------------------------------
ALBCTB00  MOVE      "CG",CATEGORY
          MOVE      DEPTCODE,CODE
          CALL      GETCOD00                * Get Deptcode Description
          MOVE      TDESC,DEPTDESC          * Dept Description
.
          PACK      KEY29,DEPTCODE,LASTDATE,Z70 * Pack to read allactaf
          CALL      RSALACT1                * Call Positional read routine
ALBCTB10  CALL      RPALACT1                * Call Sequential read
          BRANCH    OVRCD,ALBCTB99
.
          MATCH     DEPTCODE,ALACDEPT       * Do HCPfilter only if dept is empty
          GOTO      ALBCTB99 IF NOT EQUAL
.
          MATCH     FRSTDATE,ALACCODT       * Checks lastdate with contactdate
          GOTO      ALBCTB99 IF LESS
.
          MATCH     SP70,DOCTCODE           * Check for empty deptcode
          IF        !@EQUAL
            MATCH     DOCTCODE,ALACDOCT
            GOTO      ALBCTB10 IF NOT EQUAL
          ENDIF
.                                           * Does dept & doct code filtering
          PACK      KEY9,ALACDEPT,ALACSERV,SP70
          CALL      RDALSER1
          MOVE      "LD",CATEGORY
          MOVE      ALACLOCA,CODE
          CALL      GETCOD00
          MOVE      TDESC,LOCNDESC          * Location Description
.
          PACK      KEY10,ALACDOCT,SP70
          CALL      RDPMHCP1                * Read pmshcpaf file
          BRANCH    OVRCD,ALBCTB99
.
          MOVE      PMHCTITL,FMTTITLE       * Move Title
          MOVE      PMHCGNAM,FMTGNAME       * Move First Name
          MOVE      PMHCSNAM,FMTSNAME       * Move Surname
          CALL      DOCNM000                * Returns Formatted name(DOCFNAME)
.
          PACK      ALLACTKY,ALACDEPT,ALACCODT,ALACCOTM,ALACDOCT,SP70
          MATCH     "1",ALACSTAT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
          UNPACK    ALACCODT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<img src=../images/MaintenanceIcon.gif ":
                             "class=ListIcon ":
                             "onclick='NonURLLink(#"",ALLACTKY,"#");'>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALACCOTM,STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    DEPTDESC,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    ALSRDESC,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    ALACUNIT,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    ALACCOMM,"&nbsp",STRENDTG,"</td></tr>";
          GOTO      ALBCTB10
.
ALBCTB99  RETURN
.
.---------------------------------------------------------------
. Select ERC Label patients by Photo Number  Called By: MAIN1600
.---------------------------------------------------------------
SELPAT00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      SELPAT70 IF EQUAL
.
          MATCH     "A",UPDATETY            * Select ERC Label Patients
          GOTO      SELPAT10 IF EQUAL
.
          GOTO      SELPAT90
.
SELPAT10  MATCH     PHOTONFR,PHOTONTO
          GOTO      SELPAT91 IF LESS
.
          PACK      KEY8,PHOTONFR,SP70
          CALL      RDALERC1                     * Exact Read for photo from
          BRANCH    OVRCD,SELPAT92 
          GOTO      SELPAT30
.
SELPAT20  CALL      RKALERC1
          BRANCH    OVRCD,SELPAT50
.
SELPAT30  MATCH     ALERPHOT,PHOTONTO
          GOTO      SELPAT50 IF LESS
.
          IF        SELECTYP = 1
            MATCH     PHOTONFR,ALERPHOT          * Can not print a range of
            GOTO      SELPAT50 IF NOT EQUAL      * CAR Labels
.
            MATCH     ALERC006,Z70
            IF        !@EQUAL
              MOVE      ALERC006,ALERNVIE
            ENDIF
            MATCH     ALERC020,Z70
            IF        !@EQUAL
              MOVE      ALERC020,ALERDSNT
            ENDIF
.
            MATCH     ALERC021,Z70
            IF        !@EQUAL
              MOVE      ALERC021,ALERSTFF
            ENDIF
.
            PACK      KEY8,ALERPHOT,SP70
            CALL      UPALERC1
          ENDIF
.
          PACK      KEY8,ALERVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,SELPAT20
.
          MOVE      ALREURNO,URNUMBER
          MOVE      ALERVISN,ADMISSNO
          MOVE      ALERPHOT,SUBSYSKY
.
          IF        SELECTYP = 0     
            MOVE      ZERO,SCHDCOPY
            ADD       TWO,SCHDCOPY
            ADD       ALERNTRA,SCHDCOPY
....            ADD       ALERNNEG,SCHDCOPY   * CAR 35428 - Removed for RCH
....            ADD       ALERNCLP,SCHDCOPY   * they dont want it as it was
....            ADD       ALERNBWP,SCHDCOPY   * printing too many labels
          ELSE
            MOVE      ZERO,SCHDCOPY
            IF        ALERNVIE=0
              MOVE      ONE,SCHDCOPY
            ELSE
              MOVE      ALERNVIE,SCHDCOPY
            ENDIF
          ENDIF
.
          MOVE      SP70,FREETXT1
          MOVE      SP70,FREETXT2
          MOVE      SP70,FREETXT3
          MOVE      SP70,FREETXT4
          MOVE      SP70,FREETXT5
          MOVE      SP70,FREETXT6 
          MOVE      SP70,FREETXT7
          CALL      ADDPRN00                     * Write record to ibalpcaf
.
          GOTO      SELPAT20
.
SELPAT50  MOVE      ZERO,EXIT
          GOTO      SELPAT99
.
SELPAT70  CLEAR     WEBTITLE
          MOVE      "Print ERC Labels",WEBTITLE
          RESET     WEBTITLE

          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,SELPAT99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      SELPAT99
.
SELPAT90  MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SELPAT99
.
SELPAT91  MOVE      "Photo From must be less than or equal to Photo To",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SELPAT99
.
SELPAT92  MOVE      "Invalid Photo Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SELPAT99
.
SELPAT99  RETURN
.
.---------------------------------------------------------------
. Update Label Sent to Details               Called By: MAIN2200
.---------------------------------------------------------------
UPDCAR00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      UPDCAR70 IF EQUAL
.
          MATCH     "A",UPDATETY            * Select ERC Label Patients
          GOTO      UPDCAR10 IF EQUAL
.
          GOTO      UPDCAR90
.
UPDCAR10  PACK      KEY8,PHOTONUM,SP70
          CALL      RDALERC1                     * Exact Read for photo from
          BRANCH    OVRCD,UPDCAR91
.
          PACK      KEY8,ALERVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,UPDCAR92
.
          PACK      KEY16,ALERVISN,ALERENCT,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,UPDCAR93
.
          MATCH     ALERC006,Z70
          IF        !@EQUAL
            MOVE      ALERC006,ALERNVIE
          ENDIF
          MATCH     ALERC020,Z70
          IF        !@EQUAL
            MOVE      ALERC020,ALERDSNT
          ENDIF
.
          MATCH     ALERC021,Z70
          IF        !@EQUAL
            MOVE      ALERC021,ALERSTFF
          ENDIF
.
          CALL      UPALERC1
.
UPDCAR50  MOVE      ZERO,EXIT
          GOTO      UPDCAR99
.
UPDCAR70  CLEAR     WEBTITLE
          MOVE      "Photo Sent Details",WEBTITLE
          RESET     WEBTITLE
.
          PACK      KEY8,PHOTONUM,SP70
          CALL      RDALERC1                     * Exact Read for photo from
.
          PACK      KEY8,ALERVISN,SP70
          CALL      RDALREF1
.
          PACK      KEY16,ALERVISN,ALERENCT,SP70
          CALL      RDALENC1
.

          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,UPDCAR99
.
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      UPDCAR99
.
UPDCAR90  MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCAR99
.
UPDCAR91  MOVE      "Invalid Photo Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCAR99
.
UPDCAR92  MOVE      "Invalid Referral Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCAR99
.
UPDCAR93  MOVE      "Invalid Contact Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCAR99
.
UPDCAR99  RETURN
.
.------------------------------------------------------------
. Validate Patient U/R
.------------------------------------------------------------
VALPUR00  CALL      XMLHED00
          BRANCH    EXIT,VALPUR99
.
          MOVE      VALDCODE,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALPUR20
          MOVE      VALDCODE,KEY8
          CALL      RDPMPX21
          COMPARE   ZERO,OVRCD
          GOTO      VALPUR40 IF EQUAL
.
VALPUR20  RJUSTIFY  KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALPUR90
          RJUSTIFY  KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,VALPUR90
.
VALPUR40  COMPARE   ONE,PSTAT
          GOTO      VALPUR60 IF NOT EQUAL
.
VALPUR50  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VALPUR90   * New U/R number missing
          MOVE      PPSNAME,KEY8                                             
          CALL      RDPMPX21                                         
          BRANCH    OVRCD,VALPUR90   * New U/R number missing
          BRANCH    PSTAT,VALPUR50   * Another associated U/R number
.
VALPUR60  CALL      GETVIS00         * Get last inpatient visit number
          CALL      GETALL00         * Get visit number for linked visit 
          CALL      PATNAA00
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      FMTAGE00      * Format age
          CALL      FMTSEX00      * Format Sex
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DOBDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP8,TMPURNMB
          MOVE      URNUMBER,TMPURNMB
          MOVE      VALDCODE,URNUMBER
          CALL      NDIS0000
          MOVE      TMPURNMB,VALDCODE
.
          BRANCH    RETURNFM,VALPUR70,VALPUR80
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",FMTSEX,"|",DOBDATE,"|",PCEASE,"|":
                             PURNO,"|",LASTVIST,"|",LASTVDAT,"|",LASTVTYP,"|":
                             FMTAGE,"|",PMEDI,"|":
                             PADD1,"|",PADD2,"|",PSUBRB,"|",PADD4,"|",PPOST:
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR70  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PURNO,"|",PSNAME,"|",PGNAME,"|",PTITL,"|",PSEX,"|":
                             DOBDATE,"|",PCEASE,"|",FMTAGE,"|",PMEDI,"|":
                             PADD1,"|",PADD2,"|",PSUBRB,"|",PADD4,"|",PPOST:
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",TODAYVST,"|",NDISVALD,"|":
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient UR - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR98  CALL      XMLEND00
VALPUR99  RETURN
.------------------------------------------------------------
. Get linked visit number details for allied health
.------------------------------------------------------------
GETALL00  MOVE      SP70,TODAYVST
          MATCH     "       0",URNUMBER
          GOTO      GETALL99 IF EQUAL
.
          PACK      KEY24,VALDCODE,VALDDATE,Z70
          CALL      RDSVISA2
GETALL10  CALL      RDPVISA2
          BRANCH    OVRCD,GETALL99
.
          MATCH     VALDCODE,PVIURNO
          GOTO      GETALL99 IF NOT EQUAL
.
          BRANCH    PVITYPE,GETALL20,GETALL20,GETALL30,GETALL10,GETALL10:
                            GETALL10,GETALL10,GETALL10,GETALL40
.
          GOTO      GETALL10
.
GETALL20  MATCH     VALDDATE,PVIDATE           * A&E and Outpatients default
          GOTO      GETALL10 IF NOT EQUAL      * must be equal to Encounter date
.
          MOVE      PVIBILL,TODAYVST 
          GOTO      GETALL99
.
GETALL30  PACK      KEY8,PVIBILL               * Current Inpatient
          CALL      RDDSCH1
          IF        OVRCD = 1
            MOVE      PVIBILL,TODAYVST
            GOTO      GETALL99
          ELSE
            MATCH     VALDDATE,DDATE
            GOTO      GETALL99 IF LESS
          ENDIF
          MOVE      PVIBILL,TODAYVST
          GOTO      GETALL99
.
GETALL40  MATCH     " 1",PVISYST               * Event
          GOTO      GETALL10 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL               * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,GETALL10
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "O",TCINDC1                * Outpatient Events Only
          GOTO      GETALL10 IF NOT EQUAL
.
          MATCH     VALDDATE,PVIDATE 
          GOTO      GETALL10 IF NOT EQUAL
.
          MOVE      PVIBILL,TODAYVST 
. 
          GOTO      GETALL99
.
GETALL99  RETURN
.------------------------------------------------------------
. Get Last Visit
.------------------------------------------------------------
GETVIS00  PACK      KEY24,PURNO,Z70
          MOVE      SP70,LASTVIST
          MOVE      SP70,LASTVDAT
          MOVE      SP70,LASTVTYP
          CALL      RDSVISA2
GETVIS10  CALL      RDPVISA2
          BRANCH    OVRCD,GETVIS99
          MATCH     PURNO,PVIURNO
          GOTO      GETVIS99 IF NOT EQUAL
          BRANCH    VTYPFLAG,GETVIS15
          GOTO      GETVIS90
.
GETVIS15  COMPARE   "3",PVITYPE
          GOTO      GETVIS10 IF NOT EQUAL
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETVIS10
          COMPARE   "3",ASTAT
          GOTO      GETVIS10 IF NOT EQUAL
          GOTO      GETVIS90
.
GETVIS90  MOVE      PVIBILL,LASTVIST
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTVTYP,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
.
GETVIS99  RETURN
.------------------------------------------------------------
. Format sex
.------------------------------------------------------------
FMTSEX00  MOVE      SP8,FMTSEX
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,FMTSEX
.* ******************************************   End of Changes         *C-49016
.
FMTSEX99  RETURN
.------------------------------------------------------------
. Write Patient Age in Y,M,W or D
.------------------------------------------------------------
FMTAGE00  MATCH     "y",PSAGETYP
          GOTO      FMTAGE10 IF NOT EQUAL
          PACK      FMTAGE,PSAGEYRS,FMTYRS,SP70
          GOTO      FMTAGE99
.
FMTAGE10  MATCH     "d",PSAGETYP
          GOTO      FMTAGE20 IF NOT EQUAL
          PACK      FMTAGE,PSAGEDAY,FMTDAYS,SP70
          GOTO      FMTAGE99
.
FMTAGE20  MATCH     "m",PSAGETYP
          GOTO      FMTAGE30 IF NOT EQUAL
          PACK      FMTAGE,PSAGEMNT,FMTMTHS,SP70
          GOTO      FMTAGE99
.
FMTAGE30  MATCH     "w",PSAGETYP
          GOTO      FMTAGE99 IF NOT EQUAL
          PACK      FMTAGE,PSAGEWKS,FMTWKS,SP70
.
FMTAGE99  RETURN
.
.******************************************************************************
.*                 Main Action Routine for bulk encounters without referral    *
.******************************************************************************
ALLARF00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ALLARF20 IF EQUAL
.
          GOTO      ALLARF95
.
.******************************************************************************
.*         Display Bulk Encounters With Referral
.******************************************************************************
ALLARF20  CLEAR     WEBTITLE
          RESET     WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00
.
          MOVE       TEMPLATE,F1            * Setting the title for the frame
          IF        F1=2
           MOVE      "CG",KEY2
           PACK      KEY5,KEY2,DEPTCODE,SP70
           CALL      RDCODE1
           BRANCH    OVRCD,ALLREF99
           MOVE      "ENCOUNTER",KEY9
           CLEAR     WEBTITLE
           PACK      WEBTITLE,TDESC,SP1,KEY9
          ENDIF
.
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,ALLARF99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLARF99
.
ALLARF95  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLARF99
.
ALLARF99  RETURN
.
.
.******************************************************************************
.*         Branching Routine for Encounter list by Depatment / HCP        
.******************************************************************************
ABAF0000  BRANCH    FLDITMNO,ABAF0100,ABAF0200,ABAF0300,ABAF0400,ABAF0500:
                             ABAF0600,ABAF0700,ABAF0800,ABAF0900,ABAF1000:
                             ABAF1100,ABAF1200,ABAF1300,ABAF1400,ABAF1500:
                             ABAF1600,ABAF1700,ABAF1800,ABAF1900,ABAF2000:
                             ABAF2100,ABAF2200,ABAF2300,ABAF2400,ABAF2500:
                             ABAF2600,ABAF2700,ABAF2800,ABAF2900,ABAF3000:
                             ABAF3100,ABAF3200,ABAF3300
.
          WRITE     HTMLFILE;"Invalid IBA Tag - ABAF0000"
          GOTO      ABAF9999
.
ABAF0100  CALL      NEXT0000
          GOTO      ABAF9999
.
ABAF0200  CALL      PREV0000
          GOTO      ABAF9999
.
ABAF0300  CALL      CURSTD00
          GOTO      ABAF9999
.
ABAF0400  CALL      CUREND00
          GOTO      ABAF9999
.
ABAF0500  CALL      CURYR000
          GOTO      ABAF9999
.
ABAF0600  CALL      CURMON00
          GOTO      ABAF9999
.
ABAF0700  CALL      SELV0000
          GOTO      ABAF9999
.
ABAF0800  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ABAF9999
.
ABAF0900  CALL      ARFD0000
          GOTO      ABAF9999
.
ABAF1000  MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            CALL      ALGP0000                   * List of Encouters for GP
            GOTO      ABAF9999
          ENDIF
.
          CALL      ALDP0000                     * List of Encouters for Dept
.
          GOTO      ABAF9999
.
ABAF1100  PACK      KEY15,WBSESIT,DEPTCODE,SP70
          CALL      RDSCTYA3
ABAF1150  CALL      RDKCTYA3
          BRANCH    OVRCD,ABAF9999
          MATCH     WBSESIT,OCTSITE
          GOTO      ABAF9999 IF NOT EQUAL
.
          MATCH     OCTGRP,DEPTCODE
          GOTO      ABAF9999 IF NOT EQUAL
.
          MATCH     "1",OCTACT
          GOTO      ABAF1150 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=",OCTCTYP,">",OCTDESC,"</option>"
          GOTO      ABAF1150
.
ABAF1200  MOVE      "GI",CATEGORY           * Patient Type Combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABAF9999
.
ABAF1300  MOVE      "CL",CATEGORY           * Compensation Code Combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABAF9999
.
ABAF1400  MOVE      "GD",CATEGORY           * Bulk Billing code combo
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABAF9999
.
ABAF1500  MOVE      "LL",CATEGORY           * Reason For Closure
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ABAF9999
.
ABAF1600  UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ABAF9999
.
ABAF1700  WRITE     HTMLFILE;DEPTCODE;      * Department Code
          GOTO      ABAF9999
.
ABAF1800  MATCH     SP70,DEPTCODE
          GOTO      ABAF9999 IF EQUAL
          MOVE      "CG",KEY2               * Department Description
          PACK      KEY5,KEY2,DEPTCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ABAF9999
          WRITE     HTMLFILE;TDESC
          GOTO      ABAF9999
.
ABAF1900  PACK      KEY10,DOCTCODE,SP70     * Service Provider
          CALL      RDPMHCP1
          BRANCH    OVRCD,ABAF9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME
          GOTO      ABAF9999
.
ABAF2000  CALL      SRVSEL00
          GOTO      ABAF9999
.
ABAF2100  RESET     ALRELINK
          MATCH     ALRELINK,SP70
          GOTO      ABAF2150 IF NOT EQUAL
.                                            *  READ  PATIENT VISIT TABLE
          CALL      IBACLOCK
          REP       " 0",XCDATE
          PACK      KEY24,URNUMBER,XCDATE,Z70
          CALL      RDSVISA2
ABAF2110  CALL      RDPVISA2
          BRANCH    OVRCD,ABAF9999
          MATCH     URNUMBER,PVIURNO
          GOTO      ABAF9999 IF NOT EQUAL   * RECORD NOT FOUND
          BRANCH    PVITYPE,ABAF2111,ABAF2112,ABAF2113
          GOTO      ABAF2110
.
ABAF2111
ABAF2112  MATCH     PVIDATE,ALENC005
          GOTO      ABAF2110 IF NOT EQUAL   * DATE DOES'NT MATCH
          WRITE     HTMLFILE;PVIBILL
          GOTO      ABAF9999
.
ABAF2113  PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                 * READ DISCHARGE TABLE
          BRANCH    OVRCD,ABAF9999
          REP       " 0",XCDATE
          MATCH     PVIDATE,XCDATE
          GOTO      ABAF2110 IF LESS
          MATCH     DDATE,SP70              * CHECK  PATIENT IS NOT DISCHARGED
          GOTO      ABAF2115 IF EQUAL
          MATCH     XCDATE,DDATE
          GOTO      ABAF2110 IF LESS
ABAF2115  WRITE     HTMLFILE;PVIBILL
          GOTO      ABAF9999
.
ABAF2150  WRITE     HTMLFILE;ALRELINK
          GOTO      ABAF9999
.
ABAF2200  PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ABAF9999
          WRITE     HTMLFILE;ALDEBILL
          GOTO      ABAF9999
.
ABAF2300  CALL      REFN0000
          GOTO      ABAF9999
.
ABAF2400  CALL      PREVPR00
          GOTO      ABAF9999
.
ABAF2500  CALL      NEXTPR00
          GOTO      ABAF9999
.
ABAF2600
          GOTO      ABAF9999
.
ABAF2700
          GOTO      ABAF9999
.
ABAF2800
          GOTO      ABAF9999
.
ABAF2900
          GOTO      ABAF9999
.
ABAF3000  CALL      PREVGR00
          GOTO      ABAF9999
.
ABAF3100  CALL      NEXTGR00
          GOTO      ABAF9999
.
ABAF3200  CALL      HCPCOD00
          GOTO      ABAF9999
.
ABAF3300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,FILTTEAM
          GOTO      ABAF9999 IF EQUAL
.
          BRANCH    F1,ABAF3350
.
          PACK      KEY10,FILTTEAM,SP70
          CALL      RDALCAS1
          BRANCH    OVRCD,ABAF9999
.
          WRITE     HTMLFILE;ALCADESC;
          GOTO      ABAF9999
.
ABAF3350  WRITE     HTMLFILE;FILTTEAM;
          GOTO      ABAF9999
ABAF9999  RETURN
.
.--------------------------------------------------------------------
. List Encounter by date and time with department filter only
.--------------------------------------------------------------------
ALDP0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Number of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY24,LASTDATE,Z70 * Pack userid to read allencaf
          CALL      RSALENC4                * Call Positional read routine
ALDP1010  CALL      RPALENC4                * Call Sequential read
          BRANCH    OVRCD,ALDP9999
.
          MATCH     FRSTDATE,ALENSDAT       * Checks lastdate with Servicedate
          GOTO      ALDP9999 IF LESS
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     DOCTCODE,ALENHCP        * Match HCP code
            GOTO      ALDP1010 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reads allrefaf to get UR no
          BRANCH    OVRCD,ALDP1010
.
          CALL      INDHCP00
.
          MATCH     SP70,FILTTEAM
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      ALDP1010 IF NOT EQUAL * Team does not match don't disp
          ENDIF
.
          MATCH     SP70,DEPTCODE             * Check Department
          IF        !@EQUAL
            MATCH     ALREDEPT,DEPTCODE
            GOTO      ALDP1010 IF NOT EQUAL
.... I-37051
            PACK      KEY3,ALREDEPT,SP70
            CALL      RDALDEP1                * Reading For Department Security
            BRANCH    OVRCD,ALDP9999
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1                 * Reading For Web Security ID
            BRANCH    OVRCD,ALDP9999
            MATCH     "0",ALDESECU            * I-37051
            GOTO      ALDP0016 IF EQUAL       * I-37051
            MATCH     "1",ALDESECU
            IF        @EQUAL
               MATCH     WBSEDALL,ALREDEPT
               GOTO      ALDP0016 IF EQUAL
               GOTO      ALDP1010
            ELSE
               MATCH     WBSEDALL,ALREDEPT
               GOTO      ALDP0016 IF EQUAL
               GOTO      ALDP1010
            ENDIF
         ENDIF
.... END I
.
ALDP0016  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Reads patma1af to get patient Name
          BRANCH    OVRCD,ALDP1010
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21                
          BRANCH    OVRCD,ALDP1010
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * Returns formatted name(FORMATNM)
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO    ALDP1010                * If < than strt Rec then Read Next
          ENDIF
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1                * Read pmshcpaf file
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE       * Move Title
            MOVE      PMHCGNAM,FMTGNAME       * Move First Name
            MOVE      PMHCSNAM,FMTSNAME       * Move Last Name
            CALL      DOCNM000                * Returns Formatted name(DOCFNAME)
          ELSE
            MOVE      "Invalid HCP",DOCFNAME
          ENDIF
.
          MOVE      "GI",CATEGORY
          MOVE      ALENTYPE,CODE
          CALL      GETCOD00                * Get Patient type Description
          MOVE      TDESC,PATNDESC          * Patient Description
.
          MOVE      "LD",CATEGORY
          MOVE      ALACLOCA,CODE
          CALL      GETCOD00                * To get Locatin Desc(TDESC)
          MOVE      TDESC,LOCNDESC          * Location Description
.
          PACK      ENCOUTKY,ALENVISN,ALENENCT

          MATCH     "1",ALENRSTA
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<a HREF ='javascript:EncounterLink":
                             "(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&deptcode=",ALREDEPT:
                             "&encoutky=",ENCOUTKY:
                             "#");'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALENSTIM,STRENDTG,"</td>";
.
                    MATCH     "1",DOCINDIC
                    IF        @EQUAL
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    DOCFNAME,"&nbsp","<br>",DOCFNAM3,"&nbsp","<br>",DOCFNAM4,"&nbsp","<br>",DOCFNAM5,"&nbsp","<br>",DOCFNAM6,"&nbsp",STRENDTG,"</td>";
                    ELSE
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    DOCFNAME,"&nbsp",STRENDTG,"</td>";
                    ENDIF
.
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    FORMATNM,"&nbsp",STRENDTG,"</td>":
                             "<td align=center>",STRIKETG:
                                    ALENVISN,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    PATNDESC,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDIUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDBUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENINUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENIBUN,"&nbsp",STRENDTG,"</td></tr>";
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          CALL      ALDP1010 IF NOT EQUAL
.
ALDP9999  RETURN
.
.--------------------------------------------------------------------
. List Encounter by date and time with department and HCP filter
.--------------------------------------------------------------------
ALGP0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Number of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
.          PACK      KEY42,DOCTCODE,LASTDATE,Z70 * Pack userid to read allencaf
.          CALL      RSALENC2                * Call Positional read routine
.ALGP1010  CALL      RPALENC2                * Call Sequential read
.          BRANCH    OVRCD,ALGP9999
.
          PACK      KEY24,LASTDATE,Z70
          CALL      RSALENC4
ALGP1010  CALL      RPALENC4
          BRANCH    OVRCD,ALGP9999
.
.          MATCH     DOCTCODE,ALENHCP  
.          GOTO      ALGP9999 IF NOT EQUAL   * Exit if HCP doesn't match
.
          MATCH     FRSTDATE,ALENSDAT       * Checks lastdate with Servicedate
          GOTO      ALGP9999 IF LESS
.
.          MATCH     SP70,DOCTCODE
.          IF        !@EQUAL
.            MATCH     DOCTCODE,ALENHCP        * Match HCP code
.            GOTO      ALGP1010 IF NOT EQUAL
.          ENDIF
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reads allrefaf to get UR no
          BRANCH    OVRCD,ALGP1010
.
          COMPARE   ONE,FILTRHCP
          IF        !@EQUAL
            CALL      INDHCP00
          ENDIF
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALENHCP
            GOTO      ALGP1015 IF EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      ALGP1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      ALGP1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      ALGP1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      ALGP1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      ALGP1015 IF EQUAL
            GOTO      ALGP1010
          ELSE
            MATCH     DOCTCODE,ALENHCP
            GOTO      ALGP1010 IF NOT EQUAL   * Exit if HCP doesn't match
          ENDIF
.
ALGP1015  MATCH     SP70,DEPTCODE             * Check Department
          IF        !@EQUAL
            MATCH     ALREDEPT,DEPTCODE
            GOTO      ALGP1010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTEAM
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      ALGP1010 IF NOT EQUAL * Team does not match don't disp
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Reads patma1af to get patient Name
          BRANCH    OVRCD,ALGP1010
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21                                                    
          BRANCH    OVRCD,ALGP1010
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * Returns formatted name(FORMATNM)
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO    ALGP1010                * If < than strt Rec then Read Next
          ENDIF
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1                * Read pmshcpaf file
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE       * Move Title
            MOVE      PMHCGNAM,FMTGNAME       * Move First Name
            MOVE      PMHCSNAM,FMTSNAME       * Move Last Name
            CALL      DOCNM000                * Returns Formatted name(DOCFNAME)
          ELSE
            MOVE      "Invalid HCP",DOCFNAME
          ENDIF
.
          MOVE      "GI",CATEGORY
          MOVE      ALENTYPE,CODE
          CALL      GETCOD00                * Get Patient type Description
          MOVE      TDESC,PATNDESC          * Patient Description
.
          MOVE      "LD",CATEGORY
          MOVE      ALACLOCA,CODE
          CALL      GETCOD00                * To get Locatin Desc(TDESC)
          MOVE      TDESC,LOCNDESC          * Location Description
.
          PACK      ENCOUTKY,ALENVISN,ALENENCT

          MATCH     "1",ALENRSTA
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<a HREF ='javascript:EncounterLink":
                             "(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&deptcode=",ALREDEPT:
                             "&encoutky=",ENCOUTKY:
                             "#");'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALENSTIM,STRENDTG,"</td>";
.
                    MATCH     "1",DOCINDIC
                    IF        @EQUAL
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    DOCFNAME,"&nbsp","<br>",DOCFNAM3,"&nbsp","<br>",DOCFNAM4,"&nbsp","<br>",DOCFNAM5,"&nbsp","<br>",DOCFNAM6,"&nbsp",STRENDTG,"</td>";
                    ELSE
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    DOCFNAME,"&nbsp",STRENDTG,"</td>";
                    ENDIF
.
          WRITE     HTMLFILE;"<td>",STRIKETG:
                                    FORMATNM,"&nbsp",STRENDTG,"</td>":
                             "<td align=center>",STRIKETG:
                                    ALENVISN,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    PATNDESC,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDIUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDBUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENINUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENIBUN,"&nbsp",STRENDTG,"</td></tr>";
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          CALL      ALGP1010 IF NOT EQUAL
.
ALGP9999  RETURN
.
.----------------------------------------------------------------
. Validate a referral number and return u/r name and linked visit
.----------------------------------------------------------------
VALREF00  CALL      XMLHED00
          BRANCH    EXIT,VALREF99
.
          MOVE      VALDCODE,KEY8
          CALL      RDALREF1
          BRANCH    OVRCD,VALREF90
.
          MATCH     SP70,VALDDEPT
          IF        !@EQUAL
            MATCH     ALREDEPT,VALDDEPT
            GOTO      VALREF96 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ALREURNO
          CALL      RDMAST1
          BRANCH    OVRCD,VALREF95
          PACK      KEY8,ALREURNO
          CALL      RDPMPX21
          BRANCH    OVRCD,VALREF95
.
VALREF60  CALL      PATNAA00
.
          MOVE      SP8,TMPURNMB                *Stores URNUMBER to read
          MOVE      URNUMBER,TMPURNMB           *NDIS Card
          MOVE      SP8,URNUMBER
          MOVE      ALREURNO,URNUMBER
          CALL      NDIS0000
          MOVE      TMPURNMB,URNUMBER
.
VALREF50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",ALRELINK,"|",ALRECOMP,"|":
                             ALRECTYP,"|",ALRESTAT,"|",ALREURNO,"|",ALRECONT:
                             "|",ALREPURC,"|",ALREUDT1,"|",ALREDACT:
                             "|",NDISVALD,"</RETURN_VALUE>"
          GOTO      VALREF98
.
VALREF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Referral Number - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALREF98
.
VALREF95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid U/R Number - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALREF98
.
VALREF96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Contact / Referral Department must be equal.":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALREF98
.
VALREF98  CALL      XMLEND00
VALREF99  RETURN
.
.------------------------------------------------------------
.   Set Parameters for allied health item code file
.------------------------------------------------------------
SPITM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPITM001,SPITM002,SPITM003,SPITM004,SPITM005:
                       SPITM006,SPITM007,SPITM008,SPITM009,SPITM010
.
          MOVE      ONE,EXIT
          GOTO      SPITM999
.
SPITM001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN001
          PACK      ITEMN001,ITEMN001,SP70
          GOTO      SPITM999
.
SPITM002  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN002
          PACK      ITEMN002,ITEMN002,SP70
          GOTO      SPITM999
.
SPITM003  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN003
          PACK      ITEMN003,ITEMN003,SP70
          GOTO      SPITM999
.
SPITM004  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN004
          PACK      ITEMN004,ITEMN004,SP70
          GOTO      SPITM999
.
SPITM005  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN005
          PACK      ITEMN005,ITEMN005,SP70
          GOTO      SPITM999
.
SPITM006  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN006 
          PACK      ITEMN006,ITEMN006,SP70
          GOTO      SPITM999
.
SPITM007  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN007
          PACK      ITEMN007,ITEMN007,SP70
          GOTO      SPITM999
.
SPITM008  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN008
          PACK      ITEMN008,ITEMN008,SP70
          GOTO      SPITM999
.
SPITM009  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN009
          PACK      ITEMN009,ITEMN009,SP70
          GOTO      SPITM999
.
SPITM010  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN010
          PACK      ITEMN010,ITEMN010,SP70
          GOTO      SPITM999
.
SPITM999  RETURN
.
.------------------------------------------------------------
.   Set Parameters for allied health item code file
.------------------------------------------------------------
ALIT0000  MOVE      ONE,F2
.
          MATCH     SP70,ITEMN001
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN001,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN001,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN002
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN002,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN002,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN003
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN003,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN003,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN004
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN004,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN004,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN005
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN005,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN005,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN006
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN006,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN006,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN007
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN007,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN007,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN008
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN008,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN008,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN009
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN009,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN009,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN010
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN010,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN010,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
ALITM999  RETURN
.
.------------------------------------------------------------
.  Write computer generated items to allitmaf        
.------------------------------------------------------------
CITM0000  MOVE      ONE,F2
          PACK      KEY18,ALENVISN,ALENENCT,Z70
          CALL      RSALITM1
          CALL      RPALITM1
          BRANCH    OVRCD,CITM4000
.
          MATCH     ALENVISN,ALITVISN            * Same visit number
          GOTO      CITM4000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALITENCN            * Same encounter number
          GOTO      CITM4000 IF NOT EQUAL
.
          MOVE     ALITITMC,F2                   * Add one to unique count
          ADD      ONE,F2
.
CITM4000  MOVE      ALENVISN,ALITVISN
          MOVE      ALENENCT,ALITENCN
          MOVE      F2,ALITITMC
          MOVE      NUMBITEM,ALITITMN
          MOVE      SP70,ALITSPAR
.
          PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
          CALL      RAALITM1
          IF        OVRCD=1
             CALL     WRALITM1                   * Write to item file
          ELSE
             GOTO     CITM0000                   * Get next unique number
          ENDIF
.
CITM9999  RETURN
.
.------------------------------------------------------------
.   Set Parameters for allied health item code file
.------------------------------------------------------------
MVIT0000  MOVE     ALENVISN,ALITVISN
          MOVE     ALENENCT,ALITENCN
          MOVE     F2,ALITITMC
          MOVE     SP70,ALITSPAR
.
MVIT9999  RETURN
.
.----------------------------------------------------------------
. Validate a visit number and check it is for this U/R number
.----------------------------------------------------------------
VALVIS00  CALL      XMLHED00
          BRANCH    EXIT,VALVIS99
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,VALVIS40
.
          MATCH     PVIURNO,VALDURNO
          GOTO      VALVIS91 IF NOT EQUAL
.
. CAR 267255 - Added parameter to allow referrals to be linked
.
          READ      CONTROLF,HUND06;*248,ALCNLNKR
.
          MATCH     "1",ALCNLNKR
          IF        !@EQUAL
            IF        PVITYPE=9
              MATCH     " 2",PVISYST          * Referrals can not be linked visits
              GOTO      VALVIS92 IF EQUAL
            ENDIF
          ENDIF
.
          GOTO      VALVIS50
.
VALVIS40  PACK      KEY8,VALDCODE,SP70
          CALL      RDPREA1                 * Read pre attendance
          BRANCH    OVRCD,VALVIS90
.
          CALL      VALSIT00                * Open correct op site prefix files
.
          PACK      KEY28,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,VALVIS90
.
          MATCH     OBAURNO,VALDURNO
          GOTO      VALVIS91 IF NOT EQUAL
.
          IF        OBASTAT<>1 & OBASTAT <> 5
            GOTO      VALVIS92                   * Allow booked and DNA
          ENDIF
.
          MOVE      OBAURNO,PVIURNO              * Populate U/R
          MOVE      OBAOUTNO,PVIBILL             * Populate Visit
.
VALVIS50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PVIBILL,"|",PVIURNO:
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit number - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit for this U/R - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit type for a linked visit":
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS98  CALL      XMLEND00
VALVIS99  RETURN
.
.*******************************************************************************
. VALSIT00 - Check that the correct outpatient site prefix files are open
.            according to the pre attendance site code
.*******************************************************************************
VALSIT00  MATCH     SP70,OPRSITE             * Does the pre attendance have
          GOTO      VALSIT99 IF EQUAL        * a site code
.
VALSIT50  MOVE      OPRSITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,VALSIT99           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
VALSIT99  RETURN
.
.------------------------------------------------------------
. Clinic Type List
.------------------------------------------------------------
REFCTY00  PACK      KEY42,WBSESIT,SP70
          CALL      RDSCTYA2
REFCTY10  CALL      RDKCTYA2
          BRANCH    OVRCD,REFCTY99
.
          MATCH     OCTSITE,WBSESIT
          GOTO      REFCTY99 IF NOT EQUAL
.
          MATCH     OCTGRP,ALREDEPT
          GOTO      REFCTY10 IF NOT EQUAL
.
          MATCH     "1",OCTACT
          GOTO      REFCTY10 IF EQUAL
.
          MATCH     ALRECTYP,OCTCTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#" selected>":
                               OCTDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#">":
                               OCTDESC,"</option>"
          ENDIF
          GOTO      REFCTY10
.
REFCTY99  RETURN
+
.------------------------------------------------------------
. Display Warnings
.------------------------------------------------------------
WEBWAR00  CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                              "<script type=#"text/javascript#">{ "
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR20 IF LESS
          GOTO      WEBWAR10
.
WEBWAR20  WRITE     HTMLFILE;"}</script>"
.
.          MATCH     "1",SINGENC
.          GOTO      WEBWAR30 IF EQUAL
.
          MATCH     "1",NEXTPAGE
          IF        @EQUAL
            IF        SHWUPDAT=1
              WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                               " location.href=#"",REDIRECT,"#";":
                               "}":
                               "</script>"
              GOTO      WEBWAR90
            ENDIF
          ENDIF
.
          MATCH     "4",NEXTPAGE
          IF        @EQUAL
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
            GOTO      WEBWAR90
          ENDIF
.
          MATCH     "5",NEXTPAGE
          IF        @EQUAL
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{ ":
                            " redirectTopPopUpFrame(#"",REDIRECT,"#");":
                               "}":
                               "</script>"
            GOTO      WEBWAR90
          ENDIF
.
          MATCH     "6",NEXTPAGE
          IF        @EQUAL
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{ ":
                            " redirectTopContent(#"",REDIRECT,"#");":
                               "}":
                               "</script>"
           GOTO      WEBWAR90
          ENDIF
.
WEBWAR30  IF        WINCLFLG=1
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{":
                               " if (self.name.match(/PopUpFrame/)) {":
                               "  reloadParentFrame();} ":
                               " else { ":
                               "  opener.history.go(0);":
                               "  self.close(); }":
                               "}":
                               "</script>"
            GOTO      WEBWAR90
          ELSE
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{":
                               " if (self.name.match(/PopUpFrame/)) {":
                               "  redirectParentFrame(#"",REDIRECT,"#");}":
                               " else {":
                               "  location.href=#"",REDIRECT,"#"}":
                               "}":
                               "</script>"
          ENDIF
.
WEBWAR90  CALL      CLOSHTML
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBWAR99  RETURN
.
.----------------------------------------------------------------
. Validate a photo number 
.----------------------------------------------------------------
VALPHT00  CALL      XMLHED00
          BRANCH    EXIT,VALPHT99
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDALERC1
          BRANCH    OVRCD,VALPHT90
.
          PACK      KEY8,ALERVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,VALPHT90
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,VALPHT90
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,VALPHT90
.
          CALL      PATNAA00
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,ALERDSNT
          IF        !@EQUAL
            UNPACK    ALERDSNT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            PACK      ALERDSNT,CCC,CYY,CMM,CDD
            REP       " 0",ALERDSNT
            UNPACK    ALERDSNT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR

          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              PATFNAME,"|",DISPDATE,"|":
                              ALERSTFF,"|",ALREURNO,"|",ALERNVIE:
                             "</RETURN_VALUE>"
.
          GOTO      VALPHT98
.
VALPHT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Photo Number - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALPHT98
.
VALPHT98  CALL      XMLEND00
VALPHT99  RETURN
.
.******************************************************************************
.* Generate next job number if this department is using job numbers           *
.******************************************************************************
ALJOBN00  READ      CONTROLF,HUND06;*6,ALCNDEPT
          MATCH     ALREDEPT,ALCNDEPT
          GOTO      ALJOBN99 IF NOT EQUAL
.
          READ      CONTROLF,HUND06;*9,ALCNJOBN
          ADD       ONE,ALCNJOBN
          WRITAB    CONTROLF,HUND06;*9,ALCNJOBN
          SUB       ONE,ALCNJOBN
          MOVE      ALCNJOBN,ALREUNO2
.
ALJOBN99  RETURN
.
.+
.------------------------------------------------------------
. Format Patient Name (for Javascript)  <b>SURNAME</b>Title Given Names
.*** format the surname and given name by changing any ' to %60
.------------------------------------------------------------
JAVNAM00  CLEAR     DISPNAME
.
          MOVE      SP70,JAVFNAME
.
          MOVE      PSNAME,JAVSNAME          * surname
          SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVNAM10 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted surname
.
JAVNAM10  MOVE      SP70,STRTNAME
          MOVE      SP70,ENDNAME
.
          MOVE      PGNAME,JAVGNAME     * given name
          SCAN      "'",JAVGNAME        * find any apostrophies
          GOTO      JAVNAM20 IF NOT EQUAL
.
          MOVE      JAVGNAME,ENDNAME    * store all chars after apostrophy
          REP       "' ",ENDNAME        * remove the apostrophy
.
          LENSET    JAVGNAME
          RESET     JAVGNAME
          MOVE      JAVGNAME,STRTNAME   * store all chars before the '
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVGNAME,STRTNAME,SIXTY,ENDNAME,SP70  * formatted given name
.
JAVNAM20  REP       "#" ",JAVSNAME
          REP       "#" ",JAVGNAME
          MOVE      SP70,JAVFNAME
          REP       UPPLOW,JAVSNAME
          APPEND    "<b>",DISPNAME
          APPEND    JAVSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,JAVFNAME
          STRIP     JAVFNAME
.
JAVNAM99  RETURN
.
.*****************************************************************************
.*                           Photo Number Search                             *
.*****************************************************************************
PHOT0000  CALL      PHHD0000                * Output Table Heading
          IF        NORECORD=0
            MOVE      "10",NORECORD         * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY16,STARTKEY,SP70
          CALL      RSALREF2                * Reading For the Visit No.
PHOT0010  CALL      RKALREF2                * Reading From Referral Table
          BRANCH    OVRCD,PHOT9999
          MATCH     ALREURNO,STARTKEY
          GOTO      PHOT9999 IF NOT EQUAL
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,PHOT0010          
.
          MATCH     "1",ALDEUY1             * Using ERC Labels
          GOTO      PHOT0010 IF NOT EQUAL
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1
PHOT0050  CALL      RKALENC1
          BRANCH    OVRCD,PHOT0010
.
          MATCH     ALREVISN,ALENVISN
          GOTO      PHOT0010 IF NOT EQUAL
.
          PACK      KEY24,ALENVISN,ALENENCT,SP70
          CALL      RSALERC2
          CALL      RKALERC2
          BRANCH    OVRCD,PHOT0050
.
          MATCH     ALENVISN,ALERVISN
          GOTO      PHOT0050 IF NOT EQUAL
.
          MATCH     ALENENCT,ALERENCT
          GOTO      PHOT0050 IF NOT EQUAL
.
PHOT1000  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PHOT0050
          ENDIF
.
          CALL      PHRW0000                * Display Of Rows
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PHOT0050 IF NOT EQUAL
.
PHOT9999  RETURN
.
.
.*****************************************************************************
.*                  Photo Number Search(Table Heading Formation)             *
.*****************************************************************************
PHHD0000  WRITE     HTMLFILE;"<tr align=center>":
                               "<td class=HeadingCell colspan=6>":
                               "You Searched for ":
                               STARTKEY,"</td>":
                               "</tr>":
                               "<tr>":
                               "<td class=HeadingCell width=15%>":
                               "<b>Photo Number</b></td>":
                               "<td class=HeadingCell width=15%>":
                               "<b>Referral</b></td>":
                               "<td class=HeadingCell width=25%>":
                               "<b>Patient</b></td>":
                               "<td class=HeadingCell width=15%>":
                               "<b>Status</b></td>":
                               "<td class=HeadingCell width=15%>":
                               "<b>Referral Date</b></td>":
                               "<td class=HeadingCell width=15%>":
                               "<b>EOC Date</b></td>":
                             "</tr>"
.
PHHD9999  RETURN
.
.*****************************************************************************
*                      Photo Number Search(Display Formation)                *
.*****************************************************************************
PHRW0000  MOVE      SP70,DISPDATE
.
          MATCH     ALRERDAT,SP70
          IF        @EQUAL
            GOTO     PHRW0500
          ENDIF
.
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
PHRW0500  PACK      KEY8,ALREURNO
          CALL      RDMAST1
          IF        OVRCD = 1
            PACK      PACFNAME,SP70,SP70
            MOVE      "Invalid U/R",PACFNAME
            GOTO      PHRW1000
          ENDIF
.
          PACK      KEY8,ALREURNO
          CALL      RDPMPX21
          IF        OVRCD = 1
            PACK      PACFNAME,SP70,SP70
            MOVE      "Invalid U/R",PACFNAME
            GOTO      PHRW1000
          ENDIF
.
          CALL      JAVNAM00
.
          MOVE      JAVSNAME,PACSNAME
          MOVE      JAVGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * Returns formatted name(FORMATNM)
.
          MOVE      SP70,STATDESC
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            MOVE      "Waiting",STATDESC
          ENDIF
          MATCH     "1",ALRESTAT
          IF        @EQUAL
            MOVE      "Active ",STATDESC
          ENDIF
.
PHRW1000  WRITE     HTMLFILE;"<tr valign=#"top#">":
                             "<td><a href=#"":
                         "javascript:updateParent('",ALERPHOT,"')#">":
                         ALERPHOT,"</a>":
                         "</td><td>",ALREVISN,"</td>":
                         "<td>",FORMATNM,"</td><td>":
                         STATDESC,"&nbsp;","</td><td>":
                         DISPDATE,"&nbsp;","</td><td>":
                         DISPDAT1,"&nbsp;","</td>":
                         "</tr>"
.
PHRW9999  RETURN
.
.-----------------------------------------------------------
. Link to Next Group option 1
.-----------------------------------------------------------
NXTGRP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STRTNUM5+NORECORD,F5                      * C CAR 41918
          MOVE      F5,KEY5
          REP       " +",KEY5                                 * end C CAR 41918
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",BULKENCK
.
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&startnum=",KEY5:           * C CAR 41918
                                 "&norecord=",KEY2:
                                 "&bulkenck=",BULKENCK;
.
          REP       "+ ",BULKENCK
.
NXTGRP99  RETURN
.
.-----------------------------------------------------------
. Link to Next 5 Group option 1
.-----------------------------------------------------------
NXTFVG00  MOVE      NORECORD,KEY2
          MOVE      ZERO,RECNUMAL
          REP       " +",KEY2
          ASSIGN    STRTNUM5+(NORECORD*5),F5                    
.
          CALL      NUMREF00
.
NXTFVG20  IF        F5>RECNUMAL
            MOVE      RECNUMAL,F5
            SUB       TEN,F5
          ENDIF
.
          MOVE      F5,KEY5
          REP       " +",KEY5                               
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",BULKENCK
.
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&startnum=",KEY5:           
                                 "&norecord=",KEY2:
                                 "&bulkenck=",BULKENCK;
.
          REP       "+ ",BULKENCK
.
NXTFVG99  RETURN
.
.-----------------------------------------------------------
. Link to Last Group option 1
.-----------------------------------------------------------
LSTGRP00  MOVE      NORECORD,KEY2
          MOVE      ZERO,RECNUMAL
          REP       " +",KEY2
.
          CALL      NUMREF00
          SUB       TEN,RECNUMAL
          MOVE      RECNUMAL,KEY5
          REP       " +",KEY5                                 * end C CAR 41918
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",BULKENCK
.
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&startnum=",KEY5:           * C CAR 41918
                                 "&norecord=",KEY2:
                                 "&bulkenck=",BULKENCK;
.
          REP       "+ ",BULKENCK
.
LSTGRP99  RETURN
.
.-----------------------------------------------------------
. Get total number of contacts for referral
.-----------------------------------------------------------
NUMREF00  PACK      KEY32,ADMISSNO,Z70
          CALL      RSALENC6
NUMREF10  CALL      RPALENC6
          BRANCH    OVRCD,NUMREF99
          MATCH     ALENVISN,ADMISSNO
          GOTO      NUMREF99 IF NOT EQUAL
          ADD       ONE,RECNUMAL
          GOTO      NUMREF10
.
NUMREF99  RETURN
.
.-------------------------------------------------------------
. Link to Prev Group option 1
.-------------------------------------------------------------
PRVGRP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STRTNUM5-NORECORD,F5                      * C CAR 41918
          IF        F5<0
            MOVE      ZERO,F5
          ENDIF
          MOVE      F5,KEY5
          REP       " +",KEY5                                 * end C CAR 41918
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",BULKENCK
.
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&startnum=",KEY5:           * C CAR 41918
                                 "&norecord=",KEY2:
                                 "&bulkenck=",BULKENCK;
.
          REP       "+ ",BULKENCK
.
PRVGRP99  RETURN
.
.-------------------------------------------------------------
. Link to Prev 5 Group option 1
.-------------------------------------------------------------
PRVFVG00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STRTNUM5-(NORECORD*5),F5                      * C CAR 41918

          IF        F5<0
            MOVE      ZERO,F5
          ENDIF
.
          MOVE      F5,KEY5
          REP       " +",KEY5                                 * end C CAR 41918
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",BULKENCK
.
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&startnum=",KEY5:           * C CAR 41918
                                 "&norecord=",KEY2:
                                 "&bulkenck=",BULKENCK;
.
          REP       "+ ",BULKENCK
.
PRVFVG99  RETURN
.
.-------------------------------------------------------------
. Link to First Group option 1
.-------------------------------------------------------------
PRVFIG00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          MOVE      ZERO,KEY5
          REP       " +",KEY5                                 * end C CAR 41918
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",BULKENCK
.
          WRITE     HTMLFILE;"allweb03.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&startnum=",KEY5:           * C CAR 41918
                                 "&norecord=",KEY2:
                                 "&bulkenck=",BULKENCK;
.
          REP       "+ ",BULKENCK
.
PRVFIG99  RETURN
.
.------------------------------------------------------------     * I CAR 41918
. NOMORE00 - Display "No more visits" at end of visit list by type
.------------------------------------------------------------
NOMORE00  
          COMPARE    ONE,SHOWFLAG
          GOTO       NOMORE99 IF NOT EQUAL
.
           WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                               "<td colspan=10 align=center>":
                               "No more Contacts</td>"
.
NOMORE99  RETURN                                              * end I CAR 41918
.------------------------------------------------------------
. ALLTAC00 - Read previous visits TAC Claim Details (if any)  * I-41539
.------------------------------------------------------------
ALLTAC00  MATCH     ANSN,PTCNLCLM
          GOTO      ALLTAC90 IF EQUAL
.
          PACK      KEY16,URNUMBER,Z70
          CALL      RDSWMAB2
ALLTAC10  CALL      RDPWMAB2
          BRANCH    OVRCD,ALLTAC90
.
          MATCH     PTWMURNO,URNUMBER
          GOTO      ALLTAC90 IF NOT EQUAL
.
          MATCH     ANSI,PTCNLCLM                       *Inpatient Only
          IF        @EQUAL
            MOVE      MADMNO,KEY8
            CALL      RDVISA1
            BRANCH    OVRCD,ALLTAC10
.
            COMPARE   THREE,PVITYPE
            GOTO      ALLTAC10 IF NOT EQUAL
.
            CALL      CLPATVIS
          ENDIF
.
          GOTO     ALLTAC99
.
ALLTAC90  CALL     CLRCLM00
.
ALLTAC99  RETURN
.------------------------------------------------------------
. CLRCLM00 - Clear claim details                              * I-41539
.------------------------------------------------------------
CLRCLM00  MOVE      ZERO,PTWMTACF
          MOVE      SP70,PTWMTYPE
          MOVE      SP70,MREFNO
          MOVE      SP70,MACDAT
          MOVE      SP70,MPOLIC
          MOVE      SP70,MCREGO
          MOVE      SP70,MOTHDET1
          MOVE      SP70,MOTHDET2
          MOVE      SP70,MOTHDET3
          MOVE      SP70,MMDTRANS
          MOVE      SP70,MENGAGED
          MOVE      SP70,MPINJURE
          MOVE      SP70,MMECHSEV
          MOVE      SP70,MREGNSEV
          MOVE      SP70,MSNAME
          MOVE      SP70,MSTELE
          MOVE      SP70,MACLOC
.
CLRCLM99  RETURN
.
.******************************************************************************
.*                      Main Action Routine for bulk encounters               *
.******************************************************************************
BULKEN00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      BULKEN70 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Encounter
          GOTO      BULKEN10 IF EQUAL
.
          GOTO      BULKEN90
.
BULKEN10  CALL      ADDB0000                * Add Bulk Encounter
          BRANCH    EXIT,BULKEN99
.
          IF        SHWUPDAT=1 | SHWUPDAT=2
            PACK      REDIRECT,REDIRECT,SP70,SP70
            STRIP     REDIRECT
            ENDSET    REDIRECT
            PACK      KEYENCTR,ALENVISN,ALENENCT,SP70
            REP       " +",KEYENCTR
            APPEND    "&encoutk2=",REDIRECT
            APPEND    KEYENCTR,REDIRECT
          RESET     REDIRECT
          ENDIF
.
          COMPARE   ZERO,WARCOUNT
          IF        !@EQUAL
            MOVE      ONE,WINCLFLG          * Display warning messages
            CALL      WEBWAR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      BULKEN99      
.
BULKEN70  CALL      CLALLREF                * Clear referral fields
          CALL      CLALLENC                * Clear encounter fiels
          CALL      CLOUTBB1                * Clear outbb1af fields
          CALL      CLOUTBOA                * Clear outbokaf
          MOVE      SP70,LINKEDOP           
          MOVE      SP70,LINKOPCT           * Linked OP booking check in time
          MOVE      SP70,LINKVTYP           * Linked OP booking visit type
          MOVE      SP70,LINKSKEY           * Linked OP booking session key
.
          MATCH     SP70,BULKENCK
          IF        !@EQUAL
            UNPACK    BULKENCK,D8,KEY8      * Pack key with OP visit number
            CALL      RDBOKB1
            IF        OVRCD<>1
              MOVE      OBAOUTNO,LINKEDOP   * Save linked OP visit number
              MOVE      OTBBCITM,LINKOPCT   * Save linked OP visit check in time
            ENDIF
.
            PACK      KEY36,KEY8,SP70
            CALL      RDSBOKA6
            CALL      RDKBOKA6
            IF        OVRCD<>1
              MATCH     KEY8,DOBAOUTN
              IF        @EQUAL
                MOVE      OBAVISIT,LINKVTYP * SAve linked OP visit slot type
                PACK      LINKSKEY,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
              ENDIF
            ENDIF
.
            PACK      KEY8,D8,SP70
            CALL      RDALREF1
            IF        OVRCD=1
              CALL      CLALLREF
            ENDIF
.
          ENDIF
.
          MOVE      DEPTCODE,ALREDEPT       * Populate department code
.
          CLEAR     WEBTITLE
          MOVE      "Allied Health Referral Information",WEBTITLE
          RESET     WEBTITLE
. 
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,BULKEN99
.         
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      BULKEN99
.
BULKEN90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BULKEN99
.
BULKEN91  MOVE      "Please select at least one appointment",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BULKEN99
.
BULKEN98  MOVE      "U/R does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BULKEN99
.
BULKEN99  RETURN
.
.         
.******************************************************************************
.*                      Add bulk encounters                                   *
.******************************************************************************
ADDB0000  MOVE      ZERO,COUNTBOK
          MOVE      "0",SINGENC
          CALL      CLALLENC                     * Clear encounter fiels
          MOVE      CHECKBX2,SAVCKBX2            * Save last enc checkbox
.
          MATCH     SP70,BULKEKEY[ONE]           * Must select at least one
          GOTO      ADDB9100 IF EQUAL            * appointment
.
ADDB1000  ADD       ONE,COUNTBOK
.
          COMPARE   FORTY5,COUNTBOK
          GOTO      ADDB9000 IF NOT LESS
.
          MATCH     SP70,BULKEKEY[COUNTBOK]      * Any more bookings to write
          GOTO      ADDB9000 IF EQUAL
.
          MOVE      SAVCKBX2,CHECKBX2            * restore last enc checkbox
          MOVE      SP70,OUTADMIS
          UNPACK    BULKEKEY[COUNTBOK],ADMISSNO,OUTADMIS
.
          CALL      SACR0000                * Checks for SAC referral links
          CALL      CHKOUT00      * Check for future OP visit for close referral
.
          MOVE      OUTADMIS,ALENC008
.
          MOVE      BULKEKEY[COUNTBOK],KEY8
          CALL      RDALREF1                * read the referral table
          BRANCH    OVRCD,ADDB9400
.
          MOVE      ALREURNO,URNUMBER
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ADDB9200
.
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MATCH     "1",ALDEPENC          * Don't allow enc on primary ref
            GOTO      ADDB9500 IF EQUAL
          ENDIF
.
          CALL      BVLIDT00                * Check Date and Time
          BRANCH    EXIT,ADDB1000
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDB9200
.
          MATCH     "S",TCINDC28            * No contact/check in time edit
          GOTO      ADDB2000 IF EQUAL
.
          MATCH     "D",TCINDC28            * No contact/check in time edit
          GOTO      ADDB2000 IF EQUAL
.
          CALL      CHKODT00                * Check OP date and time edits
          BRANCH    EXIT,ADDB1000
.
ADDB2000  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDB9300
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDB9300
.
          IF        PCEASE=1
            MATCH    SP70,PDECDTE
            IF       @EQUAL
              CLEAR     WEBTITLE
              APPEND    "Patient is Deceased - ",WEBTITLE
              APPEND    ALREURNO,WEBTITLE
              RESET     WEBTITLE
              ADD       ONE,WARCOUNT
              MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            ELSE
              MATCH     Z70,ALENC005
              IF        !@EQUAL
                MATCH     ALENC005,PDECDTE         * Check encounter date
                IF       @LESS
                  CLEAR     WEBTITLE
                  APPEND    "Patient is Deceased - ",WEBTITLE
                  APPEND    ALREURNO,WEBTITLE
                  RESET     WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                ENDIF
              ELSE
                PACK      CURRDATE,CCC,CYY,CMM,CDD
                MATCH     CURRDATE,PDECDTE         * check encounter date
                IF       @LESS
                  CLEAR     WEBTITLE
                  APPEND    "Patient is Deceased - ",WEBTITLE
                  APPEND    ALREURNO,WEBTITLE
                  RESET     WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                ENDIF
              ENDIF
  
            ENDIF
          ENDIF
.
          CALL      NEWBEN00
.
          MATCH     "1",ALDEUY1             * Using ERC Labels
          IF        @EQUAL
            CALL      NEWERC00              * Write record to ERC Table
            CLEAR     WEBTITLE
            APPEND    "Photo Number - ",WEBTITLE
            APPEND    ALERPHOT,WEBTITLE
            APPEND    " U/R - ",WEBTITLE
            APPEND    ALREURNO,WEBTITLE
            RESET     WEBTITLE
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ENDIF
.
          CALL      WEDT0000                * Write EDWARD OP visit alteration
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
.--------*T0865480-Start
          CALL      ACLOS000                * Auto close Primary referral
.--------*T0865480-End
.
          PACK      KEY8,OUTADMIS,SP70           * Read OP booking
          CALL      RDBOKB1             
          BRANCH    OVRCD,ADDB1000,ADDB1000      * skip if invalid or locked
.
          MATCH     SP70,OTBBADCS
          IF        @EQUAL
            MATCH     "1",ALCNSDOC        * Don't update OP seen by Dr
            IF        !@EQUAL
              MOVE      ALENHCP,OTBBADCS           * Actual Dr Seen
            ENDIF
          ENDIF
.
          MATCH     Z70,OUTBB035
          IF        !@EQUAL
            MOVE      OUTBB035,OTBBOUTC          * Outcome
          ENDIF
.
          MATCH     Z70,ALENC006                 * Encounter time    
          GOTO      ADDB8000 IF EQUAL
.
          MATCH     SP70,OTBBCITM                * Checked in
          GOTO      ADDB8000 IF EQUAL
.
          MATCH     SP70,OTBBASTM                * Time seen blank
          GOTO      ADDB7000 IF NOT EQUAL
.
          MATCH     OTBBCITM,ALENC006            * Time Seen >= Check in time
          GOTO      ADDB7000 IF LESS
.
          MOVE      ALENC006,OTBBASTM            * Update Time seen
.
ADDB7000  MATCH     SP70,OTBBDPTM                * Any departure time
          GOTO      ADDB8000 IF NOT EQUAL
.
          CALL      CDEP0000                     * Calculate departure
.
ADDB8000  CALL      UPBOKB1                      * Update OP booking
.
          GOTO      ADDB1000 
.
ADDB9000  COMPARE   TWO,COUNTBOK
          IF        @EQUAL
            MOVE      "1",SINGENC
          ENDIF
. 
          MATCH     "1",ENCTREDR
          IF        @EQUAL
            CALL      ENCRED00
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ADDB9999
.
ADDB9100  MOVE      "Please select at least one appointment.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDB9999
.
ADDB9200  MOVE      "Department does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDB9999
.
ADDB9300  CLEAR     WEBTITLE
          APPEND    "U/R does not exist - ",WEBTITLE
          APPEND    ALREURNO,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      ADDB1000
.
ADDB9400  CLEAR     WEBTITLE
          APPEND    "Invalid Referral Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      ADDB1000
.
ADDB9500  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Contacts not allowed on ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referrals - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      ADDB1000
.
ADDB9999  RETURN
.
.*****************************************************************************
. Calculate the OP departure time                                            *
.*****************************************************************************
CDEP0000  MATCH     SP70,OTBBDPTM
          GOTO      CDEP9999 IF NOT EQUAL
.
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      CDEP9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      CDEP9999 IF EQUAL
.
          UNPACK    ALENSTIM,KEY2,KEY1,MIN  * HH:MM
          MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
.
          ADD       ALENDIUN,MINUTES        * Add direct units to minutes
          ASSIGN    MINUTES-SIXTY,TIME
          IF        TIME >= 0
            IF        TIME >= 540
                MOVE      TIME,MINUTES
                ASSIGN    MINUTES-HUND20,TIME
                ASSIGN    TIME-HUND20,TIME
                ASSIGN    TIME-HUND20,TIME
                ASSIGN    TIME-HUND20,TIME
                ASSIGN    TIME-SIXTY,TIME
                MOVE      TIME,MINTIME
                MOVE      MINTIME,MIN
                ADD       TEN,HOUR                              * Add Ten Hours
            ELSE
              IF        TIME >= 480
                  MOVE      TIME,MINUTES
                  ASSIGN    MINUTES-HUND20,TIME
                  ASSIGN    TIME-HUND20,TIME
                  ASSIGN    TIME-HUND20,TIME
                  ASSIGN    TIME-HUND20,TIME
                  MOVE      TIME,MINTIME
                  MOVE      MINTIME,MIN
                  ADD       NINE,HOUR                           * Add Nine Hours
              ELSE
                IF        TIME >= 420
                    MOVE      TIME,MINUTES
                    ASSIGN    MINUTES-HUND20,TIME
                    ASSIGN    TIME-HUND20,TIME
                    ASSIGN    TIME-HUND20,TIME
                    ASSIGN    TIME-SIXTY,TIME
                    MOVE      TIME,MINTIME
                    MOVE      MINTIME,MIN
                    ADD       EIGHT,HOUR                        * Add Eight Hours
                ELSE
                  IF        TIME >= 360
                      MOVE      TIME,MINUTES
                      ASSIGN    MINUTES-HUND20,TIME
                      ASSIGN    TIME-HUND20,TIME
                      ASSIGN    TIME-HUND20,TIME
                      MOVE      TIME,MINTIME
                      MOVE      MINTIME,MIN
                     ADD       SEVEN,HOUR                       * Add Seven Hours
                  ELSE
                    IF        TIME >= 300
                        MOVE      TIME,MINUTES
                        ASSIGN    MINUTES-HUND20,TIME
                        ASSIGN    TIME-HUND20,TIME
                        ASSIGN    TIME-SIXTY,TIME
                        MOVE      TIME,MINTIME
                        MOVE      MINTIME,MIN
                        ADD       SIX,HOUR                      * Add Six Hours
                    ELSE
                      IF        TIME >= 240
                         MOVE      TIME,MINUTES
                         ASSIGN    MINUTES-HUND20,TIME
                         ASSIGN    TIME-HUND20,TIME
                         MOVE      TIME,MINTIME
                         MOVE      MINTIME,MIN
                         ADD       FIVE,HOUR                    * Add Five Hours
                      ELSE
                        IF        TIME >= 180
                           MOVE      TIME,MINUTES
                           ASSIGN    MINUTES-HUND20,TIME
                           ASSIGN    TIME-SIXTY,TIME
                           MOVE      TIME,MINTIME
                           MOVE      MINTIME,MIN
                           ADD       FOUR,HOUR                  * Add Four Hours
                        ELSE
                          IF        TIME >= 120
                             MOVE      TIME,MINUTES
                             ASSIGN    MINUTES-HUND20,TIME
                             MOVE      TIME,MINTIME
                             MOVE      MINTIME,MIN
                             ADD       THREE,HOUR               * Add Three Hours
                          ELSE
                            IF        TIME >= 60
                               MOVE      TIME,MINUTES
                               ASSIGN    MINUTES-SIXTY,TIME
                               MOVE      TIME,MINTIME
                               MOVE      MINTIME,MIN
                               ADD       TWO,HOUR               * Add Two Hours
                            ELSE
                              MOVE      TIME,MINTIME
                              MOVE      MINTIME,MIN
                              ADD       ONE,HOUR                * Add One Hour
                            ENDIF
                          ENDIF
                        ENDIF
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ELSE
            MOVE      MINUTES,MINTIME              * No Hour Change
            MOVE      MINTIME,MIN
          ENDIF
.
. IF departure time is > 23:59 then hardcode it to 23:59
.
          IF        HOUR >= TWENTY4
            MOVE      TWENTY3,HOUR
            MOVE      FIFTY9,MINTIME
            MOVE      MINTIME,MIN
          ENDIF
.
          PACK      OTBBDPTM,HOUR,COLON,MIN  * pack time save variable (HH:MM)
          REP       " 0",OTBBDPTM            * replace spaces with zero
.
CDEP9999  RETURN
.
.*****************************************************************************
. Add New Bulk Encounter to a Referral                                       *
.*****************************************************************************
NEWBEN00  MATCH     "1",CHECKBX2
          IF        @EQUAL
            CALL      LASTEN00             * Add Last Encounter
            GOTO      NEWBEN10
          ENDIF
.
          MATCH     "0",CHECKBX1
          IF        @EQUAL
            CALL      WLSTEN00             * Stay On Waiting List
          ENDIF
.
          CALL      FAPD0000                * Set first appointment booked
          MOVE      ALREPRTY,SAVVPRTY       * Save referral priority
          MOVE      ALRETRGS,SAVVTRGS  * Save referral triage status
          MOVE      ALREVISN,SAVVREFN  * Referral number
          MOVE      ZERO,EPAUDFLG      * init. audit flags
          MOVE      ZERO,RIAUDFLG
          PROC      VDEF0000           * VINAH Field defaults
.
          MATCH     Z70,ALENC118
          IF        !@EQUAL
            MOVE      ALENC118,ALREREVD    * Update case review date on referral
            CALL      URMHI000             * Set MHINC indicator
            CALL      UPALREF1
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN3,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
          ENDIF
.
          MATCH     Z70,ALREF006
          IF        !@EQUAL
            MOVE      ALREF006,ALRERCLO
            CALL      UPALREF1
          ENDIF
.
NEWBEN10  MOVE      TRNSFSRC,ALENC122       * Referred to Hospital (patvadaf)
          MOVE      OUTBB035,ALENC125       * Outcome (Cat OZ)
.
          CALL      CDUEN000                * Check duplicate        *C-0844584
          BRANCH    EXIT,NEWBEN99           * encounters
.
          CALL      ADDENC00                * Add Encounter With Referal
          BRANCH    EXIT,NEWBEN91
.
          CALL      CHKBIL00
          BRANCH    EXIT,NEWBEN90
.         
          CALL      ALLBIL00                * For Billing
.
          PACK      KEY16,ALENVISN,ALENENCT,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,NEWBEN90
.         
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALEN00
.
          MOVE      PRHDUNIQ,ALENUNIQ
          CALL      UPENCF00                * Get update date/time/userid values
          CALL      UPALENC1                * Updating encounter table
.
          MOVE      THREE,AUDTTYPE           * after history record
          CALL      WAALEN00
.         
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEU                * write message to broadcast queue
.
NEWBEN90  MOVE      ZERO,EXIT
          GOTO      NEWBEN99
.
NEWBEN91  CLEAR     WEBTITLE
          APPEND    "Contact limit of 99999999 has been reached. ",WEBTITLE
          APPEND    "Please close this referral - ",WEBTITLE
          APPEND    ALREVISN,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      NEWBEN99
.
NEWBEN99  RETURN
.
.******************************************************************************
.*                      VALIDATE DATE& TIME FOR ADD ENCOUNTER WITH REFERRAL   *
.******************************************************************************
BVLIDT00  CLOCK     TIME,CTIMEIS
          PACK      CDATE,CCC,CYY,CMM,CDD
          REP       " 0",CDATE
          MOVE      ZERO,EXIT
          MATCH     "4",ALRESTAT            * Cancelled(4) referral
          GOTO      BVLIDT90 IF EQUAL
.
          MATCH     SP70,ALRERDAT
          GOTO      BVLIDT95 IF EQUAL
.
          MATCH     ALRERDAT,ALENC005       * Check If ALENC05>=ALREDAT
          GOTO      BVLIDT91 IF LESS        * Check for contact date equal to
.                                           * or greater than the Referral dt
          MOVE      ALRESTAT,F1
          ADD       ONE,F1
          BRANCH    F1,BVLIDT10,BVLIDT20,BVLIDT30,BVLIDT40
          GOTO      BVLIDT99
.
BVLIDT10                                    * Validation for Wating(0) Referral
BVLIDT20  MATCH     ALENC005,CDATE          * Same for Active(1)
          GOTO      BVLIDT92 IF LESS
          MATCH     ALENC005,CDATE
          IF        @EQUAL
            MATCH     ALENC006,CTIMEIS
            GOTO      BVLIDT92 IF LESS
          ENDIF
          GOTO      BVLIDT99
.                                           * Referral Closed (2)
BVLIDT30  MATCH     ALENC005,ALREDCLO       * Check closed date
          GOTO      BVLIDT93 IF LESS
          MATCH     ALENC005,ALREDCLO       * Check closed date
          IF        @EQUAL
            MATCH     ALENC006,ALRETCLO
            GOTO      BVLIDT93 IF LESS
          ENDIF
          GOTO      BVLIDT99
.                                           * Referral Inactive(3)
BVLIDT40  MATCH     ALENC005,ALREDINA       * Check inactive code
          GOTO      BVLIDT94 IF LESS
          MATCH     ALENC005,ALREDINA       * Check inactive code
          IF        @EQUAL
            MATCH     ALENC006,ALRETINA
            GOTO      BVLIDT94 IF LESS
          ENDIF
          GOTO      BVLIDT99
.
BVLIDT90  CLEAR     WEBTITLE
          APPEND    "Contact Cannot be added to a Cancelled ",WEBTITLE
          APPEND    "Referral - ",WEBTITLE
          APPEND    ALREVISN,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ONE,EXIT
          GOTO      BVLIDT99
.
BVLIDT91  CLEAR     WEBTITLE
          APPEND    "Contact date/time must be greater ",WEBTITLE
          APPEND    "than referral - ",WEBTITLE
          APPEND    ALREVISN,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ONE,EXIT
          GOTO      BVLIDT99
.
BVLIDT92  CLEAR     WEBTITLE
          APPEND    "Contact date/time should not be in future ",WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ONE,EXIT
          GOTO      BVLIDT99
.
BVLIDT93  CLEAR     WEBTITLE
          APPEND    "Contact date/time must be less ",WEBTITLE
          APPEND    "than closed referral - ",WEBTITLE
          APPEND    ALREVISN,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ONE,EXIT
          GOTO      BVLIDT99
.
BVLIDT94  CLEAR     WEBTITLE
          APPEND    "Contact date and time must less than inactive - ",WEBTITLE
          APPEND    ALREVISN,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ONE,EXIT
          GOTO      BVLIDT99
.
BVLIDT95  CLEAR     WEBTITLE
          APPEND    "Referral date cannot be blank",WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ONE,EXIT
          GOTO      BVLIDT99
.
BVLIDT99  RETURN
.
.******************************************************************************
.*  Validate the contact date with the OP check in time                       *
.******************************************************************************
CHKODT00  MOVE      ZERO,EXIT
.
          PACK      KEY8,OUTADMIS,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,CHKODT99
.
          MATCH     Z70,ALENC005            * Contact date
          GOTO      CHKODT99 IF EQUAL
.
          MATCH     Z70,ALENC006            * Contact time
          GOTO      CHKODT99 IF EQUAL
.
          MATCH     SP70,OTBBCITM           * Check In Time seen
          GOTO      CHKODT99 IF EQUAL
.
          MATCH     ALENC005,OBADATE        * Check booking date
          GOTO      CHKODT99 IF NOT EQUAL
.
          MATCH     OTBBCITM,ALENC006       * Contact/Check in time
          GOTO      CHKODT99 IF NOT LESS
.
CHKODT90  CLEAR     WEBTITLE
          APPEND    "Contact time should be after ",WEBTITLE
          APPEND    "check in time. U/R - ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          RESET     WEBTITLE
          IF        WARCOUNT<95
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ENDIF
          MOVE      ONE,EXIT
          GOTO      CHKODT99
.
CHKODT99  RETURN
.
.******************************************************************************
.*           Routine for Medication details                                   *
.******************************************************************************
ALLMED00  MATCH     SP70,UPDATETY
          GOTO      ALLMED40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add medication
          GOTO      ALLMED10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update medication
          GOTO      ALLMED20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete medication
          GOTO      ALLMED30 IF EQUAL
.
          GOTO      ALLMED95
.
.        *************ADD FORMACTION*************
.
ALLMED10  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ONE,F8
          PACK      KEY24,ENCOUTKY,Z70
          CALL      RSALEMD1
          CALL      RPALEMD1
          BRANCH    OVRCD,ALLMED15
          MATCH     ADMISSNO,ALEMVISN
          GOTO      ALLMED15 IF NOT EQUAL
.
          MATCH     ALENENCT,ALEMENCT
          GOTO      ALLMED15 IF NOT EQUAL
.
          MOVE      ALEMMCNT,F8
          ADD       ONE,F8
.
ALLMED15  CALL      CLRMED00                * clearing all file variables
          MOVE      F8,ALEMMCNT
          MOVE      "0",ALACSTAT
          CALL      MVALEM00                * moving cgi var to file variables
          CALL      IBACLOCK
          PACK      ALEMCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALEMCDAT 
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,ALEMCTIM
          MOVE      USERID,ALEMCUID
          PACK      ALEMVISN,ADMISSNO,SP70
          PACK      ALEMENCT,ALENENCT,SP70
          PACK      KEY24,ALEMVISN,ALEMENCT,ALEMMCNT,SP70
          CALL      WRALEMD1                * writing record into allactaf
.         BRANCH    OVRCD,ALLMED95
          MOVE      ZERO,EXIT
          GOTO      ALLMED99
.
.       *************UPDATE FORMACTION******************
.
ALLMED20  CALL      CLRMED00                * clearing all file variables
          PACK      KEY24,ALEMD001,ALEMD002,ALEMD003,SP70
          CALL      RDALEMD1                * reading the record to update
          BRANCH    OVRCD,ALLMED96
          CALL      MVALEM00                * moving cgi var to file variables
          PACK      ALEMUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALEMUDAT 
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,ALEMUTIM
          MOVE      USERID,ALEMUUID
          CALL      UPALEMD1                * calling update routine
          BRANCH    OVRCD,ALLMED95
          MOVE      ZERO,EXIT
          GOTO      ALLMED99
.
.        ************DELETE FORMACTION***************
.
ALLMED30  CALL      CLRMED00                * clearing all file variables
          PACK      KEY24,ALEMD001,ALEMD002,ALEMD003,SP70
          CALL      DEALEMD1                * deleting the redord
          BRANCH    OVRCD,ALLMED95
          MOVE      ZERO,EXIT
          GOTO      ALLMED99
.
.       ***************DISPLAY FORMACTION***************
.
ALLMED40  CALL      CLRMED00
.
          RESET     ENCOUTKY
          MATCH     SP70,ENCOUTKY
          IF        !@EQUAL
            UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
            MOVE      ADMISSNO,ALENVISN
            PACK      KEY16,ENCOUTKY,SP70
            CALL      RDALENC1
            IF        OVRCD = 1
              CALL      CLALLENC
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
          MATCH     Z70,ALEMD001
          GOTO      ALLMED50 IF EQUAL
.
          PACK      KEY24,ALEMD001,ALEMD002,ALEMD003,SP70
          CALL      RDALEMD1
          BRANCH    OVRCD,ALLMED96
.
ALLMED50  CLEAR     WEBTITLE
          MOVE      "Allied Health Medication Information",WEBTITLE
          RESET     WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00
.
          MATCH     SP70,DEPTCODE
          IF        @EQUAL
            MOVE      WBSEDALL,DEPTCODE
          ENDIF
.
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      ALREURNO,URNUMBER
          ENDIF     
. 
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1 
          BRANCH    OVRCD,ALLMED98
.         
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLMED98 
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,ALLMED99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLMED99
.
.        *********** ERROR MESSAGES **************
.
ALLMED95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLMED99
.
ALLMED96  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLMED99
.
ALLMED97  MOVE      "Contact not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLMED99
.
ALLMED98  MOVE      "U/R does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLMED99
.
ALLMED99  RETURN
.
.------------------------------------------------------------
. CLRMED00 - Clear medication details 
.------------------------------------------------------------
CLRMED00  PACK      ALEMVISN,SP70
          PACK      ALEMENCT,SP70
          PACK      ALEMMCNT,SP70
          PACK      ALEMCODE,SP70
          PACK      ALEMQANT,SP70
          PACK      ALEMUNIT,SP70
          PACK      ALEMDURA,SP70
          PACK      ALEMDTYP,SP70
          PACK      ALEMMEDR,SP70
          PACK      ALEMMEDT,SP70
          PACK      ALEMTEXT,SP70
          PACK      ALEMCDAT,SP70
          PACK      ALEMCTIM,SP70
          PACK      ALEMCUID,SP70
          PACK      ALEMUDAT,SP70
          PACK      ALEMUTIM,SP70
          PACK      ALEMUUID,SP70
          PACK      ALEMSPAR,SP70
.
          RETURN
+
.******************************************************************************
.*           Routine for Intervention details                                 *
.******************************************************************************
ALLINT00  MATCH     SP70,UPDATETY
          GOTO      ALLINT40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add intervention
          GOTO      ALLINT10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update intervention
          GOTO      ALLINT20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete intervention
          GOTO      ALLINT30 IF EQUAL
.
          GOTO      ALLINT95
.
.        *************ADD FORMACTION*************
.
ALLINT10  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ONE,F8
          PACK      KEY24,ENCOUTKY,Z70
          CALL      RSALITV1
          CALL      RPALITV1
          BRANCH    OVRCD,ALLINT15
          MATCH     ADMISSNO,ALIVVISN
          GOTO      ALLINT15 IF NOT EQUAL
.
          MATCH     ALENENCT,ALIVENCT
          GOTO      ALLINT15 IF NOT EQUAL
.
          MOVE      ALIVICNT,F8
          ADD       ONE,F8
.
ALLINT15  CALL      CLRITV00                * clearing all file variables
          MOVE      F8,ALIVICNT
          CALL      MVALIV00                * moving cgi var to file variables
          CALL      IBACLOCK
          PACK      ALIVCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALIVCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,ALIVCTIM
          MOVE      USERID,ALIVCUID
          PACK      ALIVVISN,ADMISSNO,SP70
          PACK      ALIVENCT,ALENENCT,SP70
          PACK      ALIVENCT,ALIVENCT,SP70
          PACK      KEY24,ALIVVISN,ALIVENCT,ALIVICNT,SP70
          CALL      WRALITV1                * writing record into allitvaf
          BRANCH    OVRCD,ALLINT95
          MOVE      ZERO,EXIT
          GOTO      ALLINT99
.
.       *************UPDATE FORMACTION******************
.
ALLINT20  CALL      CLRITV00                * clearing all file variables
          PACK      KEY24,ALITV001,ALITV002,ALITV003,SP70
          CALL      RDALITV1                * reading the record to update
          BRANCH    OVRCD,ALLINT96
          CALL      MVALIV00                * moving cgi var to file variables
          PACK      ALIVUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALIVUDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,ALIVUTIM
          MOVE      USERID,ALIVUUID
          CALL      UPALITV1                * calling update routine
          BRANCH    OVRCD,ALLINT95
          MOVE      ZERO,EXIT
          GOTO      ALLINT99
.
.        ************DELETE FORMACTION***************
.
ALLINT30  CALL      CLRITV00                * clearing all file variables
          PACK      KEY24,ALITV001,ALITV002,ALITV003,SP70
          CALL      DEALITV1                * deleting the redord
          BRANCH    OVRCD,ALLINT95
          MOVE      ZERO,EXIT
          GOTO      ALLINT99
.
.       ***************DISPLAY FORMACTION***************
.
ALLINT40  CALL      CLRITV00
.
          RESET     ENCOUTKY
          MATCH     SP70,ENCOUTKY
          IF        !@EQUAL
            UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
            MOVE      ADMISSNO,ALENVISN
            PACK      KEY16,ENCOUTKY,SP70
            CALL      RDALENC1
            IF        OVRCD = 1
              CALL      CLALLENC
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
          MATCH     Z70,ALITV001
          GOTO      ALLINT50 IF EQUAL
.
          PACK      KEY24,ALITV001,ALITV002,ALITV003,SP70
          CALL      RDALITV1
          BRANCH    OVRCD,ALLINT96
.
ALLINT50  CLEAR     WEBTITLE
          MOVE      "Allied Health Intervention Information",WEBTITLE
          RESET     WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00
.
          MATCH     SP70,DEPTCODE
          IF        @EQUAL
            MOVE      WBSEDALL,DEPTCODE
          ENDIF
.
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      ALREURNO,URNUMBER
          ENDIF     
. 
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALLINT98
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLINT98
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,ALLINT99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
.        *********** ERROR MESSAGES **************
.
ALLINT95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
ALLINT96  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
ALLINT97  MOVE      "Contact not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
ALLINT98  MOVE      "U/R does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
ALLINT99  RETURN
.
.------------------------------------------------------------
. CLRITV00 - Clear intervention details
.------------------------------------------------------------
CLRITV00  PACK      ALIVVISN,SP70
          PACK      ALIVENCT,SP70
          PACK      ALIVICNT,SP70
          PACK      ALIVCODE,SP70
          PACK      ALIVDURA,SP70
          PACK      ALIVCDAT,SP70
          PACK      ALIVCTIM,SP70
          PACK      ALIVCUID,SP70
          PACK      ALIVUDAT,SP70
          PACK      ALIVUTIM,SP70
          PACK      ALIVUUID,SP70
          PACK      ALIVSPAR,SP70
.
          RETURN
+
.******************************************************************************
.*           Routine for Residential Admissions                               *
.******************************************************************************
ALLRAD00  MATCH     SP70,UPDATETY
          GOTO      ALLRAD40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add residential admission
          GOTO      ALLRAD10 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete residential admission
          GOTO      ALLRAD30 IF EQUAL
.
          GOTO      ALLRAD95
.
.        *************ADD FORMACTION*************
.
ALLRAD10  MOVE      SP70,ALRALADM           * clearing all file variables
.
          CALL      LNKINP00
          BRANCH    EXIT,ALLRAD99
.
          CALL      IBACLOCK
          PACK      ALRACDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRACDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,ALRACTIM
          MOVE      USERID,ALRACUID
          PACK      ALRAVISN,ADMISSNO,SP70
          PACK      ALRALADM,ALRSA002,SP70
          PACK      KEY16,ALRAVISN,ALRALADM,SP70
          CALL      RAALRSA1
          IF        OVRCD=1
            CALL      WRALRSA1                * writing record into allitvaf
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      ALLRAD99
.
.        ************DELETE FORMACTION***************
.
ALLRAD30  PACK      KEY16,ALRSA001,ALRSA002,SP70
          CALL      DEALRSA1                * deleting the redord
          BRANCH    OVRCD,ALLRAD95
          MOVE      ZERO,EXIT
          GOTO      ALLRAD99
.
ALLRAD40  MATCH     SP70,ALRSA001
          GOTO      ALLRAD50 IF EQUAL
.
          PACK      KEY16,ALRSA001,ALRSA002,SP70
          CALL      RDALRSA1
          BRANCH    OVRCD,ALLRAD96
.
ALLRAD50  CLEAR     WEBTITLE
          MOVE      "Allied Health Residential Admissions",WEBTITLE
          RESET     WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00
.
          MATCH     SP70,DEPTCODE
          IF        @EQUAL
            MOVE      WBSEDALL,DEPTCODE
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALLRAD97
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLRAD97
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,ALLINT99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
.        *********** ERROR MESSAGES **************
.
ALLRAD95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
ALLRAD96  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLINT99
.
ALLRAD97  MOVE      "U/R does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                
          GOTO      ALLRAD97
.
ALLRAD99  RETURN
.
.-------------------------------------------------------------------------
. When a waiting referral is linked to Inpatient, check to ensure that the
. admission date is equal or greater than the referral date, If it is not,
. show error. Otherwise, Update the status of referral from Waiting to
. Active
.-------------------------------------------------------------------------
LNKINP00  MOVE      ZERO,EXIT
          PACK      KEY8,ALRSA002,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,LNKINP98
.
          CALL      RDMISS1
          BRANCH    OVRCD,LNKINP98
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LNKINP99
.
          MATCH     ALRERDAT,ADATE
          GOTO      LNKINP97 IF LESS
.
          MATCH     "0",ALRESTAT                 * check if waiting status
          GOTO      LNKINP99 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LNKINP99
.
          MOVE      "1",ALRESTAT
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
          CALL      UPALREF1
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          GOTO      LNKINP99
.
LNKINP97  MOVE      "Inpatient Admission Date must be the same as or ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "greater than the referral date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKINP99
.
LNKINP98  CLEAR     WEBTITLE
          APPEND    "Invalid linked visit type. You can only ",WEBTITLE
          APPEND    "link to Inpatient visits",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKINP99
.
LNKINP99  RETURN
.
.------------------------------------------------------------
. CLRRAD00 - Clear Residential Admission details
.------------------------------------------------------------
CLRRAD00  PACK      ALRAVISN,SP70
          PACK      ALRALADM,SP70
          PACK      ALRACDAT,SP70
          PACK      ALRACTIM,SP70
          PACK      ALRACUID,SP70
          PACK      ALRAUDAT,SP70
          PACK      ALRAUTIM,SP70
          PACK      ALRAUUID,SP70
          PACK      ALRASPAR,SP70
.
          RETURN
+
.-----------------------------------------------------------------------------.
.     Residential Admission List
.-----------------------------------------------------------------------------.
RADM0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRSA1
RADM1000  CALL      RKALRSA1
          BRANCH    OVRCD,RADM9999
.
          MATCH     ADMISSNO,ALRAVISN
          GOTO      RADM9999 IF NOT EQUAL
.
          PACK      KEY8,ALRALADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,RADM1000
.
          MATCH     "5",DASTAT
          GOTO      RADM1000 IF EQUAL
.
          MOVE      "AC",CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPEDES
.
          MOVE      "A ",CATEGORY
          MOVE      ATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      SP70,DISCDATE
.          MOVE      PVIBILL,KEY8
          MOVE      ALRALADM,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,RADM1100
.
.          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
.          CALL      PACDATE
.          REP       " 0",CPCDATE
.          MOVE      CMON,F2
.          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      DISCDATE,DDATE,SP10
.
RADM1100  MOVE      ADOCTA,KEY6           * Read the doctor's file to get nam
          CALL      RDDOCT1
          IF        OVRCD=1
            CLEAR     DOCFNAME
            APPEND    "Invalid Doctor - ",DOCFNAME
            APPEND    PVIDOCT,DOCFNAME
            RESET     DOCFNAME
          ELSE
.           CALL      DOCNAM00             * format doctors name
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000     
          ENDIF
.
          REP       " +",ADMISSNO
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AdmissionLink('",HTMLLINK
          APPEND    AADMNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",ALRALADM,"#",":                   * 1
                             "#"",ADATE,"#",":                      * 2
                             "#"",ATIME,"#",":                      * 3
                             "#"",DTYPEDES,"#",":                   * 4
                             "#"",DISCDATE,"#",":                   * 5
                             "#"",DOCFNAME,"#",":                   * 6
                             "#"",ATYPDESC,"#",":                     * 7
                             "#"javascript:removeLink('",ALRALADM,"');#"":       * 8
                             ");"
          REP       "+ ",ADMISSNO
          GOTO      RADM1000
.
RADM9999  RETURN
+
.******************************************************************************
.*           Routine for Supplies detail                                      *
.******************************************************************************
ALLSUP00  MATCH     SP70,UPDATETY
          GOTO      ALLSUP40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add supplies
          GOTO      ALLSUP10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update supplies
          GOTO      ALLSUP20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete supplies
          GOTO      ALLSUP30 IF EQUAL
.
          GOTO      ALLSUP95
.
.        *************ADD FORMACTION*************
.
ALLSUP10  UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
          MOVE      ONE,F8
          PACK      KEY24,ENCOUTKY,Z70
          CALL      RSALSUP1
          CALL      RPALSUP1
          BRANCH    OVRCD,ALLSUP15
          MATCH     ADMISSNO,ALSPVISN
          GOTO      ALLSUP15 IF NOT EQUAL
.
          MATCH     ALENENCT,ALSPENCT
          GOTO      ALLSUP15 IF NOT EQUAL
.
          MOVE      ALSPSCNT,F8
          ADD       ONE,F8
.
ALLSUP15  CALL      CLRSUP00                * clearing all file variables
          MOVE      F8,ALSPSCNT
          CALL      MVALSP00                * moving cgi var to file variables
          CALL      IBACLOCK
          PACK      ALSPCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSPCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,ALSPCTIM
          MOVE      USERID,ALSPCUID
          PACK      ALSPVISN,ADMISSNO,SP70
          PACK      ALSPENCT,ALENENCT,SP70
          PACK      ALSPENCT,ALSPENCT,SP70
          PACK      KEY24,ALSPVISN,ALSPENCT,ALSPSCNT,SP70
          CALL      RAALSUP1
          IF        OVRCD<>1
            GOTO      ALLSUP98
          ENDIF
.
          CALL      WRALSUP1                * writing record into allsupaf
          MOVE      ZERO,EXIT
          GOTO      ALLSUP99
.
.       *************UPDATE FORMACTION******************
.
ALLSUP20  CALL      CLRSUP00                * clearing all file variables
          PACK      KEY24,ALSUP001,ALSUP002,ALSUP003,SP70
          CALL      RDALSUP1                * reading the record to update
          BRANCH    OVRCD,ALLSUP96
          CALL      MVALSP00                * moving cgi var to file variables
          PACK      ALSPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSPUDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,ALSPUTIM
          MOVE      USERID,ALSPUUID
          CALL      UPALSUP1                * calling update routine
          BRANCH    OVRCD,ALLSUP95
          MOVE      ZERO,EXIT
          GOTO      ALLSUP99
.
.        ************DELETE FORMACTION***************
.
ALLSUP30  CALL      CLRSUP00                * clearing all file variables
          PACK      KEY24,ALSUP001,ALSUP002,ALSUP003,SP70
          CALL      DEALSUP1                * deleting the redord
          BRANCH    OVRCD,ALLSUP95
          MOVE      ZERO,EXIT
          GOTO      ALLSUP99
.
.       ***************DISPLAY FORMACTION***************
.
ALLSUP40  CALL      CLRSUP00
.
          RESET     ENCOUTKY
          MATCH     SP70,ENCOUTKY
          IF        !@EQUAL
            UNPACK    ENCOUTKY,ADMISSNO,ALENENCT
            MOVE      ADMISSNO,ALENVISN
            PACK      KEY16,ENCOUTKY,SP70
            CALL      RDALENC1
            IF        OVRCD = 1
              CALL      CLALLENC
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
          MATCH     Z70,ALSUP001
          GOTO      ALLSUP50 IF EQUAL
.
          PACK      KEY24,ALSUP001,ALSUP002,ALSUP003,SP70
          CALL      RDALSUP1
          BRANCH    OVRCD,ALLSUP96
.
ALLSUP50  CLEAR     WEBTITLE
          MOVE      "Allied Health Supplies Information",WEBTITLE
          RESET     WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00
.
          MATCH     SP70,DEPTCODE
          IF        @EQUAL
            MOVE      WBSEDALL,DEPTCODE
          ENDIF
.
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      ALREURNO,URNUMBER
          ENDIF     
. 
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALLSUP94
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLSUP94
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,ALLSUP99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLSUP99
.
.        *********** ERROR MESSAGES **************
.
ALLSUP94  MOVE      "U/R does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUP99
.
ALLSUP95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUP99
.
ALLSUP96  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUP99
.
ALLSUP97  MOVE      "Contact not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUP99
.
ALLSUP98  MOVE      "Record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUP99
.
ALLSUP99  RETURN
.
.------------------------------------------------------------
. CLRSUP00 - Clear Supplies details
.------------------------------------------------------------
CLRSUP00  PACK      ALSPVISN,SP70
          PACK      ALSPENCT,SP70
          PACK      ALSPSCNT,SP70
          PACK      ALSPSCOD,SP70
          PACK      ALSPCDAT,SP70
          PACK      ALSPCTIM,SP70
          PACK      ALSPCUID,SP70
          PACK      ALSPUDAT,SP70
          PACK      ALSPUTIM,SP70
          PACK      ALSPUUID,SP70
          PACK      ALSPAPPN,SP70
          PACK      ALSPSPAR,SP70
          MOVE      ZERO,ALSPQNTY
          MOVE      ZERO,ALSPPRCE
.
          RETURN
.
.------------------------------------------------------------
. Display Patient Encounters By HCP/Department and Date
.------------------------------------------------------------
BENC0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Number of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
          MOVE      ZERO,LOOPCNTR           * Keep alive loop counter
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
.          PACK      KEY42,DOCTCODE,LASTDATE,Z70 * Pack userid to read allencaf
.          CALL      RSALENC2                * Call Positional read routine
.BENC1010  CALL      RPALENC2                * Call Sequential read
.          BRANCH    OVRCD,BENC9999
.
          PACK      KEY24,LASTDATE,Z70 
          CALL      RSALENC4
BENC1010  CALL      RPALENC4
          BRANCH    OVRCD,BENC9999          
.         
.          MATCH     DOCTCODE,ALENHCP        * Match HCP
.          GOTO      BENC9999 IF NOT EQUAL   
.         
          MATCH     FRSTDATE,ALENSDAT       * Checks lastdate with Service date
          GOTO      BENC9999 IF LESS
.
          ADD       ONE,LOOPCNTR
.
.  Write record number in a comment to keep apache listening if no matching
.  records are found per 100 records
.
          IF        (LOOPCNTR >=100)
            WRITE     HTMLFILE;"<!--",LOOPCNTR,"-->"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reads allrefaf to get UR no
          BRANCH    OVRCD,BENC1010
.
           COMPARE   ONE,FILTRHCP
           IF        !@EQUAL
            CALL      INDHCP00
           ENDIF
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALENHCP
            GOTO      BENC1015 IF EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      BENC1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      BENC1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      BENC1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      BENC1015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      BENC1015 IF EQUAL
            GOTO      BENC1010
          ELSE
            MATCH     DOCTCODE,ALENHCP        * Match HCP
            GOTO      BENC1010 IF NOT EQUAL
          ENDIF
.
BENC1015  MATCH     SP70,DEPTCODE             * Check Department
          IF        !@EQUAL
            MATCH     ALREDEPT,DEPTCODE
            GOTO      BENC1010 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Reads patma1af to get patient Name
          BRANCH    OVRCD,BENC1010
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,BENC1010
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000                * Returns formatted name(FORMATNM)
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO    BENC1010                * If < than strt Rec then Read Next
          ENDIF
.
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1                * Read pmshcpaf file
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE       * Move Title
            MOVE      PMHCGNAM,FMTGNAME       * Move First Name
            MOVE      PMHCSNAM,FMTSNAME       * Move Last Name
            CALL      DOCNM000                * Returns Formatted name(DOCFNAME)
          ELSE
            MOVE      "Invalid HCP",DOCFNAME
          ENDIF
.
BENC1030  IF        PTCNHDPS = 1
            UNPACK    SP70,ALSRDESC           * Occasion of Service for "NZ"
            PACK      KEY9,ALREDEPT,ALENSERV,SP10
            CALL      RDALSER1
            PACK      PATNDESC,ALSRDESC,SP70
          ELSE
            MOVE      "GI",CATEGORY
            MOVE      ALENTYPE,CODE
            CALL      GETCOD00                * Get Patient type Description
            MOVE      TDESC,PATNDESC          * Patient Description
          ENDIF
.
          MOVE      "LD",CATEGORY
          MOVE      ALACLOCA,CODE
          CALL      GETCOD00                * To get Locatin Desc(TDESC)
          MOVE      TDESC,LOCNDESC          * Location Description
.
          MOVE      "gb",CATEGORY
          MOVE      ALENCONT,CODE
          CALL      GETCOD00                * Contract Description
          MOVE      TDESC,CONTDESC 
.
          PACK      ENCOUTKY,ALENVISN,ALENENCT

          MATCH     "1",ALENRSTA
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      ZERO,LOOPCNTR           * Something displayed
.
          BRANCH    NZLAYOUT,BENC3000
.
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<a HREF ='javascript:EncounterLink":
                             "(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&encoutky=",ENCOUTKY:
                             "#");'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALENSTIM,STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    DOCFNAME,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    FORMATNM,"&nbsp",STRENDTG,"</td>":
                             "<td align=center>",STRIKETG:
                                    ALENVISN,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    PATNDESC,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDIUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENDBUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENINUN,"&nbsp",STRENDTG,"</td>":
                             "<td align=right>",STRIKETG:
                                    ALENIBUN,"&nbsp",STRENDTG,"</td></tr>"
.
          GOTO      BENC8000
.
BENC3000  WRITE     HTMLFILE;"<tr>":
                             "<td nowrap>",STRIKETG:
                             "<a HREF ='javascript:EncounterLink":
                             "(#"",LINKPRG:
                             ".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&encoutky=",ENCOUTKY:
                             "#");'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " ",ALENSTIM,STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    FORMATNM,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    ALENVISN,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    PATNDESC,"&nbsp",STRENDTG,"</td>":
                             "<td>",STRIKETG:
                                    CONTDESC,"&nbsp",STRENDTG,"</td></tr>"
.
BENC8000  ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          CALL      BENC1010 IF NOT EQUAL
.
BENC9999  RETURN
.
.------------------------------------------------------------
. Output table of linked visits for a referral
.------------------------------------------------------------
LINKT000  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,LINKT990
.         
          MOVE      ZERO,CANCFLAG
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,CANCFLAG                * to include cancelled status
.
          PACK      KEY24,ALREVISN,Z70
          CALL      RSALLNK3
LINKT100  CALL      RPALLNK3
          BRANCH    OVRCD,LINKT990
.         
          MATCH     ALREVISN,ALLNVISN            * Same referral
          GOTO      LINKT990 IF NOT EQUAL        
.
          IF        CANCFLAG<>1
            MATCH     "1",ALLNSTAT               * Cancelled
            GOTO      LINKT100 IF EQUAL
          ENDIF
.
          CALL      ROTFIL00                     * Check outpatient file prefix
.         
          PACK      KEY28,ALLNSITE,ALLNCLIN,ALLNDATE,ALLNSTRT,ALLNSLOT,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,LINKT100
.         
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1
            BRANCH    OVRCD,LINKT400
.
            MATCH     OBASITE,OCASITE
            IF        !@EQUAL
              MOVE      SP70,OCADESC
              GOTO      LINKT400
            ENDIF
.
            MATCH     OBACLIN,OCACLIN
            IF        !@EQUAL
              MOVE      SP70,OCADESC
            ENDIF
          ENDIF
.
          COMPARE   ONE,CANCFLAG
          GOTO      LINKT300 IF NOT EQUAL
.
.         Include Cancelled status
.
          MATCH     "1",ALLNSTAT                 * Cancelled status
          GOTO      LINKT300 IF NOT EQUAL
.
          PACK      KEY8,ALLNLNKV,SP70
          CALL      RDOTCAN1
          BRANCH    OVRCD,LINKT100
.
          MOVE      "Cancelled",BOOKSTAT
          GOTO      LINKT400
.
LINKT300  MOVE      SP70,BOOKSTAT
          LOAD      BOOKSTAT,OBASTAT,DBOOKED,SP1,SP1,DATTEND,DNOATTN
.
LINKT400  MOVE      SP70,DISPDAT1                * Visit Date
          COMPARE   ONE,CANCFLAG
          GOTO      LINKT500 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT                 * Cancelled status
          GOTO      LINKT500 IF NOT EQUAL
.
          UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",OPCNOUTN,"&nbsp;</td>":
                             "<td>&nbsp;</td>";
          GOTO      LINKT600
.
LINKT500  UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",OBAOUTNO,"&nbsp;</td>":
                             "<td>",PMVXUDF1,"&nbsp;</td>";
.
LINKT600  WRITE     HTMLFILE;"<td>",OCTDESC,"&nbsp;</td>":
                             "<td>",OCADESC,"&nbsp;</td>":
                             "<td>",BOOKSTAT,"&nbsp;</td></tr>"
.
          GOTO      LINKT100
.
LINKT990  WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                              "<td colspan=10 align=center>":
                              "No more Linked Outpatient Visits</td>"
.
          MOVE      ZERO,EXIT
          GOTO      LINKT999
.
LINKT999  RETURN
.
.------------------------------------------------------------
. Output table of group contact for this referral
.------------------------------------------------------------
LGRP0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LGRP9999
.
          OPEN      ALLGREA1,"allgreaf"
          OPEN      ALLGPAA2,"allgpaaf"
          OPEN      ALLGROA1,"allgroaf"
.
          CALL      CREA0000                     * Create temp file
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALGPA2
LGRP1000  CALL      RKALGPA2
          BRANCH    OVRCD,LGRP2000
.
          MATCH     ALREVISN,ALGAREFN            * Same referral
          GOTO      LGRP2000 IF NOT EQUAL
.
          MATCH     "1",ALGARCST
          GOTO      LGRP1000 IF EQUAL            * Deleted
.
          PACK      KEY8,ALGACONT,SP70
          CALL      RDALGRE1
          BRANCH    OVRCD,LGRP1000
.
          PACK      KEY8,ALGESESN,SP70
          CALL      RDALGRO1
          BRANCH    OVRCD,LGRP1000
.
          PACK      XXXXGDTE,ALGEGDTE,SP70     * Group Contact Date (CCYYMMDD)
          PACK      XXXXGTIM,ALGEGTIM,SP70     * Group Contact Time (HH:MM:SS)
          PACK      XXXXREFN,ALGAREFN,SP70     * Referral Number (allrefaf)
          PACK      XXXXCONT,ALGACONT,SP70     * Contact Number
.
          PACK      KEY32,XXXXGDTE,XXXXGTIM,XXXXREFN,XXXXCONT,SP70
          CALL      RATEMPG1
          IF        OVRCD=1
            CALL      WRTEMPG1
          ENDIF
.
          GOTO      LGRP1000
.
LGRP2000  PACK      KEY32,Z70
          CALL      RSTEMPG1
LGRP5000  CALL      RPTEMPG1
          BRANCH    OVRCD,LGRP9000
.
          PACK      KEY16,XXXXREFN,XXXXCONT,SP70
          CALL      RDALGPA2
          BRANCH    OVRCD,LGRP5000
.
          PACK      KEY8,ALGACONT,SP70
          CALL      RDALGRE1
          BRANCH    OVRCD,LGRP5000
.
          PACK      KEY8,ALGESESN,SP70
          CALL      RDALGRO1
          BRANCH    OVRCD,LGRP5000
.
          MOVE      SP70,DISPDAT1                * Contact Date
          UNPACK    ALGEGDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DESCSTAT
          MATCH     SP70,ALGAPSTA
          IF        !@EQUAL
            PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALGAPSTA,TDESC
            ENDIF
            MOVE      TDESC,DESCSTAT
          ENDIF
.
          MOVE      SP70,DESCLOCN
          MATCH     SP70,ALGELOCN
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSO,ALGELOCN,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALGELOCN,TDESC
            ENDIF
            MOVE      TDESC,DESCLOCN
          ENDIF
.
          MOVE      SP70,DESCSEST
          MATCH     SP70,ALGRSEST
          IF        !@EQUAL
            PACK      KEY5,CATGY,ALGRSEST,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALGRSEST,TDESC
            ENDIF
            MOVE      TDESC,DESCSEST
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1," at ",ALGEGTIM,"&nbsp;</td>":
                             "<td>",ALGRNAME,"&nbsp;</td>":
                             "<td>",DESCSEST,"&nbsp;</td>":
                             "<td>",DESCLOCN,"&nbsp;</td>":
                             "<td>",ALGEDURN,"&nbsp;</td>":
                             "<td>",DESCSTAT,"&nbsp;</td></tr>"
.
          GOTO      LGRP5000
.
LGRP9000  WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                              "<td colspan=10 align=center>":
                              "No more Group Contacts</td>"
.
          CALL      KILL0000                * Delete temp file
.
          MOVE      ZERO,EXIT
.
LGRP9999  RETURN
.
.*******************************************************************************
. ROTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the preferred site of the linked visit
.*******************************************************************************
ROTFIL00  MATCH     SP70,ALLNSITE            * Does the linked visit have a site
          GOTO      ROTFIL99 IF EQUAL
.
ROTFIL50  MOVE      ALLNSITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,ROTFIL99           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
ROTFIL99  RETURN
.
.******************************************************************************
. Auto activate a single waiting referral                                     *
.******************************************************************************
ACTW0000  MATCH     "1",ALCNACTW
          GOTO      ACTW9999 IF NOT EQUAL
.
          MOVE      ALREURNO,SAVEURNO                                    
          MOVE      ALREDEPT,SAVEDEPT                                    
.
          PACK      KEY3,ALREDEPT,SP70      * If the Dept Does not use Referral
          CALL      RDALDEP1
          BRANCH    OVRCD,ACTW9999
.
          MATCH     "0",ALDEREFE            * Dept uses referrals
          GOTO      ACTW9999 IF EQUAL       * no report error
.
.  Check for Active/Inactive Referral in This Department and
.  check for a single waiting referral.
.
          MOVE      SP70,SAVEVISN
          MOVE      ZERO,RACTVFLG
.
          PACK      KEY16,SAVEURNO,SP70
          CALL      RSALREF2                * Positional Read
ACTW0500  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,ACTW1000
.
          MATCH     SAVEURNO,ALREURNO
          GOTO      ACTW1000 IF NOT EQUAL
.
          MATCH     SAVEDEPT,ALREDEPT       * Match to department
          GOTO      ACTW0500 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * Waiting
          IF        @EQUAL
            MATCH     SP70,SAVEVISN
            IF        @EQUAL
              MOVE      ALREVISN,SAVEVISN   * Referral to activate
            ELSE
              MOVE      SP70,SAVEVISN
              GOTO      ACTW9999            * Exit if multiple waiting referrals
            ENDIF
          ENDIF
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      ACTW0800 IF EQUAL
.
          MATCH     "3",ALRESTAT            * Inactive
          GOTO      ACTW0800 IF EQUAL
.
          GOTO      ACTW0500
.
ACTW0800  BRANCH    OVERRIDE,ACTW0500,ACTW0500
          GOTO      ACTW9999
.
ACTW1000  MATCH     SP70,SAVEVISN           * Is there a referral to activate
          GOTO      ACTW9999 IF EQUAL
.
          PACK      KEY8,SAVEVISN,SP70
ACTW2000  CALL      RDALREF1                * Read the referral table & lock
          BRANCH    OVRCD,ACTW9999
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MATCH     "2",ALRESTAT           * Closed?
          IF        @EQUAL
            MOVE      ONE,RACTVFLG         * Re-activate referral
          ENDIF
          MOVE      "1",ALRESTAT
          MATCH     Z70,ALENC005            * Encounter date
          IF        !@EQUAL
            MOVE      ALENC005,ALREDACT
          ELSE
            PACK      ALREDACT,CCC,CYY,CMM,CDD * Date activated
            REP       " 0",ALREDACT
          ENDIF
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      URMHI000                * Set MHINC indicator
          CALL      UPALREF1                * Update referral Table (allrefaf)
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN5,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      ALREDACT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "T",ALAUUPDT            * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Re read original referral
          BRANCH    OVRCD,ACTW9999
.
          MOVE      ZERO,EXIT
.
ACTW9999  RETURN
+
.******************************************************************************
.         MHINC - Add Referral for MH Department and Primary Ref.
.******************************************************************************
ARMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ARMHI999
.
          MATCH     "M",TCINDC4
          GOTO      ARMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      ARMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MOVE      "0",ALREMOHR               * Unsent
.
ARMHI999  RETURN
+
.******************************************************************************
.         MHINC - Cancelled Encounter for MH Department and Primary Ref.
.******************************************************************************
CEMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CEMHI999
.
          MATCH     "M",TCINDC4
          GOTO      CEMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      CEMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MATCH     "1",ALENMOHR
          GOTO      CEMHI999 IF NOT EQUAL      * don't process "Sent"
.
          MATCH     "1",CANCEL                 * Cancelled?
          GOTO      CEMHI200 IF NOT EQUAL
.
.         Already sent
.
          MOVE      "2",ALENMOHR               * Set to 'Send Delete'
          GOTO      CEMHI999
.
CEMHI200  MOVE      "0",ALENMOHR               * Set to 'Unsent'
.
CEMHI999  RETURN
+
.******************************************************************************
.Check for any Waiting/Active SACS Linked Referrals                           *
.                                                                             *
.******************************************************************************
SACR0000  MATCH     "1",CHECKBX2            * Last Encounter Checkbox
          GOTO      SACR9999 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,SACR9999
.
          MATCH     "1",ALREUYN4            * SACS Referral
          GOTO      SACR9999 IF NOT EQUAL
.
SACR2000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
SACR3000  CALL      RKALRLN1
          BRANCH    OVRCD,SACR9000
.
          MATCH     ADMISSNO,ALRLVISN       * Linked referrals
          GOTO      SACR9000 IF NOT EQUAL
.
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,SACR3000
.
          MATCH     "0",ALRESTAT            * Error if waiting
          GOTO      SACR4000 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Error if active
          GOTO      SACR4000 IF EQUAL
.
          GOTO      SACR3000
.
SACR4000  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error closing ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    "referral - Waiting/Active Linked referrals exist",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
.
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ZERO,CHECKBX2                * Set last enconter cgi to no
.
          GOTO      SACR9000
.
SACR9000  PACK      KEY8,ADMISSNO,SP70            * Restore correct referral
          CALL      RDALREF1
.
SACR9999  RETURN
.
.******************************************************************************
.Check for any future linked OP visits if we are closing this referral        *
.                                                                             *
.******************************************************************************
CHKOUT00  MATCH     "1",CHECKBX2            * Last Encounter Checkbox
          GOTO      CHKOUT99 IF NOT EQUAL
.
          MATCH     Z70,ALENC005            * Exit if no close date
          GOTO      CHKOUT99 IF EQUAL
.
          MATCH     SP70,ALENC005           * Exit if no close date
          GOTO      CHKOUT99 IF EQUAL
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
CHKOUT20  CALL      RKALLNK1
          BRANCH    OVRCD,CHKOUT99
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      CHKOUT99 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      CHKOUT20 IF EQUAL
.
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,CHKOUT20
.
          MATCH     ALLNLNKV,DOBAOUTN
          GOTO      CHKOUT20 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT                  * booked
          GOTO      CHKOUT20 IF NOT EQUAL
.
CHKOUT30  MATCH     OBADATE,ALENC005             * Booking date after
          GOTO      CHKOUT20 IF NOT LESS         * proposed close date
.
CHKOUT40  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error closing referral ",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          APPEND    " - Linked visits exist after close date",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
.
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      ZERO,CHECKBX2                * Set last enconter cgi to no
.
CHKOUT99  RETURN
+
.******************************************************************************
.*                      Redirect Content URL                                  *
.******************************************************************************
PPREDI00  CALL      OPENHTML
          BRANCH    EXIT,PPREDI90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                              " alert(#"",WEBTITLE,"#");":
                             " parent.parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PPREDI99
.
PPREDI90  DISPLAY   "*** Fifo Not Found ***"
.
PPREDI99  RETURN
.******************************************************************************
.*                      Redirect Add Encounter                                *
.******************************************************************************
ENCRED00  MOVE      "allweb03.pbl?reportno=01&template=003",REDIRECT
.
          PACK      REDIRECT,REDIRECT,SP70,SP70
          STRIP     REDIRECT
          ENDSET    REDIRECT
.
          PACK      ALLDEPD3,ALREDEPT,SP70
          REP       " +",ALLDEPD3
          APPEND    "&deptcode=",REDIRECT
          APPEND    ALLDEPD3,REDIRECT
.
          PACK      ENKYDM16,ALENVISN,ALENENCT,SP70
          REP       " +",ENKYDM16
          APPEND    "&encoutky=",REDIRECT
          APPEND    ENKYDM16,REDIRECT
          RESET     REDIRECT
.
          MOVE      "1",NEXTPAGE
.
ENCRED99  RETURN
.******************************************************************************
.*                      Linked Outpatient Visit                               *
.******************************************************************************
LNKVSO00  PACK      KEY8,ADMISSNO,SP70
          CALL      RSALLNK1
          CALL      RKALLNK1
          BRANCH    OVRCD,LNKVSO99
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      LNKVSO99 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALLNLNKV;
.
LNKVSO99  RETURN
.
.******************************************************************************
.*                      Linked Outpatient Visit Clinic Type                   *
.******************************************************************************
LNKCTY00  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
LNKCTY10  CALL      RKALLNK1
          BRANCH    OVRCD,LNKCTY99
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      LNKCTY99 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      LNKCTY10 IF EQUAL
.
          MATCH     SP70,ALLNLNKV
          GOTO      LNKCTY99 IF EQUAL
          GOTO      LNKCTY99 IF EOS
.
          PACK      KEY28,ALLNSITE,ALLNCLIN,ALLNDATE,ALLNSTRT,ALLNSLOT,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,LNKCTY99
.
          MATCH     SP70,OBACTYP
          GOTO      LNKCTY99 IF EQUAL
          GOTO      LNKCTY99 IF EOS
.
.         PACK      KEY12,OBASITE,OBACTYP,SP70
.         CALL      RDCTYA1
.         BRANCH    OVRCD,LNKCTY99
.
.         WRITE     HTMLFILE;OCTGRP;
          WRITE     HTMLFILE;OBACTYP;
.
LNKCTY99  RETURN
.
.******************************************************************************
.*                      Get Previous Encounter Details                        *
.******************************************************************************
PRVENC00  PACK      KEY16,ADMISSNO,Z70
          CALL      RSALENC1
PRVENC10  CALL      RPALENC1
          BRANCH    OVRCD,PRVENC90
.
          MATCH     ADMISSNO,ALENVISN
          GOTO      PRVENC90 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA
          GOTO      PRVENC10 IF EQUAL
.
          BRANCH    FORM1,PRVENC20,PRVENC30,PRVENC40,PRVENC50,PRVENC60:
                          PRVENC70
.
          GOTO      PRVENC95
.
PRVENC20  WRITE     HTMLFILE;ALENUC37;
          GOTO      PRVENC95
.
PRVENC30  WRITE     HTMLFILE;ALENCOMP;
          GOTO      PRVENC95
.
PRVENC40  WRITE     HTMLFILE;ALENUC38;
          GOTO      PRVENC95
.
PRVENC50  WRITE     HTMLFILE;ALENUC40;
          GOTO      PRVENC95
.
PRVENC60  WRITE     HTMLFILE;ALENUC34;
          GOTO      PRVENC95
.
PRVENC70  WRITE     HTMLFILE;ALENUC35;
          GOTO      PRVENC95
.
PRVENC90  WRITE     HTMLFILE;SP3;
.
PRVENC95  CALL      CLALLENC
.
          MATCH     SP70,ENCOUTKY
          IF        !@EQUAL
            CALL      RDALENC1
          ENDIF
.
PRVENC99  RETURN
.
.------------------------------------------------------------
. Output table of linked WL procedures for a referral
.------------------------------------------------------------
LINKW000  PACK      KEY27,ALREVISN,SP70
          CALL      RSALWLN2
LINKW100  CALL      RKALWLN2                               * Loop linked WL
          BRANCH    OVRCD,LINKW900
.
          MATCH     ALREVISN,ALWLVISN                      * Same referral
          GOTO      LINKW900 IF NOT EQUAL
.
          PACK      KEY19,ALWLURNO,ALWLPCOD,ALWLPCNT,SP70
          CALL      RDTREA1                                * Read WL record
          BRANCH    OVRCD,LINKW100
.
          MOVE      SP70,DISPDAT1                          * Date in list
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      SP70,DOCFNAME
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
.
          LOAD      STATDES2,WMSTAT,WAITST01,WAITST02,WAITST03,WAITST04:
                             WAITST05,WAITST06,WAITST07,WAITST08,WAITST09
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",UNITDESC,"&nbsp;</td>":
                             "<td>",DOCFNAME,"&nbsp;</td>":
                             "<td>",WMDESC,"&nbsp;</td>":
                             "<td>",STATDES2,"&nbsp;</td>":
                             "</tr>";
.
          GOTO      LINKW100
.
LINKW900  WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                              "<td colspan=5 align=center>":
                              "No more Linked Waiting List Records</td>"
.
LINKW999  RETURN
.
.------------------------------------------------------------
. Delete the group contact display order temp file
.------------------------------------------------------------
KILL0000  CLOSE     TEMPGRP1                  * close temp file
.
          CLEAR     CMDLINE                   * clear command line
          PACK      CMDLINE,ISERASE,GRPFILNM  * set command line for erase
          RESET     CMDLINE                   * reset FP
          EXECUTE   CMDLINE,TASKID            * delete the temp file
.
KILL9999  RETURN
.
.------------------------------------------------------------
. Create the group contact display order temp file
.------------------------------------------------------------
CREA0000  CALL      KILL0000                          * Delete temp file
.
          CLEAR     CMDLINE                           * clear command line
          PACK      CMDLINE,ISBUILD,GRPFILNM,GRPFILKY,SP30     * set command
          RESET     CMDLINE                           * reset FP
          EXECUTE   CMDLINE,TASKID                    * build the temp file
          OPEN      TEMPGRP1,GRPFILNM                 * open the temp file
.
CREA9999  RETURN
.
RATEMPG1  RESET     KEY32
          MOVE      ZERO,OVRCD
          READ      TEMPGRP1,KEY32;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTEMPG1  RESET     KEY32
          READ      TEMPGRP1,KEY32;;
          RETURN
.
RPTEMPG1  MOVE      ZERO,OVRCD
          READKP    TEMPGRP1;XXXXGDTE,XXXXGTIM,XXXXREFN,XXXXCONT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMPG1  RESET     KEY32
          WRITE     TEMPGRP1,KEY32;XXXXGDTE,XXXXGTIM,XXXXREFN,XXXXCONT
          RETURN
.
.-----------------------------------------------------------------------------
.Check duplicate indicator for service code                         *C-0844584
.Read allencaf if duplicate record found then return error message
.-----------------------------------------------------------------------------
CDUEN000  MOVE      ZERO,EXIT
          MOVE      ZERO,DUPCOUNT                   * Duplicate counter
.
          MATCH     "A",UPDATETY                    * Add Encounter?
          GOTO      CDUEN050 IF EQUAL                 * Yes, check duplicates
.
          MATCH     "C",UPDATETY                    * Update Encounter?
          GOTO      CDUEN040 IF EQUAL                * Yes, check mandatory inp
.
          GOTO      CDUEN999                        * Exit, for all others
.
CDUEN040  MATCH     Z70,ALENC004                    * HCP blank ?
          GOTO      CDUEN999 IF EQUAL                * Yes, exit
.
          MATCH     Z70,ALENC005                    * Service date blank?
          GOTO      CDUEN999 IF EQUAL                * Yes, exit
.
          MATCH     Z70,ALENC006                    * Service time blank?
          GOTO      CDUEN999 IF EQUAL                * Yes, exit
.
          MATCH     Z70,ALENC010                    * Service code blank?
          GOTO      CDUEN999 IF EQUAL                * Yes, exit
.
          GOTO      CDUEN050                        
.
CDUEN050  PACK      SVHCPD10,ALENC004,SP70          * HCP input
          PACK      KEY42,SVHCPD10,ALENC005,ALENC006,ADMISSNO,SP70
          CALL      RSALENC2                        * Position allencaf
CDUEN100  CALL      RKALENC2                        * Read next allencaf record
          BRANCH    OVRCD,CDUEN999
.
          MATCH     ADMISSNO,ALENVISN               * Same visit number?
          GOTO      CDUEN999 IF NOT EQUAL            * No, exit
.
.-------- Ignore cancelled encounter records
          MATCH     "1",ALENRSTA                    * Encounter is cancelled?
          GOTO      CDUEN100 IF EQUAL                * Yes, read next record
.
.-------- Check indicator for Cat "s" code on a Service Code/Contact code
.-------- in allseraf.ALSRSPEC is set to "D"='Do not allow Duplicate Activities'
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1                        * Read allseraf table
          BRANCH    OVRCD,CDUEN100
.
          MOVE      "s ",DIM2
          PACK      KEY5,DIM2,ALSRSPEC,SP70         * Cat s on Service Code
          CALL      RDCODE1
          BRANCH    OVRCD,CDUEN100
.
          MATCH     ANSD,TCINDC2                     * Do not allow duplicates?
          GOTO      CDUEN100 IF NOT EQUAL            * No, read next record
.
.-------- Check for duplicates contact with the same Service/Contact code,
.-------- HCP, contact date and time and Service Location (LD) already saved 
.-------- in the allencaf table 
.
          MATCH     SVHCPD10,ALENHCP                * Same HCP?
          GOTO      CDUEN100 IF NOT EQUAL            * No, read next record
.
          MATCH     ALENC005,ALENSDAT               * Same Contact Date?
          GOTO      CDUEN100 IF NOT EQUAL            * No, read next record
.
          MATCH     ALENC006,ALENSTIM               * Same Contact Time?
          GOTO      CDUEN100 IF NOT EQUAL            * No, read next record
.
          MATCH     ALENC010,ALENSERV               * Same contact/service code?
          GOTO      CDUEN100 IF NOT EQUAL            * No, read next record
.
          MATCH     ALENC007,ALENLOCA               * Same Location of Service?
          GOTO      CDUEN120 IF NOT EQUAL            * No, check if Add/Update  
          GOTO      CDUEN130 IF EQUAL                * Yes, check errmsg reqd  
.
.-------- Location is not matched
CDUEN120  MATCH     "A",UPDATETY                    * Add encounter?
          GOTO      CDUEN100 IF EQUAL                * Yes, read next record
.
          MATCH     "C",UPDATETY                    * Update encounter?          
          GOTO      CDUEN100 IF NOT EQUAL            * No, read next record
.
          MATCH     SVENCTNO,ALENENCT               * Current encounter?
          GOTO      CDUEN130 IF EQUAL                 * Yes, check duplicates
          GOTO      CDUEN100 IF NOT EQUAL             * No, read next record 
.
.-------- Check if error message needs to be displayed
CDUEN130  MATCH     "A",UPDATETY                    * Add encounter?
          GOTO      CDUEN900 IF EQUAL                * Duplicate found, errmsg
.
          ADD       ONE,DUPCOUNT                    * Duplicate counter
          IF        DUPCOUNT > 1
            GOTO      CDUEN900                       * Duplicate found, errmsg
          ELSE
            GOTO      CDUEN100                       
          ENDIF
.
.-------- Duplicate encounter/contact found - Write error message
CDUEN900  CALL      OPENHTML
          BRANCH    EXIT,CDUEN950
          BRANCH    FHIRTYPE,CDUEN920
.
          UNPACK    ALENC005,CCENT,CYEAR,CMON,CDAY
          PACK      DISENDAT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
          MOVE      SP70,DEFHCPNM
          PACK      KEY10,ALENC004,SP70
          CALL      RDPMHCP1                 * Read pmshcpaf file
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE      * Move Title
            MOVE      PMHCGNAM,FMTGNAME      * Move First Name
            MOVE      PMHCSNAM,FMTSNAME      * Move Surname
            CALL      DOCNM000               * Returns Formatted name(DOCFNAME)
            MOVE      DOCFNAME,DEFHCPNM
          ELSE
            MOVE      "Invalid HCP",DEFHCPNM
          ENDIF
.
          MOVE      SP70,LOCNDESC
          MOVE      "LD",CATEGORY
          MOVE      ALENC007,CODE
          CALL      GETCOD00                * To get Location Desc(TDESC)
          MOVE      TDESC,LOCNDESC          * Location Description          
.
          STRIP     ALENC004
          STRIP     ALENC007
          STRIP     ALENC010
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#">":
                    "alert(#"":
                    "\nError: Duplicate Contact already Exists for":
                    "\nReferral ",ADMISSNO:                       
		    "\n":
                    "\nContact Code:\t",*+,ALENC010,*-," - ",ALSRDESC:
                    "\nDate and Time:\t",DISENDAT," ",ALENC006:
                    "\nHCP:\t\t",*+,ALENC004,*-," - ",DEFHCPNM:
                    "\nLocation:\t\t",*+,ALENC007,*-," - ",LOCNDESC:
		    "\n":
                    "\nDuplicate cannot be saved.":
                    "#");"
.
          MATCH     "C",UPDATETY                   * Update Encounter
          IF        @EQUAL
            WRITE     HTMLFILE;"history.go(-1);":
                               "</script>",012
            GOTO      CDUEN910
          ENDIF
.
.-------- Add Encounter templates
          IF        REPORTNO = 1 | REPORTNO = 5
            WRITE     HTMLFILE;"self.close();":
                               "</script>",012
            GOTO      CDUEN910
          ENDIF
          
          IF        REPORTNO = 13
            WRITE     HTMLFILE;"history.go(-1);":
                               "</script>",012
            GOTO      CDUEN910
          ENDIF
.
.-------- All others Add Encounter templates will use the same code as WEBERR00
          WRITE     HTMLFILE;" ":
            "var PopUpScreen = parent.document.getElementById('PopUpScreen');":
                             "  if (window.name.substr(0,4)=='Hide') {":
                             "    self.close();} else {":
                             "  if (PopUpScreen) {":
                             "    PopUpScreen.style.display='none'; } else {":
                             "    history.go(-1); }":
                             "}":
                             "</script>",012
.
CDUEN910  CALL      CLOSHTML     * End of Document
          GOTO      CDUEN980
.
. FHIR Error Response
CDUEN920  CALL      FHRERR00
          GOTO      CDUEN980
.
CDUEN950  DISPLAY   "*** Fifo Not Found - ",FILNAM," ***"
.
CDUEN980  MOVE      ONE,EXIT
CDUEN999  RETURN
.
.******************************************************************************
.* Allied Health Inpatient Contacts                                           *
.******************************************************************************
IPCONT00  MATCH     SP70,UPDATETY
          GOTO      IPCONT70 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add 
          GOTO      IPCONT10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update
          GOTO      IPCONT30 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete 
          GOTO      IPCONT40 IF EQUAL
.
          GOTO      IPCONT90
.
.         ********* ADD *************
.
IPCONT10  MOVE      ZERO,F8
          PACK      KEY16,ADMISSNO,Z70
          CALL      RSPMENC1
          CALL      RPPMENC1
          BRANCH    OVRCD,IPCONT15
.
          MATCH     ADMISSNO,PMENVISN
          GOTO      IPCONT15 IF NOT EQUAL
.
          MOVE      PMENENCT,F8
.
          COMPARE   "99999999",F8                * Max 99999999 Encounters
          GOTO      IPCONT94 IF EQUAL
.
IPCONT15  CALL      CLPMSENC      
          ADD       ONE,F8
          MOVE      F8,PMENC002
.
          CALL      MVPMEN00
.
          PACK      PMENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMENCDAT
          CLOCK     TIME,PMENCTIM
          MOVE      USERID,PMENCUID
.
          PACK      KEY16,PMENVISN,PMENENCT,SP70
          CALL      RAPMENC1
          IF        OVRCD=1
            CALL      WRPMENC1 
          ELSE
            GOTO      IPCONT10
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      IPCONT99
.
.         ********* UPDATE **********
.
IPCONT30  PACK      KEY16,PMENC001,PMENC002,SP70
          CALL      RDPMENC1
          BRANCH    OVRCD,IPCONT95
.
          CALL      MVPMEN00
.
          PACK      PMENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMENUDAT
          CLOCK     TIME,PMENUTIM
          MOVE      USERID,PMENUUID
.
          CALL      UPPMENC1
          MOVE      ZERO,EXIT
          GOTO      IPCONT99
.
.         ********* DELETE **********
.
IPCONT40  PACK      KEY16,PMENC001,PMENC002,SP70
          CALL      RDPMENC1
          BRANCH    OVRCD,IPCONT95
.
          CALL      DEPMENC1
          MOVE      ZERO,EXIT
          GOTO      IPCONT99
.
.         ********* DISPLAY *********
.
IPCONT70  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1                 * Read IP Visit
          BRANCH    OVRCD,IPCONT93
.
          COMPARE   ONE,ASTAT               * Pre Adm
          GOTO      IPCONT96 IF EQUAL  
.
          COMPARE   FIVE,ASTAT               * Cancelled
          GOTO      IPCONT96 IF EQUAL  
.
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      AURNO,URNUMBER        * Default U/R
          ELSE
            MATCH     AURNO,URNUMBER        * Validate U/R to Visit
            GOTO      IPCONT92 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                 * Read IP Discharge
          IF        OVRCD=1
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,IPCONT91
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,IPCONT91
.
          PACK      KEY16,PMENC001,PMENC002,SP70
          CALL      RDPMENC1
          IF        OVRCD=1
            CALL      CLPMSENC
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Inpatient Contacts",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Create Output & Write HTML  Header
          BRANCH    EXIT,IPCONT99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      IPCONT99
.
IPCONT90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IPCONT99
.
IPCONT91  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IPCONT99
.
IPCONT92  MOVE      "Invalid U/R Number/Visit Number Combination.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IPCONT99
.
IPCONT93  MOVE      "Invalid Inpatient Visit Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IPCONT99
.
IPCONT94  MOVE      "Maximum Contacts Reached for Visit Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IPCONT99
.
IPCONT95  MOVE      "Invalid IP Contact Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IPCONT99
.
IPCONT96  MOVE      "Invalid IP Visit Status (Pre-Admitted/Cancelled).",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IPCONT99
IPCONT99  RETURN
.
.******************************************************************************
.* Inpatient Contact List                                                     *
.******************************************************************************
ITAB0000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSPMENC1
ITAB1000  CALL      RKPMENC1                * Loop contacts
          BRANCH    OVRCD,ITAB9999
.
          MATCH     ADMISSNO,PMENVISN
          GOTO      ITAB9999 IF NOT EQUAL
.
          MATCH     "1",PMENRSTA            * Skip if cancelled
          GOTO      ITAB1000 IF EQUAL
.
          MOVE      "CG",CATEGORY
          MOVE      PMENSDEP,CODE
          CALL      GETCOD00                * Get Deptcode Description
          MOVE      PTCDLDES,DEPLDESC          * Dept Description
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,PMENSHCP,SP70     * Read service privider
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      KEY9,PMENSDEP,PMENSERV,SP70
          CALL      RDALSER1                          * Read Service
          IF        OVRCD=1
            MOVE      SP70,ALSRDESC
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "ContactLink('",HTMLLINK
          APPEND    PMENVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMENENCT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",DEPLDESC,"#",":                   * 1
                             "#"",DOCFNAME,"#",":                   * 2
                             "#"",PMENSDAT,PMENSTIM,"#",":          * 3
                             "#"",PMENDIUN,"#",":                   * 4
                             "#"",PMENINUN,"#",":                   * 5
                             "#"",ALSRDESC,"#");" 
          GOTO      ITAB1000
.
ITAB9999  RETURN
.
.------------------------------------------------------------
. Update items file
.------------------------------------------------------------
UITM0000  COMPARE   ONE,UPDITEMS                     * Items received
          GOTO      UITM9999 IF NOT EQUAL
.
          PACK      KEY18,ALENVISN,ALENENCT,SP70
          CALL      RSALITM1
          CALL      RKALITM1
          BRANCH    OVRCD,UITM5000
.
          MATCH     ALENVISN,ALITVISN                * Same referral
          GOTO      UITM5000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALITENCN                * Same Encounter Number
          GOTO      UITM5000 IF NOT EQUAL
.
          PACK      KEY18,ALITVISN,ALITENCN,ALITITMC
          CALL      DEALITM1
          GOTO      UITM0000
.
UITM5000  CALL      ALIT0000                          * Write items
.
UITM9999  RETURN
.
.-----------------------------------------------------------
. Write EDWARD encounter alteration record
.------------------------------------------------------------
WEDE0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDE9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDE9999 IF EQUAL
.
          MOVE      ALENVISN,PMAWVISN
          MOVE      SEVEN,PMAWTYPE
          PACK      PMAWOLDV,ALENVISN,ALENENCT,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      ALENENCT,PMAWCTIM       * Use encounter number for type 7
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
          MATCH     SP70,ALENLINK           * Linked visit
          GOTO      WEDE9999 IF EQUAL
.
          PACK      KEY8,ALENLINK,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,WEDE9999
.
          MOVE      ALENLINK,PMAWVISN
          MOVE      FIVE,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1              * Write OP visit update
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEDE9999  RETURN
.
.------------------------------------------------------------
. Write EDWARD OP visit update trigger after encounter add
.------------------------------------------------------------
WEDT0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDT9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDT9999 IF EQUAL
.
          MATCH     SP70,ALENLINK           * Linked visit
          GOTO      WEDT9999 IF EQUAL
.
          PACK      KEY8,ALENLINK,SP70
          CALL      RDBOKB1                 * Exit no OP visit
          BRANCH    OVRCD,WEDT9999
.
          MOVE      ALENLINK,PMAWVISN
          MOVE      FIVE,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1              * Write OP visit update
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEDT9999  RETURN
.
.------------------------------------------------------------
. Additional HCPs Indicator for ALREDEPT
.------------------------------------------------------------
INDHCP00  MOVE      SP70,DOCINDIC
.
          MATCH     SP70,ALREDEPT
          GOTO      INDHCP99 IF EQUAL
          GOTO      INDHCP99 IF EOS
.
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
.
          MATCH     "A",TCINDC22
          GOTO      INDHCP99 IF NOT EQUAL
.
          MOVE      "1",DOCINDIC
.
INDHCP99  RETURN
.
.
.------------------------------------------------------------
. Additional HCPs
.------------------------------------------------------------
ADDHCP00  MOVE      SP70,DOCFNAM3
          MOVE      SP70,DOCFNAM4
          MOVE      SP70,DOCFNAM5
          MOVE      SP70,DOCFNAM6
          MOVE      SP70,DOCINDIC
.
.         MOVE      ALREDEPT,CODE
.         MOVE      "CG",CATEGORY
.         CALL      GETCOD00
.
.         MATCH     "A",TCINDC22
.         GOTO      ADDHCP99 IF NOT EQUAL
.
.         MOVE      "1",DOCINDIC
.
          MATCH     "1",DOCINDIC
          GOTO      ADDHCP99 IF NOT EQUAL
.
          MATCH     SP70,ALREUHC2
          IF        !@EQUAL
            PACK      KEY10,ALREUHC2,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM3
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC3
          IF        !@EQUAL
            PACK      KEY10,ALREUHC3,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM4
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC5
          IF        !@EQUAL
            PACK      KEY10,ALREUHC5,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM5
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC6
          IF        !@EQUAL
            PACK      KEY10,ALREUHC6,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM6
            ENDIF
          ENDIF
.
ADDHCP99  RETURN
+
.******************************************************************************
.*T0865480 - CPRI0000
. Check if there are other linked referrals for the Primary this linked
. referral is linked to.  If there are no other waiting, active or inactive
. linked referrals, then will allow to also close the Primary Referral at the
. same time as the Linked Referral is closed with the same information for
. Referral Reason for Closure, Referral to, Closure date/time and Next Review
. Date.
.******************************************************************************
CPRI0000  MOVE      ZERO,MULTILRF
          MOVE      SP70,SAVPRIRF
.
.-------- Get Primary referral from the closed Linked referral
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,CPRI9100
.
          MATCH     ADMISSNO,ALRLLNKV       * Same Linked referral?
          GOTO      CPRI9100 IF NOT EQUAL   * No, exit
.
          MOVE      ALRLVISN,SAVPRIRF       * Save Primary referral
.
.-------- Using the Primary referral, check if there are any linked referrals
.-------- still waiting/active/inactive
          PACK      KEY16,SAVPRIRF,SP70
          CALL      RSALRLN1
CPRI1000  CALL      RKALRLN1
          BRANCH    OVRCD,CPRI9800
.
          MATCH     SAVPRIRF,ALRLVISN       * Same primary referral?
          GOTO      CPRI9800 IF NOT EQUAL   * No, exit
.
          PACK      KEY8,ALRLLNKV,SP70      * Get status for linked referral
          CALL      RDALREF1
          BRANCH    OVRCD,CPRI1000
.
          MATCH     "0",ALRESTAT            * Error if waiting
          GOTO      CPRI9100 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Error if active
          GOTO      CPRI9100 IF EQUAL
.
          MATCH     "3",ALRESTAT            * Error if inactive
          GOTO      CPRI9100 IF EQUAL
.
          GOTO      CPRI1000
.
CPRI9100  MOVE      ONE,MULTILRF
          GOTO      CPRI9800
.
CPRI9800  PACK      KEY8,ADMISSNO,SP70      * Restore original referral
          CALL      RDALREF1
          IF        OVRCD=1
           CALL      CLALLREF
          ENDIF

          GOTO      CPRI9999
.
CPRI9999  RETURN
.
.******************************************************************************
.*T0865480 - ACLOS000
. Check if the Primary referral can be automatically closed from a linked
. referral
.******************************************************************************

ACLOS000  MATCH     "1",CHECKBX2            * Last contact checkbox
          GOTO      ACLOS999 IF NOT EQUAL   * Exit, not checked
      
          COMPARE   TWO,AUTOCPRF            * Template Auto close Prim ref on?
          GOTO      ACLOS999 IF NOT EQUAL   * No, exit
.
          MATCH     "1",ALREUYN4            * Just closed a Primary ref?
          GOTO      ACLOS999 IF EQUAL       * Yes, exit
.
          PACK      KEY5,CATCG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ACLOS999
.
          MATCH     ANSC,TCINDC24           * Dept Auto-close Primary ref on?
          GOTO      ACLOS999 IF NOT EQUAl   * No, exit
.
          MOVE      ADMISSNO,SAVEVISN       * Save original linked referral
          CALL      CPRI0000                * Can primary referral be closed?
          BRANCH    MULTILRF,ACLOS910       * No,multi linked referrals found
.
          PACK      KEY8,SAVPRIRF,SP70      * Read primary referral to close 
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
            GOTO      ACLOS910  
          ENDIF
.
          MOVE      SAVPRIRF,ADMISSNO       * Set primary referral   
          CALL      LASTEN00                * Close primary referral
          GOTO      ACLOS910
.
ACLOS910  MOVE      SAVEVISN,ADMISSNO       * Restore original referral
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
          GOTO      ACLOS999
.      
ACLOS999  RETURN      
.
.******************************************************************************
.         The following dummy routine is used in ABFRFINV
.******************************************************************************
PDAT0000  RETURN
+
.******************************************************************************
          INC       ACCDIAIO/INC           * AE Diagnosis
          INC       ALLLNKIO/INC
          INC       ALLREFIO/INC
          INC       ALLRITIO/INC                                       *I-41539
          INC       ALLRSAIO/INC                                       *I-41539
          INC       ALLRLNIO/INC
          INC       ALLCASIO/INC
          INC       ALLAUDIO/INC
          INC       ALLCCTIO/INC
          INC       ALLDEPIO/INC
          INC       ALLDIAIO/INC
          INC       ALLGPAIO/INC
          INC       ALLGREIO/INC
          INC       ALLGROIO/INC
          INC       ALLLINIO/INC
          INC       ALLMDTIO/INC            * a/h encounter notes     
          INC       ALLPRRIO/INC
          INC       ALLPROIO/INC
          INC       ALLQUEIO/INC
          INC       ALLSERIO/INC
          INC       ALLSTSIO/INC
          INC       ALLTMPIO/INC
          INC       APSMASIO/INC            * <SB-CHANGES17.07.2001>
          INC       EMRICDIO/INC            * AE Diagnosis Codes
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       OUTCLIIO/INC                                       *I-41539
          INC       OUTCANIO/INC            * Cancelled booking table
          INC       PATABFIO/INC
          INC       PATASFIO/INC
          INC       PATCMCIO/INC
          INC       OUTCTYIO/INC
          INC       PATDADIO/INC
          INC       PATDO1IO/INC
          INC       PATEORIO/INC
          INC       PATHSPIO/INC            * patient hospital table
          INC       PATMA1IO/INC
          INC       PATNIDIO/INC
          INC       PMSENCIO/INC
          INC       PMSPX2IO/INC
          INC       PMSQPTIO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       PMSCURIO/INC
          INC       BRHLCOMN
          INC       IBAWEBCD
          INC       ACONTACT                * add contact/encounter routines
          INC       ALLREFTM
          INC       WEBDATCD
          INC       DAYOFWEK
          INC       PATNAMCD
          INC       DGCLICEA                * DG API Create Encounter  I-090202
          INC       DGCLICED                * DG API Delete Encounter  I-090202
          INC       DGCLICEU                * DG API Update Encounter
          INC       DGCLII12
          INC       DGCLII13
          INC       NAMSTRCD
          INC       PATDOCTM
          INC       PATMASTM
          INC       PMIGTNID
          INC       CALCAGE
          INC       CLPRIHTR
          INC       CLPRIHRE
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTPREIO/INC
          INC       PATALRIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATMI1IO/INC
          INC       PATPR1IO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       PMSEXTIO/INC
          INC       MLTSECIO/INC
          INC       MLTSITIO/INC
          INC       MRTMASIO/INC
          INC       ALLENCIO/INC
          INC       ALLEMDIO/INC
          INC       ALLMEDIO/INC
          INC       ALLITVIO/INC
          INC       ALLSUPIO/INC
          INC       ALLINCIO/INC
          INC       ALLEMDTM
          INC       ALLITVTM
          INC       ALLSUPTM
          INC       ALLENCTM
          INC       ALLRSATM
          INC       ALLERCIO/INC
          INC       ALLBILIO/INC            * billing table
          INC       OBSPCOIO/INC            * Clinic Notes table
          INC       OUTSESIO/INC
          INC       OUTHEDIO/INC
          INC       OUTMA1IO/INC
          INC       PATIN1IO/INC            * patient insurance table
          INC       PATVADIO/INC 
          INC       PRIHDBIO/INC            * private practice holding header
          INC       PRIHREIO/INC            * private practice holding doctor
          INC       PRIBULIO/INC            * private practice bulk billing
          INC       PRIINVIO/INC            * private practice invoice 
          INC       PRIHTRIO/INC            * private practice holding
          INC       PRIITMIO/INC            * private practice item table
          INC       PRIMABIO/INC            * private parctice vehicle accident
          INC       PRIVAFIO/INC            * private practice veteran affairs
          INC       PRIWCOIO/INC            * private practice work cover tbl
          INC       ALLACTIO/INC            * Non U/R Acivity table
          INC       ALLITMIO/INC            * Allied Health Item File
          INC       CLALLREF
          INC       PATVISTM
          INC       PMSEXTTM
          INC       PMSVX1TM
          INC       ALLACTTM
          INC       PATRE1IO/INC
          INC       PATDSCIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       CLNHIMAS                * Clear nhimasaf file variables
          INC       PMSENCTM
          INC       PMSPX2TM
          INC       PMSHCGTM                * <SB-CHANGES17.07.2001>
          INC       PMSHCPTM                * <SB-CHANGES17.07.2001>
          INC       PATMSXTM
          INC       PATCLMTM                * I-41539
          INC       CLOUTBOA
          INC       CLOUTBB1
          INC       CLPATDSC
          INC       CLPATDOC
          INC       CLPATVIS
          INC       CLPMSENC
          INC       CLPMSVX1
          INC       CLALLENC
          INC       CLALLSTS
          INC       CLALLAUD
          INC       CLALLACT
          INC       CLALLERC
          INC       CLPATABF
          INC       CLPMSQPX
.
          INC       GENANVIS
          INC       PATDSCTM
          INC       PATMISTM
          INC       ALLERCTM
          INC       IBALPCCD
          INC       ABFRFDET
          INC       ABFRFINV
          INC       IBALPCIO/INC
          INC       IBAPOSIO/INC
          INC       PATDGWIO/INC
          INC       PATITMIO/INC
          INC       PATWMAIO/INC            * I-41539
          INC       PMSADWIO/INC
          INC       PMSEVTIO/INC
          INC       PMSCCDIO/INC            * Concession Card Details
.
          INC       SINCIAIO/INC
          INC       ALLWLNIO/INC
          INC       TFILENAM
          INC       VINAHDEF
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       WATTR1IO/INC
