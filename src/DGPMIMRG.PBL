.**************************************************************************
.*  DGPMIMRG  :  Merge URs from a Datagate request                        *
.*               ~~~~~~~~~                                                *
.*                                                                        *
.*  Author    :  Mike Laming  (22/04/2002)                                *
.*                                                                        *
.*  Mods      :                                                           *
.*                                                                        *
.**************************************************************************
          DEFPROC   DGPMIMRG
 IFGE     $$VER,7
.
+
.*************************************************************************
.*  DGMRG000  :  Process datagate Admission message                      *
.*************************************************************************
DGMRG000  MOVE      "MRG",RPLYHEAD
          CALL      ADOPE000                      * open some files
          CALL      CLEAR000                      * clear some fields
.
          MOVE      ZERO,OVRCD
          READ      DGATEOUT;*SB,NEWURNO;
          MOVE      NEWURNO,PURNO
.
          CALL      VALID000                      * read pat. details & validate
          BRANCH    EXIT,DGMRG900                 * Error!  Patient Locked   
.
. *SB will suppress blank fill, *SP will turn off suppress blank fill
.
          MOVE      ZERO,OVRCD
          READ      DGATEOUT;*SB,OLDURNO,PTITL,PHOSP,PLDAYS,PBDEBT:
                            PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB:
                            PADD4,PPOST,PTELEP,PTELEB,PSEX:
                            PMSTAT,PBDATE,PCONT,PREG,PTYPE:
                            POCCUP,PLDDATE,PMEDIXX,PPENNO,PPNDTE:
                            PREPAT,PSMOK,PMICRO,PCEASE,PCASE:
                            PAUTOPY,PHIGH1,PHIGH2,PHIGH3,PLOCDOC:
                            PFUNDH,PFNDTB,PFNDMM,PUSR1,PUSR2:
                            PUSR3,PUSR4,PUSR5,PUSR6,PUYN1:
                            PUYN2,PUYN3,PYRRES,PNKNAME,PNKADD1:
                            PNKADD2,PNKSUBR,PNKADD4,PNKPOST,PNKTELP:
                            PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                            PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                            PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                            PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                            PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                            PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                            PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                            PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                            PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                            PTMXDOFR,PMPXRHC1,PMPXRH1G,PTMXSPID,PMPXR1GC:
                            PTMXOSDT,PTNINMPI:
                            NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                            NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                            NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                            NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                            PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                            PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PMPXLNG1:
                            PMPXLNG2,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                            PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                            PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                            PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                            PMPXDVAC,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                            PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                            PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                            PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                            PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                            PMPXMMNO,PMPXMEML,PMPXMCNT,PMPXMCRP,PMPXMLAB:
                            PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                            PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                            PMPXFBNO,PMPXFMNO,PMPXFEML,PMPXFCNT,PMPXFCRP:
                            PMPXFLAB,PMPXFREL,DATETIME
.
          CALL      SPLTPMED                * Split PMEDIXX into PMEDI, PTMXMCCD
.
          MOVE      OLDURNO,OURNO          * get ready for call to CHANGEUR
          CALL      CHANGEUR
          BRANCH    EXIT,DGMRG900:          * errors detected
                         DGMRG800           * Both URs Admitted
.
.
. send reply message as successful
.
          MOVE      "00000",RPLYCODE              * successful message
          MOVE      SP50,RPLYDESC                 * clear error description
          PACK      CCENCODE,CCDATE,CCDST,CCSRC,CCNAME,REPLYRPL
          WRITE     DGATEIN;CCENCODE:
                            RPLYHEAD,RPLYCODE,RPLYDESC:
                            DGMISC1,DGMISC2,DGMISC3
.
          ADD       ONE,SUCCPROC                  * increm # success transactns
          GOTO      DGMRG999
.
. --- send back an Error response ---
.
DGMRG800  MOVE      "Both URs currently Admitted",WEBTITLE
          MOVE      "02230",RPLYCODE
          GOTO      DGMRG900
.
DGMRG900  MOVE      WEBTITLE,RPLYDESC
.                                                 * RPLYCODE set up in PATCHADT
          PACK      CCENCODE,CCDATE,CCDST,CCSRC,CCNAME,REPLYRPL
          WRITE     DGATEIN;CCENCODE:
                            RPLYHEAD,RPLYCODE,RPLYDESC:
                            DGMISC1,DGMISC2,DGMISC3
          ADD       ONE,ERRRPROC                  * increm # error transactions
.
DGMRG999  CALL      CLOS0000
          GOTO      ENDPROC1
+
.*************************************************************************
.*                      Internal routines                                *
.*************************************************************************
.
.***************************************************************************
.*  VALID000  :  read patients details & make sure we have a valid patient *
.*               Returns:  EXIT=1 --> New UR Locked,                       *
.***************************************************************************
VALID000  MOVE      ZERO,OVRCD
.
.                                                 * Check if New UR exists 
.
          MOVE      ZERO,EXIT
          MOVE      NEWURNO,KEY8
          CALL      RLPTMAS1
          MOVE      OVRCD,EXISTFL                 * Set Exist flag for CHANGEUR
          BRANCH    OVRCD,VALID700,VALID800
.
VALID700  MOVE      ZERO,EXIT                     * we have a valid patient
          GOTO      VALID999
.
.
VALID800  MOVE      "Patient UR Locked on another Port",WEBTITLE
          MOVE      "02231",RPLYCODE
          GOTO      VALID990
.
.
VALID990  MOVE      ONE,EXIT
.
VALID999  RETURN
.
.***************************************************************************
.*  ADOPE000  :  open a few files                                          *
.***************************************************************************
ADOPE000  MOVE      ZERO,OVRCD
.
.                                             * These files may not exist -
.                                             * OPENs performed in CHANGEUR
...       OPEN      AAEDE1A1,"aaede1af"       * A&E Master/Detail
...       OPEN      ALLREFA1,"allrefaf"       * Allied Health Referral Table
...       OPEN      EMRVISA1,"emrvisaf"       * Emergency Visit 
...       OPEN      WATTR1A1,"wattr1af"       * W/L Patient Procedures
...       OPEN      WATTX1A1,"wattx1af"       * Waiting List file extension 
.
.  ----  It appears that all files are opened in WEBCHGUR - so these are just
.        here (as comments) in case they may be needed 
.
...       OPEN      MRTMASA1,"mrtmasaf"       * Medical Records Tracking Master
.
...       OPEN      PATAXEA1,"pataxeaf"       * Admission Extension File
...       OPEN      PATDSCH1,"patdschf"       * Discharge Details   
...       OPEN      PATHCUC1,"pathcsuc"       * HCS U/R No CORRECTIONS AUDIT
...       OPEN      PATNMPA1,"patnmpaf"       * National Master Patient Index 
.... ??   OPEN      PATRE1A1,"patre1af"       * Person Responsible for Account
...       OPEN      PATTRAN2,"pattranf"       * Patient Transfer Details
...       OPEN      PATURCA1,"paturcaf"       * U/R Number Changes Audit
.
.
ADOPE9999 RETURN
.
.***************************************************************************
.*  CLEAR000  :  clear fields                                              *
.***************************************************************************
CLEAR000  CALL      CLPATMAS                      * clear master file vars
          CALL      CLPMSPX2                      * Clear Master Extn.2 
.
CLEAR999  RETURN
.
.***************************************************************************
.*  CLOS0000  :  close files                                               *
.***************************************************************************
CLOS0000  MOVE      ZERO,OVRCD
.
.
CLOS99999 RETURN
.
.***************************************************************************
.*                            End of DGPMIMRG Module                       *
.***************************************************************************
.
ENDPROC1  ENDPROC
+
