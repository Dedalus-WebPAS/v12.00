.******************************************************************************
.*                                                                            *
.*                         P R O G R A M   S U M M A R Y                      *
.*                         -------------   -------------                      *
.*                                                                            *
.*  PROGRAM NAME:   IBABIL19                                                  *
.*                                                                            *
.*  FUNCTION:       FEES INVOICED REPORT                                      *
.*                                                                            *
.*  DATE WRITTEN:   03/07/86                                                  *
.*                                                                            *
.*  AUTHOR:         GRAEME WILLIAMS                                           *
.*                                                                            *
.*  MODIFICATIONS:                                                            *
.*                                                                            *
.*----------------------------------------------------------------------------*
.* V11.05.01 20/02/2025  J.Tan   TSK 0955356                                  *
.*           Recompiled for PATCALFN - Financial Summary                      *
.*           24/02/2025  J.Tan            TSK 0946490                         *
.*           Recompiled for PATCATBI - Changes for MV CWO Payment Model       *
.* V11.04.11 25/10/2024 J.Tan             TSK 0951578                         *
.*           Recompiled for ABFPTINV-Added Min.to roundup ICU Hrs(ABF)        *
.* V11.04.10 23/09/2024  J.Tan          TSK 0949848                           *
.*           Recompiled for ABFPTINV - DRG List used in for COVID Adjustor    *
.* V11.04.09 11/09/2024  J.Tan          TSK 0947315                           *
.*           Recompiled for ABFPTINV - fixed Total Unqualified                *
.* V11.04.08 07/08/2024  J.Tan            TSK 0939432                         *
.*           Recompiled for ISBITEMS - zero Item quantity (PTCNISBZ)          *
.* V11.04.07 01/08/2024  J.Tan          TSK 0947804                           *
.*           Recompiled for ABFMHINV - Changes for Discharges after 1/7/2023  *
.* V11.04.06 17/07/2024  J.Tan          TSK 0947315                           *
.*           Recompiled for ABFPTINV (LOS ICU adjusted & Newborn)             *
.* V11.04.05 14/03/2024  J.Tan          TSK 0910994                           *
.*           Recompiled for CMXMATRX                                          *
.* V11.04.04 29/01/2024  Jacob Jackson  TSK 0919335                           *
.*           Add HF History includes                                          *
.* V11.04.03 29/01/2024  Jacob Jackson  TSK 0919335                           *
.*           Add new local variable and recompile for GETTFEES                *
.* V11.04.02 21/12/2023  J.Tan          TSK 0940154                           *
.*           Recompiled for FINSUMMR - FINCODE for Misc.item to use TCLMTYP   *
.* V11.04.01 07/12/2023  Jacob Jackson  TSK 0925706                           *
.*           Fix layout issue when EXPORTDE=0                                 *
.* V11.03.08 17/11/2023  J.Tan          TSK 0940089                           *
.*           Recompiled for ABFPTINV - checking for blank Disc.DRG            *
.* V11.03.07 13/11/2023  J.Tan          TSK 0939019                           *
.*           Recompiled for ABFPTINV - HAC ICD10 Edition 12                   *
.* V11.03.06 13/10/2023  Jacob Jackson  TSK 0925706                           *
.*           Fix order of Journal/Claim Code code and change usage of IBGIREF *
.*           variables where EXPORTDE=1 with IBGIEREF                         *
.* V11.03.05 04/10/2023  J.Tan          TASK 0938230                          *
.*           Recompiled for ABFAECCL - Emergency ABF                          *
.* V11.03.04 14/08/2023 Jacob Jackson   TSK 0925706                           *
.*           Add EXPORTDE parameter to allow extended descriptions that match *
.*           spooled report. Also add extended admission type description for *
.*           spooled and exported report.                                     *
.* V11.03.03 15/06/2023  J.Tan          TSK 0923703                           *
.*           Recompiled for ABF new calculations                              *
.* V11.03.02 05/04/2023 Bella Turco     TSK 0911166                           *
.*           Recompiled for PATIPERH - Hold Invoice Audit                     *
.* V11.03.01 28/11/2022 J.Tan           TSK 0927091                           *
.*           Recompiled for FINSUMMR - fixed Casepayment Lumpsum daycase      *
.* V11.02.06 11/07/2022 J.Tan           TSK 0922027                           *
.*           Mod MSDS6000 - Fixed ABF system breakdown description            *
.* V11.02.05 29/06/2022 J.Tan           TSK 0920712                           *
.*           Recompiled for ABFAECCL - I*D on emrvcdaf file                   *
.* V11.02.04 24/03/2022  J.Tan          TSK 0917155                           *
.*           Recompiled for FINSUMMR - FINCODE for Pre-surgical               *
.* V11.02.03 23/03/2022 J.Tan           TSK 0917559                           *
.*           Fixed GGST0000 - GST & GST Credit note (ffin) for Consolidated   *
.* V11.02.02 03/03/2022  J.Tan           TSK 0902652                          *
.*           Recompiled for OUTCATBI/AAECATBI - Pat.Invoice new functionality *
.* V11.02.01 20/01/2022  J.Tan           TSK 0915428                          *
.*           Mod for CACCFEE=4 Checking All Adm type for Lumpsum,All Ward for *
.*           Daily charge                                                     *
.* V11.01.12 02/12/2021  J.Tan           TSK 0903454                          *
. *          Mod TRGL4010 to check Journal with 'All' Claim type              *
.* V11.01.11 08/11/2021 J.Tan           TSK 0880410                           *
.*           Recompiled for PATIPERH - added Hospital and System              *
.* V11.01.10 17/11/2021  J.Tan          TSK 0913621                           *
.*           Recompiled for ABFPTINV - Mod for Multiple NEP Values            *
.* V11.01.09 28/10/2021 J.Tan           TSK 0913056                           *
.*           Recompiled for ABFAECCL-ADMFLAG and CCAR0000(Clinical Care)      *
.* V11.01.08 13/10/2021 J.Tan           TSK 0905305                           *
.*           Recompiled for ABFAECCL - Adjustment type 068 & 069              *
.* V11.01.07 29/09/2021  J.Tan          TSK 0901515                           *
.*           Recompiled for CMXMATRX - Added Primary Proc.to Matrix           *
.* V11.01.06 14/09/2021  J.Tan          TSK 0906222                           *
.*           Recompiled for ABFPTINV - Mod for Multiple NEP Values            *
.* V11.01.05 09/08/2021  J.Tan           TSK 0905305                          *
.*           Recompiled for AAECATBI - AE Care class (ABFAECCL)               *
.* V11.01.04 18/08/2021  J.Tan           TSK 0903454                          *
.*           Added Claim code to Lumpsum/Daily charge for CACCFEE=4           *
.* V11.01.03 07/07/2021  J.Tan           TSK 0908588                          *
.*           Recompiled for PATCATBI -Exclude Unqualified days for Casepayment*
.* V11.01.02 28/04/2021  Thanh T         TSK 0895165                          *
.*           Recompiled for OPRARDFD changes                                  *
.*           07/04/2021  Tracey Nguyen   TSK 0901515                          *
.*           Recompiled for PMSCMTFD - Added new fields                       *
.*           a) 1 File type for ICD procedure (PMCCIPF)                       *
.*           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)            *
.*           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)            *
.*           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)            *
.*           13/04/2021  J.Tan           TSK 0863287                          *
.*           Mod for Patient Invoice new functionality                        *
.* V11.01.01 10/03/2021  Tracey Nguyen   TSK 0901515                          *
.*           Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5        *
.*           (PMCCICP1-5)                                                     *
.*----------------------------------------------------------------------------*
.*        V11.00.12 10/11/2020  J.Tan           TSK 0899562                   *
.*                  Recompiled for CMXMATRX - setup date for reading MBS item *
.*        V11.00.11 22/10/2020  J.Tan           TSK 0898866                   *
.*                  Recompiled for PATIPERH - on hold invoice                 *
.*        V11.00.10 29/09/2020  J.Tan          TSK 0896829                    *
.*                  Recompiled for CMXMATRX - use National(PTPGNDRG)DRG       *
.*        V11.00.09 22/09/2020  J.Tan           TSK 0895330                   *
.*                  Recompiled for CMXMATRX - reposition read of Matrix table *
.*        V11.00.08 20/07/2020  J.Tan           TSK 0892319                   *
.*                  Recompiled for ABFPTINV - Additional NEP and Psych.Adjus. *
.*        V11.00.07 14/07/2020  J.Tan          TSK 0892902                    *
.*                  Recompiled for PATCATBI - Mod to initialise CASMXKEY      *
.*        V11.00.06 01/07/2020  J.Tan           TSK 0892765                   *
.*                  Recompiled for PATCATBI-Low outlier exc. unqualified days *
.*                  05/07/2020  J.Tan           TSK 0892746                   *
.*                  Recompiled for ABFPTINV - CALCAGE as at Admission date    *
.*        V11.00.05 29/06/2020  J.Tan           TSK 0893767                   *
.*                  Recompiled for ABFPTINV - Changed CALCFLAG to 01/01/2021  *
.*        V11.00.04 20/04/2020 J.Tan           TSK 0890733                    *
.*                  Recompiled for ABFPTINV - ABF new 2020 calculation        *
.*        V11.00.03 07/05/2020  J.Tan            TSK 0891341                  *
.*                  Recompiled for ABFOTINV - added TRAP to write pmsabfaf    *
.*        V11.00.02 30/03/2020  J.Tan            TSK 0889749                  *
.*                  Recompiled for IPENBOK1 - Outpatient booking              *
.*        V11.00.01 24/02/2020  J.Tan          TSK 0838262                    *
.*                  Added Effective from and to date to MBS Item file         *
.*                  18/03/2020  J.Tan            TSK 0889344                  *
.*                  Fixed GST for non multi hospital                          *
.*        V10.15.07 10/02/2020  J.Tan            TSK 0887341                  *
.*                  Mod for HEA System breakdown G/L interfacae (pmsfmsaf)    *
.*                  30/01/2020  J.Tan            TSK 0883777                  *
.*                  Recompiled for PATCATBI -MV with days days hospitalisation*
.*        V10.15.06 17/01/2020  J.Tan            TSK 0887223                  *
.*                  Recompiled for FINSUMMR                                   *
.*        V10.15.05 06/01/2020  J.Tan            TSK 0886179                  *
.*                  Mod for system breakdown for ABF charges                  *
.*        V10.15.04 11/12/2019  Peter Vela       TSK 0857392                  *
.*                  Changed IPENBOOK to IPENBOK1                              *
.*        V10.15.03 21/11/2019  J.Tan            TSK 0857392                  *
.*                  Added option for ABF Booked Outpatient to be invoiced     *
.*        V10.15.02 11/10/2019  Peter Vela       TSK 0882906                  *
.*                  Recompiled for OUTCATBI - Fixed I*C for OUTBB1 ABF        *
.*        V10.15.01 07/10/2019  J.Tan            TSK 0882545                  *
.*                  Mod to clear Disc.record                                  *
.*                  09/10/2019  J.Tan          TSK 0872482                    *
.*                  Recompiled for PATCATBI - Mechanical Ventilation          *
.*        V10.14.05 26/09/2019  J.Tan            TSK 0857392                  *
.*                  Recompiled for OUTCATBI - ABF outpatient invoice          *
.*        V10.14.04 23/09/2019  J.Tan           TSK 0857392                   *
.*                  Mod ABF charges to appear under Items instead of Accomm.  *
.*        V10.14.03 09/09/2019  J.Tan           TSK 0857392                   *
.*                  Recompiled for EMR ABF invoice                            *
.*        V10.14.02 21/05/2019  J.Tan           TSK 0857392                   *
.*                  Mod for ABF Admitted invoice                              *
.*        V10.14.01 20/03/2019  J.Tan            TSK 0857392                  *
.*                  Changed RCP Transaction count from DIM3 to DIM5           *
.*        V10.13.03 11/01/2019  Peter Vela     TSK 0867807                    *
.*                  Recompiled for OUTCATBI                                   *
.*        V10.13.02 26/10/2018  Thanh T        TSK 0859743                    *
.*                  Added BULKBILL field and removed OUTHEDFD/OUTHEDIO,       *
.*                  OUTSESFD/OUTSESIO for OUTCATBI changes                    *
.*        V10.13.01 25/10/2018  Thanh T        TSK 0859743                    *
.*                  Added OUTHEDFD/OUTHEDIO, OUTSESFD/OUTSESIO for OUTCATBI   *
.*                  changes                                                   *
.*----------------------------------------------------------------------------*
.*        V10.12.03 18/07/2018  J.Tan          TSK 0859911                    *
.*                  Recompiled for PATCATBI - Fixed No Payday Add on charge   *
.*        V10.12.02 13.03.2018  J.Tan   TSK 0848146                           *
.*                  Fixed I*C rcpbnkaf                                        *
.*        V10.12.01 15.01.2018  J.Tan   TSK 0848146                           *
.*                  Added CACCFEE=5 - Accumulation FI by Claim code           *
.*        V10.11.01 07/09/2017  J.Tan         TSK 0837479                     *
.*                  Recompiled for CMXMATRX - Consumption type items          *
.*        V10.10.02 13/06/2017  J.Tan          TSK 0839991                    *
.*                  Recompiled for PATDBTYP (PATCMSTP)                        *
.*        V10.10.01 25/01/2017  J.Tan          TSK 0832407                    *
.*                  Recompiled for PATCATBI- multi bed trans on sameday for MV*
.*                  04/04/2017  J.Tan         TSK 0297904                     *
.*                  Recompiled for PATCMSTP - Non-Accumulative inlier ICU/CCU *
.*        V10.08.09 06/10/2016  J.Tan         TSK 0826824                     *
.*                  Recompiled for CALCMVHR - MV Hours                        *
.*        V10.08.08 21/09/2016  J.Tan         TSK 0826370                     *
.*                  Recompiled for CMXMATRX - Chgd MCHGARR MCHGAMT array to F3*
.*        V10.08.07 26/08/2016  Don Nguyen    TSK 0312570                     *
.*                  Recompiled for CMXMATRX - Added check for PTCNDGED=1      *
.*                  Added PMSEDGFD/IO and GETEFDRG                            *
.*        V10.08.06 17/08/2016  J.Tan         TSK 0808745                     *
.*                  Recompiled for PATCATBI - for NPDAYFLG=1                  *
.*        V10.08.05 20/07/2016  J.Tan         TSK 0819914                     *
.*                  Recompiled for PATCATBI - Non ICU MV Hours                *
.*        V10.08.04 15/07/2016  J.Tan         TSK 0819914                     *
.*                  Recompiled for PATCATBI - Calculating non ICU MV hours    *
.*        V10.08.03 20/06/2016  J.Tan         TSK 0820816                     *
.*                  Recompiled for PATCATBI - Fixed No payday for Daycase     *
.*        V10.08.02 02/06/2016  J.Tan         TSK 0816651                     *
.*                  Recompiled for PATCATBI -Continuous Bill.to chk for Matrix*
.*        V10.08.01 02/05/2016  Ebon Clements TSK 0268970                     *
.*                  Change to use OUTCLIFD index 1 instead of index 2         *
.*        V10.07.02 04/03/2016  J.Tan         CAR 290448                      *
.*                  Recompiled for PATCATBI - Mods for Addon with No Pay DAy  *
.*        V10.07.01 18/11/2015  J.Tan         CAR 303942                      *
.*                  Added new payment types                                   *
.*        V10.06.02 15/07/2015  J.Tan          CAR 319342                     *
.*                  Recompiled for CMXMATRX - Chg 'Disc.UDF' to 'Care Class'  *
.*        V10.06.01 14/07/2015  Peter Vela     CAR 318700                     *
.*                  Recompiled for PRBILCMN - Validate for deleted VISMDT     *
.*                  record                                                    *
.*        V10.05.02 04/08/2014 J.Tan           CAR 304397                     *
.*                  Mods to check Suggested classification for tobe invoiced  *
.*        V10.05.01  16/07/2014 J.Tan           CAR 303627                    *
.*                   Mods G/L Interface to write to a comma delimited file    *
.*        V10.04.07  03/07/2014 J.Tan           CAR 268860                    *
.*                   Recompiled for PATCATBI - ICD10 Suggested Classification *
.*        V10.04.06 19/06/2014 J.Tan           CAR 302452                     *
.*                  Recompiled for PATDINVS - Changed MCHGARR/MCHGAMT         *
.*        V10.04.05 12/06/2014 Jill Parkinson  CAR 301639                     *
.*                  Added FNAMET, FNAMEM and FNAMEW to KILL0000               *
.*        V10.04.04 11/06/2014 Sandra Barcham  CAR 301639                     *
.*                  Moved call to TFILENAM to INIT0000                        *
.*        V10.04.03 27/05/2014  J.Tan          CAR 300784                     *
.*                  Recompiled for STEPDOWN - force stepdown prior inv.fromdat*
.*        V10.04.02 08/04/2013 J.Tan          CAR 261630                      *
.*                  Removed port number from temp file name                   *
.*        V10.04.01 14/02/2014  J.Tan          CAR 297139                     *
.*                  Mods for Ind.Services Billing to automaticaly update items*
.*        V10.03.11 13/12/2013  J.Tan          CAR 294609                     *
.*                  Recompiled for CMXMATRX - mods for Default Grouper Version*
.*        V10.03.10 14/11/2013  J.Tan          CAR 285294                     *
.*                  Added option to create Export file                        *
.*        V10.03.09 07/11/2013  J.Tan          CAR 283618                     *
.*                  Recompiled for PATCATBI - mods for Ind.Services Billing   *
.*        V10.03.08 02/10/2013  J.Tan          CAR 291588                     *
.*                  Recompiled for PATCATBI - fixed stepdown return from leave*
.*        V10.03.07 14/08/2013  J.Tan          CAR 288416                     *
.*                  Recompiled for PATCATBI - fixed Days of Hosps.            *
.*        V10.03.06 05/08/2013  J.Tan          CAR 288060                     *
.*                  Recompiled for CMXMATRX - fixed Primary/Secondary/Tertiary*
.*        V10.03.05 06/05/2013  J.Tan          CAR 284902                     *
.*                  Recompiled for STEPDOWN - force stepdown prior Inv.Fromdat*
.*        V10.03.04 10/04/2013  J.Tan    CAR 283743                           *
.*                  Recompiled for PATCATBI -  reset PTTRESPD for New Stepdown*
.*        V10.03.03 05/03/2013  Patrick Adair CAR 281898                      *
.*                  Recompiled for PATCATBI PATCATAI                          *
.*        V10.03.02 21/09/2012  J.Tan          CAR 271474                     *
.*                  Recompiled for CMXMATRX - using index 5 of pmscmtaf       *
.*                  04/12/2012  J.Tan          CAR 262673                     *
.*                  Recompiled for PATCATBI - Casepayment perdiem rate        *
.*        V10.03.01 18/05/2012  J.Tan     CAR 253244                          *
.*                  Replaced Z20 with TILDA20                                 *
.*        V10.02.10 13/10/2011 J.Tan      CAR 249949                          *
.*                  Fixed G/L Extract for total GST for non-multi hospital    *
.*        V10.02.09 13/10/2011 J.Tan      CAR 249949                          *
.*                  Fixed G/L Extract for total GST for non-multi hospital    *
.*                  13/10/2011 J.Tan      CAR 251460                          *
.*                  Fixed G/L Extract for Credit Note EMR Revenue breakdown   *
.*        V10.02.08 29/09/2011 J.Tan      CAR 251460                          *
.*                  Mods for EMR Revenue breakdown                            *
.*        V10.02.07 09/09/2011 J.Tan      CAR 249949                          *
.*                  Mods for Inpat GST breakdown                              *
.*        V10.02.06 23/08/2011 J.Tan      CAR 244159                          *
.*                  Removed printing Credit card surcharge                    *
.*        V10.02.05 19/08/2011 J.Tan      CAR 244159                          *
.*                  Fixed printing credit card surcharge again                *
.*        V10.02.04 18/08/2011 J.Tan      CAR 244159                          *
.*                  Fixed printing credit card surcharge                      *
.*        V10.02.03 12/08/2011 J.Tan      CAR 244159                          *
.*                  Fixed printing credit card surcharge for non multi hosp.  *
.*        V10.02.02 08/08/2011 J.Tan      CAR 236214                          *
.*                  Fixed to set up Hospital ID for G/L interface             *
.*        V10.02.01 01/08/2011 J.Tan      CAR 244159                          *
.*                  Mods for Credit Card Surcharge                            *
.*        V10.01.03 23/02/2011 Peter Vela CAR 233034                          *
.*                  Removed PATBF2FD and PATBF2IO                             *
.*        V10.01.02 12/01/2011 J.Tan      CAR 236214                          *
.*                  Fixed grouping GST                                        *
.*                  20/12/2010  Mike Laming   CAR 233046                      *
.*                  Mods to Misc.Charges PATMCHFD - Key change, logic changes *
.*        V10.01.01 06/12/2010  Ebon Clements     CAR 233927                  *
.*                  Added reason for hold update to invoice pending           *
.*        V10.00.10 27/09/2010 J.Tan      CAR 230664                          *
.*                  Recompiled for AAECATBI - HEC Invoice layout              *
.*        V10.00.09 17/08/2010 J.Tan         CAR 227873                       *
.*                  Recompiled for CMXMATRX- getting the grouper version      *
.*        V10.00.08 11/08/2010 J.Tan         CAR 227873                       *
.*                  Recompiled for CMXMATRX-searching for next rules of matrix*
.*        V10.00.07 05/08/2010  Mike Laming   CAR 225306                      *
.*                  Correct FINYTD variable to "FORM 12.2"                    *
.*        V10.00.06 03/08/2010  J.Tan         CAR 227319                      *
.*                  Recompiled for PATCATBI - Mechanical Ventilation          *
.*        V10.00.05 14/07/2010  J.Tan         CAR 226158                      *
.*                  Recompiled for STEPDOWN - bed fees update                 *
.*        V10.00.04 16/07/2010 J.Tan         CAR 226322                       *
.*                  Recompiled for CMXMATRX - search for next rule if Contract*
.*                  is not valid                                              *
.*        V10.00.03 12/07/2010  J.Tan         CAR 225932                      *
.*                  Recompiled for PATCATBI - set TDATE to IDATET for per-diem*
.*        V10.00.02 07/06/2010  Mike Laming   CAR 212864                      *
.*                  Recompiled for PATCATBI - mods at GCDE6500                *
.*        V10.00.01 30/04/2010  J.Tan     CAR 220887                          *
.*                  Mods checking for Active/Inactive of Misc.charge          *
.*        V9.12.13  11/03/2010  J.Tan         CAR 216044                      *
.*                  Mods to include Leave days in stepdown count for TAC      *
.*        V9.12.12  16/02/2010  Peter Vela    CAR 215485                      *
.*                  Recompiled for PATCATBI - Ignore Leave if less than a day *
.*        V9.12.11  05/02/2010  Peter Vela    CAR 215485                      *
.*                  Recompiled for PATCATBI - Ignore Leave if less than a day *
.*        V9.12.10  02/02/2010  Peter Vela    CAR 215234                      *
.*                  Recompiled for CMXMATRX                                   *
.*        V9.12.09  27/01/2010  J.Tan         CAR 214548                      *
.*                  Recompiled for PATCATBI - Stepdown after bed fees update  *
.*                  27/01/2010  J.Tan         CAR 214877                      *
.*                  Recompiled for CMXMATRX - Checking for range of MBS items *
.*        V9.12.08  19/01/2010  J.Tan         CAR 166439                      *
.*                  Recompiled for PATCMSTP - C/P additional charge stepdown  *
.*        V9.12.07  24/11/2009  Davin         CAR 210721                      *
.*                  Recompiled for CHKCMXPT - I*C on patcmxaf file            *
.*        V9.12.06  09/10/2009  J.Tan         CAR 203934                      *
.*                  Recompiled for PATCATBI - display ICD10 Sugg.Class on Inv.*
.*        V9.12.05  21/09/2009  J.Tan         CAR 204390                      *
.*                  Recompiled for STEPDOWN - mods to old bed fees file       *
.*        V9.12.04  24/07/2009  J.Tan         CAR 201132 & 202168             *
.*                  Recompiled for CMXMATRX - checking for zero MBS amount    *
.*        V9.12.03  03/07/2009  Peter Vela    CAR 199927                      *
.*                  Recompiled for EMROPOCK - Check if PMMIAMTT = 0 GPRC4000  *
.*        V9.12.02  05/06/2009  J.Tan         CAR 196010                      *
.*                  Recompiled for CMXMATRX - ICD10 Secondary/Tertiary        *
.*        V9.12.01  11/05/2009  J.Tan         CAR 125842                      *
.*                  Recompiled for PATCATBI - Recalculate zero amt of Misc.Itm*
.*        V9.11.09  02/04/2009  J.Tan   CAR 193432                            *
.*                  Mods CACFEE=3 to print Claim code description             *
.*        V9.11.08  30/03/2009  J.Tan   CAR 190946                            *
.*                  Added G/L Interface Prefix                                *
.*        V9.11.07  27/03/2009  J.Tan   CAR 189115                            *
.*                  Mods to Acc.description for CACCFEE=3 (Ward/Claim/Admtype)*
.*        V9.11.06  16/03/2009  J.Tan         CAR 188205                      *
.*                  Recompiled for PATCATBI - Mods to Non-banked Deposits     *
.*        V9.11.05  09/01/2009  J.Tan   CAR 187013                            *
.*                  Mods to Acc.description for CACCFEE=2                     *
.*        V9.11.04  08/01/2009  Steve Armstrong   CAR 185927                  *
.*                  Removed isadd on temp file and included extra index in    *
.*                  isbuild (now that CMDLINE has been extended in length     *
.*                  from 80 to 100).                                          *
.*        V9.11.03  31/12/2008  J.Tan             CAR 183976                  *
.*                  Mods for Cash from Eclipse Payments                       *
.*        V9.11.02  20/11/2008  Steve Armstrong   CAR 181373                  *
.*                  Recompiled for changes to PATCATBI.                       *
.*        V9.11.01  08/10/2008  J.Tan         CAR 179953                      *
.*                  Mods to include deposits from Booking                     *
.******************************************************************************
.*        V9.10.07  25/09/2008  J.Tan         CAR 178209                      *
.*                  Recompiled for PATCATBI - Fixed checking for Doct.chg rec.*
.*                  25/09/2008  J.Tan         CAR 179009                      *
.*                  Recompiled for STEPDOWN - Check 'Exclude Days of Hosp."   *
.*        V9.10.06  22/09/2008  J.Tan         CAR 179070                      *
.*                  Mods to print description of Totals                       *
.*        V9.10.05  05/09/2008  J.Tan         CAR 177126                      *
.*                  Recompiled for PATCATBI - Checking matrix parameter       *
.*        V9.10.04  06/08/2008 J.Tan      CAR 175246                          *
.*                  Recompiled for AAECATBI                                   *
.*        V9.10.03  08/07/2008 Sandra Barcham CAR 173135                      *
.*                  Recompiled for PATCATBI - Remove close of PATDGWA1        *
.*        V9.10.02  01/07/2008  Ebon Clements  CAR 172181                     *
.*                  Fixed open of RCPDTEA1                                    *
.*        V9.10.01  05/05/2008  J.Tan          CAR 162313                     *
.*                  Added Deposit status to comdepaf                          *
.******************************************************************************
.*        V9.09.14  04/03/2008 J.Tan          CAR 157583                      *
.*                  Recompiled for AAECATBI-Invoice total with 'Out of Pocket"*
.*        V9.09.13  29/02/2008  J.Tan         CAR 162893 & 162609             *
.*                  Recompiled for PATCATBI - Inv.breakdown and Lumpsum amt   *
.*        V9.09.12  20/02/2008  Peter Vela    CAR 161535                      *
.*                  Recompiled for PATCATBI                                   *
.*        V9.09.11  03/01/2008  J.Tan         CAR 136785                      *
.*                  Recompiled for STEPDOWN                                   *
.*        V9.09.10  14/12/2007  Jill Habasque CAR 158207                      *
.*                  Recompiled for AAECHRG - removed open of patipenf         *
.*        V9.09.09  30/11/2007  J.Tan         CAR 154278                      *
.*                  Mods Journal G/L extract to have same sign as FINPER      *
.*        V9.09.08  12/11/2007 J.Tan       CAR 151803                         *
.*                  Recompiled for AAECATBI - ED Billing                      *
.*        V9.09.07  24/08/2007  Peter Vela CAR 146143                         *
.*                  Recompiled for PATCATBI                                   *
.*        V9.09.06  20/08/2007 J.Tan          CAR 144656                      *
.*                  Recompiled for PATCATBI - for Multiple Procedures Billing *
.*        V9.09.05  10/08/2007  Peter Vela CAR 146143                         *
.*                  Recompiled for PATCATAI                                   *
.*        V9.09.04  17/07/2007  J.Tan     CAR 140282                          *
.*                  Recompiled for NZPCATBI - Revenue breakdown               *
.*        V9.09.03  03/07/2007  Peter Vela CAR 142173                         *
.*                  Recompiled for PATCATAI                                   *
.*        V9.09.02  29/06/2007  Peter Vela CAR 142173                         *
.*                  Recompiled for PATCATAI                                   *
.*        V9.09.01  07/06/2007  J.Tan            CAR 142173                   *
.*                  Mods for Emergency events                                 *
.******************************************************************************
.*        V9.08.14  16/05/2007  J.Tan            CAR 133059                   *
.*                  Fixed G/L Transfer for Credit notes                       *
.*        V9.08.13  04/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2      *
.*                  Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)       *
.*        V9.08.12  16/04/2007  J.Tan            CAR 138026                   *
.*                  Recomp.for PATCATBI - JH Charging for discharged day      *
.*        V9.08.11  05/03/2008 J.Tan          CAR 130462                      *
.*                  Mods for JH GST                                           *
.*        V9.08.10  19/02/2007 Peter Vela     CAR 135241                      *
.*                  Recompiled for PATCATBI - St. John of God invoice layout  *
.*        V9.08.09  26/02/2007  J.Tan         CAR 120014                      *
.*                  Recompiled for NZPCATBI - NZ exploding misc.item          *
.*        V9.08.08  31/01/2007  Peter Vela    CAR 127930                      *
.*                  Recompiled for EMRSITFD                                   *
.*        V9.08.07  18/12/2006 J.Tan          CAR 128578                      *
.*                  Recompiled for OUTCATBI - GST amount for O/P Next invoice *
.*        V9.08.06  17/11/2006  Peter Vela    CAR 124538                      *
.*                  Recompiled for PATCATBI                                   *
.*                  Added display of PATITMFD.PTITTCER                        *
.*                  Type of Certificate Type B Type C                         *
.*        V9.08.05  09/11/2006  J.Tan         CAR 123584                      *
.*                  Mods to use System based G/L Interface                    *
.*        V9.08.04  06/11/2006  J.Tan         CAR 121855                      *
.*                  Mods to use GST account for No FMS and fixed -ve jrnl amt *
.*        V9.08.03  20/10/2006  J.Tan         CAR 121855                      *
.*                  Added ibabil19.us1                                        *
.*                  Mods G/L interface -IBGIDESC to have fincode description  *
.*        V9.08.02  18/10/2006  J.Tan         CAR 120502                      *
.*                  Recompiled for PATCATBI - Ignore Doctor Change record     *
.*        V9.08.01  11/10/2006  J.Tan         CAR 121178                      *
.*                  Fixed I*C on pmsmtiaf                                     *
.******************************************************************************
.*        V9.07.02  25/09/2006  Peter Vela    CAR 118940                      *
.*                  Recompiled for PATCATBI                                   *
.*        V9.07.01  01/08/2006  J.Tan         CAR 103365                      *
.*                  Recompiled for PATCATBI - Johns Hopkins                    *
.*                  Added Discount & rounding                                 *
.******************************************************************************
.*        V9.06.02  16/05/2006  Peter Vela    CAR 104103                      *
.*                  Recompiled for PATCATBI - PTCNINVL=12                     *
.*        V9.06.01  19/05/2006  J.Tan         CAR 105459                      *
.*                  Added Hospital id to patfmsaf file                        *
.******************************************************************************
.*        V9.05.02  07/03/2006  J.Tan         CAR 101054                      *
.*                  Added field for G/L Transfer to hospital file             *
.*        V9.05.01  07/03/2006  J.Tan         CAR 97175                       *
.*                  Fixed printing description for Daycase/Overnight C/P Misc.*
.******************************************************************************
.*        V9.04.B02 20/12/2005  J.Tan         CAR 89226                       *
.*                  Recompiled for PATCATBI - recalculate theatre fees        *
.*        V9.04.17  28/11/2005  J.Tan             CAR 86469                   *
.*                  Fixed Period and YTD columns                              *
.*        V9.04.16  02/11/2005  Peter Vela        CAR 81394                   *
.*                  Recompiled for PATCATBI                                   *
.*        V9.04.15  30/09/2005  J.Tan         CAR 78677                       *
.*                  Fixed printing total of GST                               *
.*        V9.04.14  05/09/2005  Mike Laming   CAR 65765                       *
.*                  More adjustments to fit a bigger description              *
.*        V9.04.13  31/08/2005  J.Tan         CAR 74153                       *
.*                  Recompiled for CMXMATRX - checking for exclusive          *
.*                  04/08/2005  J.Tan        CAR 62750                     *
.*                  Mods not to use the redefined amount variables         *
.*        V9.04.12  20/07/2005  J.Tan         CAR 67749                       *
.*                  Fixed credit note for the general ledger transfer file    *
.*        V9.04.11  05/07/2005  Mike Laming   CAR 65765                       *
.*                  Make "PERIOD" & "Y.T.D" cols cater for $100,000,000 values*
.*        V9.04.10  16/06/2005  Mike Laming   CAR 61746                       *
.*                  Recompiled for CLPATDTR - add clear PTDTTIME & PTDTCRST   *
.*        V9.04.09  08/06/2005  J.Tan      CAR 62923                          *
.*                  Mods checking for refund deposit                          *
.*        V9.04.08  01/04/2005  J.Tan    CAR 60117                            *
.*                  Changed field for INVNAME,TBINAME to DIM 80 & added '.txt'*
.*        V9.04.07  24/01/2005  J.Tan    CAR 57052                            *
.*                  Mods to use the receipting FMS Batch directory            *
.*        V9.04.06  29/11/2004  Mike Laming   CAR 54534                       *
.*                  Re-comple for PATCMSTP - fix Addit.Charge Description     *
.*        V9.04.05  19/10/2004  J.Tan    CAR 54207                            *
.*                  Fixed reading system parameter for Using Matrix (PTCNNWCM)*
.*        V9.04.04  29/09/2004  J.Tan    CAR  53909                           *
.*                  Mods multi hospital will have G/L interface option        *
.*                  Mods G/L transfer to check if the hospital id using fms   *
.*        V9.04.03  08/09/2004  J.Tan    CAR 53292                            *
.*                  Recompiled for STEPDOWN - bed fees not setup              *
.*                  23/09/2004  Lina Vo  CAR 53660                            *
.*                  Recompiled for PATCATBI - multi hospital theatre fee      *
.*        V9.04.02  31/08/2004  J.Tan  CAR 53073                              *
.*                  Fixed Multi hospital id variable                          *
.*        V9.04.01  23/08/2004  J.Tan  CAR 52835                              *
.*                  Mods for Multi hospital                                   *
.******************************************************************************
.*        V9.03.17  22/06/2004  Lina Vo  CAR 50811                            *
.*                  Removed use of RCPDEPFD & IO - now obselete.              *
.*        V9.03.16  09/06/2004  J.Tan    CAR 50035                            *
.*                  Re-compile for PATCATBI - Mechanical ventilation          *
.*        V9.03.15  02/06/2004 J.Tan   CAR 50396                              *
.*                  Mods to check for credit notes                            *
.*        V9.03.14  02/06/2004  J.Tan   CAR 50391                             *
.*                  Fixed Description of Accommodation and Item group         *
.*        V9.03.13  22/04/2004  Mike Laming   CAR 46224                       *
.*                  Re-compile for PATCATBI - Theatre DTR sequences           *
.*        V9.03.12  05/04/2004  J.Tan   CAR 44116
.*                  Fixed for credit note                                     *
.*        V9.03.11  12/02/2004  Henry Son        CAR 47385                    *
.*                  Added PTCNMBSF for checking if we allow more than         *
.*                  Six MBS Items.                                            *
.*        V9.03.10  23/02/2004  Mike Laming   CAR 47440                       *
.*                  Re-compile for PATCATBI - initialise TPATAMTP             *
.*        V9.03.09  17/12/2003  J.Tan                                         *
.*                  Mods to use comdep for deposit                            *
.*        V9.03.08  18/11/2003  Henry Son   CAR 39291                         *
.*                  Allow more than 7 Theatre stepdown fees.                  *
.*                  Recompile PATCATBI.                                       *
.*        V9.03.07  03/11/2003  Mike Laming  CAR 43911                        *
.*                  Recompile for PATCATBI - correct GROSSTOT & ACCMTOT       *
.*        V9.03.06  17/10/2003  J.Tan  CAR 44176                              *
.*                  Recompiled for PATCATBI.                                  *
.*        V9.03.05  12/09/2003  CAR 40497   Lina Vo                           *
.*                  Changed index and read of patmchgf to include effective   *
.*                  date.                                                     *
.*                  Recompiled for AAECATBI, OUTCATBI & PATCATBI.             *
.*        V9.03.04  12/08/2003  CAR 41196   Lina Vo                           *
.*                  Recompile for big change in PATSELFN.                     *
.*                  11/08/2003  CAR 41072   Mike Laming                       *
.*                  Recompile for PATCATBI to correct Lump Sums in BIL19      *
.*        V9.03.03  04/08/2003  CAR 34330/41952   Mike Laming                 *
.*                  Recompiled for PATCATBI & PATDINVS - Add second temp      *
.*                  file for Misc.Items to change sequence to Date/DTR seq.   *
.*        V9.03.02  05/07/2003  CAR 41109   Guomin Fu                         
.*                  Fixed the logic for G/L interface mapping                 
.*        V9.03.01  03/06/2003  J.Tan     CAR 37764                           *
.*                  Fixed resetting gst file (patfigaf)                       *
.******************************************************************************
.*        V9.02.25  02/04/2003  J.Tan     CAR 37764                           *
.*                  Mods to reset gst file (patfigaf)                         *
.*        V9.02.24  24/02/2003  Dean Cramer  CAR 36478                        *
.*                  Removed receipting tran file                              *
.*                  Recompiled for PABXBILL                                   *
.*        V9.02.23  13/02/2003  Dean Cramer  CAR 22238                        *
.*                  Recompiled                                                *
.*        V9.02.22  12/11/2002  J.Tan                                         *
.*                  Recompiled for PATIVMES                                   *
.*        V9.02.21  08/11/2002  J.Tan                                         *
.*                  Added new parameter PTCNPFID - print fees invoice details *
.*        V9.02.20  30/10/2002  J.Tan                                         *
.*                  Recompiled for CMXMATRX                                   *
.*        V9.02.19  19/09/2002  J.Tan                                         *
.*                  Recompiled for PATCATBI                                   *
.*        V9.02.18  11/09/2002  J.Tan   SRF 21879                             *
.*                  Fixed printing cash                                       *
.*        V9.02.17  09/09/2002  J.Tan    SRF 20791                            *
.*                  Recompiled for PATCATBI                                   *
.*        V9.02.16  07/09/2002  J.Tan                                         *
.*                  Fixed printing Cash from health fund                      *
.*        V9.02.15  27/08/2002  J.Tan    SRF 20791                            *
.*                  Recompiled for PATCATBI - Revenue breakdown               *
.*        V9.02.14  06/08/2002  Dean Cramer                                   *
.*                  Enlarge CMDLINE to fix I*I on patcatbixx                  *
.*                  Fix where casemix accomodation comes up UNKNOWN           *
.*                  Fix where casemix miscellaneous code comes up UNKNOWN     *
.*                  Fix where casemix miscellaneous group comes up UNKNOWN    *
.*        V9.02.13  24/07/2002  J.Tan  SRF 19425                              *
.*                  Recompiled for CMXMATRX - mods to use health fund grouper *
.*        V9.02.12  22/04/2002  J.Tan                                         *
.*                  Recompiled for PATCATBI - changes from 6.09               *
.*        V9.02.11  12/03/2002  J.Tan        
.*                  Mods not to open fms file if not using FMS system         *
.*        V9.02.10  07/03/2002  J.Tan        
.*                  Mods to allow reset for consolidate                       *
.*        V9.02.09  19/02/2002  Jill Habasque
.*                  Recompiled for STEPDOWN                                   *
.*        V9.02.08  14/02/2002  Jill Habasque
.*                  Recompiled for STEPDOWN                                   *
.*        V9.02.07  22/01/2002  Steve Downing  SRF 14240                      *
.*                  Recompiled for PATCATBI - changes to modbury layout       *
.*        V9.02.06  07/12/2001  Tonii                                         *
.*                  Recompiled for PATCATBI - Casemix changes                 *
.*        V9.02.05  17/10/2001  Greg Horvat      SRF 13654                    *
.*                  Recompiled for PATCATBI - Changed to display the patient's*
.*                  admission number when a casemix error occurs              *
.*                  16/10/2001  Greg Horvat      SRF 13636                    *
.*                  Recompield for PATCATBI - Changed to use AADMNO rather    *
.*                  than TADMN when reading pattranf for the 1st time when    *
.*                  calculating the amount to be invoiced                     *
.*  V9.02.04  11/10/2001 J.Tan                                                *
.*            Fixed matching site for outpatients                             *
.*  V9.02.03  06/10/2001  J.Tan                                               *
.*            Recompiled for CMXMATRX                                         *
.*  V9.02.02  04/10/2001  J.Tan                                               *
.*            Fixed printing error for Misc. Items, SRF 10954 & 11873         *
.*            in version 609                                                  *
.*            Recompile for PATCATBI (casemix - matrix changes)               *
.*            Include PATTFEFD, new variable ZERO8, dummy label GETTHR        *
.*  V9.02.01  22/09/2001  Tonii  SRF 13075                                    *
.*            Recompiled for PATDINVS                                         *
.******************************************************************************
. * V5.10.B01 06/04/2001  Jill Habasque  SRF 4670                      *
. *           Fixed reset option - moved MOVE ZERO,FINPER to be after  *
. *           read of patfinsf                                         *
. * V5.09.B02 03/01/2001  Jill Habasque                                *
. *           Casemix mods - recompiled for PATCATBI                   *
. * V5.09.B01 15/12/2000  Sandra Barcham                               *
. *           Changed file from fmspataf to patfmsaf                   *
. *           Added write of BAS Code to interface file                *
. **********************************************************************
. * V5.08.13  22/11/2000  Greg Horvat                                  *
. *           Recompiled for PATCATBI - Commented out any code         *
. *           to do with Hong Kong or Mt Alvernia                      *
. * V5.08.12  24/10/2000  Dean Cramer   SRF 6710                       *
. *           Recomplied for OUTCATBI                                  *       
. *           Changed for health fund table code size increase to      *
. *           8 characters                                             *
. * V5.08.11  14/09/2000 Caleb Sharman                                 *
. *           Health fund change mods                                  *
. * V5.08.10  04/08/2000 J.Tan   SRF 2435                              *
. *           Recomp.for PATCATBI - no totals for lanscape with RH     *
. * V5.08.09  16/08/2000  Caleb Sharman                                *
. *           Changed Health Fund variables to be 8 chars              *
. * V5.08.08  29/06/2000  Steve Armstrong                              *
. *           Recompiled for PATCATBI                                  *
. * V5.08.07  28/06/2000  J Tan                                        *
. *           Changed index name for patfigaf file                     *
. * V5.08.06  06/06/2000  Jill Habasque                                *
. *           Changed from key10 to key14 for the health fund file     *
. * V5.08.05  29/05/2000  Caleb Sharman  SRF 639169                    *
. *           Recompiled for OUTCATBI                                  *
. * V5.08.04  18/05/2000  Jill Habasque                                *
. *           Recompiled for changes to AAECATBI                       *
. * V5.08.03  15/05/2000 J.Tan                                         *
. *           Recompiled for PATCATBI - landscape invoice              *
. * V5.08.02  02/04/2000  J.Tan                                        *
. *           Mods subhead of to be invoiced section                   *
. * V5.08.B04 14/03/2000  J.Tan                5.08 Mods               *
. *           Mods for GST                                             *
. * V5.08.B01 11/03/2000  Steve Armstrong      5.08 Mods               *
. *           Mods for changes to OUTCLIFD (effective date)            *
. *           03/03/2000  J.Tan                                        *
. *           Mods to print Nursing home accommodation description     *
. *           28/02/2000  Greg Horvat                                  *
. *           Recompiled for PATCATBI - Changed a few routines into    *
. *           procedures                                               *
. *           25/02/2000  Greg Horvat      SRF 637565                  *
. *           Changes for 4 character DRGs                             *
. **********************************************************************
. * V5.07.08  16/12/1999 J.Tan                                         *
. *           Recompiled for PATCATBI-nursing home & Y2K "tobe invoice"*
. * V5.07.09  10/01/2000 J.Tan                                         *
. *           Fixed printing sub heading of casemix items              *
. * V5.07.07  25/08/1999  Jill Habasque SRF 633206                     *
. *           Fixed printing of Ward/Bed in PATCATBI                   *
. * V5.07.06  15/07/1999  J.Tan                                        *
. *           Fixed the totals accommodation/misc.items                *
. * V5.07.05  13/07/1999  Greg Horvat                                  *
. *           Replaced certain variables & with KEY variables          *
. * V5.07.04  13/07/1999  Nicole Harrington                            *
. *           Recompiled for AAECATBI                                  *
. * V5.07.03  24/05/1999  J.Tan                                        *
. *           Recompiled for PATCMSTP - addition charge description    *
. * V5.07.02  15/03/1999  J.Tan                                        *
. *           Mods for casemix funding                                 *
. * V5.07.01  03/02/1999  Jim Stathopoulos                             *
. *           Report Modifications                                     *
. * V5.07.B05 01/02/1999  Nicole Harrington                            *
. *           507 rebounds                                             *
. * V5.07.B04 13/01/1999  Jim Stathopoulos                             *
. *           Fixed Global Compile Errors                              *
. * V5.07.B03 15/12/1998  Jim Stathopoulos                             *
. *           507 Rebounds                                             *
. * V5.07.B02 10/11/1998  Jim Stathopoulos                             *
. *           507 Changes                                              *
. * V5.07.01  30/10/1998  Katie Nelson                                 *
. *           Recompiled for PATCATBI                                  *
. **********************************************************************
. * V5.05.01  14/10/1997  Steve Armstrong    SRF 643393                *
. *           Recompiled for removal of THC invoice message            *
. **********************************************************************
. * V5.04.04  21/05/97 J.Tan    SRF 620087                             *
. *           Mods for patient/general ledger interface                *
. * V5.04.03  02/05/1997  Steve Armstrong   SRF 642857                 *
. *           Changed temp file name "pstidx" to standard format       *
. * V5.04.02  24/07/1996  Steve Armstrong                              *
. *           Fixed packing of key25 at GENF0100                       *
. * V5.04.01  15/06/1996  Greg Horvat      SRF 616143                  *
. *           Recompiled for OUTCATBI & PATCATBI - Added new invoice   *
. *           layout for MBF - layout 17                               *
. * V5.02.01  24/02/1995  Paul Howells    SRF 134836                   *
. *           Don't validate Site Code for inpatients.                 *
. * V5.02.02  02/03/1995  Greg Horvat      SRF 134196  Quote 8277      *
. *           Changed to print miscell. charges & journals by claim coe*
. *           if respective parameters are set & recompiled for AAECATBI*
. *           & PATCATBI                                               *
. * V5.02.03  18/04/1995  Steve Armstrong                              *
. *           Recompiled                                               *
. * V5.02.04  05/05/1995  ROD           SRF 136175                     *
. *           Recompiled for changes to PATINV10 & PATINV16            *
. * V5.03.B1  08/05/1995  Gabrielle     SRF 135813                     *
. *           Changed to read the patfn1af file with a KEY10           *
. * V5.03.B2  02/06/1995  Steve Armstrong                              *
. *           Recompiled for RCPDEPFD                                  *
. * V5.03.B3  06/06/95  Paul Howells                  SRF 136735       *
. *           Recompiled for PATSELFN                                  *
. * V5.03.B4  22/06/1995  Greg Horvat      SRF 136513                  *
. *           Changed to print the correct journal code when printing  *
. *           journal by claim code                                    *
. * V5.03.02  01/08/1995  Greg Horvat      SRF 610897                  *
. *           Recompiled for AAECATBI - Changed Port Mac. invoice to   *
. *           print the attending doctor in the body of the invoice    *
. * V5.03.03  03/11/1995  Greg Horvat      SRF 612487                  *
. *           Changed to print the journal code within the journals    *
. *           section correctly                                        *
. * V5.03.04  13/12/95  J.Tan      SRF 640744                          *
. *           Recomp.for PATCATBI- no deposit display for insurance in.*
. *                                                                    *
. **********************************************************************
.
          INC       STD001FD
          INC       PABXVARS/INC
          INC       IBASEQFD/INC                 * Sequential Numbers File
          INC       TFILEVAR/INC                 * Generate Temp File Name
          INC       WEBERRFD/INC                 * Web Server Error Logging
.
          INC       AAEDE1FD/INC
          INC       AAEDEBFD/INC
          INC       AAEDTRFD/INC
.
          INC       IBATMHFD/INC
          INC       IBASECFD/INC
          INC       IBAPASFD/INC
          INC       IBACONFD/INC
          INC       IBAGEDFD/INC
          INC       IBAGSTFD/INC
.
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTDTRFD/INC
          INC       OUTSITFD/INC
          INC       OUTSESFD/INC
          INC       BOKRC1FD/INC
          INC       PATBFEFD/INC
          INC       PATCFAFD/INC
          INC       PATCODFD/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATCTFFD/INC
          INC       PMSCIDFD/INC
          INC       PMSCCDFD/INC
          INC       PATELGFD/INC
          INC       PATDHEAD/INC
          INC       PATDGWFD/INC
          INC       PATDINVS/INC
          INC       PATDO1FD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATFINFD/INC
          INC       NZPEXTFD/INC
          INC       NZPFINFD/INC
          INC       PATFIGFD/INC
          INC       NZPFIGFD/INC
          INC       PATFMOFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATFN2FD/INC
          INC       PATHSPFD/INC
          INC       PATHTRFD/INC
          INC       OUTHTRFD/INC
          INC       EMRHTRFD/INC
          INC       PATIBLFD/INC
          INC       PATICUFD/INC
          INC       PATIN1FD/INC
          INC       PATINMFD/INC
          INC       PATINVFD/INC
          INC       PATIOVFD/INC
          INC       PATIPEFD/INC
          INC       PATITMFD/INC
          INC       PATMA1FD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATOVBFD/INC
          INC       PATPGRFD/INC
          INC       PATRBLFD/INC
          INC       PATRE1FD/INC
          INC       PATRCAUD/INC
          INC       PATRATFD/INC
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       NZPRFNFD/INC
          INC       NZPRDTFD/INC
          INC       PATSELDT/INC
          INC       PATSRBFD/INC
          INC       PATTFEFD/INC
          INC       PATTRNFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC
          INC       PMSCNOFD/INC
          INC       PMSHATFD/INC
          INC       PMSHCPFD/INC
          INC       PMSEVTFD/INC
          INC       PMSVX1FD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PATFMSFD/INC
          INC       PMSFMSFD/INC
          INC       IBAGINFD/INC
          INC       FMSLMAFD/INC
          INC       PMSSINFD/INC
          INC       PATCMTFD/INC
          INC       PMSCMTFD/INC
          INC       PMSMTIFD/INC
          INC       PMSMPRFD/INC
          INC       PMSSGAFD/INC
          INC       PATSTAFD/INC
          INC       PATAA1FD/INC
          INC       PATONHFD/INC
.
          INC       PATAFEFD/INC
          INC       PATASDFD/INC
          INC       PATCMXFD/INC
          INC       PATHDFFD/INC
          INC       PATHLFFD/INC
          INC       PATLDFFD/INC
          INC       PATLSDFD/INC
          INC       PMSPYRFD/INC
          INC       PMSPBRFD/INC
          INC       PMSIDEFD/INC
          INC       PMSIVBFD/INC
.
          INC       VISPAYFD/INC
          INC       NZPBFEFD/INC
          INC       NZPCMTFD/INC
          INC       NZPCFNFD/INC
          INC       MLTCFNFD/INC
          INC       NZPIBRFD/INC
          INC       NZPSPRFD/INC
          INC       NZPPFEFD/INC
          INC       NZPPICFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       NZPTFEFD/INC
          INC       NZPIVBFD/INC
          INC       NZPRVBFD/INC
          INC       NZPRBRFD/INC
          INC       OPRARDFD/INC
          INC       OPRDEAFD/INC
          INC       OPRSESFD/INC
          INC       PRIITMFD/INC
          INC       PATRGMFD/INC
          INC       PMSREGFD/INC
.
          INC       EMRSITFD/INC
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       COMDEPFD/INC
          INC       RCPBNKFD/INC
          INC       RCPBDTFD/INC
          INC       RCPDTEFD/INC
          INC       RCPCONFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PATDDHFD/INC
+
TMPFILE2 IFILE     SQL, FIXED=61, KEY="U1-1,2-4,47-47,5-17"
.Name    Type     Size    Physical   Start     Description
.----    ----     ----    --------   -----     -----------
XCURSECT   DIM       1       1         1       Current Section
.                                              1 = Section 1 (Inv)
.                                              2 = Section 2 (To be inv)
.SAVFMHOS  DIM       3       3         2       Hospital ID
.SAVFCODE  DIM      13      13         5       Fincode (item group)
XTTAMITM   FORM     12.2     8         18      Total of Item amount
XTTCRITM   FORM     12.2     8         26      Total of Credit Note Items amount
XFINCODE   DIM      13      13         34      Fincode
.SAVFMSYS  DIM       1       1         47      System (1 EMR, 2 Outpat, 3 Inpat)
.SAVSCODE  DIM      13      13         48      Sub code
.EOR                                   61
.
TMPFILE1 IFILE     SQL, FIXED=40, KEY="U1-3,20-20"
.Name    Type     Size    Physical   Start     Description
.----    ----     ----    --------   -----     -----------
XHOSPID  DIM       3         3         1       Hospital ID
XTTAMGST FORM    12.2        8         4       Total GST amount
XTTCRGST FORM    12.2        8        12       Total Credit Note GST amount
XFSYST   DIM       1         1        20       System
XSPARE   DIM       19       19        21       Spare
.EOR                                  40
.
.          Temporary file used to accumulate data before printing report
.
TEMPFILE IFILE     SQL, FIXED=218, KEY="U1-1,2-3,4-16"     * was 186   *C-65765
.
.Name    Type     Size    Physical   Start     Description
.----    ----     ----    --------   -----     -----------
DSECTION DIM       1         1         1       Section of report
.                                              1 = Section 1 (Inv/cash/jrnl/crd)
.                                              2 = Section 2 (To be inv)
.                                              3 = Section 3 (Merch cards)
.
DSUBSECT DIM       2         2         2       Sub Section of report
.                                              Section 1:
.                                                 1 = Accom./Clinic charge
.                                                 2 = Casemix funding accomm.
.                                                 3 = Misc items
.                                                 4 = Credit Note Accomm.
.                                                 5 = Credit Note Casemix
.                                                 6 = Credit Note Misc.Items
.                                                 7 = GST 
.                                                 8 = Credit Note GST 
.                                                 9 = Cash
.                                                10 = Journals
.                                                11 = GST Journals
.                                                12 = Discount - John Hopkins
.                                                13 = Rounding - John Hopkins
.                                                14 = Credit Note Discount 
.                                                15 = Credit Note Rounding 
.
.                                              Section 2:
.                                                 1 = Accom./Clinic charge
.                                                 2 = Casemix funding accomm.
.                                                 3 = Misc items
.                                                 4 = Cash
.                                              Section 3:
.                                                 1 = Claimed
.                                                 2 = Cash
.                                                 3 = Commission
.                                                 4 = Journals
.
SUBCODE  DIM       13        13        4       Subsection code
.                                              Section 1.1 & 2.1 & 1.4:
.                                                 AXXX   , XXX  = Adm Type
.                                                               = Adm Type
.                                                 or
.                                                 AXXXYYY, XXX  = Ward
.                                                          YYY  = Claim Type
.                                                 or
.                                                 AXXXYYYZ,XXX  = Claim Type
.                                                          YYY  = Adm type
.                                                            Z  = Extra Charge
.
.                                                 BXXX   , XXX  = Mat Rate Code
.
.                                                 Inpatient casemix
.                                                 CXYYY  , X    = Episode type
.                                                          YYY  = Adm.Type
.
.                                                 Outpatient
.                                                 OXXXXXXYYY
.                                                        XXXXXX = Clinic id
.                                                           YYY = Site prefix
.                                                 G             = Gov Subsudy
.                                                 ZZZZZZZ       = Section Total
.
.                                              Section 1.3 & 2.3 & 1.4:
.                                                PTCNMFEE=1
.                                                 XXXYYY    XXX = Claim Code,
.                                                           YYY = Misc Grp/Item
.                                   (Casemix):    TZXXXYYY  Z   = Episode type
.                                                           XXX = Claim Code,
.                                                           YYY = Misc Grp/Item
.                                                ELSE
.                                                 XXX    , XXX  = Misc Grp
.                                                 TZXXX  , Z    = Episode type
.                                                          XXX  = Misc Grp
.                                                (if Misc.Grp does not exist):
.                                                    YYYY, YYYY = Item code
.                                                ENDIF
.                                                ZZZZZZYYY      = GST code
.                                                ZZZZZZZ        = Section Total
.                                                                   (Inc Accom)
.                                              Section 1.5 & 2.5:
.                                                 A             = From Patient
.                                                 BXXXXXX       = From H.F.
.                                                 C             = From Govt Sub
.                                                 DXXX   , XXX  = Deposit
.                                                 IXXXXXX,      = Ins Company
.                                                 MXXX   , XXX  = Merch Company
.                                                 ZZZZZZZ       = Section Total
.                                              Section 1.6 & 2.6 & 1.7:
.                                               PTCNJFEE=1
.                                                 XXXYY         = Claim Code,
.                                                                 Journal Code
.                                               ELSE
.                                                 XX            = Journal Code
.                                               ENDIF
.                                                 WCXXX         = Merch Commiss
.                                                 WJXXX         = Merch Journal
.                                                 ZZZZZZYYY     = GST code
.                                                 ZZZZZZZ       = Section Total
.                                              Section 3.1, 3.2, 3.3, 3.4:
.                                                 XXX           = Merchant Code
.                                                 ZZZZZZZ       = Section Total
.
. ***  Note:Credit Note will have prefix of N for Accommodation
.                                           H for Casemix Lumpsum
.                                           J for Casemix daily charge
.                                           Q for Misc.item
.                                           P for Casemix Misc.item
.
SUBDESC1 DIM       30        30        17      Description for Subcode 1
SUBDCOD  DIM       11        11        47      Displayed code for sub code
SUBDESC2 DIM       30        30        58      Description for Subcode 2
SUBUS2DS FORM      1         2         88      Using 2nd description
XSUBPER  FORM     12.2       8         90      Period Figure
XSUBYTD  FORM     12.2       8         98      YTD Figure
XSUBPRY  FORM     12.2       8        106      Prior Year Figure
XSUBM01  FORM     12.2       8        114      Month 01 Figure
XSUBM02  FORM     12.2       8        122      Month 02 Figure
XSUBM03  FORM     12.2       8        130      Month 03 Figure
XSUBM04  FORM     12.2       8        138      Month 04 Figure
XSUBM05  FORM     12.2       8        146      Month 05 Figure
XSUBM06  FORM     12.2       8        154      Month 06 Figure
XSUBM07  FORM     12.2       8        162      Month 07 Figure
XSUBM08  FORM     12.2       8        170      Month 08 Figure
XSUBM09  FORM     12.2       8        178      Month 09 Figure
XSUBM10  FORM     12.2       8        186      Month 10 Figure
XSUBM11  FORM     12.2       8        194      Month 11 Figure
XSUBM12  FORM     12.2       8        202      Month 12 Figure
XSUBM13  FORM     12.2       8        210      Month 13 Figure
.
.                  END OF RECORD      218
.
.        Redefine variables for the key for the temp file
.
.Name    Type     Size    Physical   Start     Description
.----    ----     ----    --------   -----     -----------
SECTION  FORM      1         1         1       Section of report
SUBSECT  FORM      2         2         2       Sub Section of report
.
SUBPER   FORM     12.2       8         90      Period Figure
SUBYTD   FORM     12.2       8         98      YTD Figure
SUBPRY   FORM     12.2       8        106      Prior Year Figure
SUBM01   FORM     12.2       8        114      Month 01 Figure
SUBM02   FORM     12.2       8        122      Month 02 Figure
SUBM03   FORM     12.2       8        130      Month 03 Figure
SUBM04   FORM     12.2       8        138      Month 04 Figure
SUBM05   FORM     12.2       8        146      Month 05 Figure
SUBM06   FORM     12.2       8        154      Month 06 Figure
SUBM07   FORM     12.2       8        162      Month 07 Figure
SUBM08   FORM     12.2       8        170      Month 08 Figure
SUBM09   FORM     12.2       8        178      Month 09 Figure
SUBM10   FORM     12.2       8        186      Month 10 Figure
SUBM11   FORM     12.2       8        194      Month 11 Figure
SUBM12   FORM     12.2       8        202      Month 12 Figure
SUBM13   FORM     12.2       8        210      Month 13 Figure
.
PTINVGL   FILE      ASCII, FIXED=120
.
.Name    Type     Size    Start     Description
.----    ----     ----    -----     -----------
.IBGILEDG  DIM       2      2        1     Ledger
.IBGIACCT  DIM       12     12       3     Account
.IBGIDATE  DIM       8      8        15    Date (Optional)
.IBGISIGN  DIM       1      1        23    Sign
.IBGIVALU  FORM      12.2   15       31    Value
.IBGIDESC  DIM       30     30       39    Transaction Description (Optional)
.IBGIREF   DIM       15     15       69    Reference (Optional)
.IBGIDISS  DIM       5      5        84    Dissection (Optional)
.IBGIRESP  DIM       4      4        89    Responsibility (Optional)
.IBGICRAC  DIM       12     12       93    Credit Account - Cash (Optional)
.IBGICRAA  DIM       12     12       105   Credit Account - Accrual (Optional)
.IBGIBASC  DIM       3      3        117   BAS Code
.End of record                       120
.
.***  With paramter for Show description on G/L Extract IBGIREF will have DIM 30
.     (IBGIEREF)
.
PTTBIGL   FILE      ASCII, FIXED=120
.
.Name    Type     Size    Start     Description
.----    ----     ----    -----     -----------
.IBGILEDG  DIM       2      2        1     Ledger
.IBGIACCT  DIM       12     12       3     Account
.IBGIDATE  DIM       8      8        15    Date (Optional)
.IBGISIGN  DIM       1      1        23    Sign
.IBGIVALU  FORM      12.2   15       31    Value
.IBGIDESC  DIM       30     30       39    Transaction Description (Optional)
.IBGIREF   DIM       15     15       69    Reference (Optional)
.IBGIDISS  DIM       5      5        84    Dissection (Optional)
.IBGIRESP  DIM       4      4        89    Responsibility (Optional)
.IBGICRAC  DIM       12     12       93    Credit Account - Cash (Optional)
.IBGICRAA  DIM       12     12       105   Credit Account - Accrual (Optional)
.IBGIBASC  DIM       3      3        117   BAS Code
.End of record                       120
.
.               WORK AREA
.
ADAY      DIM       2
AMON      DIM       2
AYER      DIM       2
ACEN      DIM       2
ACCTOTF         FORM    1
ACCDTE          DIM     8         * accommodation date used in AAECATBI
AECNFTYP        FORM    1
AECNCHRS        FORM    1
DIM7            DIM     7
DIM11           DIM     11
DIM13           DIM     13
DIM14           DIM     14
DIM24A          DIM     24
MCCODE          INIT    "MC"
DPCODE          INIT    "DP"
MSO             INIT    "MSO"
SDAY            INIT    "DAY"
SAMEDAY         INIT    "SAMEDAY"
.
XLCNT     FORM    2
ZERO00    FORM    ".00"
.
ACTION    DIM       1                       * Action for PATAA1FD
ADD       DIM       2                       * Day for PATAA1FD
AMM       DIM       2                       * Month for PATAA1FD
AYY       DIM       2                       * Year for PATAA1FD
ACC       DIM       2                       * Century for PATAA1FD
OPERCODE  DIM       4                       * Operator code for PATAA1FD
CSTRTYR   DIM       8
FORM5     FORM      5
UPADMTYP  DIM       1
WARNINGL  DIM       20
.
.
.      EXTRA VARIABLES
.
CREDFLAG        FORM    1
CDYSDAYS        FORM    6                       * CALCDAYS number of days
CDYSFDTE        DIM     8                       * CALCDAYS from date
CDYSTDTE        DIM     8                       * CALCDAYS to date
CDYSYEAR        FORM    2                       * CALCDAYS year
CMXMSC          FORM    1
CALDAYS         FORM    3
CERTINDC        FORM    1
CLMTYPE         DIM     3
CURRDATE        DIM     8
CURYEAR         DIM     4
BULKBILL        DIM     1
CODE            DIM     2
CATCR           INIT    "cr"
CODEA           INIT    "A "
CODECL          INIT    "CL"
CODEDP          INIT    "DP"
CODEJ           INIT    "J "
CODEPY          INIT    "Py"
CMDLINE         DIM     100
CURSECT         FORM    1
CURSESS         DIM     18
CURSUBS         FORM    2
.
DAYFLG          FORM    1
DIM1A           DIM     1
DIM2A           DIM     2
DIM3B1          DIM     3
DIM4            DIM     4
DIM4A           DIM     4
DIM9            DIM     9
DIM10A          DIM     10
DIM12           DIM     12 
DIM18           DIM     18 
DIM18A          DIM     18 
DIM30           DIM     30
DISCJRNL        DIM     7
DWARD           DIM     3
DIM3AA          DIM     3
DIM3BB          DIM     3
DIM3CC          DIM     3
DIM5A           DIM     5
DAILY           INIT    "DAILY: "
DOCFNAME        DIM       50
.
TTBILL    FORM      12.2
TTDAYS    FORM      8
TTNETT    FORM      12.2
TRANTYPE        FORM      1
INCLBOOK        FORM      "0"
INVFDATE        DIM       8
INVTDATE        DIM       8
FINSUMFL        FORM      1
EXPORTFL        FORM      1         * Create Export File
EXPORTDE        FORM      1         * Show Description Export
EXPORTDN        DIM       20        * Detailed Description Name
EMCNGINV        DIM       1
EMCNDPOC        DIM       1
EMCNOPOC        DIM       15
EFTDATE         DIM     8
ERRORFLG        FORM    1
EXTRA           INIT    "Extra"
EXTRACH         DIM     5
.
FMTGNAME        DIM       35
FMTTITLE        DIM       10
FMTSNAME        DIM       35
FOUR0           INIT    "0000"
FORM3A          FORM    3
FIVE9           FORM    "59"
FINYTD          FORM    12.2                               * was 8.2  *C-225306
FNAMEI          DIM     8
FNAMEW          DIM     8
FNAMET          DIM     8
FNAMEM          DIM     8
FILEOPEN        DIM     30
FFIN            INIT    "ffin"
TFIN            INIT    "tfin"
THCFLG          FORM    2
.
FPDATE          DIM     10
FCC             FORM    2
FDD             FORM    2
FMM             FORM    2
FYY             FORM    2
FTCC            DIM     2
FTDD            DIM     2
FTMM            DIM     2
FTYY            DIM     2
FIRSTFLG        FORM    1
.
GSTADJST        FORM    6.6
GSTCODE         INIT    "ZZZZZZYYY"     * code for GST record
.
HFHIFUND        FORM    2
.
JYEAR           FORM    2
.
MBSFLAG         FORM    1
MDESC1          DIM     68
MDESC2          DIM     68
MDESC3          DIM     68
MINDEX          FORM    2
MONNAME         DIM     12
.
NOTBINVC        FORM    1         * no tobe invoiced flag
NOSUBS          FORM    1
NUMPERS         FORM    2
.
OPRDATE         DIM     8
OTCNCFEE        FORM    1
OTCNFTYP        FORM    1
OPOCFLAG        FORM    1
.
.
SAVSCODE        DIM     13
SKEY16          DIM     16
SAVESECT        DIM     1
SAVAMNT         FORM    12.2
SERVDOCT        DIM     10
SECTHD          DIM     29
SECT1           INIT    "FEES INVOICED DETAIL"
SECT2           INIT    "TO BE INVOICED DETAIL"
SECT3           INIT    "MERCHANT TRANSACTION DETAIL"
SUMM1           INIT    "FEES INVOICED SUMMARY"
SUMM2           INIT    "TO BE INVOICED SUMMARY"
SUMM3           INIT    "MERCHANT SUMMARY"
.
SAVBEND         FORM    3
SAVALLW         FORM      6.2
SAVDISC         FORM      6.2
SAVEXTRA        FORM      6.2
SAVFIN          FORM      8.2[20]
SAVKEY16        DIM     16
SAVFMSUB        DIM     1
SAVFMSYS        DIM     1
SAVFMHOS        DIM     3
SP12            INIT    "            "
SP14            INIT    "              "
STYTD           FORM    2
SUBHEAD         DIM     29
SYSAL           INIT    "Consolidated "
SYSIP           INIT    "   Inpatient "
SYSOP           INIT    "  Outpatient "
SYSAE           INIT    "       A + E "
SYSOT           INIT    "  Other Fin. "
SYSID           DIM     13
SYSTEM          FORM    1
INVNAME         DIM     80
TBINAME         DIM     80
TBIFLAG         FORM    1
TFEEIND         FORM    1
.
VISTYP          DIM       3   
TOTAMTS         FORM    12.2
.
TOMINUS         INIT    " -A-B-C-D-E-F-G-H-I-J-K-L-M-N-O-P-Q-R-S-T-U-V-W-X-Y-Z-"
.
WORK1           FORM    12.2
WORK2           FORM    12.2
.
UNKCLCOD        INIT    "UNKNOWN CLAIM CODE  "
UNKJOUR         INIT    "UNKNOWN JOURNAL TYPE"
UNKMISC         INIT    "UNKNOWN MISC CODE   "
UNKMGRP         INIT    "UNKNOWN MISC GROUP  "
ACCOMTL         INIT    "ACCOM: "
ACCTL1          INIT    "WARD "
ACCTL2          INIT    "  CLAIM TYPE "
ACCTL3          INIT    "MATRN : "
ACCTL4          INIT    "CLAIM "
ACCTL5          INIT    "CLINIC "
ACCTL6          INIT    "ADM "
ACCTL7          INIT    "ADM TYPE:"
.
PATTYPE         DIM      3
PATIP           INIT     " IP"
PATDC           INIT     " DC"
PRTFLAG         FORM     1
PTFMSYST        DIM      1
.
WBSEUID         DIM     10
WDATE1          DIM      8
WDATE2          DIM      8
NOTCYR          FORM     1
YEARTTL         DIM      19
NOWYEAR         DIM      4
NOWCC           DIM      2
NOWYY           DIM      2
OPCNCONS        DIM      1
OPNBRA          INIT    "("
CLSBRA          INIT    ")"
OPNFLAG         FORM    "0"      * Used in stepdown
TILDA20         INIT    "~~~~~~~~~~~~~~~~~~~~"
ZERO4           INIT    "0000"
.
.         Web Variables (only the include files use these variables)
.
DAYFORMT  DIM       4
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
KEY13A    DIM       13
KEYFLAG   FORM      1
HESYST    FORM      1
HOSPID    DIM       3
HOSPNAME  DIM       50
HOSPFLAG  FORM      1
HTMLFILE  FIFO      ASCII, FIXED=250
MTHNAM3   DIM       3
MTHNAM3A  DIM       3
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
.
.         end web variables
.
PRGID     INIT      "IBABIL19"
PRGNAM    INIT      "Fees Invoiced Report"
VERSION   INIT      "V12.00.00"
+
.
.        ======================================================================
.        MAIN0000: Main program loop
.        ======================================================================
.
.        Start of program
.
         CALL      INIT0000                      * Initialiation routine
         BRANCH    EXIT,MAIN9999                 * Init failure
MAIN1000 CALL      OPTN0000                      * Select option to be run
         BRANCH    EXIT,MAIN9999                 * exit
.
         IF        OPTION=2
           CALL      FSUM0000                    * Financial Summary
           BRANCH    EXIT,MAIN9999               * exit
         ENDIF
.
         CALL      OPST0000                      * Do initialisation for option
         CALL      GENF0000                      * Generate sections 1 & 3
         IF        NOTBINVC=0
           CALL      GENT0000                    * Generate section 2 of report
         ENDIF
.
         CALL      PRNT0000                      * Print the report
         CALL      ENDP0000                      * Do any post processing
.
         BRANCH    OPTION,MAIN1000               * Print only
.
         MATCH     "1",PTCNSIGL                  * System based G/L interface?
         GOTO      MAIN2000 IF NOT EQUAL         * No
.
         COMPARE   ONE,CGLIND
         GOTO      MAIN2000 IF NOT EQUAL         * No interface 
         CALL      PRGL0000                      * Print G/L Inteface
.
MAIN2000 COMPARE   ONE,FINSUMFL
         GOTO      MAIN1000 IF NOT EQUAL         * not running financial summary
.
         PROC      FINSUMMR                      * Print Financial summary
.
         GOTO      MAIN1000                      * Get the next option
.
MAIN9999 CALL      KILL0000
         CALL      KILT0000
         CHAIN     PGM                           * Exit
         STOP
+
.        ======================================================================
.        INIT0000: Initialisation routine
.        ======================================================================
.
INIT0000 CALL      DISPHEAD                      * Display program heading
.
.        Open files
.
         DISPLAY   *P56:24,"Opening patdschf";
         OPEN      PATDSCH1,"patdschf"
.
         DISPLAY   *P64:24,"patcfaaf";
         OPEN      PATCFAA1,"patcfaaf"
.
         DISPLAY   *P64:24,"patmi1af";
         OPEN      PATMI1A1,"patmi1af"
.
         DISPLAY   *P64:24,"patma1af";
         OPEN      PATMA1A1,"patma1af"
.
         DISPLAY   *P64:24,"patmx1af";
         OPEN      PATMX1A1,"patmx1af"
.
         DISPLAY   *P64:24,"patwr1af";
         OPEN      PATWR1A1,"patwr1af"
.
         DISPLAY   *P64:24,"pattranf";
         OPEN      PATTRAN2,"pattranf"
.
         DISPLAY   *P64:24,"patdtraf";
         OPEN      PATDTRA1,"patdtraf"
.
         DISPLAY   *P64:24,"pmsmtiaf";
         OPEN      PMSMTIA1,"pmsmtiaf"
         OPEN      PMSMTIA2,"pmsmtiaf"
         OPEN      PMSMTIA4,"pmsmtiaf"
.
         DISPLAY   *P64:24,"patdrgaf";
         OPEN      PATDRGA1,"patdrgaf"
.
         DISPLAY   *P64:24,"patfx1af";
         OPEN      PATFX1A1,"patfx1af"
.
         DISPLAY   *P64:24,"patfinsf";
         OPEN      PATFINS1,"patfinsf"
         OPEN      PATFINS2,"patfinsf"
.
         DISPLAY   *P64:24,"patfigaf";
         OPEN      PATFIGA1,"patfigaf"
         OPEN      PATFIGA2,"patfigaf"
.
         DISPLAY   *P64:24,"patcodes";
         OPEN      PATCODE1,"patcodes"
.
         DISPLAY   *P64:24,"aaede1af";
         OPEN      AAEDE1A1,"aaede1af"
.
         DISPLAY   *P64:24,"aaedtref";
         OPEN      AAEDTRE1,"aaedtref"
.
         DISPLAY   *P64:24,"outsitaf";
         OPEN      OUTSITA1,"outsitaf"
.
         DISPLAY   *P64:24,"patvisaf";
         OPEN      PATVISA1,"patvisaf"
.
         DISPLAY   *P64:24,"pmsvx1af";
         OPEN      PMSVX1A1,"pmsvx1af"
.
         DISPLAY   *P64:24,"patipenf";
         OPEN      PATIPEN1,"patipenf"
.
         DISPLAY   *P64:24,"controlf";
         OPEN      CONTROLF,"controlf"
.
         OPEN      PATMCHG1,"patmchgf"           * Misc Charges file
         OPEN      PATITEM1,"patitemn"           * MBS item file
.
         DISPLAY   *P64:24,"rcpbnkaf";
         OPEN      RCPBNKA1,"rcpbnkaf"
.
         DISPLAY   *P64:24,"oprardaf";
         DISPLAY   *P64:24,"rcpbdtaf";
         OPEN      RCPBDTA1,"rcpbdtaf"
.
         DISPLAY   *P64:24,"oprardaf";
         OPEN      OPRARDA1,"oprardaf"
.
         DISPLAY   *P64:24,"oprdetaf";
         OPEN      OPRDETA1,"oprdetaf"
.
         OPEN      PMSEVTA1,"pmsevtaf"
         OPEN      PATFN1A1,"patfn1af"
.
         READ      CONTROLF,ZERO;*43,IBCNMHOS,*85,IBCNUGST
         READ      CONTROLF,TEN;*33,PTCNGSTF,*104,PTCNMBSF:            *C-47385
                                *192,CACCFEE:
                                *217,CAUDQ    * added for V5.01.15 - SRF 105195
         READ      CONTROLF,TEN3;*211,CINV1ST,*245,CHOSTYP
         READ      CONTROLF,TEN5;*247,CSTDOWN
         READ      CONTROLF,TEN8;*162,CGLIND,CGLPATH
         READ      CONTROLF,TEN9;*212,CFEETYP
         READ      CONTROLF,TWENTY;*164,PTRESDAY,*193,PTCNDCLM:
                                   *199,PTCNBCUT,*211,PTCNCNDY
         READ      CONTROLF,TWENTY1;*120,PTCNADDC
         READ      CONTROLF,THIRTY;*200,AECNFTYP
         READ      CONTROLF,THIRTY1;*163,OTCNFTYP,OTCNCFEE
         READ      CONTROLF,THIRTY6;*86,HSYS1,*113,HJNL
         READ      CONTROLF,FIVE9;*1,CDLSTEP,*60,PTCNUFMS,*66,CGSTPERC,CGSTITEM
         READ      CONTROLF,SEVENTY7;*214,PTCNBTNM
         READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
         READ      CONTROLF,EIGHTY8;*102,CFEEDT,*162,PTCFEEOF:
                                    *194,PTCFEEAE,PTCFEEOP,*233,PTCNADES:
                                    *248,PTCNISBZ
         READ      CONTROLF,HUND03;*219,PTCNSIGL
         READ      CONTROLF,HUND05;*99,PTCNNWCM:
                                   *158,PTCNDGPV:
                                   *205,PTCNPFID:
                                   *247,PTCNCDIS
         READ      CONTROLF,HUND08;*1,HDATARCP
         READ      CONTROLF,HUND09;*247,PTCNROUN
         READ      CONTROLF,HUND16;*211,PTCNGLPF,*224,PTCNFGST,*225,PTCNFEMR
         READ      CONTROLF,HUND28;*105,PTCNUABF
.
         PACK      DISCJRNL,HJNL,SP10
         MOVE      ONE,PRTFLAG
         REP       " 0",PTCNSIGL
.
         IF        IBCNMHOS=1
           MOVE      ONE,CGLIND           * Multi hosp always has G/L interface
           OPEN      PATHSPA1,"pathspaf"
         ENDIF
.
         IF        IBCNUGST=2 | IBCNUGST=3
           MOVE      ZERO,PTCNGSTF        * not applicable for Aust.GST
         ELSE
           ASSIGN    (1.0 + (CGSTPERC/100.0)),GSTADJST
         ENDIF
.
         PACK      CURRDATE,CCC,CYY,CMM,CDD
         REP       " 0",CURRDATE
.
.        Set up the names of the temporary files used
.
...  used in ABFAECCL
         CALL      TFILENAM                * Get file name calculating Exponent
         MOVE      TFILNAME,FNAMEN

         CALL      TFILENAM                     * Generate temporary file name
         MOVE      TFILNAME,FNAMEI
.
         CALL      TFILENAM                     * Generate temporary file name
         MOVE      TFILNAME,FNAMEW
.
         CALL      TFILENAM                     * Generate temporary file name
         MOVE      TFILNAME,FNAMET
.
         CALL      TFILENAM                     * Generate temporary file name
         MOVE      TFILNAME,FNAMEM
.
...  used in PATCATBI CRMV0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEX
.
...  used in PATCATBI PTMP0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEZ
.
...  used in PATCATBI PT2P0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEY
.
...  used in PABXBILL
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAME
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAM2
.
.        Set up the G/L interface file names
.
         PACK      KEY4,CMM,CDD
         REP       " 0",KEY4
         STRIP     HDATARCP
         CLEAR     INVNAME
         APPEND    HDATARCP,INVNAME
         MATCH     SP70,PTCNGLPF
         IF        !@EQUAL
           SQUEEZE   PTCNGLPF
           APPEND    PTCNGLPF,INVNAME
         ENDIF
         APPEND    FFIN,INVNAME
         APPEND    KEY4,INVNAME
         APPEND    ".txt",INVNAME
         APPEND    SP70,INVNAME
         RESET     INVNAME
.
         STRIP     HDATARCP
         CLEAR     TBINAME
         APPEND    HDATARCP,TBINAME
         MATCH     SP70,PTCNGLPF
         IF        !@EQUAL
           SQUEEZE   PTCNGLPF
           APPEND    PTCNGLPF,TBINAME
         ENDIF
         APPEND    TFIN,TBINAME
         APPEND    KEY4,TBINAME
         APPEND    ".txt",TBINAME
         APPEND    SP70,TBINAME
         RESET     TBINAME
.
         COMPARE   ONE,CGLIND      * Check parameter
         GOTO      INIT0500 IF NOT EQUAL
.
         MOVE      TWENTY,XLCNT
INIT0400 RESET     CGLPATH,XLCNT
         CMATCH    SP1,CGLPATH
         GOTO      INIT0450 IF NOT EQUAL
         SUB       ONE,XLCNT
         COMPARE   ZERO,XLCNT
         GOTO      INIT0400 IF NOT EQUAL
         CLEAR     CGLPATH
         GOTO      INIT0460
.
INIT0450 LENSET    CGLPATH
         RESET     CGLPATH
.
INIT0460 MATCH     "1",PTCNSIGL
         GOTO      INIT0480 IF EQUAL       * Using system based G/L Interface
         MATCH     "2",PTCNSIGL
         GOTO      INIT0480 IF EQUAL       * Using system based G/L Interface
.
         DISPLAY   *P38:24,"patfmsaf";
         MOVE      ZERO,OVRCD
         TRAP      OVERCOND IF IO
         OPEN      PATFMSA1,"patfmsaf"
         TRAPCLR   IO
         IF        OVRCD = 1
           DISPLAY   *P1:24,*EL,*B,"File Not Found, patfmsaf - ";
           CALL      HITENTER
           GOTO      INIT9900
         ENDIF
         GOTO      INIT0500
.
INIT0480 DISPLAY   *P38:24,"pmsfmsaf";
         MOVE      ZERO,OVRCD
         TRAP      OVERCOND IF IO
         OPEN      PMSFMSA1,"pmsfmsaf"
         TRAPCLR   IO
         IF        OVRCD = 1
           DISPLAY   *P1:24,*EL,*B,"File Not Found, pmsfmsaf - ";
           CALL      HITENTER
           GOTO      INIT9900
         ENDIF
.
.        Get the current financial period (used as a default year)
.
INIT0500 PACK      CPTDATE,CCC,CYY,CMM,CDD
         REP       " 0",CPTDATE
         CALL      GPERD
         BRANCH    EXIT,INIT9000
.
         MOVE      DRGYR,NOWYEAR                 * Save the year.
.
.        Set up the month descriptions for the heading.
.        MDESC1 contains the first  six periods of the financial year
.        MDESC2 contains the second six periods of the financial year
.        MDESC3 contains the third six periods of the financial year
.        NUMPERS contains the number of periods in the financial year
.
         CLEAR     MDESC1                        * Clear the description
         CLEAR     MDESC2                        * Clear the description
         CLEAR     MDESC3                        * Clear the description
.
         PACK      KEY6,NOWYEAR,SP2
         CALL      RDSDRGA1                      * Position at start of year
INIT1000 CALL      RDKDRGA1
         BRANCH    OVRCD,INIT4000                * Finished loop
.
         MATCH     DRGYR,NOWYEAR                 * Still the same year ?
         GOTO      INIT4000 IF NOT EQUAL         * No. Finished loop
.
.        Add the description for this period to the appropriate variable
.
         ADD       ONE,NUMPERS                   * Increment number of periods
.
         IF        PRTFLAG=1
           COMPARE   NINE,NUMPERS                * Done the 2nd 6 periods yet ?
           GOTO      INIT3000 IF NOT LESS        * Yes.
           COMPARE   FIVE,NUMPERS                * Done the 1st 6 periods yet ?
           GOTO      INIT2000 IF NOT LESS        * Yes.
         ELSE
           COMPARE   TEN3,NUMPERS                * Done the 2nd 6 periods yet ?
           GOTO      INIT3000 IF NOT LESS        * Yes.
           COMPARE   SEVEN,NUMPERS               * Done the 1st 6 periods yet ?
           GOTO      INIT2000 IF NOT LESS        * Yes.
         ENDIF
.
.        Add the description to the 1st six periods
.
         APPEND    SP5,MDESC1                    * Add leading blanks
         APPEND    DRGMDSC,MDESC1                * Append description
         APPEND    SP3,MDESC1                    * Add trailing blanks
         GOTO      INIT1000
.
.        Add the description to the 2nd six periods
.
INIT2000 APPEND    SP5,MDESC2                    * Add leading blanks
         APPEND    DRGMDSC,MDESC2                * Append description
         APPEND    SP3,MDESC2                    * Add trailing blanks
         GOTO      INIT1000
.
.        Add the description to the 3rd six periods
.
INIT3000 APPEND    SP5,MDESC3                    * Add leading blanks
         APPEND    DRGMDSC,MDESC3                * Append description
         APPEND    SP3,MDESC3                    * Add trailing blanks
         GOTO      INIT1000
.
.        Finished processing financial year
.
INIT4000 APPEND    SP30,MDESC1
         APPEND    SP30,MDESC1
         APPEND    SP30,MDESC1
.
         APPEND    SP30,MDESC2
         APPEND    SP30,MDESC2
         APPEND    SP30,MDESC2
.
         APPEND    SP30,MDESC3
         APPEND    SP30,MDESC3
         APPEND    SP30,MDESC3
.
         RESET     MDESC1                        * Reset description 1
         RESET     MDESC2                        * Reset description 2
         RESET     MDESC3                        * Reset description 2
.
.        Restore the financial year record
.
         PACK      KEY6,NOWYEAR,SP2
         CALL      RDSDRGA1
         CALL      RDKDRGA1
.
         MOVE      ZERO,EXIT                     * Initialisation succeeded
         GOTO      INIT9999
.
.        Error finding current period
.
INIT9000 KEYIN      *P1:24,*EL,*B:
                    "Current Date Missing in the Period Range File. ";
         CALL       HITENTER
.
INIT9900 MOVE       ONE,EXIT                     * Initialisation failed
.
INIT9999 RETURN
+
.        ======================================================================
.        OPTN0000: Select option to be run
.        ======================================================================
.
OPTN0000 HLINE     *G37,2,50,80
         KEYIN     *P1:3,*EF:
                   *P1:4,*V2LON,*DV,ZERO,*HOFF," = Exit":
                   *P1:5,*V2LON,*DV,ONE,*HOFF," = Print Only":
                   *P1:6,*V2LON,*DV,TWO,*HOFF," = Print and Reset":
                   *P1:8,"Option : ",*EL,*V2LON,OPTION
.
         COMPARE   ZERO TO OPTION                * Check if they want to exit
         GOTO      OPTN9000 IF EQUAL
.
         MOVE      ZERO,NOTBINVC                 * no tobe invoiced flag
         MOVE      ZERO,INCLBOOK
         BRANCH    OPTION,OPTN1000,OPTN1000:     * Validate option
                          OPTN0800
.
.        Invalid selection
.
         BEEP
         GOTO      OPTN0000
.
OPTN0800 MOVE      ONE,OPTION
         KEYIN     *P1:23,*EL,*B,*V2LON:
                   "TOBE Invoiced Section will NOT be Printed!":
                   *P1:24," (Y to Continue) ",ANS;
         REP       "cC",ANS
         CMATCH    "Y",ANS
         GOTO      OPTN0000 IF NOT EQUAL
         MOVE      ONE,NOTBINVC               * no tobe invoiced flag
.
.        Determine which system this report is for
.
OPTN1000 CALL      PATSELFN                      * Select the system
         BRANCH    EXIT,OPTN0000                 * No system selected
.
.        Set up from date for the report
.
         MOVE      CFEEDT,DIM8                   * Default to inpatient
         LOAD      DIM8,FSTSYS,PTCFEEAE,PTCFEEOP,CFEEDT,PTCFEEOF
.
         UNPACK    DIM8 WITH FTCC,FTYY,FTMM,FTDD
         MOVE      FTCC,FCC
         MOVE      FTYY,FYY
         MOVE      FTMM,FMM
         MOVE      FTDD,FDD
         MOVE      FCC,CCENT
         MOVE      FYY,CYEAR
         MOVE      FMM,CMON
         MOVE      FDD,CDAY
         CALL      PACDATE
         MOVE      CPCDATE,FPDATE           * DD/MM/CCYY print date
         REP       " 0" IN FPDATE
.
         MOVE       SYSAL,SYSID
         LOAD       SYSID,FSTSYS,SYSAE,SYSOP,SYSIP,SYSOT
.
.        Get the year of the report
.
         MOVE       DRGYR,NOWYEAR
         DISPLAY    *P1:11,*EF,"Report for Year : ",*V2LON,NOWYEAR
.
         KEYIN      *P19:11,*V2LON,*RV,*JR,*DE,NOWYEAR
.
         UNPACK     NOWYEAR,NOWCC,NOWYY
         MATCH      SP2,NOWCC
         IF         @EQUAL
           MOVE       CCC,NOWCC
         ENDIF
         PACK       NOWYEAR,NOWCC,NOWYY
         REP        " 0",NOWYEAR
         DISPLAY    *P19:11,*V2LON,NOWYEAR
.
.        NOTCYR is a flag to say if we are doing the current financial year.
.        If it a "1" then we don't do the "To Be Invoiced" section of the report
.
         MOVE       ZERO,NOTCYR       * Assume this is current financial year
.
         MATCH      NOWYEAR,DRGYR
         GOTO       OPTN2000 IF EQUAL
.
.        Check with the indicator if we are doing the first of month 
.        invoice to go in previous month
.
         COMPARE    ONE,CINV1ST
         GOTO       OPTN1100 IF NOT EQUAL
.
.        If this is the first day of financial year, then do the "To Be 
.        Invoiced" section of the report
.
         PACK       DIM8,CCC,CYY,CMM,CDD   * Current date
         REP        " 0",DIM8
         MATCH      DIM8,DRGFDTE           * Is today is the first day of
         GOTO       OPTN2000 IF EQUAL      * financial year ?
.
OPTN1100 MOVE       ONE,NOTCYR        * This is not the current financial year
.
.        Pack up the title
.
OPTN2000 PACK       YEARTTL WITH SYSID,OPNBRA,NOWYEAR,CLSBRA
         DISPLAY    *P50:2,*V2LON,"-",YEARTTL,SP1
.
         MOVE       SP10,HOSPID
         IF         IBCNMHOS=1
           CALL       KHOS0000        * Hospital id
           BRANCH     EXIT,OPTN9999
         ENDIF
.
         MOVE       ZERO,EXIT         * Successful option selected
         BRANCH     OPTION,OPTN5000   * Print only option
.
         MOVE       ZERO,TBIFLAG  * default not to transfer'Fees to be invoiced'
         COMPARE    ONE,IBCNMHOS
         GOTO       OPTN2600 IF NOT EQUAL     * not multi hospital
.
         MATCH      SP3,HOSPID 
         GOTO       OPTN2600 IF EQUAL
         PACK       KEY3,HOSPID
         CALL       RDPTHSP1
         BRANCH     OVRCD,OPTN2600
.
         MOVE       ZERO,PTCNUFMS
         MOVE       PTHSUFMS,PTCNUFMS        * parameter for Using IBA FMS
         MOVE       ZERO,CGLIND
         MOVE       PTHSPTIN,CGLIND          * parameter for G/L Interface
         CALL       TFIL0000                 * set Interface files for multihosp
.
OPTN2600 COMPARE    ONE,CGLIND
         GOTO       OPTN5000 IF NOT EQUAL
         PREP       PTINVGL,INVNAME     * open invoiced G/L text file
.
OPTN3000 KEYIN      *P1:15,*EL,"Transfer Fees to be Invoiced to Finance ":
                    "System (Y/N) ? ":
                    *V2LON,ANS;
         REP        "yYnN",ANS
.
         MATCH      ANSN,ANS
         GOTO       OPTN5000 IF EQUAL
         MATCH      ANSY,ANS
         GOTO       OPTN4000 IF EQUAL
         BEEP
         GOTO       OPTN3000
.
OPTN4000 MOVE       ONE,TBIFLAG       * Flag to transfer fees to be invoiced
         PREP       PTTBIGL,TBINAME   * Open to be invoiced G/L file
         GOTO       OPTN5000
.
OPTN5000 CALL       CRTX0000          * Create Export File for Excel
         CALL       SHDE0000          * Show Description on Export File
.
.        Option to include Booked outpatient for Consolidated and Outpatient
.
         BRANCH    FSTSYS,OPTN9999,OPTN5100,OPTN9999,OPTN9999
.
OPTN5100 MATCH     "1",PTCNUABF
         GOTO      OPTN9999 IF NOT EQUAL    * Not using ABF
.
         KEYIN      *P1:19,*EL,"Include Booked Outpatients in the ":
                    " 'To Be Invoiced' Section (Y/N) ? ":
                    *V2LON,ANS;
         REP        "yYnN",ANS
         MATCH      ANSN,ANS
         GOTO       OPTN9999 IF EQUAL
         MATCH      ANSY,ANS
         GOTO       OPTN9999 IF NOT EQUAL
.
         MOVE       ONE,INCLBOOK
         GOTO       OPTN9999
.
.        No option selected. Set flag to indicate this
.
OPTN9000 MOVE       ONE,EXIT          * No option selected
.
OPTN9999 RETURN
+
.        ======================================================================
.        FSUM0000: Financial summary report
.        ======================================================================
FSUM0000 MOVE       ZERO,EXIT
         CALL       RFIN0000           * Run Financial Summary report option
         COMPARE    ONE,FINSUMFL
         GOTO       FSUM9999 IF NOT EQUAL  
.
.        Running Financial summary
.
         CALL       TRTY0000           * Transaction type
         BRANCH     EXIT,FSUM9999
.
         CALL       DRNG0000           * Get date range
.
FSUM9999 RETURN
+
.        ======================================================================
.        TFIL0000: Set transfer file for multi hospital
.        ======================================================================
TFIL0000 MOVE      HOSPID,KEY3
         REP       " 0",KEY3
         PACK      KEY4,CMM,CDD
         REP       " 0",KEY4
         STRIP     HDATARCP
         CLEAR     INVNAME
         APPEND    HDATARCP,INVNAME
         MATCH     SP70,PTCNGLPF
         IF        !@EQUAL
           SQUEEZE   PTCNGLPF
           APPEND    PTCNGLPF,INVNAME
         ENDIF
         APPEND    "f",INVNAME
         APPEND    KEY3,INVNAME
         APPEND    KEY4,INVNAME
         APPEND    ".txt",INVNAME
         APPEND    SP70,INVNAME
         RESET     INVNAME
.
         STRIP     HDATARCP
         CLEAR     TBINAME
         APPEND    HDATARCP,TBINAME
         MATCH     SP70,PTCNGLPF
         IF        !@EQUAL
           SQUEEZE   PTCNGLPF
           APPEND    PTCNGLPF,TBINAME
         ENDIF
         APPEND    "t",TBINAME
         APPEND    KEY3,TBINAME
         APPEND    KEY4,TBINAME
         APPEND    ".txt",TBINAME
         APPEND    SP70,TBINAME
         RESET     TBINAME
.
TFIL9999 RETURN
+
.        ======================================================================
.        KHOS0000: Keyin hospital ID
.        ======================================================================
KHOS0000 DISPLAY    *P1:12,*EL,"Hospital Id : ";
         MOVE       TEN5,ECOL
         MOVE       "12",EVERT
         MOVE       SP3,CKYIDEF3
         MOVE       ZERO,CKYIMAND           * Not Mandatory
         OPEN       PATHSPA1,"pathspaf"
.
         CALL       PATHSPKY
         BRANCH     EXIT,KHOS1000,KHOS2000
         MOVE       PTHSHOSP,HOSPID
         MOVE       PTHSNAME,HOSPNAME
         MOVE       ZERO,EXIT
         GOTO       KHOS9999
.
KHOS1000 MOVE       "All Hospitals",HOSPNAME
         MOVE       SP10,PTHSHOSP
         MOVE       ZERO,EXIT
         GOTO       KHOS9999
.
KHOS2000 MOVE       ONE,EXIT
KHOS9999 RETURN
.
.        ======================================================================
.        OPST0000: Initialise for the report
.        ======================================================================
.
OPST0000 MOVE       ZERO,CPAGENO                 * Init page number
         MOVE       ZERO,BOUTFLAG
         MOVE       "60",CLNO                    * Init line number
         CLOCK      TIME,CTIMEIS                 * Init starting time
         MOVE       ONE,CNOUNDLN
.
         DISPLAY    *P1:15,*EF;
.
.        Delete the work file if it exists
.
         CLOSE      TEMPFILE
         CLEAR      CMDLINE
         APPEND     "iserase ",CMDLINE
         APPEND     FNAMEW,CMDLINE
         RESET      CMDLINE
.
         EXECUTE    CMDLINE,TASKID               * Delete the work file
.
         CLEAR      CMDLINE
         APPEND     "/bin/rm -f ",CMDLINE
         APPEND     FNAMEW,CMDLINE
         APPEND     ".*",CMDLINE
         RESET      CMDLINE
         EXECUTE    CMDLINE,TASKID
.
.        Create the work file
.
         CLEAR      CMDLINE
         APPEND     "isbuild ",CMDLINE
         APPEND     FNAMEW,CMDLINE
         APPEND     " 218 U1-1,2-3,4-16",CMDLINE
         RESET      CMDLINE
.
         EXECUTE    CMDLINE,TASKID               * Create the work file
         OPEN       TEMPFILE,FNAMEW              * Open the work file
.
.        Initialise the current section
.
         MOVE       ONE,CURSECT                  * Start with section one
. 
         MOVE       ZERO,HOSPFLAG                * Print all hospitals data
         IF         IBCNMHOS=1
           MATCH      SP70,HOSPID
           IF         !@EQUAL
             MOVE       ONE,HOSPFLAG             * Print one hospital data only
           ENDIF
         ENDIF
.
.        PTCNSIGL = 0 - using patfmsaf - G/L (Claim breakdown)
.                       with GST (PTCNFGST) and EMR breakdown (PTCNFEMR)
.        PTCNSIGL = 1 - using pmsfmsaf - System based G/L 
.                       (without GST (PTCNFGST) and EMR breakdown (PTCNFEMR))
.        PTCNSIGL = 2 - using pmsfmsaf - System based G/L (Claim breakdown)
.                       with GST (PTCNFGST) and EMR breakdown (PTCNFEMR)
.
         MATCH      "1",PTCNSIGL
         GOTO       OPST9999 IF EQUAL            * Using system based G/L
.
         COMPARE    ONE,CGLIND
         GOTO       OPST9999 IF NOT EQUAL        * Not extracting G/L
.
         MATCH      "1",PTCNFGST
         GOTO       OPST2000 IF NOT EQUAL
.
         CLOSE      TMPFILE1
         CLEAR      CMDLINE
         APPEND     "iserase ",CMDLINE
         APPEND     FNAMET,CMDLINE
         RESET      CMDLINE
         EXECUTE    CMDLINE,TASKID               * Delete the work file
.
         CLEAR      CMDLINE
         APPEND     "isbuild ",CMDLINE
         APPEND     FNAMET,CMDLINE
         APPEND     " 40 U1-3,20-20",CMDLINE
         RESET      CMDLINE
.
         EXECUTE    CMDLINE,TASKID               * Create the work file
         OPEN       TMPFILE1,FNAMET              * Open the work file
.
OPST2000 MATCH      "1",PTCNFEMR
         GOTO       OPST9999 IF NOT EQUAL        * Not grouping EMR items
.
         CLOSE      TMPFILE2
         CLEAR      CMDLINE
         APPEND     "iserase ",CMDLINE
         APPEND     FNAMEM,CMDLINE
         RESET      CMDLINE
         EXECUTE    CMDLINE,TASKID               * Delete the work file
.
         CLEAR      CMDLINE
         APPEND     "isbuild ",CMDLINE
         APPEND     FNAMEM,CMDLINE
         APPEND     " 61 U1-1,2-4,47-47,5-17",CMDLINE
         RESET      CMDLINE
.
         EXECUTE    CMDLINE,TASKID               * Create the work file
         OPEN       TMPFILE2,FNAMEM              * Open the work file
.
OPST9999 RETURN
.
.        ======================================================================
.        GSTS0000: Get the first site record
.        ======================================================================
.
GSTS0000 BRANCH     SYSTEM,GSTS8000,GSTS0100,GSTS8000,GSTS8000
.
.        When appropriate, get the first outpatient site
.
GSTS0100 MOVE       FSTSITE,KEY6                 * Current site
         CALL       RDSITA1                      * Get the site record
         BRANCH     OVRCD,GSTS1000               * Not an exact key
.
         GOTO       GSTS2000                     * Validate the department
.
.        Do a positional read to find the first site record
.
GSTS1000 CALL       RDKSITA1                     * Read next site record
         BRANCH     OVRCD,GSTS9000               * Nothing found.
.
.        Validate the department
.
GSTS2000 MATCH      FSTDEPT,OSTSYST              * Check against starting dept.
         GOTO       GSTS1000 IF LESS             * Invalid. Get next record
.
         MATCH      OSTSYST,FEDDEPT              * Check against ending dept.
         GOTO       GSTS1000 IF LESS             * Invalid. Get next record
.
         MOVE       ZERO,EXIT                    * Valid site found
         GOTO       GSTS9999
.
.        Not an outpatients system
.
GSTS8000 MOVE       ZERO,EXIT                    * Successful location of site
         MOVE       SP6,OSTSITE                  * The site for non-outpatients
.
         MOVE       TILDA20,KEY6                 * Position ourselves
         CALL       RDSSITA1                     * for non-outpatient systems
         GOTO       GSTS9999
.
.        No valid record found
.
GSTS9000 MOVE       ONE,EXIT                     * No valid site found
.
GSTS9999 RETURN
.
.        ======================================================================
.        GENF0000: Generate the fee's invoiced section of the report
.        ======================================================================
.
GENF0000 MOVE       ZERO,GSTFLAG                  * Initialise GST flag
.
GENF0020 MOVE       ONE,FIRSTFLG
         MOVE       FSTSYS,SYSTEM                * Current system
         CALL       VSYS0000                     * Get the starting site
         BRANCH     EXIT,GENF8000                * No valid sites
         MOVE       ZERO,FIRSTFLG
.
         DISPLAY    *P1:24,*EL,*P10:24,"Financial Type :";
.
.        Position ourselves at the appropriate position in the file
.        and then loop until we have finished
.
GENF0100 PACK       KEY28,SYSTEM,OSTSITE,NOWYEAR,SP30
         IF         HOSPFLAG=1
           PACK       KEY28,HOSPID,SYSTEM,OSTSITE,NOWYEAR,SP30
         ENDIF
.
         CALL       RSFINN
GENF1000 CALL       RKFINN
         BRANCH     OVRCD,GENF8000               * No more data in file
         COMPARE    ZERO,FINSYS
         GOTO       GENF1000 IF EQUAL
.
         DISPLAY    *P30:24,*V2LON,FINSYS,SP1,FINTYPE,SP1,FINCODE;
.
         IF         HOSPFLAG=1
           MATCH       SP10,HOSPID
           IF          !@EQUAL
             MATCH       FINHOSP,HOSPID
             GOTO        GENF8000 IF NOT EQUAL
           ENDIF
         ENDIF
.
         CALL       VSYS0000                     * Validate system
         BRANCH     EXIT,GENF8000,GENF0100       * 1=no more site, 2=next site
.
.        If we are separating GST from the report, reduce the amounts by the
.        appropriate amounts, and update the GST field in the miscellaneous
.        charges section of the report.
.
         IF         PTCNGSTF = 1
           CMATCH     ANSA,FINTYPE               * only if Fees Invoiced sect.
           CALL       ADDG0000 IF EQUAL          * add GST to work file
.
           CMATCH     ANSC,FINTYPE               * check if journals section
           GOTO       GENF2000 IF NOT EQUAL      * no, finished GST changes
.
           MATCH      DISCJRNL,FINCODE           * receipting discount journal?
           CALL       ADDG0000 IF EQUAL          * add GST to work file
         ENDIF
.
.        Add the data to the work file
.
GENF2000 CALL       PWRK0000                * Processing work file
         GOTO       GENF1000
.
GENF8000 COMPARE    TWO,CURSECT             * printing "to be invoiced"
         GOTO       GENF9999 IF EQUAL       * no GST for to be invoiced
.
         IF         GSTFLAG=0
           MOVE       "1",SAVESECT          * Invoiced items
           CALL       ITGL0000              * G/L interface for group of Items
         ENDIF
.
         COMPARE    THREE,IBCNUGST
         GOTO       GENF8200 IF EQUAL
         COMPARE    TWO,IBCNUGST
         GOTO       GENF9999 IF NOT EQUAL
.
         IF         GSTFLAG=1
           CALL       GGST0000              * G/L extract for Total of GST amt
           GOTO       GENF9999
         ENDIF
.
GENF8200 BRANCH     GSTFLAG,GENF9999        * GST has been processed
.
.        Print GST amount
.
         MOVE       ONE,GSTFLAG
         GOTO       GENF0020                * setup GST amount
.
GENF9999 RETURN
+
.        ======================================================================
.        Validate the system
.        ======================================================================
VSYS0000 MOVE       ZERO,EXIT
         BRANCH     FIRSTFLG,VSYS1300            * First flag
         MOVE       ZERO,CMXMSC                  * Initialise casemix misc.
.
         COMPARE    FINSYS,SYSTEM                * Change of system ?
         GOTO       VSYS1200 IF NOT EQUAL        * Get the next system
.
.        Validate the site
.
         MATCH      FINSITE,OSTSITE              * Change of site ?
         GOTO       VSYS1400 IF EQUAL            * No.
.
.        Get next outpatient site and try again
.
VSYS1100 CALL       RDKSITA1                     * Get the next site record
         BRANCH     OVRCD,VSYS1200               * No record. Get next system
.
         MATCH      FINSITE,FEDSITE              * Check ending site
         GOTO       VSYS1200 IF LESS             * Get next system
.
.        Validate the department
.
         MATCH      FSTDEPT,OSTSYST              * Check against starting dept
         GOTO       VSYS1100 IF LESS             * Invalid. Get next site
.
         MATCH      OSTSYST,FEDDEPT              * Check against ending dept
         GOTO       VSYS1100 IF LESS             * Invalid. Get next site
.
.        Reposition for this new site
.
         MOVE       TWO,EXIT
         GOTO       VSYS9999
.
.        Get the next system
.
VSYS1200 COMPARE    NINE,SYSTEM                  * Have we finished ?
         GOTO       VSYS9000 IF EQUAL            * Yes.
.
         ADD        ONE,SYSTEM                   * Get the next system number
.
.        Check if still in the valid range
.
         COMPARE    SYSTEM,FEDSYS                * Check against ending system
         GOTO       VSYS9000 IF LESS             * Outside range. Finished
.
VSYS1300 CALL       GSTS0000                     * Get the starting site
         BRANCH     EXIT,VSYS1200                * No valid sites, try next sys
.
         MOVE       TWO,EXIT
         GOTO       VSYS9999
.
.        Check that we still have the correct financial year
.
VSYS1400 MATCH      FINYEAR,NOWYEAR              * Still current year ?
         GOTO       VSYS1100 IF NOT EQUAL        * No. Get next site
         GOTO       VSYS9999
.
VSYS9000 MOVE       ONE,EXIT
VSYS9999 RETURN
+
.        ======================================================================
.        PWRK0000:  Processing work file
.        ======================================================================
PWRK0000 CALL       WKEY0000                     * Get the key for work file
         BRANCH     ERRORFLG,PWRK9999
.
         CALL       ADDW0000
.
         MOVE       SP70,SAVSCODE
         UNPACK     SUBCODE,DIM3,DIM1,KEY9
         MATCH      "yyyyyyyyy",KEY9
         IF         @EQUAL
           MOVE       SUBCODE,SAVSCODE      * save subcode for System breakdown
         ENDIF
.
         MOVE       TILDA20,SUBCODE              * Add the totals key to work
         CALL       ADDW0000
.
.        We have finished processing this record. Check if a reset needs
.        to be done
.
         BRANCH     OPTION,PWRK9999
.
.        Check if the parameter is set to do the interface 
.
         IF         CGLIND = 1
.
.        invoiced section - then do the interface for the invoiced.
.
           IF         CURSECT = 1
             CALL       TRGL0000                    * G/L Interface
.
.        to be invoiced section - check if the user requested to do the 
.        interface for the to be invoiced.
.
           ELSE
             IF         TBIFLAG = 1
               CALL       TRGL0000                  * G/L Interface
             ENDIF
           ENDIF
          ENDIF
.
.        If doing a reset, zero period value
.
         PACK       KEY28,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,FINHOSP,SP70
         IF         HOSPFLAG=1
           PACK       KEY28,FINHOSP,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,SP70
         ENDIF
.
         BRANCH     GSTFLAG,PWRK9000
         IF         HOSPFLAG=1
           CALL       RDFINS2
           BRANCH     OVRCD,PWRK9999
           MOVE       ZERO,FINPER
           CALL       UPFINS2
         ELSE
           CALL       RDFINS1
           BRANCH     OVRCD,PWRK9999
           MOVE       ZERO,FINPER
           CALL       UPFINS1
         ENDIF
.
         GOTO       PWRK9999
.
PWRK9000 IF         HOSPFLAG=1
           CALL       RDPTFIA2
           BRANCH     OVRCD,PWRK9999
           MOVE       ZERO,FINPER
           CALL       UPPTFIA2
         ELSE
           CALL       RDPTFIA1
           BRANCH     OVRCD,PWRK9999
           MOVE       ZERO,FINPER
           CALL       UPPTFIA1
         ENDIF
.
PWRK9999 RETURN
+
.        ======================================================================
.        GENT0000: Generate the to be invoiced section of the report
.        ======================================================================
.
GENT0000 BRANCH    NOTCYR,GENT9999               * Not cur yr -> no to be inv.
.
         CLOSE     PATFINS1                      * Close the file
         CLOSE     PATFINS2                      * Close the file
         MOVE      TWO,CURSECT                   * To-be-invoiced section
.
.        Create a temporary index file with the same format as PATFINS
.
         CALL      INDZ0000                      * Create a temp index file
.
.        Calculate the To-Be-Invoiced data, and put into tempfile
.
         IF        PTCNPFID = 1
           PRINT     *1,"Admission No",*20,"Invoice Amount",*40,"Total"
         ENDIF
         CALL      CTBI0000                      * Calculate to be invoiced
.
         IF        INCLBOOK=1
           MOVE      FOUR,PROGFLAG
           CALL      BOUT0000                    * 'Booked' outpatients
           MOVE      ZERO,BOUTFLAG
         ENDIF
.
         IF        PTCNPFID = 1
           PRINT     *N,*N,*N,*1,"Admission No",*20,"Cash Amount",*40,"Total"
         ENDIF
.
         CALL      GETC0000                      * cash still to be invoiced
.
         IF        PTCNPFID = 1
           CALL      HEAD0000
           MOVE      ZERO,CPAGENO                 * Init page number
         ENDIF
.
         CALL      GENF0000                      * Process temp file
         MOVE      "2",SAVESECT                  * to be invoiced Items
         CALL      ITGL0000                 * G/L interface for group of Items
.
.        Check if we need to do 'Booked' Outpatients
.
         MATCH     "1",PTCNUABF
         GOTO      GENT6000 IF NOT EQUAL
.
         BRANCH    FSTSYS,GENT6000,GENT2000
         GOTO      GENT6000
.
GENT2000 MOVE      "6",FSTSYS                 * ABF Booked Outpatients
         MOVE      "6",FEDSYS
         CALL      GENF0000                   * Process temp file
.
.        Get rid of the temporary file
.
GENT6000
         CLOSE     PATFINS1                      * Close temporary file
         CLOSE     PATFINS2                      * Close temporary file
.         CALL      KILL0000                      * Delete temporary index file
         OPEN      PATFINS1,"patfinsf"           * Re-open PATFINS file
         OPEN      PATFINS2,"patfinsf"           * Re-open PATFINS file
.
GENT9999 RETURN
+
.        ======================================================================
.        G/L interface for all Items (including EMR) breakdown
.        ======================================================================
ITGL0000 MATCH      "1",PTCNSIGL
         GOTO       ITGL9999 IF EQUAL       * using system based G/L
         COMPARE    ONE,CGLIND
         GOTO       ITGL9999 IF NOT EQUAL   * no G/L extract
         MATCH      "1",PTCNFEMR
         GOTO       ITGL9999 IF NOT EQUAL   * Not grouping EMR items
.
         PACK       KEY18,SAVESECT,SP70
         CALL       RSTMPA2                 * Positional read of work
ITGL1000 CALL       RKTMPA2                 * Read the next record
         BRANCH     OVRCD,ITGL9999          * Finished work file
.
         MATCH      SAVESECT,XCURSECT
         GOTO       ITGL9999 IF NOT EQUAL   * different section
.
         CALL       WMIT0000                * Write to G/L file
         GOTO       ITGL1000
.
ITGL9999 RETURN
+
.        ======================================================================
.        Write total items amount to Financial Extract file
.        ======================================================================
WMIT0000 MOVE      "3",PTFMSUB              * for Misc.Item
.
.        check if record exists in the interface file
.
         UNPACK    XFINCODE,KEY1,KEY12
         REP       "PTQM",KEY1
         PACK      SAVFCODE,KEY1,KEY12
.
         MOVE      PTFMSUB,SAVFMSUB
         PACK      KEY17,SAVFMHOS,SAVFMSUB,SAVFCODE,SP70
         PACK      KEY18,SAVFMHOS,SAVFMSYS,SAVFMSUB,SAVFCODE,SP70
         CALL      RDSYFMS
         COMPARE   ZERO,OVRCD
         GOTO      WMIT5000 IF EQUAL
.
.        Miscellaneous items
.
         CMATCH    "T",KEY1                  * check for misc.casemix
         GOTO      WMIT2000 IF NOT EQUAL
.
.        Casemix
.
         UNPACK    SAVFCODE,ANS,DIM1,DIM3,DIM9 * ANST,Episode type,Misc.grp/code
         PACK      KEY17,SAVFMHOS,SAVFMSUB,ANS,DIM1,DIM3,SP10
         PACK      KEY18,SAVFMHOS,SAVFMSYS,SAVFMSUB,ANS,DIM1,DIM3,SP10
         CALL      RDSYFMS
         BRANCH    OVRCD,WMIT1000
         GOTO      WMIT5000
.
WMIT1000 PACK      KEY17,SAVFMHOS,SAVFMSUB,ANS,DIM1,SP3,DIM9
         PACK      KEY18,SAVFMHOS,SAVFMSYS,SAVFMSUB,ANS,DIM1,SP3,DIM9
         CALL      RDSYFMS
         BRANCH    OVRCD,WMIT4000
         GOTO      WMIT5000
.
.        Not Casemix
.
WMIT2000 UNPACK    SAVFCODE,ANS,DIM3,DIM9
         PACK      KEY17,SAVFMHOS,SAVFMSUB,ANS,DIM3,SP10
         PACK      KEY18,SAVFMHOS,SAVFMSYS,SAVFMSUB,ANS,DIM3,SP10
         CALL      RDSYFMS
         BRANCH    OVRCD,WMIT3000
         GOTO      WMIT5000
.
WMIT3000 PACK      KEY17,SAVFMHOS,SAVFMSUB,ANS,SP3,DIM9,SP10
         PACK      KEY18,SAVFMHOS,SAVFMSYS,SAVFMSUB,ANS,SP3,DIM9,SP10
         CALL      RDSYFMS
         BRANCH    OVRCD,WMIT4000
         GOTO      WMIT5000
.
WMIT4000  PACK      KEY17,SAVFMHOS,SAVFMSUB,SP20    * use default
          PACK      KEY18,SAVFMHOS,SAVFMSYS,SAVFMSUB,SP20    * use default
          CALL      RDSYFMS
          BRANCH    OVRCD,WMIT9999
.
.         Write to G/L financial extract
.
WMIT5000  MOVE      "Fees Invoiced G/L Transfer    ",IBGIDESC    * Default
          MOVE      "A",FINTYPE
          MOVE      XFINCODE,FINCODE
          CALL      ACDS0000                      * Get G/L transfer description
          MOVE      CURRDATE,IBGIDATE             * Date
          MOVE      SP20,IBGIREF                  * Reference
          MOVE      SP20,IBGICRAC                 * Credit account - cash
          MOVE      SP1,IBGISIGN                  * Sign
.
          MOVE      XTTAMITM,IBGIVALU             * Amount
          IF        XTTCRITM<>0
            MOVE      XTTCRITM,IBGIVALU
            MULT      "-1",IBGIVALU               * credit notes
          ENDIF
.
          MATCH     "1",XCURSECT                  * invoiced
          IF        @EQUAL
.
.         invoiced section
.
           MOVE      PTFMIDI,IBGIDISS              * Dissection
           MOVE      PTFMIRE,IBGIRESP              * Responsibility
           MOVE      PTFMILD,IBGILEDG              * Ledger
.
           MOVE      PTFMIDA,IBGIACCT            * Debit Account
           MOVE      PTFMICA,IBGICRAA            * Income Acc - Credit Acc.
           MOVE      PTFMBASC,IBGIBASC
           CALL      WRPTFMI                       * write to invoiced file
.
        ELSE
.
.        to be invoiced section
.
           MOVE      PTFMTDI,IBGIDISS              * Dissection
           MOVE      PTFMTRE,IBGIRESP              * Responsibility
           MOVE      PTFMTLD,IBGILEDG              * Ledger
.
           MOVE      PTFMTDA,IBGIACCT            * Debit Account
           MOVE      PTFMTCA,IBGICRAA            * Income Acc - Credit Acc.
           MOVE      SP3,IBGIBASC
           CALL      WRPTFMT                      * write to to be invoiced file
.
         ENDIF
.
WMIT9999 RETURN
+
.        ======================================================================
.        Transfer total GST amount to financial system
.        ======================================================================
GGST0000 MATCH     "1",PTCNSIGL
         GOTO      GGST9999 IF EQUAL    * system based G/L with No GST breakdown
.
         COMPARE   ONE,CGLIND
         GOTO      GGST9999 IF NOT EQUAL
.
         MATCH     "1",PTCNFGST
         GOTO      GGST9999 IF NOT EQUAL   * GST
.
         MOVE      SP70,KEY4
         BRANCH    IBCNMHOS,GGST0200       * multi hospital group GST by Hosp.id
.
         CALL      RDTMPA1
         BRANCH    OVRCD,GGST0200
         GOTO      GGST2000
.
GGST0200 CALL      RSTMPA1
GGST1000 CALL      RKTMPA1
         BRANCH    OVRCD,GGST9999
.
GGST2000 MOVE      ZERO,F1
         COMPARE   ZERO,XTTAMGST
         GOTO      GGST6000 IF NOT EQUAL
.
GGST3000 MOVE      TWO,F1                        * Credit note GST
         COMPARE   ZERO,XTTCRGST
         GOTO      GGST1000 IF EQUAL
.
         MOVE      "CREDIT NOTE GST                ",IBGIDESC
         MOVE      XTTCRGST,FINPER
         MULT      "-1",FINPER                   * credit notes
         GOTO      GGST8000
.
GGST6000 MOVE      ONE,F1                        * GST
         MOVE      "GST                            ",IBGIDESC
         MOVE      XTTAMGST,FINPER               * Amount
.
GGST8000 CALL      WGST0000                      * Write GST amount to Extract
         BRANCH    F1,GGST3000
.
         GOTO      GGST1000
.
GGST9999 RETURN
+
.        ======================================================================
.        Write GST amount to Financial Extract file
.        ======================================================================
WGST0000 MOVE      "1",PTFMSUB
         UNPACK    SP70,PTFMCOD,PTFMHOSP,PTFMSYST
         MOVE      XHOSPID,PTFMHOSP
         MOVE      XFSYST,PTFMSYST
.
         MOVE      "3",PTFMSUB
         PACK      KEY17,PTFMHOSP,PTFMSUB,PTFMCOD,SP70
         PACK      KEY18,PTFMHOSP,PTFMSYST,PTFMSUB,PTFMCOD,SP70
         CALL      RDSYFMS
         BRANCH    OVRCD,WGST9999
.
         MOVE      CURRDATE,IBGIDATE             * Date
         MOVE      SP20,IBGIREF                  * Reference
         MOVE      SP20,IBGICRAC                 * Credit account - cash
         MOVE      SP1,IBGISIGN                  * Sign
         MOVE      FINPER,IBGIVALU               * Amount
         MOVE      PTFMIDI,IBGIDISS              * Dissection
         MOVE      PTFMIRE,IBGIRESP              * Responsibility
         MOVE      PTFMILD,IBGILEDG              * Ledger
.
         MOVE      PTFMIDA,IBGIACCT              * Debit Account
         MOVE      PTFMICA,IBGICRAA              * Income Acc - Credit Acc.
.
         MOVE      PTFMIGS,IBGICRAA              * GST Control - Credit Acc
         MOVE      PTFMBASC,IBGIBASC
         CALL      WRPTFMI                       * write to invoiced file
.
WGST9999  RETURN
+
.        ======================================================================
.        TRGL0000: Transfer fees to financial system
.        ======================================================================
.
TRGL0000 COMPARE   ZERO,FINPER
         GOTO      TRGL9999 IF EQUAL
.
         MOVE      ZERO,CREDFLAG
         MOVE      FINHOSP,PTFMHOSP
         MOVE      FINCODE,SAVFCODE
         MOVE      FINSYS,PTFMSYST
.
.        Check for fees generated
.
         CMATCH    "A",FINTYPE
         GOTO      TRGL3000 IF NOT EQUAL
.
         CMATCH    "A",FINCODE
         GOTO      TRGL1000 IF EQUAL
         CMATCH    "N",FINCODE             * credit note
         GOTO      TRGL0900 IF EQUAL
.
         CMATCH    "C",FINCODE             * Lumpsum (casemix)
         GOTO      TRGL1000 IF EQUAL
         CMATCH    "H",FINCODE             * Lumpsum (casemix) credit note
         GOTO      TRGL0900 IF EQUAL
.
         CMATCH    "D",FINCODE             * Daily charge (casemix)
         GOTO      TRGL1000 IF EQUAL
         CMATCH    "J",FINCODE             * Daily charge (casemix) credit note
         GOTO      TRGL2000 IF NOT EQUAL
.
TRGL0900 MOVE      ONE,CREDFLAG            * set flag for credit note
         UNPACK    SP70,KEY1,KEY12
         UNPACK    SAVFCODE,KEY1,KEY12
         REP       "NAHCJD",KEY1
         PACK      SAVFCODE,KEY1,KEY12
.
TRGL1000 MOVE      "1",PTFMSUB             * Accommodations
         GOTO      TRGL4000
.
.        Check for miscellaneous
.
TRGL2000 CMATCH    "T",FINCODE             * Misc.items (casemix)
         GOTO      TRGL2200 IF EQUAL
.
         CMATCH    "M",FINCODE
         GOTO      TRGL2200 IF EQUAL
         CMATCH    "Q",FINCODE             * Misc. credit note
         GOTO      TRGL2100 IF EQUAL
         CMATCH    "P",FINCODE             * Misc.(casemix) credit note
         GOTO      TRGL9999 IF NOT EQUAL
.
TRGL2100 MOVE      ONE,CREDFLAG            * set flag for credit note
         UNPACK    SP70,KEY1,KEY12
         UNPACK    SAVFCODE,KEY1,KEY12
         REP       "PTQM",KEY1
         PACK      SAVFCODE,KEY1,KEY12
.
TRGL2200 MOVE      "3",PTFMSUB             * Miscellaneous
         BRANCH    GSTFLAG,TRGL4000        * GST
.
.        Check if we are grouping all Items including Emergency by Item Group
.
         MATCH     "1",PTCNSIGL
         GOTO      TRGL4000 IF EQUAL       * using system based G/L
         MATCH     "1",PTCNFEMR
         GOTO      TRGL4000 IF NOT EQUAL
.
         CALL      SVITM000                * Save Item amount
         GOTO      TRGL9999
.
.        Check for journals
.
TRGL3000 CMATCH    "C",FINTYPE
         GOTO      TRGL9999 IF NOT EQUAL
         MOVE      "5",PTFMSUB               * Journals
         GOTO      TRGL4010
.
TRGL4000 COMPARE   ONE,GSTFLAG
         GOTO      TRGL4010 IF NOT EQUAL     * Not GST Amount
         MATCH     "1",PTCNSIGL
         GOTO      TRGL4010 IF EQUAL         * system based
         MATCH     "1",PTCNFGST
         GOTO      TRGL4010 IF NOT EQUAL     * breakdown of GST amount
.
         MOVE      FINPER,IBGIVALU           * Amount
         CALL      SVGST000                  * Save GST amount by hospital id
         GOTO      TRGL9999
.
.        check if record exists in the interface file
.
TRGL4010 MOVE      PTFMSUB,SAVFMSUB
         MOVE      PTFMHOSP,SAVFMHOS
         MOVE      PTFMSYST,SAVFMSYS
         PACK      KEY17,PTFMHOSP,PTFMSUB,SAVFCODE,SP70
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,SAVFCODE,SP70
         CALL      RDSYFMS
         COMPARE   ZERO,OVRCD
         GOTO      TRGL5000 IF EQUAL
.
         UNPACK    SAVFCODE,ANS,DIM3,DIM3A,DIM3B
         MOVE      PTFMSUB,FORM1
         BRANCH    FORM1,TRGL4040,TRGL9999,TRGL4020
.
         IF        CACCFEE=4 & FORM1=5
           UNPACK    SP70,DIM3,DIM3A
           UNPACK    SAVFCODE,DIM3,DIM3A
           PACK      KEY17,PTFMHOSP,PTFMSUB,SP3,DIM3A,SP70
           PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,SP3,DIM3A,SP70
           CALL      RDSYFMS
           COMPARE   ZERO,OVRCD
           GOTO      TRGL5000 IF EQUAL
         ENDIF
         GOTO      TRGL4800
.
.        Miscellaneous items
.
TRGL4020 CMATCH    "T",ANS                  * Check for misc.casemix
         GOTO      TRGL4022 IF NOT EQUAL
.
.        Casemix Misc. item
.
         UNPACK    SAVFCODE,ANS,DIM1,DIM3,DIM9 * ANST,Episode type,Misc.grp/code
         PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM1,DIM3,SP10
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM1,DIM3,SP10
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4021
         GOTO      TRGL5000
.
TRGL4021 PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM1,SP3,DIM9
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM1,SP3,DIM9
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4800
         GOTO      TRGL5000
.
.        Per diem Misc.item
.
TRGL4022 UNPACK    SAVFCODE,ANS,DIM3,DIM9
         PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM3,SP10
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM3,SP10
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4032
         GOTO      TRGL5000
.
TRGL4032 PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,SP3,DIM9,SP10
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,SP3,DIM9,SP10
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4800
         GOTO      TRGL5000
.
.        Accommodations
.
TRGL4040 CMATCH    "C",ANS                      * Check for lumpsum casemix
         GOTO      TRGL4050 IF NOT EQUAL
.
.        Casemix Lumpsum
.
         UNPACK    SAVFCODE,ANS,DIM1,DIM3,DIM3A *"C",Episode type,Adm.type,claim
.
.        for CACCFEE=4, check All Adm.type for the claim code
.
         IF        CACCFEE=4
           PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM1,SP3,DIM3A,SP20
           PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM1,SP3,DIM3A,SP20
           CALL      RDSYFMS
           BRANCH    OVRCD,TRGL4042
           GOTO      TRGL5000
         ENDIF
.
.        check All claim code for the adm.type
.
TRGL4042 PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM1,DIM3,SP20
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM1,DIM3,SP20
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4043
         GOTO      TRGL5000
.
TRGL4043 PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM1,SP20
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM1,SP20
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4800                * no record
         GOTO      TRGL5000
.
TRGL4050 CMATCH    "D",ANS                      * Check for daily chge (casemix)
         GOTO      TRGL4090 IF NOT EQUAL
.
.        Casemix Daily charge 
.
         UNPACK    SAVFCODE,ANS,DIM3,DIM3A        * "D",ward,claim code
.
.        CACCFEE=4, Check All Ward for the claim code
.
         IF        CACCFEE=4
           PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,SP3,DIM3A,SP20
           PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,SP3,DIM3A,SP20
           CALL      RDSYFMS
           BRANCH    OVRCD,TRGL4051
           GOTO      TRGL5000
         ENDIF
.
.        Check All Claim code for the Ward
.
TRGL4051 UNPACK    SAVFCODE,ANS,DIM3             * "D",ward
         PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM3,SP20
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM3,SP20
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4800                * no record
         GOTO      TRGL5000
.
TRGL4090 BRANCH    CACCFEE,TRGL4100:            * Ward/Claim code ?
                           TRGL4100:            * Ward/Adm. type
                           TRGL4500:            * Ward/Claim/Adm.type ?
                           TRGL4500:            * Ward/Adm.type/Claim ?
                           TRGL4800             * Claim type
.
.        Accommodation by admission type
.
         GOTO      TRGL4800
.
.        Accommodation by ward/claim or by Ward/admission type
.
TRGL4100 PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,DIM3,SP10       * use default
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,DIM3,SP10 * use default
         CALL      RDSYFMS
         COMPARE   ZERO,OVRCD
         GOTO      TRGL5000 IF EQUAL
.
         PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,SP3,DIM3A,SP10  * use default
         PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,ANS,SP3,DIM3A,SP10
         CALL      RDSYFMS
         BRANCH    OVRCD,TRGL4800                * no record
.
.        By ward/claim/admission type or ward/adm/claim type
.
TRGL4500  PACK      KEY17,PTFMHOSP,PTFMSUB,SP20            * use default
          PACK      KEY18,PTFMHOSP,SAVFMSYS,PTFMSUB,SP20   * use default
          CALL      RDSYFMS
.         BRANCH    OVRCD,TRGL9999
TRGL4550  CALL      RKSYFMS
          BRANCH    OVRCD,TRGL4800
          MATCH     PTFMHOSP,SAVFMHOS
          GOTO      TRGL4800 IF NOT EQUAL
          MATCH     "0",PTCNSIGL
          IF        !@EQUAL
            MATCH     PMFMSYST,SAVFMSYS
            GOTO      TRGL4800 IF NOT EQUAL
          ENDIF
          MATCH     PTFMSUB,SAVFMSUB
          GOTO      TRGL4800 IF NOT EQUAL
          UNPACK    PTFMCOD,ANS,DIM3AA,DIM3BB,DIM3CC 
          MATCH     SP3,DIM3AA
          GOTO      TRGL4551 IF EQUAL
          MATCH     DIM3,DIM3AA
          GOTO      TRGL4550 IF NOT EQUAL
TRGL4551  MATCH     SP3,DIM3BB
          GOTO      TRGL4552 IF EQUAL
          MATCH     DIM3A,DIM3BB
          GOTO      TRGL4550 IF NOT EQUAL
TRGL4552  MATCH     SP3,DIM3CC
          GOTO      TRGL5000 IF EQUAL
          MATCH     DIM3B,DIM3CC
          GOTO      TRGL4550 IF NOT EQUAL
          GOTO      TRGL5000
TRGL4800  PACK      KEY17,SAVFMHOS,SAVFMSUB,SP20    * use default
          PACK      KEY18,SAVFMHOS,SAVFMSYS,SAVFMSUB,SP20 
          CALL      RDSYFMS
          BRANCH    OVRCD,TRGL9999
.
.         Check of Accommodation
.
TRGL5000  MOVE      "Fees Invoiced G/L Transfer    ",IBGIDESC    * Default
          CALL      ACDS0000                      * Get G/L transfer description
          MOVE      CURRDATE,IBGIDATE             * Date
          IF        EXPORTDE=0
            MOVE      SP20,IBGIREF                  * Reference
          ENDIF
          MOVE      SP20,IBGICRAC                 * Credit account - cash
          MOVE      SP1,IBGISIGN                  * Sign
          MOVE      FINPER,IBGIVALU               * Amount
.
          IF        CURSECT = 1
.
.         invoiced section
.
           MOVE      PTFMIDI,IBGIDISS              * Dissection
           MOVE      PTFMIRE,IBGIRESP              * Responsibility
           MOVE      PTFMILD,IBGILEDG              * Ledger
.
           MATCH     "5",PTFMSUB                   * Check for journal
           IF        @EQUAL
             MOVE      PTFMICA,IBGIACCT            * Debit account
             MOVE      PTFMIDA,IBGICRAA            * Credit account
           ELSE
             MOVE      PTFMIDA,IBGIACCT            * Debit Account
             MOVE      PTFMICA,IBGICRAA            * Income Acc - Credit Acc.
             IF        CREDFLAG=1
               MULT      "-1",IBGIVALU
             ENDIF
           ENDIF
.
           IF        GSTFLAG=1
             MATCH     "5",PTFMSUB                 * Check for journal
             IF        !@EQUAL
               MOVE      PTFMIGS,IBGICRAA          * GST Control - Credit Acc
             ENDIF
           ENDIF
.
           MOVE      PTFMBASC,IBGIBASC
           CALL      WRPTFMI                       * write to invoiced file
.
        ELSE
.
.        to be invoiced section
.
           MOVE      PTFMTDI,IBGIDISS              * Dissection
           MOVE      PTFMTRE,IBGIRESP              * Responsibility
           MOVE      PTFMTLD,IBGILEDG              * Ledger
.
           MATCH     "5",PTFMSUB                   * Check for journal
           IF        @EQUAL
             MULT      "-1",IBGIVALU               * Amount
             MOVE      PTFMTCA,IBGIACCT            * Debit account
             MOVE      PTFMTDA,IBGICRAA            * Credit account
           ELSE
             MOVE      PTFMTDA,IBGIACCT            * Debit Account
             MOVE      PTFMTCA,IBGICRAA            * Income Acc - Credit Acc.
             IF        CREDFLAG=1
               MULT      "-1",IBGIVALU
             ENDIF
           ENDIF
.
           MOVE      SP3,IBGIBASC
           CALL      WRPTFMT                      * write to to be invoiced file
.
         ENDIF
.
TRGL9999 RETURN
+
.        ======================================================================
.        Save total Misc.amount by item group
.        ======================================================================
SVITM000 MOVE      CURSECT,XCURSECT
         MOVE      FINCODE,XFINCODE
         MOVE      FINCODE,SAVFCODE
         MOVE      PTFMHOSP,SAVFMHOS
         MOVE      PTFMSYST,SAVFMSYS
.
.        PTCNMFEE = 1                             * by claim/misc.group
.
         IF        PTCNMFEE=1
           UNPACK    SAVFCODE,KEY1,DIM3,KEY3        * by claim/misc.group
           PACK      KEY13,KEY1,DIM3,KEY3,SP70
           IF        CMXMSC=1
             UNPACK    SAVFCODE,KEY1,DIM1,DIM3,KEY3 * Claim, Group code
             PACK      KEY13,KEY1,DIM1,DIM3,KEY3,SP70
           ENDIF
         ELSE
           UNPACK    SAVFCODE,KEY1,KEY3            * by misc.group/item code
           PACK      KEY13,KEY1,KEY3,SP70
           IF        CMXMSC=1
             UNPACK    SAVFCODE,KEY1,DIM1,KEY3     * C/P by misc.group/item code
             PACK      KEY13,KEY1,DIM1,KEY3,SP70
           ENDIF
         ENDIF
.
         PACK      SAVFCODE,KEY13,SP70
         PACK      KEY18,XCURSECT,SAVFMHOS,SAVFMSYS,SAVFCODE,SP70
         CALL      RDTMPA2
         IF        OVRCD=0
           IF        CREDFLAG=1
             ADD      FINPER,XTTCRITM    * add to Item Total
           ELSE
             ADD      FINPER,XTTAMITM    * add to Item Total
           ENDIF
           CALL      UPTMPA2
         ELSE
           UNPACK    KEY18,XCURSECT,SAVFMHOS,SAVFMSYS,SAVFCODE
           IF        CREDFLAG=1
             MOVE      FINPER,XTTCRITM    * add to Item Total
             MOVE      ZERO,XTTAMITM
           ELSE
             MOVE      ZERO,XTTCRITM
             MOVE      FINPER,XTTAMITM    * add to Item Total
           ENDIF
           CALL        WRTMPA2
         ENDIF
SVITM999 RETURN
+
.        ======================================================================
.        Save total GST amount for each hospital
.        ======================================================================
SVGST000 PACK      KEY4,PTFMHOSP,PTFMSYST,SP70
         CALL      RDTMPA1
         IF        OVRCD=0
           IF        CREDFLAG=1
              ADD      IBGIVALU,XTTCRGST    * add to GST Total
            ELSE
              ADD      IBGIVALU,XTTAMGST    * add to GST Total
            ENDIF
            CALL      UPTMPA1
          ELSE
            UNPACK    KEY4,XHOSPID,XFSYST
            IF        CREDFLAG=1
              MOVE      IBGIVALU,XTTCRGST    * add to GST Total
              MOVE      ZERO,XTTAMGST
            ELSE
              MOVE      ZERO,XTTCRGST
              MOVE      IBGIVALU,XTTAMGST    * add to GST Total
            ENDIF
            MOVE        SP70,XSPARE
            CALL        WRTMPA1
          ENDIF
.
SVGST999  RETURN
+
.        ======================================================================
.        Get accommodation description
.        ======================================================================
ACDS0000  MOVE      ZERO,CMXMSC
          MATCH     ANSA,FINTYPE
          GOTO      ACDS2000 IF EQUAL          * Fees
.
          MATCH     ANSC,FINTYPE
          GOTO      ACDS9999 IF NOT EQUAL      * Not journals
.
          CALL      JRDS0000                   * Get journal description
          GOTO      ACDS9999
.
ACDS2000  UNPACK    FINCODE,KEY1,DIM3,DIM4
          MATCH     ANSA,KEY1
          GOTO      ACDS1000 IF EQUAL          * Normal accommodation
          MATCH     ANSN,KEY1
          GOTO      ACDS1000 IF EQUAL          * Accomm.Credit notes
.
          MATCH     ANSC,KEY1
          GOTO      ACDS1200 IF EQUAL          * Lumpsum
          MATCH     ANSH,KEY1
          GOTO      ACDS1200 IF EQUAL          * Lumpsum Credit notes
.
          MATCH     ANSD,KEY1
          GOTO      ACDS1300 IF EQUAL          * Daily charge
          MATCH     ANSJ,KEY1
          GOTO      ACDS1300 IF EQUAL          * Daily charge Credit notes
.
          MATCH     ANST,KEY1
          GOTO      ACDS0600 IF EQUAL          * casemix misc
          MATCH     ANSP,KEY1
          GOTO      ACDS0600 IF EQUAL          * casemix misc credit note
.
          MATCH     ANSM,KEY1
          GOTO      ACDS0800 IF EQUAL          * misc
          MATCH     ANSQ,KEY1
          GOTO      ACDS0800 IF EQUAL          * Misc.Credit note
          GOTO      ACDS9999
.
ACDS0600  MOVE      ONE,CMXMSC                 * Casemix misc.
ACDS0800  CALL      MSDS0000                   * Check for Misc.
          GOTO      ACDS9999
.
ACDS1000  BRANCH    CACCFEE,ACDS1010,ACDS1020,ACDS1030,ACDS1040,ACDS1050
.
.         Accommodation by admission type
.
          UNPACK    FINCODE,KEY1,KEY3
          PACK      KEY5,CODEA,KEY3
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      IBGIDESC,ACCOMTL,TDESC,SP70       * Get the description
          ENDIF
          GOTO      ACDS9999
.
.        Accommodation by ward/claim
.
ACDS1010  UNPACK    FINCODE,KEY1,DIM3,DIM4
          PACK      IBGIDESC,ACCOMTL,ACCTL1,DIM3,ACCTL2,DIM4,SP70
          GOTO      ACDS9999
.
.        Accommodation by ward/admission type
.
ACDS1020  UNPACK    FINCODE,KEY1,WWARD,DIM3
          IF        HSYS1=4
            PACK      IBGIDESC,ACCTL1,WWARD,SLASH,DIM3,SP70
          ELSE
            PACK      IBGIDESC,ACCTL1,WWARD,SP1,DIM3,SP70
          ENDIF
          GOTO      ACDS9999
.
.        Accommodation by ward/claim/admission type
.
ACDS1030  UNPACK    FINCODE,KEY1,WWARD,DIM3A,DIM3B
          IF        HSYS1=4
            PACK   IBGIDESC,ACCOMTL,ACCTL1,WWARD,SLASH,ACCTL4,DIM3A,SLASH,DIM3B,SP70
          ELSE
        PACK   IBGIDESC,ACCOMTL,ACCTL1,WWARD,SP1,ACCTL4,DIM3A,SP1,DIM3B,SP70
          ENDIF
          GOTO      ACDS9999
.
.        Accomodation by  Ward/admission type/Claim type
.
ACDS1040  UNPACK    FINCODE,KEY1,DIM3A,DIM3B,DIM3C
          IF        HSYS1=4
            PACK      IBGIDESC,ACCOMTL,ACCTL1,DIM3A,SLASH,DIM3B,SLASH,DIM3C,SP70
          ELSE
            PACK      IBGIDESC,ACCOMTL,ACCTL1,DIM3A,SP1,DIM3B,SP1,DIM3C,SP70
          ENDIF
          GOTO      ACDS9999
.
.         Accommodation by Claim type
.
ACDS1050  UNPACK    FINCODE,KEY1,KEY3
          PACK      KEY5,CODECL,KEY3
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      IBGIDESC,ACCOMTL,TDESC,SP70       * Get the description
          ENDIF
          GOTO      ACDS9999
.
.        Lumpsum
.
ACDS1200  UNPACK    FINCODE,KEY1,DIM1,DIM3,DIM3A  * Seperate out the codes
          MOVE      DIM1,FORM1
          MOVE      SP10,DIM8
          MOVE      MSO,DIM8
          MOVE      MSO,DIM3B1
          LOAD      DIM8,FORM1,SAMEDAY
          LOAD      DIM3B1,FORM1,SDAY
.
          PACK      TDESC,SP20
          IF        CACCFEE=5
            PACK      KEY5,ANSC,ANSL,DIM3
          ELSE
            PACK      KEY5,ANSA,SP1,DIM3
          ENDIF
          CALL      RDCODE1
.
          MOVE      SP30,IBGIEREF
          CLEAR     IBGIEREF
.
          MOVE      SP30,IBGIDESC
          CLEAR     IBGIDESC
.
          MATCH     SP70,DIM3A
          IF        !@EQUAL
            IF        CACCFEE=4
              IF        EXPORTDE=0
                APPEND    "L/S: ",IBGIDESC
                APPEND    DIM8,IBGIDESC
                APPEND    " - ",IBGIDESC
                UNPACK    TDESC,KEY10
                APPEND    KEY10,IBGIDESC
                APPEND    "-",IBGIDESC
                APPEND    DIM3A,IBGIDESC
                RESET     IBGIDESC
              ELSE
                APPEND    "L/S:",IBGIDESC
                APPEND    DIM3B1,IBGIDESC
                APPEND    "-",IBGIDESC
                APPEND    TDESC,IBGIDESC
                APPEND    "-",IBGIDESC
                APPEND    DIM3A,IBGIEREF
                RESET     IBGIDESC
                RESET     IBGIEREF
              ENDIF
              GOTO      ACDS9999
            ENDIF
          ENDIF
.
          IF        EXPORTDE=0
            APPEND    "LUMP SUM: ",IBGIDESC
            APPEND    DIM8,IBGIDESC
            APPEND    " - ",IBGIDESC
            APPEND    TDESC,IBGIDESC
            RESET     IBGIDESC
          ELSE
            APPEND    "L/S:",IBGIDESC
            APPEND    DIM3B1,IBGIDESC
            APPEND    "-",IBGIDESC
            APPEND    TDESC,IBGIDESC
            RESET     IBGIDESC
          ENDIF
          GOTO      ACDS9999
.
.         Daily charge
.
ACDS1300  UNPACK    FINCODE,KEY1,DIM3,DIM3A  * Seperate out the codes
          MOVE      SP30,IBGIDESC
          CLEAR     IBGIDESC
          APPEND    DAILY,IBGIDESC
.
          IF        CACCFEE=5
             MOVE      SP20,TDESC
             PACK      KEY5,CODECL,DIM3             * Key for Claim type
             CALL      RDCODE1                      * Read in the codes record
             IF        OVRCD=0
               APPEND    TDESC,IBGIDESC        * Get the description
             ELSE
               APPEND    "Claim- ",IBGIDESC
               APPEND    DIM3,IBGIDESC
             ENDIF
          ELSE
            APPEND    "Ward - ",IBGIDESC
            APPEND    DIM3,IBGIDESC
            IF        CACCFEE=4
              MATCH     SP70,DIM3A
              IF        !@EQUAL
                APPEND    " - ",IBGIDESC
                APPEND    DIM3A,IBGIDESC
              ENDIF
            ENDIF
          ENDIF
          RESET     IBGIDESC
ACDS9999  RETURN
.
.        ======================================================================
.        MSDS0000: Get misc.item group description
.        ======================================================================
MSDS0000 UNPACK    SP70,KEY3,DIM3,DIM9
         BRANCH    PTCNMFEE,MSDS6000          * by claim/misc.group
.
         IF        CMXMSC=1
           UNPACK    FINCODE,KEY1,DIM1,DIM3,DIM9  * C/P by misc.group/item code
           MOVE      ZERO,FORM1
           MOVE      DIM1,FORM1
           IF        FORM1=1
             MOVE      "DAY-",DIM4A
           ELSE
             MOVE      "MSO-",DIM4A
           ENDIF
         ELSE
           UNPACK    FINCODE,KEY1,DIM3,DIM9       * by misc.group/item code
           MOVE      SP70,DIM4A
         ENDIF
.
         MATCH     SP70,DIM3
         GOTO      MSDS3000 IF EQUAL            * No group
.
.        We have a grouping code. Get the description from the codes file
.
         PACK      IBGIDESC,UNKMGRP,DIM3,SP70         * Default description
.
         MOVE      "-",DIM1
         PACK      KEY5,CODEFI,DIM3              * Get the group code desc.
         CALL      RDCODE1
         IF        OVRCD=0
           MATCH     SP70,DIM9
           IF        @EQUAL
             PACK      IBGIDESC,TDESC,DIM1,DIM3,SP70
           ELSE
             MOVE      TDESC,KEY15
             PACK      IBGIDESC,KEY15,DIM1,DIM3,SP1,DIM9,SP70
           ENDIF
         ENDIF
         GOTO      MSDS9999
.
.        Get item description
.
MSDS3000 PACK      IBGIDESC,UNKMISC,DIM9,SP70         * Default description
.
.        check that it is a valid MBS item number
.
         PACK      KEY9,DIM9                     * Key for item file
         PACK      KEY17,KEY9,CURRDATE,SP70
         CALL      PATITMRD                      * Read the item file
         BRANCH    OVRCD,MSDS4000                * Check for valid misc charge
         MOVE      IDESC,KEY20                   * Save the description
         MOVE      "-",DIM1
         PACK      IBGIDESC,KEY20,DIM1,KEY9,SP70
         GOTO      MSDS9999
.
.        Get the description from the Misc charges file
.
MSDS4000 MOVE      PTCNDCLM,MCLMCOD              * Claim code 0
         PACK      KEY29,MCLMCOD,SP6,SP3,DIM9,CURRDATE,SP10
         CALL      PATMCHRD                 * read Misc.Charges file 
         COMPARE   ZERO,EXIT
         GOTO      MSDS5000 IF NOT EQUAL    * invalid Item
.
MSDS4200 MOVE      MDESC,KEY20                * Save the description
         MOVE      "-",DIM1
         IF        HSYS1=4
           PACK      IBGIDESC,KEY20,SLASH,DIM1,DIM9,SP70
         ELSE
           PACK      IBGIDESC,KEY20,SP1,DIM1,DIM9,SP70
         ENDIF
         GOTO      MSDS9999
.
MSDS5000 UNPACK    SP10,KEY4,KEY5
         UNPACK    KEY9,KEY4,KEY5
         MATCH     SP5,KEY5
         IF        @EQUAL
           OPEN      PATDGWA1,"patdgwaf"
           PACK      KEY7,KEY4,PTCNDGPV,SP10                          *I-137125
           CALL      RDPTDGW1               * Valid DRG code ?
           CLOSE     PATDGWA1
           IF        OVRCD<>1
             MOVE      "-",DIM1
             PACK      IBGIDESC,KEY4,DIM1,PTDWDESC,SP70  * Save the description
           ENDIF
         ENDIF
         GOTO      MSDS9999
.
.        Misc.item by claim and Item group
.
MSDS6000 IF        CMXMSC=1
           UNPACK    FINCODE,KEY1,DIM1,DIM3,KEY3  * C/P by claim/misc.group
           MOVE      ZERO,FORM1
           MOVE      DIM1,FORM1
           IF        FORM1=1
             MOVE      "DAY-",DIM4A
           ELSE
             MOVE      "MSO-",DIM4A
           ENDIF
         ELSE
           UNPACK    FINCODE,KEY1,DIM3,KEY3       * by claim/misc.group
           MOVE      SP70,DIM4A
         ENDIF
.
         IF        HSYS1=4
           PACK     IBGIDESC,UNKCLCOD,SLASH,OPNBRA,DIM3,CLSBRA,SP70
         ELSE
           PACK     IBGIDESC,UNKCLCOD,SP1,OPNBRA,DIM3,CLSBRA,SP70 * Default desc
         ENDIF
         PACK      KEY5,CODECL,DIM3
         CALL      RDCODE1
         BRANCH    OVRCD,MSDS9999
.
         BRANCH    CMXMSC,MSDS7000
         MATCH     "A",TCINDC2
         GOTO      MSDS7000 IF NOT EQUAL    * Not an ABF Funding
.
         MATCH     SP70,SAVSCODE
         GOTO      MSDS7000 IF EQUAL
.
         UNPACK    SAVSCODE,KEY4,KEY9
         MATCH     "yyyyyyyyy",KEY9
         GOTO      MSDS7000 IF NOT EQUAL
.
         UNPACK    SAVSCODE,KEY3,DIM1
         MOVE      "INP",KEY3
         MATCH     "2",DIM1
         IF        @EQUAL
           MOVE      "OUT",KEY3
         ELSE
           MATCH     "1",DIM1
           IF        @EQUAL
             MOVE      "ED ",KEY3
           ENDIF
         ENDIF
.
MSDS7000 MOVE      "-",DIM1
         IF        HSYS1=4
           PACK      IBGIDESC,TDESC,DIM1,DIM3,SLASH,KEY3,SP70
         ELSE
           IF        EXPORTDE=1
             UNPACK    TDESC,EXPORTDN
.
             PACK      KEY5,CODEFI,KEY3
             CALL      RDCODE1
             BRANCH    OVRCD,MSDS8000
.
             MATCH     SP70,DIM4A
             IF        @EQUAL
               PACK      IBGIDESC,DIM3,SP1,EXPORTDN
               PACK      IBGIEREF,KEY3,SP1,TDESC
             ELSE
               PACK      IBGIDESC,DIM3,SP1,EXPORTDN
               PACK      IBGIEREF,DIM4A,KEY3,SP1,TDESC
             ENDIF
           ELSE
             PACK      IBGIDESC,TDESC,DIM1,DIM3,SP1,KEY3,SP70
           ENDIF
         ENDIF
         GOTO       MSDS9999
.
MSDS8000 PACK       IBGIDESC,DIM3,SP1,EXPORTDN
.
MSDS9999 RETURN
+
.        ======================================================================
.        JRDS0000: Get Journal description
.        ======================================================================
JRDS0000 COMPARE   ONE,PTCNJFEE                  * Journals by claim code ?
         GOTO      JRDS3300 IF EQUAL             * Yes
.
         UNPACK    FINCODE,DIM2
         PACK      KEY5,CODEJ,DIM2,SP1           * Key for journal code
         CALL      RDCODE1                       * Read in codes file record
         IF        HSYS1=4
           PACK      IBGIDESC,TDESC,SLASH,OPNBRA,DIM2,CLSBRA,SP70
         ELSE
           PACK      IBGIDESC,TDESC,SP1,OPNBRA,DIM2,CLSBRA,SP70
         ENDIF
         GOTO      JRDS9999
.
JRDS3300 UNPACK    FINCODE,DIM3,DIM2             * claim/journal
         IF        HSYS1=4
           PACK     IBGIDESC,UNKCLCOD,SLASH,OPNBRA,DIM3,CLSBRA,SP70
         ELSE
           PACK     IBGIDESC,UNKCLCOD,SP1,OPNBRA,DIM3,CLSBRA,SP70 * Default desc
         ENDIF
.
         IF        EXPORTDE=1
           PACK      KEY5,CODEJ,DIM2
           CALL      RDCODE1
           IF        OVRCD<>1
             MOVE      TDESC,EXPORTDN
           ENDIF
         ENDIF
.
         MATCH     SP3,DIM3
         GOTO      JRDS3400 IF EQUAL             * No claim code set up
.
         PACK      KEY5,CODECL,DIM3              * Key for journal code
         CALL      RDCODE1                       * Read in codes file record
         IF        OVRCD<>1
           IF        HSYS1=4
             PACK      IBGIDESC,TDESC,SLASH,OPNBRA,DIM3,SLASH,DIM2,CLSBRA,SP70
           ELSE
             IF      EXPORTDE=1
               PACK      IBGIDESC,DIM3,SP1,TDESC
               PACK      IBGIEREF,DIM2,SP1,EXPORTDN
             ELSE
               PACK      IBGIDESC,TDESC,SP1,OPNBRA,DIM3,SP1,DIM2,CLSBRA,SP70
             ENDIF
           ENDIF
         ENDIF
         GOTO      JRDS9999
.
JRDS3400 IF        HSYS1=4
           PACK      IBGIDESC,UNKJOUR,SLASH,OPNBRA,DIM2,CLSBRA  * Default desc.
         ELSE
           PACK      IBGIDESC,UNKJOUR,SP1,OPNBRA,DIM2,CLSBRA  * Default desc.
         ENDIF
.
         MATCH     SP2,DIM2
         GOTO      JRDS9999 IF EQUAL             * No journal code set up
.
         PACK      KEY5,CODEJ,DIM2,SP1           * Key for journal code
         CALL      RDCODE1                       * Read in codes file record
         IF        OVRCD<>1
           PACK      SUBDESC2,TDESC,SP1,OPNBRA,DIM2,CLSBRA
         ENDIF
JRDS9999 RETURN
+
.        ======================================================================
.        PRNT0000: Loop over the work file, and print the report
.        ======================================================================
.
PRNT0000 DISPLAY   *P1:24,*EL,*P10:24,"Printing : ";
.
          IF        EXPORTFL=1
            CALL      EHED0000               * Print the heading
          ENDIF
.
         CALL      FIXA0000                      * Fix accom/misc totals
.
         MOVE      ZERO,CURSECT                  * Initialise current section
         MOVE      ZERO,CURSUBS                  * Initialise current subsect
         MOVE      SP20,KEY16                    * Loop from start of work file
         CALL      RDSWORK                       * Positional read of work
PRNT1000 CALL      RDKWORK                       * Read the next record
         BRANCH    OVRCD,PRNT8000                * Finished work file
.
         COMPARE   CURSECT,SECTION               * Check for new section
         GOTO      PRNT2000 IF EQUAL             * Same section
.
         CALL      PSUM0000                      * Print the summary section
         MOVE      "60",CLNO                     * Force new page
         MOVE      SECTION,CURSECT               * Save new section number
         MOVE      SUBSECT,CURSUBS               * Save new sub-section number
.
.        Load up the section and subsection headings
.
         LOAD      SECTHD,CURSECT,SECT1,SECT2,SECT3
.
         DISPLAY   *P21:24,*EL,*V2LON,SECTHD     * Display the section name
.
PRNT2000 COMPARE   CURSUBS,SUBSECT               * Check for a new subsection
         GOTO      PRNT3000 IF EQUAL             * Same subsection
.
         COMPARE   "52",CLNO                     * Enough room on page ?
         GOTO      PRNT2200 IF NOT LESS          * No.
.
         CALL      ENDS0000                      * End of a subsection
         CALL      SUBS0000                      * Print Subsection title
         GOTO      PRNT2400
.
PRNT2200 MOVE      "60",CLNO                     * Force a new page
.
PRNT2400 MOVE      SUBSECT,CURSUBS               * Save new sub-section number
.
PRNT3000 CALL      PDAT0000                      * Print this data record
         GOTO      PRNT1000                      * Get the next record
.
.        End of work file. Check if anything was produced
.
PRNT8000 CALL      PSUM0000                      * Print the last summary
.
         BRANCH    EXPORTFL,PRNT9999
.
         COMPARE   ZERO,CPAGENO                  * Still on page zero ?
         GOTO      PRNT9000 IF NOT EQUAL         * No. A report was produced
.
         DISPLAY   *P1:24,*EL,*B:
                   "No Data Found for the Report ",YEARTTL:
                   ". ";
         CALL      HITENTER
.
         GOTO      PRNT9999
.
PRNT9000 CALL      ENDS0000                      * End of a subsection
         PRINT     *N,"*** END OF REPORT ***"
.
PRNT9999 RETURN
.
.        ======================================================================
.        PDAT0000: Print the current work file record
.        ======================================================================
.
PDAT0000 MATCH      SUBCODE,TILDA20              * Check for a totals record
         GOTO       PDAT2000 IF EQUAL            * Yes. Print totals record
.
.        Check for a non-zero line
.
         MOVE       ZERO,FORM2                   * Start from the beginning
PDAT1000 ADD        ONE,FORM2                    * Get next variable
.
         COMPARE    TEN6,FORM2
         GOTO       PDAT9999 IF NOT LESS
.
         LOAD       WORK1,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                                XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                                XSUBM09,XSUBM10,XSUBM11,XSUBM12:
                                XSUBM13,XSUBPER,XSUBPRY
.
.        Check if this is non-zero
.
         COMPARE    ZERO,WORK1
         GOTO       PDAT1000 IF EQUAL
.
.        We have a line with at least one non-zero figure
.
PDAT2000 COMPARE   "52",CLNO
         CALL      HEAD0000 IF NOT LESS          * Start new page if neccessary
.
         MATCH     SUBCODE,TILDA20               * Check for a totals record
         CALL      TOTL0000 IF EQUAL             * Print a line of '-'s
.
         DISPLAY   *P43:24,*EL,*V2LON,SUBDESC1;
.
.        Print the data
.
         CALL      PRTD0000                      * Print the work file record
.
         MATCH     SUBCODE,TILDA20               * Check if not a totals rec.
         CALL      BLNK0000 IF NOT EQUAL         * Print a blank line
.
         MATCH     SUBCODE,TILDA20               * Check if not a totals rec.
         IF        @EQUAL
           CALL      PBLK0000
         ENDIF
.
PDAT9999 RETURN
.
.        ======================================================================
.        PRTD0000: Print the data variables
.        ======================================================================
.
PRTD0000 BRANCH    EXPORTFL,PRTD3000
.
         COMPARE   TEN2,NUMPERS
         GOTO      PRTD2000 IF NOT EQUAL
.
.        Print 12 periods
.
         MOVE      SUBDESC1,DIM29
         BRANCH    PRTFLAG,PRTD1000
.
         PRINT     *1,"|",*2,DIM29,*30,"|",*31,SUBPER,*45,"|":
                   *46,SUBYTD,*60,"|",*61,SUBM01,*73,SUBM02:
                   *85,SUBM03,*97,SUBM04,*109,SUBM05:
                   *121,SUBM06,*132,"|",*N:
                   *1,"|";
.
         IF        SUBUS2DS=1
           UNPACK    SUBDESC2,KEY26
           PRINT     *2,KEY26;
         ELSE
           UNPACK    SUBDESC2,DIM15
           PRINT     *2,DIM15,*19,SUBDCOD;
         ENDIF
.
         PRINT     *30,"|",*45,"|":
                   *46,SUBPRY,*60,"|",*61,SUBM07,*73,SUBM08:
                   *85,SUBM09,*97,SUBM10,*109,SUBM11:
                   *121,SUBM12,*132,"|"
         ADD       TWO,CLNO                      * Increment the line count
.
PRTD1000 PRINT     *1,"|",*2,DIM29,*33,"|",*34,XSUBPER,*50,"|":
                   *51,XSUBYTD,*67,"|",*68,XSUBM01,*84,XSUBM02:
                   *101,XSUBM03,*117,XSUBM04,*132,"|",*N:
                   *1,"|";
.
         IF        SUBUS2DS=1
           UNPACK    SUBDESC2,KEY29
           PRINT     *2,KEY29;
         ELSE
           UNPACK    SUBDESC2,DIM15
           PRINT     *2,DIM15,*19,SUBDCOD;
         ENDIF
.
         PRINT     *33,"|",*50,"|":
                   *51,XSUBPRY,*67,"|",*68,XSUBM05,*84,XSUBM06:
                   *101,XSUBM07,*117,XSUBM08,*132,"|",*N;
.
         PRINT     *1,"|":
                   *33,"|",*50,"|":
                   *67,"|",*68,XSUBM09,*84,XSUBM10:
                   *101,XSUBM11,*117,XSUBM12,*132,"|"
         ADD       THREE,CLNO                      * Increment the line count
         GOTO      PRTD9999
.
.        Print 13 periods
.
PRTD2000 MOVE      SUBDESC1,DIM29
         PRINT     *1,"|",*2,DIM29,*30,"|",*31,SUBPER,*45,"|":
                   *46,SUBYTD,*60,"|",*61,SUBM01,*73,SUBM02:
                   *85,SUBM03,*97,SUBM04,*109,SUBM05:
                   *121,SUBM06,*132,"|",*N:
                   *1,"|";
         IF        SUBUS2DS=1
           PRINT     *2,SUBDESC2;
         ELSE
           PRINT     *21,SUBDCOD;
         ENDIF
         PRINT     *30,"|",*45,"|":
                   *46,SUBPRY,*60,"|",*61,SUBM07,*73,SUBM08:
                   *85,SUBM09,*97,SUBM10,*109,SUBM11:
                   *121,SUBM12,*132,"|",*N:
                   *1,"|",*30,"|",*45,"|",*60,"|",*61,SUBM07,*132,"|"
.
         ADD       THREE,CLNO                    * Increment the line count
         GOTO      PRTD9999
.
.        Export file
.
PRTD3000
         MOVE      SUBDESC1,DIM29
.
         IF        SUBUS2DS=1
           UNPACK    SUBDESC2,KEY29
           PRINT     "<tr><td width=30%>",DIM29:
                     "   ",KEY29,"</td>"
         ELSE
           UNPACK    SUBDESC2,DIM15
           PRINT     "<tr><td width=30%>",DIM29:
                     "   ",DIM15,SP2,SUBDCOD,"</td>"
         ENDIF
.
         PRINT     "<td>",XSUBPER,"</td>":
                   "<td>",XSUBYTD,"</td>":
                   "<td>",XSUBPRY,"</td>":
                   "<td>",XSUBM01,"</td>":
                   "<td>",XSUBM02,"</td>":
                   "<td>",XSUBM03,"</td>":
                   "<td>",XSUBM04,"</td>"
.
         PRINT     "<td>",XSUBM05,"</td>":
                   "<td>",XSUBM06,"</td>":
                   "<td>",XSUBM07,"</td>":
                   "<td>",XSUBM08,"</td>":
                   "<td>",XSUBM09,"</td>":
                   "<td>",XSUBM10,"</td>":
                   "<td>",XSUBM11,"</td>":
                   "<td>",XSUBM12,"</td></tr>"
.
PRTD9999 RETURN
.
.        ======================================================================
.        BLNK0000: Print a "blank" line
.        ======================================================================
.
BLNK0000 BRANCH    EXPORTFL,BLNK9999
         BRANCH    PRTFLAG,BLNK1000
         PRINT     *1,"|",*30,"|",*45,"|",*60,"|",*132,"|"
         GOTO      BLNK2000
.
BLNK1000 PRINT     *1,"|",*33,"|",*50,"|",*67,"|",*132,"|"
BLNK2000 ADD       ONE,CLNO
BLNK9999 RETURN
.
.        ======================================================================
.        TOTL0000: Print a line of '-'s
.        ======================================================================
.
TOTL0000 BRANCH    EXPORTFL,TOTL9999
         BRANCH    PRTFLAG,TOTL1000
         PRINT     *1,"|",*30,"|--------------|--------------|------------":
                   "--------------------------------------------------":
                   "---------|"
         GOTO      TOTL2000
.
TOTL1000 PRINT     *1,"|",*33,"|----------------|----------------|":
                   "-----------------":
                   "-----------------":
                   "-----------------":
                   "-------------|"
TOTL2000 ADD       ONE,CLNO
TOTL9999 RETURN
.
.        ======================================================================
.        ENDS0000: Print the end of a section
.        ======================================================================
.
ENDS0000 BRANCH    EXPORTFL,ENDS9999
         PRINT     "*-------------------------------------------------":
                   "--------------------------------------------------":
                   "-------------------------------*"
         ADD       ONE,CLNO
         GOTO      ENDS9999
.
ENDS9999 RETURN
.
.        ======================================================================
.        Print a blank line
.        ======================================================================
PBLK0000 COMPARE   ONE,EXPORTFL
         GOTO      PBLK9999 IF NOT EQUAL
.
         PRINT     "<tr><td>&nbsp;</td></tr>"
PBLK9999 RETURN
.
.        ======================================================================
.        PSUB0000: Print a subheading line
.        ======================================================================
.
PSUB0000 BRANCH    EXPORTFL,PSUB6000
.
         BRANCH    PRTFLAG,PSUB1000
.
         PRINT     *1,"|",SUBHEAD,*30,"|",*45,"|",*60,"|",*132,"|"
.
.        Convert letters to '-'s and reprint (gives an underline)
.
         REP       TOMINUS,SUBHEAD
         PRINT     *1,"|",SUBHEAD,*30,"|",*45,"|",*60,"|",*132,"|"
         GOTO      PSUB2000
.
PSUB1000 PRINT     *1,"|",SUBHEAD,*33,"|",*50,"|",*67,"|",*132,"|"
.
PSUB2000 ADD       TWO,CLNO
         GOTO      PSUB9999
.
PSUB6000 CALL      ESUB0000                  * Print Sub heading on Export file
.
PSUB9999 RETURN
+
.        ======================================================================
.        Print Sub heading
.        ======================================================================
ESUB0000 
.        PRINT     "<tr><td width=30%>",SUBHEAD,"</td>":
.                  "<td>&nbsp;</td>":
.                  "<td>&nbsp;</td>":
.                  "<td>&nbsp;</td>":
.                  "<td>&nbsp;</td>":
.                  "<td>&nbsp;</td>":
.                  "<td>&nbsp;</td></tr>"
ESUB9999 RETURN
.
.        ======================================================================
.        FIXA0000: Add the Accommodation totals to the Misc Item totals
.        ======================================================================
.
FIXA0000 MOVE      ONE,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 1 Accom total key
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA2000                * No Accom in section 1
.
         CALL      SAVT0000                      * Save the total amounts
.
.        Read in the Misc Item total (if it exists). If it exists, add the
.        accommodation totals. If it does not exist, then change to description
.        to "TOTALS" on the accommodation record
.
         MOVE      "3",FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 1 Misc Item total key
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA1000                * No Misc Items in section 1
.
         CALL      ADDW0000                      * Add the Accom totals
         GOTO      FIXA2000                      * Now fix section 2
.
.        Fix the description on the accommodation record
.
FIXA1000 MOVE      ONE,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 1 Accom total key
         CALL      RDWORK                        * Re-read in the accom record
.
         MOVE      THREE,SUBSECT                 * Change to Misc total
         MOVE      "TOTAL ACCOMMODATIONS          ",SUBDESC1
         CALL      UPWORK                        * Update the description
.
FIXA2000 MOVE      TWO,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 1 Casemix Accom.
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA4000                * No Misc Items in section 1
.
         CALL      SAVT0000                      * Save the total amounts
         MOVE      THREE,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * set 1 misc item total key
         CALL      RDWORK                        * read in the work file record
         BRANCH    OVRCD,FIXA3000                * no misc item in section 1
.
         CALL      ADDW0000                      * Add the Accom totals
         GOTO      FIXA4000
.
FIXA3000 MOVE      TWO,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 1 Accom total key
         CALL      RDWORK                        * Re-read in the accom record
.
         MOVE      THREE,SUBSECT                 * Change to Misc total
         MOVE      "TOTAL CASEMIX FUND ACCOMM.    ",SUBDESC1
         CALL      UPWORK                        * Update the description
.
.        Check for credit notes
.
FIXA4000 MOVE      FOUR,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 8 Accom total key
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA4600                * No Accom in section 8
.
         CALL      SAVT0000                      * Save the total amounts
.
.        Read in the Misc Item total (if it exists). If it exists, add the
.        accommodation totals. If it does not exist, then change to description
.        to "TOTALS" on the accommodation record
.
         MOVE      SIX,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 8 Misc Item total key
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA4500                * No Misc Items in section 8
.
         CALL      ADDW0000                      * Add the Accom totals
         GOTO      FIXA4600                      * Now fix section 9
.
.        Fix the description on the accommodation record
.
FIXA4500 MOVE      FOUR,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 8 Accom total key
         CALL      RDWORK                        * Re-read in the accom record
.
         MOVE      SIX,SUBSECT                   * Change to Misc total
         MOVE      "TOTAL CREDIT NOTES ACCOM.     ",SUBDESC1
         CALL      UPWORK                        * Update the description
.
FIXA4600 MOVE      FIVE,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 9 Casemix Accom.
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA5000                * No Misc Items in section 9
.
         CALL      SAVT0000                      * Save the total amounts
         MOVE      SIX,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * set 9 misc item total key
         CALL      RDWORK                        * read in the work file record
         BRANCH    OVRCD,FIXA4800                * no misc item in section 1
.
         CALL      ADDW0000                      * Add the Accom totals
         GOTO      FIXA5000
.
FIXA4800 MOVE      FIVE,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Sect 9 Accom total key
         CALL      RDWORK                        * Re-read in the accom record
.
         MOVE      SIX,SUBSECT                   * Change to Misc total
         MOVE      "TOTAL C'MIX CRED.NOTE ACCOM.  ",SUBDESC1
         CALL      UPWORK                        * Update the description
.
.        Fix up the accommodation/misc item totals for section 2
.
FIXA5000 MOVE      ONE,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20       * Sect 2 Accom total key
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA7000                * No Accom in section 2
.
         CALL      SAVT0000                      * Save the total amounts
.
.        Read in the Misc Item total (if it exists). If it exists, add the
.        accommodation totals. If it does not exist, then change to description
.        to "TOTALS" on the accommodation record
.
         MOVE      THREE,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20       * Sect 2 Misc Item total key
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA6000                * No Misc Items in section 2
.
         CALL      ADDW0000                      * Add the Accom totals
         GOTO      FIXA7000
.
.        Fix the description on the accommodation record
.
FIXA6000 MOVE      ONE,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20       * Sect 2 Accom total key
         CALL      RDWORK                        * Re-read in the accom record
.
         MOVE      THREE,SUBSECT                 * Change to Misc total
         MOVE      "TOTAL TO BE INVOICED ACCOM.   ",SUBDESC1
         CALL      UPWORK                        * Update the description
.
FIXA7000 MOVE      TWO,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20       * Sect 2 Casemix Accom.
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA9999                * No Accom in section 2
.
         CALL      SAVT0000                      * Save the total amounts
         MOVE      THREE,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20       * Sect 2 Misc Item total key
         CALL      RDWORK                        * Read in the work file record
         BRANCH    OVRCD,FIXA8000                * No Misc Items in section 2
.
         CALL      ADDW0000                      * Add the Accom totals
         GOTO      FIXA9999
.
FIXA8000 MOVE      TWO,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20       * Sect 2 Casemix Accom.
         CALL      RDWORK                        * Read in the work file record
.
         MOVE      THREE,SUBSECT                 * Change to Misc total
         MOVE      "TOTAL TOBE INVOICED C'MIX ACCM",SUBDESC1
         CALL      UPWORK                        * Update the description
.
FIXA9999 RETURN
.
.        ======================================================================
.        SAVT0000: Save the work file totals in the PATFINS variables
.        ======================================================================
.
SAVT0000 MOVE      ZERO,FORM2                    * Start from the beginning
SAVT1000 ADD       ONE,FORM2                     * Get the next variable
         COMPARE   TEN7,FORM2                    * Have we finished yet ?
         GOTO      SAVT9999 IF NOT LESS          * Yes.
.
         LOAD      WORK1,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                               XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                               XSUBM09,XSUBM10,XSUBM11,XSUBM12:
                               XSUBM13,XSUBPER,XSUBPRY,XSUBYTD
.
         STORE     WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                               FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                               FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                               FINMTH13,FINPER,FLSTYR,FINYTD
         GOTO      SAVT1000
.
SAVT9999 RETURN
.
.        ======================================================================
.        REST0000: Restore the work file totals from the PATFINS variables
.        ======================================================================
.
REST0000 MOVE      ZERO,FORM2                    * Start from the beginning
REST1000 ADD       ONE,FORM2                     * Get the next variable
         COMPARE   TEN7,FORM2                    * Have we finished yet ?
         GOTO      REST9999 IF NOT LESS          * Yes.
.
         LOAD      WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                               FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                               FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                               FINMTH13,FINPER,FLSTYR,FINYTD
.
         STORE     WORK1,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                               XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                               XSUBM09,XSUBM10,XSUBM11,XSUBM12:
                               XSUBM13,XSUBPER,XSUBPRY,XSUBYTD
         GOTO      REST1000
.
REST9999 RETURN
.
.        ======================================================================
.        SUBT0000: Subtract the work file totals from the PATFINS variables
.        ======================================================================
.
SUBT0000 MOVE      ZERO,FORM2                    * Start from the beginning
SUBT1000 ADD       ONE,FORM2                     * Get the next variable
         COMPARE   TEN7,FORM2                    * Have we finished yet ?
         GOTO      SUBT9999 IF NOT LESS          * Yes.
.
         LOAD      WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                               FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                               FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                               FINMTH13,FINPER,FLSTYR,FINYTD
.
         LOAD      WORK2,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                               XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                               XSUBM09,XSUBM10,XSUBM11,XSUBM12:
                               XSUBM13,XSUBPER,XSUBPRY,XSUBYTD
.
         SUB       WORK2,WORK1
.
         STORE     WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                               FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                               FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                               FINMTH13,FINPER,FLSTYR,FINYTD
         GOTO      SUBT1000
.
SUBT9999 RETURN
.
.        ======================================================================
.        ADDI0000: Add the work file totals from the PATFINS variables
.        ======================================================================
.
ADDI0000 MOVE      ZERO,FORM2                    * Start from the beginning
ADDI1000 ADD       ONE,FORM2                     * Get the next variable
         COMPARE   TEN7,FORM2                    * Have we finished yet ?
         GOTO      ADDI9999 IF NOT LESS          * Yes.
.
         LOAD      WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                               FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                               FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                               FINMTH13,FINPER,FLSTYR,FINYTD
.
         LOAD      WORK2,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                               XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                               XSUBM09,XSUBM10,XSUBM11,XSUBM12:
                               XSUBM13,XSUBPER,XSUBPRY,XSUBYTD
.
         ADD       WORK2,WORK1
.
         STORE     WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                               FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                               FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                               FINMTH13,FINPER,FLSTYR,FINYTD
         GOTO      ADDI1000
.
ADDI9999 RETURN
.
.        ======================================================================
.        PSUM0000: Print the summary for the currect section
.        ======================================================================
.
PSUM0000 LOAD      SECTHD,CURSECT,SUMM1,SUMM2,SUMM3
         MOVE      ONE,NOSUBS                    * No subheadings in summary
.
.        Save the current record for reposition later on
.
         PACK      SAVKEY16,SECTION,SUBSECT,SUBCODE
.
.        Go to the appropriate summary section
.
         CALL      PBLK0000
.
         BRANCH    CURSECT,PSUM1000,PSUM2000,PSUM3000
         MOVE      ZERO,NOSUBS                   * Turn subheadings on
         GOTO      PSUM9999
.
.        Section 1 summary (Fee's Invoiced)
.
PSUM1000 CALL      ZERO0000                      * Zero the variables
         MOVE      THREE,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Fee's invoiced total key
         CALL      RDWORK                        * Read in the record
.
         CALL      HEAD0000                      * Start new page
.
.        Change the descriptions for the Fee's Invoiced total
.
         MOVE      "FEES INVOICED                 ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SAVT0000                      * Save the totals
.
         COMPARE   NINE,CFEETYP                  * John Hopkins?
         GOTO      PSUM1080 IF NOT EQUAL
.
.        Get Discount
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      "12",FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Discount
         CALL      RDWORK                        * Read in the record
.
         MOVE      "LESS DISCOUNT                 ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
PSUM1080 COMPARE   THREE,IBCNUGST
         GOTO      PSUM1090 IF EQUAL
         COMPARE   TWO,IBCNUGST
         GOTO      PSUM1100 IF NOT EQUAL
.
PSUM1090 CALL      ZERO0000                      * Zero the variables
         MOVE      SEVEN,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * GST
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the GST total
.
         MOVE      "PLUS GST                      ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      ADDI0000                      * Add to the totals
.
.        Get Rounding adjustment
.
PSUM1100 COMPARE   NINE,CFEETYP                  * John Hopkins?
         GOTO      PSUM1102 IF NOT EQUAL
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      "13",FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Rounding
         CALL      RDWORK                        * Read in the record
.
         MOVE      "LESS ROUNDING ADJUSTMENT      ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
PSUM1102 CALL      ZERO0000                      * Zero the variables
         MOVE      SIX,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Credit Note Acc.
         CALL      RDWORK                        * Read in the record
.
         MOVE      "LESS CREDIT NOTES             ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
.        Get Credit Notes Discount
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      "14",FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Discount
         CALL      RDWORK                        * Read in the record
         BRANCH    OVRCD,PSUM1104
.
         MOVE      "LESS CREDIT NOTES DISCOUNT       ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
PSUM1104 COMPARE   THREE,IBCNUGST
         GOTO      PSUM1120 IF EQUAL
         COMPARE   TWO,IBCNUGST
         GOTO      PSUM1200 IF NOT EQUAL
.        
.        Change the descriptions for the GST total
.
PSUM1120 CALL      ZERO0000                      * Zero the variables
         MOVE      EIGHT,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * GST
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the GST total
.
         MOVE      "LESS CREDIT NOTE GST               ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
.        Get Credit Note Rounding adjustment
.        
PSUM1140 COMPARE   NINE,CFEETYP                  * John Hopkins?
         GOTO      PSUM1200 IF NOT EQUAL
.        
         CALL      ZERO0000                      * Zero the variables
         MOVE      "15",FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Rounding
         CALL      RDWORK                        * Read in the record
         BRANCH    OVRCD,PSUM1200
.
         MOVE      "LESS CREDIT NOTES ROUNDING ADJ.",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
PSUM1200 CALL      ZERO0000                      * Zero the variables
         MOVE      NINE,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Cash Received total key
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the Cash Received total
.
         MOVE      "LESS CASH RECEIVED            ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      TEN,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * Journals total key
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the Journals total
.
         MOVE      "LESS JOURNALS                 ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
         COMPARE   THREE,IBCNUGST
         GOTO      PSUM1220 IF EQUAL
         COMPARE   TWO,IBCNUGST
         GOTO      PSUM1600 IF NOT EQUAL
.
PSUM1220 CALL      ZERO0000                      * Zero the variables
         MOVE      TEN1,FORM2
         PACK      KEY16,ONE,FORM2,TILDA20       * GST Journals total key
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the Journals total
.
         MOVE      "LESS GST JOURNALS             ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
.        Print the grand total
.
PSUM1600 MOVE      "NETT:                         ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      REST0000                      * Restore the totals
         CALL      TOTL0000                      * Start of totals line
         CALL      PRTD0000                      * Print the data
.         CALL      ENDS0000                      * End of section 
         MOVE      ZERO,NOSUBS                   * Turn subheadings on
         CALL      PBLK0000
         GOTO      PSUM9990
.
.        Section 2 summary (To Be Invoiced)
.
PSUM2000 CALL      ZERO0000                      * Zero the variables
         MOVE      THREE,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20         * To be invoiced total key
         CALL      RDWORK                        * Read in the record
.
         CALL      HEAD0000                      * Start new page
.
.        Change the descriptions for the To Be Invoiced total
.
         MOVE      "TO BE INVOICED                ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SAVT0000                      * Save the totals
.
         COMPARE   NINE,CFEETYP                  * John Hopkins?
         GOTO      PSUM2200 IF NOT EQUAL
.
.        Get Discount
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      "12",FORM2
         PACK      KEY16,TWO,FORM2,TILDA20       * Discount
         CALL      RDWORK                        * Read in the record
.
         MOVE      "LESS DISCOUNT                 ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
PSUM2200 CALL      ZERO0000                      * Zero the variables
         MOVE      FOUR,FORM2
         PACK      KEY16,TWO,FORM2,TILDA20          * Cash Received total key
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the Cash Received total
.
         MOVE      "LESS CASH RECEIVED            ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
.        Print the grand total
.
         MOVE      "NETT:                         ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      REST0000                      * Restore the totals
         CALL      TOTL0000                      * Start of totals line
         CALL      PRTD0000                      * Print the data
         CALL      ENDS0000                      * End of section 
         MOVE      ZERO,NOSUBS                   * Turn subheadings on
         CALL      PBLK0000
         GOTO      PSUM9990
.
.        Section 3 summary (Merchant Cards)
.
PSUM3000 CALL      ZERO0000                      * Zero the variables
         MOVE      ONE,FORM2
         PACK      KEY16,THREE,FORM2,TILDA20     * Claimed total key
         CALL      RDWORK                        * Read in the record
         BRANCH    OVRCD,PSUM9990                * No Misc Items, No summary
.
         CALL      HEAD0000                      * Start new page
.
.        Change the descriptions for the Claimed total
.
         MOVE      "CLAIMED                       ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SAVT0000                      * Save the totals
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      TWO,FORM2
         PACK      KEY16,THREE,FORM2,TILDA20     * Cash Received total key
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the Cash Received total
.
         MOVE      "LESS CASH RECEIVED            ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      THREE,FORM2
         PACK      KEY16,THREE,FORM2,TILDA20       * Commissions total key
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the Commissions total
.
         MOVE      "LESS COMMISSIONS              ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
         CALL      ZERO0000                      * Zero the variables
         MOVE      FOUR,FORM2
         PACK      KEY16,THREE,FORM2,TILDA20     * Journals total key
         CALL      RDWORK                        * Read in the record
.
.        Change the descriptions for the Journals total
.
         MOVE      "LESS JOURNALS                 ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      PRTD0000                      * Print the data
         CALL      BLNK0000                      * Blank line
         CALL      SUBT0000                      * Subtract from the totals
.
.        Print the grand total
.
         MOVE      "NETT:                         ",SUBDESC1
         MOVE      SP20,SUBDCOD
.
         CALL      REST0000                      * Restore the totals
         CALL      TOTL0000                      * Start of totals line
         CALL      PRTD0000                      * Print the data
         CALL      ENDS0000                      * End of section 
         MOVE      ZERO,NOSUBS                   * Turn subheadings on
         CALL      PBLK0000
.
.        Reposition in the work file
.
PSUM9990 MOVE      SAVKEY16,KEY16
         CALL      RDWORK
.
PSUM9999 RETURN
.
.        ======================================================================
.        ENDP0000: Do the end of report processing
.        ======================================================================
.
ENDP0000 CLOSE     TEMPFILE                      * Make sure file is closed
         CLEAR     CMDLINE                       * Clear CMDLINE
         APPEND    "iserase ",CMDLINE            * Set up for erase of work
         APPEND    FNAMEW,CMDLINE
         RESET     CMDLINE
.
         EXECUTE   CMDLINE,TASKID                * Delete work file
.
.        If Print & Reset was selected, then rest date in control file
.
         BRANCH    OPTION,ENDP9999,ENDP1000
.
ENDP1000 CALL      MVEXT000                      * move file to web
.
.        Reset date in control file
.
         BRANCH    FSTSYS,ENDP1100,ENDP1200,ENDP1300,ENDP1400
.
.        This must be consolidate report or only inpatient system is used
.
.         MOVE      ZERO,FORM2
.         MOVE      FUAAE,FORM2
.         ADD       FUOUTP,FORM2
.         ADD       FUINP,FORM2
.         ADD       COTHSFN,FORM2
.
.         COMPARE   ONE,FORM2                     * Only one system ?
.         GOTO      ENDP1300 IF EQUAL             * must be inpatient
.
.         DISPLAY   *P1:24,*EL,*B:
.                   "You Cannot Reset Consolidated Report.  ";
.         CALL      HITENTER
.
         MOVE      CURRDATE,PTCFEEAE
         WRITAB    CONTROLF,EIGHTY8;*194,PTCFEEAE * A&E
.
         MOVE      CURRDATE,PTCFEEOP
         WRITAB    CONTROLF,EIGHTY8;*202,PTCFEEOP * Outpatient
.
         MOVE      CURRDATE,CFEEDT
         WRITAB    CONTROLF,EIGHTY8;*102,CFEEDT   * Inpatient
.
         MOVE      CURRDATE,PTCFEEOF
         WRITAB    CONTROLF,EIGHTY8;*162,PTCFEEOF * Other financial
.
         GOTO      ENDP9999                      * Consolidate
.
ENDP1100 MOVE      CURRDATE,PTCFEEAE
         WRITAB    CONTROLF,EIGHTY8;*194,PTCFEEAE  * A&E
         GOTO      ENDP9999
.
ENDP1200 MOVE      CURRDATE,PTCFEEOP
         WRITAB    CONTROLF,EIGHTY8;*202,PTCFEEOP  * Outpatient
         GOTO      ENDP9999
.
ENDP1300 MOVE      CURRDATE,CFEEDT
         WRITAB    CONTROLF,EIGHTY8;*102,CFEEDT      * Inpatient
         GOTO      ENDP9999
.
ENDP1400 MOVE      CURRDATE,PTCFEEOF
         WRITAB    CONTROLF,EIGHTY8;*162,PTCFEEOF    * Other financial
.
ENDP9999 RETURN
+
.------------------------------------------------------------
. Move Extract to Web Directory
.------------------------------------------------------------
MVEXT000  MOVE      "fin",KEY3
          PACK      KEY4,CMM,CDD
          REP       " 0",KEY4
.
          COMPARE   ONE,IBCNMHOS
          GOTO      MVEXT100 IF NOT EQUAL     * not multi hospital
.
          MATCH     SP3,HOSPID
          GOTO      MVEXT100 IF EQUAL
          PACK      KEY3,HOSPID
          REP       " 0",KEY3
.
MVEXT100  SQUEEZE   INVNAME
          CLEAR     CMDLINE
          APPEND    "ibabil19.us1 ",CMDLINE
          APPEND    INVNAME,CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    "f",CMDLINE
          APPEND    KEY3,CMDLINE        * pass filename for display on web
          APPEND    KEY4,CMDLINE
          APPEND    SP70,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
.         Setup to be invoiced file
.
          SQUEEZE   TBINAME
          CLEAR     CMDLINE
          APPEND    "ibabil19.us2 ",CMDLINE
          APPEND    TBINAME,CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    "t",CMDLINE
          APPEND    KEY3,CMDLINE        * pass filename for display on web
          APPEND    KEY4,CMDLINE
          APPEND    SP70,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
MVEXT999  RETURN
.
.        ======================================================================
.        HEAD0000: Print the heading for the report
.        ======================================================================
.
HEAD0000 BRANCH    EXPORTFL,HEAD6000             * Export file
.
         COMPARE   ZERO,CPAGENO                  * First page ?
         CALL      ENDS0000 IF NOT EQUAL         * No. End previous page
.
         MOVE      YEARTTL,CPHDROPT
.
.        Print the standard section of the heading
.
         CALL      HEAD132
.
         IF        IBCNMHOS =1
            PRINT     *40,"Hospital : ",HOSPID,"    ",HOSPNAME
            MOVE      THREE,CLNO
         ENDIF
.
         PRINT     *N,*45,"REPORT FOR ITEMS ENTERED DURING PERIOD ":
                          FPDATE," TO ",CDATE,*N
.
         CLOCK     TIME,CTIMEIS                  * Clock the starting time
         MOVE      FIVE,CLNO                     * Reset the line counter
.
.        Check if we are doing outpatients. If so, check if we are doing
.        a single site, dept or all sites
.
         COMPARE   TWO,FSTSYS                    * Outpatients ?
         GOTO      HEAD2000 IF NOT EQUAL         * No.
.
         MATCH     SP6,FSTSITE                   * A single site ?
         GOTO      HEAD1000 IF NOT EQUAL         * Yes.
.
         MATCH     SP3,FSTDEPT                   * A single department ?
         GOTO      HEAD0500 IF NOT EQUAL         * Yes.
.
.        Printing all sites
.
         PRINT     *45,"ALL SITES",*N
         ADD       TWO,CLNO
         GOTO      HEAD2000
.
.        Printing a single department
.
HEAD0500 MOVE      SP20,TDESC                    * Clear description
         PACK      KEY5,CODEO,FSTDEPT            * Pack key for dept code
         CALL      RDCODE1                       * Read in the dept desc.
.
         PRINT     *45,"DEPT: ",FSTDEPT,SP3,TDESC,*N
         ADD       TWO,CLNO
         GOTO      HEAD2000
.
.        Printing a single site
.
HEAD1000 MOVE      SP30,OSTDESC                  * Clear description
         MOVE      FSTSITE,KEY6                  * Pack key for site code
         CALL      RDSITA1                       * Read in the site desc.
.
         PRINT     *45,"SITE: ",FSTSITE,SP3,OSTDESC,*N
         ADD       TWO,CLNO
.
HEAD2000 CALL      ENDS0000                      * Print the line of '-'s
.
.        Print the column headings
.
         BRANCH    PRTFLAG,HEAD2200
.
.******************************************** start of changes         *C-65765
         PRINT     *1,"|",*30,"|",*37,"PERIOD",*45,"|",*51,"Y.T.D.":
                   *60,"|",*61,MDESC1,*132,"|",*N:
                   *1,"|",*2,SECTHD,*30,"|":
                   *45,"|",*49,"PRIOR YEAR",*60,"|":
                   *61,MDESC2,*132,"|"
.
         ADD       TWO,CLNO                      * Modify line counter
         GOTO      HEAD2400
.
HEAD2200 UNPACK    MDESC1,KEY64
         PRINT     *1,"|",*33,"|",*38,"PERIOD",*50,"|",*58,"Y.T.D.":
                   *67,"|",*68,KEY64,*132,"|",*N;
.
         UNPACK    MDESC2,KEY64
         PRINT     *1,"|",*2,SECTHD,*33,"|":
                   *50,"|",*54,"PRIOR YEAR",*67,"|":
                   *68,KEY64,*132,"|"
.
         ADD       THREE,CLNO                      * Modify line counter
.
.        If we don't have 12 periods in the year, then print the 3rd descrip.
.
HEAD2400 BRANCH    PRTFLAG,HEAD2600
.
         COMPARE   TEN2,NUMPERS
         GOTO      HEAD3000 IF EQUAL
.
         PRINT     *1,"|",*30,"|",*45,"|",*60,"|",*61,MDESC3,*132,"|"
         ADD       ONE,CLNO                      * Modify line counter
         GOTO      HEAD3000
.
HEAD2600 UNPACK    MDESC3,KEY64
         PRINT     *1,"|",*33,"|",*50,"|",*67,"|",*68,KEY64,*132,"|"
.********************************************   end of changes         *C-65765
         ADD       ONE,CLNO                      * Modify line counter
.
.        Print the last section of the heading
.
HEAD3000 CALL      ENDS0000                      * Print the line of '-'s
.
HEAD6000 BRANCH    NOSUBS,HEAD9999               * Subheading to be printed ?
.
         CALL      SUBS0000                      * Print the subsection title
         GOTO      HEAD9999
.
HEAD9999 RETURN
+
.*******************************************************************************
.         Routine to print heading for Export File
.*******************************************************************************
EHED0000  PRINT     "<table border=1><tr><td width=30%>&nbsp;",SECTHD,"</td>":
                    "<td>PERIOD</td>":
                    "<td>Y.T.D.</td>":
                    "<td>PRIOR YEAR</td>"
.
          UNPACK    MDESC1,KEY68
          CALL      PEHD0000               * Print Heading line
.
          UNPACK    MDESC2,KEY68
          CALL      PEHD0000               * Print Heading line
.
          UNPACK    MDESC3,KEY68
          CALL      PEHD0000               * Print Heading line
.
          PRINT     "</tr>"
.
EHED9999  RETURN
+
.*******************************************************************************
.         Print Healding line
.*******************************************************************************
PEHD0000  MATCH     SP70,KEY68
          GOTO      PEHD9999 IF EQUAL
.
          RESET     KEY68
          MOVE      SP70,KEY14
          MOVE      KEY68,KEY14
          PRINT     "<td>",KEY14,"</td>"
.
          BUMP      KEY68,17
          MOVE      SP70,KEY14
          MOVE      KEY68,KEY14
          PRINT     "<td>",KEY14,"</td>"
.
          BUMP      KEY68,17
          MOVE      SP70,KEY14
          MOVE      KEY68,KEY14
          PRINT     "<td>",KEY14,"</td>"
.
          BUMP      KEY68,17
          MOVE      SP70,KEY14
          MOVE      KEY68,KEY14
          PRINT     "<td>",KEY14,"</td>"
.
PEHD9999  RETURN
.
.        ======================================================================
.        SUBS0000: Print the subsection heading if appropriate
.        ======================================================================
.
.        SUBSECT is the current subsection to be printed
.        CURSECT is the subsection of the previous record. It is used
.                to determine whether or not to print a new heading when
.                changing between Accommodation and Misc Items.
.
SUBS0000 BRANCH    CURSECT,SUBS1000,SUBS2000,SUBS9999
         GOTO      SUBS9999
.
.        Section 1 subheadings (Fee's invoiced)
.
SUBS1000 BRANCH    SUBSECT,SUBS1100,SUBS1200,SUBS1300:
                           SUBS1370,SUBS1380,SUBS1390:
                           SUBS1400,SUBS1420,SUBS1500:
                           SUBS1600,SUBS1700,SUBS1800:
                           SUBS1900,SUBS1820,SUBS1920
         GOTO      SUBS9999
.
.        Accommodation
.
SUBS1100 MOVE      "FEES INVOICED",SUBHEAD       * Fee's invoiced
         GOTO      SUBS5000
.
SUBS1200 MOVE      "FESS INVOICED - CASEMIX FUND",SUBHEAD
         GOTO      SUBS5000
.
.        Misc Items
.
SUBS1300 COMPARE   ONE,CURSECT                   * Check if was Accommodation
         GOTO      SUBS1350 IF NOT EQUAL         * No.
.
.        Changed from Accommodation to Misc items
.
         CALL      BLNK0000                      * Print a blank line
         GOTO      SUBS9999
.
SUBS1350 MOVE      "FEES INVOICED",SUBHEAD       * Fee's invoiced
         GOTO      SUBS5000
.
SUBS1370 MOVE      "CREDIT NOTES FEES INVOICED",SUBHEAD       * Fee's invoiced
         GOTO      SUBS5000
.
SUBS1380 MOVE      "CREDIT NOTES FEES INVOICED - CASEMIX FUND",SUBHEAD
         GOTO      SUBS5000
.
SUBS1390 
.        CALL      BLNK0000                      * Print a blank line
         MOVE      "CREDIT NOTES",SUBHEAD
         IF        EXPORTFL=1
           CALL      ESUB0000                    * Print Sub head on Export file
         ELSE
           IF        PRTFLAG=1
             PRINT     *1,"|",SUBHEAD,*33,"|",*50,"|",*67,"|",*132,"|"
           ELSE
             PRINT     *1,"|",SUBHEAD,*32,"|",*49,"|",*66,"|",*132,"|"
           ENDIF
         ENDIF
         ADD       ONE,CLNO
         GOTO      SUBS9999
.
SUBS1400 MOVE      "GST",SUBHEAD
         GOTO      SUBS5000
.
SUBS1420 MOVE      "CREDIT NOTES GST",SUBHEAD
         GOTO      SUBS5000
.
.        Cash Received
.
SUBS1500 MOVE      "CASH RECEIVED",SUBHEAD       * Cash Received
         GOTO      SUBS5000
.
.        Journals
.
SUBS1600 MOVE      "JOURNALS",SUBHEAD            * Journals
         GOTO      SUBS5000
.
SUBS1700 MOVE      "GST JOURNALS",SUBHEAD        * GST Journals
         GOTO      SUBS5000
.
.        Discount for John Hopkins
.
SUBS1800 MOVE      "Discount",SUBHEAD            * Discount
         GOTO      SUBS5000
.
SUBS1820 MOVE      "CREDIT NOTES Discount",SUBHEAD            * Discount
         GOTO      SUBS5000
.
.        Rounding for John Hopkins
.
SUBS1900 MOVE      "Rounding",SUBHEAD            * Rounding
         GOTO      SUBS5000
.
SUBS1920 MOVE      "CREDIT NOTES Rounding",SUBHEAD            * Rounding
         GOTO      SUBS5000
.
.        Section 2 subheadings (To be invoiced)
.        Section 2 subheadings (To be invoiced)
.
SUBS2000 BRANCH    SUBSECT,SUBS2100,SUBS2200,SUBS2300:
                           SUBS2400
         COMPARE   "12",SUBSECT
         GOTO      SUBS2500 IF EQUAL              * Discount
         COMPARE   "13",SUBSECT
         GOTO      SUBS2600 IF EQUAL              * Rounding
         GOTO      SUBS9999
.
.        Accommodation
.
SUBS2100 MOVE      "TO BE INVOICED",SUBHEAD       * Fee's invoiced
         GOTO      SUBS5000
.
SUBS2200 MOVE      "TO BE INVOICED - CASEMIX FUND",SUBHEAD    * Fee's invoiced
         GOTO      SUBS5000
.
.        Misc Items
.
SUBS2300 COMPARE   ONE,CURSECT                   * Check if was Accommodation
         GOTO      SUBS2350 IF NOT EQUAL         * No.
.
.        Changed from Accommodation to Misc items
.
         CALL      BLNK0000                      * Print a blank line
         GOTO      SUBS9999
.
SUBS2350 MOVE      "TO BE INVOICED",SUBHEAD       * Fee's invoiced
         GOTO      SUBS5000
.
.        Cash Received
.
SUBS2400 MOVE      "CASH RECEIVED",SUBHEAD       * Cash Received
         GOTO      SUBS5000
.
.        Discount
.
SUBS2500 MOVE      "DISCOUNT     ",SUBHEAD       * Discount
         GOTO      SUBS5000
.
.        Rounding
.
SUBS2600 MOVE      "ROUNDING     ",SUBHEAD       * Rounding
         GOTO      SUBS5000
.
.        SUBHEAD contains the description to be printed.
.
SUBS5000 CALL      PSUB0000                      * Print the subheading
.
SUBS9999 RETURN
.
.        ======================================================================
.        Check for Credit note GST
.        ======================================================================
CRGST000 MOVE      ZERO,EXIT
         MATCH     "N",FINCODE
         GOTO      CRGST900 IF EQUAL    * Credit Note Accommodation
         MATCH     "H",FINCODE
         GOTO      CRGST900 IF EQUAL    * Credit Note lumpsum
         MATCH     "J",FINCODE
         GOTO      CRGST900 IF EQUAL    * Credit Note Daily charge
         MATCH     "Q",FINCODE
         GOTO      CRGST900 IF EQUAL    * Credit Note Misc.
         MATCH     "P",FINCODE
         GOTO      CRGST999 IF NOT EQUAL    * not Credit Note C/P Misc.
CRGST900 MOVE      ONE,EXIT
CRGST999 RETURN
+
.        ======================================================================
.        WKEY0000: Get the work file key for the current PATFINS record
.        ======================================================================
.
WKEY0000 MOVE      ZERO,ERRORFLG 
         CMATCH    ANSA,FINTYPE                  * Fee's Invoiced
         GOTO      WKEY1000 IF EQUAL
.
         CMATCH    ANSB,FINTYPE                  * Cash Received
         GOTO      WKEY2000 IF EQUAL
.
         CMATCH    ANSC,FINTYPE                  * Journals
         GOTO      WKEY3000 IF EQUAL
.
         CMATCH    ANSD,FINTYPE                  * Merch Card Claimed
         GOTO      WKEY4000 IF EQUAL
.
         CMATCH    ANSE,FINTYPE                  * Merch Card Paid
         GOTO      WKEY5000 IF EQUAL
.
         CMATCH    ANSF,FINTYPE                  * Merch Card Commission
         GOTO      WKEY6000 IF EQUAL
.
         CMATCH    ANSG,FINTYPE                  * Merch Card Journals
         GOTO      WKEY7000 IF EQUAL
.
.        Fee's Generated
.
WKEY1000 MOVE      CURSECT,SECTION               * Section 1 or 2
.
         COMPARE   TWO,IBCNUGST
         GOTO      WKEY1002 IF EQUAL
         COMPARE   THREE,IBCNUGST
         GOTO      WKEY1004 IF NOT EQUAL
.
WKEY1002 IF        GSTFLAG=1 & CGLIND=1
           MOVE      SEVEN,SUBSECT                * for GST
           CALL      CRGST000                     * Credit Note GST?
           IF        EXIT=1
             MOVE      EIGHT,SUBSECT              * for Credit note GST
           ENDIF
.
           MOVE      SP20,SUBCODE
           MATCH     "1",PTCNFGST                 * GST breakdown by fincode
           IF        @EQUAL
             PACK      SUBCODE,FINCODE,SP70       * subsection code
             GOTO      WKEY1004
           ENDIF
.
           MOVE      ONE,PTFMSUB
           CALL      GLED0000                    * Get the general ledger
           GOTO      WKEY9999
         ENDIF
.
.        Normal
.
WKEY1004 MATCH     "1",PTCNUABF
         IF        @EQUAL
           IF        FINSYS=6
             MOVE      THREE,SUBSECT                 * Subsection 3
             UNPACK    FINCODE,ANS,DIM3,DIM9         * Extract Subsection code
             MOVE      "zzzzzzzzzz",KEY10        * flag for ABF Booked outpat
             PACK      SUBCODE,DIM3,KEY10        * Subsection code (w/o grps)
             GOTO      WKEY9999
           ENDIF
.
         ENDIF
.
         CMATCH    ANSA,FINCODE                  * Accommodation
         GOTO      WKEY1100 IF EQUAL
.
         CMATCH    ANSN,FINCODE                  * Credit note accommodation
         GOTO      WKEY1200 IF EQUAL
.
         CMATCH    ANSB,FINCODE                  * Maternity Accommodation
         GOTO      WKEY1100 IF EQUAL
.
         IF        CFEETYP = 6
           CMATCH    ANSG,FINCODE
           IF        @EQUAL
             GOTO      WKEY1502
           ENDIF
         ENDIF
.
         CMATCH    ANSG,FINCODE                  * Government Subsidy
         GOTO      WKEY1100 IF EQUAL
.
         CMATCH    ANSQ,FINCODE                  * Credit note misc item
         GOTO      WKEY1500 IF EQUAL
         CMATCH    ANSM,FINCODE                  * Misc Items
         GOTO      WKEY1500 IF EQUAL
.
         CMATCH    ANSP,FINCODE                  * Credit note MiscItems casemix
         IF        @EQUAL
           MOVE      SIX,SUBSECT                 * Credit note misc.item
           GOTO      WKEY1010
         ENDIF
         CMATCH    ANST,FINCODE                  * Misc Items (casemix funding)
         IF        @EQUAL
           MOVE      THREE,SUBSECT               * misc. item sub section
WKEY1010   MOVE      ONE,CMXMSC                  * flag to casemix misc.
           UNPACK    FINCODE,KEY1,ANS,DIM3,DIM9       * Extract subsection code
.
           IF        PTCNMFEE=1
             PACK      SUBCODE,ANS,DIM3,DIM9,SP20   * without/without group
           ELSE
             MATCH     SP3,DIM3                  * check if we are using groups
             IF        @EQUAL 
               PACK      SUBCODE,ANS,SP3,DIM9,SP20 * subsection code (w/o grps)
             ELSE
               PACK      SUBCODE,ANS,DIM3,SP20     * subsection code (with grps)
             ENDIF
           ENDIF
           GOTO       WKEY1600
         ENDIF
.
         COMPARE    THREE,FINSYS                 * Inpatient system ?
         GOTO       WKEY1100 IF NOT EQUAL        * no
.
.        Check for Casemix accommodation
.
         CMATCH     ANSC,FINCODE                 * lumpsums (casemix funding)
         GOTO       WKEY1020 IF EQUAL
.
         CMATCH     ANSD,FINCODE                 * Daily charges (casemix)
         IF         @EQUAL
WKEY1020   MOVE       TWO,SUBSECT                * subsection 2 (accomm.casemix)
           PACK       SUBCODE,FINCODE,SP70       * subsection code
           GOTO       WKEY1600
         ENDIF
.
.        Check for Credit note casemi accommodation
.
         CMATCH     ANSH,FINCODE                 * lumpsums (casemix funding)
         GOTO       WKEY1030 IF EQUAL
.
         CMATCH     ANSJ,FINCODE                 * Daily charges (casemix)
         IF         @EQUAL
WKEY1030   MOVE       FIVE,SUBSECT               * subsection 5 (accomm.casemix)
           PACK       SUBCODE,FINCODE,SP70       * subsection code
           GOTO       WKEY1600
         ENDIF
.
         MOVE       ONE,ERRORFLG
         GOTO       WKEY1600
.
.        Accommodation subsection
.
WKEY1100 MOVE      ONE,SUBSECT                   * Subsection 1
         GOTO      WKEY1300
.
.        Credit Note Accommodation
.
WKEY1200 MOVE      FOUR,SUBSECT                 * Subsection 4
.
.        If the current record is an outpatient record, then this means
.        that we are using the clinic id as the code. Otherwise, use
.        whatever the code from the fees invoiced file is as the sub-code
.
WKEY1300 IF        FINSYS = 2
           UNPACK    FINCODE,ANS,OCACLIN
           PACK      SUBCODE,ANSO,OCACLIN,OSTFILE,SP20
         ELSE
           PACK      SUBCODE,FINCODE,SP20        * Subsection code
         ENDIF
         GOTO      WKEY1600
.
.        Misc Items
.
WKEY1500 COMPARE   NINE,CFEETYP                 * John Hopkins?
         GOTO      WKEY1502 IF NOT EQUAL
.
         UNPACK    FINCODE,ANS,DIM3A             * Group code
         IF        PTCNMFEE=1
           UNPACK    FINCODE,ANS,DIM3,DIM3A      * Claim, Group code
         ENDIF
.
         MATCH     PTCNCDIS,DIM3A
         GOTO      WKEY1501 IF EQUAL             * discount catg
.
         MATCH     PTCNROUN,DIM3A
         GOTO      WKEY1502 IF NOT EQUAL         * Not a rounding catg
.
         CMATCH    ANSQ,FINCODE
         IF        @EQUAL
           MOVE      "15",SUBSECT                * Credit note Rounding
         ELSE
           MOVE      "13",SUBSECT                * Rounding
         ENDIF
         GOTO      WKEY1510
.
WKEY1501 CMATCH    ANSQ,FINCODE
         IF        @EQUAL
           MOVE      "14",SUBSECT                * Credit Note Discount
         ELSE
           MOVE      "12",SUBSECT                * Discount
         ENDIF
         GOTO      WKEY1510
.
WKEY1502 MOVE      THREE,SUBSECT                 * Subsection 3
         CMATCH    ANSQ,FINCODE                  * Credit note misc item
         IF        @EQUAL
           MOVE      SIX,SUBSECT                  * Subsection 6
         ENDIF
.
         CALL      BABF0000
         IF        EXIT=1
           UNPACK    FINCODE,ANS,DIM3,DIM9     * Extract Subsection code
           MOVE      "yyyyyyyyyy",KEY9         * flag for ABF charges
           PACK      SUBCODE,DIM3,DFINSYS,KEY9 * breakdown by System
           MOVE      ZERO,EXIT
           GOTO      WKEY9999
         ENDIF
.
WKEY1510 UNPACK    FINCODE,ANS,DIM3,DIM9         * Extract Subsection code
         MATCH     "G",ANS
         GOTO      WKEY1550 IF EQUAL             * Government Subsidette
.
         IF        PTCNMFEE=1
           UNPACK    DIM9,DIM1,DIM8
             PACK      SUBCODE,DIM3,DIM9,SP20    * Subsection code (w/o grps)
.                              Claim Code & Item Code
         ELSE
WKEY1550   MATCH     SP3,DIM3                    * Check if we are using groups
           IF        @EQUAL
             PACK      SUBCODE,SP3,DIM9,SP20     * Subsection code (w/o grps)
.                              Item Code
           ELSE
             PACK      SUBCODE,DIM3,SP20         * Subsection code (with grps)
.                              Group Code
           ENDIF
         ENDIF
.
WKEY1600 COMPARE   "12",SUBSECT
         GOTO      WKEY9999 IF EQUAL              * Discount
.
         COMPARE   TWO,IBCNUGST
         GOTO      WKEY1700 IF EQUAL
         COMPARE   THREE,IBCNUGST
         GOTO      WKEY9999 IF NOT EQUAL
.
WKEY1700 IF        GSTFLAG=1
           MOVE      SEVEN,SUBSECT                * for GST
           CALL      CRGST000                     * Credit Note GST?
           IF        EXIT=1
             MOVE      EIGHT,SUBSECT              * for Credit note GST
           ENDIF
.
           MATCH     "1",PTCNFGST
           IF        @EQUAL
.            PACK      SUBCODE,FINCODE,SP70         * subsection code
             GOTO      WKEY9999
           ENDIF
.
           MOVE      SP70,SUBCODE
           MOVE      ONE,PTFMSUB
           CALL      GLED0000                    * Get the general ledger
         ENDIF
         GOTO      WKEY9999
.
.        Cash received
.
WKEY2000 MOVE      CURSECT,SECTION               * Section 1 or 2
         MOVE      NINE,SUBSECT                  * Subsection 9
         IF        CURSECT=2
           MOVE      FOUR,SUBSECT                * Subsection 4
         ENDIF
         PACK      SUBCODE,FINCODE,SP20          * Subsection code
         GOTO      WKEY9999
.
.        Journals
.
WKEY3000 MOVE      CURSECT,SECTION               * Section 1 or 2
.
         COMPARE   TWO,IBCNUGST
         GOTO      WKEY3020 IF EQUAL
         COMPARE   THREE,IBCNUGST
         GOTO      WKEY9999 IF NOT EQUAL
.
WKEY3020 IF        GSTFLAG=1 
           MOVE      TEN1,SUBSECT
           MOVE      SP20,SUBCODE
           MOVE      FIVE,PTFMSUB
           PACK      SUBCODE,FINCODE,SP70                * Subsection code
           CALL      GLED0000                    * Get the general ledger
           GOTO      WKEY9999
         ENDIF
.
         MOVE      TEN,SUBSECT                   * Subsection 10
         UNPACK    FINCODE,DIM13
         IF        PTCNJFEE=1
           UNPACK    DIM13,DIM3,DIM10
           PACK      SUBCODE,DIM3,DIM10,SP20     * Subsection code
.                            Claim Code, Journal Code
         ELSE
           PACK      SUBCODE,DIM13,SP20          * Subsection code
.                            Journal Code
         ENDIF
         GOTO      WKEY9999
.
.        Merchant card claimed
.
WKEY4000 MOVE      THREE,SECTION                 * Section 3
         MOVE      ONE,SUBSECT                   * Subsection 1
         PACK      SUBCODE,FINCODE,SP20          * Subsection code
         GOTO      WKEY9999
.
.        Merchant card journals
.
WKEY5000 MOVE      THREE,SECTION                 * Section 3
         MOVE      TWO,SUBSECT                   * Subsection 2
         PACK      SUBCODE,FINCODE,SP20          * Subsection code
         GOTO      WKEY9999
.
.        Merchant card commissions
.
WKEY6000 MOVE      THREE,SECTION                 * Section 3
         MOVE      THREE,SUBSECT                 * Subsection 3
         PACK      SUBCODE,FINCODE,SP20          * Subsection code
         GOTO      WKEY9999
.
.        Merchant card journals
.
WKEY7000 MOVE      THREE,SECTION                 * Section 3
         MOVE      FOUR,SUBSECT                  * Subsection 4
         PACK      SUBCODE,FINCODE,SP20          * Subsection code
         GOTO      WKEY9999
.
WKEY9999 RETURN
+
.        ======================================================================
.        GLED0000: Get the General Ledger
.        ======================================================================
GLED0000 COMPARE   ONE,CGLIND
         GOTO      GLED9999 IF NOT EQUAL
.
         UNPACK    SP70,ANS,KEY12
         UNPACK    FINCODE,ANS,KEY12
         REP       "NAHCJDQMPT",ANS
         MOVE      FINHOSP,PTFMHOSP
         MATCH     "1",PTFMSUB
         IF        @EQUAL
           UNPACK    FINCODE,KEY1
           REP       "P1Q1M1T1",KEY1
           MATCH     "1",KEY1
           IF        @EQUAL
             MOVE      "3",PTFMSUB            * Misc.Item
           ENDIF
         ENDIF
         PACK      KEY17,PTFMHOSP,PTFMSUB,ANS,KEY12
         PACK      KEY18,PTFMHOSP,FINSYS,PTFMSUB,ANS,KEY12
         CALL      RDSYFMS
         IF        OVRCD=1
           PACK      KEY17,PTFMHOSP,PTFMSUB,SP20        * use default
	   PACK      KEY18,PTFMHOSP,FINSYS,PTFMSUB,SP20
           CALL      RDSYFMS
           BRANCH    OVRCD,GLED9999
         ENDIF
         PACK      SUBCODE,PTFMILD,SP70        * ledger
GLED9999 RETURN
+
.        ======================================================================
.        ABF system breakdown description
.        ======================================================================
SYSD0000  COMPARE   THREE,SUBSECT
          GOTO      SYSD0200 IF EQUAL         * Misc.Items - ABF charges
.
          COMPARE   SIX,SUBSECT               * Credit note Misc.Items - ABF ?
          GOTO      SYSD9999 IF NOT EQUAL
.
SYSD0200  PACK      KEY5,CODECL,DIM3          * Get the group code desc.
          CALL      RDCODE1
          BRANCH    OVRCD,SYSD9999
.
          MATCH     "A",TCINDC2
          GOTO      SYSD9999 IF NOT EQUAL    * Not an ABF Funding
.
          MOVE      "INP",KEY3
          MATCH     "2",DIM1
          IF        @EQUAL
            MOVE      "OUT",KEY3
          ELSE
            MATCH     "1",DIM1
            IF        @EQUAL
              MOVE      "ED ",KEY3
            ENDIF
          ENDIF
          STRIP     TDESC
.
          CLEAR     SUBDESC1
          APPEND    TDESC,SUBDESC1
          APPEND    SP1,SUBDESC1
          APPEND    OPNBRA,SUBDESC1
          APPEND    DIM3,SUBDESC1
          APPEND    "-",SUBDESC1
          APPEND    KEY3,SUBDESC1
          APPEND    CLSBRA,SUBDESC1
.
          APPEND    SP70,SUBDESC1
          RESET     SUBDESC1
.
SYSD9999  RETURN
+
.        ======================================================================
.        GETD0000: Get the description for the current PATFINS record
.        ======================================================================
.
GETD0000 MOVE      SP30,SUBDESC1                 * Initialise Description
         MOVE      SP30,SUBDESC2                 * Initialise Description
         MOVE      SP20,SUBDCOD                  * Initialise Printed Code
         MOVE      ZERO,SUBUS2DS                 * Initialise 2nd desc flag
.
         MATCH     "1",PTCNUABF
         IF        @EQUAL
           UNPACK    SUBCODE,DIM3,KEY10          * Subsection code (w/o grps)
           MATCH     "zzzzzzzzzz",KEY10          * check for ABF Booked outpat
           IF        @EQUAL
             PACK      SUBDESC1,UNKMGRP,DIM3     * Default description
             PACK      KEY5,CODECL,DIM3          * Get the group code desc.
             CALL      RDCODE1
             IF        OVRCD=0
               MOVE      TDESC,SUBDESC1          * Save the description
               MOVE      "ABF Booked O/P",SUBDESC2
               PACK      SUBDCOD,OPNBRA,DIM3,CLSBRA
               GOTO      GETD9999
             ENDIF
           ELSE
             UNPACK    SUBCODE,DIM3,DIM1,KEY9
             MATCH     "yyyyyyyyy",KEY9
             IF        @EQUAL
               CALL      SYSD0000                * System breakdown
               GOTO      GETD9999
             ENDIF
           ENDIF
         ENDIF
.
.        Check to see if this is a totals record
.
         MATCH     SUBCODE,TILDA20                * Totals record ?
         GOTO      GETD0500 IF NOT EQUAL         * No.
.
.        Totals record. The description will be TOTAL, unless this
.        is the accommodation totals record
.
         MOVE      "TOTAL",SUBDESC1              * Totals description
.
.        Only sections 1 & 2 may have accommodation
.
         BRANCH    SECTION,GETD0100,GETD0120,GETD9999
         GOTO      GETD9999
.
.        Subsection 1 is the accommodation
.
GETD0100 BRANCH    SUBSECT,GETD0200,GETD0220,GETD0222:
                           GETD0242,GETD0250,GETD0252,GETD0230:
                           GETD0260,GETD0232,GETD0234,GETD0240
         GOTO      GETD9999
.
GETD0120 BRANCH    SUBSECT,GETD0300,GETD0310,GETD0320,GETD0390
.
         GOTO      GETD9999
.
.        Accommodation total description
.
GETD0200 MOVE      "TOTAL ACCOMMODATION",SUBDESC1 * Accommodation description
         GOTO      GETD9999
.
GETD0220 MOVE      "TOTAL CASEMIX FUND ACCOMM.",SUBDESC1 * Accom.description
         GOTO      GETD9999
.
GETD0222 MOVE      "TOTAL ITEMS",SUBDESC1 * description
         GOTO      GETD9999
.
GETD0230 MOVE      "TOTAL GST",SUBDESC1            * Total GST.description
         GOTO      GETD9999
.
GETD0232 MOVE      "TOTAL CASH RECEIVED",SUBDESC1  * Total cash description
         GOTO      GETD9999
.
GETD0234 MOVE      "TOTAL JOURNALS",SUBDESC1       * Total Journal description
         GOTO      GETD9999
.
GETD0240 MOVE      "TOTAL GST JOURNALS",SUBDESC1    * description
         GOTO      GETD9999
.
GETD0242 MOVE      "TOTAL CREDIT NOTES ACCOM.",SUBDESC1 * description
         GOTO      GETD9999
.
GETD0250 MOVE      "TOTAL C'MIX CRED.NOTE ACCOM.",SUBDESC1 * Accom.desc.
         GOTO      GETD9999
.
GETD0252 MOVE      "TOTAL CREDIT NOTE ITEMS",SUBDESC1 * desc.
         GOTO      GETD9999
.
GETD0260 MOVE      "TOTAL CREDIT NOTES GST",SUBDESC1 * description
         GOTO      GETD9999
.
GETD0300 MOVE      "TOTAL TO BE INVOICED ACCOM.",SUBDESC1 * description
         GOTO      GETD9999
.
GETD0310 MOVE      "TOTAL TOBE INVOICED C'MIX ACCM",SUBDESC1 * description
         GOTO      GETD9999
.
GETD0320 MOVE      "TOTAL TOBE INVOICED ITEMS",SUBDESC1 * description
         GOTO      GETD9999
.
GETD0390 MOVE      "TOTAL CASH RECEIVED",SUBDESC1 * description
         GOTO      GETD9999
.
.
.        We do different things depending on the currect section
.
GETD0500 BRANCH    SECTION,GETD1000,GETD1040,GETD3000
.
.        Section 1 & 2, Fee's Invoiced, & To Be Invoiced
.
GETD1000 BRANCH    SUBSECT,GETD1100,GETD1100,GETD1300:
                           GETD1100,GETD1100,GETD1300,GETD1050:
                           GETD1050,GETD1500,GETD1600,GETD1700
         GOTO      GETD1100
.
GETD1040 BRANCH    SUBSECT,GETD1100,GETD1100,GETD1300:
                           GETD1500
         GOTO      GETD1100
.
.        GST
.
GETD1050 MATCH     "1",PTCNFGST
         GOTO      GETD1070 IF EQUAL             * Group by Fincode
.
         COMPARE   ONE,CGLIND
         GOTO      GETD9999 IF NOT EQUAL
.
         PACK      SUBDESC1,SUBCODE,SP70         * Set to ledger
         COMPARE   ONE,PTCNUFMS
         GOTO      GETD9999 IF NOT EQUAL         * not using fms file
.
         PACK      KEY2,SUBCODE
         OPEN      FMSLMAA1,"fmslmaaf"
         CALL      RDFMLA1
         CLOSE     FMSLMAA1
         IF        OVRCD=0
           MOVE      "-",ANS
           PACK      SUBDESC1,SUBCODE,ANS,FMLADESC   * Ledger description
         ENDIF
         GOTO      GETD9999
.
.        Breakdown by Fincode
.
GETD1070 UNPACK    FINCODE,ANS
         REP       "T1P1M1Q1",ANS
         MATCH     "1",ANS
         GOTO      GETD1300 IF EQUAL      * Misc.GST
.
.        Accommodation (includes Maternity, O/P clinics & Goverment Subsidy)
.
GETD1100 RESET     SUBCODE 
         UNPACK    SUBCODE,ANS,DIM3,DIM4         * Seperate out the codes
.
         COMPARE   "12",SUBSECT
         GOTO      GETD2000 IF EQUAL             * Discount
         COMPARE   "14",SUBSECT
         GOTO      GETD2000 IF EQUAL             * Credit Note Discount
.
         COMPARE   "13",SUBSECT
         GOTO      GETD2100 IF EQUAL             * Rounding
         COMPARE   "15",SUBSECT
         GOTO      GETD2100 IF EQUAL             * Credit Note Rounding
.
         CMATCH    ANSA,ANS                      * Normal Accommodation
         GOTO      GETD1110 IF EQUAL
.
.         CMATCH    ANSB,ANS                      * Maternity Accommodation
.         GOTO      GETD1140 IF EQUAL
.
         CMATCH    ANSG,ANS                      * Government Subsidy
         GOTO      GETD1150 IF EQUAL
.
         CMATCH    ANSC,ANS                      * Lumpsum
         GOTO      GETD1160 IF EQUAL
.
         CMATCH    ANSD,ANS                      * Daily charge
         GOTO      GETD1165 IF EQUAL
.
         CMATCH    ANSO,ANS                      * Outpatient clinic
         GOTO      GETD1170 IF EQUAL
.
.        The following prefix(s) are for credit note
.
         CMATCH    ANSN,ANS
         GOTO      GETD1110 IF EQUAL             * Credit note accommodation
.
         CMATCH    ANSH,ANS                      * Lumpsum
         GOTO      GETD1160 IF EQUAL
.
         CMATCH    ANSJ,ANS                      * Daily charge
         GOTO      GETD1165 IF EQUAL
.
.        Should never get here, but just in case ...
.
GETD1106 MOVE      "UNKNOWN ACCOMMODATION CODE",SUBDESC1
.
         IF        IBCNUGST=2 & GSTFLAG=1 & SUBSECT=4
           GOTO      GETD1300                     * Check with Misc.
         ENDIF
         GOTO      GETD9999
.
.        Normal Accommodation record. Check to see if it is by admission type
.        or by ward/claim code (Use CACCFEE)
.
GETD1110 BRANCH    CACCFEE,GETD1120,GETD1125,GETD1130,GETD1133:
                           GETD1135             * Wrd/Claim/Adm?
.
.        Accommodation by admission type
.
         MOVE      SP20,TDESC
         PACK      KEY5,CODEA,DIM3              * Key for admission type
         CALL      RDCODE1                      * Read in the codes record
.
         PACK      SUBDESC1,ACCOMTL,TDESC       * Get the description
         GOTO      GETD9999
.
.        Accommodation by ward/claim
.
GETD1120 PACK      SUBDESC1,ACCOMTL,ACCTL1,DIM3,ACCTL2,DIM4
         GOTO      GETD9999
.
.        Accommodation by ward/admission type
.
GETD1125 UNPACK    SUBCODE,ANS,DIM3,DIM3A        * Seperate out the codes
         MOVE      SP20,TDESC
         PACK      KEY5,CODEA,DIM3A
         CALL      RDCODE1
.
         MOVE      SP30,SUBDESC1
         CLEAR     SUBDESC1
         APPEND    ACCOMTL,SUBDESC1
         APPEND    "Ward ",SUBDESC1
         APPEND    DIM3,SUBDESC1
         APPEND    "-",SUBDESC1
         APPEND    TDESC,SUBDESC1
         RESET     SUBDESC1
         GOTO      GETD9999
.
.        Accommodation by ward/claim/admission type
.
GETD1130 UNPACK    SUBCODE,ANS,DIM3A,DIM3B,DIM3C
.        MOVE      DIM3A,WWARD
.        PACK      SUBDESC1,ACCOMTL,ACCTL1,WWARD,SP1,ACCTL4,DIM3B,SP70
.        PACK      SUBDESC2,ACCTL7,DIM3C
.
         MOVE      SP20,TDESC
         PACK      KEY5,CODECL,DIM3B
         CALL      RDCODE1
.
         MOVE      SP30,SUBDESC1
         CLEAR     SUBDESC1
         APPEND    ACCOMTL,SUBDESC1
         APPEND    "Ward ",SUBDESC1
         APPEND    DIM3A,SUBDESC1
         APPEND    "-",SUBDESC1
         APPEND    TDESC,SUBDESC1
         RESET     SUBDESC1
.
         MOVE      SP20,TDESC
         PACK      KEY5,CODEA,DIM3C
         CALL      RDCODE1
.
         MOVE      SP20,SUBDESC2
         CLEAR     SUBDESC2
         APPEND    ACCTL7,SUBDESC2
         APPEND    TDESC,SUBDESC2
         RESET     SUBDESC2
.
         GOTO      GETD9999
.
.        Accomodation by  Ward/admission type/Claim type
.
GETD1133 UNPACK    SUBCODE,ANS,DIM3A,DIM3B,DIM3C
         PACK      SUBDESC1,ACCOMTL,ACCTL1,DIM3A,SP1,DIM3B,SP1,DIM3C
         GOTO      GETD9999
.
.        Accommodation by Claim type
.
GETD1135 MOVE      SP20,TDESC
         PACK      KEY5,CODECL,DIM3             * Key for Claim type
         CALL      RDCODE1                      * Read in the codes record
.
         PACK      SUBDESC1,ACCOMTL,TDESC       * Get the description
         GOTO      GETD9999
.
.        Maternity Accommodation
.
GETD1140 MOVE      DIM3,KEY3                     * Set up key for Mat. Rates
.        MOVE      SP20,MRDESC
.        OPEN      MATMRAT1,"matmratf"           * Open Maternity rates file
.        CALL      RDMRAT1                       * Read the rates record
.        CLOSE     MATMRAT1
.
.        PACK      SUBDESC1,ACCTL3,MRDESC,SP10   * Pack up description
         PACK      SUBDCOD,OPNBRA,DIM3,CLSBRA    * Pack up printed code
         GOTO      GETD9999
.
.        Government Subsidy
.
GETD1150 MOVE      "GOVERNMENT SUBSIDY",SUBDESC1
         GOTO      GETD9999
.
.        Lumpsum
.
GETD1160 UNPACK    SUBCODE,ANS,DIM1,DIM3,DIM3A  * Seperate out the codes
         MOVE      DIM1,FORM1
         MOVE      SP10,DIM8
         MOVE      MSO,DIM8
         MOVE      MSO,DIM3B1
         LOAD      DIM8,FORM1,SAMEDAY
         LOAD      DIM3B1,FORM1,SDAY
.
         PACK      TDESC,SP20
         IF        CACCFEE=5
           PACK      KEY5,ANSC,ANSL,DIM3
         ELSE
           PACK      KEY5,ANSA,SP1,DIM3
         ENDIF
         CALL      RDCODE1
.
         MOVE      SP30,SUBDESC1
         CLEAR     SUBDESC1
.
         MATCH     SP70,DIM3A
         IF        !@EQUAL
           IF        CACCFEE=4
             IF        EXPORTDE=1
               APPEND    "L/S:",SUBDESC1
               APPEND    DIM3B1,SUBDESC1
               APPEND    "-",SUBDESC1
               APPEND    TDESC,SUBDESC1
               APPEND    "-",SUBDESC2
               APPEND    DIM3A,SUBDESC2
               APPEND    SP70,SUBDESC2
               RESET     SUBDESC1
               RESET     SUBDESC2
               GOTO      GETD9999
             ELSE 
               APPEND    "L/S: ",SUBDESC1
               APPEND    DIM8,SUBDESC1
               APPEND    " - ",SUBDESC1
               UNPACK    TDESC,KEY10
               APPEND    KEY10,SUBDESC1
               APPEND    "-",SUBDESC1
               APPEND    DIM3A,SUBDESC1
               APPEND    SP70,SUBDESC1
               RESET     SUBDESC1
               GOTO      GETD9999
             ENDIF
           ENDIF
         ENDIF
.
         IF        EXPORTDE=1
           APPEND    "L/S:",SUBDESC1
           APPEND    DIM3B1,SUBDESC1
           APPEND    "-",SUBDESC1
           APPEND    TDESC,SUBDESC1
           RESET     SUBDESC1
         ELSE
           APPEND    "LUMP SUM: ",SUBDESC1
           APPEND    DIM8,SUBDESC1
           APPEND    " - ",SUBDESC1
           APPEND    TDESC,SUBDESC1
           RESET     SUBDESC1
         ENDIF
         GOTO      GETD9999
.
.        Daily charge
.
GETD1165 UNPACK    SUBCODE,ANS,DIM3,DIM3A  * Seperate out the codes
         MOVE      SP30,SUBDESC1
         CLEAR     SUBDESC1
         APPEND    DAILY,SUBDESC1
         IF        CACCFEE=5
           MOVE      SP20,TDESC
           PACK      KEY5,CODECL,DIM3             * Key for Claim type
           CALL      RDCODE1                      * Read in the codes record
           IF        OVRCD=0
             APPEND    TDESC,SUBDESC1        * Get the description
           ELSE
             APPEND    "Claim- ",SUBDESC1
             APPEND    DIM3,SUBDESC1
           ENDIF
         ELSE
           APPEND    "Ward - ",SUBDESC1
           APPEND    DIM3,SUBDESC1
           IF        CACCFEE=4
             MATCH     SP70,DIM3A
             IF        !@EQUAL
               APPEND    " - ",SUBDESC1
               APPEND    DIM3A,SUBDESC1
             ENDIF
           ENDIF
         ENDIF
         RESET     SUBDESC1
         GOTO      GETD9999
.
.        Clinic id
.
GETD1170 UNPACK    SUBCODE,ANS,DIM6,DIM3         * get parts of key
.
         PACK      CFNAME,DIM3,FILCLIA1          * file name for clinic file
         MOVE      ZERO,OVRCD                    * assume file exists
         TRAP      OVERCOND IF IO                * trap for open errors
         OPEN      OUTCLIA1,CFNAME               * open clinic id file
         TRAPCLR   IO                            * clear IO trap
         BRANCH    OVRCD,GETD1175
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY20,FINSITE,DIM6,KEY8
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     FINSITE,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ELSE
                MATCH     DIM6,OCACLIN
                IF        !@EQUAL
                  MOVE      ONE,OVRCD
                ENDIF
              ENDIF
            ENDIF
          ENDIF
         CLOSE     OUTCLIA1
         BRANCH    OVRCD,GETD1175                * no details
.
.        Set up default description
.
         PACK      SUBDESC1,ACCTL5,OCACLIN,SP1,OCADESC
.
.        If the name is not based on a doctor code, we have finished
.
         MATCH     SP6,OCADOCT                   * do we have a doctor code ?
         GOTO      GETD9999 IF EQUAL             * no, use clinic desc.
.
.        Get the doctors name
.
         OPEN      PATDO1A1,"patdo1af"                      * open doctors file
         MOVE      OCADOCT,KEY6
         CALL      RDDOCT1                       * get doctor record
         CLOSE     PATDO1A1
         BRANCH    OVRCD,GETD9999                * no doctor -> blank desc.
.
         MOVE      TWO,PACFRMT                   * format as surname,given name
         MOVE      DSNAME,PACSNAME
         MOVE      DGNAME,PACGNAME
         MOVE      DTITL,PACTITLE
         CALL      PACNAME
         PACK      SUBDESC1,ACCTL5,OCACLIN,SP1,PACFNAME
         GOTO      GETD9999
.
.        Missing file or missing code
.
GETD1175 MOVE      "UNKNOWN CLINIC CODE",OCADESC
         PACK      SUBDESC1,ACCTL5,DIM6,SP1,OCADESC
         GOTO      GETD9999
.
.        Miscellenaous Items (Includes theatre)
.
GETD1300 IF        CMXMSC <> ONE
           GOTO      GETD1305             * not a casemix miscellaneous
         ENDIF
.
         MOVE      ZERO,FORM1
         UNPACK    SUBCODE,ANS
         MOVE      ANS,FORM1
         IF        FORM1 = 0 | FORM1 = 1
           UNPACK    SUBCODE,ANS,DIM3,DIM9
           IF        FORM1 = 1
             MOVE      "Same Day        ",SUBDESC2
           ELSE
             MOVE      "MSO             ",SUBDESC2
           ENDIF
         ELSE
GETD1305   UNPACK    SUBCODE,DIM3,DIM9             * Unpack the subsection code
         ENDIF
.
         MATCH     GSTCODE,SUBCODE               * Goods & Services tax ?
         GOTO      GETD1360 IF EQUAL             * Yes.
.
         MATCH     "G",ANS
         IF        !@EQUAL
           COMPARE   ONE,PTCNMFEE                * Miscell. items by claim code
           GOTO      GETD1350 IF EQUAL           * Yes
         ENDIF
.
         MATCH     SP3,DIM3                      * Are we grouping misc codes ?
         GOTO      GETD1320 IF EQUAL             * No.
.
.        We have a grouping code. Get the description from the codes file
.
         PACK      SUBDESC1,UNKMGRP,DIM3         * Default description
.
         PACK      KEY5,CODEFI,DIM3              * Get the group code desc.
         CALL      RDCODE1
         BRANCH    OVRCD,GETD1307                * Code not found
         MOVE      TDESC,SUBDESC1                * Save the description
         GOTO      GETD1310
.
.      Check for a valid category PG for Private practice item (Emergency Event)
.
GETD1307 PACK      KEY5,ANSP,ANSG,DIM3           * Get the group code desc.
         CALL      RDCODE1
         BRANCH    OVRCD,GETD1310                * Code not found
         MOVE      TDESC,SUBDESC1                * Save the description
.
.        Pack up the printed code
.
GETD1310 PACK      SUBDCOD,OPNBRA,DIM3,CLSBRA
         GOTO      GETD9999
.
.        Pack up the printed code
.
GETD1320 PACK      SUBDCOD,OPNBRA,DIM9,CLSBRA
.
         PACK      SUBDESC1,UNKMISC,DIM9         * Default description
.
.        Code is numeric - check that it is a valid MBS item number
.
         PACK      KEY9,DIM9                     * Key for item file
         PACK      KEY17,KEY9,CURRDATE,SP70
         CALL      PATITMRD                      * Read the item file
         BRANCH    OVRCD,GETD1330                * Check for valid misc charge
         MOVE      IDESC,SUBDESC1                * Save the description
         GOTO      GETD9999
.
.        Get the description from the Misc charges file
.
GETD1330 MOVE      PTCNDCLM,MCLMCOD         * Claim code 0
         PACK      KEY29,MCLMCOD,SP6,SP3,DIM9,CURRDATE,SP10
         CALL      PATMCHRD                 * read Misc.Charges file 
         COMPARE   ZERO,EXIT
         GOTO      GETD1340 IF NOT EQUAL    * invalid Item
.
GETD1335 MOVE      MDESC,SUBDESC1                * Save the description
         GOTO      GETD9999
.
GETD1340 UNPACK    SP10,KEY4,KEY5
         UNPACK    KEY9,KEY4,KEY5
         MATCH     SP5,KEY5
         IF        @EQUAL
           OPEN      PATDGWA1,"patdgwaf"
           PACK      KEY7,KEY4,PTCNDGPV,SP10                          *I-137125
           CALL      RDPTDGW1               * Valid DRG code ?
           CLOSE     PATDGWA1
           IF        OVRCD<>1
             MOVE      "-",DIM1
             PACK      SUBDESC1,KEY4,DIM1,PTDWDESC     * Save the description
           ENDIF
         ENDIF
         GOTO      GETD9999
.
.        Get miscell charges claim code
.
GETD1350 MOVE      ONE,SUBUS2DS                  * Using 2nd description
         MOVE      SP10,DIM4
         IF        CMXMSC=1
           UNPACK    SUBCODE,ANS,DIM3,DIM9         * Unpack the subsection code
           MOVE      ZERO,FORM1
           MOVE      ANS,FORM1
           IF        FORM1 = 1
             MOVE      "DAY-",DIM4
           ELSE
             MOVE      "MSO-",DIM4
           ENDIF
         ELSE
           UNPACK    SUBCODE,DIM3,DIM9             * Unpack the subsection code
         ENDIF
.
         PACK      SUBDESC1,UNKCLCOD,SP1,OPNBRA,DIM3,CLSBRA  * Default desc.
.
         PACK      KEY5,CODECL,DIM3
         CALL      RDCODE1
         IF        OVRCD<>1
           PACK      SUBDESC1,TDESC,SP1,OPNBRA,DIM3,CLSBRA
         ENDIF
.
         UNPACK    DIM9,DIM3,DIM5
         COMPARE   ONE,PTCNMFEE                  * Are we grouping misc codes ?
         GOTO      GETD1354 IF NOT EQUAL
.
         MATCH     SP4,DIM4
         IF        @EQUAL
           MATCH     SP70,DIM3
           IF        @EQUAL
             PACK      SUBDESC2,SP70         * ABF Charges have NO item grp
           ELSE
             PACK      SUBDESC2,UNKMGRP,SP1,OPNBRA,DIM3,CLSBRA * Default desc.
           ENDIF
         ELSE
           PACK      SUBDESC2,DIM4,UNKMGRP,SP1,OPNBRA,DIM3,CLSBRA 
         ENDIF
.
         PACK      KEY5,CODEFI,DIM3            * Get the group code desc.
         CALL      RDCODE1
         IF        OVRCD<>1
           MATCH     SP4,DIM4
           IF        @EQUAL
             MATCH     SP70,DIM3
             IF        @EQUAL
               PACK      SUBDESC2,SP70         * ABF Charges have NO item grp
             ELSE
               PACK      SUBDESC2,TDESC,SP1,OPNBRA,DIM3,CLSBRA
             ENDIF
           ELSE
             PACK      SUBDESC2,DIM4,TDESC,SP1,OPNBRA,DIM3,CLSBRA
           ENDIF
         ELSE
           GOTO      GETD1354
         ENDIF
.
         GOTO      GETD9999
.
GETD1354 MATCH     SP4,DIM4
         IF        @EQUAL
           PACK      SUBDESC2,UNKMISC,SP1,DIM9 * Default desc.
         ELSE
           PACK      SUBDESC2,DIM4,UNKMISC,SP1,DIM9 * Default desc.
         ENDIF
.
         PACK      KEY9,DIM9                   * Key for item file
         PACK      KEY17,KEY9,CURRDATE,SP70
         CALL      PATITMRD                    * Read the item file
         BRANCH    OVRCD,GETD1355
.
         MOVE      IDESC,DIM30
         CALL      FTDS0000                  * Format description
         MATCH     SP4,DIM4
         IF        @EQUAL
           PACK      SUBDESC2,DIM30
         ELSE
           PACK      SUBDESC2,DIM4,DIM30
         ENDIF
.
         GOTO      GETD9999
.
GETD1355 MOVE      "0  ",MCLMCOD             * Claim code 0
         PACK      KEY29,MCLMCOD,SP6,SP3,DIM9,CURRDATE,SP10
         CALL      PATMCHRD                 * read Misc.Charges file 
         COMPARE   ZERO,EXIT
         GOTO      GETD1367 IF NOT EQUAL    * invalid Item
.
GETD1366 MOVE      MDESC,DIM30
         CALL      FTDS0000                * Format description
         MATCH     SP4,DIM4
         IF        @EQUAL
           PACK      SUBDESC2,DIM30
         ELSE
           PACK      SUBDESC2,DIM4,DIM30
         ENDIF
.
         GOTO      GETD9999
.
GETD1367 UNPACK    SP10,KEY4,KEY5
         UNPACK    KEY9,KEY4,KEY5
         MATCH     SP5,KEY5
         IF        @EQUAL
           OPEN      PATDGWA1,"patdgwaf"
           PACK      KEY7,KEY4,PTCNDGPV,SP10                          *I-137125
           CALL      RDPTDGW1                * Valid DRG code ?
           CLOSE     PATDGWA1
           IF        OVRCD<>1
             MOVE      "-",DIM1
             PACK      DIM30,KEY4,DIM1,PTDWDESC
             CALL      FTDS0000              * Format description
             IF        @EQUAL
               PACK      SUBDESC2,DIM30
             ELSE
               PACK      SUBDESC2,DIM4,DIM30
             ENDIF
           ENDIF
         ENDIF
         GOTO      GETD9999
.
.        Goods & services tax
.
GETD1360 MOVE      "GOODS & SERVICES TAX",SUBDESC1
         MOVE      SP30,SUBDCOD
         GOTO      GETD9999
.
.        Cash received. Find out what type of receipt it is.
.
GETD1500 MOVE      SP30,SUBDESC1                 * Initialise description
         MOVE      SP30,SUBDCOD                  * Initialise printed code
.
         CMATCH    ANSA,SUBCODE                  * Patient Cash
         GOTO      GETD1510 IF EQUAL
.
         CMATCH    ANSB,SUBCODE                  * Health Fund cash
         GOTO      GETD1520 IF EQUAL
.
         CMATCH    ANSC,SUBCODE                  * Government subsidy cash
         GOTO      GETD1530 IF EQUAL
.
         CMATCH    ANSD,SUBCODE                  * Deposits received
         GOTO      GETD1540 IF EQUAL
.
         CMATCH    ANSE,SUBCODE                 * Eclipse Health Fund/Claim cash
         GOTO      GETD1522 IF EQUAL
.
         CMATCH    ANSI,SUBCODE                  * Insurance company cash
         GOTO      GETD1550 IF EQUAL
.
         CMATCH    ANSM,SUBCODE                  * Merchant card cash
         GOTO      GETD1560 IF EQUAL
.
         GOTO      GETD9999
.
.        Patient cash
.
GETD1510 MOVE      "PATIENT",SUBDESC1
         GOTO      GETD9999
.
.        Health Fund cash
.
GETD1520 UNPACK    SUBCODE,ANS,KEY6              * Extract the health fund code
         MATCH     SP6,KEY6                      * blank code ?
         GOTO      GETD1525 IF EQUAL
.
.        Set up the default health fund cash description
.
         CLEAR     HFNAME
         APPEND    "UNKNOWN H.F. CODE ",HFNAME
         APPEND    KEY6,HFNAME
         RESET     HFNAME
.
         PACK      KEY14,KEY6,FOUR0,SP10
.
         OPEN      PATFN1A1,"patfn1af"
         CALL      RDFUND1                       * Read in the health fund
         MOVE      HFNAME,SUBDESC1               * Save the description
         GOTO      GETD9999
.
.        Eclipse payment
.
GETD1522 MOVE      "ECLIPSE HEALTH FUND",SUBDESC1
.
.        Get the health fund code
.
         UNPACK    SUBCODE,ANS,KEY1
         MOVE      "ECLIPSE",SUBDESC1
         CMATCH    ANSH,KEY1              * Health fund paymen
         IF        @EQUAL
.
.        Set the default description for the health fund code
.
           UNPACK    SUBCODE,ANS,KEY1,HCODE
           CLEAR     HFNAME
           APPEND    "UNKNOWN HEALTH FUND ",HFNAME
           APPEND    HCODE,HFNAME
           RESET     HFNAME
.
           PACK      KEY14,HCODE,ZERO,ZERO,ZERO,ZERO,SP20
           OPEN      PATFN1A1,"patfn1af"
           CALL      RDFUND1                       * Read in the health fund
           MOVE      HFNAME,SUBDESC2
         ELSE
.
.        Set the default description for the claim codecode
.
           UNPACK    SUBCODE,ANS,KEY1,ACODE
           CLEAR     TDESC
           APPEND    "UNKNOWN CLAIM CODE",TDESC
           APPEND    ACODE,TDESC
           RESET     TDESC
.
           PACK      KEY5,ANSC,ANSL,ACODE
           CALL      RDCODE1
           MOVE      TDESC,SUBDESC2
         ENDIF
         GOTO      GETD9999
.
GETD1525 MOVE      "HEALTH FUND",SUBDESC1
         GOTO      GETD9999
.
.        Government Subsidy cash
.
GETD1530 MOVE      "GOVERNMENT SUBSIDY",SUBDESC1
         GOTO      GETD9999
.
.        Deposit received
.
GETD1540 UNPACK    SUBCODE,ANS,DIM3,DIM4         * Extract the deposit code
.
.        Set up the default deposit description
.
         CLEAR     TDESC
         APPEND    "UNK DEPOSIT CODE ",TDESC
         APPEND    DIM3,TDESC
         RESET     TDESC
.
         PACK      KEY5 WITH CODEDP,DIM3         * Pack up key for deposit code
         CALL      RDCODE1                       * Read in codes file record
         MOVE      TDESC,SUBDESC1                * Save the description
         GOTO      GETD9999
.
.        Insurance company cash
.
GETD1550 UNPACK    SUBCODE,ANS,KEY6              * Extract the Ins Company code
.
.        Set up the default insurance cash description
.
         CLEAR     INAME
         APPEND    "UNKNOWN INSURANCE CODE ",INAME
         APPEND    KEY6,INAME
         RESET     INAME
.
         OPEN      PATIN1A1,"patin1af"            * Open the insurance file
         CALL      RDINSR1                       * Read in the insurance record
         CLOSE     PATIN1A1                      * Close the insurance file
         MOVE      INAME,SUBDESC1                * Save the description
         GOTO      GETD9999
.
.        Merchant card cash receipt
.
GETD1560 UNPACK    SUBCODE,ANS,DIM3,DIM4         * Extract the merchant code
.
         CALL      MRCH0000                      * Get the merchant card desc.
         MOVE      TDESC,SUBDESC1                * Save the description
         GOTO      GETD9999
.
.        Journals
.
GETD1600 MATCH     GSTCODE,SUBCODE               * GST code ?
         GOTO      GETD1660 IF EQUAL             * yes, special description
.
         COMPARE   ONE,PTCNJFEE                  * Journals by claim code ?
         GOTO      GETD1650 IF EQUAL             * Yes
.
         UNPACK    SUBCODE,DIM2,DIM3,DIM4        * Extract the journal code
.
.        If DIM3 if non-blank, then this is a Merchant Card
.
         MATCH     SP3,DIM3                      * Merchant code ?
         GOTO      GETD1610 IF EQUAL             * No.
.
         MATCH     "WJ",DIM2                     * Merchant card journal ?
         GOTO      GETD1620 IF EQUAL             * Yes.
.
         MATCH     "WC",DIM2                     * Merchant card commission ?
         GOTO      GETD1630 IF EQUAL             * Yes.
.
.        Normal journal
.
GETD1610 MOVE      "UNKNOWN JOURNAL TYPE",TDESC  * Default description
.
         PACK      KEY5,CODEJ,DIM2,SP1           * Key for journal code
         CALL      RDCODE1                       * Read in codes file record
         MOVE      TDESC,SUBDESC1                * Save the description
.
         PACK      SUBDCOD,OPNBRA,DIM2,CLSBRA    * Pack up printed code
         GOTO      GETD9999
.
.        Merchant card journal
.
GETD1620 MOVE      " - JOURNAL   ",DIM13
         GOTO      GETD1640
.
.        Merchant card commission
.
GETD1630 MOVE      " - COMMISSION",DIM13
.
.        Get the merchant card description
.
GETD1640 CALL      MRCH0000                      * Get the merchant card desc.
         MOVE      TDESC,DIM19                   * Shorten description
         PACK      SUBDESC1,DIM19,DIM13          * Pack up subsection desc.
         GOTO      GETD9999
.
.        Get journal claim code description
.
GETD1650 MOVE      ONE,SUBUS2DS                  * Using 2nd description
         UNPACK    SUBCODE,DIM3,DIM2,DIM8
         PACK      SUBDESC1,UNKCLCOD,SP1,OPNBRA,DIM3,CLSBRA     * Default desc.
.
         MATCH     SP3,DIM3
         GOTO      GETD1655 IF EQUAL             * No claim code set up
.
         PACK      KEY5,CODECL,DIM3              * Key for journal code
         CALL      RDCODE1                       * Read in codes file record
         IF        OVRCD<>1
           PACK      SUBDESC1,TDESC,SP1,OPNBRA,DIM3,CLSBRA
         ENDIF
.
GETD1655 PACK      SUBDESC2,UNKJOUR,SP1,OPNBRA,DIM2,SP1,CLSBRA  * Default desc.
.
         MATCH     SP2,DIM2
         GOTO      GETD9999 IF EQUAL             * No journal code set up
.
         PACK      KEY5,CODEJ,DIM2,SP1           * Key for journal code
         CALL      RDCODE1                       * Read in codes file record
         IF        OVRCD<>1
           PACK      SUBDESC2,TDESC,SP1,OPNBRA,DIM2,SP1,CLSBRA
         ENDIF
.
         GOTO      GETD9999
.
GETD1660 MOVE      "GST DISCOUNT ADJUSTMENT",SUBDESC1
         GOTO      GETD9999
.
.        GST Journal
.
GETD1700 MOVE      SP30,SUBDESC1                 * Initialise description
         MOVE      SP30,SUBDCOD                  * Initialise printed code
         COMPARE   ONE,CGLIND
         GOTO      GETD1600 IF NOT EQUAL         * No G/L interface
.
         PACK      SUBDESC1,SUBCODE,SP70         * Set to ledger 
         COMPARE   ONE,PTCNUFMS
         GOTO      GETD9999 IF NOT EQUAL         * not using fms file
.
         PACK      KEY2,SUBCODE
         OPEN      FMSLMAA1,"fmslmaaf"
         CALL      RDFMLA1
         CLOSE     FMSLMAA1
         IF        OVRCD=0
           MOVE      "-",ANS
           PACK      SUBDESC1,SUBCODE,ANS,FMLADESC   * Ledger description
         ENDIF
         GOTO      GETD9999
.
GETD2000 IF        PTCNMFEE=1
           UNPACK    SUBCODE,DIM3,DIM3A        * Seperate out the codes
         ELSE
           UNPACK    SUBCODE,DIM3A             * Seperate out the codes
         ENDIF
         GOTO      GETD2200
.
GETD2100 UNPACK    SUBCODE,DIM3A             * Seperate out the codes
.
GETD2200 PACK      KEY5,CODEFI,DIM3A           * Get the group code desc.
         CALL      RDCODE1
         IF        OVRCD<>1
           PACK      SUBDESC1,TDESC,SP1,OPNBRA,DIM3A,CLSBRA
         ENDIF
         GOTO      GETD9999
.
.        Section 3, Merchant Cards
.
GETD3000 BRANCH    SUBSECT,GETD3100,GETD3200,GETD3300,GETD3400
.
.        Claimed
.
GETD3100 MOVE      "CLAIMED    - ",DIM13
         GOTO      GETD3800
.
.        Cash Received
.
GETD3200 MOVE      "RECEIVED   - ",DIM13
         GOTO      GETD3800
.
.        Commission
.
GETD3300 MOVE      "COMMISSION - ",DIM13
         GOTO      GETD3800
.
.        Journals
.
GETD3400 MOVE      "JOURNALS   - ",DIM13
.
.        Get the description for the merchant card, and append to the header
.
GETD3800 MOVE      SUBCODE,DIM3                  * Extract merchant code
         CALL      MRCH0000                      * Get the description
         PACK      SUBDESC1,DIM13,TDESC          * Save the subsection desc
         GOTO      GETD9999
.
GETD9999 RETURN
.
.        ======================================================================
.        FTDS0000: Format the miscell charges description
.        ======================================================================
.
FTDS0000 ENDSET    DIM30
FTDS1000 CMATCH    SP1,DIM30
         GOTO      FTDS2000 IF NOT EQUAL
.
         BUMP      DIM30,-1
         GOTO      FTDS1000 IF NOT EOS
.
         CLEAR     DIM30
         GOTO      FTDS3000
.
FTDS2000 APPEND    SP1,DIM30
FTDS3000 APPEND    DIM9,DIM30                    * Move item to description
         RESET     DIM30
FTDS9999 RETURN
.
.        ======================================================================
.        MRCH0000: Get the merchant card description
.        ======================================================================
.
MRCH0000 CLEAR     TDESC
         APPEND    "UNK MERCH CODE ",TDESC
         APPEND    DIM3,TDESC
         RESET     TDESC
.
         PACK      KEY5 WITH MCCODE,DIM3         * Pack up the merch. code key
         CALL      RDCODE1                       * Read the codes file record
MRCH9999 RETURN
+
.        ======================================================================
.        CTBI0000: Subroutine to loop over all admissions and calculate
.        the grand total of all invoices still to be issued. This data will be
.        put into the temporary file openned up on PATFINS 
.        ======================================================================
.
CTBI0000 MOVE       ZERO,DISPROG                 * Flag required by CALCTBI
.
         DISPLAY    *P1:24,*EL:
                    "Calculating Total Amount Still to be Invoiced.":
                    *P48:24,*EL,"Billing No :";
.
.        Loop over Admissions with invoices pending
.
         MOVE       SP8,KEY8                     * Loop over all pending No.'s
         CALL       RDSIPEN1
CTBI1000 CALL       RDKIPEN1                     * Get next invoice pending adm
         BRANCH     OVRCD,CTBI9999               * Nothing left to process
.
         DISPLAY    *P61:24,*EL,*V2LON,IPADMNO;  * Display number on screen
         MOVE       ZERO,CASHFLAG                * Flag required by CALCTBI
.
.        Check for a valid system
.
         COMPARE   FSTSYS,IPSYSTM
         GOTO      CTBI1000 IF LESS
.
         COMPARE   IPSYSTM,FEDSYS
         GOTO      CTBI1000 IF LESS
.
.        Check for a valid site
.
         MATCH     FSTSITE,IPSITE
         GOTO      CTBI1000 IF LESS
.
         MATCH     IPSITE,FEDSITE
         GOTO      CTBI1000 IF LESS
.
         IF        HOSPFLAG=1
           PACK      KEY8,IPADMNO,SP8
           CALL      RDPMVX11
           BRANCH    OVRCD,CTBI1000
           MATCH     PMVXMHOS,HOSPID
           GOTO      CTBI1000 IF NOT EQUAL
         ENDIF
.
.        Calculate the amount to be invoiced - different for each system
.
         BRANCH     IPSYSTM,CTBI4000,CTBI3000,CTBI2000,CTBI3000,CTBI1000
.
.        Inpatient to be invoiced
.
CTBI2000 MOVE       IPADMNO,KEY8
         CALL       RDMISS1                      * Read in the admision record
         BRANCH     OVRCD,CTBI9200
.
         MOVE       IPADMNO,KEY8
         CALL       RDVISA1                      * Read in the visit record
         BRANCH     OVRCD,CTBI9200
.
         MOVE       AURNO,KEY8
         CALL       RDMAST1                      * Read in the PMI record
         BRANCH     OVRCD,CTBI9100
.
         MOVE       ZERO,SAVETRN
.
.        Check to see if the patient is discharged yet
.
         MOVE       ONE,DISFLG                   * Assume no discharge record
         CALL       CLPATDSC                     * Clear Disc.record
.
         COMPARE    THREE,ASTAT
         GOTO       CTBI2200 IF NOT EQUAL
.
         MOVE       ZERO,DISFLG                  * Patient is discharged
.
         MOVE       AADMNO,KEY8
         CALL       RDDSCH1                      * Read in the discharge record
         BRANCH     OVRCD,CTBI1000
.
.        PROGFLAG=4 means calculate the amount to be invoiced, and put the
.        figures into the file openned on PATFINS, but don't actually produce
.        the invoice.
.
CTBI2200  CALL       ISBITEMS                   * Update item for Ind.Serv.Bill?
.
          MOVE       FOUR,PROGFLAG
          OPEN      PATDO1A1,"patdo1af"
         IF         IBCNUGST=2 | IBCNUGST=3
           MOVE       ZERO,IBCNUGST           * Set to No GST for to be invoiced
           CALL       CALCTBI                 * Calculate the amt to invoice
           READ       CONTROLF,ZERO;*85,IBCNUGST
         ELSE
           CALL       CALCTBI                   * Calculate the amt to invoice
         ENDIF
         CLOSE     PATDO1A1
         IF         PTCNPFID = 1
           ADD        NETTOT,TOTAMTS
           PRINT      *1,VISTYP,"  ",IPADMNO,*20,NETTOT,*40,TOTAMTS:
                      "C/P=",PTMICMXP," CLM=",ACLAIM," HF=",AFUNDH,SLASH,AFNDTB
         ENDIF
.
         GOTO       CTBI1000
.
.        Outpatient to be invoiced
.
CTBI3000 MOVE       IPADMNO,PVIBILL
         MOVE       PVIBILL,KEY8
         CALL       RDVISA1                      * Read in the visit record
         BRANCH     OVRCD,CTBI9200
.
         COMPARE    FOUR,IPSYSTM
         GOTO       CTBI3500 IF NOT EQUAL
.
.        Other financial 
.
         MOVE       "out",OSTFILE
         MOVE       PVIURNO,AURNO
         GOTO       CTBI3600
.
CTBI3500 CALL       GETB0000                     * Get the booking file record
         BRANCH     OVRCD,CTBI9200               * Couldn't find it
.
         MOVE       OBAURNO,AURNO
.
CTBI3600 MOVE       AURNO,KEY8
         CALL       RDMAST1                      * Read in the PMI record
         BRANCH     OVRCD,CTBI9100
.
         CLOSE      OUTDTRO1
         PACK       CFNAME,OSTFILE,FILDTRO1
         OPEN       OUTDTRO1,CFNAME
         PACK       CFNAME,OSTFILE,FILBB1A1
         CALL       OPOTBB11
.
.        PROGFLAG=4 means calculate the amount to be invoiced, and put the
.        figures into the file openned on PATFINS, but don't actually produce
.        the invoice.
.
         PACK       PINVDTE,CCC,CYY,CMM,CDD
         REP        " 0",PINVDTE
.
         MOVE       FOUR,PROGFLAG
         MOVE       IPADMNO,OTNUMB 
         IF         IBCNUGST=2 | IBCNUGST=3
           MOVE       ZERO,IBCNUGST           * Set to No GST for to be invoiced
           CALL       OUTTBI                     * Calculate the amt to invoice
           READ       CONTROLF,ZERO;*85,IBCNUGST
         ELSE
           CALL       OUTTBI                     * Calculate the amt to invoice
         ENDIF
         IF         PTCNPFID = 1
           ADD        NETTOT,TOTAMTS
           PRINT      *1,VISTYP,"  ",IPADMNO,*20,NETTOT,*40,TOTAMTS
         ENDIF
.
         GOTO       CTBI1000
.
.        A + E to be invoiced
.
CTBI4000 MOVE       IPADMNO,PVIBILL
         MOVE       PVIBILL,KEY8
         CALL       RDVISA1                      * Read in the visit record
         BRANCH     OVRCD,CTBI9200
.
         COMPARE    NINE,PVITYPE
         GOTO       CTBI5000 IF NOT EQUAL
.
         MOVE       PVIURNO,ADAURNO
         MOVE       PVIBILL,ADANUMB
         MATCH      " 1",PVISYST
         GOTO       CTBI5000 IF NOT EQUAL        * not an event
.
         MOVE       PVIBILL,KEY8
         CALL       RDPMEVT1
         BRANCH     OVRCD,CTBI5000
.
         PACK       KEY5,ANSE,ANSV,PMEVEVNT,SP70
         CALL       RDCODE1
         BRANCH     OVRCD,CTBI5000
         MATCH      ANSE,TCINDC1
         GOTO       CTBI5200 IF EQUAL            * Emergency event
.
CTBI5000 MOVE       PVIBILL,KEY8
         CALL       RDDETA1                      * Read in the A+E details
         BRANCH     OVRCD,CTBI9200
.
CTBI5200 MOVE       ADAURNO,AURNO
         MOVE       AURNO,KEY8
         CALL       RDMAST1                      * Read in the PMI record
         BRANCH     OVRCD,CTBI9100
.
.        PROGFLAG=4 means calculate the amount to be invoiced, and put the
.        figures into the file openned on PATFINS, but don't actually produce
.        the invoice.
.
         PACK       PINVDTE,CCC,CYY,CMM,CDD
         REP        " 0",PINVDTE
.
         MOVE       FOUR,PROGFLAG
         IF         IBCNUGST=2 | IBCNUGST=3
           MOVE       ZERO,IBCNUGST           * Set to No GST for to be invoiced
           CALL       AAETBI                  * Calculate the amt to invoice
           READ       CONTROLF,ZERO;*85,IBCNUGST
         ELSE
           CALL       AAETBI                  * Calculate the amt to invoice
         ENDIF
         IF         PTCNPFID = 1
           ADD        NETTOT,TOTAMTS
           PRINT      *1,VISTYP,"  ",IPADMNO,*20,NETTOT,*40,TOTAMTS
         ENDIF
         GOTO       CTBI1000
.
CTBI9100 
.        DISPLAY    *P1:24,*B,*EL,"Admission No ",IPADMNO:
.                   " has Invalid U/R No ",AURNO,".  ",*W2;
.
.        DISPLAY    *P1:24,*EL:
.                   "Calculating Total Amount Still to be Invoiced.":
.                   *P48:24,*EL,"Billing No :";
         GOTO       CTBI1000
.
CTBI9200 
.        DISPLAY    *P1:24,*B,*EL,"Invalid Admission No ",IPADMNO:
.                   " in Invoices Pending File. ",*W2;
.
.        DISPLAY    *P1:24,*EL:
.                   "Calculating Total Amount Still to be Invoiced.":
.                   *P48:24,*EL,"Billing No :";
         GOTO       CTBI1000
.
CTBI9999 RETURN
+
.        ======================================================================
.        GETB0000: Locate Booking Record given the Visit file details
.        ======================================================================
.
GETB0000 MOVE       ZERO,OVRCD
.
         MOVE       "out",OSTFILE
         MOVE       PVISITE,KEY6
         CALL       RDSITA1                      * Get the site prefix
.
         PACK       CFNAME,OSTFILE,FILBB1A2
         CALL       OPOTBB12
.
         PACK       KEY16,PVIDATE,PVIBILL
         CALL       RDBOKB2
         COMPARE    ZERO,OVRCD
         GOTO       GETB3000 IF EQUAL
         GOTO       GETB9999
.
GETB3000 MOVE       PVIURNO,OBAURNO
         MOVE       PVISITE,OBASITE
         CLOSE     OUTBB1A2
GETB9999 RETURN
.
.        ======================================================================
.        GETC0000: Get the cash payments pending
.        ======================================================================
.
GETC0000 MOVE      "B",FINTYPE                   * Cash received section
         OPEN      COMDEPA7,"comdepaf"
         OPEN      RCPDTEA1,"rcpdteaf"
         OPEN      BOKRC1A1,"bokrc1af"
.
         MOVE      "0",CMDESTAT
         PACK      KEY26,CMDESTAT,SP70           * Read from start of file
         CALL      RSCMDEP7
GETC1000 CALL      RKCMDEP7                      * Read next record
         BRANCH    OVRCD,GETC9000                * Finished file
.
         MATCH     "0",CMDESTAT                  * Deposit held?
         GOTO      GETC9000 IF NOT EQUAL
.
         MATCH     SP70,CMDEADMN
         GOTO      GETC1000 IF EQUAL
.
         PACK      KEY8,CMDEADMN,SP8
         CALL      RDPMVX11
         COMPARE   ZERO,OVRCD
         GOTO      GETC1010 IF EQUAL
.
.        Check for booking
.
         CALL      RDBKREC1
         BRANCH    OVRCD,GETC1000
.
         MOVE      CMDEADMN,PVIBILL
         MOVE      THREE,CMDESYST          * Inpatient
         MOVE      SP6,PVISITE
.
         COMPARE   ONE,HOSPFLAG
         GOTO      GETC1100 IF NOT EQUAL
.
         PACK      KEY6,BKREWARD,SP70
         CALL      RDWARD1
         BRANCH    OVRCD,GETC1000
.
         MATCH     PTWDHOSN,HOSPID
         GOTO      GETC1000 IF NOT EQUAL   * Not same hospital
         GOTO      GETC1100
.
GETC1010 IF        HOSPFLAG=1
           MATCH     PMVXMHOS,HOSPID
           GOTO      GETC1000 IF NOT EQUAL
         ENDIF
.
         BRANCH    CMDESYST,GETC1020,GETC1020,GETC1020
         GOTO      GETC1000
.
.        Read in the visit file record
.
GETC1020 MOVE      CMDEADMN,PVIBILL
         MOVE      PVIBILL,KEY8
         CALL      RDVISA1
         COMPARE   ZERO,OVRCD
         GOTO      GETC1100 IF EQUAL
.
.        No visit record, it could be a pre-admission patient
.
         MOVE      CMDEADMN,KEY8
         CALL      RDMISS1
         BRANCH    OVRCD OF GETC1000
.
         COMPARE   ONE,ASTAT
         GOTO      GETC1000 IF NOT EQUAL
.
         MOVE      CMDEADMN,PVIBILL
         MOVE      THREE,PVITYPE                 * Inpatient
         MOVE      SP6,PVISITE
.
.        Check for a valid system
.
GETC1100 COMPARE   FSTSYS,PVITYPE
         GOTO      GETC1000 IF LESS
.
         COMPARE   PVITYPE,FEDSYS
         GOTO      GETC1000 IF LESS
.
.        Check for a valid site
.
         IF        PVITYPE = TWO
           MATCH     FSTSITE,PVISITE
           GOTO      GETC1000 IF LESS
.
           MATCH     PVISITE,FEDSITE
           GOTO      GETC1000 IF LESS
         ENDIF
.
.        Read receipt details
.
         PACK      KEY17,CMDERECN,CMDETCNT
         CALL      RDRCDTE1
         BRANCH    OVRCD,GETC1000
.
         PACK      FINCODE WITH ANSD,CMDEDTYP,SP70 * Deposit
.
.        Post this payment to the temporary fee's invoiced file
.
GETC2100 UNPACK    SP70,FININVN,FINADMN,FINURNO
         PACK      FINDATE,CCC,CYY,CMM,CDD
         REP       " 0",FINDATE
         MOVE      PVITYPE,FINSYS
         IF        PVITYPE = TWO
           MOVE      PVISITE,FINSITE
         ELSE
           MOVE      SP6,FINSITE
         ENDIF
         MOVE      RCDTAMNT,FINAMT
         MOVE      PMVXMHOS,FINHOSP
         CALL      PATCALF
         IF        PTCNPFID = 1
           ADD        FINAMT,TOTAMTS
           PRINT      *1,CMDEADMN,*20,FINAMT,*40,TOTAMTS
         ENDIF
.
         GOTO      GETC1000
.
GETC9000 CLOSE     COMDEPA7
         CLOSE     RCPDTEA1
.
         RETURN
+
.        ======================================================================
.        INDZ0000: Create a temporary index file with the PATFINS format
.        ======================================================================
.
INDZ0000 CALL      KILL0000                      * Delete the file first
         CLOSE     PATFINS1                    * Make sure the file is closed
         CLOSE     PATFINS2                    * Make sure the file is closed
.
         PACK      CMDLINE,SP70
         CLEAR     CMDLINE
         APPEND    "isbuild ",CMDLINE
         APPEND    FNAMEI,CMDLINE
         APPEND    " 156 UC1-1,2-7,8-11,12-12,13-25,146-148",CMDLINE
         APPEND    " UC146-148,1-1,2-7,8-11,12-12,13-25",CMDLINE
         APPEND    SP70,CMDLINE
         RESET     CMDLINE
         EXECUTE   CMDLINE,TASKID
.
         OPEN      PATFINS1,FNAMEI               * Open temp file as PATFINS
         OPEN      PATFINS2,FNAMEI               * Open temp file as PATFINS
.
INDZ9999 RETURN
.
.        ======================================================================
.        KILL0000: Deleting an indexed file based on port
.        ======================================================================
.
KILL0000 CLEAR     CMDLINE
         APPEND    "iserase ",CMDLINE
         APPEND    FNAMEI,CMDLINE
         RESET     CMDLINE
         EXECUTE   CMDLINE,TASKID
.
         RETURN
.
KILT0000 CLOSE      TMPFILE1
         CLEAR      CMDLINE
         APPEND     "iserase ",CMDLINE
         APPEND     FNAMET,CMDLINE
         RESET      CMDLINE
         EXECUTE    CMDLINE,TASKID               * Delete the work file
.
         CLOSE      TEMPFILE
         CLEAR      CMDLINE
         APPEND     "iserase ",CMDLINE
         APPEND     FNAMEW,CMDLINE
         RESET      CMDLINE
.
         CLOSE      TMPFILE2
         CLEAR      CMDLINE
         APPEND     "iserase ",CMDLINE
         APPEND     FNAMEM,CMDLINE
         RESET      CMDLINE
         EXECUTE    CMDLINE,TASKID               * Delete the work file
.
KILL9999 RETURN
+
.        ======================================================================
.        I/O routines for the work file
.        ======================================================================
.
RDSWORK  READ      TEMPFILE,KEY16;;
         RETURN
.
RDWORK   MOVE      ZERO,OVRCD
         READ      TEMPFILE,KEY16;DSECTION,DSUBSECT,SUBCODE,SUBDESC1,SUBDCOD:
                                  SUBDESC2,SUBUS2DS,XSUBPER,XSUBYTD,XSUBPRY:
                                  XSUBM01,XSUBM02,XSUBM03,XSUBM04,XSUBM05:
                                  XSUBM06,XSUBM07,XSUBM08,XSUBM09,XSUBM10:
                                  XSUBM11,XSUBM12,XSUBM13
         GOTO      OVERCOND IF OVER
         MOVE      DSECTION,SECTION
         MOVE      DSUBSECT,SUBSECT
.
         MOVE      XSUBPER,SUBPER
         MOVE      XSUBYTD,SUBYTD
         MOVE      XSUBPRY,SUBPRY
         MOVE      XSUBM01,SUBM01
         MOVE      XSUBM02,SUBM02
         MOVE      XSUBM03,SUBM03
         MOVE      XSUBM04,SUBM04
         MOVE      XSUBM05,SUBM05
         MOVE      XSUBM06,SUBM06
         MOVE      XSUBM07,SUBM07
         MOVE      XSUBM08,SUBM08
         MOVE      XSUBM09,SUBM09
         MOVE      XSUBM10,SUBM10
         MOVE      XSUBM11,SUBM11
         MOVE      XSUBM12,SUBM12
         MOVE      XSUBM13,SUBM13
         RETURN
.
RDKWORK  MOVE      ZERO,OVRCD
         READKS    TEMPFILE;DSECTION,DSUBSECT,SUBCODE,SUBDESC1,SUBDCOD:
                            SUBDESC2,SUBUS2DS,XSUBPER,XSUBYTD,XSUBPRY:
                            XSUBM01,XSUBM02,XSUBM03,XSUBM04,XSUBM05:
                            XSUBM06,XSUBM07,XSUBM08,XSUBM09,XSUBM10:
                            XSUBM11,XSUBM12,XSUBM13
         GOTO      OVERCOND IF OVER
         MOVE      DSECTION,SECTION
         MOVE      DSUBSECT,SUBSECT
         MOVE      XSUBPER,SUBPER
         MOVE      XSUBYTD,SUBYTD
         MOVE      XSUBPRY,SUBPRY
         MOVE      XSUBM01,SUBM01
         MOVE      XSUBM02,SUBM02
         MOVE      XSUBM03,SUBM03
         MOVE      XSUBM04,SUBM04
         MOVE      XSUBM05,SUBM05
         MOVE      XSUBM06,SUBM06
         MOVE      XSUBM07,SUBM07
         MOVE      XSUBM08,SUBM08
         MOVE      XSUBM09,SUBM09
         MOVE      XSUBM10,SUBM10
         MOVE      XSUBM11,SUBM11
         MOVE      XSUBM12,SUBM12
         MOVE      XSUBM13,SUBM13
         RETURN
.
UPWORK   MOVE      SECTION,DSECTION
         MOVE      SUBSECT,DSUBSECT
         UPDATE    TEMPFILE;DSECTION,DSUBSECT,SUBCODE,SUBDESC1,SUBDCOD:
                            SUBDESC2,SUBUS2DS,XSUBPER,XSUBYTD,XSUBPRY:
                            XSUBM01,XSUBM02,XSUBM03,XSUBM04,XSUBM05:
                            XSUBM06,XSUBM07,XSUBM08,XSUBM09,XSUBM10:
                            XSUBM11,XSUBM12,XSUBM13
         RETURN
.
WRWORK   MOVE      ZERO,OVRCD
         MOVE      SECTION,DSECTION
         MOVE      SUBSECT,DSUBSECT
         WRITE     TEMPFILE,KEY16;DSECTION,DSUBSECT,SUBCODE,SUBDESC1,SUBDCOD:
                                  SUBDESC2,SUBUS2DS,XSUBPER,XSUBYTD,XSUBPRY:
                                  XSUBM01,XSUBM02,XSUBM03,XSUBM04,XSUBM05:
                                  XSUBM06,XSUBM07,XSUBM08,XSUBM09,XSUBM10:
                                  XSUBM11,XSUBM12,XSUBM13
         RETURN
.
.        ======================================================================
.        ADDG0000: Subtract GST from the current record, and post separately
.        ======================================================================
.
ADDG0000 PACK       KEY28,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,FINHOSP
         IF         HOSPFLAG=1
            PACK       KEY28,FINHOSP,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE
         ENDIF
.
.        Calculate the GST for each field
.
         MOVE       ZERO,FORM2                   * initialise counter
ADDG1000 ADD        ONE,FORM2                    * increment variable counter
         COMPARE    TEN6,FORM2                   * finished ?
         GOTO       ADDG4000 IF NOT LESS         * yes go to next step
.
         LOAD       WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                                FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                                FINMTH9,FINMTH10,FINMTH11:
                                FINMTH12,FINMTH13,FINPER,FLSTYR
.
.        Save the amount, less the GST. Then calculate the GST and
.        set the PATFINFD variables to the GST amount
.
         ASSIGN     (WORK1/GSTADJST),SAVFIN[FORM2]
         ASSIGN     (WORK1 - SAVFIN[FORM2]),WORK2
.
         STORE      WORK2,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                                FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                                FINMTH9,FINMTH10,FINMTH11:
                                FINMTH12,FINMTH13,FINPER,FLSTYR
         GOTO       ADDG1000
.
.        We have extracted the GST from all items. Post it away
.
ADDG4000 MOVE       CURSECT,SECTION
         MOVE       THREE,SUBSECT            * miscellaneous charges
.
         CMATCH     ANSC,FINTYPE
         IF         @EQUAL
           MOVE       SIX,SUBSECT            * journals
         ENDIF
         PACK       SUBCODE,GSTCODE,SP20
         CALL       ADDW0000
.
         MOVE       TILDA20,SUBCODE          * Add the totals key to work
         CALL       ADDW0000
.
.        Now restore the original data, less the GST portion
.
         MOVE       ZERO,FORM2
ADDG5000 ADD        ONE,FORM2
         COMPARE    TEN6,FORM2
         GOTO       ADDG9999 IF NOT LESS
.
         MOVE       SAVFIN[FORM2],WORK2          * orginal amt less GST
.
         STORE      WORK2,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                                FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                                FINMTH9,FINMTH10,FINMTH11:
                                FINMTH12,FINMTH13,FINPER,FLSTYR
         GOTO       ADDG5000
.
ADDG9999 RETURN
.
.         ======================================================================
.         BABF0000: system breakdown for ABF Charge
.         ======================================================================
.
BABF0000  MOVE      ZERO,EXIT
          COMPARE   ZERO,FSTSYS
          GOTO      BABF9999 IF NOT EQUAL    * not running a consolidate report
.
          COMPARE   THREE,SUBSECT
          GOTO      BABF1000 IF EQUAL        * Misc. Item
          COMPARE   SIX,SUBSECT
          GOTO      BABF9999 IF NOT EQUAL    * Misc. Item Credit Note
.
BABF1000  UNPACK    FINCODE,KEY1,KEY3,KEY10
          MATCH     SP70,KEY10
          GOTO      BABF9999 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD,BABF9999
          MATCH     "A",TCINDC2
          GOTO      BABF9999 IF NOT EQUAL    * Not an ABF Funding
.
          MOVE      ONE,EXIT
.
BABF9999  RETURN
.
.        ======================================================================
.        ADDW0000: Add data to the work file
.        ======================================================================
.
ADDW0000 
.        CMATCH     "B",SUBCODE
.        GOTO       ADDW9999 IF EQUAL
.
         PACK       KEY16,SECTION,SUBSECT,SUBCODE
         CALL       RDWORK                       * Read the work file record
         BRANCH     OVRCD,ADDW2000               * No record currently in file
.
.        Update the record with the new data
.
         ADD        FINPER,XSUBPER                * Period Total
         ADD        FLSTYR,XSUBPRY                * Prior year total
.
         MOVE       ZERO,FORM2                   * Prepare to loop over months
ADDW1600 ADD        ONE,FORM2                    * Get the next month
         COMPARE    TEN4,FORM2                   * Check if we have finished
         GOTO       ADDW1800 IF NOT LESS         * Yes, update the record
.
         LOAD       WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                                FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                                FINMTH9,FINMTH10,FINMTH11:
                                FINMTH12,FINMTH13
.
         ADD        WORK1,XSUBYTD                 * Increment YTD total
.
         LOAD       WORK2,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                                XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                                XSUBM09,XSUBM10,XSUBM11,XSUBM12,XSUBM13
.
         ADD        WORK1,WORK2                  * Increment month total
.
         STORE      WORK2,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                                XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                                XSUBM09,XSUBM10,XSUBM11,XSUBM12,XSUBM13
         GOTO       ADDW1600                     * Get next month
.
.        Update the work file
.
ADDW1800 CALL       UPWORK
         GOTO       ADDW9999
.
.        Create a new work file record
.
ADDW2000 CALL       GETD0000                     * Get the description
.
         MOVE       FINPER,XSUBPER               * Period Total
         MOVE       FLSTYR,XSUBPRY                * Prior year total
         MOVE       ZERO,XSUBYTD                  * Year to date total
.
         MOVE       ZERO,FORM2                   * Prepare to loop over months
ADDW2200 ADD        ONE,FORM2                    * Get the next month
         COMPARE    TEN4,FORM2                   * Check if we have finished
         GOTO       ADDW2400 IF NOT LESS         * Yes, write the record
.
         LOAD       WORK1,FORM2,FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                                FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                                FINMTH9,FINMTH10,FINMTH11:
                                FINMTH12,FINMTH13
.
         ADD        WORK1,XSUBYTD                 * Increment YTD total
.
         STORE      WORK1,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                                XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                                XSUBM09,XSUBM10,XSUBM11,XSUBM12,XSUBM13
         GOTO       ADDW2200                     * Get next month
.
.        Write to the work file
.
ADDW2400 PACK       KEY16,SECTION,SUBSECT,SUBCODE
         CALL       WRWORK
.
ADDW9999 RETURN
.
.         ======================================================================
.         ZERO0000: Zero the amounts in the work file variables
.         ======================================================================
.
ZERO0000  MOVE      ZERO,FORM2                    * Start from the beginning
ZERO1000  ADD       ONE,FORM2                     * Get the next variable
          COMPARE   TEN7,FORM2                    * Have we finished yet ?
          GOTO      ZERO9999 IF NOT LESS          * Yes.
.
          STORE     ZERO,FORM2,XSUBM01,XSUBM02,XSUBM03,XSUBM04:
                               XSUBM05,XSUBM06,XSUBM07,XSUBM08:
                               XSUBM09,XSUBM10,XSUBM11,XSUBM12:
                               XSUBM13,XSUBPER,XSUBPRY,XSUBYTD
          GOTO      ZERO1000
.
ZERO9999  RETURN
+
.        ==========================================
.        WRPTFMI: Write record to the Invoiced file
.        HSYS1=4 Write to a comma delimited file
.        ==========================================
WRPTFMI  IF        HSYS1=4
           STRIP     IBGILEDG
           STRIP     IBGIACCT
           STRIP     IBGIDATE
           STRIP     IBGISIGN
           MOVE      IBGIVALU,KEY15
           SQUEEZE   KEY15
           STRIP     IBGIDESC
           STRIP     IBGIREF
           STRIP     IBGIEREF
           STRIP     IBGIDISS
           STRIP     IBGIRESP
           STRIP     IBGICRAC
           STRIP     IBGICRAA
           STRIP     IBGIBASC
           WRITE     PTINVGL,SEQ;*+,IBGILEDG,COMMA,IBGIACCT,COMMA:
                               IBGIDATE,COMMA,IBGISIGN,COMMA:
                               KEY15,COMMA,IBGIDESC,COMMA:
                               IBGIREF,COMMA,IBGIDISS,COMMA:
                               IBGIRESP,COMMA,IBGICRAC,COMMA:
                               IBGICRAA,COMMA,IBGIBASC
         ELSE
           IF        EXPORTDE<>1
             WRITE     PTINVGL,SEQ;IBGILEDG,IBGIACCT,IBGIDATE,IBGISIGN:
                                 IBGIVALU,IBGIDESC,IBGIREF,IBGIDISS:
                                 IBGIRESP,IBGICRAC,IBGICRAA,IBGIBASC
           ELSE
             WRITE     PTINVGL,SEQ;IBGILEDG,IBGIACCT,IBGIDATE,IBGISIGN:
                                 IBGIVALU,IBGIDESC,IBGIEREF,IBGIDISS:
                                 IBGIRESP,IBGICRAC,IBGICRAA,IBGIBASC
             MOVE      SP30,IBGIEREF
           ENDIF
         ENDIF
         RETURN
+
.        ================================================
.        WRPTFMT: Write record to the to be Invoiced file
.        HSYS1=4 Write to a comma delimited file
.        ================================================
WRPTFMT  MOVE      SP3,IBGIBASC
         IF        HSYS1=4
           STRIP     IBGILEDG
           STRIP     IBGIACCT
           STRIP     IBGIDATE
           STRIP     IBGISIGN
           MOVE      IBGIVALU,KEY15
           SQUEEZE   KEY15
           STRIP     IBGIDESC
           STRIP     IBGIREF
           STRIP     IBGIEREF
           STRIP     IBGIDISS
           STRIP     IBGIRESP
           STRIP     IBGICRAC
           STRIP     IBGICRAA
           STRIP     IBGIBASC
           WRITE     PTTBIGL,SEQ;*+,IBGILEDG,COMMA,IBGIACCT,COMMA:
                               IBGIDATE,COMMA,IBGISIGN,COMMA:
                               KEY15,COMMA,IBGIDESC,COMMA:
                               IBGIREF,COMMA,IBGIDISS,COMMA:
                               IBGIRESP,COMMA,IBGICRAC,COMMA:
                               IBGICRAA,COMMA,IBGIBASC
         ELSE
           IF        EXPORTDE<>1
             WRITE     PTTBIGL,SEQ;IBGILEDG,IBGIACCT,IBGIDATE,IBGISIGN:
                                 IBGIVALU,IBGIDESC,IBGIREF,IBGIDISS:
                                 IBGIRESP,IBGICRAC,IBGICRAA,IBGIBASC
           ELSE
             WRITE     PTTBIGL,SEQ;IBGILEDG,IBGIACCT,IBGIDATE,IBGISIGN:
                                 IBGIVALU,IBGIDESC,IBGIEREF,IBGIDISS:
                                 IBGIRESP,IBGICRAC,IBGICRAA,IBGIBASC
             MOVE      SP30,IBGIEREF
           ENDIF
         ENDIF
         RETURN
+
RSFINN   IF         GSTFLAG=1
           IF         HOSPFLAG=1
             CALL       RSPTFIA2                     * Initialise file
           ELSE
             CALL       RSPTFIA1                     * Initialise file
           ENDIF
         ELSE
           IF         HOSPFLAG=1
             CALL       RDSFINS2                     * Initialise file
           ELSE
             CALL       RDSFINS1                     * Initialise file
           ENDIF
         ENDIF
         RETURN
+
RKFINN   IF         GSTFLAG=1
           IF         HOSPFLAG=1
             CALL       RKPTFIA2
           ELSE
             CALL       RKPTFIA1
           ENDIF
         ELSE
           IF         HOSPFLAG=1
             CALL       RDKFINS2
           ELSE
             CALL       RDKFINS1
           ENDIF
         ENDIF
         RETURN
+
.        ================================================
.         I/O for G/L Interface file
.        ================================================
RDSYFMS   MOVE      SP70,PTFMSYST
          MATCH     "0",PTCNSIGL
          IF        @EQUAL
            CALL      RDPTFM1
          ELSE
            CALL      RDPMFMS1
            BRANCH    OVRCD,RDSYFM9
            CALL      MVFLD00              * move fields
          ENDIF
RDSYFM9   RETURN
.
RKSYFMS   MOVE      SP70,PTFMSYST
          MATCH     "0",PTCNSIGL
          IF        @EQUAL
            CALL      RKPTFM1
          ELSE
            CALL      RKPMFMS1
            BRANCH    OVRCD,RKSYFM9
            CALL      MVFLD00              * move fields
          ENDIF
RKSYFM9   RETURN
.
.        ========================================================
.        Move fields from System based G/L Int.to Normal G/L Int.
.        ========================================================
MVFLD00   MOVE      PMFMHOSP,PTFMHOSP
          MOVE      PMFMRSUB,PTFMSUB
          MOVE      PMFMCODE,PTFMCOD
          MOVE      PMFMFDIS,PTFMIDI
          MOVE      PMFMFRES,PTFMIRE
          MOVE      PMFMFLED,PTFMILD
          MOVE      PMFMFCRD,PTFMICA
          MOVE      PMFMFDEB,PTFMIDA
          MOVE      PMFMGSTA,PTFMIGS
.
          MOVE      PMFMTDIS,PTFMTDI
          MOVE      PMFMTRES,PTFMTRE
          MOVE      PMFMTLED,PTFMTLD
          MOVE      PMFMTCRD,PTFMTCA
          MOVE      PMFMTDEB,PTFMTDA
          MOVE      PMFMBASC,PTFMBASC
.
          MOVE      PMFMSYST,PTFMSYST
MVFLD99   RETURN
.
.        ========================================================
.        Print G/L Interface
.        ========================================================
PRGL0000  OPEN      IBAGINA1,INVNAME
          MOVE      ZERO,CPAGENO
          MOVE      "60",CLNO                    * Init line number
          MOVE      ZERO,FIRSTFLG
          CALL      PRGIN000
.
          COMPARE   ONE,TBIFLAG
          GOTO      PRGL9000 IF NOT EQUAL        * No to be invoiced
.
          CLOSE     IBAGINA1
          MOVE      "60",CLNO                    * Init line number
          MOVE      ONE,FIRSTFLAG
          OPEN      IBAGINA1,TBINAME
          CALL      PRGIN000
.
PRGL9000  CLOSE     IBAGINA1
PRGL9999  RETURN
.
.        ========================================================
.        Print IBAGINA file 
.        ========================================================
PRGIN000  CALL      RKIBGI1
          BRANCH    OVRCD,PRGIN999
.
          ADD       ONE,SECTOR
          IF        SECTOR%100=0
            DISPLAY   *P40:24,*V2LON,SECTOR
          ENDIF
.
          BRANCH    EXPORTFL,PRGIN200
.
          COMPARE   SIXTY,CLNO
          CALL      HDGIN000 IF NOT LESS
.
          PRINT     *1,IBGIACCT,*22,IBGICRAA,*44,IBGIDESC,*78,IBGIVALU
          ADD       ONE,CLNO
          GOTO      PRGIN000
.
PRGIN200  PRINT     "<tr><td>",IBGIACCT,"/<td>":
                        "<td>",IBGICRAA,"</td>":
                        "<td>",IBGIDESC,"</td>":
                        "<td>",IBGIVALU,"</td></tr>"
          GOTO      PRGIN000
.
PRGIN999  RETURN
+
.        ========================================================
.        Header
.        ========================================================
HDGIN000  CALL      IBACLOCK
.
          BRANCH    EXPORTFL,HDGIN200
.
          CALL      HEAD132
.
          PRINT     *1,"Debit Account",*22,"Credit Account":
                    *44,"Description",*78,"Amount"
          CALL      UND132
          IF        FIRSTFLG=0
            PRINT     *1,"Fees Invoiced G/L Interface Section":
                      *N,"==================================="
          ELSE
            PRINT     *1,"To Be Invoiced G/L Interface Section":
                      *N,"===================================="
          ENDIF
          MOVE      THREE,CLNO
          GOTO      HDGIN999
.
HDGIN200  
          IF        FIRSTFLG=0
            PRINT     "<tr><td>Fees Invoiced G/L Interface Section</td></tr>"
          ELSE
            PRINT     "<tr><td>To Be Invoiced G/L Interface Section</td></tr>"
          ENDIF
.
          PRINT     "<tr><td>Debbit Account</td>":
                        "<td>Credit Account</td>":
                        "<td>Description</td>":
                        "<td>Amount</td></tr>"
.
HDGIN999  RETURN
+
.****************************************************************************
.*                                CRTX0000                                  *
.* Create export file for excel                                             *
.****************************************************************************
CRTX0000  MOVE      ZERO,EXIT
          MOVE      ZERO,EXPORTFL                  * No to create export file
          DISPLAY   *P1:17,"Create Export file for Excel : "
          KEYIN     *P32:17,*V2LON,*RV,DIM1:
                    *P32:17,*DV,DIM1
          REP       UPPLOW,DIM1
          DISPLAY   *P32:17,*V2LON,DIM1
          MOVE      ONE,EXPORTFL
          MATCH     "Y",DIM1
          GOTO      CRTX9999 IF EQUAL
          MOVE      ZERO,EXPORTFL
.
CRTX9999  RETURN
+
.****************************************************************************
.*                                SHDE0000                                  *
.* Show description on export file                                          *
.****************************************************************************
SHDE0000  MOVE      ZERO,EXIT
          MOVE      ZERO,EXPORTDE
          DISPLAY   *P1:18,"Show Description on Export File : "
          KEYIN     *P35:18,*V2LON,*RV,DIM1A:
                    *P35:18,*DV,DIM1A
          REP       UPPLOW,DIM1A
          DISPLAY   *P35:18,*V2LON,DIM1A
          MOVE      ONE,EXPORTDE
          MATCH     "Y",DIM1A
          GOTO      SHDE9999 IF EQUAL
          MOVE      ZERO,EXPORTDE
.
SHDE9999  RETURN
+
.****************************************************************************
.*                                RFIN0000                                  *
.* Run Financial summary report                                             *
.****************************************************************************
RFIN0000  MOVE      ZERO,EXIT
          MOVE      "Y",DIM1
          DISPLAY   *P1:11,*EF,"Run Financial Summary Report : "
          KEYIN     *P32:11,*V2LON,*RV,DIM1:
                    *P32:11,*DV,DIM1
          REP       UPPLOW,DIM1
          DISPLAY   *P32:11,*V2LON,DIM1
          MOVE      ONE,FINSUMFL
          MATCH     "Y",DIM1
          GOTO      RFIN9999 IF EQUAL
          MOVE      ZERO,FINSUMFL
.
RFIN9999  RETURN
+
.****************************************************************************
.*                                TRTY0000                                  *
.* Transaction Type option                                                  *
.****************************************************************************
TRTY0000  MOVE      ZERO,EXIT
          MOVE      ZERO,TRANTYPE
          KEYIN     *P1:13,*V2LON,*DV,ZERO,*HOFF," = Exit":
                    *P1:14,*V2LON,*DV,ONE,*HOFF," = All":
                    *P1:15,*V2LON,*DV,TWO,*HOFF," = Accommodation":
                    *P1:16,*V2LON,*DV,THREE,*HOFF," = Item Charges":
                    *P1:17,*V2LON,*DV,FOUR,*HOFF," = Journal":
                    *P1:18,"Option : ",*EL,*V2LON,TRANTYPE
.
          BRANCH    TRANTYPE,TRTY9999,TRTY9999,TRTY9999,TRTY9999
          MOVE      ONE,EXIT
TRTY9999  RETURN
+
.****************************************************************************
.*                                DRNG0000                                  *
.* Date Range                                                               *
.****************************************************************************
DRNG0000  DISPLAY   *P1:20,"Starting Date :":
                    *P1:21,"  Ending Date :"
.
          MOVE       "20",CVERT
          PACK       KEY8 WITH FTCC,FTYY,FTMM,FTDD
          UNPACK     KEY8,XCENT,XYEAR,XMON,XDAY
          MOVE       XDAY,IDAY
          MOVE       XMON,IMON
          MOVE       XYEAR,IYEAR
          MOVE       XCENT,ICENT
.
          CALL       KEYDTE00
          PACK       INVFDATE WITH ICENT,IYEAR,IMON,IDAY
          REP        " 0",INVFDATE
.
          MOVE       "21",CVERT
.
DRNG1000  MOVE       CDD,IDAY
          MOVE       CMM,IMON
          MOVE       CYY,IYEAR
          MOVE       CCC,ICENT
          CALL       KEYDTE00
          PACK       INVTDATE WITH ICENT,IYEAR,IMON,IDAY
          REP        " 0",INVTDATE
.
          MATCH      INVFDATE,INVTDATE
          GOTO       DRNG9999 IF NOT LESS
.
          DISPLAY    *P1:24,*EL,*B,"End Date must be >= Start Date.  ";
          CALL       HITENTER
          GOTO       DRNG1000

DRNG9999 RETURN
+
.****************************************************************************
.         Subroutine to key in a valid date
.****************************************************************************
KEYDTE00  IF        IDAY=0
            MOVE      SP10,CDAY        * no default day/mon
            MOVE      SP10,CMON
            MOVE      SP10,CYEAR
            MOVE      SP10,CCENT
          ELSE
            MOVE      IDAY,CDAY        * set up day/mon
            MOVE      IMON,CMON
            MOVE      IYEAR,CYEAR
            MOVE      ICENT,CCENT
          ENDIF
.
          MOVE      "17",CCOL          * set up position
          MOVE      "1",CDEFDTE        * 0=3 C/R's to accept date, 1=1 C/R
          REPEAT
            CALL      KEYDATE          * nez modified to use standard routine
          UNTIL     CQUEST=0
.
          MOVE      ZERO,IDAY
          MOVE      CDAY,IDAY
.
KEYDTE99  RETURN
+
.        ========================================================
.
WRTMPA1   RESET     KEY4
          MOVE      ZERO,OVRCD
          WRITE     TMPFILE1,KEY4;XHOSPID,XTTAMGST,XTTCRGST,XFSYST,XSPARE
          RETURN
.
RDTMPA1   MOVE      ZERO,OVRCD
          RESET     KEY4
          READ      TMPFILE1,KEY4;XHOSPID,XTTAMGST,XTTCRGST,XFSYST,XSPARE
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPA1   RESET     KEY4
          READ      TMPFILE1,KEY4;;
          RETURN
.
RKTMPA1   MOVE      ZERO,OVRCD
          READKS    TMPFILE1;XHOSPID,XTTAMGST,XTTCRGST,XFSYST,XSPARE
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTMPA1   MOVE      ZERO,OVRCD
          UPDATE    TMPFILE1;XHOSPID,XTTAMGST,XTTCRGST,XFSYST,XSPARE
          RETURN
.
WRTMPA2   RESET     KEY18
          MOVE      ZERO,OVRCD
          WRITE     TMPFILE2,KEY18;XCURSECT,SAVFMHOS,SAVFCODE,XTTAMITM,XTTCRITM:
                                   XFINCODE,SAVFMSYS,SAVSCODE
          RETURN
.
RDTMPA2   MOVE      ZERO,OVRCD
          RESET     KEY18
          READ      TMPFILE2,KEY18;XCURSECT,SAVFMHOS,SAVFCODE,XTTAMITM,XTTCRITM:
                                   XFINCODE,SAVFMSYS,SAVSCODE
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPA2   RESET     KEY18
          READ      TMPFILE2,KEY18;;
          RETURN
.
RKTMPA2   MOVE      ZERO,OVRCD
          READKS    TMPFILE2;XCURSECT,SAVFMHOS,SAVFCODE,XTTAMITM,XTTCRITM:
                             XFINCODE,SAVFMSYS,SAVSCODE
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTMPA2   MOVE      ZERO,OVRCD
          UPDATE    TMPFILE2;XCURSECT,SAVFMHOS,SAVFCODE,XTTAMITM,XTTCRITM:
                             XFINCODE,SAVFMSYS,SAVSCODE
          RETURN
.
          INC       STD001IO
          INC       PATGNCMX
          INC       PATHSPKY
          INC       CMGETTHR
          INC       CMXMATRX
          INC       AAECATBI
          INC       AAEDE1IO/INC
          INC       AAEDTRIO/INC
          INC       IBAPASIO/INC
          INC       IBASECIO/INC
          INC       IBAGEDIO/INC
          INC       IBAGSTIO/INC
          INC       OUTCATBI
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCLIIO/INC
          INC       OUTDTRIO/INC
          INC       OUTSITIO/INC
          INC       OUTSESIO/INC
          INC       PATCALFN
          INC       PATCATBI
          INC       PATCOMN3
          INC       PATDRGIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATCODDS
          INC       GETCNEFF
          INC       GETBFEES
          INC       GETTFEES
          INC       TFILENAM                     * Generate Temp File Name
.
          INC       IBASEQIO/INC                 * Sequential Numbers File
          INC       WEBERRIO/INC                 * Web Server Error Logging
.
          INC       PATAFEIO/INC
          INC       PATASDIO/INC
          INC       PATCFAIO/INC
          INC       PATCMXIO/INC
          INC       PATCTFIO/INC
          INC       PMSCIDIO/INC
          INC       PMSCCDIO/INC
          INC       PATDGWIO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATLDFIO/INC
          INC       PATLSDIO/INC
          INC       PMSPYRIO/INC
          INC       PMSPBRIO/INC
          INC       PMSIDEIO/INC
          INC       PMSIVBIO/INC
.
          INC       BOKRC1IO/INC
          INC       PATBFEIO/INC
          INC       PATELGIO/INC
          INC       PATTFEIO/INC
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATIBLIO/INC
          INC       PATICUIO/INC
          INC       PATIOVIO/INC
          INC       PATFINIO/INC
          INC       NZPEXTIO/INC
          INC       NZPFINIO/INC
          INC       PATFIGIO/INC
          INC       NZPFIGIO/INC
          INC       PATFMOIO/INC
          INC       PATFN1IO/INC
          INC       PATFN2IO/INC
          INC       PATHSPIO/INC
          INC       PATHTRIO/INC
          INC       OUTHTRIO/INC
          INC       EMRHTRIO/INC
          INC       PATIN1IO/INC
          INC       PATINMIO/INC
          INC       PATINVIO/INC
          INC       PATIPEIO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATOVBIO/INC
          INC       PATPGRIO/INC
          INC       PATRBLIO/INC
          INC       PATRCAIO/INC
          INC       PATRATIO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       NZPRFNIO/INC
          INC       PATSRBIO/INC
          INC       PATTRNIO/INC
          INC       PATVENIO/INC
          INC       PATVISIO/INC
          INC       PMSCNOIO/INC
          INC       PMSHATIO/INC
          INC       PMSHCPIO/INC
          INC       PMSEVTIO/INC
          INC       PMSVX1IO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       PATFMSIO/INC
          INC       PMSFMSIO/INC
          INC       FMSLMAIO/INC
          INC       PMSSINIO/INC
          INC       PATCMTIO/INC
          INC       PMSCMTIO/INC
          INC       PMSMTIIO/INC
          INC       PMSMPRIO/INC
          INC       PMSSGAIO/INC
          INC       RCPBDTIO/INC
          INC       IBAGINIO/INC
.
          INC       VISPAYIO/INC
          INC       NZPBFEIO/INC
          INC       NZPCMTIO/INC
          INC       NZPCFNIO/INC
          INC       MLTCFNIO/INC
          INC       NZPIBRIO/INC
          INC       NZPSPRIO/INC
          INC       NZPPFEIO/INC
          INC       NZPPICIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       NZPTFEIO/INC
          INC       NZPIVBIO/INC
          INC       NZPRVBIO/INC
          INC       NZPRBRIO/INC
          INC       NZPRDTIO/INC
          INC       OPRARDIO/INC
          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       PRIITMIO/INC
          INC       PATRGMIO/INC
          INC       PMSREGIO/INC
          INC       PATAA1IO/INC
          INC       PATSTAIO/INC
          INC       PATONHIO/INC
.
          INC       ICDSCLAS
          INC       CLNZPPIC
          INC       PATIVMES
          INC       CLPATDTR                * Clear DTR file variables
          INC       CLOUTDTR                * Clear DTR file variables
          INC       CLPATDSC
          INC       CLPMSIDE
          INC       PATSELFN
          INC       PATIPERH
          INC       STEPDOWN
          INC       PATCMSTP
          INC       NHOSPDAY
          INC       CHKCMXPT
          INC       CALCDAYS
          INC       PABXBILL
          INC       PRBILCMN
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       ISBITEMS
          INC       VALCMXFN
          INC       GETEFDRG
          INC       FINSUMMR
          INC       IPENBOK1
          INC       PATITMRD
.
          INC       EMRSITIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
          INC       COMDEPIO/INC
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       PATDDHIO/INC
.
.        The following a subroutines mentioned in PATCATBI, but will never be
.        needed by this program. They are defined here to allow compilation
.
GETTHR
INITIVAR
NXTTRAN1
PROCAAEI
PROCACCM
PROCMISC
PRTCLMS
PRTEOL
TAIL
WRITETRN
PRTINVTL
SINVT000
DOCNM000
CKTL0000
PEOL0000
PRLN0000
PROACC00
ENDPRT00
PRTIPROV
GCDE0000
.
SBDY0000
SPBD9999
PATSTRYR
ADDWRN00
PRINTL
ENDP
          RETURN
+
.
. The dummy routine required by PATGNCMX. 
.
WEBERR00  RETURN
+
.
ENDIT     CHAIN     PGM
          STOP
.
