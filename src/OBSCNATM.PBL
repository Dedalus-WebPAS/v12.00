.----------------------------------------------------------------------
. Program       : OBSCNATM
.
. Function      : Clinical Note Details
.
. Modifications : 
. V11.04.01 25/06/2024 Nikitha Bhaskar   TSK 0947665  
.           Added inactive check - PTCOACTV in HGHSEL10.
. V11.01.01 15/03/2021 Jill Parkinson Task 0903816
.           Added space before selected tag
. V10.08.01 02.11.2016  Ebon Clements     TSK 0305048
.           Added clinical note enquiry functionality
.-----------------------------------------------------------------------------
.                V10.06.02 24/07/2015  Davin          CAR 308063
.                          Added tag for CLIWEB06 user level security (clif7300)
.                          Output note security level in notsel00 (selectio=5)
.                V10.06.01 01/06/2015  Peter Vela     CAR 317493 - 284803
.                          Totranned for CAR 284803
.                V10.03.03 20/08/2013  Don Nguyen     CAR 281660
.                          Added CLIF7100 - check if there are clinical notes
.                V10.03.02 15.08.2012 B.G.Ackland     CAR 275970
.                          Fix Loop on OBACNB causing Server Timeout Error
.                V10.03.01 29/11/2011 Jill Parkinson  CAR 249362
.                          Changed keys for alert tables        
.                V10.00.01 21/09/2010 Saroeun Soeur   CAR 230973
.                          Added new tag - CLIF6900 - CLIF7000
.-----------------------------------------------------------------------------
.                V5.07.01 12.01.2000 Bronko Sosic
.                          Added REP " 0" after CYEAR
.
.                 V5.06.00 12.03.1999 Pat Dirito
.                          Ported from r6.05    
.
.                 V6.05.01 25.02.1999 Andrew Peel
.
.                 V9.07.01 06.09.2006 Jill Habasque CAR 103377
.                          Added tags from 40-62
.                 V9.07.02 26.10.2006 Jill Habasque CAR 121320
.                          Added tag 63
.                 V9.07.03 30.11.2006 Jill Habasque CAR 121320
.                          Added tags 64 and 65
.                 V9.07.04 20.12.2006 Jill Habasque CAR 128819
.                          Added output of <br> for text area printing
.                 V9.09.01 05.07.2007 Jill Habasque CAR 140517
.                          Added output of princ diagnosis and procedure desc
.----------------------------------------------------------------------
. Clinical Note Fields 
.------------------------------------------------------------
.
CLIF0000  BRANCH    FLDITMNO,CLIF0100,CLIF0200,CLIF0300,CLIF0400:
                             CLIF0500,CLIF0600,CLIF0700,CLIF0800:
                             CLIF0900,CLIF1000,CLIF1100,CLIF1200:
                             CLIF1300,CLIF1400,CLIF1500,CLIF1600:
                             CLIF1700,CLIF1800,CLIF1900,CLIF2000:
                             CLIF2100,CLIF2200,CLIF2300,CLIF2400:
                             CLIF2500,CLIF2600,CLIF2700,CLIF2800:
                             CLIF2900,CLIF3000,CLIF3100,CLIF3200:
                             CLIF3300,CLIF3400,CLIF3500,CLIF3600:
                             CLIF3700,CLIF3800,CLIF3900,CLIF4000:
                             CLIF4100,CLIF4200,CLIF4300,CLIF4400:
                             CLIF4500,CLIF4600,CLIF4700,CLIF4800:
                             CLIF4900,CLIF5000,CLIF5100,CLIF5200:
                             CLIF5300,CLIF5400,CLIF5500,CLIF5600:
                             CLIF5700,CLIF5800,CLIF5900,CLIF6000:
                             CLIF6100,CLIF6200,CLIF6300,CLIF6400:
                             CLIF6500,CLIF6600,CLIF6700,CLIF6800:
                             CLIF6900,CLIF7000,CLIF7100,CLIF7200:
                             CLIF7300
.
CLIF0100  CALL      LCNP0000
          GOTO      CLIF9999
.
CLIF0200  WRITE     HTMLFILE;OBCAVIS;       * Output Visit Number 
          GOTO      CLIF9999
.
CLIF0300  CALL      INDATE00
          GOTO      CLIF9999
.
CLIF0400  CALL      INTIME00
          GOTO      CLIF9999
.
CLIF0500  CALL      INUSER00
          GOTO      CLIF9999
.
CLIF0600  MATCH     SP4,CLNOTEID            * If New Clinical Note
          IF        @EQUAL
            PACK      KEY10,USERID,SP10     * Pack Key with User ID 
          ELSE
            PACK      KEY10,OBCAUID,SP10    * Pack Key with Input by User 
          ENDIF
          CALL      RDWBSE1
          MOVE      "OG",CATEGORY
          MOVE      WBSEOCG,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF0700  CALL      NTTYPE00
          GOTO      CLIF9999
.
CLIF0800  CALL      HIGHLV00
          GOTO      CLIF9999
.
CLIF0900  PACK      KEY3,OBCATYP,SP70
          CALL      RDOBCC1
          IF        OVRCD=1
            MOVE      OBCASLV,OBCCSLV   * Use original security level
          ENDIF
.
          WRITE     HTMLFILE;OBCCSLV;   * Output Security Level from Note Type
          GOTO      CLIF9999
.
CLIF1000  CALL      ACTIVE00
          GOTO      CLIF9999
.
CLIF1100  CALL      USEDTM00
          GOTO      CLIF9999
.
CLIF1200  CALL      MAINP100
          GOTO      CLIF9999
.
CLIF1300  CALL      MAINP200
          GOTO      CLIF9999
.
CLIF1400  CALL      MAINP300
          GOTO      CLIF9999
.
CLIF1500  CALL      MAINP400
          GOTO      CLIF9999
.
CLIF1600  MOVE      CATUC1,CATEGORY
          MOVE      OBCAUC1,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF1700  MOVE      CATUC2,CATEGORY
          MOVE      OBCAUC2,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF1800  MOVE      CATUC3,CATEGORY
          MOVE      OBCAUC3,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF1900  MOVE      CATUC4,CATEGORY
          MOVE      OBCAUC4,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF2000  MOVE      CATUC5,CATEGORY
          MOVE      OBCAUC5,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF2100  MOVE      CATUC6,CATEGORY
          MOVE      OBCAUC6,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF2200  MOVE      CATUC7,CATEGORY
          MOVE      OBCAUC7,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF2300  MOVE      CATUC8,CATEGORY
          MOVE      OBCAUC8,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF2400  WRITE     HTMLFILE;OBCAUD1; 
          GOTO      CLIF9999
.
CLIF2500  WRITE     HTMLFILE;OBCAUD2; 
          GOTO      CLIF9999
.
CLIF2600  WRITE     HTMLFILE;OBCAUD3; 
          GOTO      CLIF9999
.
CLIF2700  WRITE     HTMLFILE;OBCAUD4; 
          GOTO      CLIF9999
.
CLIF2800  MATCH     SP70,OBCADD1
          GOTO      CLIF9999 IF EQUAL
          UNPACK    OBCADD1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      CLIF9999
.
CLIF2900  MATCH     SP70,OBCADD2
          GOTO      CLIF9999 IF EQUAL
          UNPACK    OBCADD2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      CLIF9999
.
CLIF3000  CALL      LUPDTE00 
          GOTO      CLIF9999
.
CLIF3100  CALL      LUPTME00 
          GOTO      CLIF9999
.
CLIF3200  CALL      LUPUSR00
          GOTO      CLIF9999
.
CLIF3300  CALL      FFNOTE00
          GOTO      CLIF9999
.
CLIF3400  PACK      NOTESKEY,ADMISSNO,CLNOTEID 
          REP       " +",NOTESKEY 
          WRITE     HTMLFILE;NOTESKEY;
          REP       "+ ",NOTESKEY 
          GOTO      CLIF9999
.
CLIF3500  WRITE     HTMLFILE;OBCADLU,OBCATLU;
          GOTO      CLIF9999
.
CLIF3600  CALL      CHCLIN00
          GOTO      CLIF9999
.
CLIF3700  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      OBDHTM00
          GOTO      CLIF9999
.
CLIF3800  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      OBPHTM00
          GOTO      CLIF9999
.
CLIF3900  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      OBRHTM00
          GOTO      CLIF9999
.
CLIF4000  WRITE     HTMLFILE;OBPNPDIA;
          GOTO      CLIF9999
.
CLIF4100  WRITE     HTMLFILE;OBPNPPRO;
          GOTO      CLIF9999
.
CLIF4200  PACK      CATEGORY,ANSR,ANSU,SP70
          MOVE      OBPNREAA,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF4300  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      RESHTM00
          GOTO      CLIF9999
.
CLIF4400  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      PHYHTM00
          GOTO      CLIF9999
.
CLIF4500  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      DITHTM00
          GOTO      CLIF9999
.
CLIF4600  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      CALHTM00
          GOTO      CLIF9999
.
CLIF4700  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          BRANCH    OVRCD,CLIF9999
          WRITE     HTMLFILE;OBMEDRUG;
          GOTO      CLIF9999
.
CLIF4800  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          IF        OVRCD=1
            MOVE      SP70,OBMEDOSF
          ENDIF
          MOVE      "DU",CATEGORY
          MOVE      OBMEDOSF,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF4900  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          BRANCH    OVRCD,CLIF9999
          WRITE     HTMLFILE;OBMEDOSE;
          GOTO      CLIF9999
.
CLIF5000  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          IF        OVRCD=1
            MOVE      SP70,OBMEFREQ
          ENDIF
          MOVE      "DW",CATEGORY
          MOVE      OBMEFREQ,CODE
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF5100  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          BRANCH    OVRCD,CLIF9999
          WRITE     HTMLFILE;OBMEDURA;
          GOTO      CLIF9999
.
CLIF5200  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          BRANCH    OVRCD,CLIF9999
          WRITE     HTMLFILE;OBMEQUAN;
          GOTO      CLIF9999
.
CLIF5300  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          BRANCH    OVRCD,CLIF9999
          WRITE     HTMLFILE;OBMEINST;
          GOTO      CLIF9999
.
CLIF5400  WRITE     HTMLFILE;OBCAAT1; 
          GOTO      CLIF9999
.
CLIF5500  WRITE     HTMLFILE;OBCAAT2; 
          GOTO      CLIF9999
.
CLIF5600  WRITE     HTMLFILE;OBCATX1; 
          GOTO      CLIF9999
.
CLIF5700  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      OBHHTM00
          GOTO      CLIF9999
.
CLIF5800  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      OBEHTM00
          GOTO      CLIF9999
.
CLIF5900  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      OBLHTM00
          GOTO      CLIF9999
.
CLIF6000  UNPACK    DIM127,D1,KEY1,DIM127
          CALL      IHOSPS00
          GOTO      CLIF9999
.
CLIF6100  CALL      CONDIS00
          GOTO      CLIF9999
.
CLIF6200  CALL      RESDIS00
          GOTO      CLIF9999
.
CLIF6300  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY11,ADMISSNO,KEY3,SP70
          CALL      RDOBMED1
          BRANCH    OVRCD,CLIF9999
          WRITE     HTMLFILE;OBMEMCOD;
          GOTO      CLIF9999
.
CLIF6400  PROC      GETALR00
          GOTO      CLIF9999
.
CLIF6500  PROC      GETPRE00
          GOTO      CLIF9999
.
CLIF6600  MOVE      "VR",CATEGORY             * Intent to Re-Admit
          PACK      CODE,PMVXIRAD,SP70
          CALL      CODITM00
          GOTO      CLIF9999
.
CLIF6700  MATCH     SP70,OBPNPDIA
          GOTO      CLIF9999 IF EQUAL
.
          PACK      KEY9,OBPNPDIA,SP70
          CALL      RDPTICD1               * Check ICD10 Codes
          BRANCH    OVRCD,CLIF9999   
.
          WRITE     HTMLFILE;DDESC;
          GOTO      CLIF9999
.
CLIF6800  MATCH     SP70,OBPNPPRO
          GOTO      CLIF9999 IF EQUAL
.
          PACK      KEY9,OBPNPPRO,SP70
          CALL      RDPTICO1               * Check ICD10 Codes
          BRANCH    OVRCD,CLIF9999   
.
          WRITE     HTMLFILE;ODESC;
          GOTO      CLIF9999
.
CLIF6900  PACK      KEY3,CLNOT001,SP70
          CALL      RDOBCC1
          BRANCH    OVRCD,CLIF7000
          WRITE     HTMLFILE;OBCCTYP;
          GOTO      CLIF9999
.
CLIF7000  PACK      KEY3,CLNOT001,SP70
          CALL      RDOBCC1
          BRANCH    OVRCD,CLIF9999
          WRITE     HTMLFILE;OBCCDES;
          GOTO      CLIF9999
.
CLIF7100  CALL      HASCLI00                * Check if there are clinical notes
          GOTO      CLIF9999
.
CLIF7200  MOVE      ZERO,F1                 * Has one or more obsmedaf records? 
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSOBMED1
CLIF7201  CALL      RKOBMED1
          BRANCH    OVRCD,CLIF7299
.
          MATCH     ADMISSNO,OBMEVISN
          GOTO      CLIF7299 IF NOT EQUAL
.
          STRIP     OBMEDRBR
          STRIP     OBMEDRUG
          UNPACK    OBMESCDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          IF        F1=0
            WRITE     HTMLFILE;"<table>":
                               "<tr><td><b><u>DISCHARGE MEDICATIONS</u></td>":
                               "</tr></table><table border=1 cellspacing=0>":
                               "<tr><td><b>Date</b></td>":
                               "<td><b>Medicine</b></td>":
                               "<td><b>Form/Strength</b></td>":
                               "<td><b>Directions</b></td></tr>";
            MOVE      ONE,F1
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",CPCDATE,"&nbsp;</td>":
                             "<td>",*+,OBMEDRBR," ",*+,OBMEDRUG,"&nbsp;</td>":
                             "<td>",*+,OBMEDOSE,"&nbsp;</td>":
                             "<td>",*+,OBMEINST,"&nbsp;</td></tr>";
.
          GOTO      CLIF7201
.
CLIF7299  IF        F1=1
            WRITE     HTMLFILE;"</table>";
          ENDIF
          GOTO      CLIF9999
.
CLIF7300  MOVE      "CLIWEB06",D8
          PACK      KEY18,USERID,D8,SP70
          CALL      RDWBST1
          IF        OVRCD=1
            MOVE      ZERO,WBSTLEV
          ENDIF
          WRITE     HTMLFILE;WBSTLEV;
          GOTO      CLIF9999
.
CLIF9999  RETURN
.-----------------------------------------------------------------------
.Link to New Clinical Note Page
.-----------------------------------------------------------------------
LCNP0000  
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      CLNOTEID,SP4
          PACK      NOTESKEY,ADMISSNO,CLNOTEID,SP20   
          REP       " +",TEMPLATE
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          REP       " +",NOTESKEY
          WRITE     HTMLFILE;LINKPRG,".pbl?reportno=",LINKREP:
                                         "&template=",LINKTEM:
                                         "&urnumber=",URNUMBER:
                                         "&admissno=",ADMISSNO:
                                         "&nzteskey=",NOTESKEY;
          REP       "+ ",TEMPLATE
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       "+ ",NOTESKEY
.
LCNP9999  RETURN
.
.--------------------------------------------------------------
. Output Input Date --> Return Current Date if Noteskey not set
.--------------------------------------------------------------
INDATE00  MATCH     SP4,CLNOTEID        *** If New Clinical Note
          IF        @EQUAL
            CALL      IBACLOCK
            MOVE      CCC,CCENT
            MOVE      CYY,CYEAR
            REP       " 0",CYEAR
            MOVE      CMM,CMON
            MOVE      CDD,CDAY
          ELSE
            UNPACK    OBCADTE,CCENT,CYEAR,CMON,CDAY
          ENDIF
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
INDATE99  RETURN
.
.--------------------------------------------------------------
. Output Input Time --> Return Current Time if Noteskey not set
.--------------------------------------------------------------
INTIME00  MATCH     SP4,CLNOTEID        *** If New Clinical Note
          IF        @EQUAL
            CALL      IBACLOCK
            UNPACK    CTIMEIS,DIM2,DIM1,DIM2A    
          ELSE
            UNPACK    OBCATME,DIM2,DIM1,DIM2A 
          ENDIF
          MOVE      DIM2,F2
          IF        F2>=12
            MOVE      "pm",DIM2B
            IF        F2>=13
              ASSIGN    F2-12,F2
            ENDIF
          ELSE
            MOVE    "am",DIM2B
          ENDIF
          MOVE      F2,DIM2
          WRITE     HTMLFILE;DIM2,DIM1,DIM2A,SP2,DIM2B
.
INTIME99  RETURN
.
.------------------------------------------------------------
. Output Input by User 
.------------------------------------------------------------
INUSER00  UNPACK    DIM127,D1,LINKTYP,DIM127
          MATCH     SP4,CLNOTEID            * If New Clinical Note
          IF        @EQUAL
            PACK      KEY10,USERID,SP10
          ELSE
            PACK      KEY10,OBCAUID,SP10    * Pack Key with User ID 
          ENDIF
          CALL      RDWBSE1
          MATCH     "0",LINKTYP
          IF        @EQUAL
            WRITE     HTMLFILE;WBSENAM
          ENDIF
          MATCH     "1",LINKTYP
          IF        @EQUAL
            WRITE     HTMLFILE;WBSEUID
          ENDIF
.
INUSER99  RETURN
.
.------------------------------------------------------------
. Output Type of Note
.------------------------------------------------------------
NTTYPE00  UNPACK    DIM127,D1,LINKTYP,DIM127
          MOVE      ZERO,F1
          MOVE      LINKTYP,F1
          BRANCH    F1,NTTYPE10,NTTYPE20,NTTYPE30
          CALL      GETNOTE0
          WRITE     HTMLFILE;OBCCDES;
          GOTO      NTTYPE99
NTTYPE10  WRITE     HTMLFILE;OBCATYP;
          GOTO      NTTYPE99
.
NTTYPE20  CALL      NOTSEL00
          GOTO      NTTYPE99
.
NTTYPE30  
.
NTTYPE99  RETURN
.
.------------------------------------------------------------
. Add Type of Note Selection List to New Note 
.------------------------------------------------------------
.
NOTSEL00  UNPACK    DIM127,D1,SELECTIO,DIM127 
          PACK      KEY3,SP3
          CALL      RSOBCC1                 * Positional Read
NOTSEL10  CALL      RKOBCC1                 * Sequential Read
          BRANCH    OVRCD,NOTSEL99
          MATCH     SP70,OBCCTYP
          GOTO      NOTSEL10 IF EQUAL
          MATCH     "1",SELECTIO
          IF        @EQUAL
            MATCH     TEMPLATE,OBCCTMI
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=#"",OBCCTYP,OBCCTMI:
                                 "#"selected>",OBCCDES,"</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=#"",OBCCTYP,OBCCTMI:
                                 "#">",OBCCDES,"</option>"
            ENDIF
          ENDIF
          MATCH     "2",SELECTIO
          IF        @EQUAL
            MATCH     TEMPLATE,OBCCTMI
            IF        @EQUAL
              WRITE     HTMLFILE;OBCCTMO;
            ENDIF
          ENDIF
          MATCH     "3",SELECTIO
          IF        @EQUAL
            MATCH     TEMPLATE,OBCCTMI
            IF        @EQUAL
              WRITE     HTMLFILE;OBCCTYP;
            ENDIF
          ENDIF
          MATCH     "4",SELECTIO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OBCCTYP,OBCCTMI:
                               "#">",OBCCDES,"</option>"
          ENDIF
          MATCH     "5",SELECTIO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OBCCTYP,OBCCTMI,OBCCSLV:
                               "#">",OBCCDES,"</option>"
          ENDIF
          GOTO      NOTSEL10
.
NOTSEL99  RETURN
.
.------------------------------------------------------------
GETNOTE0  MOVE      SP70,OBCCDES
          MATCH     SP3,OBCATYP
          GOTO      GETNOTE9 IF EQUAL
          PACK      KEY3,OBCATYP
          CALL      RDOBCC1
          IF        OVRCD=1
            MOVE      SP70,OBCCDES
          ENDIF
.
GETNOTE9  RETURN
.
.------------------------------------------------------------
. Output Highlight Level
.------------------------------------------------------------
HIGHLV00  UNPACK    DIM127,D1,LINKTYP,DIM127
.
          MOVE      ZERO,F1
          MOVE      LINKTYP,F1
          BRANCH    F1,HIGHLV10,HIGHLV20
          CALL      GETHIGH0
          WRITE     HTMLFILE;TDESC;
          GOTO      HIGHLV99
HIGHLV10  WRITE     HTMLFILE;OBCAHLV;
          GOTO      HIGHLV99
.
HIGHLV20  CALL      HGHSEL00
.
HIGHLV99  RETURN
.
.------------------------------------------------------------
GETHIGH0  MOVE      SP70,TDESC
          MATCH     SP3,OBCAHLV
          GOTO      GETHIGH9 IF EQUAL
          PACK      KEY5,CATHLV,OBCAHLV
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
GETHIGH9  RETURN
.
.------------------------------------------------------------
. Add Highlight Selection List to New Note 
.------------------------------------------------------------
.
HGHSEL00  
          PACK      KEY3,SP3
          CALL      RSOBCC1                 * Positional Read
HGHSEL03  CALL      RKOBCC1                 * Read Clinical Note Type File
          BRANCH    OVRCD,HGHSEL05
          MATCH     TEMPLATE,OBCCTMI
          GOTO      HGHSEL05 IF EQUAL
          GOTO      HGHSEL03
HGHSEL05  PACK      KEY5,CATHLV,SP5
          CALL      RDSCODE1                * Positional Read
HGHSEL10  CALL      RDKCODE1                * Sequential Read
          BRANCH    OVRCD,HGHSEL99
          MATCH     SP70,ACODE
          GOTO      HGHSEL10 IF EQUAL
          MATCH     TCODE,CATHLV
          GOTO      HGHSEL99 IF NOT EQUAL 
          MATCH     ACODE,OBCCDHL
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ACODE:
                               "#" selected>",TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV               
            GOTO      HGHSEL10 IF EQUAL     * Skip Inactive Highlight Selection
            WRITE     HTMLFILE;"<option value=#"",ACODE:
                               "#">",TDESC,"</option>"
          ENDIF
.
          GOTO      HGHSEL10
.
HGHSEL99  RETURN
.
.------------------------------------------------------------
. Output Inactive 0=No 1=Yes 
.------------------------------------------------------------
ACTIVE00  MATCH     "1",OBCAMDL            *** If ALL of Note is Deleted
          IF        @EQUAL
            WRITE     HTMLFILE;"InActive"  
          ELSE
            WRITE     HTMLFILE;"Active"  
          ENDIF                    *** If OBCAMDL=1(Yes) then INACTIVE=1(Yes)
.
ACTIVE99  RETURN
.
.------------------------------------------------------------
. Output Time Used in Minutes
.------------------------------------------------------------
USEDTM00  WRITE     HTMLFILE;OBCAMIN
.
USEDTM99  RETURN
.
.------------------------------------------------------------
. Output Main Point 1
.------------------------------------------------------------
MAINP100  
.          MATCH     "1",OBCAMDL            *** If ALL of Note is Deleted
.          GOTO      MAINP199 IF EQUAL
          MATCH     "1",OBCAP1D
          IF        @EQUAL
            WRITE     HTMLFILE;"<strike>",OBCAPT1,"</strike>"
          ELSE
            WRITE     HTMLFILE;OBCAPT1
          ENDIF 
.
MAINP199  RETURN
.
.------------------------------------------------------------
. Output Main Point 2
.------------------------------------------------------------
MAINP200 
.          MATCH     "1",OBCAMDL            *** If ALL of Note is Deleted
.          GOTO      MAINP299 IF EQUAL
          MATCH     "1",OBCAP2D
          IF        @EQUAL
            WRITE     HTMLFILE;"<strike>",OBCAPT2,"</strike>"
          ELSE
            WRITE     HTMLFILE;OBCAPT2
          ENDIF 
.
MAINP299  RETURN
.
.------------------------------------------------------------
. Output Main Point 3
.------------------------------------------------------------
MAINP300 
.          MATCH     "1",OBCAMDL            *** If ALL of Note is Deleted
.          GOTO      MAINP399 IF EQUAL
          MATCH     "1",OBCAP3D
          IF        @EQUAL
            WRITE     HTMLFILE;"<strike>",OBCAPT3,"</strike>"
          ELSE
            WRITE     HTMLFILE;OBCAPT3
          ENDIF 
.
MAINP399  RETURN
.
.------------------------------------------------------------
. Output Main Point 4 
.------------------------------------------------------------
MAINP400 
.          MATCH     "1",OBCAMDL            *** If ALL of Note is Deleted
.          GOTO      MAINP499 IF EQUAL
          MATCH     "1",OBCAP4D
          IF        @EQUAL
            WRITE     HTMLFILE;"<strike>",OBCAPT4,"</strike>"
          ELSE
            WRITE     HTMLFILE;OBCAPT4
          ENDIF 
.
MAINP499  RETURN
.------------------------------------------------------------
. Output Date of Last Update
.------------------------------------------------------------
LUPDTE00  UNPACK    OBCADLU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
LUPDTE99  RETURN
.
.------------------------------------------------------------
. Output Time of Last Update
.------------------------------------------------------------
LUPTME00  UNPACK    OBCATLU,DIM2,DIM1,DIM2A  
          MOVE      DIM2,F2
          IF        F2>=12
            MOVE      "pm",DIM2B
            IF        F2>=13
              ASSIGN    F2-12,F2
            ENDIF
          ELSE
            MOVE    "am",DIM2B
          ENDIF
          MOVE      F2,DIM2
          WRITE     HTMLFILE;DIM2,DIM1,DIM2A,SP2,DIM2B;
.
LUPTME99  RETURN
.
.------------------------------------------------------------
. Output Last Updated by User 
.------------------------------------------------------------
LUPUSR00  UNPACK    DIM127,D1,LINKTYP,DIM127
          PACK      KEY10,OBCALID           * Pack Key with User ID 
          CALL      RDWBSE1                 * Read Web Security File
          BRANCH    OVRCD,LUPUSR99
          MATCH     "0",LINKTYP             * 0 = Display Description
          IF        @EQUAL
            WRITE     HTMLFILE;WBSENAM      * User Name
          ENDIF
          MATCH     "1",LINKTYP             * 1 = Display Code
          IF        @EQUAL
            WRITE     HTMLFILE;WBSEUID      * User ID
          ENDIF
.
LUPUSR99  RETURN
.
.------------------------------------------------------------
. Output Clinical Note Text Area 
.------------------------------------------------------------
FFNOTE00  PACK      KEY15,NOTESKEY,SP20     * Key is Visit No + Note ID
          CALL      RSOBCB1                 * Positional Read
FFNOTE50  CALL      RKOBCB1                 * Sequential Read
          BRANCH    OVRCD,FFNOTE99          * If not found ?
          PACK      KEY12,OBCBVIS,OBCBCID,SP70
          MATCH     KEY12,NOTESKEY
          GOTO      FFNOTE99 IF NOT EQUAL
.
          STRIP     OBCBLDT
          MOVELPTR  OBCBLDT,TXTLEN
          IF        TXTLEN>0
            SFORMAT   VAR,TXTLEN
          ELSE
            SFORMAT   VAR,ONE
          ENDIF
          MOVE      OBCBLDT,VAR
          WRITE     HTMLFILE;VAR        * Line Details
          SFORMAT   VAR,127
          GOTO      FFNOTE50
.         
FFNOTE99  RETURN
.
.------------------------------------------------------------
. Check if a note type already exists
.------------------------------------------------------------
CHCLIN00  UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY12,ADMISSNO,SP20 

          CALL      RSOBCA1
CHCLIN10  CALL      RKOBCA1
          BRANCH    OVRCD,CHCLIN90
.
          MATCH     OBCAVIS,ADMISSNO
          GOTO      CHCLIN90 IF NOT EQUAL
.
          MATCH     KEY3,OBCATYP
          GOTO      CHCLIN10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      CHCLIN99
.
CHCLIN90  WRITE     HTMLFILE;ZERO;
          GOTO      CHCLIN99
.
CHCLIN99  RETURN
+
.------------------------------------------------------------------------------
. Check if there are clinical notes (non-deleted) for this visit
.------------------------------------------------------------------------------
HASCLI00  PACK      KEY12,ADMISSNO,SP20
          CALL      RSOBCA1
HASCLI10  CALL      RKOBCA1
          BRANCH    OVRCD,HASCLI91
.
          MATCH     OBCAVIS,ADMISSNO
          GOTO      HASCLI91 IF NOT EQUAL
.
          MATCH     "1",OBCAMDL             * Deleted?
          GOTO      HASCLI10 IF EQUAL       * Yes; get next note
.
HASCLI90  MOVE      ZERO,EXIT
          WRITE     HTMLFILE;ONE;           * Clinical notes exist
          GOTO      HASCLI99
.
HASCLI91  MOVE      ONE,EXIT
          WRITE     HTMLFILE;ZERO;          * No Clinical notes
.          
HASCLI99  RETURN
+
.------------------------------------------------------------
. Output In hospital summary     
.------------------------------------------------------------
IHOSPS00  PACK      KEY12,ADMISSNO,SP70
          CALL      RSOBCA1
IHOSPS10  CALL      RKOBCA1
          BRANCH    OVRCD,IHOSPS99
.
          MATCH     ADMISSNO,OBCAVIS
          GOTO      IHOSPS99 IF NOT EQUAL
.
          MATCH     "007",OBCATYP
          GOTO      IHOSPS20 IF EQUAL
          GOTO      IHOSPS10
. 
IHOSPS20  PACK      KEY15,ADMISSNO,OBCACID,SP20  * Key is Visit + NoteID
          CALL      RSOBCB1                 * Positional Read
IHOSPS50  CALL      RKOBCB1                 * Sequential Read
          BRANCH    OVRCD,IHOSPS99          * If not found ?
          PACK      KEY12,OBCBVIS,OBCBCID,SP70
          MATCH     KEY12,NOTESKEY
          GOTO      IHOSPS99 IF NOT EQUAL
.
          STRIP     OBCBLDT
          MOVELPTR  OBCBLDT,TXTLEN
          IF        TXTLEN>0
            SFORMAT   VAR,TXTLEN
          ELSE
            SFORMAT   VAR,ONE
          ENDIF
          MOVE      OBCBLDT,VAR
          WRITE     HTMLFILE;VAR        * Line Details
          MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;"<br>"
          ENDIF
          SFORMAT   VAR,127
          GOTO      IHOSPS50
.
IHOSPS99  RETURN
.
.------------------------------------------------------------
. Condition upon Discharge  
.------------------------------------------------------------
CONDIS00  PACK      KEY12,ADMISSNO,SP70
          CALL      RSOBCA1
CONDIS10  CALL      RKOBCA1
          BRANCH    OVRCD,CONDIS99
.
          MATCH     ADMISSNO,OBCAVIS
          GOTO      CONDIS99 IF NOT EQUAL
.
          MATCH     "007",OBCATYP
          GOTO      CONDIS10 IF NOT EQUAL
.
          MATCH     SP70,OBCAUC1
          GOTO      CONDIS99 IF EQUAL
.
          PACK      KEY5,CATUC1,OBCAUC1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CONDIS99
          WRITE     HTMLFILE;TDESC;
          GOTO      CONDIS99
.
CONDIS99  RETURN
.
.------------------------------------------------------------
. Results pending Discharge
.------------------------------------------------------------
RESDIS00  PACK      KEY12,ADMISSNO,SP70
          CALL      RSOBCA1
RESDIS10  CALL      RKOBCA1
          BRANCH    OVRCD,RESDIS99
.
          MATCH     ADMISSNO,OBCAVIS
          GOTO      RESDIS99 IF NOT EQUAL
.
          MATCH     "007",OBCATYP
          GOTO      RESDIS10 IF NOT EQUAL
.
          MATCH     SP70,OBCATX1
          GOTO      CONDIS99 IF EQUAL
.
          WRITE     HTMLFILE;OBCATX1;;
          GOTO      RESDIS99
.
RESDIS99  RETURN
.
.------------------------------------------------------------
. Procedure to get the medical alert/drug allergy data
.------------------------------------------------------------
          DEFPROC  GETALR00
.
          INC      PATALRFD/INC
          INC      PMSALNFD/INC
.
ALRCOMM   DIM      70
.
          MOVE     ZERO,OVRCD
          UNPACK   DIM127,D1,KEY2,DIM127
.
          TRAP     OVERCOND IF IO
          OPEN     PATALRT1,"patalrtf"
          TRAPCLR  IO
          BRANCH   OVRCD,GETALR95
.
          TRAP     OVERCOND IF IO
          OPEN     PMSALNA1,"pmsalnaf"
          TRAPCLR  IO
          BRANCH   OVRCD,GETALR95
.
          PACK     KEY16,URNUMBER,SP70
          CALL     RSPTALR1
GETALR10  CALL     RKPTALR1
          BRANCH   OVRCD,GETALR95
.
          MATCH    URNUMBER,PTALURNO
          GOTO     GETALR95 IF NOT EQUAL
.
          PACK     KEY5,PTALCATG,PTALCODE,SP70
          CALL     RDCODE1
          IF       OVRCD=1
            GOTO     GETALR10
          ENDIF
.
          MATCH    KEY2,THCSCOD
          GOTO     GETALR10 IF NOT EQUAL
.
          PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALN1
          CALL      RKPMALN1
          IF        OVRCD=0
            MATCH     PTALURNO,PMANURNO
            GOTO      GETALR20 IF NOT EQUAL
            MATCH     PTALCATG,PMANACAT
            GOTO      GETALR20 IF NOT EQUAL
            MATCH     PTALCODE,PMANACOD
            GOTO      GETALR20 IF NOT EQUAL
            MATCH     PTALCNTR,PMANCNTR
            GOTO      GETALR20 IF NOT EQUAL
            MOVE      PMANCOMM,ALRCOMM
          ENDIF
.
          CALL      RKPMALN1
          IF        OVRCD=0
            MATCH     PTALURNO,PMANURNO
            GOTO      GETALR20 IF NOT EQUAL
            MATCH     PTALCATG,PMANACAT
            GOTO      GETALR20 IF NOT EQUAL
            MATCH     PTALCODE,PMANACOD
            GOTO      GETALR20 IF NOT EQUAL
            MATCH     PTALCNTR,PMANCNTR
            GOTO      GETALR20 IF NOT EQUAL
            ENDSET    ALRCOMM
            APPEND    PMANCOMM,ALRCOMM
          ENDIF
.
GETALR20  WRITE    HTMLFILE;TDESC," - ",ALRCOMM;
.
          GOTO     GETALR99
.
GETALR95  MOVE     ZERO,EXIT
          GOTO     GETALR99
.
          INC       PATALRIO/INC
          INC       PMSALNIO/INC
          INC       IBAOVRIO/INC
.
GETALR99  ENDPROC
.
.------------------------------------------------------------
. Procedure to get the future preadmission details    
.------------------------------------------------------------
          DEFPROC  GETPRE00
.
          INC      PATMI1FD/INC
.
DIM8      DIM      8
.
          MOVE     ZERO,OVRCD
.
          TRAP     OVERCOND IF IO
          OPEN     PATMI1A8,"patmi1af"
          TRAPCLR  IO
          BRANCH   OVRCD,GETPRE95
.
          CALL     IBACLOCK
          PACK     KEY8,CCC,CYY,CMM,CDD,SP70
          REP      " 0",KEY8
.
          PACK     KEY17,URNUMBER,ONE,SP70
          CALL     RSPTMI18
GETPRE10  CALL     RKPTMI18
          BRANCH   OVRCD,GETPRE95
.
          MATCH    URNUMBER,AURNO
          GOTO     GETPRE95 IF NOT EQUAL
.
          COMPARE  ONE,ASTAT
          GOTO     GETPRE95 IF NOT EQUAL
.
          MATCH    KEY8,ADATE
          GOTO     GETPRE10 IF LESS
.
          UNPACK   ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE     CMON,F2
          LOAD     MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE   HTMLFILE;"Pre admission for ":
                            CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          GOTO     GETPRE95
.
GETPRE95  MOVE     ZERO,EXIT
          GOTO     GETPRE99
.
          INC       PATMI1IO/INC
          INC       IBAOVRIO/INC
.
GETPRE99  ENDPROC
.


CLROBA00  PACK      OBCACID,SP70
          PACK      OBCADTE,SP70
          PACK      OBCATME,SP70
          PACK      OBCAUID,SP70
          PACK      OBCAOCG,SP70
          PACK      OBCATYP,SP70
          PACK      OBCAMDL,SP70
          PACK      OBCAHLV,SP70
          PACK      OBCASLV,SP70
          PACK      OBCAMIN,SP70
          PACK      OBCAPT1,SP70
          PACK      OBCAP1D,SP70
          PACK      OBCAPT2,SP70
          PACK      OBCAP2D,SP70
          PACK      OBCAPT3,SP70
          PACK      OBCAP3D,SP70
          PACK      OBCAPT4,SP70
          PACK      OBCAP4D,SP70
          PACK      OBCAUC1,SP70
          PACK      OBCAUC2,SP70
          PACK      OBCAUC3,SP70
          PACK      OBCAUC4,SP70
          PACK      OBCAUC5,SP70
          PACK      OBCAUC6,SP70
          PACK      OBCAUC7,SP70
          PACK      OBCAUC8,SP70
          PACK      OBCAUD1,SP70
          PACK      OBCAUD2,SP70
          PACK      OBCAUD3,SP70
          PACK      OBCAUD4,SP70
          PACK      OBCADD1,SP70
          PACK      OBCADD2,SP70
          PACK      OBCADLU,SP70
          PACK      OBCATLU,SP70
          PACK      OBCALID,SP70
          PACK      OBCAAT1,SP70
          PACK      OBCAAT2,SP70
          PACK      OBCATX1,SP70,SP70
.
          RETURN
+
