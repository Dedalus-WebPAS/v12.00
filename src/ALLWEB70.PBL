.----------------------------------------------------------------------
. Program       : ALLWEB70
.
. Function      : Print Server - Allied Health / Referrals Management
.                 Print Letters
.
.********* Programmer's Note ********************************************
. Please note that changes that are made to letters will usually also need to
. be made to stationery templating as they use a common piece of code for
. printing the same variable set (GETVAR00).
.************************************************************************
.
. Modifications :
.
.---------------------------------------------------------------------------
. V12.00.01 05/09/2025  Thanh T          TSK 0949457
.           Recompiled for ALLLETCD, ALLLETDF changes
.---------------------------------------------------------------------------
. V11.04.01 17/07/2024  Thanh T          TSK 0939648
.           Recompiled for ALLLETCD, ALLLETDF changes
. V11.03.01 17/10/2023  Peter Vela       TSK 0935874
.           Added parameter check for pmsihiaf
. V11.02.04 20/04/2022  Thanh T          TSK 090345  
.           Recompiled for ALLLETCD, ALLLETDF changes                       
. V11.02.03 08/04/2022  Jacob Jackson    TSK 0864505
.           Recompiled for ALLLETCD, ALLLETDF
.           Add CONTROLF variables - PTCNPFSN, PTCNPFGN
. V11.02.02 23/03/2022  Sunny            TSK 0914741                    
.           Added LXRFFHOS, LXRFTHOS and LXALHCPC                     
. V11.02.01 24/01/2022  Jacob Jackson    TSK 0864505
.           Recomplied for ALLLETCD - Adding preferred name options
. V11.01.01 28/06/2021  Sunny            TSK 0893817
.           Added PTCNSTYP - System Type for Letter              
.           Added MXDYSL00 - Calculated Max Dept on Wait List Time in D/M/Y
.           Added Placeholder - MBIRINIT (Multiple Birth Control)
. V11.00.04 17/11/2020  Thanh T          TSK 0878747                         
.           Added PATATRFD PATATRIO and PATATRTD for ALLLETCD               
. V11.00.03 07/04/2020  Thanh T       TSK 0879163
.           Recompiled for ALLLETCD
. V11.00.02 20/03/2020  Peter Vela    TSK 0889143
.           Fixed ALLLET IO calls
. V11.00.01 19/03/2020  Peter Vela    TSK 0889143
.           Recompiled for ALLLETFD
.---------------------------------------------------------------------------
. V10.15.02 07/02/2020  Ebon Clements  TSK 0887235
.           Recompiled for PMSCEXCD - extra contact postal address
. V10.15.01 15/10/2019  Ken Bell       TSK 0875392
.           Exclude Claim Details if Claim was cancelled
. V10.14.01 19/02/2019  Ebon Clements  TSK 0867703
.           Changed NHI ethnicity file reads to use KEY5 
. V10.13.01 14/08/2018  Ebon Clements  TSK 0861347
.           Fixed key pack for letter history write - PRTAUD00
. V10.10.01 24/03/2017  Richa Phogat   TSK 0832066
.           Included new conession file PMSCCDFD and sub routine GCCARD00
. V10.09.01 07/12/2016  Jill Parkinson TSK 0822329
.           Added ACC Purchase Order output
. V10.08.03 01/07/2016  Peter Vela     TSK 0821692
.           Recompiled for ALLLETCD
. V10.08.02 07/06/2016  Jill Parkinson TSK 0820003
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
.         V10.08.01 31/05/2016  Nicole Torrisi   TSK 0816184
.                   Recompiled for ALLLETCD - Added alerts
.         V10.06.01 21/09/2015  Davin            CAR 313906
.                   Recompiled for PMSCEXCD - allow patmx1af/patma1af details
.         V10.05.03 04/03/2015  Patrick Adair    CAR 312706 
.                   Changed TOPMARG, COUNT, TEMPF2 from Form 2 to 4
.         V10.05.02 10/10/2014  Ania P           CAR 306908 
.                   Added CATCG/CATHP for letters
.         V10.05.01 03/10/2014  Ebon Clements    CAR 268970
.                   Change to use OUTCLIFD index 1 instead of index 2
.         V10.04.01 24/02/2014  Don Nguyen       CAR 291879
.                   Added GTIHINUM (IHI Number)
.         V10.03.11 27/11/2013  Don Nguyen       CAR 293872
.                   Added RNHIET00 & ROCONT00
.                   Recompiled for changes to ALLLETCD & ALLLETDF.
.         V10.03.10 11/10/2013  Steve Armstrong  CAR 289244
.                   Recompiled for changes to ALLWEBCD.
.                   Added code to load extra referral based data (RALEXT00).
.         V10.03.09 30/08/2013  Steve Armstrong  CAR 289244
.                   Recompiled for changes to ALLWEBCD
.         V10.03.08 16/08/2013  Ebon Clements    CAR 290270
.                   Fixed practice details when practice only - RDHCP000
.         V10.03.07 18/07/2013  Don Nguyen       CAR 288603
.                   Recompiled for changes to ALLLETCD - added variable 414
.         V10.03.06 10/07/2013  Don Nguyen       CAR 288152
.                   Recompiled for changes to ALLLETDF, ALLLETCD.
.                   Moved DOCFNAME into LXRERHCP for Referring HCP.
.         V10.03.05 22/05/2013  Davin            CAR 284814
.                   Added PMI GP/Practice fields 391-413 (rpmigp00)
.         V10.03.04 19/12/2012  Don Nguyen       CAR 278200
.                   Recompiled for ALLLETCD and added CATHP
.         V10.03.03 19/11/2012 Saroeun Soeur     CAR 276061
.                   Recompiled for ALLLETCD
.         V10.03.02 15/08/2012 Ebon Clements     CAR 261277   
.                   Assigned new cat code to ALREUC32         
.         V10.03.01 09/11/2011  Ebon Clements    CAR 248529
.                   Added multiple contacts of the same type functionality
.         V10.02.05 09/09/2011  Saroeun Soeur    CAR 245585
.                   Recompiled for ALLLETCD
.         V10.02.04 15/07/2011  Saroeun Soeur    CAR 
.                   Recompiled for changes to ALLLETDF, ALLLETCD
.         V10.02.03 22/06/2011  Steve Armstrong  CAR 240722
.                   Recompiled for changes to PMSCEXCD
.         V10.02.02 10/06/2011  Ebon Clements    CAR 239530
.                   Added print extra contact functionality
.         V10.02.01 22/03/2011  Jill Parkinson   CAR 239574
.                   Recompiled for ALLLPCFD                      
.         V10.01.01 26/11/2010  Jill Parkinson   CAR 233088
.                   Recompiled for ALLLETCD                      
.         V10.00.02 25/10/2010  Peter Vela    CAR 230909
.                   Added read of ALREHCP in RDHCP00
.         V10.00.01 13/09/2010  Ebon Clements CAR 229850
.                   Don't write letter history if letter number blank - PRTAUD00
.         V9.12.03  02/12/2009  Saroeun Soeur CAR 202063
.                   PRTAUD00 - write letter history audit 
.         V9.12.02  16/10/2009  Ebon Clements CAR 190680
.                   Recompiled for DXALLDET -
.                   Fixed pack of VAR after calls to CMPH0000
.         V9.12.01  15/10/2009  WeeLee Koo    CAR 206462
.                   Get ACC No (RDMST250)
.         V9.11.02  04/05/2009  Saroeun Soeur CAR 191508
.                   LXHCPFFL - removed formatting and format is controlled by
.                   controlf
.         V9.11.01  24/04/2009  Saroeun Soeur CAR 191508
.                   added LXHCPTTL,LXHCPFNM,LXHCPSNM,LXHCPFFL
.         V9.10.02  09/09/2008  Ebon Clements CAR 175728
.                   Recompiled for ALLLETCD - Compensable vars and pmi address
.         V9.10.01  29/07/2008  Peter Vela    CAR 151951
.                   Recompiled for ALLLETCD 
.         V9.09.01  05/02/2008  Ebon Clements CAR 163260
.                   Recompiled for ALLLETCD - Don't case ur
.         V9.08.03  23/01/2007  Ebon Clements CAR 127364
.                   Don't reformat site clinic id and type before printing
.         V9.08.02  22/01/2007  Janet George  CAR 127364
.                   Modified the program to display Clinic type description,
.                   Clinic Id description and HCP address details
.         V9.08.01  16/01/2007  Janet George  CAR 127364
.                   Mod to Ref HCP to populate with formatted HCP Name  
.         V9.05.02  24/03/2006  Peter Vela    CAR 61299
.                   Increased SRCHNUM size from FORM3 to FORM5   
.         V9.05.01  09/03/2006  Ebon Clements CAR 78533
.                   Mods for PATCODTM - Hospital specific category codes
.         V9.05.B01 19/01/2005  Mike Laming   CAR 76341
.                   Add Templated Forms
.         V9.05.B00 13/01/2006  Mike Laming  CAR 76341
.                   New Program (with a bit of help from EMRWEB03)
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
          INC       IBADLABS/INC
          INC       IBATMDFD/INC
.
          INC       PATCONFD/INC
          INC       PATALRFD/INC
.
          INC       ALLCONFD/INC
          INC       ALLDADFD/INC
          INC       ALLDIAFD/INC
          INC       ALLPRRFD/INC
          INC       ALLREFFD/INC
          INC       ALLLETFD/INC
          INC       ALLLPCFD/INC
....      INC       ALLLNKFD/INC
          INC       ALLLETDF/INC
.
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
.
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
.
          INC       PATDO1FD/INC
          INC       PATFN1FD/INC
          INC       PATWVEFD/INC
          INC       PATWC1FD/INC
          INC       PMSWX1FD/INC
          INC       PATWMAFD/INC
          INC       PATVADFD/INC
          INC       PMSCCDFD/INC
          INC       PMSCEXFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSIHIFD/INC
          INC       PMSRELFD/INC
.
          INC       PATATRFD/INC
          INC       PATATRTD/INC
.
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCTYFD/INC
          INC       OUTCLIFD/INC 
.
          INC       SCRPSTFD/INC
          INC       SCRSBGFD/INC
          INC       SCRSLTFD/INC
          INC       SCRMASFD/INC
.
          INC       ALLLHIFD/INC
.
.----------------------------------------------------------
BOTTMARG  FORM      2
.
CCODE     DIM       2
CFILEPRE  DIM       3
CLMDET1   DIM       50
CLMDET2   DIM       50
CONTTYPE  DIM       1
CURRROW   FORM      3
CHG       FORM      1
CHKMNCNT  FORM      1          * check mandatory fields cycle counter
COUNTER   FORM      1
COUNT     FORM      4
COMPLETE  FORM      3
CRRDATE   DIM       8
.
DIM3      DIM       3
DIM5      DIM       5
DIM8      DIM       8
DIM70     DIM       70
DOCTCODE  DIM       6
DTFORMAT  FORM      1
DAYSLIST  FORM      4          * Days on list
DEPTCODE  DIM       3          * Allied Health Department Code (CG)
.
ENDSTR    FORM      2
.
FIRSTCH   FORM      1
FORM3     FORM      3
FORM3A    FORM      3
FORM5     FORM      5
FULLNAME  DIM       70
.
HOSPFREF  DIM       30
HOSPTREF  DIM       30
.
IHINUMBR  DIM       20
.
.
LASTROW   FORM      3
LEFTMARG  FORM      2
LETTERNO  DIM       3
LETTFORM  FORM      3
.
MBIRURNO  DIM       8
MBIRTYOR  DIM       24
MXDYSLST  FORM      4
MXYRSLST  FORM      4
MXMTHLST  FORM      4 
MBIRINIT  INIT      "XXXXXXXXXXXXXXXXXXXXXXXXX"
.
.NOCOPIES  FORM      3
.
PAGE      DIM       4
PAGELEN   FORM      4
PERCPOS   FORM      2
PHYSPAGE  FORM      4
PRNTSTRT  FORM      3
PRINTTYP  DIM       1
PRINTVAR  DIM       70
.
STATNCOD  DIM       6
SRCHNUM   FORM      5
SRCHVAR   DIM       15
STARTSTR  FORM      2
SAVKEY8   DIM       8
SAVDEPT   DIM       3
.
TEMPF2    FORM      4
TEMPF3    FORM      3
TEMP70    DIM       70
TOPMARG   FORM      4
.
VARIABLE  DIM       127
VARSTRNG  DIM       70
VISITNUM  DIM       8             * emergency visit number variable
.
TIME      DIM       5
.
.
. PROGRAM CONSTANTS
. ----------------
.
CATAC     INIT      "AC"
CATC      INIT      "C "
CATCA     INIT      "CA"
CATCG     INIT      "CG"
CATCI     INIT      "CI"
CATCL     INIT      "CL"
CATCS     INIT      "CS"
CATCV     INIT      "CV"
CATDA     INIT      "DA"
CATDC     INIT      "DC"
CATDO     INIT      "DO"
CATDX     INIT      "DX"
CATDY     INIT      "DY"
CATFS     INIT      "FS"
CATgb     init      "gb"
CATH1     INIT      "H1"
CATH2     INIT      "H2"
CATH3     INIT      "H3"
CATHP     INIT      "HP"
CAThr     INIT      "hr"
CATiw     INIT      "iw"
CATM      INIT      "M "
CATLA     INIT      "LA"
CA1la     INIT      "la"
CA2lA     INIT      "lA"
CA1lb     INIT      "lb"
CA2lB     INIT      "lB"
CA1lc     INIT      "lc"
CA2lC     INIT      "lC"
CA1ld     INIT      "ld"
CA2lD     INIT      "lD"
CA1le     INIT      "le"
CA2lE     INIT      "lE"
CA1lf     INIT      "lf"
CA2lO     INIT      "lO"
CA1lg     INIT      "lg"
CA2lG     INIT      "lG"
CA1lh     INIT      "lh"
CA2lH     INIT      "lH"
CATLI     INIT      "LI"
CA1li     INIT      "li"
CA2lI     INIT      "lI"
CA1lj     INIT      "lj"
CA2lJ     INIT      "lJ"
CA1lk     INIT      "lk"
CA2lK     INIT      "lK"
CATLL     INIT      "LL"
CA1ll     INIT      "ll"
CA2lL     INIT      "lL"
CA1lm     INIT      "lm"
CA2lM     INIT      "lM"
CATLN     INIT      "LN"
CA1ln     INIT      "ln"
CA2lN     INIT      "lN"
CA1lo     INIT      "lo"
CA1lp     INIT      "lp"
CA1lq     INIT      "lq"
CA1lr     INIT      "lr"
CATLS     INIT      "LS"
CA1ls     INIT      "ls"
CA1lt     INIT      "lt"
CA1lu     INIT      "lu"
CA1lv     INIT      "lv"
CA1lw     INIT      "lw"
CA1lx     INIT      "lx"
CA1ly     INIT      "ly"
CA1lz     INIT      "lz"
CATCZ     INIT      "CZ"
CATO1     INIT      "O1"
CATO2     INIT      "O2"
CATO3     INIT      "O3"
CATO4     INIT      "O4"
CATO5     INIT      "O5"
CATO6     INIT      "O6"
CATO7     INIT      "O7"
CATO8     INIT      "O8"
CATOB     INIT      "OB"
CATOL     INIT      "OL"
CATOZ     INIT      "OZ"
CATP      INIT      "P "
CATP1     INIT      "P1"
CATP2     INIT      "P2"
CATP3     INIT      "P3"
CATP4     INIT      "P4"
CATP5     INIT      "P5"
CATP6     INIT      "P6"
CATP7     INIT      "P7"
CATP8     INIT      "P8"
CATP9     INIT      "P9"
CATPR     INIT      "PR"
CATR      INIT      "R "
CATRI     INIT      "RI"
CATRR     INIT      "RR"
CATRRr    INIT      "rr"
CATsc     INIT      "sc"
CATS      INIT      "S "
CATT      INIT      "T "
CATTC     INIT      "tc"
CATU1     INIT      "U1"
CATV6     INIT      "V6"
CATV7     INIT      "V7"
CATV8     INIT      "V8"
OTHER     INIT      "Other"
REPSTR    INIT      "a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z0102030405060708090"
ZERO4     INIT      "0000"
.
.
. ----------------------------------------------------------------------------
PRGID     INIT      "ALLWEB70"
VERSION   INIT      "V12.00.01"
PRGNAM    INIT      "Print Server - Allied Health Letters"
. ----------------------------------------------------------------------------
.
          CALL      WEBINT00         * Initialise Fifo Etc.
.
          CALL      INIT0000         * Open Files
          MOVE      ZERO,CHKMNCNT    * initialise check mandatory cycle counter
.
MAIN0000  COMMIT
.
          BEGIN
.
          DISPLAY   *W5
.
          ADD       ONE,CHKMNCNT     * check mandatory every 30 sec/6th cycle
          IF        CHKMNCNT>=6
            MOVE      ZERO,CHKMNCNT
          ENDIF
.
          MOVE      ZERO,EXIT
          PACK      KEY5,SP70
          CALL      RSALLPC1
MAIN1000  CALL      RKALLPC1
          BRANCH    OVRCD,MAIN0000
          MOVE      ALLPSCHE,KEY5
          CALL      RLALLPC1
          BRANCH    OVRCD,MAIN0000,MAIN1000
.
.                                           * set printing parameters
          MOVE      ALLPURNO,URNUMBER
          MOVE      ALLPVISN,ADMISSNO
          MOVE      ALLPVISN,VISITNUM
          MOVE      ALLPPRNT,SELPRINT       * (was PRINTRNO)
          MOVE      ALLPCOPY,NOCOPIES
          MOVE      ALLPSTAT,STATNCOD
          MOVE      ALLPLETT,LETTERNO
          MOVE      ALLPPTYP,PRINTTYP
          MOVE      ALLPWEBU,WBSEUID
.
.
          PACK      KEY10,ALLPWEBU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,PASSCODE
          ELSE
            MOVE      WBSEPCD,PASSCODE      * Set Passcode for printing
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD * current date
          REP       " 0",CURRDATE
.
          MOVE      ALLPPTYP,F1
          BRANCH    F1,MAIN2100:            * "Letters"
                       MAIN2200             * "Forms" (Stationery Type "17")
          GOTO      MAIN9000
.
MAIN2100  CALL      PRTLET00                 * Print Allied Health Letters
          CALL      PRTAUD00
          GOTO      MAIN9000
.
MAIN2200  CALL      PRTFRM00                 * Print AH templated Forms  
          GOTO      MAIN9000
.
MAIN9000  MOVE      ALLPSCHE,KEY5
          CALL      DEALLPC1
          CALL      UUALLPC1
.
          COMMIT
          BEGIN
.
          GOTO      MAIN1000
.
.------------------------------------------------------------
. Program Initialisation
.------------------------------------------------------------
INIT0000  MOVE      ZERO,EXIT
          OPEN      ALLLETR1,"allletaf"
          OPEN      ALLLPCA1,"alllpcaf"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLPRRA1,"allprraf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLREFA4,"allrefaf"
.
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND28;*210,PTCNSTYP
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          OPEN      PATDO1A1,"patdo1af"
...       OPEN      PATHSPA1,"pathspaf"     * Hospital Details
          OPEN      PATCODE1,"patcodes"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSHCPA1,"pmshcpaf"     * Healthcare Profess
          OPEN      PMSHCGA1,"pmshcgaf"     * HCP Practice
          OPEN      PMSRELA1,"pmsrelaf"     * Relationship types
.
          OPEN      NHIETHA1,"nhiethaf"     * Ethnicity Codes
          OPEN      NHIMASA2,"nhimasaf"     * NHI/MWS HCU Details
.
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBAPDFA1,"ibapdfaf"
.
          MATCH     "0",PTCNUNET
          IF        !@EQUAL
            OPEN      PMSIHIA1,"pmsihiaf"     * IHI Details
          ENDIF
.
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          OPEN      OUTSITA1,"outsitaf"     * Open the site file
          OPEN      ALLLHIA1,"alllhiaf"
          OPEN      ALLDADA1,"alldadaf"
          OPEN      WEBERRA1,"weberraf"
...       OPEN      OUTSITA3,"outsitaf"     * Open the site file
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
.
INIT9999  RETURN
+
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
...       PACK      CFNAME,CFILEPRE,FILRSHA1
...       CLOSE     OUTRSHA1
...       OPEN      OUTRSHA1,CFNAME
.
...       PACK      CFNAME,CFILEPRE,FILCANA2
...       CLOSE     OUTCANA2
...       OPEN      OUTCANA2,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BOKA3 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME
.
...       PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
...       CLOSE     OUTSESA1
...       OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
...       PACK      CFNAME,CFILEPRE,FILMA1A1
...       CLOSE     OUTMA1A1
...       OPEN      OUTMA1A1,CFNAME
.
...       PACK      CFNAME,CFILEPRE,FILHEDA1
...       CLOSE     OUTHEDA1
...       OPEN      OUTHEDA1,CFNAME
.
...       PACK      CFNAME,CFILEPRE,FILDIAG1
...       CLOSE     OUTDIAG1
...       OPEN      OUTDIAG1,CFNAME
.
OPNOUT99  RETURN
+
.---------------------------------------------------------------
.         Print Audit History 
.---------------------------------------------------------------
PRTAUD00  MATCH     SP70,ALLPLETT       * Don't write history if 
          GOTO      PRTAUD99 IF EQUAL   * letter number blank
.
          MOVE      URNUMBER,ALLHURNO   * ur
          MOVE      CURRDATE,ALLHDATE   * date
          CLOCK     TIME,ALLHTIME       * time
          MOVE      ALLPLETT,ALLHLTNO   * letter number
          MOVE      ALLPVISN,ALLHREFN   * referral number
          MOVE      ALLPWEBU,ALLHUSER   * web user id
.
          PACK      KEY35,ALLHURNO,ALLHREFN,ALLHLTNO,ALLHDATE,ALLHTIME,SP70
          CALL      RAALLHI1
          IF        OVRCD=1
            CALL      WRALLHI1
          ENDIF
.
PRTAUD99  RETURN
+
.---------------------------------------------------------------
.                   Print Allied Health Letter
.---------------------------------------------------------------
PRTLET00  MOVE      ZERO,EXIT
.
          CALL      RDMST000
          BRANCH    EXIT,PRTLET99
.                                           * read the Referral Letters file
          CALL      RDHCP000
          CALL      RPMIGP00                * get pmi hcp/hcg data
          CALL      RALEXT00                * get extra referral details
          CALL      RNHIET00                * get NHI Patient/Ethnicity details
          CALL      ROCONT00                * get other contact details
. 
          MOVE      ZERO,FORM3
          PACK      KEY6,LETTERNO,FORM3
          CALL      RDALLET1
          BRANCH    OVRCD,PRTLET90
.
          CALL      OPNPRINT
.
.
          MOVE      ZERO,COMPLETE
PRTLET30  ADD       ONE,COMPLETE            * check number of copies printed
          IF        COMPLETE > NOCOPIES
            GOTO      PRTLET40
          ENDIF
          CALL      PRIN0000                * print a letter
          GOTO      PRTLET30
.
PRTLET40  CALL      CLSPRINT
          GOTO      PRTLET99
.
.
PRTLET90  MOVE      "Letter not on File.",WEBTITLE
          CALL      PRTERR00
          MOVE      ONE,EXIT
.
PRTLET99  RETURN
+
.---------------------------------------------------------------
.                   Print Allied Health Forms (Templated stuff)
.---------------------------------------------------------------
PRTFRM00  MOVE      ZERO,EXIT
.
          CALL      RDMST000
          BRANCH    EXIT,PRTFRM99
.                                           * read Template Header
          CALL      RDHCP000
          CALL      RPMIGP00                * get pmi hcp/hcg data
          CALL      RALEXT00                * get extra referral details
          CALL      RNHIET00                * get NHI Patient/Ethnicity details
          CALL      ROCONT00                * get other contact details
.
          PACK      KEY6,STATNCOD,SP6
          CALL      RDIBTH1
          BRANCH    OVRCD,PRTFRM90
.
          MATCH     "1",IBTHACTV
          GOTO      PRTFRM90 IF NOT EQUAL   * template not active
.
.
          CALL      OPNPRINT
.
.
          MOVE     ZERO,COMPLETE
PRTFRM30  ADD      ONE,COMPLETE             * check number of copies printed
          IF       COMPLETE > NOCOPIES
            GOTO     PRTFRM40
          ENDIF
.
          CALL     FORMP000                 * print a form
          GOTO     PRTFRM30
.
PRTFRM40  CALL     CLSPRINT
          GOTO     PRTFRM99
.
.
PRTFRM90  MOVE      "Stationery Code not on File.",WEBTITLE
          CALL      PRTERR00
          MOVE      ONE,EXIT
.
PRTFRM99  RETURN
+
.******************************************************************************
.*                           RDHCP000                                         *
.*        Routine to read all HCP data for Letters or Forms                   *
.******************************************************************************
RDHCP000  MOVE      SP70,LXRERHCP
          MOVE      SP70,LXHCPAD1
          MOVE      SP70,LXHCPAD2
          MOVE      SP70,LXHCPAD3
          MOVE      SP70,LXHCPAD4
          MOVE      SP70,LXHCPAD5
          MOVE      SP70,LXHCPAD6
          MOVE      SP70,LXHCPPOC
          MOVE      SP70,LXHCPSTA
          PACK      LXHCPEMA,SP70,SP70
          MOVE      SP70,LXHCPTEL
          MOVE      SP70,LXHCPFAX
          MOVE      SP70,LXHCPRAC
          MOVE      SP70,PMHCTITL
          MOVE      SP70,LXHCPFNM
          MOVE      SP70,LXHCPSNM
          MOVE      SP70,LXHCPTTL
          MOVE      SP70,LXHCPFFL
          MOVE      SP70,LXALREHS
          MOVE      SP70,LXALREHG
          MOVE      SP70,LXLNPNAM
          MOVE      SP70,LXLNPAD1            * Get values from HCG File
          MOVE      SP70,LXLNPAD2
          MOVE      SP70,LXLNPAD3
          MOVE      SP70,LXLNPAD4
          MOVE      SP70,LXLNPPOS
          MOVE      SP70,LXLNPPHN
          MOVE      SP70,LXLNPFAX
          MOVE      SP70,LXLREREJ
.
.         Responsible HCP
.
          PACK      KEY10,ALREHCP,SP70           * To get Responsible HCP name
          CALL      RDPMHCP1                     * !! datefile not exists
          IF        OVRCD=0
            MOVE      PMHCGNAM,LXALREHG
            MOVE      PMHCSNAM,LXALREHS
          ENDIF
.
          PACK      KEY10,ALRERHCP,SP70          * To get Referring HCP name
          CALL      RDPMHCP1                     * !! datefile not exists
          IF        OVRCD=0
            MOVE      PMHCTITL,LXHCPTTL
            MOVE      PMHCGNAM,LXHCPFNM
            MOVE      PMHCSNAM,LXHCPSNM
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
.
            CALL      DOCNM000
            MOVE      DOCFNAME,LXRERHCP          * Referring HCP name
.
            MOVE      PMHCADR1,LXHCPAD1          * Get values from HCP file
            MOVE      PMHCADR2,LXHCPAD2
            MOVE      PMHCADR3,LXHCPAD3
            MOVE      PMHCADR4,LXHCPAD4
            MOVE      PMHCADR5,LXHCPAD5
            MOVE      PMHCADR6,LXHCPAD6
            MOVE      PMHCPOST,LXHCPPOC
            MOVE      PMHCSTAT,LXHCPSTA
            MOVE      PMHCSEML,LXHCPEMA
            MOVE      PMHCSTEL,LXHCPTEL
            MOVE      PMHCFAXN,LXHCPFAX
          ENDIF
.
          MATCH     SP70,ALRERHCR              * Chk if practise exists
          IF        !@EQUAL
            PACK      KEY12,ALRERHCR,ALRERHCT,SP70
            CALL      RDPMHCG1
            IF        OVRCD=0
              MOVE      PMHGPNAM,LXHCPRAC
              MOVE      PMHGPNAM,LXLNPNAM    
              MOVE      PMHGADD1,LXLNPAD1            * Get values from HCG File
              MOVE      PMHGADD2,LXLNPAD2
              MOVE      PMHGADD3,LXLNPAD3
              MOVE      PMHGADD4,LXLNPAD4
              MOVE      PMHGPOST,LXLNPPOS
              MOVE      PMHGPTEL,LXLNPPHN
              MOVE      PMHGPFAX,LXLNPFAX
            ENDIF
          ENDIF
.
RDHCP999  RETURN
+
.*****************************************************************************
.*                        RALEXT00                 Called by: PRTLET00       *
.*        Load extra variables based on referral data         PRTFRM00       *
.*****************************************************************************
.
.         Clear the variables first
.
RALEXT00  MOVE      SP70,LXREPRO1
          MOVE      SP70,LXREPRO2
          MOVE      SP70,LXREPRO3
          MOVE      SP70,LXREDIA1
          MOVE      SP70,LXREDIA2
          MOVE      SP70,LXREDIA3
.
          MATCH     SP3,ALREDEPT                 * blank department code ?
          GOTO      RALEXT99 IF EQUAL            * yes - finished
.
          MATCH     SP3,ALREPRO1                 * blank problem code 1 ?
          GOTO      RALEXT10 IF EQUAL            * yes
.
          PACK      KEY12,ALREDEPT,ALREPRO1
          CALL      RDALPRR1                     * problem 1 code on file ?
          IF        OVRCD = 0
            MOVE      ALPRDESC,LXREPRO1          * yes
          ENDIF
.
RALEXT10  MATCH     SP3,ALREPRO2                 * blank problem code 2 ?
          GOTO      RALEXT20 IF EQUAL            * yes
.
          PACK      KEY12,ALREDEPT,ALREPRO2
          CALL      RDALPRR1                     * problem 2 code on file ?
          IF        OVRCD = 0
            MOVE      ALPRDESC,LXREPRO2          * yes
          ENDIF
.
RALEXT20  MATCH     SP3,ALREPRO3                 * blank problem code 3 ?
          GOTO      RALEXT30 IF EQUAL            * yes
.
          PACK      KEY12,ALREDEPT,ALREPRO3
          CALL      RDALPRR1                     * problem 3 code on file ?
          IF        OVRCD = 0
            MOVE      ALPRDESC,LXREPRO3          * yes
          ENDIF
.
RALEXT30  MATCH     SP3,ALREDIA1                 * blank diagnosis code 1 ?
          GOTO      RALEXT40 IF EQUAL            * yes
.
          PACK      KEY12,ALREDEPT,ALREDIA1
          CALL      RDALDIA1                     * diagnosis 1 code on file ?
          IF        OVRCD = 0
            MOVE      ALDIDESC,LXREDIA1          * yes
          ENDIF
.
RALEXT40  MATCH     SP3,ALREDIA2                 * blank diagnosis code 2 ?
          GOTO      RALEXT50 IF EQUAL            * yes
.
          PACK      KEY12,ALREDEPT,ALREDIA2
          CALL      RDALDIA1                     * diagnosis 2 code on file ?
          IF        OVRCD = 0
            MOVE      ALDIDESC,LXREDIA2          * yes
          ENDIF
.
RALEXT50  MATCH     SP3,ALREDIA3                 * blank diagnosis code 3 ?
          GOTO      RALEXT99 IF EQUAL            * yes
.
          PACK      KEY12,ALREDEPT,ALREDIA3
          CALL      RDALDIA1                     * diagnosis 3 code on file ?
          IF        OVRCD = 0
            MOVE      ALDIDESC,LXREDIA3          * yes
          ENDIF
.
RALEXT99  RETURN
+
.******************************************************************************
.*                           RPMIGP00                                         *
.*        Routine to read all HCP data for PMI GP and Practice                *
.******************************************************************************
RPMIGP00  PACK      LXPMTITL,SP70,SP70
          PACK      LXPMGNAM,SP70,SP70
          PACK      LXPMSNAM,SP70,SP70
          PACK      LXPMFNAM,SP70,SP70
          PACK      LXPMADR1,SP70,SP70
          PACK      LXPMADR2,SP70,SP70
          PACK      LXPMADR3,SP70,SP70
          PACK      LXPMADR4,SP70,SP70
          PACK      LXPMPOST,SP70,SP70
          PACK      LXPMSEML,SP70,SP70
          PACK      LXPMSTEL,SP70,SP70
          PACK      LXPMFAXN,SP70,SP70
          PACK      LXPGPNAM,SP70,SP70
          PACK      LXPGADD1,SP70,SP70
          PACK      LXPGADD2,SP70,SP70
          PACK      LXPGADD3,SP70,SP70
          PACK      LXPGADD4,SP70,SP70
          PACK      LXPGADD5,SP70,SP70
          PACK      LXPGADD6,SP70,SP70
          PACK      LXPGPOST,SP70,SP70
          PACK      LXPGPEML,SP70,SP70
          PACK      LXPGPTEL,SP70,SP70
          PACK      LXPGPFAX,SP70,SP70
.
.         PMI GP & Practice data
.
          MATCH     SP70,PMPXRHC1
          GOTO      RPMIGP50 IF EQUAL
.
          PACK      KEY10,PMPXRHC1,SP70          * To get HCP data
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,LXPMTITL
            MOVE      PMHCGNAM,LXPMGNAM
            MOVE      PMHCSNAM,LXPMSNAM
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
.
            CALL      DOCNM000
            MOVE      DOCFNAME,LXPMFNAM
.
            MOVE      PMHCADR1,LXPMADR1
            MOVE      PMHCADR2,LXPMADR2
            MOVE      PMHCADR3,LXPMADR3
            MOVE      PMHCADR4,LXPMADR4
            MOVE      PMHCPOST,LXPMPOST
            MOVE      PMHCSEML,LXPMSEML
            MOVE      PMHCSTEL,LXPMSTEL
            MOVE      PMHCFAXN,LXPMFAXN
          ENDIF
.
RPMIGP50  MATCH     SP70,PMPXRH1G
          GOTO      RPMIGP99 IF EQUAL
.
          MATCH     SP70,PMPXR1GC
          GOTO      RPMIGP99 IF EQUAL
.
          PACK      KEY12,PMPXRH1G,PMPXR1GC,SP70 * To get HCG data
          CALL      RDPMHCG1
          IF        OVRCD=0
            MOVE      PMHGPNAM,LXPGPNAM
            MOVE      PMHGADD1,LXPGADD1
            MOVE      PMHGADD2,LXPGADD2
            MOVE      PMHGADD3,LXPGADD3
            MOVE      PMHGADD4,LXPGADD4
            MOVE      PMHGADD5,LXPGADD5
            MOVE      PMHGADD6,LXPGADD6
            MOVE      PMHGPOST,LXPGPOST
            MOVE      PMHGPEML,LXPGPEML
            MOVE      PMHGPTEL,LXPGPTEL
            MOVE      PMHGPFAX,LXPGPFAX
          ENDIF
.
RPMIGP99  RETURN
+
.******************************************************************************
.*                           RDMST000                                         *
.*        Routine to read all Patient data for Letters or Forms               *
.******************************************************************************
RDMST000  MOVE      ZERO,EXIT
.                                           * read the PMI Master
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RDMST900
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,PNKNAME      * NEXT OF KIN 1 NAME
            MOVE      PMCEADD1,PNKADD1      * N.O.K 1 ADDRESS LINE 1
            MOVE      PMCEADD2,PNKADD2      * N.O.K 1 ADDRESS LINE 2
            MOVE      PMCEADD3,PNKSUBR      * N.O.K 1 ADDRESS LINE 3
            MOVE      PMCEADD4,PNKADD4      * N.O.K 1 ADDRESS LINE 4
            MOVE      PMCEPOST,PNKPOST      * N.O.K 1 POSTCODE
            MOVE      PMCETELP,PNKTELP      * N.O.K 1 PRIVATE TELEPHONE
            MOVE      PMCETELB,PNKTELB      * N.O.K 1 BUSINESS TELEPHONE
            MOVE      PMCETELM,PMPXKMOB     * N.O.K 1 MOBILE        
            MOVE      PMCERELP,PNKRELP      * N.O.K 1 RELATIONSHIP
            MOVE      PMCEEMAI,PMPXKEML     * N.O.K 1 EMAIL
            MOVE      PMCESLET,PMPXKCRP     * N.O.K 1 Send Letter
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,PTMXADD1     * POSTAL ADDRESS LINE 1
            MOVE      PMCEADD2,PTMXADD2     * POSTAL ADDRESS LINE 2
            MOVE      PMCEADD3,PTMXADD3     * POSTAL ADDRESS LINE 3
            MOVE      PMCEADD4,PTMXADD4     * POSTAL ADDRESS LINE 4
            MOVE      PMCEPOST,PTMXPOST     * POSTAL POSTCODE
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,PTMXECNM     *  Emergency Contact 1 Name
            MOVE      PMCEADD1,PTMXECA1     *  Emergency Contact Address Line 1
            MOVE      PMCEADD2,PTMXECA2     *  Emergency Contact Address Line 2
            MOVE      PMCEADD3,PTMXECA3     *  Emergency Contact Address Line 3
            MOVE      PMCEADD4,PTMXECA4     *  Emergency Contact Address Line 4
            MOVE      PMCEPOST,PTMXECPC     *  Emergency Contact Postcode
            MOVE      PMCETELP,PTMXECPP     *  Emergency Contact Private Tel
            MOVE      PMCETELB,PTMXECBP     *  Emergency Contact Business Tel
            MOVE      PMCETELM,PMPXCMOB     *  Emergency Contact MobilE
            MOVE      PMCERELP,PTMXECRE     *  Emergency Contact Relationship
            MOVE      PMCEEMAI,PMPXCEML     *  Emergency Contact Email
            MOVE      PMCESLET,PMPXCCRP     *  Emergency Contact Send Letter
          ENDIF
.
          MATCH     "1",PTCNUNET
          IF        @EQUAL
            CALL      GTIHINUM
            MOVE      IHINUMBR,LXIHINUM
          ENDIF
.
          CALL      FNAM0000                * format name into FULLNAME
          CALL      PACADDRS                * formatted address
.                                           * read the Referral table
          MOVE      VISITNUM,KEY8
          CALL      RDALREF1
          BRANCH    OVRCD,RDMST900
.
          MOVE      ALREVISN,SAVKEY8
.
RDMST100  MOVE      SP70,LXRCTDES
          MOVE      SP70,LXRCIDES
          MOVE      SP70,LXBCTDES
          MOVE      SP70,LXBCIDES
.
          CALL      CMPH0000                * Compensable/Heath Fund Name
.
          MATCH     SP6,ALREPSIT            * Check if Outpatient data required
          GOTO      RDMST250 IF EQUAL       * no - no Site code
.
          PACK      KEY6,ALREPSIT,SP6
          CALL      RDSITA1                * Referral preferred site
          BRANCH    OVRCD,RDMST250
.
          MATCH     CFILEPRE,OSTFILE
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CALL      OPNOUT00              * open the correct Outpatient files
          ENDIF
.
.         Get the clinic descriptions for the Referral Clinic Type and Id
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1                * To get Clinic Type Description
          IF        OVRCD=0
            MOVE      OCTDESC,LXRCTDES
          ENDIF
.
          PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,ALREPSIT,ALRECLID,ALRERDAT,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,RDMST250
.
            MATCH     ALREPSIT,OCASITE
            GOTO      RDMST250 IF NOT EQUAL
.
            MATCH     ALRECLID,OCACLIN
            GOTO      RDMST250 IF NOT EQUAL
          ENDIF
.
          MOVE      OCADESC,LXRCIDES
.
RDMST250  MOVE      SP70,LXHACCNO
          PACK      KEY8,VISITNUM,SP70
          CALL      RDPMWX11
          IF        OVRCD = 1
            CALL      CLPMSWX1
          ENDIF
.
          PACK      KEY8,VISITNUM,SP70
          CALL      RDWCOM1
          IF        OVRCD = 0
            MATCH     "3",PMWXCSTA          * Claim Cancelled
            IF        !@EQUAL
              MOVE    WCCLMNO,LXHACCNO
            ENDIF
          ENDIF
.
          MATCH     SP6,ALLPOUST            * Check if Outpatient data required
          GOTO      RDMST700 IF EQUAL       * no - no Site code
.
          PACK      KEY6,ALLPOUST,SP6
          CALL      RDSITA1
          BRANCH    OVRCD,RDMST700
.
          MATCH     CFILEPRE,OSTFILE
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CALL      OPNOUT00              * open the correct Outpatient files
          ENDIF
.                                           * read Outpatient Session Booking
          PACK      KEY36,ALLPOUNO,SP30
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          MATCH     ALLPOUNO,DOBAOUTN
          GOTO      RDMST700 IF NOT EQUAL   * Booking found ?  
.
.                                           * read Outpatient Session Booking 2
          PACK      KEY8,ALLPOUNO,SP10
          CALL      RDBOKB1
          BRANCH    OVRCD,RDMST750
.
.         Get the clinic descriptions for the OP Clinic Type and Id
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1                * To get Clinic Type Description
          IF        OVRCD=0
            MOVE      OCTDESC,LXBCTDES
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,RDMST999
.
            MATCH     OBASITE,OCASITE
            GOTO      RDMST999 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      RDMST999 IF NOT EQUAL
          ENDIF
.
          MOVE      OCADESC,LXBCIDES
.
          GOTO      RDMST999
.
RDMST700  CALL      CLOUTBOA
RDMST750  CALL      CLOUTBB1
          GOTO      RDMST999
.
RDMST900  MOVE      ONE,EXIT
.
RDMST999  RETURN
+
.*****************************************************************************
.*                        RNHIET00                 Called by: PRTLET00       *
.*        Load NHI Patient & Ethnicity data                   PRTFRM00       *
.*****************************************************************************
RNHIET00  MOVE      SP70,LXNHIE1D
          MOVE      SP70,LXNHIE2D
          MOVE      SP70,LXNHIE3D
          MOVE      SP70,LXNHIRES
.
          MOVE      PURNO,KEY8
          CALL      RDNHMAS2
          BRANCH    OVRCD,RNHIET99
.
          MATCH     SP5,NHMAETH             * Ethnicity 1 code
          IF        !@EQUAL
            PACK      KEY5,NHMAETH,SP10
            CALL      RDNHETH1
            BRANCH    OVRCD,RNHIET01
.
            MOVE      NHETDES,LXNHIE1D
          ENDIF
.
RNHIET01  MATCH     SP5,NHMAETH2            * Ethnicity 2 code
          IF        !@EQUAL
            PACK      KEY5,NHMAETH2,SP10
            CALL      RDNHETH1
            BRANCH    OVRCD,RNHIET02
.
            MOVE      NHETDES,LXNHIE2D
          ENDIF
.
RNHIET02  MATCH     SP5,NHMAETH3            * Ethnicity 3 code
          IF        !@EQUAL
            PACK      KEY5,NHMAETH3,SP10
            CALL      RDNHETH1
            BRANCH    OVRCD,RNHIET03
.
            MOVE      NHETDES,LXNHIE3D
          ENDIF
.
RNHIET03  REP       UPPLOW,NHMARES
          MATCH     "Y",NHMARES
          IF        @EQUAL
            MOVE      "Yes",LXNHIRES
          ENDIF
.
          MATCH     "N",NHMARES
          IF        @EQUAL
            MOVE      "No ",LXNHIRES
          ENDIF
.
RNHIET99  RETURN
+
.*****************************************************************************
.*                        ROCONT00                 Called by: PRTLET00       *
.*        Load patient's Other contact details                PRTFRM00       *
.*****************************************************************************
ROCONT00  MOVE      SP70,LXNXKINR           * Next of Kin Relationship
          MOVE      SP70,LXEMRCON           * Emergency Contact description
.
          PACK      KEY10,PNKRELP,SP10
          CALL      RDPMREL1
          IF        OVRCD=0
            MOVE      PMRLDESC,LXNXKINR
          ENDIF
.
          PACK      KEY10,PTMXECRE,SP10
          CALL      RDPMREL1
          IF        OVRCD=0
            MOVE      PMRLDESC,LXEMRCON
          ENDIF
.
ROCONT99  RETURN
+
.
.******************************************************************************
.*                           FNAM0000                                         *
.*                routine to Format patient's NAMe                            *
.******************************************************************************
FNAM0000  CLEAR     VARSTRNG
          RESET     PTITL
          MATCH     SP4,PTITL               * test title for spaces
          GOTO      FNAM2000 IF EQUAL
.         
FNAM0500  CMATCH    SP1,PTITL               
          GOTO      FNAM1000 IF EQUAL       
          MOVE      PTITL,ANS               * append title to varstrng
          APPEND    ANS,VARSTRNG
          BUMP      PTITL
          GOTO      FNAM1000 IF EOS         
          
          GOTO      FNAM0500
.
FNAM1000  RESET     PTITL
          APPEND    DOT,VARSTRNG
          APPEND    SP1,VARSTRNG
          MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1700 IF EQUAL
.
FNAM1500  APPEND    PGNAME,VARSTRNG         * append given name to varstrng
          APPEND    SP1,VARSTRNG
.
FNAM1700  APPEND    PSNAME,VARSTRNG
          RESET     VARSTRNG
          CALL      COMP0000                * compress blanks
....      CALL      CASE0000                * convert to lower case
          MOVE      VARSTRNG,FULLNAME
          GOTO      FNAM9999
.
FNAM2000  MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1500 IF NOT EQUAL
          GOTO      FNAM1700
.
FNAM9999  RETURN
+
.******************************************************************************
.*                              COMP0000                                      *
.*            routine to COMPress excessive blanks in VARSTRNG                *
.******************************************************************************
COMP0000  MOVE      VARSTRNG,DIM70
          PACK      TEMP70,SP70
          MATCH     TEMP70,DIM70                 * test line for spaces
          GOTO      COMP9999 IF EQUAL
          CLEAR     VARSTRNG
.
COMP1000  CMATCH    SP1,DIM70
          GOTO      COMP5000 IF NOT EQUAL        * compress leading blanks
          BUMP      DIM70
          GOTO      COMP1000 IF NOT EOS
          GOTO      COMP8000
.
COMP5000  MOVE      DIM70,TEMP70
          MOVE      TEMP70,DIM70
          ENDSET    DIM70
.
COMP5100  CMATCH    SP1,DIM70
          GOTO      COMP7000 IF NOT EQUAL   * compress trailing blanks
          BUMP      DIM70,-1
          GOTO      COMP5100
.
COMP7000  LENSET    DIM70
          RESET     DIM70
.
COMP7100  MOVE      DIM70,ANS
          APPEND    ANS,VARSTRNG
          BUMP      DIM70                   * compress multiple blanks
          GOTO      COMP8000 IF EOS         *   from in-between words
          CMATCH    SP1,DIM70
          GOTO      COMP7100 IF NOT EQUAL
          MOVE      DIM70,ANS
          APPEND    ANS,VARSTRNG
.
COMP7200  BUMP      DIM70
          CMATCH    SP1,DIM70
          GOTO      COMP7100 IF NOT EQUAL
          GOTO      COMP7200
.
COMP8000  RESET     VARSTRNG
          GOTO      COMP9999
.
COMP9999  RETURN
.-----------------------------------------------------------------------------
.         Transfer hospital codes and descriptions 
.-----------------------------------------------------------------------------
HOSTC000  MOVE      SP70,LXRFFHOS
          MOVE      SP70,LXRFTHOS
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALDAD1
          BRANCH    OVRCD,HOSTC999
.
          PACK      KEY5,ALDAFHOS,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            MOVE      ALDAFHOS,PTVADESC
          ENDIF
.
          MOVE      PTVADESC,HOSPFREF    
.
          MOVE      SP70,PTVADESC  
          PACK      KEY5,ALDATHOS,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            MOVE      ALDATHOS,PTVADESC
          ENDIF
.
          MOVE      PTVADESC,HOSPTREF   
.            
HOSTC999  RETURN
.
.-----------------------------------------------------------------------------
. To output the maximum number of 'List Days' in days/month/years for using 
. the value for List Days shown on standard/allweb0201006.html for 
. the Referral Department (allrefaf.alredept) - TSK 0893817
.
. Output: MXDYSLST  FORM 4  - Maximum number of List Days in days
.         MXYRSLST  FORM 4  - Maximum number of List Days in years
.         MXMTHLST  FORM 4  - Maximum number of List Days in months
.-----------------------------------------------------------------------------
MXDYSL00  MOVE      ZERO,MXDYSLST
          MOVE      ZERO,MXYRSLST
          MOVE      ZERO,MXMTHLST
          MOVE      ALREDEPT,SAVDEPT
.
          PACK      KEY22,SAVDEPT,ZERO,SP70
          CALL      RSALREF4                * positional read
MXDYSL10  CALL      RKALREF4                * read a record forward
          BRANCH    OVRCD,MXDYSL90
.
.         match dept and status 
.
          MATCH     ALREDEPT,SAVDEPT
          GOTO      MXDYSL90 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * check waiting list status 
          GOTO      MXDYSL90 IF NOT EQUAL          
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          MOVE      ZERO,DAYSLIST
          MATCH     SP70,ALRERDAT
          IF        !@EQUAL
            DAYSEP    ALRERDAT,CRRDATE,DAYSLIST
          ENDIF
.
          COMPARE   DAYSLIST,MXDYSLST
          IF        @LESS
            MOVE      DAYSLIST,MXDYSLST     * store new max days
          ENDIF
.            
          GOTO      MXDYSL10
.
.         re-read original referral to restore values
.
MXDYSL90  MOVE      MXDYSLST,MXYRSLST       * store to calc in years
          MOVE      MXDYSLST,MXMTHLST       * store to calc in months
.
          DIV       "365",MXYRSLST
          DIV       "30",MXMTHLST 
.
          PACK      KEY8,SAVKEY8,SP70
          CALL      RDALREF1
.
MXDYSL99  RETURN
.
.-------------------------------------------------
. Format Doctors Given Name
.-------------------------------------------------
DOCGIV00  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV00 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this name
.
          UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
.         Check for any more names
.
          SETLPTR   NAME35,35              * reset logical length
          ADD       ONE,CCITEM             * position of 1st blank
          RESET     NAME35,CCITEM          * reset to this point
          PACK      KEY35,NAME35,SP70      * reset form pointer
          MOVE      KEY35,NAME35

DOCGIV10  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV10 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this Initial
.
          UNPACK    NAME35,KEY1,KEY50
          APPEND    KEY1,DISPNAME
          APPEND    SP1,DISPNAME
.
          GOTO      DOCGIV99
.
.         Rest of the string is one name
.
DOCGIV20  UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
DOCGIV99  RETURN
.
.------------------------------------------------------------
. Log Printing Error to Web Error Log
.------------------------------------------------------------
PRTERR00  CLOCK     TIME,CTIMEIS
          MOVE      "ALLWEB70",PRGID
          PACK      KEY24,PRGID,CCC,CYY,CMM,CDD,CTIMEIS,SP70
          REP       " 0",KEY24
          CALL      RDWBER1
          IF        OVRCD=0
            GOTO      PRTERR99
          ENDIF
          UNPACK    KEY24,WBERPID,WBERDAT,WBERTIM
          MOVE      WEBTITLE,WBERERR
          MOVE      USERID,WBERUID
          MOVE      REPORTNO,WBERREP
          MOVE      TEMPLATE,WBERTMP
          MOVE      URNUMBER,WBERURN
          MOVE      ADMISSNO,WBERVIS
          MOVE      PRGERRCT,F3
          MOVE      F3,WBERCNT
          MOVE      SP70,WBERSPA
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WRWBER1
          TRAPCLR   IO
.
PRTERR99  RETURN
+
.---------------------------------------------------------------
. Clear Parameters (NOT USED - REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
CLRPAR00  RETURN 
.---------------------------------------------------------------
. Set Parameters   (NOT USED - REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
SETPAR00  RETURN
.---------------------------------------------------------------
. Process Fields   (NOT USED - REQUIRED FOR STANDARD WEB INCLUDES)
.---------------------------------------------------------------
PROFLD00  RETURN
.
.
.-----------------------------------------------------------------------------
.
          INC       IBAWEBCD
.
          INC       NAMSTRCD
.
          INC       PATPAOFS
.
          INC       ALLLETCD
          INC       GTIHINUM
          INC       CLPMSWX1
          INC       IBATMDIO/INC
          INC       ALLDIAIO/INC
          INC       ALLDADIO/INC
          INC       ALLPRRIO/INC
          INC       ALLREFIO/INC
          INC       ALLLETIO/INC
          INC       ALLLPCIO/INC
....      INC       ALLLNKIO/INC
.
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
.
          INC       PATDO1IO/INC
          INC       PATFN1IO/INC
          INC       PATMA1IO/INC
          INC       PATWVEIO/INC
          INC       PATWC1IO/INC
          INC       PMSWX1IO/INC
          INC       PATWMAIO/INC
          INC       PATVADIO/INC
.
          INC       PMSCCDIO/INC
          INC       PMSCEXIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSIHIIO/INC
          INC       PMSPX2IO/INC
          INC       PMSRELIO/INC
.
          INC       PATATRIO/INC
          INC       MULBIR00
.
          INC       CLOUTBOA
          INC       CLOUTBB1
          INC       CLPMSCEX
          INC       GCCARD00
          INC       PACADDRS
          INC       PATDOCCD
          INC       PMSCEXCD
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCTYIO/INC
          INC       OUTCLIIO/INC
          INC       ALLLHIIO/INC
.
          INC       CLPATMAS
          INC       CLPMSPX2
