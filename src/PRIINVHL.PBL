.******************************************************************************
.*                                                                            *
.*  PRIINVHL - PRI Invoice Header Fields                                      *
.*                                                                            *
.* &&&&& Make sure the file ibavaraf is updated with the new variables &&&&&  *
.*                                                                            *
.* Modifications  :                                                           *
.*----------------------------------------------------------------------------*
.*       V12.00.01  27/08/2025  Alina Bhari      TSK 0954453                  *
.*                  Added stattionary template variable for patient name      *
.*                  - PRPIH400,PRPI1270                                       *
.*       V11.04.01  09/07/2024  J.Tan            TSK 0934944                  *
.*                  Mod to check Referral Provider no from a linked Practice  *
.*       V11.03.01 02/10/2023  Nikitha B         TSK 0927699                  *
.*                 Added CAPPRVNO and PTCNHABN for Hospital Approval Number   *
.*                 and  ABN Number for single and multi hospital.             *
.*       V11.02.01 24/01/2022  Jacob Jackson     TSK 0864505                  *
.*                 Added preferred name option fields                         *
.*                 PRPI1180, PRPI1190, PRPI1200, PRPI1210, PRPI1220           *
.*       V11.00.01 06/04/2020  Thanh T           TSK 0879163                  *
.*                 Added PRPI1170 for sex long description                    *
.*----------------------------------------------------------------------------*
.*       V10.13.01  31/07/2018  J.Tan            TSK 0848506                  *
.*                  Changed PP Doctor from DIM6 to DIM10                      *
.*       V10.11.01  06/09/2017  J.Tan          TSK 0821057                    *
.*                  Variable 76 - Default health fund from Holding Header file*
.*       V10.10.01  10/05/2017  Tracey Nguyen  TSK 0837929                    *
.*                  Fixed I*C error message on PATMESG1 at PRPI1040 & PRPI1050*
.*       V10.08.01  09/06/2016  Peter Vela     TSK 0820206                    *
.*                  Added Health Fund variable from PRIHDBFD                  *
.*       V10.04.01  23/01/2014  Patrick Adair  CAR 265844                     *
.*                  Corrected variables for PRFA and Debtor full address      *
.*                  Added variables for PRA Address 4, Mobile Phone and       *
.*                  Patient Address 4                                         *
.*       V10.03.01  29/11/2011  J.Tan          CAR 254776                     *
.*                  Added variables for PRFA and Debtor full address          *
.*       V10.02.01  04/04/2011  Jill Parkinson CAR 239574                     *
.*                  Removed open of ibaprntf                                  *
.*       V10.00.01  26/08/2010  Davin            CAR 226963                   *
.*                  Added referral date from prihreff (variable 70)           *
.*        V9.12.02  01/10/2009  Peter Vela       CAR 203243                   *
.*                  Added Medical Practice Service Doctor Service Provider Num*
.*        V9.12.01  03/09/2009  Peter Vela       CAR 194715                   *
.*                  Added variables from prihreaf                             *
.*        V9.11.01  01/12/2008  Steve Armstrong  CAR 184702                   *
.*                  Added Service Doctor ABN (variable 56)                    *
.******************************************************************************
.*        V9.08.01  28/09/2006  Peter Vela    CAR 118366                      *
.*                  Added Medicare Prefix PATMX1FD.PTMXMCCD                   *
.******************************************************************************
.*        V9.06.01  28/04/2006  Peter Vela    CAR 102393                      *
.*                  Added PRFA details (PRIINVFD)                             *
.******************************************************************************
.*        V9.05.02  17/03/2006  Peter Vela    CAR 95780                       *
.*                  Added EMG Contact mobile numbers                          *
.*        V9.05.01  27/03/2006  Peter Vela    CAR 61299                       *
.*                  Increased field no size from DIM3 to DIM5                 *
.******************************************************************************
.*        V9.03.04  25/05/2004  J.Tan         CAR 50111
.*                  Fixed not checking for VSCANPMI                           *
.*        V9.03.03  30/03/2004  J.Tan         CAR 44116                       *
.*                  Added field no 48 for credit number                       *
.*        V9.03.02  02/03/2004  Lina Vo       CAR 47921                       *
.*                  Removed use of PRIDBTFD & IO.                             *
.*        V9.03.01  26/02/2004  J.Tan                                         *
.*                  Mods not to Close patmesgf                                *
.******************************************************************************
.*        V9.02.06  30/08/2002  Dean Cramer                                   *
.*                  Open/Close for patmesgf where accessed                    *
.*        V9.02.05  02/07/2002  Dean Cramer - Defect 19030                    *
.*                  Added message line 1 & message line 2                     *
.*        V9.02.04  23/05/2002  J.Tan                                         *
.*                  Added patient indicator                                   *
.*        V9.02.03  19/03/2002  J.Tan                                         *
.*                  Added claim code                                          *
.*        V9.02.02  14/12/2001  Dean Cramer                                   *
.*                  Mods to for web                                           *
.*        V9.02.01  02/10/2001  J.Tan                                         *
.*                  Mods to use PMSHCPFD instead of PATDO1FD                  *
.******************************************************************************
.*        V5.08.01  15/09/2000  Davin  SRF 4964                               *
.*                  Fixed tax/copy of invoice indicator                       *
.*        V5.08.00  06/06/2000  Davin                                         *
.*                  Ported from 607                                           * .****************************************************************************** .
.******************************************************************************
.*        Lineup Print for Invoice Header Fields                              *
.******************************************************************************
.
LINUPPIH  MATCH     "IBARSH",PGM
          GOTO      LINUPPH1 IF EQUAL
.         
          IF        WEBFLAG=0
            CALL      OPNPRINT                 * open spool file
          ENDIF
LINUPPH1  MOVE      ONE,CURRROW              * Initialise current row counter
          IF        IBDTROW < 1
            GOTO      PRILP999               * don't template anything
          ENDIF
.
PRILP000  COMPARE   CURRROW,IBDTROW          * Current row up to required row ?
          GOTO      PRILP200 IF EQUAL        * Yes - print data
          PRINT     *N;                      * Else print 1 extra line
          ADD       ONE,CURRROW              * Increment counter
          GOTO      PRILP000                 * Check counter again
.
. ------- Read through the details file -------
.
PRILP100  CALL      RKIBDET1                 * Read next detail record
          BRANCH    OVRCD,PRILP900           * No more records - pad out form
.
          MATCH     PRCNPRIH,IBDTSCOD        * Same form ?
          GOTO      PRILP900 IF NOT EQUAL    * No - pad out rest of form
.
PRILP110  COMPARE   CURRROW,IBDTROW          * Are we at required row ?
          GOTO      PRILP200 IF EQUAL        * Yes - print data
          PRINT     *N;                      * Else pad out form to req row
          ADD       ONE,CURRROW              * One more row printed
          GOTO      PRILP110                 * Check row count
.
. ------- Print actual data lines -------
.
PRILP200  BRANCH    IBDTINDC,PRILP300:       * Text field
                             PRILP400        * Data field
.
. ------- Print text field -------
.
PRILP300  PRINT     *IBDTCOL,IBDTTXFL;       * Print data
          MOVE      IBDTROW,CURRROW          * Row printed is current row
          GOTO      PRILP100                 * Read next record
.
. ------- Print data field -------
.
PRILP400  MOVE      IBDTTXFL,DIM5            * Data number 1st 3 chars of field
          MOVE      DIM5,FORM5               * Move to a FORM field for BRANCH
.
          BRANCH    FORM5,PRILP450,PRILP450,PRILP450,PRILP450,PRILP470:
                          PRILP450,PRILP470,PRILP470,PRILP470,PRILP450:    10
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:    20
                          PRILP450,PRILP480,PRILP450,PRILP450,PRILP450:
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:    30
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:    40
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:    50
                          PRILP450,PRILP480,PRILP480,PRILP450,PRILP450:
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:    60
                          PRILP450,PRILP450,PRILP450,PRILP450,PRILP450:
                          PRILP450,PRILP450,PRILP450,PRILP450
.
PRILP450  PACK      VARIABLE,X10,X10,X10,X10,X10,X10,X10,X10,X10,X10,X10,X10,X10,X10,X10
          GOTO      PRILP600
.
PRILP460  MOVE      "99:99:99",VARIABLE          * Time variables
          GOTO      PRILP600
.
PRILP470  IF        IBDTPLEN = 10
            MOVE      "99/99/9999",VARIABLE      * Date with century variables
          ELSE
            MOVE      "99/99/99",VARIABLE        * Date variables
          ENDIF
          GOTO      PRILP600
.
PRILP480  MOVE      "9999999999999999999999999",VARIABLE    * Form Field
          GOTO      PRILP600
.
PRILP490  MOVE      "9",VARIABLE                 * Indicator
          GOTO      PRILP600
.
PRILP520  CLEAR     VARIABLE                     * Address
          APPEND    X10,VARIABLE
          APPEND    X10,VARIABLE
          APPEND    X5,VARIABLE
          APPEND    COMMA,VARIABLE
          APPEND    X10,VARIABLE
          APPEND    X10,VARIABLE
          APPEND    X5,VARIABLE
          APPEND    COMMA,VARIABLE
          APPEND    " 9999",VARIABLE
          RESET     VARIABLE
          GOTO      PRILP600
.
PRILP530  MOVE      "99",VARIABLE            * Year
          GOTO      PRILP600
.
PRILP540  MOVE      "999999.99",VARIABLE     * Daily rate
          GOTO      PRILP600
.
. ------- Actual data print routine -------
.
PRILP600  RESET     VARIABLE,IBDTPLEN        * Reset pointer to required length
          LENSET    VARIABLE                 * Push logical length there
          RESET     VARIABLE                 * Reset form pointer to start
          PRINT     *IBDTCOL,*+,VARIABLE;    * Only print data between FP & LL
          MOVE      IBDTROW,CURRROW          * Move row number to one printed
          GOTO      PRILP100                 * Read next record
.
. ------- Finished all data for this form - pad out rest of form -------
.
PRILP900  COMPARE   CURRROW,IBTHLENG         * End of form ?
          GOTO      PRILP999 IF EQUAL        * Yes - exit
          PRINT     *N;                      * Otherwise pad out 1 more line
          ADD       ONE,CURRROW              * 1 more line printed
          GOTO      PRILP900                 * Test again
.
PRILP999  PRINT     *N;
          MOVE      FALSE,EXIT               * Set exit flag
.>>>>     CALL      CLSPRINT                 * close the spool file
          RETURN                             * Finished
+
.*******************************************************************************
.*        Actual Print Routine for PRI Invoice Header Fields                   *
.*******************************************************************************
.
PRTPRIHL  MATCH     "IBARSH",PGM
          GOTO      PRTPRIH1 IF EQUAL
.
          IF        WEBFLAG=0
            CALL      OPNPRINT                 * open spool file
          ENDIF
PRTPRIH1  MOVE      ONE,CURRROW              * Initialise current row counter
          IF        IBDTROW < 1
            GOTO      PRPH9999               * don't template anything
          ENDIF
.
PRPIH000  COMPARE   CURRROW,IBDTROW          * Current row up to required row ?
          GOTO      PRPIH200 IF EQUAL        * Yes - print data
          PRINT     *N;                      * Else print 1 extra line
          ADD       ONE,CURRROW              * Increment counter
          GOTO      PRPIH000                 * Check counter again
.
. ------- Read through the details file -------
.
PRPIH100  CALL      RKIBDET1                 * Read next detail record
          BRANCH    OVRCD,PRPH8000           * No more records - pad out form
.
          MATCH     PRCNPRIH,IBDTSCOD        * Same form ?
          GOTO      PRPH8000 IF NOT EQUAL    * No - pad out rest of form
.
PRPIH110  COMPARE   CURRROW,IBDTROW          * Are we at the required row ?
          GOTO      PRPIH200 IF EQUAL        * Yes - print data
          PRINT     *N;                      * Else pad out to required row
          ADD       ONE,CURRROW              * One more row printed
          GOTO      PRPIH110                 * Check row count
.
. ------- Print actual data lines -------
.
PRPIH200  BRANCH    IBDTINDC,PRPIH300:       * Text field
                             PRPIH400        * Data field
.
. ------- Print text field -------
.
PRPIH300  RESET     IBDTTXFL,IBDTPLEN
          LENSET    IBDTTXFL
          RESET     IBDTTXFL
          PRINT     *IBDTCOL,*+,IBDTTXFL;    * Print data
          MOVE      IBDTROW,CURRROW          * Row printed is current row
          GOTO      PRPIH100                 * Read next record
.
. ------- Print data field -------
.
PRPIH400  MOVE      IBDTTXFL,DIM5            * Data number 1st 3 chars of field
          MOVE      DIM5,FORM5               * Move to a FORM field for BRANCH
.
          PACK      VARIABLE,SP30,SP30,SP30,SP30,SP10  * Initialise variable
          BRANCH    FORM5,PRPIH410,PRPIH420,PRPIH430,PRPIH440,PRPIH450:
                          PRPIH460,PRPIH470,PRPIH480,PRPIH490,PRPIH500:   10
                          PRPIH510,PRPIH520,PRPIH530,PRPIH540,PRPIH550:
                          PRPIH560,PRPIH570,PRPIH580,PRPIH590,PRPIH600:   20
                          PRPIH610,PRPIH620,PRPIH630,PRPIH640,PRPIH650:
                          PRPIH660,PRPIH670,PRPIH680,PRPIH690,PRPIH700:   30
                          PRPIH710,PRPIH720,PRPIH730,PRPIH740,PRPIH750:
                          PRPIH760,PRPIH770,PRPIH780,PRPIH790,PRPIH800:   40
                          PRPIH810,PRPIH820,PRPIH830,PRPIH840,PRPIH850:
                          PRPIH860,PRPIH870,PRPIH880,PRPIH890,PRPIH900:   50
                          PRPIH910,PRPIH920,PRPIH930,PRPIH940,PRPIH950:
                          PRPIH960,PRPIH970,PRPIH980,PRPIH990,PRPI1000:   60
                          PRPI1010,PRPI1020,PRPI1030,PRPI1040,PRPI1050:
                          PRPI1060,PRPI1070,PRPI1080,PRPI1090,PRPI1100:   70
                          PRPI1110,PRPI1120,PRPI1130,PRPI1140,PRPI1150:
                          PRPI1160,PRPI1170,PRPI1180,PRPI1190,PRPI1200:   80
                          PRPI1210,PRPI1220,PRPI1230,PRPI1240,PRPI1250:
                          PRPI1260,PRPI1270
.
PRPIH410  
.         IF        VSCANPMI = 1
.*                   to populate the new state field based on the post code  *
            MOVE      PFNDTB,VARIABLE          * Health fund table (PMI)
..        ELSE
..          MOVE      PRDBTABL,VARIABLE        * Health fund table (PRI)
.         ENDIF
          GOTO      PRPH5000
.
PRPIH420  
.         IF        VSCANPMI = 1
            MOVE      PFUNDH,VARIABLE          * Health fund (PMI)
..        ELSE
..          MOVE      PRDBFUND,VARIABLE        * Health fund (PRI)
.         ENDIF
          GOTO      PRPH5000
.
PRPIH430  
.         IF        VSCANPMI = 1
            MOVE      PFNDMM,VARIABLE        * Fund membership number (PMI)
..        ELSE
..          MOVE      PRDBMEMN,VARIABLE      * Fund membership number (PRI)
.         ENDIF
          GOTO      PRPH5000
.
PRPIH440  MOVE      CNAME,VARIABLE           * Hospital Name
          GOTO      PRPH5000
.
PRPIH450  CALL      IBACLOCK                 * Current Date
          MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          CALL      PACDATE
          IF        IBDTPLEN = 10
            MOVE      CPCDATE,VARIABLE
          ELSE
            MOVE      CPDATE,VARIABLE
          ENDIF
          GOTO      PRPH5000
. 
PRPIH460  MOVE      VSVDPROV,VARIABLE        * Doctor Provider Number
          GOTO      PRPH5000
. 
PRPIH470  
.         IF        VSCANPMI = 1
            UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY     * Birth date (PMI)
..        ELSE
..          UNPACK    PRDBDOBH,CCENT,CYEAR,CMON,CDAY   * Birth date (PRI)
.         ENDIF
          CALL      PACDATE
          IF        IBDTPLEN = 10
            MOVE      CPCDATE,VARIABLE
          ELSE
            MOVE      CPDATE,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPIH480  UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY     * PRI Invoice Date
          CALL      PACDATE
          IF        IBDTPLEN = 10
            MOVE      CPCDATE,VARIABLE
          ELSE
            MOVE      CPDATE,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPIH490  UNPACK    CLAIMDTE,CDAY,DIM1,CMON,DIM1,CCENT,CYEAR  * Accident date
          CALL      PACDATE
          IF        IBDTPLEN = 10
            MOVE      CPCDATE,VARIABLE
          ELSE
            MOVE      CPDATE,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPIH500  MOVE      CLAIMNUM,VARIABLE            * Claim number
          GOTO      PRPH5000
.
PRPIH510  MOVE      CLAIMTYP,VARIABLE            * Claim type
          GOTO      PRPH5000
.
PRPIH520  MOVE      EMPLNAME,VARIABLE            * Employer name
          GOTO      PRPH5000
.
PRPIH530  
.         IF        VSCANPMI = 1
            MOVE      PMEDI,VARIABLE             * Medicare number (PMI)
..        ELSE
..          MOVE      PRDBMEDN,VARIABLE          * Medicare number (PRI)
.         ENDIF
          GOTO      PRPH5000
.
PRPIH540  READ      CONTROLF,ZERO;*70,IBCNABNN   * ABN Number
          MOVE      IBCNABNN,VARIABLE
          GOTO      PRPH5000
.
PRPIH550  MOVE      PRIMTYPE,VARIABLE            * Doctor Type (description)
          GOTO      PRPH5000
.
PRPIH560  MOVE      PRPRADD1,VARIABLE            * M.P. Address line 1
          GOTO      PRPH5000
.
PRPIH570  MOVE      PRPRADD2,VARIABLE            * M.P. Address line 2
          GOTO      PRPH5000
.
PRPIH580  MOVE      PRPRADD3,VARIABLE            * M.P. Address line 3
          GOTO      PRPH5000
.
PRPIH590  MOVE      PRPRPOST,VARIABLE            * M.P. Postcode
          GOTO      PRPH5000
.
PRPIH600  MOVE      PRPRDESC,VARIABLE            * M.P. Description
          GOTO      PRPH5000
.
PRPIH610  MOVE      PRPRTELP,VARIABLE            * M.P. Telephone
          GOTO      PRPH5000
.
PRPIH620  MOVE      PRCNINVN,VARIABLE            * Invoice Number
          MOVE      EIGHT,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PRPH6000
.
PRPIH630  MOVE      PRCNNAME,VARIABLE            * Clinic Name on Invoice
          GOTO      PRPH5000
.
PRPIH640  MOVE      PRCNTELE,VARIABLE            * Telephone Number on Invoice
          GOTO      PRPH5000
.
PRPIH650  MOVE      VPRANAME,VARIABLE            * PRA Name
          GOTO      PRPH5000
.
PRPIH660  MOVE      TMPRADD1,VARIABLE            * PRA Address line 1
          GOTO      PRPH5000
.
PRPIH670  MOVE      TMPRADD2,VARIABLE            * PRA Address line 2
          GOTO      PRPH5000
.
PRPIH680  MOVE      TMPRADD3,VARIABLE            * PRA Address line 3
          GOTO      PRPH5000
.
PRPIH690  MOVE      TMPRPOST,VARIABLE            * PRA Postcode
          GOTO      PRPH5000
.
PRPIH700  MOVE      VDEBADD1,VARIABLE            * Debtors Address line 1
          GOTO      PRPH5000
.
PRPIH710  MOVE      VDEBADD2,VARIABLE            * Debtors Address line 2
          GOTO      PRPH5000
.
PRPIH720  MOVE      VDEBADD3,VARIABLE            * Debtors Address line 3
          GOTO      PRPH5000
.
PRPIH730  MOVE      VDEBPOST,VARIABLE            * Debtors Postcode
          GOTO      PRPH5000
.
PRPIH740  MOVE      VDEBNAME,VARIABLE            * Formatted Debtors Name
          GOTO      PRPH5000
.
PRPIH750  MOVE      VDEBTOR,VARIABLE             * Debtor Number
          GOTO      PRPH5000
.
PRPIH760  MOVE      VSVDOCT,VARIABLE             * Service Doctor's code
          GOTO      PRPH5000
.
PRPIH770  MOVE      VSVDCNAM,VARIABLE            * Formatted Service Doc. Name
          GOTO      PRPH5000
.
PRPIH780  
.         IF        VSCANPMI = 1
            MOVE      "U",VARIABLE               * Patient Type (PMI)
.         ELSE
.           MOVE      "D",VARIABLE               * Patient Type (PRI)
.         ENDIF
          GOTO      PRPH5000
.
PRPIH790  MOVE      "INVOICE",VARIABLE           * Tax Invoice indicator
          COMPARE   ONE,TMPGSTA
          IF        @EQUAL
            MOVE      "TAX INVOICE",VARIABLE
          ELSE
            COMPARE   NINE,TMPGSTA
            IF        @EQUAL
              MOVE      "CREDIT NOTE",VARIABLE
            ENDIF
          ENDIF
          IF        COPINV=1
            MOVE      "COPY OF INVOICE",VARIABLE
            COMPARE   ONE,PRDTGSTA
            IF        @EQUAL
              MOVE      "COPY OF TAX INVOICE",VARIABLE
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPIH800  MOVE      SP70,VARIABLE                * Doctor type 2 description
          PACK      KEY10,VSVDOCT,SP10
          CALL      RDPMHCP1
          IF        OVRCD <> 1
            MATCH     SP3,PMHCSPC2
            IF        !@EQUAL
              PACK      KEY5,ANSD,ANST,PMHCSPC2
              CALL      RDCODE1
              IF        OVRCD <> 1
                MOVE      TDESC,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPIH810  MOVE      SP70,VARIABLE                * Doctor qualification line 1
          OPEN      PATPERS1,"patperss"
          UNPACK    VSVDOCT,KEY6
          PACK      KEY12,KEY6,ANSQ,SP2,ONE,SP1,ONE
          CALL      RDPERS1
          IF        OVRCD <> 1
            MOVE      PEDESC,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPIH820  MOVE      SP70,VARIABLE              * Debtor's Name (titl/givn/surn)
.         BRANCH    VSCANPMI,PRPIH825
.
.         Get debtor name
.
..        MOVE      SP30,PRDBSNAM
..        MOVE      SP30,PRDBGNAM
..        MOVE      SP5,PRDBTITL
..        MOVE      VDEBTOR,KEY8
..        CALL      RDPRDB1
..        BRANCH    OVRCD,PRPIH829
.
..        MOVE      PRDBSNAM,PACSNAME
..        MOVE      PRDBGNAM,PACGNAME
..        MOVE      PRDBTITL,PACTITLE
.         MOVE      "Unknown Debtor",PACSNAME
.         MOVE      SP70,PACGNAME
.         MOVE      SP70,PACTITLE
.         GOTO      PRPIH828
.
.         Get PMI name
.
PRPIH825  OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          MOVE      SP30,PSNAME
          MOVE      SP30,PGNAME
          MOVE      SP5,PTITL
          MOVE      VDEBTOR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PRPIH829
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
.
PRPIH828  MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,VARIABLE
PRPIH829  GOTO      PRPH5000
.
PRPIH830  MOVE      PSEX,VARIABLE            * Patients Sex
          GOTO      PRPH5000
.
PRPIH840  MOVE      TMPCLAIM,VARIABLE
          GOTO      PRPH5000
.
PRPIH850  CALL      GPIND000                * get patient indicator from codes
          MOVE      TDESC,VARIABLE
          GOTO      PRPH5000
.
PRPIH860  OPEN      PATMESG1,"patmesgf"
          MOVE      MESSCODE,KEY3
          CALL      RDMESG1                 * read the message file for line 1
          BRANCH    OVRCD,PRPIH865
.
          MOVE      PMLINE1,VARIABLE
          GOTO      PRPH5000
.
PRPIH865  PACK      PMLINE1 WITH SP30,SP30,SP5
          GOTO      PRPH5000
.
PRPIH870  OPEN      PATMESG1,"patmesgf"
          MOVE      MESSCODE,KEY3
          CALL      RDMESG1                 * read the message file for line 1
          BRANCH    OVRCD,PRPIH875
.
          MOVE      PMLINE2,VARIABLE
          GOTO      PRPH5000
.
PRPIH875  PACK      PMLINE2 WITH SP30,SP30,SP5
          GOTO      PRPH5000
.
PRPIH880  MOVE      PRCOCRNO,VARIABLE        * Credit note number
          GOTO      PRPH5000
.
PRPIH890  MOVE      PMPXKMOB,VARIABLE
          GOTO      PRPH5000
.
PRPIH900  MOVE      PMPXCMOB,VARIABLE
          GOTO      PRPH5000
.
PRPIH910  MOVE      PMPXRMOB,VARIABLE
          GOTO      PRPH5000
.
PRPIH920  MOVE      TMPRPTEL,VARIABLE
          GOTO      PRPH5000
.
PRPIH930  MOVE      TMPRBTEL,VARIABLE
          GOTO      PRPH5000
.
PRPIH940  MOVE      TMPRREL,VARIABLE
          GOTO      PRPH5000
.
PRPIH950  MOVE      PTMXMCCD,VARIABLE
          GOTO      PRPH5000
.
PRPIH960  MOVE      SP70,VARIABLE
          PACK      KEY22,PRINPRAC,PRINDOCT,PRINCLAM,TMPPIND
          CALL      RDPRDO1
          IF        OVRCD = 0
            MOVE      PRDOABNN,VARIABLE          * Service Doctor ABN
          ENDIF
          GOTO      PRPH5000
.
PRPIH970  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP70,PRHRREFD
            IF        !@EQUAL & !@EOS
              PACK      KEY10,PRHRREFD,SP70
              CALL      RDPMHCP1
              IF        OVRCD = 0
                MOVE      PMHCTITL,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPIH980  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP70,PRHRREFD
            IF        !@EQUAL & !@EOS
              PACK      KEY10,PRHRREFD,SP70
              CALL      RDPMHCP1
              IF        OVRCD = 0
                MOVE      PMHCGNAM,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPIH990  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP70,PRHRREFD
            IF        !@EQUAL & !@EOS
              PACK      KEY10,PRHRREFD,SP70
              CALL      RDPMHCP1
              IF        OVRCD = 0
                MOVE      PMHCSNAM,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1000  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,PRPH5000
.
          MATCH     SP70,PRHRREFD
          IF        !@EQUAL & !@EOS
            OPEN      PMSHCLA1,"pmshclaf"
            PACK      KEY20,PRHRREFD,PRHRHCPP,SP70
            CALL      RDPMHCL1
            IF        OVRCD=0
              MATCH     SP70,PMHLPRV1
              IF        !@EQUAL
                MOVE      PMHLPRV1,VARIABLE    * provider from a Linked Practice
                GOTO      PRPH5000
              ENDIF
            ENDIF
            PACK      KEY10,PRHRREFD,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
              MOVE      PMHCPRV1,VARIABLE
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1010  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MOVE      PRHRREFT,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPI1020  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MOVE      PRHRRFPD,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPI1030  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP70,PRHRRFPD
            IF        !@EQUAL & !@EOS
              PACK      KEY5,ANSR,ANSF,PRHRRFPD,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1040  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP70,PRHRMESS
            IF        !@EQUAL & !@EOS
              OPEN      PATMESG1,"patmesgf"
              PACK      KEY3,PRHRMESS,SP70
              CALL      RDMESG1
              IF        OVRCD=0
                MOVE      PMLINE1,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1050  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP70,PRHRMESS
            IF        !@EQUAL & !@EOS
              OPEN      PATMESG1,"patmesgf"
              PACK      KEY3,PRHRMESS,SP70
              CALL      RDMESG1
              IF        OVRCD=0
                MOVE      PMLINE2,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1060  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MOVE      PRHRBULK,VARIABLE
          ENDIF     
          GOTO      PRPH5000
.
PRPI1070  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP70,PRHRBULK
            IF        !@EQUAL & !@EOS
              PACK      KEY5,ANSG,ANSB,PRHRBULK,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1080  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MOVE      PRHROCOD,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPI1090  MOVE      SP70,VARIABLE
          PACK      KEY22,PRINPRAC,PRINDOCT,TMPCLAIM,TMPPIND,SP70
          CALL      RDPRDO1
          IF        OVRCD = 0
            MOVE      PRDOPROV,VARIABLE
          ENDIF
          GOTO      PRPH5000
.
PRPI1100  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            UNPACK    PRHRRDAT,CCENT,CYEAR,CMON,CDAY  * Referral date
            CALL      PACDATE
            IF        IBDTPLEN = 10
              MOVE      CPCDATE,VARIABLE
            ELSE
              MOVE      CPDATE,VARIABLE
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1110  MOVE      TMPRADD4,VARIABLE            * PRA Address line 4 - state
          GOTO      PRPH5000
.
PRPI1120  MOVE      TMPRMPHN,VARIABLE            * PRA Mobile Phone
          GOTO      PRPH5000
.
PRPI1130  MOVE      VDEBADD4,VARIABLE            * Debtors Address line 4 - state
          GOTO      PRPH5000
.
PRPI1140  CALL      SPRD0000                          * PRA Full address
          GOTO      PRPH5000
.
PRPI1150  CALL      SDBT0000                          * Debtor Full address
          GOTO      PRPH5000
.
PRPI1160  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MOVE      PRHDHFND,VARIABLE
            MATCH     SP70,PRHRBCOD
            IF        !@EQUAL
              MOVE      PRHRBCOD,VARIABLE
            ENDIF
          ELSE 
            MOVE      PFUNDH,VARIABLE
          ENDIF
          GOTO      PRPH5000
.	  
.----- format patient sex long description ------	  
.	  
PRPI1170  MOVE      PSEX,DSEXCHAR	  
          CALL      SEXDSP00	      
          MOVE      DSEXLDES,VARIABLE        * Get sex long description		
          GOTO      PRPH5000	      
.
PRPI1180  PACK      VARIABLE,PMPXPFSN,SP70   * Preferred Surname
          GOTO      PRPH5000
.
PRPI1190  PACK      VARIABLE,PMPXPFGN,SP70   * Preferred Given Name
          GOTO      PRPH5000
.
PRPI1200  PACK      VARIABLE,PSNAME,SP70     * Pref Surname instead of Actual SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1210  PACK      VARIABLE,PGNAME,SP70     * Pref GN instead of Actual GN
          MATCH     "1",PTCNPFGN
          IF        @EQUAL
            MATCH     SP70,PMPXPFGN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFGN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1220  PACK      VARIABLE,PTMASNAM,SP70   * Pref Surname instead of 40char SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1230  PACK      VARIABLE,CAPPRVNO,SP70   * Hospital Provider Approval Number
          GOTO      PRPH5000
.
PRPI1240  PACK      VARIABLE,PTCNHABN,SP70   * Hospital ABN Number
          GOTO      PRPH5000
.
PRPI1250  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP6,PRHRPRAC                       * practice blank ?
            IF        !@EQUAL
              PACK      KEY6,PRHRPRAC,SP70
              CALL      RDPRPR1                          * practice on file ?
              IF        OVRCD = 0
                MATCH     SP3,PRPRREGI                   * register blank ?
                IF        !@EQUAL
                  PACK      KEY3,PRPRREGI,SP70
                  CALL      RDREGA1                      * register on file ?
                  IF        OVRCD = 0
                    MATCH     SP3,REGHOSP                * hosp file blank ?
                    IF        !@EQUAL
                      PACK      KEY3,REGHOSP,SP70
                      CALL      RDPTHSP1                 * hospital on file ?
                      IF        OVRCD = 0
                        PACK      VARIABLE,PTHSAPPR,SP70 * MultiHosp ApprovalNum
                        GOTO      PRPH5000
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1260  MOVE      SP70,VARIABLE
          PACK      KEY27,DPRINUNQ,PRINPRAC,PRINDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD = 0
            MATCH     SP6,PRHRPRAC                        * practice blank ?
            IF        !@EQUAL
              PACK      KEY6,PRHRPRAC,SP70
              CALL      RDPRPR1                           * practice on file ?
              IF        OVRCD = 0
                MATCH     SP3,PRPRREGI                    * register blank ?
                IF        !@EQUAL
                  PACK      KEY3,PRPRREGI,SP70
                  CALL      RDREGA1                       * register on file ?
                  IF        OVRCD = 0
                    MATCH     SP3,REGHOSP                 * hosp file blank ?
                    IF        !@EQUAL
                      PACK      KEY3,REGHOSP,SP70
                      CALL      RDPTHSP1                  * hospital on file ?
                      IF        OVRCD = 0
                        PACK      VARIABLE,PTHSABNN,SP70  * MultiHosp ABN Number
                        GOTO      PRPH5000
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          GOTO      PRPH5000
.
PRPI1270  MOVE      SP70,VARIABLE           * Patient Name
          MOVE      PTITL,PACTITLE          * Patient Title
          MOVE      PGNAME,PACGNAME         * Patient given name
          MOVE      PSNAME,PACSNAMX         * Patient surname
          MOVE      THREE,PACFRMT           * Title,Given name and Surname
          CALL      PACNAME
          PACK      KEY80,PACFNAMX,SP70
          MOVE      KEY80,VARIABLE          * Formatted patient Name
          GOTO      PRPH5000
.
. ------- Format the variable -------
.
PRPH5000  RESET     VARIABLE,IBDTPLEN
          LENSET    VARIABLE
          RESET     VARIABLE
          PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      PRPIH100                 * Read next record
.
. ------- Formatting for Form fields and right justified variables -------
.
PRPH6000  COMPARE   ZERO,PRNTSTRT          * Don't bump if printing full length
          GOTO      PRPH7000 IF EQUAL
.
          BUMP      VARIABLE,PRNTSTRT      * bump to starting position
.
. ------- Print the variable -------
.
PRPH7000  PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      PRPIH100                 * Read next record
.
.------ end of invoice reached ------
.
PRPH8000  MOVE      FALSE,EXIT
.
.------ print new-lines until the end of page is reached ------
.
PRPH9000  COMPARE   CURRROW,IBTHLENG          * test page length
          GOTO      PRPH9999 IF EQUAL
.
          PRINT     *N;
          ADD       ONE,CURRROW
          GOTO      PRPH9000
.
PRPH9999  PRINT     *N;
          MOVE      FALSE,EXIT               * Set exit flag
.>>>>     CALL      CLSPRINT                 * close the spool file
          RETURN                             * Finished
+
.******************************************************************************
.         Set PRA Full Address
.******************************************************************************
SPRD0000  CLEAR     VARIABLE
          APPEND    TMPRADD3,VARIABLE
          RESET     VARIABLE
          STRIP     VARIABLE
          ENDSET    VARIABLE
          APPEND    SP1,VARIABLE
          APPEND    TMPRADD4,VARIABLE
          RESET     VARIABLE
          STRIP     VARIABLE
          ENDSET    VARIABLE
          APPEND    SP1,VARIABLE
          APPEND    TMPRPOST,VARIABLE
          RESET     VARIABLE
          STRIP     VARIABLE
          ENDSET    VARIABLE
          APPEND    SP70,VARIABLE
          RESET     VARIABLE
SPRD9999  RETURN
+
.******************************************************************************
.         Set Debtors Full Address
.******************************************************************************
SDBT0000  CLEAR     VARIABLE
          APPEND    VDEBADD3,VARIABLE
          RESET     VARIABLE
          STRIP     VARIABLE
          ENDSET    VARIABLE
          APPEND    SP1,VARIABLE
          APPEND    VDEBADD4,VARIABLE
          RESET     VARIABLE
          STRIP     VARIABLE
          ENDSET    VARIABLE
          APPEND    SP1,VARIABLE
          APPEND    VDEBPOST,VARIABLE
          RESET     VARIABLE
          STRIP     VARIABLE
          ENDSET    VARIABLE
          APPEND    SP70,VARIABLE
          RESET     VARIABLE
SDBT9999  RETURN
