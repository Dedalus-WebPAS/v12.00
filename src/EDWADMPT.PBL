.****************************************************************************** 
.* EDWADMPT - This is a routine used by IBAPMS40 to extract NSW EDWARD        *
.*            Admitted Patient Data                                           *
.*                                                                            *
.* PARAMETERS  :                                                              *
.* RETURNS     :                                                              *
.* Mods        :                                                              *
.******************************************************************************
.* V12.00.06 09/09/2025 Ebon Clements  Task 0960807                           *
.*           Read admission file record to restore the current care type      *
.*           value after reporting care type change on admission date         *
.*           UCAR2000                                                         *
.* V12.00.05 25/08/2025 Ebon Clements  Task 0959908 0960807                   *
.*           Determine Obj 60 attribute 01 qualification change end date when *
.*           reporting record rather then updating last sent records end      *
.*           date - UCAR0000                                                  *
.* V12.00.04 15/08/2025 Ebon Clements  Task 0959908 0960807                   *
.*           Created new procesing routine for update visit trigger 14        *
.*           reporting of Obj 60 attribute 01 for qualification changes       *
.*           Moved from LVAL2000 to UCAR0000                                  *
.* V12.00.03 30/07/2025 Nikitha B      Task 0961300                           *
.*           Modified WRCNC000 obj 114 to read before the squeeze of DPTCDDAD *
.* V12.00.02 08/07/2025 Nikitha B      Task 0961300                           *
.*            Added Added ICD10 ED 13 code for object 56, 61 and 114          *
.* V12.00.01 23/05/2025 PJ Le Febour   Task 0955096 AlphaNum VisitNum         *
.*           Amend COMPARE   AADMNO,WMBOOK to MATCH AADMNO,WMBOOK             *
.*           Amend COMPARE   AADMNO,TADMN  to MATCH AADMNO,TADMN              *
.* V11.05.03 29/04/2025 Ebon Clements  Task 0950532                           *
.*           Added bed transfer seconds to OBJ 142 - Bed transfer             *
.*           SERVICE_EVENT_LOCATION_RECORD_ID - SELC0000                      *
.* V11.05.02 21/03/2025 Ebon Clements  Task 0954909                           *
.*           Only end the last open Obj 133 on leave record for a return      *
.*           from leave - RETU0000 - GETLFROM - LSOF0000                      *
.*           Added trigger 25 report all leave records - RLEV000              *
.* V11.05.01 13/03/2025 Ebon Clements  Task 0957524                           *
.*           Send Obj 142 delete bed transfers prior to reporting all         *
.*           bed transfers - BDAT1200 - Trigger PMAWTYPE = 24                 *
.* V11.04.10 10/10/2024 Nikitha B      Task 0952518                           *
.*           Added ICD10 ED 12 code with 47146 value at DIAG1500 for object 61*
.*           Added ICD10 ED 12 code with 47639 value at SACT4000 for object 56*
.* V11.04.09 03/10/2024 Ebon Clements  Task 0938123                           *
.*           Changed SEAD1100 and WROF0000 to make Catgeory DD indicator 7 =  *
.*           'E' the same as indicator 7 = 'S'. Obj 112 and 64                *
.* V11.04.08 16.09.2024 Ebon Clements  Task 0951071                           *
.*           Report bed type changes if ward/bed has not changed              *
.*           but bed type has Obj 142 CHNG0000                                *
.*           Report all Obj 142 bed transfers - BDAT0000 PMAWTYPE = 24        *
.* V11.04.07 26.08.2024 Ebon Clements  Task 0950552                           *
.*           Added pulic claim code test when no diagnosis records exists     *
.*           patecdaf  - DIAG0000                                             *
.* V11.04.06 27.05.2024 Ebon Clements  Task 0945367                           *
.*           Restore transfer file record in context after reporting MH       *
.*           legal status - LVAL2100                                          *
.* V11.04.05 27.05.2024 Ebon Clements  Task 0945367                           *
.*           Added care type test for OBJ 60 Attr 01 financial class for      *
.*           change admission/discharge date  - LUNA0000                      *
.*           Send Obj 60 Attr 01, 03 and 09 for visit update trigger          *
.*           LVAL0000                                                         *
.* V11.04.04 16.05.2024 Ebon Clements  Task 0945463                           *
.*           Correct Only send MH legal status OBJ 60 Attr 09 using patatraf  *
.*           values - PROT1000 LUNA1100                                       *
.* V11.04.03 15.05.2024 Ebon Clements  Task 0945463                           *
.*           Only send MH legal status OBJ 60 Attr 09 using patatraf values   *
.*           MHLG0000 LVAL2000 WR600000                                       *
.* V11.04.02 15.02.2024 Ebon Clements  Task 0933826                           *
.*           Added CC ind 9=1 test (same as 9=5) to report CC Assoc field 3   * 
.*           for public and Assoc field 4 for reciprocal obj 60 attribute     *
.*           type 1 financial class code PROT0000, ESQU0000 and CTDL0000      *
.*           Added date/time to object key for OBJ 60 Attr 09 - Legal status  *
.*           WR600000. Send discharge 142 object PROT0000                     *
.* V11.04.01 07.12.2023 Ebon Clements  Task 0938123                           *
.*           Treat cat DD ind 7 = S or E as a statistical discharge. Obj 142  *
.*           SELC0000 - HEALTH_SERVICE_LOCATION_TRANSFER_REASON_CODE - (02)   *
.* V11.03.03 16.11.2023 DA Sarkies     Task 0935552                           *
.*           Added DRG value of 11.0                                          *
.* V11.03.02 20.07.2023 DA Sarkies     Task 0932383                           *
.*           Changed PLANNED_EVENT_OFFER_RECORD_ID in object 112 to send      *
.*           send W wattr1af,WTWMECNT - wattr1af.WMBOOK                       *
.* V11.03.01 13/02/2023 Bella Turco    Task 0927894                           *
.*           Changed RELATED_SERVICE_EVENT_TYPE_CODE from "2" to "1" in       *
.*           SERL2500                                                         *
.* V11.02.08 09/11/2022 Jill Parkinson Task 0899679                           *
.*           Added PRIOTIMA to key20 in WR600000 only for type 09 see spec    *
.*           section 5.2.1                                                    *
.*           Changed hardcoded MW and U2 to use PTCDASC3 and PTCDASC4         *
.* V11.02.07 03/11/2022 Ebon Clements  Task 0924816                           *
.*           Obj 142 HEALTH_SERVICE_LOCATION_TRANSFER_REASON_CODE for         * 
.*           statistical admissions - SELC0000                                * 
.* V11.02.06 18/10/2022 Ebon Clements  Task 0923637                           *
.*           Obj 112 SERVICE_EVENT_SEPARATION_MODE_NHDD_CODE after            * 
.*           1 July 2021 is 2 characters- SEAD0000 - SEPRMODE                 *
.* V11.02.05 04/10/2022 Jill Parkinson Task 0924783                           *
.*           Added DRG Version 10                                             *
.* V11.02.04 30/08/2022 Jill Parkinson Task 0924032                           *
.*           Added match to inpatient for mothers admission number            *
.* V11.02.03 31/03/2022 Jill Parkinson Task 0903848                           *
.*           Fixed header for object 137                                      *
.* V11.02.02 24/03/2022 Jill Parkinson Task 0903848                           *
.*           Fixed sending of visit nmumber in 137                            *
.* V11.02.01 28/02/2022 Jill Parkinson Task 0903848                           *
.*           Added service event delay                                        *
.* V11.01.03 06/01/2022 Jill Parkinson Task 0914424                           *
.*           Corrected check for expired cards to use blank as valid          *
.* V11.01.02 11/08/2021 Jill Parkinson Task 0893922                           *
.*           Added check for NDIS to send 18 for pension code in obj 112      *
.* V11.01.01 18/05/2021 Ebon Clements  Task 0886023                           *
.*           Added PTCNEXED - Collect extra container information test        *
.*           to report new object 64 -  WROF0000                              *
.* V11.00.24 23/11/2020 Jill Parkinson Task 0899677                           *
.*           Added match for oldbed and newbed in CHNG0000                    *
.* V11.00.23 24/09/2020 Jill Parkinson Task 0897361                           *
.*           Changed to use DDRGCODE instead of PTDSDDRG in 112               *
.* V11.00.22 16/09/2020 Jill Parkinson Task 0896842                           *
.*           Removed bdatflag check and always pack changkey with only        *
.*           admisssion number/I so last 63 record is always updated          *
.* V11.00.21 10/09/2020 Ebon Clements  Task 0897079                           *
.*           Added ICD10 ED 11 test to ACTIVITY_REF_DOMAIN_ID OBJ 56 SACT0000 *
.* V11.00.20 04/09/2020 Jill Parkinson Task 0896270                           *
.*           Mods to clear start/end date time in obj 56 if either are blank  *
.* V11.00.19 24/08/2020 Jill Parkinson Task 0896382                           *
.*           Removed default of 00 to CLAIM_REASON                            *
.*           24/08/2020 Jill Parkinson Task 0896270                           *
.*           Added check for blank times in object 56 start and end date/time *
.* V11.00.18 03/08/2020 Jill Parkinson Task 0895444                           *
.*           Added :00 to object 56 start and end time fields                 *
.* V11.00.17 29/06/2020 Jill Parkinson Task 0893853                           *
.*           Changed care type to use associated field 1                      *
.* V11.00.16 23/06/2020 Jill Parkinson Task 0893553                           *
.*           Corrected 63 updates for discharges O and OP records             *
.* V11.00.15 17/06/2020 Ebon Clements  Task 0888984                           *
.*           Report employment status user defined field 3 in obj 112 EMPLOYMS*
.* V11.00.14 12/06/2020 Jill Parkinson Task 0893076                           *
.*           Fixed W to wtwmecnt for 112                                      *
.* V11.00.13 11/06/2020 Jill Parkinson Task 0893076                           *
.*           added psycyear=9999 if prevspec=2,4 or 5                         *
.*           11/06/2020 Jill Parkinson Task 0893079                           *
.*           Mods to only delete (DOAD0000) for claim type changes            *
.* V11.00.12 09/06/2020 Jill Parkinson Task 0892513                           *
.*           Mods to only send 112 values for WL patients                     *
.* V11.00.11 29/05/2020 Jill Parkinson Task 0892521                           *
.*           Mods to end attribute 03 for object 60                           *
.* V11.00.10 24/05/2020 Jill Parkinson Task 0892074                           *
.*           Changed key30 for patecdaf records                               *
.* V11.00.09 24/05/2020 Jill Parkinson Task 0892254                           *
.*           Changed plevoffr to use admission number                         *
.* V11.00.08 15/05/2020 Jill Parkinson Task 0891375                           *
.*           Changed category KN to use PTCDUDF3 instead of THCSCOD           *
.* V11.00.07 07/05/2020 Jill Parkinson Task 0891505 0890966                   *
.*           Changed SEAD0000 to use pttrcdat/ctim for source modified        *
.*           Added RCOL0000 to check if ward/bed info changed since last sent *
.* V11.00.06 02/04/2020 Jill Parkinson Task 0889928                           *
.*           Added end of last 63 OP when discharging                         *
.* V11.00.05 31/03/2020 Jill Parkinson Task 0889928                           *
.*           Corrected object 63  when calling from supervisor resend BDAT0000*
.* V11.00.04 27/03/2020 Jill Parkinson Task 0889928                           *
.*           Corrected object 142 when calling from supervisor resend BDAT0000*
.* V11.00.03 13/03/2020 Jill Parkinson Task 0884272                           *
.*           Added delete of last 130 on update discharge                     *
.* V11.00.02 10/03/2020 Jill Parkinson Task 0889117                           *
.*           Removed tdate and ttime from objectky for 60 records             *
.*           Added check for deleted in CHATR00                               *
.* V11.00.01 02/03/2020 Jill Parkinson Task 0889117                           *
.*           Added re-read of patchcof                                        *
.* V10.15.10 16/01/2020 Jill Parkinson Task 0885455                           *
.*           Added code to end previous 136 object and create new key         *
.* V10.15.09 10/01/2020 Jill Parkinson Task 0885290                           *
.*           Added oldtdate and time before calling LSOF0000 in SELC0000      *
.* V10.15.08 10/01/2020 Jill Parkinson Task 0885160                           *
.*           Added oldtdate and time before calling LSOF0000 in CHNG0000      *
.* V10.15.07 27/11/2019 Jill Parkinson Task 0884140                           *
.*           0884140 - added CNXT0000 to add one back to wbhdate for 134/135s *
.* V10.15.06 22/11/2019 Jill Parkinson Task 0884689                           *
.*           Added LCHC0000 to send 112 for care type changes                 *
.* V10.15.05 22/11/2019 Jill Parkinson Task 0884689                           *
.*           Added LCHC0000 to send 112 for care type changes                 *
.* V10.15.04 15/11/2019 Jill Parkinson Task 0884274 and 0884145               *
.*           Added BDAT0000 - resend all 63 and 142 objects if movements      *
.*           are deleted                                                      *
.*           0884140 - added CNXT0000 to add one back to wbhdate for 136 objs *
.* V10.15.03 06/11/2019 Jill Parkinson Task 0884142                           *
.*           Added setting of SENDALT before sending a 112 from DIAG3500      *
.* V10.15.02 23/10/2019 Jill Parkinson Task 0882723                           *
.*           Fixed loop in DIAG3600                                           *
.* V10.15.01 07/10/2019 Jill Parkinson Task 0882723                           *
.*           Moved bedtype2 to use ptcdudf3. Collaborative care default to 2  *
.*           Added mapping for cancer state                                   *
.* V10.14.17 01/10/2019 Jill Parkinson Task 0882126                           *
.*           Mods to delete all 63 objects when pmadtype=18 for doctor deletes*
.* V10.14.16 19/09/2019 Jill Parkinson Task 0881407                           *
.*           Mods to delete only last diag/procs using GDDL0000               *
.* V10.14.15 04/09/2019 Jill Parkinson Task 0881005                           *
.*           Mods to send 115 for practice only also                          *
.* V10.14.14 30/08/2019 Jill Parkinson Task 0880287                           *
.*           Fixed sending of 135 and 136 objects                             *
.* V10.14.13 15/08/2019 Jill Parkinson Task 0878505                           *
.*           Added readmit within 28 days, deleted cancer reg                 *
.* V10.14.12 31/07/2019 Jill Parkinson Task 0878505                           *
.*           Corrected reciprocal to use HCP equiv not HDP Default            *
.*           Added OSP_CREATED_SERVICE_EVENT_FLAG to 63 objects               *
.* V10.14.11 17/07/2019 Jill Parkinson Task 0877130                           *
.*           Updated object 56 to use pteocdte for source created             *
.*           Updated object 56 and 61 key to include diag/proc code           *
.* V10.14.10 11/07/2019 Jill Parkinson Task 0877130                           *
.*           AP Rebounds                                                      *
.* V10.14.09 28/06/2019 Jill Parkinson Task 0876268                           *
.*           Changed Category LS to use ptcdudf4 instead of ptcdudf3          *
.* V10.14.08 28/05/2019 Jill Parkinson Task 0873054                           *
.*           Added sending of reciprocal patients                             *
.*           Added patatraf for mh legal status                               *
.* V10.14.07 08/05/2019 Ebon Clements  Task 0874051                           *
.*           Added building location id to obj 134                            *
.* V10.14.06 17/04/2019 Jill Parkinson 0873055                                *
.*           AP rebounds - removed extra wward column in object 134           *
.* V10.14.05 15/04/2019 Jill Parkinson 0873055                                *
.*           AP rebounds - delete records to use original source date/time    *
.* V10.14.04 26/03/2019 Jill Parkinson 0871879 and 0871784                    *
.*           Leave and return to be 1 line in object 133                      *
.* V10.14.03 24/03/2019 Jill Parkinson Task 0871097                           *
.*           Changed service_encounter_record_id for objects 56 and 61        *
.* V10.14.02 25/02/2019 Jill Parkinson Task 0870828                           *
.*           Changed to resend object 60 for admission/discharge date changes *
.* V10.14.01 10/02/2019 Jill Parkinson Task 0869604                           *
.*           Changed to send dim8 for 61 and 56 service encounter records     *
.* V10.13.14 12/01/2019 Jill Parkinson Task 0864976                           *
.*           Added source modified values                                     *
.* V10.13.13 30/12/2018 Jill Parkinson Task 0864976                           *
.*           Fixed loop of pattranf in LALT1500                               *
.* V10.13.13 06/12/2018 Jill Parkinson Task 0864976                           *
.*           Fixed loop of pattranf in LALT1500                               *
.* V10.13.12 26/11/2018 Ebon Clements  Task R0864975                          *
.*           Added merge functionality for OBJ 57 & 72 to resend new U/R      *
.*           AMRG0000                                                         *
.* V10.13.11 24/11/2018 Jill Parkinson Task 0864976                           *
.*           Added loop of alteration table and send new or delete objects    *
.* V10.13.10 23/11/2018 Ebon Clements  TSK 0864976                            *
.*           Added ED AMBULANCE_INCIDENT_ID to object 112 - SEAD0000          *
.* V10.13.09 20/09/2018 Jill Parkinson TSK 0861841                            *
.*           Beta rebounds 3                                                  *
.* V10.13.08 17/09/2018 Jill Parkinson TSK 0862272                            *
.*           Statistical adm rebounds 2                                       *
.* V10.13.07 16/09/2018 Jill Parkinson TSK 0862272                            *
.*           Statistical adm rebounds                                         *
.* V10.13.06 13/09/2018 Jill Parkinson TSK 0861841                            *
.*           Beta rebound document 2                                          *
.* V10.13.05 12/09/2018 Jill Parkinson TSK 0861841                            *
.*           Beta rebound document 1                                          *
.* V10.13.04 09/09/2018 Jill Parkinson TSK 0862703                            *
.*           Defects - obj 61, 130 and 133                                    *
.* V10.13.03 09/09/2018 Jill Parkinson TSK 0861841                            *
.*           Change requests - obj 60,63,59,112,115 and 131                   *
.* V10.13.02 07/09/2018 Jill Parkinson TSK 0862272                            *
.*           Statistical adm changes                                          *
.* V10.13.01 06/09/2018 Jill Parkinson TSK 0862271                            *
.*           Removed : from time fields in key                                *
.* V10.12.05 22/06/2018 Jill Parkinson TSK 0858101                            *
.*           Added checks for public in 56, 61 and 137                        *
.* V10.12.04 17/05/2018 Thanh T.       TSK 0851528                            *
.*           Added PMVXUD12 of pmsvx1af for transfer reason code              *
.* V10.12.03 26/04/2018 Jill Parkinson Task 0848131                           *
.*           Beta rebounds doc 3 and 4                                        *
.* V10.12.02 18/04/2018 Jill Parkinson Task 0848131                           *
.*           Beta rebounds                                                    *
.* V10.12.01 07/03/2018 Jill Parkinson Task 0848131                           *
.*           Created include                                                  *
.******************************************************************************
EDAP0000  CALL      HSWR0000 * extract Ward objects (134-135-136)
.                            * object records
          CALL      ADEL0000 * extract deleted objects    
.
          CALL      BDAT0000 * extract backdated/supervisor objects
.
          CALL      LUNA0000 * admission/discharge date alterations
.
          CALL      ADTR0000 * extract Admisssion/Transfer/Discharge objects
.                            * (57-59-60-63-112-130-131-142)
          CALL      DIAG0000 * extract diagnosis objects (61)
.
          CALL      SACT0000 * extract service activity object (56)
.
          CALL      CANC0000 * extract cancer object (114)
.
          CALL      LALT0000 * process claim type alterations
.
          CALL      LVAL0000 * process visit alterations
.
          CALL      RLEV0000 * Report all leave records
.
          CALL      LCHC0000 * process care type changes
.
          CALL      EDUNL000 * extract deleted objects
.
          CALL      AMRG0000 * process admission merges
.
          CALL      MHLG0000 * process MH legal status changes
.
          CALL      UCAR0000 * process updatre vist care type records
.
EDAP9999  RETURN
+
.******************************************************************************
.*  ADTR0000 - Loop pattranf and extract objects 57-60-63-112-130-131-142
.******************************************************************************
ADTR0000  PACK      KEY46,STRTDATE,SP70
          CALL      RSPTTRN6
ADTR0500  CALL      RKPTTRN6
          BRANCH    OVRCD,ADTR9999
.
          MATCH     PTTRCDAT,ENDDATE
          GOTO      ADTR9999 IF LESS
.
          PACK      KEY8,DTADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,ADTR0500
.
. *** only send public claim types ****
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADTR0500
.
          MATCH     ANSP,TCINDC1         * Extract public
          GOTO      ADTR2000 IF EQUAL
.
          MATCH     "11",PTCDNHCP        * Extract reciprocal
          GOTO      ADTR2000 IF EQUAL
.
ADTR1000  PACK      SRMDDATE,PTTRCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
. commented out for task 0893079
...       CALL      DOAD0000              * Send deletes as not public
          GOTO      ADTR0500
.
ADTR2000  CALL      PROT0000   * process transfer record
.
ADTR3000  GOTO      ADTR0500
.
ADTR9999  RETURN
+
.******************************************************************************
.*  PROT0000 - Process a transfer record objects 57-60-63-112-130-131-142
.******************************************************************************
PROT0000  MATCH     ANSL,TMOVE
          IF        @EQUAL
            CALL      LEAV0000
            GOTO      PROT9999
          ENDIF
.
          MATCH     ANSR,TMOVE
          IF        @EQUAL
            CALL      RETU0000
            GOTO      PROT9999
          ENDIF
.
          CALL      CLPATDSC
          PACK      KEY8,DAADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            CALL      SEAD0000
            CALL      WRGP0000
            CALL      DELY0000                           * service event delay
            CALL      SETR0000
            CALL      WROF0000                           * Onward referral
. * end last doctor (63)I object  
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "63 ",CHANGOBJ                     * Adress
            MOVE      "21",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ANSI,SP70,SP70     * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last doctor (63) O object
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "63 ",CHANGOBJ                     * Adress
            MOVE      "21",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ANSO,ONE,SP70,SP70     * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last doctor (63) OP object
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "63 ",CHANGOBJ                     * Adress
            MOVE      "21",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ANSO,ANSP,SP70,SP70     * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last transfer (142) object
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "142",CHANGOBJ                     * Adress
            MOVE      "17",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,SP70,SP70          * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * Send discharge 142 object
.
            PACK      OLDTDATE,TDATE * save date
            PACK      OLDTTIME,TTIME * save time
            CALL      SELC0000
.
. * end last (60) object attribute 01
            MOVE      "01",ATTRTYPE
            MOVE      "17 ",CHANGSTM                     * 17=Admitted
            MOVE      "60 ",CHANGOBJ
            MOVE      "15",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ATTRTYPE,SP70,SP70 * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last (60) object attribute 03
            MOVE      "03",ATTRTYPE
            MOVE      "17 ",CHANGSTM                     * 17=Admitted
            MOVE      "60 ",CHANGOBJ
            MOVE      "15",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ATTRTYPE,SP70,SP70 * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last (60) object attribute 09
....        MOVE      "09",ATTRTYPE
....        MOVE      "17 ",CHANGSTM                     * 17=Admitted
....        MOVE      "60 ",CHANGOBJ
....        MOVE      "15",CHANGCOL                      * Change column
....        MOVE      SP70,CHANGOVL
....        PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
....        PACK      CHANGKEY,DTADMN,ATTRTYPE,SP70,SP70 * Change Key
....        PACK      CHANGPRM,SP70,SP70                 * Change primary key
....        PACK      SRMDDATE,PTTRCDAT,SP70
....        PACK      SRMDTIME,PTTRCTIM,SP70
....        CALL      LSOF0000           * Change sent stream object field
.
            GOTO      PROT9999
          ENDIF
.
          MATCH     ANSC,TMOVE
          IF        @EQUAL
            CALL      CHNG0000
          ENDIF
.
          MATCH     ANSA,TMOVE
          GOTO      PROT9999 IF NOT EQUAL
.
          PACK      OLDTDATE,TDATE * save date
          PACK      OLDTTIME,TTIME * save time
          CALL      SELC0000
          CALL      WR570000             
          CALL      WR590000             
.
          CALL      CLPATDSC
          MATCH     "3",DASTAT
          IF        @EQUAL
            PACK      KEY8,DAADMNO,SP70
            CALL      RDDSCH1
            IF        OVRCD=1
              CALL      CLPATDSC
            ENDIF
          ENDIF
          CALL      SEAD0000  * service event admission/discharge
          CALL      SETR0000  * service event transfer
          CALL      SERL0000  * service event relationship
.
. * send financial class attribute *
          MOVE      "01",ATTRTYPE
          MOVE      SP70,ATTRVALU
          MOVE      ADATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      ATIME,PRIOTIMA
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MOVE      DDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      DTIME,PRIOTIMB
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PROT1000
.
          MOVE      PTCDUDF3,ATTRVALU
.
. *check if care type changed on day of admission.  Get old value from patchcof
          CALL      CHCTC000
          MATCH     ANSP,TCINDC1          * Public - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
               MATCH    "5",TCINDC9   * public/qualified
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
               MATCH    "1",TCINDC9   * public/qualified
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
               COMPARE  "13",TCFORM6
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
             ENDIF
          ENDIF
          MATCH     "11",PTCDNHCP         * reciprocal - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.             IF       @EQUAL
.                MOVE     "RW",ATTRVALU
.              ENDIF
.              COMPARE  "13",TCFORM6
.              IF       @EQUAL
.                MOVE     "BD",ATTRVALU  * organ procurement
.              ENDIF
            ENDIF
          ENDIF
          CALL      WR600000     * write object type 60 record
.
. * send admitted patient election code attribute *
PROT1000  MOVE      "03",ATTRTYPE
          MOVE      SP70,ATTRVALU
.
          MOVE      "1",ATTRVALU
          CALL      WR600000     * write object type 60 record
.
. * send legal status attribute *
....      MOVE      "09",ATTRTYPE
....      MOVE      SP70,ATTRVALU
....
....      PACK      KEY5,ANSL,ANSS,PMVXMHLS,SP70
....      CALL      RDCODE1
....      IF        OVRCD<>1
....        MOVE      PTCDUDF4,ATTRVALU
....        CALL      WR600000     * write object type 60 record
....      ENDIF
.
          CALL      WR630000     * write object type 63 record
.
. * check if object 72 - request for service is required *
          PACK      KEY8,DTADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,PROT2000
.
          MATCH     SP70,BKREPROC
          GOTO      PROT2000 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,DBKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,PROT2000
.
          MATCH     WMDOCTOR,ADOCTA
          GOTO      PROT9999 IF EQUAL
.
PROT2000  CALL      HS720000
.
PROT9999  RETURN
+
.******************************************************************************
.*  CHCTC000 - Check if care type changed and use old value
.******************************************************************************
CHCTC000  PACK      KEY24,DTADMN,SP70
          CALL      RDSCHCO1
CHCTC100  CALL      RDKCHCO1
          BRANCH    OVRCD,CHCTC999
.
          MATCH     DTADMN,DCHADMN
          GOTO      CHCTC999 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      CHCTC100 IF NOT EQUAL
.
          PACK      ACARE,CHCODE,SP70
.
CHCTC999  RETURN
+
.******************************************************************************
.*  CHNG0000 - Check what changed on the transfer table
.*             by reading one transfer record before this one
.******************************************************************************
CHNG0000  PACK     SAVKEY46,PTTRCDAT,PTTRCTIM,DTADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      SAVKEY30,DTADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      SAVADMN,DTADMN * save admission number
          PACK      NEWWARD,TWARD  * save ward
          PACK      NEWBED,TBED    * save ward
          PACK      NEWBTYP,TRBTYP * save bed type
          PACK      NEWADOC,TADOCT * save doctor
          PACK      NEWTDATE,TDATE * save date
          PACK      NEWTTIME,TTIME * save time
.
          PACK      KEY30,DTADMN,TDATE,TTIME,TWARD,TBED,SP70 * read this record
          CALL      RDTRAN2
          BRANCH    OVRCD,CHNG9000
.
          CALL      RDPTRAN2     * read previous for this admission
          BRANCH    OVRCD,CHNG9000
.
          MATCH     DTADMN,SAVADMN  * same admission?
          GOTO      CHNG9000 IF NOT EQUAL
.
          PACK      OLDWARD,TWARD  * save ward
          PACK      OLDBED,TBED    * save ward
          PACK      OLDBTYP,TRBTYP * save bed type
          PACK      OLDADOC,TADOCT * save doctor
          PACK      OLDTDATE,TDATE * save date
          PACK      OLDTTIME,TTIME * save time
.
          MATCH     OLDADOC,NEWADOC
          IF        !@EQUAL
            MOVE      OLDTDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      OLDTTIME,PRIOTIMA
            MOVE      NEWTDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      NEWTTIME,PRIOTIMB
. * end previous
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "63 ",CHANGOBJ                     * Adress
            MOVE      "21",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ANSI,SP70 * Change Key
... removed for task 0896842
...         IF        BDATFLAG=1
...           PACK      CHANGKEY,DTADMN,ANSI,SP70 * Change Key
...         ELSE
...           PACK      CHANGKEY,DTADMN,ANSI,OLDTDATE,OLDTTIME,SP70 * Change Key
...         ENDIF
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
.
            PACK      KEY46,SAVKEY46      * reposition back where we were
            CALL      RDPTTRN6
            BRANCH    OVRCD,CHNG9999
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      TTIME,PRIOTIMA
            MOVE      SP70,DIM10B
            MOVE      SP70,PRIOTIMB
            PACK      LASTDOCT,TDATE
            PACK      LASTDTIM,TTIME
            CALL      DCCH0000
          ENDIF
.
CHNG9000  PACK      KEY46,SAVKEY46      * reposition back where we were
          CALL      RDPTTRN6
          BRANCH    OVRCD,CHNG9999
.
          PACK      KEY30,SAVKEY30,SP70 * read this record
          CALL      RDTRAN2
          BRANCH    OVRCD,CHNG9999
.
          MATCH     OLDWARD,NEWWARD
          IF        !@EQUAL
. don't clear these fields if coming from back dated records
            IF        BDATFLAG<>1
              PACK      OLDTDATE,SP70
              PACK      OLDTTIME,SP70
            ELSE
              PACK      OLDTDATE,LASTDATE,SP70
              PACK      OLDTTIME,LASTTIME,SP70
            ENDIF
            CALL      SELC0000  * service event location    
            PACK      LASTDATE,TDATE
            PACK      LASTTIME,TTIME
.
            GOTO     CHNG9100
          ENDIF
.
          MATCH     OLDBED,NEWBED
          IF        !@EQUAL
. don't clear these fields if coming from back dated records
            IF        BDATFLAG<>1
              PACK      OLDTDATE,SP70
              PACK      OLDTTIME,SP70
            ELSE
              PACK      OLDTDATE,LASTDATE,SP70
              PACK      OLDTTIME,LASTTIME,SP70
            ENDIF
            CALL      SELC0000  * service event location
            PACK      LASTDATE,TDATE
            PACK      LASTTIME,TTIME
.
            GOTO      CHNG9100
          ENDIF
.
. Ward and bed have not changed so check if the bed type has changed
.
          MATCH     OLDBTYP,NEWBTYP
          IF        !@EQUAL
. don't clear these fields if coming from back dated records
            IF        BDATFLAG<>1
              PACK      OLDTDATE,SP70
              PACK      OLDTTIME,SP70
            ELSE
              PACK      OLDTDATE,LASTDATE,SP70
              PACK      OLDTTIME,LASTTIME,SP70
            ENDIF
            CALL      SELC0000  * service event location
            PACK      LASTDATE,TDATE
            PACK      LASTTIME,TTIME
.
            GOTO      CHNG9100
          ENDIF
CHNG9100
.
CHNG9999  RETURN
+
.******************************************************************************
.*  EWBC0000 - End Ward bed changed send objects
.******************************************************************************
EWBC0000  MOVE      "60 ",OBJECTTY
          PACK      KEY8,DTADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EWBC9999
.
          MOVE      "06",ATTRTYPE
          MOVE      SP70,ATTRVALU
.
          PACK      KEY7,ONE,OLDWARD,OLDBED,SP70
          CALL      RDPMUHL1
          IF        OVRCD<>1
            PACK      ATTRVALU,PMULUHID,SP900
          ENDIF
.
          MOVE      TDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      TTIME,PRIOTIMA
          MOVE      NEWTDATE,DIM10B
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
          MOVE      NEWTTIME,PRIOTIMB
.
          CALL      WR600000     * write object type 60  attribute 06 record
.
EWBC9999  RETURN
+
.******************************************************************************
.*  WBCH0000 - Ward bed changed send objects
.******************************************************************************
WBCH0000  MOVE      "60 ",OBJECTTY
          PACK      KEY8,DTADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,WBCH9999
.
          MOVE      "06",ATTRTYPE
          MOVE      SP70,ATTRVALU
.
          PACK      KEY7,ONE,TWARD,TBED,SP70
          CALL      RDPMUHL1
          IF        OVRCD<>1
            PACK      ATTRVALU,PMULUHID,SP900
          ENDIF
.
          MOVE      TDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      TTIME,PRIOTIMA
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
.
          CALL      WR600000     * write object type 60  attribute 06 record
.
WBCH9999  RETURN
+
.******************************************************************************
.*  EBTC0000 - end bed type changed send objects
.******************************************************************************
EBTC0000  PACK      KEY8,DTADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EBTC9999
.
          MOVE      "07",ATTRTYPE
          MOVE      SP70,ATTRVALU
.
          PACK      KEY5,ANSB,ANST,TRBTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM2
            PACK      ATTRVALU,DIM2,SP900
          ENDIF
.
          MOVE      TDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      TTIME,PRIOTIMA
          MOVE      NEWTDATE,DIM10B
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      NEWTTIME,PRIOTIMB
.
          CALL      WR600000   * write object type 60  attribute 07 record
.
EBTC9999  RETURN
+
.******************************************************************************
.*  DCCH0000 - Doctor changed extract object 63
.******************************************************************************
DCCH0000  MOVE      "63",OBJECTTY
          PACK      KEY8,DTADMN
          CALL      RDMISS1
          BRANCH    OVRCD,DCCH9999
.
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
.
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          STRIP     DIM10A
          STRIP     DIM10B
.
          MOVE      SP70,PMHCPRV1
          PACK      KEY16,TADOCT,SP70
          CALL      RSPMHCP4
          CALL      RKPMHCP4
          BRANCH    OVRCD,DCCH9999
.
          MATCH     PMHCLDOC,TADOCT
          GOTO      DCCH9999 IF NOT EQUAL
.
          STRIP     PMHCPRV1
          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,PTCDUDF3
          ENDIF
          STRIP     PTCDUDF3
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          UNPACK    TTIME,XHOUR,D1,XMIN
          PACK      KEY11,CYEAR,CMON,CDAY,XHOUR,XMIN,SP70
          STRIP     KEY11
.
          SQUEEZE   TADOCT
          PACK      OBJECTKY,DTADMN,ANSI,TDATE,TTIME,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             ANSI,KEY11,TILDA: * PROVIDER_RECORD_ID
                             ANSI,TILDA:     * PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA: * PROVIDER_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * PROVIDER_SOURCE_ID
                             TADOCT,TILDA:   * PROVIDER_ID
                             PTCDUDF3,TILDA: * DISC_SPEC_CODE
                             TILDA:          * DISC_SPEC_LOCAL_CODE
                             TILDA:          * OSP_LOCAL_ID
                             ANSY,TILDA:     * RESPONSIBLE_PROVIDER_FLAG
                             TWO,TILDA:      * COLLABORATIVE_CARE_ROLE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB   * END_DATETIME
.
          PACK      SRCRDATE,PTTRCDAT,SP70
          PACK      SRCRTIME,PTTRCTIM,SP70
          PACK      SRMDDATE,PTTRCDAT,SP70
          PACK      SRMDTIME,PTTRCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
DCCH9999  RETURN
+
.******************************************************************************
.*  HSWR0000 - Loop patwbhaf and extract objects 134-135-136
.******************************************************************************
HSWR0000  MATCH     "1",PTCNSHSD      * sending Health service objects ?
          GOTO      HSWR9999 IF NOT EQUAL
.
          PACK      KEY30,STRTDATE,SP70
          CALL      RSPTWBH2
HSWR0500  CALL      RKPTWBH2
          BRANCH    OVRCD,HSWR9999
.
          MATCH     WBHCRDT,ENDDATE
          GOTO      HSWR9999 IF LESS
.
          PACK      KEY6,WBHWARD,WBHBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,HSWR0500
.
HSWR1000  PACK      KEY7,ONE,WWARD,WBED,SP70
          CALL      RDPMUHL1
          IF        OVRCD=1
            MOVE      SP70,PMULUHID
          ENDIF
.
          MOVE      SP70,D2
          MATCH     SP70,WCLASS
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,WCLASS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      D2,THCSCOD,SP70
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY2
          MOVE      SP70,KEY1
          MATCH     SP70,WEFRBT
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      THCSCOD,KEY2,KEY1
            ENDIF
          ENDIF
.
          MOVE      WBHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          MATCH     SP70,WBHBED      * only send 134 for ward records(not beds)
          GOTO      HSWR1200 IF NOT EQUAL
.
. get first effective date
          PACK      SAVKEY14,WBHWARD,WBHBED,WBHDATE,SP70
          PACK      KEY14,WWARD,SP70 
          CALL      RSPTWBH1
          CALL      RKPTWBH1
          IF        OVRCD<>1
            MATCH     WBHWARD,WWARD
            IF        @EQUAL
              UNPACK    WBHDATE,CCENT,CYEAR,CMON,CDAY
              CALL      CNXT0000                 * Calculate the next Date
              MOVE      KEY8,DATFIELD
              CALL      FMTD0000
              MOVE      FORMATDT,DIM10A
            ENDIF
          ENDIF
          PACK      KEY14,SAVKEY14,SP70
          CALL      RDPTWBH1
.
          MOVE      "134",OBJECTTY
          PACK      OBJECTKY,WWARD,WBED,SP70,SP70
          STRIP     WWARD
          STRIP     WBED
          STRIP     WBDESC
          STRIP     D2
          STRIP     KEY2
          STRIP     KEY1
          STRIP     PMULUHID
          PACK      DIM8,SP70
          COMPARE   "1",WACTIVE
          IF        @EQUAL
            PACK      DIM8,PTWDUPDT,SP70
          ENDIF
          STRIP     DIM8
.
          PACK      OBJECTTX,PTCNNSSI,TILDA: * HEALTH_SERVICE_LOCATION_SOURCE_ID
                             PTCNNECI,TILDA: * CAMPUS_LOCAL_ID
                             WWARD,TILDA:    * WARD_LOCAL_ID
                             NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE,TILDA: 
.                                            * SERVICE_LOCATION_SOURCE_ID
                             PMULUHID,TILDA: * WARD_LOCATION_ID
                             PTCNNECI,TILDA: * CAMPUS_LOCATION_ID
                             PTCNNEBI,TILDA: * BUILDING_LOCATION_ID
                             WBDESC,TILDA:   * WARD_NAME
                             D2,TILDA:       * WARD_TYPE_CODE
                             DIM10A,SP1,TIME001,TILDA:  * FIRST_OPEN_DATETIME
                             TILDA:          * CLOSURE_DATETIME
                             KEY2,TILDA:     * PRIMARY_BED_TYPE_CODE
                             KEY1,TILDA:     * WARD_IS_VIRTUAL_FLAG
                             ONE,ZERO,ZERO,TILDA: * ADMIN_OSP_ID_TYPE_CODE
                             CANCSID,TILDA:  * WARD_ADMIN_OSP_SOURCE_ID
                             PTCNNIAI        * WARD_ADMIN_OSP_ID
.
          PACK      SRCRDATE,PTWDCRDT,SP70
          PACK      SRCRTIME,PTWDCRTM,SP70
          PACK      SRMDDATE,WBHCRDT,SP70
          PACK      SRMDTIME,WBHCRTM,SP70
.
          CALL      WRCOND00
.
HSWR1200  MATCH     SP70,WBED
          IF        @EQUAL | @EOS
            GOTO      HSWR0500
          ENDIF
.
. get first effective date
          PACK      SAVKEY14,WBHWARD,WBHBED,WBHDATE,SP70
          PACK      KEY14,WWARD,SP70
          CALL      RSPTWBH1
          CALL      RKPTWBH1
          IF        OVRCD<>1
            MATCH     WBHWARD,WWARD
            IF        @EQUAL
              UNPACK    WBHDATE,CCENT,CYEAR,CMON,CDAY
              CALL      CNXT0000                 * Calculate the next Date
              MOVE      KEY8,DATFIELD
              CALL      FMTD0000
              MOVE      FORMATDT,DIM10A
            ENDIF
          ENDIF
          PACK      KEY14,SAVKEY14,SP70
          CALL      RDPTWBH1
.
          MOVE      "135",OBJECTTY
          PACK      OBJECTKY,WWARD,WBED,SP70,SP70
.
          MOVE      SP70,D8
          MOVE      SP70,DIM10B
          IF        WACTIVE=1
            MOVE      WBHDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TIME058,D8
          ENDIF
          STRIP     WBDESC
          STRIP     DIM10A
          STRIP     WBHCRTM
          STRIP     DIM10B
          STRIP     D8
.
          PACK      OBJECTTX,PTCNNSSI,TILDA: * HEALTH_SERVICE_LOCATION_SOURCE_ID
                             PTCNNECI,TILDA: * CAMPUS_LOCAL_ID
                             WWARD,TILDA:    * WARD_LOCAL_ID
                             WBED,TILDA:     * BED_LOCAL_ID
                             TILDA:          * ROOM_LOCAL_ID
                             WBDESC,TILDA:   * BED_DESC
                             DIM10A,SP1,PTWDCRTM,TILDA:  * START_DATETIME
                             SP900           * END_DATETIME
.
          PACK      SRCRDATE,PTWDCRDT,SP70
          PACK      SRCRTIME,PTWDCRTM,SP70
          PACK      SRMDDATE,WBHCRDT,SP70
          PACK      SRMDTIME,WBHCRTM,SP70
.
          CALL      WRCOND00
.
. * if a bed is made inactive, ignore record - Task 0890966
          COMPARE   "1",WACTIVE
          IF        @EQUAL
            GOTO      HSWR0500
          ENDIF
          MOVE      "136",OBJECTTY
          PACK      OBJECTKY,WWARD,WBED,SP70,SP70
.
          UNPACK    WBHDATE,CCENT,CYEAR,CMON,CDAY
          CALL      CNXT0000                 * Calculate the next Date
          MOVE      KEY8,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      WBHCRTM,PRIOTIMA
.
          MOVE      "17 ",CHANGSTM                     * 17=Admitted
          MOVE      "136",CHANGOBJ
          MOVE      "13",CHANGCOL                      * Change column
.
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new value
          PACK      CHANGKEY,WWARD,WBED,SP70,SP70      * Change Key
.
          MATCH     SP70,WEFRBT
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     SP70,THCSCOD
              IF        !@EQUAL
                PACK      D2,ZERO,ONE,SP70
                PACK      DIM2,THCSCOD,SP70
              ENDIF
              MATCH     "1",TCINDC3
              IF        @EQUAL
                PACK      D2,ZERO,THREE,SP70
                PACK      DIM2,ANSY,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,WCLASS
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,WCLASS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     "D",PTCDUDF3
              IF        @EQUAL
                PACK      D2,ZERO,FOUR,SP70
                PACK      DIM2,ANSY,SP70
              ENDIF
              MATCH     "P",PTCDUDF3
              IF        @EQUAL
                PACK      D2,ZERO,FIVE,SP70
                PACK      DIM2,ANSC,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "17 ",CHANGSTM                     * 17=Admitted
          MOVE      "136",CHANGOBJ
.
. column 13 has changed, end last and send new
          MOVE      SP70,CHANGAAA
          MOVE      "13",CHANGCOL                      * Change column
          CALL      RCOL0000           * Return last sent stream object field
          MATCH     D2,CHANGAAA
          GOTO      HSWR3000 IF NOT EQUAL
.
          MOVE      SP70,CHANGAAA
          MOVE      "14",CHANGCOL                      * Change column
          CALL      RCOL0000           * Return last sent stream object field
. column 14 has changed, end last and send new
          MATCH     DIM2,CHANGAAA
          GOTO      HSWR3000 IF NOT EQUAL
.
          GOTO      HSWR0500
.
HSWR3000  MOVE      SP70,CHANGOVL
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,WBHCRDT,SP70
          PACK      SRMDTIME,WBHCRTM,SP70
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      OBJECTKY,WWARD,WBED,WBHCRDT,WBHCRTM,SP70,SP70
          MOVE      SP70,D8
          MOVE      SP70,DIM10B
          IF        WBHACTV=0 & WACTIVE=1
            GOTO      HSWR0500
          ENDIF
          STRIP     DIM10B
          STRIP     D8
.
          PACK      DIM2,ZERO,ONE
          MOVE      SP70,D2
          PACK      D2,ZERO,ONE
.
          MATCH     SP70,WEFRBT
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     SP70,THCSCOD
              IF        !@EQUAL
                PACK      D2,ZERO,ONE,SP70
                PACK      DIM2,THCSCOD,SP70
              ENDIF
              MATCH     "1",TCINDC3
              IF        @EQUAL
                PACK      D2,ZERO,THREE,SP70
                PACK      DIM2,ANSY,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,WCLASS
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,WCLASS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     "D",PTCDUDF3
              IF        @EQUAL
                PACK      D2,ZERO,FOUR,SP70
                PACK      DIM2,ANSY,SP70
              ENDIF
              MATCH     "P",PTCDUDF3
              IF        @EQUAL
                PACK      D2,ZERO,FIVE,SP70
                PACK      DIM2,ANSC,SP70
              ENDIF
            ENDIF
          ENDIF
.
          STRIP     WBDESC
          STRIP     DIM10A
          STRIP     WBHCRTM
          STRIP     DIM10B
          STRIP     D8
          STRIP     DIM2
      PACK    KEY40,WWARD,DASH,WBED,DASH,D2,DASH,DIM2,DASH,WBHCRDT,WBHCRTM,SP70
          SQUEEZE   KEY40
.
          PACK      OBJECTTX,PTCNNSSI,TILDA: * HEALTH_SERVICE_LOCATION_SOURCE_ID
                             PTCNSHSD,TILDA: * CAMPUS_LOCAL_ID
                             WWARD,TILDA:    * WARD_LOCAL_ID
                             WBED,TILDA:     * BED_LOCAL_ID
                             KEY40,TILDA:    * RECORD_ID
                             DIM10A,SP1,WBHCRTM,TILDA:  * FIRST_OPEN_DATETIME
                             DIM10B,SP1,D8,TILDA:  * CLOSURE_DATETIME
                             D2,TILDA:       * BED_ATTRIBUTE_TYPE_CODE
                             DIM2            * BED_ATTRIBUTE_CODE
.
          PACK      SRCRDATE,WBHCRDT,SP70
          PACK      SRCRTIME,WBHCRTM,SP70
          PACK      SRMDDATE,WBHCRDT,SP70
          PACK      SRMDTIME,WBHCRTM,SP70
.
          CALL      WRCOND00
.
          GOTO      HSWR0500
.
HSWR9999  RETURN
+
.------------------------------------------------------------------------
.          CNXT0000 - Calculate the next day
.------------------------------------------------------------------------
CNXT0000  MOVE      CDAY,DD              * These variables are
          MOVE      CMON,MM              * used by DMYCON
          MOVE      CYEAR,YY
          MOVE      CCENT,CC
          CALL      DMYCON               * Convert to Julian format
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON               * Convert back to "normal" format
.
          MOVE      DD,CDAY
          MOVE      MM,CMON
          MOVE      YY,CYEAR
          MOVE      CC,CCENT
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
.
CNXT9999  RETURN
+
.******************************************************************************
.*  WR570000 - Write object type 57
.*  Requires pattranf/patmi1af record
.******************************************************************************
WR570000  MOVE      "57",OBJECTTY
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
          MOVE      AURNO,D8
          SQUEEZE   D8
          PACK      OBJECTKY,DTADMN,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_TYPE_CODE
                             PTCNNIAI,TILDA: * CLIENT_ID_ISSUING_AUTH
                             D8,SP900     * CLIENT_ID      
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
WR579999  RETURN
+
.******************************************************************************
.*  WR590000 - Write object type 59
.*  Requires pattranf/patmi1af record
.******************************************************************************
WR590000  MOVE      "59",OBJECTTY
          PACK      KEY14,DTADMN,ZERO,TWO,ZERO,SP70
          CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,WR591000
.
          MATCH     DTADMN,VSCTVIST
          GOTO      WR591000 IF NOT EQUAL
.
          MATCH     "020",VSCTTYPE
          GOTO      WR591000 IF NOT EQUAL
.
          MATCH     SP70,VSCTDATA
          GOTO      WR591000 IF EQUAL
.
          REP       "~ ",VSCTDATA
          PACK      KEY100,VSCTDATA
.
WR591000  MATCH     SP70,ADIAG1
          GOTO      WR599999 IF EQUAL
          REP       "~ ",ADIAG1
          PACK      KEY100,ADIAG1,SP70,SP70
.
WR592000  MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
          MOVE      AURNO,D8
          SQUEEZE   D8
          STRIP     KEY100
          PACK      OBJECTKY,DTADMN,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             DIM8,TILDA:     * PRESENTING_ISSUE_RECORD_ID
                             ZERO,FOUR,TILDA:* PRESENTING_ISSUE_SOURCE_CODE
                             ZERO,ONE,TILDA: * PRESENTING_ISSUE_SEQUENCE_NUMBER
                             TILDA:          * PRESENTING_ISSUE_START_DATE
                             SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE,TILDA:
.                                            * PRESENTING_ISSUE_REF_SOURCE_ID
                             TILDA:          * PRESENTING_ISSUE_DOMAIN_ID
                             TILDA:          * PRESENTING_ISSUE_CODE
                             KEY100,SP900    * PRESENTING_ISSUE_COMMENTS
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
WR599999  RETURN
+
.******************************************************************************
.*  MHLG0000 - Write MH Legal Status changes - object type 60
.*  ATTRTYPE,ATTRVALU,DIM10A,PRIOTIMA,DIM10B,PRIOTIMB
.* send legal status attribute *
.******************************************************************************
MHLG0000  PACK      KEY51,STRTDATE,SP70
          CALL      RSPTATR4
MHLG0500  CALL      RKPTATR4
          BRANCH    OVRCD,MHLG9999
.
          MATCH     PTARUDTE,ENDDATE
          GOTO      MHLG9999 IF LESS
.
          MATCH     "019",PTARTYPE
          GOTO      MHLG0500 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
            MOVE      PTARDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      PTARTIME,PRIOTIMA
.
            MOVE      ANSD,OBJECTRT
            PACK      CMEWSCDT,PTARCDTE,SP70
            PACK      CMEWSCTM,PTARCTME,SP70
            MOVE      "17 ",DELETSTM          * 17=Inpatient
            MOVE      "60 ",DELETOBJ          * MH Attribute
            PACK      SRMDDATE,PTARCDTE,SP70
            PACK      SRMDTIME,PTARCTME,SP70
            PACK      DELETKEY,PTARVISN,ZERO,NINE,DIM10A,PRIOTIMA,SP70
            CALL      EDDK0000
            GOTO      MHLG0500
          ENDIF
.
          MOVE      "09",ATTRTYPE
          MOVE      SP70,ATTRVALU
.
          MATCH     SP70,PTARCOD1
          GOTO      MHLG0500 IF EQUAL
.
          PACK      KEY5,ANSL,ANSS,PTARCOD1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF4,ATTRVALU
          ENDIF
.
          PACK      DTADMN,PTARVISN,SP70
          PACK      TDATE,PTARDATE,SP70
          PACK      TTIME,PTARTIME,SP70
.
          MOVE      PTARDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      PTARTIME,PRIOTIMA
.
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MATCH     SP70,PTARFDTE
          IF        !@EQUAL
            MOVE      PTARFDTE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      PTARFTME,PRIOTIMB
          ENDIF
          MOVE      ONE,SENDALT
          PACK      PMVXCDTE,PTARCDTE,SP70
          PACK      PMVXCTIM,PTARCTME,SP70
          PACK      PMAWCDAT,PTARUDTE,SP70
          PACK      PMAWCTIM,PTARUTME,SP70
.
          CALL      WR600000     * write object type 60 record
          GOTO      MHLG0500
.
MHLG9999  RETURN
+
.******************************************************************************
.*  WR600000 - Write object type 60
.*  Requires pattranf/patmi1af record
.*  ATTRTYPE,ATTRVALU,DIM10A,PRIOTIMA,DIM10B,PRIOTIMB
.******************************************************************************
WR600000  MOVE      "60",OBJECTTY
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
          STRIP     ATTRTYPE
          STRIP     ATTRVALU
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          STRIP     DIM10A
          STRIP     DIM10B
          PACK      KEY20,SP70
          MATCH     "09",ATTRTYPE
          IF        @EQUAL
....        MOVE      "17 ",CHANGSTM                     * 17=Admitted
....        MOVE      "60 ",CHANGOBJ
....        MOVE      "15",CHANGCOL                      * Change column
....        MOVE      SP70,CHANGOVL
....        PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new value
....        PACK      CHANGKEY,DTADMN,ATTRTYPE,SP70,SP70 * Change Key
....        PACK      CHANGPRM,SP70,SP70                 * Change primary key
....        PACK      SRMDDATE,PMAWCDAT,SP70
....        PACK      SRMDTIME,PMAWCTIM,SP70
....        CALL      LSOF0000           * Change sent stream object field
            PACK      KEY20,ATTRTYPE,DIM10A,SP1,PRIOTIMA,ATTRVALU,SP70
          ELSE
            PACK      KEY20,ATTRTYPE,SP70
          ENDIF
          STRIP     KEY20
.
          MATCH     "09",ATTRTYPE
          IF        @EQUAL
            PACK      OBJECTKY,DTADMN,ATTRTYPE,DIM10A,PRIOTIMA,SP70,SP70
          ELSE
            PACK      OBJECTKY,DTADMN,ATTRTYPE,SP70,SP70
          ENDIF
.
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             KEY20,TILDA: * ATTRIBUTE_RECORD_ID
                             ATTRTYPE,TILDA: * ATTRIBUTE_TYPE_CODE
                             TILDA:          * ATTRIBUTE_LOCAL_CODE
                             ATTRVALU,TILDA: * ATTRIBUTE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB,SP900  * END_DATETIME
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
WR609999  RETURN
+
.******************************************************************************
.*  WR630000 - Write object type 63
.*  Requires pattranf/patmi1af record
.*  DIM10A,PRIOTIMA,DIM10B,PRIOTIMB
.******************************************************************************
WR630000  MOVE      "63",OBJECTTY
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          STRIP     DIM10A
          STRIP     DIM10B
.
          MOVE      SP70,PMHCPRV1
          PACK      KEY16,TADOCT,SP70
          CALL      RSPMHCP4
          CALL      RKPMHCP4
          BRANCH    OVRCD,WR631000
.
          MATCH     PMHCLDOC,TADOCT
          GOTO      WR631000 IF NOT EQUAL
.
          STRIP     PMHCPRV1
          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,PTCDUDF3
          ENDIF
          STRIP     PTCDUDF3
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          UNPACK    TTIME,XHOUR,D1,XMIN
          PACK      KEY11,CYEAR,CMON,CDAY,XHOUR,XMIN,SP70
          STRIP     KEY11
.
          SQUEEZE   TADOCT
          PACK      OBJECTKY,DTADMN,ANSI,TDATE,TTIME,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             ANSI,KEY11,TILDA: * PROVIDER_RECORD_ID
                             ANSI,TILDA:     * PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA: * PROVIDER_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * PROVIDER_SOURCE_ID
                             TADOCT,TILDA:   * PROVIDER_ID
                             PTCDUDF3,TILDA: * DISC_SPEC_CODE
                             TILDA:          * DISC_SPEC_LOCAL_CODE
                             TILDA:          * OSP_LOCAL_ID
                             ANSY,TILDA:     * RESPONSIBLE_PROVIDER_FLAG
                             TWO,TILDA:      * COLLABORATIVE_CARE_ROLE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB,TILDA: * END_DATETIME
                             SP900           * OSP_CREATED_SERVICE_EVENT_FLAG
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
WR631000  PACK      OBJECTKY,DTADMN,ANSO,ONE,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             DIM8,ANSO,TILDA: * PROVIDER_RECORD_ID
                             ANSO,TILDA:     * PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA: * PROVIDER_ID_TYPE_CODE
                             NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE:
                             TILDA: * PROVIDER_SOURCE_ID
                             PTCNNIAI,TILDA: * PROVIDER_ID
                             TILDA:          * DISC_SPEC_CODE
                             TILDA:          * DISC_SPEC_LOCAL_CODE
                             PTCNNIAI,TILDA: * OSP_LOCAL_ID
                             ANSN,TILDA:     * RESPONSIBLE_PROVIDER_FLAG
                             TWO,TILDA:      * COLLABORATIVE_CARE_ROLE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB,TILDA: * END_DATETIME
                             ANSY,SP900      * OSP_CREATED_SERVICE_EVENT_FLAG
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
          PACK      OBJECTKY,DTADMN,ANSO,ANSP,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             DIM8,ANSO,ANSP,TILDA: * PROVIDER_RECORD_ID
                             ANSO,TILDA:     * PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA: * PROVIDER_ID_TYPE_CODE
                             NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE:
                             TILDA: * PROVIDER_SOURCE_ID
                             PTCNNCPP,TILDA: * PROVIDER_ID
                             TILDA:          * ISP_SPEC_CODE
                             TILDA:          * ISP_SPEC_LOCAL_CODE
                             PTCNNIAI,TILDA: * OSP_LOCAL_ID
                             ANSY,TILDA:     * RESPONSIBLE_PROVIDER_FLAG
                             ONE,TILDA:      * COLLABORATIVE_CARE_ROLE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB,TILDA: * END_DATETIME
                             ANSN,SP900      * OSP_CREATED_SERVICE_EVENT_FLAG
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
WR639999  RETURN
+
.******************************************************************************
.*  HS720000 - Write object type 72
.*  Requires pattranf/patmi1af record
.*  DIM10A,PRIOTIMA,DIM10B,PRIOTIMB
.******************************************************************************
HS720000  MOVE      "72",OBJECTTY
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
          MOVE      AURNO,D8
          SQUEEZE   D8
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          STRIP     DIM10A
          STRIP     DIM10B
.
          MOVE      SP70,PMHCPRV1
          PACK      KEY16,ADOCTA,SP70
          CALL      RSPMHCP4
          CALL      RKPMHCP4
          IF        OVRCD=1
            MOVE      SP70,PMHCPRV1
          ELSE
            MATCH     PMHCLDOC,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,PMHCPRV1
            ENDIF
          ENDIF
.
          STRIP     PMHCPRV1
.
          MOVE      SP70,PTCDASC1
          PACK      KEY5,ANSS,SP1,ASRCE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,PTCDASC1
          ENDIF
          STRIP     PTCDASC1
.
          PACK      KEY19,AURNO,SP20        * Get Waiting List procedure
          CALL      RDSTREA1
HS721000  CALL      RDKTREA1
          BRANCH    OVRCD,HS722000          * no procedures
.
          MATCH     AURNO,WMURNO            * same UR?
          GOTO      HS722000 IF NOT EQUAL   * no; get next WL patient procedure
.
          MATCH     AADMNO,WMBOOK           * same booking?
          GOTO      HS723000 IF EQUAL
          GOTO      HS721000                * no; get next WL patient procedure
.
HS722000  MOVE      SP70,WMKEYDT
          MOVE      SP70,WMDATE1
.
HS723000  PACK      OBJECTKY,DTADMN,SP70,SP70
          STRIP     WMKEYDT
          STRIP     WMDATE1
          PACK      OBJECTTX,PTCNNSSI,TILDA: * REQUEST_FOR_SERVICE_SOURCE_ID
                             DIM8,TILDA:     * REQUEST_SERVICE_RECORD_ID
                             TWO,TILDA:      * SERVICE_EVENT_RECORD_ID
                             PTCDASC1,TILDA: * REQUEST_SOURCE_TYPE_CODE
                             TILDA:          * CORRESPONDENCE_DATE
                             WMKEYDT,TILDA:  * RECEIVED_DATE
                             TILDA:          * EXPIRY_DATE
                             TILDA:          * COMMENTS
                             WMDATE1,TILDA:  * ACCEPTANCE_DATE
                             TILDA:          * REJECTION_DATE
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_TYPE_CODE
                             PTCNNIAI,TILDA: * ISSUING_AUTH
                             D8,TILDA:       * CLIENT_ID
                             ONE,ZERO,ZERO,TILDA: * OSP_ID_TYPE_CODE
                             NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE:
                             TILDA:          * OSP_SOURCE_ID
                             PTCNNIAI,TILDA: * OSP_ID
                             ZERO,THREE,FIVE,TILDA: * OSP_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * ISP_SOURCE_ID
                             PMVXRHC1,SP900  * REQUESTING_ISP_ID
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
HS729999  RETURN
+
.******************************************************************************
.*  SEAD0000 - Write object type 112 - Service Event and Admitted
.*  Requires pattranf/patmi1af record
.******************************************************************************
SEAD0000  MOVE      "112",OBJECTTY
          MOVE      SP70,PLEVOFFR
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
          MOVE      AURNO,D8
          SQUEEZE   D8
          MOVE      ADATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      ATIME,PRIOTIMA
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,SEAD9999
          CALL      RDPMPX21
          BRANCH    OVRCD,SEAD9999
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
          ENDIF
.
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          STRIP     DIM10A
          STRIP     DIM10B
.
. * care type
          MOVE      SP70,CARETYPE
          MOVE      SP70,CARETYPA
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF3,CARETYPE  * 1st 5 characters
            MOVE      PTCDASC1,CARETYPA  * 1st character only
          ENDIF
          STRIP     CARETYPE
          STRIP     CARETYPA
.
. * previous specialised treatment
          MOVE      SP70,PREVSPEC
          MATCH     SP70,PMVXUDF6
          IF        !@EQUAL
            PACK      KEY5,ANSY,ANSE,PMVXUDF6,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,PREVSPEC
            ENDIF
          ENDIF
          STRIP     PREVSPEC
.
. * primary treatment
          MOVE      SEVEN,PRIMTREA
          MOVE      SP70,LEGLSTAT
          CALL      CHATR000      * check legal status attributes
          STRIP     LEGLSTAT
          STRIP     PRIMTREA
.
. * year last admitted to psych
          MOVE      SP70,PSYCYEAR
          MATCH     SP70,ATYPE
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     ANSP,TCINDC3
              IF        @EQUAL
                MOVE      PMVXUDT1,PSYCYEAR
              ENDIF
            ENDIF
          ENDIF
.  ** task 0893076 if previous specialised treatment=2,4 or 5
.  ** and last year blank, set year to 9999
          MATCH    "2",PREVSPEC
          GOTO     SEAD0200 IF EQUAL
.
          MATCH    "4",PREVSPEC
          GOTO     SEAD0200 IF EQUAL
.
          MATCH    "5",PREVSPEC
          GOTO     SEAD0300 IF NOT EQUAL
.
SEAD0200  MATCH    SP70,PSYCYEAR
          IF       @EQUAL
            MOVE     "9999",PSYCYEAR
          ENDIF
.
SEAD0300  STRIP    PSYCYEAR
.
. * accommodation type
          MOVE      SP70,ACCOMTYP
          MATCH     SP70,PMVXUSAC
          IF        !@EQUAL
            PACK      KEY5,ANSK,ANSP,PMVXUSAC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      PTCDASC1,ACCOMTYP
            ENDIF
          ENDIF
          STRIP     ACCOMTYP
.
. * employment status 
          MOVE      SP70,EMPLOYMS
          MATCH     SP70,PMVXEMPL
          IF        !@EQUAL
            PACK      KEY5,ANSK,ANSD,PMVXEMPL,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      PTCDUDF3,EMPLOYMS
            ENDIF
          ENDIF
          STRIP     EMPLOYMS
.
. * intended los code
          MOVE      SP70,INTLOSCD
          MATCH     SP70,PMVXIDUS
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSI,PMVXIDUS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,INTLOSCD
            ENDIF
          ENDIF
          STRIP     INTLOSCD
.
. * weight
          SQUEEZE   ABWGHT
.
. * coding status
          MOVE      TWO,CODINGST
          MATCH     SP70,ACODDTE
          IF        !@EQUAL
            MOVE      ONE,CODINGST
          ENDIF
. 
. * planned event offer
          MOVE      SP70,PLEVOFFR
          MOVE      SP70,PSETYPEC
          MOVE      SP70,PSESOURC
          MOVE      SP70,WTWMECNT
          MOVE      SP70,WMBOOK
          PACK      KEY8,DTADMN,SP70
          CALL      RDBKREC1
          IF        OVRCD<>1
            MATCH     SP70,BKREPROC
            GOTO      SEAD1000 IF EQUAL
.
            PACK      KEY19,BKREURNO,BKREPROC,DBKRECNT,SP70
            CALL      RDTREA1
            BRANCH    OVRCD,SEAD1000
...         COMPARE   TWO,WMSTAT
...         IF        @EQUAL
...           PACK      PLEVOFFR,DTADMN
              PACK      PLEVOFFR,ANSW,WTWMECNT,DASH,WMBOOK,SP70
              PACK      PSETYPEC,TWO
              PACK      PSESOURC,PTCNNSSI
...         ENDIF
          ENDIF
          STRIP     PSESOURC
          SQUEEZE   PLEVOFFR
.
. * pension status
SEAD1000  MOVE      "01",PENSCODE
          PACK      KEY19,AURNO,SP70
          CALL      RSPMCCD1
SEAD1050  CALL      RKPMCCD1
          BRANCH    OVRCD,SEAD1100
.
          MATCH     AURNO,PMCDURNO
          GOTO      SEAD1100 IF NOT EQUAL
.
          MATCH     SP70,PMCDEXDT  * only check expiry if entered
          IF        !@EQUAL
            MATCH     ENDDATE,PMCDEXDT
            GOTO      SEAD1050 IF LESS
          ENDIF
.
          PACK      KEY5,LOWC,LOWT,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SEAD1100
.
          MATCH     "7",TCINDC1
          IF        @EQUAL
            MOVE      "18",PENSCODE
            GOTO      SEAD1100
          ENDIF
          MATCH     "1",TCINDC1
          IF        @EQUAL
            MOVE      "99",PENSCODE
            GOTO      SEAD1050
          ENDIF
          MATCH     "3",TCINDC1
          IF        @EQUAL
            MOVE      "99",PENSCODE
            GOTO      SEAD1050
          ENDIF
          MATCH     "3",TCINDC1
          IF        @EQUAL
            MOVE      "99",PENSCODE
            GOTO      SEAD1050
          ENDIF
          GOTO      SEAD1050
.
SEAD1100  MOVE      ASTAY,D5
          SQUEEZE   D5
.
. * insurance claim flag
          MOVE      ANSN,INSCLFLG
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSP,TCINDC6
            IF        @EQUAL
              MOVE      ANSY,INSCLFLG
            ENDIF
          ENDIF
.
. * urgency code
          MOVE      SP70,URGENCYC
          PACK      KEY5,ANSP,SP1,ACLSS,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    PTCDUDF3,URGENCYC
          ENDIF
          STRIP     URGENCYC
.
. * readmit status
          MOVE      ONE,READMITC
          CALL      CHK28D00    * check if readmitted in 28 days
...       MATCH     SP70,PMVXREAD
...       IF        !@EQUAL
...         PACK      KEY5,ANSK,ANSM,PMVXREAD,SP70
...         CALL      RDCODE1
...         IF        OVRCD<>1
...           UNPACK    THCSCOD,READMITC
...         ENDIF
...       ENDIF
          STRIP     READMITC
.
. * unplanned return to theatre
          MOVE      SP70,UNPRETTH
          MATCH     SP70,PMVXUVTH
          IF        !@EQUAL
            PACK      KEY5,ANSK,ANSB,PMVXUVTH,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK    THCSCOD,D2,UNPRETTH
            ENDIF
          ENDIF
          STRIP     UNPRETTH
.
. * discharge intention
          MOVE      SP70,DISINTEN
          MATCH     SP70,PMVXUDIN
          IF        !@EQUAL
            PACK      KEY5,ANSK,ANSN,PMVXUDIN,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK    PTCDUDF3,DISINTEN * 891375
            ENDIF
          ENDIF
          STRIP     DISINTEN
.
. * expected discharge date
          MOVE      SP70,PMWOEDAT
          PACK      KEY8,DTADMN,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            UNPACK    SP70,PMWOEDAT
          ENDIF
          STRIP     PMWOEDAT
.
. * weight
          MOVE      SP70,WEIGHT
          PACK      WEIGHT,ABWGHT
          STRIP     WEIGHT
.
          MOVE      SP70,ARRVMODE           * Arrival mode
. * discharge mode
          MOVE      SP70,DISCMODE
          MOVE      SP70,SEPRMODE
          MATCH     SP70,DDEST
          GOTO      SEAD2000 IF EQUAL
.
          PACK      KEY5,ANSD,ANSD,DDEST,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SEAD2000
.
          MOVE      THCSCOD,DISCMODE
          UNPACK    THCSCOD,D2,D1
          MOVE      D1,SEPRMODE
.
          MATCH     SP70,DDATE              * Discharged after 1 July 2021
          IF        !@EQUAL
            MATCH     "20210701",DDATE
            IF        !@LESS
              MOVE      PTCDUDF3,SEPRMODE
            ENDIF
          ENDIF
.
          MATCH     ANSD,TMOVE
          GOTO      SEAD2000 IF NOT EQUAL
.
. is this a statistical discharge?
          MATCH     "S",TCINDC7
          IF        @EQUAL
            PACK       DISINTEN,ONE,SP70
            PACK       DISCMODE,ZERO,ONE,SP70
            PACK       SEPRMODE,FIVE,SP70
.
            MATCH     SP70,DDATE              * Discharged after 1 July 2021
            IF        !@EQUAL
              MATCH     "20210701",DDATE
              IF        !@LESS
                 MOVE      "50",SEPRMODE
              ENDIF
            ENDIF
.
          ENDIF
.
          MATCH     "E",TCINDC7
          IF        @EQUAL
            PACK       DISINTEN,ONE,SP70
            PACK       DISCMODE,ZERO,ONE,SP70
            PACK       SEPRMODE,FIVE,SP70
.
            MATCH     SP70,DDATE              * Discharged after 1 July 2021
            IF        !@EQUAL
              MATCH     "20210701",DDATE
              IF        !@LESS
                 MOVE      "50",SEPRMODE
              ENDIF
            ENDIF
          ENDIF
.
SEAD2000  STRIP     DISCMODE
          STRIP     SEPRMODE
.
. * mech vent hours
          MOVE      ZERO,MECHVENT
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTICU1
          IF        OVRCD=1
            MOVE      ZERO,PTICUMEC
          ENDIF
          MOVE      PTICUMEC,MECHVENT
          SQUEEZE   MECHVENT
.
. * admission mode
          MOVE      "3",ADMNMODE
          MOVE      SP70,REQUESTS
          PACK      KEY5,ANSS,SP1,ASRCE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDASC2,REQUESTS
            MATCH     "1",TCINDC1
            IF        @EQUAL
              MOVE      "1",ADMNMODE
            ENDIF
            MATCH     "2",TCINDC1
            IF        @EQUAL
              MOVE      "2",ADMNMODE
            ENDIF
          ENDIF
          STRIP     REQUESTS
          STRIP     ADMNMODE
. is this a statistical admission?
          MATCH     "2",TCINDC3
          GOTO      SEAD8000 IF NOT EQUAL
.
          PACK      READMITC,ONE,SP70
          PACK      URGENCYC,TWO,SP70
          PACK      ADMNMODE,TWO,SP70
          PACK      ARRVMODE,ONE,ONE,SP70
          PACK      REQUESTS,ZERO,FIVE,DOT,TWO,SIX,SP70
          STRIP     READMITC
          STRIP     ADMNMODE
          STRIP     REQUESTS
          STRIP     URGENCYC
          STRIP     ARRVMODE
.
.* use the discharge date/time of the stat admission instead of actual adate/tim
          PACK      KEY8,PTMILSDN,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,SEAD8000
.
          MOVE      DDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      DTIME,PRIOTIMA
.
          STRIP     DIM10A
          STRIP     PRIOTIMA
.
. - re-read this discharge record
          PACK      KEY8,DAADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
SEAD8000  MOVE      SP70,DIM10C
          MOVE      SP70,PRIOTIMC
          CALL      EAMB0000                * ED Linked ambulance case number
          STRIP     DIM10C
          STRIP     PRIOTIMC
          STRIP     ARRVMODE
.
          SQUEEZE   PLEVOFFR
          MOVE      SP70,DRGVERSN
          MOVE      SP70,DDRGCODE
          MOVE      SP70,AFUNDH * 0893076 don't use health fund drg
          CALL      GETDRG
          MATCH     "050",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG50
          ENDIF
.
          MATCH     "051",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG51
          ENDIF
.
          MATCH     "052",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG51
          ENDIF
.
          MATCH     "060",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG60
          ENDIF
.
          MATCH     "062",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG6X
          ENDIF
.
          MATCH     "070",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG70
          ENDIF
.
          MATCH     "080",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG80
          ENDIF
.
          MATCH     "090",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG90
          ENDIF
.
          MATCH     "100",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG100
          ENDIF
.
          MATCH     "110",DRGVER
          IF        @EQUAL
            PACK      DRGVERSN,DRG110
          ENDIF
.
          PACK      DRGSRCID,SP70
          PACK      DRGRETCD,SP70
          MATCH     SP70,DDRGCODE
          IF        !@EQUAL
            PACK      DRGSRCID,SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE,SP70
            PACK      DRGRETCD,ZERO,ZERO,SP70
          ENDIF
          STRIP     DRGSRCID
          STRIP     DRGRETCD
          STRIP     DRGVERSN
          STRIP     DDRGCODE
          STRIP     PTDSDMDC
          MOVE      SP70,KEY10
          MATCH     SP70,WTWMECNT
          IF        !@EQUAL
            PACK      KEY10,ANSW,WTWMECNT,SP70
          ENDIF
          SQUEEZE   KEY10
. claim reason
          MOVE      SP70,D2
          MATCH     SP70,PFUNDH
          IF        !@EQUAL
            MOVE      "01",D2
          ENDIF
          STRIP     D2
.
          PACK      OBJECTKY,DTADMN,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             PTCNNSSI,TILDA: * REQUEST_FOR_SERVICE_SOURCE_ID
                             DIM8,TILDA:     * RECORD_ID
                             PSETYPEC,TILDA: * PLANNED_SERVICE_EVENT_TYPE_CODE
                             PSESOURC,TILDA: * PLANNED_EVENT_OFFER_SOURCE_ID
                             PLEVOFFR,TILDA: * PLANNED_EVENT_OFFER_RECORD_ID
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATE
                             DIM10B,SP1,PRIOTIMB,TILDA: * END_DATE
                             ANSY,TILDA:     * COLLABORATIVE_CARE_FLAG
                             THREE,TILDA:    * COLLABORATIVE_CARE_STATUS
                             CARETYPE,TILDA: * CARE_TYPE_NHDD_CODE
                             PREVSPEC,TILDA: * PREV_SPEC_TREATMENT_CODE
                             PSYCYEAR,TILDA: * YEAR_LAST_ADMIT_TO_PSYC
                             PRIMTREA,TILDA: * PRIMARY_TREATMENT_PURPOSE_CODE
                             CODINGST,TILDA: * CLINICAL_CODING_STATUS
                             WEIGHT,TILDA:   * WEIGHT_AT_SERVICE_EVENT
                             ACCOMTYP,TILDA: * ACCOMMODATION_TYPE_CODE
                             EMPLOYMS,TILDA: * EMPLOYMENT_STATUS_CODE 
                             PENSCODE,TILDA: * PENSION_CODE
                             DIM14A,TILDA:   * AMBULANCE_INCIDENT_ID
                             DIM10C,SP1,PRIOTIMC,TILDA:* AMBULANCE_INCIDENT_DATE
                             DIM10A,SP1,PRIOTIMA,TILDA: * FORMAL_ADMIT_DATE
                             D5,TILDA:       * INTENDED_LOS
                             INTLOSCD,TILDA: * INTENDED_LOD_CODE
                             CARETYPA,TILDA: * SERVICE_CATEGORY
                             INSCLFLG,TILDA: * INSUR_CLAIM_FLAG
                             D2,TILDA:       * CLAIM_REASON_FLAG
                             URGENCYC,TILDA: * URGENCY_CODE
                             READMITC,TILDA: * READMIT_CODE
                             PMWOEDAT,TILDA: * EXPECTED_DISCHARGE_DATE
                             UNPRETTH,TILDA: * UNPLANNED_RETURN_TO_THEATRE
                             PMWOEDAT,TILDA: * LAST_EXPECTED_DISCHARGE_DATE
                             DIM10B,SP1,PRIOTIMB,TILDA: * END_DATE
                             DISINTEN,TILDA: * DISCHARGE_INTENTION
                             DISCMODE,TILDA: * DISCHARGE_MODE
                             LEGLSTAT,TILDA: * MH_LEGAL_STATUS
                             MECHVENT,TILDA: * TOTAL_MECH_VENT_HOURS
                             DDRGCODE,TILDA: * AR_DRG_CODE
                             DRGVERSN,TILDA: * AR_DRG_REF_DOMAIN_ID
                             DRGSRCID,TILDA: * AR_DRG_REF_SOURCE_ID
                             PTDSDMDC,TILDA: * AR_DRG_MDC_CODE
                             TILDA:          * AR_DRG_PCCL_CODE
                             DRGRETCD,TILDA: * AR_DRG_RETURN_CODE
                             PSETYPEC,TILDA: * WL_SERICE_EVENT_TYPE_CODE
                             PSESOURC,TILDA: * WL_BOOKING_SOURCE_ID
                             KEY10,TILDA: * WL_BOOKING_RECORD_ID
                             NINE,NINE,TILDA:* PRIMARY_PROGRAM_FUNDING_SOURCE
                             DIM8,TILDA:     * ALT_ENCOUNTER_ID
                             ZERO,TWO,TILDA: * SERVICE_EVENT_MODEL_OF_CARE_CODE
                             ARRVMODE,TILDA: * CLIENT_MODE_OF_ARRIVAL_CODE
                             ADMNMODE,TILDA: * ADMISSION_MODE
                             SEPRMODE,TILDA: * SEPARATION_MODE
                             REQUESTS,SP900  * REQUEST_SOURCE_TYPE_CODE
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PTTRCDAT,SP70
          PACK      SRMDTIME,PTTRCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
SEAD9999  RETURN
+
.******************************************************************************
* Check if readmitted in 28 days     
.******************************************************************************
CHK28D00  PACK      KEY24,AURNO,Z70      * seach for the last discharge date
          CALL      RDSDSCH3
CHK28D10  CALL      RDPDSCH3             * hunt backwards
          BRANCH    OVRCD,CHK28D20
.
          MATCH     AURNO,DURNO
          GOTO      CHK28D20 IF NOT EQUAL
.
          MOVE      ZERO,F8
          MATCH     DAADMNO,DDADMNO    * same visit? ignore
          GOTO      CHK28D10 IF EQUAL
.
          MATCH     DDATE,ADATE
          GOTO      CHK28D10 IF LESS
.
          DAYSEP    DDATE,ADATE,F8
          IF        F8<29
            MOVE      TWO,READMITC
            GOTO      CHK28D99
          ELSE
            GOTO      CHK28D10
          ENDIF
.
CHK28D20  PACK      KEY29,DAADMNO,SP70
          CALL      RSPMPHS1
CHK28D25  CALL      RKPMPHS1
          BRANCH    OVRCD,CHK28D99
.
          MATCH     DAADMNO,PMPHADMN
          GOTO      CHK28D99 IF NOT EQUAL
.
          MOVE      ZERO,F8
          MATCH     PMPHDDAT,ADATE
          GOTO      CHK28D25 IF LESS
.
          DAYSEP    PMPHDDAT,ADATE,F8
          IF        F8<29
            MOVE      THREE,READMITC
            GOTO      CHK28D99
          ELSE
            GOTO      CHK28D25
          ENDIF
.
. - re-read this discharge record
CHK28D99  PACK      KEY8,DAADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          RETURN
+
.******************************************************************************
* Get MH Legal status attribues      
.******************************************************************************
CHATR000  MOVE      ZERO,FOUNDFLG
          PACK      KEY35,AURNO,DTADMN,ZERO,ONE,NINE,Z70
          CALL      RSPTATR3
CHATR100  CALL      RPPTATR3
          BRANCH    OVRCD,CHATR900
.
          MATCH     AURNO,PTARURNO
          GOTO      CHATR900 IF NOT EQUAL
.
          MATCH     DTADMN,PTARVISN
          GOTO      CHATR900 IF NOT EQUAL
.
          MATCH     "019",PTARTYPE
          GOTO      CHATR900 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      CHATR100 IF EQUAL
.
          MOVE      ONE,FOUNDFLG
          MATCH     SP70,PTARFDTE
          IF        @EQUAL
            MOVE      ANSA,PRIMTREA
            GOTO      CHATR500
          ENDIF
.
          PACK      KEY8,DTADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          MATCH     SP70,DDATE
          IF        @EQUAL
            MOVE      ANSA,PRIMTREA
            GOTO      CHATR500
          ENDIF
.
          MATCH     DDATE,PTARFDTE
          IF        @EQUAL
            MOVE      ANSA,PRIMTREA
            GOTO      CHATR500
          ENDIF
.
CHATR500  PACK      KEY5,ANSL,ANSS,PTARCOD1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     "1",PTCDASC1
            IF        @EQUAL
              MOVE      PTCDASC1,LEGLSTAT
            ENDIF
          ENDIF
          GOTO      CHATR100
.
CHATR900  IF        FOUNDFLG=1
            GOTO      CHATR999
          ENDIF
.
          MATCH     SP70,PMVXMHLS
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSS,PMVXMHLS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      PTCDASC1,LEGLSTAT
            ENDIF
          ENDIF
.
CHATR999  RETURN
+
.******************************************************************************
* Get ED Linked ambulance case number
.******************************************************************************
EAMB0000  PACK      DIM14A,SP70
.
          PACK      KEY16,AURNO,Z70
          CALL      RSEMVIS3                * Check for linked ED visit
EAMB1000  CALL      RPEMVIS3
          BRANCH    OVRCD,EAMB9000
.
          MATCH     AURNO,EMVIURNO
          GOTO      EAMB9000 IF NOT EQUAL
.
          MATCH     EMVIPADM,DAADMNO
          GOTO      EAMB1000 IF NOT EQUAL
.
          PACK      DIM14A,EMVIAMBL,SP70
          MOVE      EMVIUD09,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10C
          MOVE      EMVIUT09,PRIOTIMC
.
          PACK      KEY5,ANSE,ANSA,EMVIMODE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      ARRVMODE,THCSCOD,SP70
          ENDIF
.
EAMB9000  STRIP     DIM14A
.
EAMB9999  RETURN
+
.******************************************************************************
.*  SETR0000 - Write object type 130 - Service Event Transfer     
.*  Requires pattranf/patmi1af record
.******************************************************************************
SETR0000  MOVE      "130",OBJECTTY
          MOVE      SP70,PLEVOFFR
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
          MOVE      ADATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      ATIME,PRIOTIMA
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
          ENDIF
.
          PACK      KEY8,DTADMN,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            MOVE      SP70,PTDAADTS
            MOVE      SP70,PTDADCTS
          ENDIF
.
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            PACK      KEY5,PTDAADTS,SP70
          ELSE
            PACK      KEY5,PTDADCTS,SP70
          ENDIF
          CALL      RDPTVAD1
          IF        OVRCD=1
            PACK      TRANSOSP,SP70
          ELSE
            PACK      TRANSOSP,PTVAESTB,SP70
          ENDIF
          SQUEEZE   TRANSOSP
.
          MOVE      SP70,TRANSTYP
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            PACK      KEY5,ANSS,SP1,ASRCE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     "1",TCINDC2
              IF        @EQUAL
                MOVE      ONE,TRANSTYP
              ENDIF
            ENDIF
          ENDIF
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            PACK      KEY5,ANSD,ANSD,DDEST,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     "1",TCINDC2
              IF        @EQUAL
                MOVE      TWO,TRANSTYP
              ENDIF
            ENDIF
          ENDIF
.
          SQUEEZE   TRANSTYP
.
          MATCH     "1",TRANSTYP
          IF        !@EQUAL
            MATCH     "2",TRANSTYP
            GOTO      SETR9999 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,TRANSREA
          MATCH     SP70,PMVXUD12
          IF        !@EQUAL
            MOVE      "rT",TCODE
            PACK      KEY5,TCODE,PMVXUD12,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      PTCDUDF3,TRANSREA
            ENDIF
          ENDIF
          SQUEEZE   TRANSREA 
.
          PACK      OBJECTKY,DTADMN,TRANSTYP,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             TRANSTYP,TILDA: * TRANSFER_TYPE_CODE
                             TRANSREA,TILDA:       * TRANSFER_REASON_CODE
                             ONE,ZERO,ZERO,TILDA:  * TRANSFER_OSP_ID_TYPE_CODE
                             NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE,TILDA:
.                                            * TRANSFER_OSP_SOURCE_ID
                             TRANSOSP,SP900  * TRANSFER_OSP_ID
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          MATCH     "2",TRANSTYP
          IF        @EQUAL
            PACK      SRCRDATE,DDATE,SP70
            PACK      SRCRTIME,DTIME,SP70
          ENDIF
          PACK      SRMDDATE,DDATE,SP70
          PACK      SRMDTIME,DTIME,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
SETR9999  RETURN
+
.******************************************************************************
.*  SERL0000 - Write object type 131 - Service Event Relationship
.*  Requires pattranf/patmi1af record
.******************************************************************************
SERL0000  MOVE      "131",OBJECTTY
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
.
. * mother/baby link
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SERL1000
.
          MATCH     "70",PTCDNHCP
          GOTO      SERL1000 IF NOT EQUAL
.
          PACK      KEY16,AURNO,SP70
          CALL      RDSLINK1
SERL0200  CALL      RDKLINK1
          BRANCH    OVRCD,SERL1000
.
          MATCH     AURNO,LINKFUR
          GOTO      SERL1000 IF NOT EQUAL
.
          PACK      KEY5,ANSL,ANSU,LINKREA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SERL1000
.
          MATCH     "M",TCINDC1
          GOTO      SERL1000 IF NOT EQUAL
. * get mothers admission number
          PACK      KEY24,LINKTUR,ADATE,Z70
          CALL      RDSVISA2
SERL0900  CALL      RDPVISA2
          BRANCH    OVRCD,SERL1000
.
          MATCH     PVIURNO,LINKTUR
          GOTO      SERL1000 IF NOT EQUAL
.
          COMPARE   "3",PVITYPE
          GOTO      SERL0900 IF NOT EQUAL
.
          PACK      MOTHADMN,DPVIBILL
          SQUEEZE   MOTHADMN
.
. * write baby record
          PACK      OBJECTKY,DTADMN,ZERO,ONE,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * EVENT_RECORD_ID
                             ZERO,TWO,DASH,MOTHADMN,TILDA:
.                                            * EVENT_RELATIONSHIP_RECORD_ID
                             ZERO,TWO,TILDA: * EVENT_RELATIONSHIP_TYPE_CODE
                             TWO,TILDA:      * RELATED_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             MOTHADMN,TILDA: * RELATED_ENCOUNTER_RECORD_ID
                             ONE             * EVENT_RECORD_ID
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
. * write mother record
          PACK      OBJECTKY,DTADMN,ZERO,TWO,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             MOTHADMN,TILDA: * ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * EVENT_RECORD_ID
                             ZERO,ONE,DASH,DIM8,TILDA:
.                                            * EVENT_RELATIONSHIP_RECORD_ID
                             ZERO,ONE,TILDA: * EVENT_RELATIONSHIP_TYPE_CODE
                             TWO,TILDA:      * RELATED_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * RELATED_ENCOUNTER_RECORD_ID
                             ONE             * EVENT_RECORD_ID
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      SERL9999
.
. emergency link
SERL1000  PACK      KEY5,ANSS,SP1,ASRCE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SERL9999
.
          MATCH     "4",TCINDC3
          GOTO      SERL9999 IF NOT EQUAL
.
SERL2000  MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
.
          PACK      KEY16,AURNO,Z70
          CALL      RSEMVIS3
SERL2500  CALL      RPEMVIS3
          BRANCH    OVRCD,SERL9999
.
          MATCH     AURNO,EMVIURNO
          GOTO      SERL9999 IF NOT EQUAL
.
          MATCH     EMVIPADM,DTADMN
          GOTO      SERL2500 IF NOT EQUAL
.
          PACK      KEY8,EMVIADMN,SP70
          SQUEEZE   KEY8
.
          PACK      OBJECTKY,DTADMN,ZERO,THREE,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * EVENT_RECORD_ID
                             ZERO,THREE,TILDA:  * EVENT_RELATIONSHIP_RECORD_ID
                             ZERO,THREE,TILDA:  * EVENT_RELATIONSHIP_TYPE_CODE
                             ONE,TILDA:      * RELATED_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             KEY8,TILDA:     * RELATED_ENCOUNTER_RECORD_ID
                             ONE             * EVENT_RECORD_ID
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
SERL9999  RETURN
+
.******************************************************************************
.*  SELC0000 - Write object type 142- Service Event Location
.*  Requires pattranf/patmi1af record
.*  Requires oldtdate/oldttime
.******************************************************************************
SELC0000  MOVE      "142",OBJECTTY
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
.
          MOVE      OLDTDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      OLDTTIME,PRIOTIMA
.
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MOVE      TDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
          MOVE      TTIME,PRIOTIMB
.
          MOVE      SP70,BEDTYPE1
          MOVE      SP70,BEDTYPE2
          PACK      KEY5,ANSB,ANST,TRBTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,BEDTYPE1
            PACK      BEDTYPE2,PTCDUDF3
          ENDIF
.
. transfer reason 01=Admit 10=Transfer
          MOVE      "01",D2
.
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            PACK      KEY8,DTADMN,SP70
            CALL      RDMISS1
            IF        OVRCD<>1
              MATCH     SP70,ASRCE
              IF        !@EQUAL
                PACK      KEY5,ANSS,SP1,ASRCE,SP70
                CALL      RDCODE1
                IF        OVRCD<>1
                  MATCH    "2",TCINDC3
                  IF       @EQUAL
                    MOVE      "02",D2         * Statistical admission
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     ANSA,TMOVE
          IF        !@EQUAL
            MOVE      "10",D2
          ENDIF
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            PACK      KEY8,DTADMN,SP70
            CALL      RDDSCH1
            IF        OVRCD<>1
              PACK      KEY5,ANSD,ANSD,DDEST,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
.
                MATCH    "S",TCINDC7
                IF       @EQUAL
                  MOVE      "02",D2         * Statistical discharge
                ENDIF
.
                MATCH    "E",TCINDC7
                IF       @EQUAL
                  MOVE      "02",D2         * Statistical discharge
                ENDIF
.
                MATCH    "D",TCINDC1
                IF       @EQUAL
                  MOVE      "19",D2         * Deceased
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          UNPACK    TTIME,XHOUR,D1,XMIN,D1,XSEC
          PACK      KEY20,TWARD,TBED,CYEAR,CMON,CDAY,XHOUR,XMIN,XSEC,SP70
          SQUEEZE   KEY20
.
          SQUEEZE   TBED
.
. * end previous
          MATCH     ANSA,TMOVE
          IF        !@EQUAL
            MOVE      "17 ",CHANGSTM
            MOVE      "142",CHANGOBJ
            MOVE      "17",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,OLDTDATE,OLDTTIME,SP70,SP70  * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PTTRCDAT,SP70
            PACK      SRMDTIME,PTTRCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
          ENDIF
.
          PACK      OBJECTKY,DTADMN,TDATE,TTIME,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * EVENT_RECORD_ID
                             KEY20,TILDA:    * SERVICE_EVENT_LOCATION_RECORD_ID
                             PTCNNSSI,TILDA: * SOURCE_ID
                             PTCNNECI,TILDA: * CAMPUS_LOCAL_ID
                             TWARD,TILDA:    * WARD_LOCAL_ID
                             TBED,TILDA:     * BED_LOCAL_ID
                             D2,TILDA:       * LOCATION_TRANSFER_REASON
                             DIM10B,SP1,PRIOTIMB,TILDA: * START_DATETIME
                             TILDA:          * END_DATETIME
                             BEDTYPE1,TILDA: * BED_TYPE_CODE
                             BEDTYPE2:       * MH_BED_TYPE_CODE
                             SP900  
.
          PACK      SRCRDATE,PTTRCDAT,SP70
          PACK      SRCRTIME,PTTRCTIM,SP70
          PACK      SRMDDATE,PTTRCDAT,SP70
          PACK      SRMDTIME,PTTRCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
SELC9999  RETURN
+
.******************************************************************************
.*  SACT0000 - Loop patecmaf and extract objects 56
.******************************************************************************
SACT0000  MOVE      "56 ",OBJECTTY
          PACK      KEY18,STRTDATE,SP70
          CALL      RSPTECM2
SACT0500  CALL      RKPTECM2
          BRANCH    OVRCD,SACT9999
.
          MATCH     PTEMCDTE,ENDDATE
          GOTO      SACT9999 IF LESS
.
          MOVE      "17 ",DELETSTM          * 17=Admitted Patient
.
          MOVE      "56 ",DELETOBJ          * SERVICE_ACTIVITY
          PACK      DELETKEY,DPTEMADM,SP70
          PACK      DAADMNO,DPTEMADM
          PACK      SRMDDATE,PTEMCDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      GDDL0000
.
          PACK      KEY13,DPTEMADM,SP70
          CALL      RSPTECO1
SACT1000  CALL      RKPTECO1
          BRANCH    OVRCD,SACT0500
.  
          MATCH     DPTEMADM,DPTEOADM
          GOTO      SACT0500 IF NOT EQUAL
.
. *** only send public claim types ****
          PACK      KEY8,DPTEMADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,SACT0500
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SACT0500
.
          MATCH     ANSP,TCINDC1          * extract public
          GOTO      SACT3000 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * extract reciprocal
          GOTO      SACT3000 IF EQUAL
.
          PACK      SRMDDATE,PTEODTCD,SP70
          PACK      SRMDTIME,PTEOTIME,SP70
. commented out for task 0893079
......    CALL      DOAD0000              * Send deletes as not public
          GOTO      SACT0500
.
SACT3000  MOVE      DPTEOADM,DIM8
          SQUEEZE   DIM8
.
          PACK      DIM10A,SP70
          PACK      PRIOTIMA,SP70
          PACK      DIM10B,SP70
          PACK      PRIOTIMB,SP70
.
          MATCH     SP70,PTEODATE
          GOTO      SACT4000 IF EQUAL
.
          MOVE      PTEODATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MATCH     SP70,PTEOSTTM
          IF        @EQUAL
            PACK      DIM10A,SP70
            PACK      PRIOTIMA,SP70
            PACK      DIM10B,SP70
            PACK      PRIOTIMB,SP70
            GOTO      SACT4000
          ELSE
            PACK      PRIOTIMA,PTEOSTTM,COLON,ZERO,ZERO
          ENDIF
.
          MOVE      PTEODATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
          MATCH     SP70,PTEOEDTM
          IF        @EQUAL
            PACK      DIM10A,SP70
            PACK      PRIOTIMA,SP70
            PACK      DIM10B,SP70
            PACK      PRIOTIMB,SP70
            GOTO      SACT4000
          ELSE
            PACK      PRIOTIMB,PTEOEDTM,COLON,ZERO,ZERO
          ENDIF
.
SACT4000  STRIP     DIM10A
          STRIP     DIM10B
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          COMPARE   TEN,PTEOCNT
          IF        @LESS
            PACK      DIM4,ZERO,PTEOCNT,SP70
            SQUEEZE   DIM4
            PACK      DPTEOCNT,DIM4
          ENDIF
          SQUEEZE   DPTEOCNT
          SQUEEZE   DPTEOEPN
          STRIP     PTEOCODE
.
          PACK      KEY8,DPTEOADM,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            PACK      DDATE,ADATE,SP70
          ENDIF
.
          MOVE      "22983",DIM5             * Pre-july 2019  icd 10 ed 10
.
          MATCH     PTCNGDX1,DDATE           * disc.date > icd 10 ed 11
          IF        !@LESS
            MOVE      "33995",DIM5
          ENDIF
.
          MATCH     PTCNGDX2,DDATE           * disc.date > icd 10 ed 12
          IF        !@LESS
            MOVE      "47639",DIM5
          ENDIF
.
          MATCH     PTCNGDX3,DDATE           * disc.date > icd 10 ed 13
          IF        !@LESS
            MOVE      "49763",DIM5
          ENDIF
.
          PACK      KEY30,DPTEOADM,DPTEOEPN,DPTEOCNT,PTEOCODE,SP70
          SQUEEZE   KEY30
.
          MOVE      "56 ",OBJECTTY
          PACK      OBJECTKY,DPTEOADM,DPTEOEPN,DPTEOCNT,PTEOCODE,SP70,SP70
          PACK      OBJECTTX,PTCNNSSI,TILDA: * SOURCE_ID
                             KEY30,TILDA:    * RECORD_ID
                             TWO,TILDA:      * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * ENCOUNTER_RECORD_ID
                             DPTEOEPN,TILDA: * EVENT_RECORD_ID
                             DPTEOCNT,TILDA: * SEQUENCE_NUMBER
                             SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE,TILDA:
.                                            * REF_SOURCE_ID 
                             DIM5,TILDA:     * REF_DOMAIN_ID
                             PTEOCODE,TILDA: * SERVICE_ACTIVITY_CODE
                             ZERO,ONE,TILDA: * SOURCE_CODE
                             ONE,TILDA:      * TYPE_CODE
                             TILDA:          * COMMENTS
                             ONE,TILDA:      * PROVIDER_INDICATOR
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DT
                             DIM10B,SP1,PRIOTIMB,SP900  * END_DT
.
          PACK      SRCRDATE,PTEODTCD,SP70
          PACK      SRCRTIME,PTEOTIME,COLON,ZERO,ZERO,SP70
          PACK      SRMDDATE,PTEODTCD,SP70
          PACK      SRMDTIME,PTEOTIME,COLON,ZERO,ZERO,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          MOVE      "56 ",OBJECTTY
          CALL      WRCOND00     * write record to container detail table
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,SACT1000
.
          MATCH     AADMNO,TADMN
          GOTO      SACT1000 IF NOT EQUAL
.
          CALL      SEAD0000     * write 112 update also
          GOTO      SACT1000
.
SACT9999  RETURN
+
.******************************************************************************
.*  DIAG0000 - Loop patecmaf and extract objects 61 - diagnosis
.******************************************************************************
DIAG0000  MOVE      "61 ",OBJECTTY
          PACK      KEY18,STRTDATE,SP70
          CALL      RSPTECM2
DIAG0500  CALL      RKPTECM2
          BRANCH    OVRCD,DIAG9999
.
          MATCH     PTEMCDTE,ENDDATE
          GOTO      DIAG9999 IF LESS
.
          MOVE      "17 ",DELETSTM          * 17=Admitted Patient
.
          MOVE      "61 ",DELETOBJ          * SERVICE_ACTIVITY
          PACK      DELETKEY,DPTEMADM,SP70
          PACK      DAADMNO,DPTEMADM
          PACK      SRMDDATE,PTEMCDTE,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      GDDL0000
.
          PACK      KEY13,DPTEMADM,SP70
          CALL      RSPTECD1
DIAG1000  CALL      RKPTECD1
          BRANCH    OVRCD,DIAG3500
.
          MATCH     DPTEMADM,DPTEDADM
          GOTO      DIAG3500 IF NOT EQUAL
.
. *** only send public claim types ****
          PACK      KEY8,DPTEMADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,DIAG0500
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DIAG0500
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      DIAG1500 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      DIAG1500 IF EQUAL
.
          PACK      SRMDDATE,PTEDDTCD,SP70
          PACK      SRMDTIME,PTEDTIME,SP70
. commented out for task 0893079
....      CALL      DOAD0000              * Send deletes as not public
          GOTO      DIAG0500
.
DIAG1500  PACK      KEY8,DPTEMADM,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            PACK      DDATE,ADATE,SP70
          ENDIF
.
          MOVE      "22502",D5              * Pre-july 2019
.
          MATCH     PTCNGDX1,DDATE          * disc.date > icd 10 ed 11
          IF        !@LESS
            MOVE      "23856",D5
          ENDIF
.
          MATCH     PTCNGDX2,DDATE          * disc.date > icd 10 ed 12
          IF        !@LESS
            MOVE      "47146",D5
          ENDIF
.
          MATCH     PTCNGDX3,DDATE          * disc.date > icd 10 ed 13
          IF        !@LESS
            MOVE      "49412",D5
          ENDIF
.
          MOVE      DPTEDADM,DIM8
          SQUEEZE   DIM8
.
          MOVE      PTEDDTCD,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      PTEDTIME,PRIOTIMA
.
          PACK      KEY20,DPTEDEPN,DASH,DPTEDCNT,DASH,PTEDCODE,SP70
          SQUEEZE   KEY20
.
          COMPARE   TEN,PTEDCNT
          IF        @LESS
            PACK      DIM4,ZERO,PTEDCNT,SP70
            SQUEEZE   DIM4
            PACK      DPTEDCNT,DIM4
          ENDIF
          SQUEEZE   DPTEDCNT
          STRIP     PTEDCODE
          STRIP     PTEDOSET
.
          PACK      DIM512,SP900
.
          CLEAR     DIM512
          PACK      KEY14,DPTEDADM,ZERO,ZERO,FOUR,SP70
          CALL      RSVSCMT1
DIAG2000  CALL      RKVSCMT1
          BRANCH    OVRCD,DIAG3000
.
          MATCH     DPTEDADM,VSCTVIST
          GOTO      DIAG3000 IF NOT EQUAL
.
          MATCH     "004",VSCTTYPE
          GOTO      DIAG3000 IF NOT EQUAL
.
          MATCH     SP70,VSCTDATA
          GOTO      DIAG3000 IF EQUAL
.
          REP       "~ ",VSCTDATA
          APPEND    VSCTDATA,DIM512
          GOTO      DIAG2000
.
DIAG3000  RESET     DIM512
          STRIP     DIM512
          MOVE      "61 ",OBJECTTY
          PACK      OBJECTKY,DPTEDADM,DPTEDEPN,DPTEDCNT,PTEDCODE,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * EVENT_RECORD_ID
                             ZERO,ONE,TILDA: * DIAGNOSIS_SOURCE_CODE
                             KEY20,TILDA:    * DIAGNOSIS_REC_ID
                             SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE,TILDA:
.                                            * REF_SOURCE_ID
                             D5,TILDA:       * REF_DOMAIN_ID
                             PTEDCODE,TILDA: * SERVICE_ACTIVITY_CODE
                             DPTEDCNT,TILDA: * SEQUENCE_NUMBER
                             ONE,TILDA:          * STATUS_CODE
                             PTEDDTCD,TILDA: * START_DT
                             PTEDOSET,TILDA: * ONSET_TYPE_CODE
                             DIM512,SP900    * DIAGNOSIS_COMMENTS
.
          PACK      SRCRDATE,PTEDDTCD,SP70
          PACK      SRCRTIME,PTEDTIME,COLON,ZERO,ZERO,SP70
          PACK      SRMDDATE,PTEDDTCD,SP70
          PACK      SRMDTIME,PTEDTIME,COLON,ZERO,ZERO,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      DIAG1000
.
DIAG3500  PACK      KEY8,DPTEMADM,SP70
          CALL      RDMISS1               * Reread admission 
          BRANCH    OVRCD,DIAG3600
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DIAG3600
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      DIAG3550 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      DIAG3600 IF NOT EQUAL
.
DIAG3550  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,DIAG3600
.
          MATCH     AADMNO,TADMN
          GOTO      DIAG3600 IF NOT EQUAL
.
          MOVE      ONE,SENDALT
          PACK      PMAWCDAT,PTEMCDTE,SP70
          PACK      PMAWCTIM,TIME059,SP70

          CALL      SEAD0000     * write 112 update also
.
DIAG3600  GOTO      DIAG0500     

DIAG9999  RETURN
+
.******************************************************************************
.*  CANC0000 - Loop patcrdaf and extract object 114 - cancer    
.******************************************************************************
CANC0000  PACK      KEY41,STRTDATE,SP70         *new records
          CALL      RSPTCRD3
CANC0500  CALL      RKPTCRD3
          BRANCH    OVRCD,CANC1000
.
          MATCH     PTCDDTRC,ENDDATE
          GOTO      CANC1000 IF LESS
.
          PACK      KEY8,DPTCDDAD,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,CANC0500
.
          PACK      KEY8,DPTCDDAD,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CANC0500
.
. *** only send public claim types ****
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANC0500
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      CANC0800 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      CANC0800 IF EQUAL
.
          PACK      SRMDDATE,PTCDDTRC,SP70
          PACK      SRMDTIME,PTCDTMCR,SP70
. commented out for task 0893079
...       CALL      DOAD0000              * Send deletes as not public
          GOTO      CANC0500
.
CANC0800  CALL      WRCNC000
          GOTO      CANC0500
.
. * loop updated records
CANC1000  PACK      KEY41,STRTDATE,SP70
          CALL      RSPTCRD4
CANC1500  CALL      RKPTCRD4
          BRANCH    OVRCD,CANC3000
.
          MATCH     PTCDDTUP,ENDDATE
          GOTO      CANC3000 IF LESS
.
          PACK      KEY8,DPTCDDAD,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,CANC1500
.
          PACK      KEY8,DPTCDDAD,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CANC1500
.
. *** only send public claim types ****
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANC1500
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      CANC2000 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      CANC2000 IF EQUAL
.
          PACK      SRMDDATE,PTCDDTUP,SP70
          PACK      SRMDTIME,PTCDTMUP,SP70
. commented out for task 0893079
...       CALL      DOAD0000              * Send deletes as not public
          GOTO      CANC1500
.
CANC2000  MOVE      ONE,SENDALT
          PACK      PMAWCDAT,PTCDDTUP,SP70
          PACK      PMAWCTIM,PTCDTMUP,SP70
          CALL      WRCNC000
          GOTO      CANC1500
.
. * loop deleted records
CANC3000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
CANC3500  CALL      RKPMADW1
          BRANCH    OVRCD,CANC9999
.
          MATCH     PMAWCDAT,ENDDATE        * After extract end date
          GOTO      CANC9999 IF LESS
.
          MATCH     "21",PMAWTYPE
          GOTO      CANC3500 IF NOT EQUAL
.
          MOVE      "17 ",DELETSTM          * 17=Inpatient
          MOVE      "114",DELETOBJ          * Cancer
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
          PACK      DELETKEY,PMAWVISN,PMAWOLDV,SP70   * Delete Key
          CALL      EDDK0000
.
          GOTO      CANC3500
.
CANC9999  RETURN
+
.******************************************************************************
.*  EDUNL000 - write ED visit unlinked 
.******************************************************************************
. * loop deleted records
EDUNL000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
EDUNL500  CALL      RKPMADW1
          BRANCH    OVRCD,EDUNL999
.
          MATCH     PMAWCDAT,ENDDATE        * After extract end date
          GOTO      EDUNL999 IF LESS
.
          MATCH     "22",PMAWTYPE
          GOTO      EDUNL500 IF NOT EQUAL
.
          MOVE      "17 ",DELETSTM          * 17=Inpatient
          MOVE      "131",DELETOBJ          * Relationship
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
          PACK      DELETKEY,PMAWVISN,SP70   * Delete Key
          CALL      EDDK0000
.
          GOTO      EDUNL500
.
EDUNL999  RETURN
+
.******************************************************************************
.*  WRCNC000 - write cancer object 114 
.******************************************************************************
WRCNC000  MOVE      "114 ",OBJECTTY
          MOVE      DPTCDDAD,DIM8
          SQUEEZE   DIM8
.
          MOVE      SP70,PMPXRHC1
          PACK      KEY8,PVIURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WRCNC999
          CALL      RDPMPX21
          BRANCH    OVRCD,WRCNC999
          STRIP     PMPXRHC1
.
          MOVE      PTCDDDTE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          PACK      D2,NINE,NINE
          MATCH     "NSW",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,ONE,SP70
          ENDIF
.
          MATCH     "VIC",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,TWO,SP70
          ENDIF
.
          MATCH     "QLD",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,THREE,SP70
          ENDIF
.
          MATCH     "SA",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,FOUR,SP70
          ENDIF
.
          MATCH     "WA",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,FIVE,SP70
          ENDIF
.
          MATCH     "TAS",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,SIX,SP70
          ENDIF
.
          MATCH     "NT",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,SEVEN,SP70
          ENDIF
.
          MATCH     "ACT",PTCDSTTE
          IF        @EQUAL
            PACK      D2,ZERO,EIGHT,SP70
          ENDIF
.
          MATCH     "NFA",PTCDSTTE
          IF        @EQUAL
            PACK      D2,NINE,EIGHT,SP70
          ENDIF
.
          MATCH     "NFD",PTCDSTTE
          IF        @EQUAL
            PACK      D2,NINE,NINE,SP70
          ENDIF
.
          MOVE      SP70,CANLATER
          PACK      KEY5,ANSL,ANSY,PTCDLATR,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      THCSCOD,CANLATER
          ENDIF
          STRIP     CANLATER
.
          MOVE      SP70,CANBESTB
          PACK      KEY5,ANSB,LOWD,PTCDBDIA,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      THCSCOD,CANBESTB
          ENDIF
          STRIP     CANBESTB
.
          MOVE      ANSN,INSCLFLG
          COMPARE   ONE,PTCDAUTP
          IF        @EQUAL
            MOVE      ANSY,INSCLFLG
          ENDIF
.
          MOVE      SP70,DIM20
          UNPACK    PTCDOTDG,DIM20
          STRIP     DIM20
.
          MOVE      SP70,D8
          MATCH     SP70,DIM20
          IF        !@EQUAL & !@EOS
            PACK      DIM3,ONE,ZERO,ZERO
            PACK      D8,CANCSID,SP70
          ENDIF
          STRIP     DIM3
          STRIP     D8
          STRIP     PTCDPRMM
          STRIP     PTCDHTYP
          STRIP     PTCDSTTE
          STRIP     PTCDCELT
          STRIP     PTCDCSGT
          STRIP     PTCDCSGN
          STRIP     PTCDCSGM
          STRIP     INSCLFLG
.
          PACK      OBJECTKY,DPTCDDAD,PTCDPRMM,DPTCDCNR,SP70,SP70
.
          MOVE      "22502",DIM5               * Pre-july 2025
.
          PACK      KEY8,DPTCDDAD,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            PACK      DDATE,ADATE,SP70
          ENDIF
.
          MATCH     PTCNGDX3,DDATE           * disc.date > icd 10 ed 13
          IF        !@LESS
            MOVE      "49412",DIM5
          ENDIF
.
          SQUEEZE   DPTCDDAD
          SQUEEZE   PTCDPRMM
          SQUEEZE   DPTCDCNR
.
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * RECORD_ID
                             ONE,TILDA:      * EVENT_RECORD_ID
                             DPTCDDAD,DASH,DPTCDCNR,TILDA:* CANCER_RECORD_ID
                             PTCDPRMM,TILDA: * EVENT_RECORD_ID
                             SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE,TILDA: 
.                                            * CANCER_MORPH_REF_SOURCE_ID
                             DIM5,TILDA:     * CANCER_MORPH_REF_DOMAIN_ID
                             PTCDHTYP,TILDA: * CANCER_MORPH_CODE
                             SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE,TILDA: 
.                                            * CANCER_TOPO_REF_SOURCE_ID
                             DIM5,TILDA:     * CANCER_TOPO_REF_DOMAIN_ID
                             PTCDPRMM,TILDA: * CANCER_TOPO_CODE
                             PTCDDDTE,TILDA: * FIRST_DIAG_DATE
                             CANLATER,TILDA: * CANCER_LATERALITY_CODE
                             CANBESTB,TILDA: * CANCER_BEST_BASIS_CODE
                             D2,TILDA:       * CANCER_FIRST_DIAG_STATE_RES_CODE
                             PTCDCELT,TILDA: * CANCER_DEGREE_OF_SPREAD_CODE   
                             TILDA:          * CANCER_WITH_MULTIPLE_PRIMARY   
                             DIM3,TILDA:     * PATH_LAB_OSP_ID_TYPE_CODE   
                             D8,TILDA:       * LAB_OSP_SOURCE_ID
                             DIM20,TILDA:    * PATH_LAB_OSP_ID 
                             TILDA:          * STAGE_SCHEME_CODE
                             TILDA:          * CANCER_STAGE_CODE
                             PTCDCSGT,TILDA: * T_STAGE_SCORE
                             PTCDCSGN,TILDA: * N_STAGE_SCORE
                             PTCDCSGM,TILDA: * M_STAGE_SCORE
                             TILDA:          * INT_TREATMENT_MODE_CODE
                             TILDA:          * INT_RADIOTHERAPY_EVIQ_ID
                             TILDA:          * INT_SYS_THERAPY_EVIQ_ID
                             INSCLFLG,TILDA: * INCID_FIND_AT_PM_FLAG
                             PMPXRHC1        * GP_RECORD_ID
.
          PACK      SRCRDATE,PTCDDTRC,SP70
          PACK      SRCRTIME,PTCDTMCR,SP70
          PACK      SRMDDATE,PTCDDTRC,SP70
          PACK      SRMDTIME,PTCDTMCR,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
WRCNC999  RETURN
+
.******************************************************************************
.*  WRGP0000 - write Service Event General Practitioner - 115
.******************************************************************************
WRGP0000  MOVE      "115",OBJECTTY
          MOVE      DTADMN,DIM8
          MATCH     SP70,DIM8
          GOTO      WRGP9999 IF EQUAL
          SQUEEZE   DIM8
.
          MOVE      SP70,PMPXRHC1
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WRGP9999
          CALL      RDPMPX21
          BRANCH    OVRCD,WRGP9999
.
          MATCH     SP70,PMPXRHC1
          IF        @EQUAL
            MATCH     SP70,PMPXRH1G
            GOTO      WRGP9999 IF EQUAL
          ENDIF
.
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP
          ENDIF
.
          PACK      KEY12,PMPXRH1G,PMPXR1GC,SP70
          CALL      RDPMHCG1
          IF        OVRCD=1
            CALL      CLPMSHCG
            MOVE      PMHCADR1,PMHGADD1
            MOVE      PMHCADR2,PMHGADD2
            MOVE      PMHCADR3,PMHGADD3
            MOVE      PMHCADR4,PMHGADD4
            MOVE      PMHCPOST,PMHGPOST
            MOVE      PMHCFAXN,PMHGPFAX
            MOVE      PMHCSTEL,PMHGPTEL
          ENDIF
.
          PACK      KEY20,PMPXRHC1,PMPXRH1G,SP70
          CALL      RDPMHCL1
          IF        OVRCD=1
            CALL      CLPMSHCL
            MOVE      PMHCPRV5,PMHLPRV5
          ENDIF
.
.
          MATCH     SP70,PMHCHCPC
          IF        @EQUAL
            MATCH     SP70,PMHGPRAC
            GOTO      EDCC9999 IF EQUAL
          ENDIF
.
          MATCH     SP70,PMHCHCPC           * Invalid or no HCP code
          IF        @EQUAL
            MOVE      PMHGPRAC,PMPXRHC1     * Send practice when no HCP
            MOVE      PMHGPNAM,PACFNAME     * recorded
          ELSE
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
          ENDIF
.
          STRIP     PACFNAME
.
          STRIP     PMHLPRV5
.
          STRIP     PMHGADD1
          STRIP     PMHGADD2
          STRIP     PMHGADD3
          STRIP     PMHGADD4
          STRIP     PMHGADD5
          STRIP     PMHCHAD6
          STRIP     PMHGPOST
          STRIP     PMHGPTEL
          STRIP     PMHGPFAX
          STRIP     PMPXRHC1
.
          PACK      OBJECTKY,DTADMN,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             PMPXRHC1,TILDA: * SERVICE_EVENT_GP_RECORD_ID
                             ZERO,THREE,FIVE,TILDA: * GP_ISP_ID_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             PMPXRHC1,TILDA: * GP_ISP_ID
                             PACFNAME,TILDA: * GP_FULL_NAME
                             TILDA:          * OSP_ID_TYPE_CODE
                             TILDA:          * OSP_SOURCE_ID
                             TILDA:          * PRACTICE_OSP_ID
                             PMHGADD1,SP1,PMHGADD2,TILDA: * GP_PRACTICE_ADDRESS
                             PMHGADD3,TILDA: * GP_PRACTICE_SUBURB 
                             PMHGPOST,TILDA: * GP_PRACTICE_POSTCODE
                             PMHGADD4,TILDA: * GP_PRACTICE_STATE
                             ONE,ONE,ZERO,ONE,TILDA: * GP_PRACTICE_COUNTRY
                             PMHGPFAX,TILDA: * GP_PRACTICE_FAX_NUMBER
                             PMHGPTEL,SP900  * GP_PRACTICE_PHONE_NUMBER
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
          PACK      SRMDDATE,PMVXCDTE,SP70
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
WRGP9999  RETURN
+
.******************************************************************************
.*  LEAV0000 - write Service Event Leave - 133
.******************************************************************************
LEAV0000  MOVE      "133",OBJECTTY
          MOVE      DTADMN,DIM8
          SQUEEZE   DIM8
.
          MOVE      SP70,DIM1
          MOVE      SP70,D1
          PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      DIM1,TCINDC1
            PACK      D2,THCSCOD
          ENDIF
          STRIP     DIM1
          STRIP     D2
.
          MOVE      SP70,DIM10A
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMA
          MOVE      SP70,PRIOTIMB
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      TTIME,PRIOTIMA
          ENDIF
.
          MATCH     ANSR,TMOVE
          IF        @EQUAL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
          ENDIF
.
          STRIP     DIM10A
          STRIP     DIM10B
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          UNPACK    TTIME,XHOUR,KEY1,XMIN
          PACK      KEY11,CYEAR,CMON,CDAY,XHOUR,XMIN
.
          STRIP     D2
          STRIP     DIM1
          PACK      OBJECTKY,DTADMN,TDATE,TTIME,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             KEY11,TILDA:    * LEAVE_RECORD_ID
                             DIM1,TILDA:     * LEAVE_TYPE_CODE
                             TILDA:          * LEAVE_TYPE_LOCAL_CODE
                             D2,TILDA:       * LEAVE_REASON_CODE
                             TILDA:          * LEAVE_REASON_LOCAL_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA:  * LEAVE_START_DATE 
                             DIM10B,SP1,PRIOTIMB:  * LEAVE_END_DATE 
                             SP900
.
          PACK      SRCRDATE,TDATE,SP70
          PACK      SRCRTIME,TTIME,COLON,ZERO,ZERO,SP70
          PACK      SRMDDATE,TDATE,SP70
          PACK      SRMDTIME,TTIME,COLON,ZERO,ZERO,SP70
.
          MATCH     "1",SENDALT
          IF        @EQUAL
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
LEAV9999  RETURN
+
.******************************************************************************
.*  RETU0000 - write Service Event Leave/Return - 133
.******************************************************************************
RETU0000  MOVE      SP70,LVFRDATE           * Clear save leave from date
          MOVE      SP70,LVFRTIME           * Clear save leave from time
          MOVE      TADMN,SVVKEY8
          PACK      SVVKEY30,DTADMN,TDATE,TTIME,TWARD,TBED,SP70
          PROC      GETLFROM           * Get leave from date and time
.
          MOVE      "17 ",CHANGSTM                     * 17=Admitted Patient
          MOVE      "133",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "16",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * Change old value
          MOVE      TDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          PACK      CHANGNVL,DIM10A,SP1,TTIME,SP70      * Change new value
          PACK      CHANGKEY,DTADMN,LVFRDATE,LVFRTIME,SP70,SP70  * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
RETU9999  RETURN
+
.*****************************************************************************
.* Get the leave from date and time for the cuurect return from leave record
.* Returns leave from date and time in LVFRDATE and LVFRTIME
.*****************************************************************************
          DEFPROC   GETLFROM
.
          INC       PATTRNFD/INC
.
          OPEN      PATTRAN2,"pattranf"
.
          MOVE      SP70,LVFRDATE           * Clear save leave from date
          MOVE      SP70,LVFRTIME           * Clear save leave from time
.
          PACK      KEY30,SVVKEY30,SP70
          CALL      RDTRAN2                 * Return from leave record
          BRANCH    OVRCD,GETLFR99          * to get on leave record
.
          CALL      RDPTRAN2                * Read previous tran record
          BRANCH    OVRCD,GETLFR99          * to get on leave record

          MATCH     SVVKEY8,DTADMN          * Correct visit number
          GOTO      GETLFR99 IF NOT EQUAL
.
          MATCH     "L",TMOVE               * On leave record
          GOTO      GETLFR99 IF NOT EQUAL
.
          MOVE      TDATE,LVFRDATE          * Clear save leave from date
          MOVE      TTIME,LVFRTIME          * Clear save leave from time
.
          GOTO      GETLFR99
.
          INC       PATTRNIO/INC
          INC       IBAOVRIO/INC
.
GETLFR99  CLOSE     PATTRAN2
.
          ENDPROC
+
.******************************************************************************
.*  DELY0000 - Loop patatraf type=24 and extract object 137 - service event 
.*             delay if required
.******************************************************************************
DELY0000  MOVE      "137",OBJECTTY
          PACK      KEY35,AURNO,DAADMNO,ZERO,TWO,FOUR,Z70
          CALL      RSPTATR3
DELY1000  CALL      RPPTATR3
          BRANCH    OVRCD,DELY9999
.
          MATCH     AURNO,PTARURNO
          GOTO      DELY9999 IF NOT EQUAL
.
          MATCH     DAADMNO,PTARVISN
          GOTO      DELY9999 IF NOT EQUAL
.
          MATCH     "024",PTARTYPE
          GOTO      DELY9999 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      DELY1000 IF EQUAL
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,DELY9999
.
          MATCH     "3",DASTAT
          GOTO      DELY9999 IF NOT EQUAL
.
. *** only send public claim types ****
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DELY9999
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      DELY2000 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      DELY2000 IF EQUAL
.
          PACK      SRMDDATE,PTUNDATE,SP70
          PACK      SRMDTIME,PTUNTIME,SP70
          CALL      DOAD0000              * Send deletes as not public
          GOTO      DELY1000
.
DELY2000  
          PACK      KEY5,ANSZ,ANSS,PTARCOD1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSD,TCINDC1
            GOTO      DELY9999 IF NOT EQUAL
            MOVE      PTCDUDF3,DIM10
          ENDIF
.
          PACK      OBJECTKY,DAADMNO,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DAADMNO,TILDA:  * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             PTARCOD1,PTARDATE,TILDA: * DELAY_RECORD_ID
                             ZERO,ONE,TILDA: * DELAY_TYPE_CODE
                             DIM10,TILDA:    * DELAY_REASON_CODE
                             PTARTXT1,SP900  * DELAY_COMMENTS
.
          PACK      SRCRDATE,PTARCDTE,SP70
          PACK      SRCRTIME,PTARCTME,SP70
          PACK      SRMDDATE,PTARCDTE,SP70
          PACK      SRMDTIME,PTARCTME,SP70
          MATCH     SP70,PTARUDTE
          IF        !@EQUAL
            PACK      SRMDDATE,PTARUDTE,SP70
            PACK      SRMDTIME,PTARUTME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
DELY9999  RETURN
+
.******************************************************************************
.*  LUNA0000 - Loop patunaaf and extract objects
.******************************************************************************
LUNA0000  MOVE      ONE,SENDALT
          PACK      KEY25,STRTDATE,SP70
          CALL      RDSUNAA3
LUNA0500  CALL      RDKUNAA3
          BRANCH    OVRCD,LUNA9999
.
          MATCH     PTUNDATE,ENDDATE
          GOTO      LUNA9999 IF LESS
.
          MATCH     "3",PTUNTYPE         * changed admission date
          GOTO      LUNA1000 IF EQUAL
.
          MATCH     "4",PTUNTYPE         * changed discharge date
          GOTO      LUNA0500 IF NOT EQUAL
.
LUNA1000  MOVE      DPTUNADM,DIM8
          SQUEEZE   DIM8
.
          PACK      PMAWCDAT,PTUNDATE,SP70
          PACK      PMAWCTIM,PTUNTIME,SP70
.
          PACK      KEY8,DPTUNADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,LUNA0500
.
          MATCH     "5",DASTAT
          GOTO      LUNA0500 IF EQUAL
.
          PACK      KEY8,DPTUNADM,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            MOVE      SP70,DDATE
            MOVE      SP70,DTIME
          ENDIF
.
. *** only send public claim types ****
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LUNA0500
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      LUNA1100 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      LUNA1100 IF EQUAL
          GOTO      LUNA0500
.
LUNA1100  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LUNA0500
.
          MATCH     AADMNO,TADMN
          GOTO      LUNA0500 IF NOT EQUAL
.
. **** resend objects for this visit ***
          CALL      WR590000              * presenting issue
. * send financial class attribute *
          MOVE      "01",ATTRTYPE
          MOVE      SP70,ATTRVALU
          MOVE      ADATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      ATIME,PRIOTIMA
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MOVE      DDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      DTIME,PRIOTIMB
         ENDIF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LUNA1200
.
          MOVE      PTCDUDF3,ATTRVALU
.
          MATCH     ANSP,TCINDC1          * Public - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
               MATCH    "5",TCINDC9   * public/qualified
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
               MATCH    "1",TCINDC9   * public/qualified
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
               COMPARE  "13",TCFORM6
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
             ENDIF
          ENDIF
          MATCH     "11",PTCDNHCP         * reciprocal - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
            ENDIF
          ENDIF
.
          CALL      WR600000     * write object type 60 record
.
. * send admitted patient election code attribute *
LUNA1200  MOVE      "03",ATTRTYPE
          MOVE      SP70,ATTRVALU
.
          MOVE      "1",ATTRVALU
          CALL      WR600000     * write object type 60 record
.
. * send legal status attribute *
....      MOVE      "09",ATTRTYPE
....      MOVE      SP70,ATTRVALU
....
....      MATCH     SP70,PMVXMHLS
....      IF        !@EQUAL
....        PACK      KEY5,ANSL,ANSS,PMVXMHLS,SP70
....        CALL      RDCODE1
....        IF        OVRCD<>1
....          MOVE      PTCDUDF4,ATTRVALU
....          CALL      WR600000     * write object type 60 record
....        ENDIF
....      ENDIF
.
          CALL      SEAD0000            
          MATCH     "3",PTUNTYPE         * changed admission date
          IF        @EQUAL
            PACK      OLDTDATE,TDATE * save date
            PACK      OLDTTIME,TTIME * save time
            CALL      SELC0000             * object 142
          ENDIF
.
          MATCH     "4",PTUNTYPE         * changed discharge date
          IF        @EQUAL
            PACK      KEY30,AADMNO,SP70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,LUNA0500
.
            MATCH     AADMNO,TADMN
            GOTO      LUNA0500 IF NOT EQUAL
            PACK      OLDTDATE,TDATE * save date
            PACK      OLDTTIME,TTIME * save time
            CALL      SELC0000             * object 142
          ENDIF
.
LUNA2000  GOTO      LUNA0500
.
LUNA9999  MOVE      ZERO,SENDALT
          RETURN
+
.******************************************************************************
.* ADEL0000 - Loop extract and delete all records
.******************************************************************************
ADEL0000  PACK      KEY25,STRTDATE,SP70
          CALL      RDSUNAA3
ADEL1000  CALL      RDKUNAA3
          BRANCH    OVRCD,ADEL9999
.
          MATCH     PTUNDATE,ENDDATE        * After extract end date
          GOTO      ADEL9999 IF LESS
.
          PACK      KEY8,DPTUNADM,SP70
          CALL      RDMISS1                 * Get visit details 
          BRANCH    EXIT,ADEL1000
.
. *** only send public claim types ****
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADEL1000  
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      ADEL1100 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      ADEL1100 IF EQUAL
.
          PACK      SRMDDATE,PTUNDATE,SP70
          PACK      SRMDTIME,PTUNTIME,SP70
          CALL      DOAD0000              * Send deletes as not public
          GOTO      ADEL1000
.
ADEL1100  MATCH     "2",PTUNTYPE            * undischarge?
          IF        @EQUAL
            MATCH     "3",DASTAT            * see if still undischarged
            GOTO      ADEL1000 IF EQUAL
            MATCH     "5",DASTAT            * if unadmitted, ignore undischarge
            GOTO      ADEL1000 IF EQUAL
            CALL      UNDIS000
            GOTO      ADEL1000
          ENDIF
.
          MATCH     "1",PTUNTYPE            * unadmit?
          GOTO      ADEL1000 IF NOT EQUAL
.
          PACK      SRMDDATE,PTUNDATE,SP70
          PACK      SRMDTIME,PTUNTIME,SP70
          CALL      DOAD0000
.
          GOTO      ADEL1000
.
ADEL9999  RETURN
+
.******************************************************************************
.* LALT0000 - Loop claim type alterations and either resend or send deletes
.******************************************************************************
LALT0000  MOVE      "1",SENDALT
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
LALT1000  CALL      RKPMADW1
          BRANCH    OVRCD,LALT9999
.
          MATCH     PMAWCDAT,ENDDATE        * After extract end date
          GOTO      LALT9999 IF LESS
.
          MATCH     "11",PMAWTYPE
          GOTO      LALT1000 IF NOT EQUAL
.
LALT1100  PACK      KEY8,PMAWVISN,SP70
          CALL      RDMISS1                 * Get visit details
          BRANCH    EXIT,LALT1000
.
          MOVE      "17 ",DELETSTM          * 17=Admitted Patient
.
          MOVE      "133",DELETOBJ          * SERVICE_ACTIVITY
          PACK      DAADMNO,PMAWVISN
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      ADDL0000
.
          MOVE      "17 ",DELETSTM          * 17=Admitted Patient
.
          MOVE      "63",DELETOBJ          * SERVICE_PROVIDER
          PACK      DAADMNO,PMAWVISN
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      ADDL0000
.

. *** only send public claim types ****
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LALT1000
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      LALT1200 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      LALT1200 IF EQUAL
.
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
          CALL      DOAD0000              * Send deletes as not public
          GOTO      LALT1000
.
. **** resend all objects for this visit ***
. **** loop all tran records and send object ***
LALT1200  PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
LALT1500  CALL      RDKTRAN2
          BRANCH    OVRCD,LALT1000
.
          MATCH     AADMNO,TADMN
          GOTO      LALT1000 IF NOT EQUAL
.
          CALL      PROT0000         * process this transfer record
.
          GOTO      LALT1500
.
LALT9999  MOVE      ZERO,SENDALT
          RETURN
+
.******************************************************************************
.* LVAL0000 - Loop visit alterations
.******************************************************************************
LVAL0000  MOVE      "1",SENDALT
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
LVAL1000  CALL      RKPMADW1
          BRANCH    OVRCD,LALT9999
.
          MATCH     PMAWCDAT,ENDDATE        * After extract end date
          GOTO      LVAL9999 IF LESS
.
          MATCH     "14",PMAWTYPE
          GOTO      LVAL1500 IF EQUAL
.
          MATCH     "15",PMAWTYPE
          GOTO      LVAL1500 IF EQUAL
.
          MATCH     "16",PMAWTYPE
          GOTO      LVAL1500 IF EQUAL
.
          MATCH     "17",PMAWTYPE
          GOTO      LVAL1000 IF NOT EQUAL
.
LVAL1500  PACK      KEY8,PMAWVISN,SP70
          CALL      RDMISS1                 * Get visit details
          BRANCH    EXIT,LVAL1000
.
. *** only send public claim types ****
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LVAL1000
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      LVAL1600 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      LVAL1600 IF EQUAL
.
          GOTO      LVAL1000    * not public, ignore
.
LVAL1600  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LVAL1000
.
          MATCH     AADMNO,TADMN
          GOTO      LVAL1000 IF NOT EQUAL
.
. **** resend objects for this visit ***
          MATCH     "14",PMAWTYPE
          GOTO      LVAL2000 IF EQUAL
.
          GOTO      LVAL3000
.
LVAL2000  CALL      HS720000              * Admission source/att doct
          CALL      WR590000              * Admission updated
.
. Update admission trigger 14 reports financial class Obj 60 attribute 01
. later in the extract at UCAR0000
.
. * send admitted patient election code Obj 60 attribute 03
.
LVAL2100  MOVE      "03",ATTRTYPE
          MOVE      "1",ATTRVALU
          CALL      WR600000     * write object type 60 record
.
. * send legal status attribute code Obj 60 attribute 09
.
          CALL      MHGG0000
.
          PACK      KEY30,AADMNO,Z70    * Restore transfer record in context
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LVAL1000
.
          MATCH     AADMNO,TADMN
          GOTO      LVAL1000 IF NOT EQUAL
.
          CALL      SEAD0000            
          CALL      SETR0000            
.
LVAL3000  MATCH     "15",PMAWTYPE       * ambulance id updated
          IF        @EQUAL
            CALL      SEAD0000            
          ENDIF
.
          MATCH     "16",PMAWTYPE        * discharge updated
          IF        @EQUAL
            CALL      SEAD0000            
            MOVE      ANSD,OBJECTRT
            MOVE      "17 ",DELETSTM          * 17=Inpatient
            MOVE      "130",DELETOBJ
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
            PACK      DELETKEY,PMAWVISN,TWO,SP70
            CALL      EDDK0000
            CALL      SETR0000
          ENDIF
.
          MATCH     "17",PMAWTYPE
          IF        @EQUAL
            PACK      KEY25,PMAWVISN,SP70
            CALL      RSPTCRD1
            CALL      RKPTCRD1
            BRANCH    OVRCD,LVAL1000
.
            MATCH     DPTCDDAD,PMAWVISN
            GOTO      LVAL1000 IF NOT EQUAL
.
            MOVE      ONE,SENDALT
            CALL      WRCNC000
            MOVE      ZERO,SENDALT
          ENDIF
.
          GOTO      LVAL1000
.
LVAL9999  MOVE      ZERO,SENDALT
          RETURN
+
.******************************************************************************
.* LCHC0000 - Loop care type changes
.******************************************************************************
LCHC0000  MOVE      "1",SENDALT
          PACK      KEY40,STRTDATE,SP70
          CALL      RDSCHCO3
LCHC1000  CALL      RDKCHCO3
          BRANCH    OVRCD,LCHC9999
.
          MATCH     CHCRDATE,ENDDATE        * After extract end date
          GOTO      LCHC9999 IF LESS
.
          PACK      KEY8,DCHADMN,SP70
          CALL      RDMISS1                 * Get visit details
          BRANCH    EXIT,LCHC1000
.
. *** only send public claim types ****
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LCHC1000
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      LCHC1600 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      LCHC1600 IF EQUAL
.
          GOTO      LCHC1000    * not public, ignore
.
LCHC1600  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LCHC1000
.
          MATCH     AADMNO,TADMN
          GOTO      LCHC1000 IF NOT EQUAL
.
          CALL      SEAD0000
.
          CALL      ESQU0000
.
          GOTO      LCHC1000
.
LCHC9999  MOVE      ZERO,SENDALT
          RETURN
+
.******************************************************************************
.* End/Start qualification changes
.******************************************************************************
ESQU0000  PACK      NEWCODE,SP70
          MOVE      ZERO,F1 * 0=not newborn
          PACK      KEY5,ANSC,ANSC,CHCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ESQU9999
.
. * only update if  qualified/unqualified old code was qual/unqual OR new
          MATCH     "5",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
          MATCH     "1",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
. * get the new care type (either next record on patchcof or current acare)
ESQU0100  PACK      SAVKEY24,DCHADMN,CHDATE,CHTIME,SP70
          PACK      KEY24,DCHADMN,CHDATE,CHTIME,SP70
          CALL      RDCHCO1
ESQU0200  CALL      RDKCHCO1
          BRANCH    OVRCD,ESQU0500
.
          MATCH     DCHADMN,DAADMNO
          GOTO      ESQU0500 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      ESQU0200 IF NOT EQUAL
.
          PACK      NEWCODE,CHCODE,SP70
          GOTO      ESQU1000
.
ESQU0500  PACK      NEWCODE,ACARE,SP70
.
ESQU1000  PACK      KEY5,ANSC,ANSC,NEWCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ESQU9999
.
. * only update if  qualified/unqualified old code was qual/unqual OR new
          MATCH     "5",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
          MATCH     "1",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
. ** if old or new care type are not qual/unqual, don't send
          COMPARE   ONE,F1
          GOTO      ESQU9999 IF NOT EQUAL
.
          PACK      KEY24,SAVKEY24
          CALL      RDCHCO1
          BRANCH    OVRCD,ESQU9999
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ESQU9999
.
          MATCH     ANSP,TCINDC1          * Public - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,NEWCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC3,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC3,ATTRVALU
              ENDIF
.
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.             IF       @EQUAL
.               MOVE     "MW",ATTRVALU
.             ENDIF
            ENDIF
          ENDIF
          MATCH     "11",PTCDNHCP         * reciprocal - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,NEWCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.             IF       @EQUAL
.               MOVE     "RW",ATTRVALU
.             ENDIF
            ENDIF
          ENDIF
.
          MOVE      "01",ATTRTYPE
          MOVE      CHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      CHTIME,PRIOTIMA
.
. * end last obj 60 attr 01
          MOVE      "17 ",CHANGSTM                     * 17=Admitted
          MOVE      "60 ",CHANGOBJ
          MOVE      "15",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new value
          PACK      CHANGKEY,DTADMN,ATTRTYPE,SP70,SP70 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          PACK      SRMDDATE,CHCRDATE,SP70
          PACK      SRMDTIME,CHCRTIME,SP70
          CALL      LSOF0000           * Change sent stream object field
.
. * start new obj 60 attr 01
          CALL      CLPATDSC
          MATCH     "3",DASTAT
          IF        @EQUAL
            PACK      KEY8,DAADMNO,SP70
            CALL      RDDSCH1
            IF        OVRCD=1
              CALL      CLPATDSC
            ENDIF
          ENDIF
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MOVE      DDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      DTIME,PRIOTIMB
          ENDIF
.
          PACK      KEY20,ATTRTYPE,CHDATE,CHTIME,ATTRVALU,SP70
          STRIP     KEY20
          PACK      OBJECTKY,DTADMN,ATTRTYPE,CHCRDATE,CHCRTIME,SP70,SP70
          PACK      DIM8,DTADMN
          SQUEEZE   DIM8
          STRIP     ATTRVALU
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             KEY20,TILDA: * ATTRIBUTE_RECORD_ID
                             ATTRTYPE,TILDA: * ATTRIBUTE_TYPE_CODE
                             TILDA:          * ATTRIBUTE_LOCAL_CODE
                             ATTRVALU,TILDA: * ATTRIBUTE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB,SP900  * END_DATETIME
.
          PACK      SRCRDATE,CHCRDATE,SP70
          PACK      SRCRTIME,CHCRTIME,SP70
          PACK      SRMDDATE,CHCRDATE,SP70
          PACK      SRMDTIME,CHCRTIME,SP70
.
          CALL      WRCOND00     * write record to container detail table
.
ESQU9999  RETURN
+
.******************************************************************************
.* DOAD0000 - Delete all objects send for an admission
.******************************************************************************
DOAD0000  MOVE      "17 ",DELETSTM          * 17=Admitted Patient
.
          MOVE      "56 ",DELETOBJ          * SERVICE_ACTIVITY
          CALL      ADDL0000
.
          MOVE      "57 ",DELETOBJ          * SERVICE_EVENT
          CALL      ADDL0000
.
          MOVE      "59 ",DELETOBJ          * PRESENTING_ISSUES
          CALL      ADDL0000
.
          MOVE      "60 ",DELETOBJ          * SERVICE_EVENT_ATTRIBUTE
          CALL      ADDL0000
.
          MOVE      "61 ",DELETOBJ          * DIAGNOSIS
          CALL      ADDL0000
.
          MOVE      "63 ",DELETOBJ          * SERVICE_EVENT_PROVIDER
          CALL      ADDL0000
.
          MOVE      "64 ",DELETOBJ          * ONWARD REFERRAL
          CALL      ADDL0000
.
          MOVE      "72 ",DELETOBJ          * REQUEST FOR SERVICE      
          CALL      ADDL0000
.
          MOVE      "112",DELETOBJ          * SERVICE_EVENT_AND_ADMITTED
          CALL      ADDL0000
.
          MOVE      "114",DELETOBJ          * NOTIFIABLE CANCER
          CALL      ADDL0000
.
          MOVE      "115",DELETOBJ          * SERVICE_EVENT_GENERAL_PRACT
          CALL      ADDL0000
.
          MOVE      "130",DELETOBJ          * SERVICE_EVENT_TRANSFER
          CALL      ADDL0000
.
          MOVE      "131",DELETOBJ          * SERVICE_EVENT_RELATIONSHIP
          CALL      ADDL0000
.
          MOVE      "133",DELETOBJ          * SERVICE EVENT LEAVE
          CALL      ADDL0000
.
          MOVE      "137",DELETOBJ          * SERVICE_EVENT_DELAY
          CALL      ADDL0000
.
          MOVE      "142",DELETOBJ          * SERVICE_EVENT_LOCATION
          CALL      ADDL0000
.
DOAD9999  RETURN
+
.******************************************************************************
.* ADDL0000 - Send delete records for all objects for this visit
.******************************************************************************
ADDL0000  PACK      KEY112,DELETSTM,DELETOBJ,DAADMNO,SP70
          CALL      RSCMEWD2
ADDL1000  CALL      RKCMEWD2
          BRANCH    OVRCD,ADDL9999
.
          MATCH     DELETSTM,CMEWDSTR            * 17=Emergency Department
          GOTO      ADDL9999 IF NOT EQUAL
.
          MATCH     DELETOBJ,CMEWOBJT            * Correct Object
          GOTO      ADDL9999 IF NOT EQUAL
.
          UNPACK    CMEWOKEY,DIM8
          MATCH     DAADMNO,DIM8                 * First 8 chars is visit
          GOTO      ADDL9999 IF NOT EQUAL        * number
.
. ** don't delete already deleted record **
          MATCH     ANSD,CMEWRTYP
          GOTO      ADDL1000 IF EQUAL
.
          MOVE      CMEWOBJT,OBJECTTY            * Object
          PACK      OBJECTKY,CMEWOKEY,SP70       * Key
          PACK      OBJECTTX,CMEWTEXT,SP900      * Text
.
          PACK      SRCRDATE,CMEWSCDT,SP70
          PACK      SRCRTIME,CMEWSCTM,SP70
.
          MOVE      ANSD,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      ADDL1000
.
ADDL9999  RETURN
+
.******************************************************************************
.* UNDIS000 - Send records when a patient has been undischarged     
.******************************************************************************
UNDIS000  MOVE      "17 ",DELETSTM          * 17=Admitted Patient
.
          MOVE      "130",DELETOBJ          * SERVICE_EVENT_TRANSFER
          CALL      ADDL0000
.
UNDIS999  RETURN
+
.******************************************************************************
.* AMRG0000 - Loop patmrgaf and pmsadwaf and process any IP visit PMI merges
.******************************************************************************
AMRG0000  PACK      KEY25,STRTDATE,SP70
          CALL      RSPTMRG3
AMRG1000  CALL      RKPTMRG3                * Loop merge file
          BRANCH    OVRCD,AMRG5000
.
          MATCH     PTMRRDTE,ENDDATE        * Date created
          GOTO      AMRG5000 IF LESS
.
          PACK      KEY26,PTMRNWUR,SP1,THREE,SP70
          CALL      RSPTVIS4                * Read visit file by U/R
AMRG2000  CALL      RDKVISA4
          BRANCH    OVRCD,AMRG1000
.
          MATCH     PTMRNWUR,PVIURNO        * Correct U/R
          GOTO      AMRG1000 IF NOT EQUAL
.
          MATCH     " 3",PTVITYPE           * IP visits only
          GOTO      AMRG1000 IF NOT EQUAL
.
          MOVE      "17 ",CHANGSTM                     * 17=Admitted Patient
          MOVE      "57 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "12",CHANGCOL                      * Change column
          MOVE      PTMROLUR,CHANGOVL                  * Change old U/R value
          MOVE      PTMRNWUR,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,PVIBILL,SP70,SP70         * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      CSOF0000           * Change sent stream object field
.
          MOVE      "17 ",CHANGSTM                     * 17=Admitted Patient
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE  
          MOVE      "18",CHANGCOL                      * Change column
          MOVE      PTMROLUR,CHANGOVL                  * Change old U/R value
          MOVE      PTMRNWUR,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,PVIBILL,SP70,SP70         * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          GOTO      AMRG2000
.
AMRG5000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
AMRG6000  CALL      RKPMADW1                * Loop visit alterations file
          BRANCH    OVRCD,AMRG9999
.
          MATCH     PMAWCDAT,ENDDATE        * Date created
          GOTO      AMRG9999 IF LESS
.
          MATCH     "8 ",PMAWTYPE            * IP Visit Changed U/R
          GOTO      AMRG6000 IF NOT EQUAL
.
          MOVE      "17 ",CHANGSTM                     * 17=Admitted Patient
          MOVE      "57 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "12",CHANGCOL                      * Change column number
          MOVE      PMAWOLDV,CHANGOVL                  * Change old U/R value
          MOVE      PMAWNEWV,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,PMAWVISN,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          MOVE      "17 ",CHANGSTM                     * 17=Admitted Patient
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE 
          MOVE      "18",CHANGCOL                      * Change column number
          MOVE      PMAWOLDV,CHANGOVL                  * Change old U/R value
          MOVE      PMAWNEWV,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,PMAWVISN,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      CSOF0000           * Change sent stream object field
.
          GOTO      AMRG6000
.
AMRG9999  RETURN
+
.******************************************************************************
.* BDAT0000 - Attending doctor backdated/supervisor changed
.******************************************************************************
BDAT0000  MOVE      ONE,BDATFLAG
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
BDAT1000  CALL      RKPMADW1                * Loop visit alterations file
          BRANCH    OVRCD,BDAT9999
.
          MATCH     PMAWCDAT,ENDDATE        * Date created
          GOTO      BDAT9999 IF LESS
.
          MATCH     "18 ",PMAWTYPE            * movement deleted
          GOTO      BDAT1200 IF EQUAL
.
          MATCH     "23 ",PMAWTYPE            * care type change deleted
          IF        @EQUAL
            CALL      CTDL0000
            GOTO      BDAT1000
          ENDIF
.
          MATCH     "24 ",PMAWTYPE            * report all bed transfers
          GOTO      BDAT1200 IF EQUAL
.
          MATCH     "19 ",PMAWTYPE            * attending doctor changed
          GOTO      BDAT1000 IF NOT EQUAL
.
BDAT1200  PACK      DELETKEY,PMAWVISN
          MOVE      "17 ",DELETSTM          * 17=Admitted Patient
          MOVE      "63 ",DELETOBJ          * SERVICE_EVENT_PROVIDER
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      EDDK0000
.
          MATCH     "18 ",PMAWTYPE
          IF        @EQUAL
            MOVE      "17 ",DELETSTM          * 17=Admitted Patient
            MOVE      "142",DELETOBJ
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,TIME058,SP70
            CALL      EDDK0000
          ENDIF
.
          MATCH     "24 ",PMAWTYPE
          IF        @EQUAL
            PACK      DELETKEY,PMAWVISN,SP70
            MOVE      "17 ",DELETSTM          * 17=Admitted Patient
            MOVE      "142",DELETOBJ
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,TIME058,SP70
            CALL      EDDK0000
          ENDIF
.
          PACK      KEY8,PMAWVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,BDAT1000
.
. *** only send public claim types ****
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,BDAT1000
.
          MATCH     ANSP,TCINDC1         * Extract public
          GOTO      BDAT1300 IF EQUAL
.
          MATCH     "11",PTCDNHCP        * Extract reciprocal
          GOTO      BDAT1000 IF NOT EQUAL
.
.    ** resend all 63 and 142 objects for this visit **
.     **** loop all tran records and send object ***
BDAT1300  PACK      LASTDATE,SP70
          PACK      LASTTIME,SP70
          PACK      LASTDOCT,SP70
          PACK      LASTDTIM,SP70
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
BDAT1500  CALL      RDKTRAN2
          BRANCH    OVRCD,BDAT1000
.
          MATCH     AADMNO,TADMN
          GOTO      BDAT1000 IF NOT EQUAL
.
          MATCH     PTTRCDAT,ENDDATE
          GOTO      BDAT1000 IF LESS
.
          MOVE      ONE,SENDALT
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            PACK      LASTDATE,TDATE
            PACK      LASTTIME,TTIME
            PACK      LASTDOCT,TDATE
            PACK      LASTDTIM,TTIME
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      TTIME,PRIOTIMA
.
            PACK      OLDTDATE,TDATE * save date
            PACK      OLDTTIME,TTIME * save time
            MATCH     "18 ",PMAWTYPE
            IF        @EQUAL
              CALL      SELC0000
            ENDIF
            MATCH     "24 ",PMAWTYPE
            IF        @EQUAL
              CALL      SELC0000
            ENDIF
            CALL      WR630000
          ENDIF
.
          MATCH     ANSC,TMOVE
          IF        @EQUAL
            PACK      OLDTDATE,TDATE * save date
            PACK      OLDTTIME,TTIME * save time
            CALL      CHNG0000
          ENDIF
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            CALL      DELY0000                           * service event delay
. * end last doctor (63)I object
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "63 ",CHANGOBJ                     * Adress
            MOVE      "21",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ANSI,LASTDOCT,LASTDTIM,SP70,SP70
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last doctor (63) O object
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "63 ",CHANGOBJ                     * Adress
            MOVE      "21",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ANSO,ONE,SP70,SP70
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last doctor (63) OPobject
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "63 ",CHANGOBJ                     * Adress
            MOVE      "21",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,ANSO,ANSP,SP70,SP70
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
. * end last transfer (142) object
            MOVE      "17 ",CHANGSTM                     * 1=Client
            MOVE      "142",CHANGOBJ                     * Adress
            MOVE      "17",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL
            MOVE      TDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TTIME,PRIOTIMB
            PACK      CHANGNVL,DIM10B,SP1,PRIOTIMB,SP70  * Change new value
            PACK      CHANGKEY,DTADMN,LASTDATE,LASTTIME,SP70,SP70
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
            CALL      LSOF0000           * Change sent stream object field
.
          ENDIF
.
          GOTO      BDAT1500
.
BDAT9999  MOVE      ZERO,BDATFLAG
          RETURN
+
.******************************************************************************
.* CTDL0000 - Care Type change deleted
.******************************************************************************
CTDL0000  PACK      KEY8,PMAWVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CTDL9999
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CTDL9999
.
          MATCH     ANSP,TCINDC1          * extract public
          GOTO      CTDL0500 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * extract reciprocal
          GOTO      CTDL9999 IF NOT EQUAL
.
CTDL0500  MATCH     ANSP,TCINDC1          * Public - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC3,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC3,ATTRVALU
              ENDIF
.
. removed for task 0899679 as line above changed to from hardcoded
.              MATCH    "1",TCINDC9   * public/qualified
.              IF       @EQUAL
.                MOVE     "MW",ATTRVALU
.              ENDIF
             ENDIF
          ENDIF
          MATCH     "11",PTCDNHCP         * reciprocal - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.             IF       @EQUAL
.                MOVE     "RW",ATTRVALU
.             ENDIF
            ENDIF
          ENDIF
.  * delete previous records
          PACK      DELETKEY,PMAWVISN,ZERO,ONE
          MOVE      "17 ",DELETSTM          * 17=Admitted Patient
          MOVE      "60 ",DELETOBJ          * SERVICE_EVENT_ATTRIBUTE
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      EDDK0000
.
CTDL1000  PACK      KEY24,DAADMNO,SP70
          CALL      RDSCHCO1
CTDL1500  CALL      RDKCHCO1
          BRANCH    OVRCD,CTDL2000
.
          MATCH     DAADMNO,DCHADMN
          GOTO      CTDL2000 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      CTDL1500 IF NOT EQUAL
.
          MATCH     CHDATE,ENDDATE
          GOTO      CTDL2000 IF LESS
.
          MOVE      CHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
          MOVE      CHTIME,PRIOTIMB
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CTDL9999
.
          MATCH     ANSP,TCINDC1          * Public - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
               MATCH    "5",TCINDC9   * public/qualified
               IF       @EQUAL
                MOVE     PTCDASC3,ATTRVALU
              ENDIF
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.             IF       @EQUAL
.                MOVE     "MNW",ATTRVALU
.              ENDIF
             ENDIF
          ENDIF
          MATCH     "11",PTCDNHCP         * reciprocal - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
               MATCH    "5",TCINDC9   * public/qualified
               IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.              IF       @EQUAL
.                MOVE     "RW",ATTRVALU
.              ENDIF
            ENDIF
          ENDIF
.
          CALL      WRCC0000
          MOVE      CHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      CHTIME,PRIOTIMA
.
          GOTO      CTDL1500
.
CTDL2000  CALL      CLPATDSC
          PACK      KEY8,DAADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
          MATCH     DDATE,ENDDATE
          IF        !@LESS
            MOVE      DDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      DTIME,PRIOTIMB
          ENDIF
          CALL      WRCC0000
.
CTDL9999  RETURN
+
WRCC0000  MOVE      "60",OBJECTTY
          PACK      ATTRTYPE,ZERO,ONE,SP70
          MOVE      DADMNO,DIM8
          SQUEEZE   DIM8
          STRIP     ATTRTYPE
          STRIP     ATTRVALU
          STRIP     PRIOTIMA
          STRIP     PRIOTIMB
          STRIP     DIM10A
          STRIP     DIM10B
          PACK      KEY20,SP70

          STRIP     ATTRTYPE
          PACK      DIM8,AADMNO
          STRIP     DIM8
          PACK      OBJECTKY,DADMNO,ATTRTYPE,DIM10A,PRIOTIMA,SP70,SP70
          PACK      KEY20,DADMNO,ATTRTYPE,ADATE,ATIME,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             KEY20,TILDA: * ATTRIBUTE_RECORD_ID
                             ATTRTYPE,TILDA: * ATTRIBUTE_TYPE_CODE
                             TILDA:          * ATTRIBUTE_LOCAL_CODE
                             ATTRVALU,TILDA: * ATTRIBUTE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB,SP900  * END_DATETIME
.
          PACK      SRCRDATE,PMAWCDAT,SP70
          PACK      SRCRTIME,PMAWCTIM,SP70
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
.
WRCC9999  RETURN
+
.******************************************************************************
. WROF0000 - 64 ONWARD_REFERRAL
.******************************************************************************
WROF0000  MATCH     "1",PTCNEXED                 * Collect Extra Container Info
          GOTO      WROF9999 IF NOT EQUAL
.
          COMPARE   THREE,ASTAT                   
          GOTO      WROF9999 IF NOT EQUAL        * Only report if discharged
.
          PACK      KEY5,ANSD,ANSD,DDEST,SP70
          CALL      RDCODE1                      * Read cat DD
          BRANCH    OVRCD,WROF9999
.
          MATCH     "S",TCINDC7                  * Stat discharge
          IF        @EQUAL
            MOVE     "05.26",DIM5                * Stat discharge
          ELSE
            MOVE     "99",DIM5                   * Unknown
          ENDIF
.
          MATCH     "E",TCINDC7                  * Stat discharge
          IF        @EQUAL
            MOVE     "05.26",DIM5                * Stat discharge
          ELSE
            MOVE     "99",DIM5                   * Unknown
          ENDIF
.
          MOVE      "64",OBJECTTY                * ONWARD_REFERRAL
          PACK      OBJECTKY,DTADMN,DDEST,SP70,SP70
.
          MOVE      DTADMN,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM5
.
          PACK      OBJECTTX,TWO,TILDA:          * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:          * EVENT_RECORD_ID
                             ONE,TILDA:          * REFERRAL_RECORD_ID
                             DIM5,TILDA:         * TARGET_TYPE_CODE
                             TILDA:              * TARGET_OSP_ID_TYPE_CODE
                             TILDA:              * TARGET_OSP_SOURCE_ID
                             TILDA:              * TARGET_OSP_ID
                             TILDA:              * TARGET_ISP_ID_TYPE_CODE
                             TILDA:              * TARGET_ISP_SOURCE_ID
                             TILDA:              * TARGET_ISP_ID
                             SP900               * ISSUED_DATETIME
.
          PACK      SRCRDATE,PTTRCDAT,SP70
          PACK      SRCRTIME,PTTRCTIM,SP70
          PACK      SRMDDATE,PTTRCDAT,SP70
          PACK      SRMDTIME,PTTRCTIM,SP70
.
          CALL      WRCOND00     * write record to container detail table
.
WROF9999  RETURN
.
.******************************************************************************
.*  MHGG0000 - Write MH Legal Status changes - object type 60
.*  ATTRTYPE,ATTRVALU,DIM10A,PRIOTIMA,DIM10B,PRIOTIMB
.* send legal status attribute *
.******************************************************************************
MHGG0000  PACK      KEY35,AURNO,DAADMNO,ZERO,ONE,NINE,SP70
          CALL      RSPTATR3
MHGG0500  CALL      RKPTATR3
          BRANCH    OVRCD,MHGG9999
.
          MATCH     AURNO,PTARURNO
          GOTO      MHGG9999 IF NOT EQUAL
.
          MATCH     DAADMNO,PTARVISN
          GOTO      MHGG9999 IF NOT EQUAL
.
          MATCH     "019",PTARTYPE
          GOTO      MHGG9999 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
            MOVE      PTARDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      PTARTIME,PRIOTIMA
.
            MOVE      ANSD,OBJECTRT
            PACK      CMEWSCDT,PTARCDTE,SP70
            PACK      CMEWSCTM,PTARCTME,SP70
            MOVE      "17 ",DELETSTM          * 17=Inpatient
            MOVE      "60 ",DELETOBJ          * MH Attribute
            PACK      SRMDDATE,PTARCDTE,SP70
            PACK      SRMDTIME,PTARCTME,SP70
            PACK      DELETKEY,PTARVISN,ZERO,NINE,DIM10A,PRIOTIMA,SP70
            CALL      EDDK0000
            GOTO      MHGG0500
          ENDIF
.
          MOVE      "09",ATTRTYPE
          MOVE      SP70,ATTRVALU
.
          MATCH     SP70,PTARCOD1
          GOTO      MHGG0500 IF EQUAL
.
          PACK      KEY5,ANSL,ANSS,PTARCOD1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF4,ATTRVALU
          ENDIF
.
          PACK      DTADMN,PTARVISN,SP70
          PACK      TDATE,PTARDATE,SP70
          PACK      TTIME,PTARTIME,SP70
.
          MOVE      PTARDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      PTARTIME,PRIOTIMA
.
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MATCH     SP70,PTARFDTE
          IF        !@EQUAL
            MOVE      PTARFDTE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      PTARFTME,PRIOTIMB
          ENDIF
          PACK      PMVXCDTE,PTARCDTE,SP70
          PACK      PMVXCTIM,PTARCTME,SP70
          PACK      PMAWCDAT,PTARUDTE,SP70
          PACK      PMAWCTIM,PTARUTME,SP70
.
          CALL      WR600000     * write object type 60 record
          GOTO      MHGG0500
.
MHGG9999  RETURN
+
.******************************************************************************
.* RLEV0000 - Loop tranfer file records and report all leave reads
.******************************************************************************
RLEV0000  MOVE      "1",SENDALT
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
RLEV1000  CALL      RKPMADW1
          BRANCH    OVRCD,RLEV9999
.
          MATCH     PMAWCDAT,ENDDATE        * After extract end date
          GOTO      RLEV9999 IF LESS
.
          MATCH     "25 ",PMAWTYPE          * Report all leave
          GOTO      RLEV1000 IF NOT EQUAL
.
RLEV1100  PACK      KEY8,PMAWVISN,SP70
          CALL      RDMISS1                 * Get visit details
          BRANCH    EXIT,RLEV1000
.
. *** only send public claim types ****
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RLEV1000
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      RLEV1200 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      RLEV1200 IF EQUAL
.
          GOTO      RLEV1000
.
RLEV1200  MOVE      "17 ",DELETSTM          * 17=Admitted Patient
          MOVE      "133",DELETOBJ          * SERVICE_ACTIVITY
          PACK      DAADMNO,PMAWVISN
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      ADDL0000
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
RLEV1500  CALL      RDKTRAN2
          BRANCH    OVRCD,RLEV1000
.
          MATCH     AADMNO,TADMN
          GOTO      RLEV1000 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            CALL      LEAV0000               * 133 - on leave
            GOTO      RLEV1500
          ENDIF
.
          MATCH     ANSR,TMOVE
          IF        @EQUAL
            CALL      RETU0000               * 133 - return from leave
            GOTO      RLEV1500
          ENDIF
.
          GOTO      RLEV1500
.
RLEV9999  MOVE      ZERO,SENDALT
          RETURN
.
.******************************************************************************
.* UCAR0000 - Loop visit alterations and report care type obj 60
.******************************************************************************
UCAR0000  MOVE      "1",SENDALT
          PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
UCAR1000  CALL      RKPMADW1
          BRANCH    OVRCD,UCAR9999
.
          MATCH     PMAWCDAT,ENDDATE        * After extract end date
          GOTO      UCAR9999 IF LESS
.
          MATCH     "14",PMAWTYPE           * Admission details update
          GOTO      UCAR1500 IF EQUAL
.
          GOTO      UCAR1000
.
UCAR1500  PACK      KEY8,PMAWVISN,SP70
          CALL      RDMISS1                 * Get visit details
          BRANCH    EXIT,UCAR1000
.
. *** only send public claim types ****
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UCAR1000
.
          MATCH     ANSP,TCINDC1          * send public
          GOTO      UCAR1600 IF EQUAL
.
          MATCH     "11",PTCDNHCP         * send reciprocal
          GOTO      UCAR1600 IF EQUAL
.
          GOTO      UCAR1000    * not public, ignore
.
. Delete all financial class obj 60 attribute 01
.
UCAR1600  PACK      DELETKEY,PMAWVISN,ZERO,ONE
          MOVE      "17 ",DELETSTM          * 17=Admitted Patient
          MOVE      "60 ",DELETOBJ          * SERVICE_EVENT_ATTRIBUTE
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,TIME058,SP70
          CALL      EDDK0000
.
          CALL      CLPATDSC
          MATCH     "3",DASTAT
          IF        @EQUAL
            PACK      KEY8,DAADMNO,SP70
            CALL      RDDSCH1               * Read discharge record
            IF        OVRCD=1
              CALL      CLPATDSC
            ENDIF
          ENDIF
.
. Report all financial class obj 60 attribute 01 records
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
UCAR2000  CALL      RDPTRAN2
          BRANCH    OVRCD,UCAR1000
.
          MATCH     AADMNO,TADMN
          GOTO      UCAR1000 IF NOT EQUAL
.
. Report admission financial class object 60 attribute 01
.
          CALL      ADMC0000         * Admission financial class obj 60 att 01
.
          PACK      KEY8,PMAWVISN,SP70
          CALL      RDMISS1                 * Get visit details to restore
          BRANCH    EXIT,UCAR1000           * current care type in ACARE
.
. Report admission financial class qualification status changes
. object 60 attribute 01
.
          PACK      KEY24,DTADMN,SP70
          CALL      RDSCHCO1
UCAR3000  CALL      RDKCHCO1         * Process all care type changes
          BRANCH    OVRCD,UCAR1000
.
          MATCH     DTADMN,DCHADMN
          GOTO      UCAR1000 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      UCAR3000 IF NOT EQUAL
.
          CALL      USQU0000
.
          GOTO      UCAR3000
.
UCAR9999  RETURN
.
.******************************************************************************
.* Write admission financial class object 60 attribute 01
.******************************************************************************
ADMC0000  MOVE      SP70,SAVCHDAT      * Clear end date for current record
          MOVE      SP70,SAVCHTIM      * Clear end time for current record
.
.* check if care type changed on day of admission.  Get old value from patchcof
.
          PACK      KEY24,DTADMN,SP70
          CALL      RDSCHCO1
ADMC1000  CALL      RDKCHCO1
          BRANCH    OVRCD,ADMC5000
.
          MATCH     DTADMN,DCHADMN
          GOTO      ADMC5000 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      ADMC1000 IF NOT EQUAL
.
          MATCH     ADATE,CHDATE                 * Changed on admission date
          GOTO      ADMC5000 IF NOT EQUAL
.
          PACK      ACARE,CHCODE,SP70
.
ADMC5000  MOVE      ZERO,F1 * 0=not newborn
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADMC9999
.
. * only update if  qualified/unqualified old code was qual/unqual OR new
.
          MATCH     "5",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
          MATCH     "1",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
. find the next qualified/unqualified change to determine the end date
.
          PACK      KEY24,DTADMN,SP70
          CALL      RDSCHCO1
ADMC6000  CALL      RDKCHCO1
          BRANCH    OVRCD,ADMC7000
.
          MATCH     DTADMN,DCHADMN
          GOTO      ADMC7000 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      ADMC6000 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSC,CHCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADMC9999
.
. * only update if qualified/unqualified old code was qual/unqual OR new
          MATCH     "5",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
          MATCH     "1",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
          IF       F1=1
            MOVE      CHDATE,SAVCHDAT * Save end date
            MOVE      CHTIME,SAVCHTIM * Save end date
            GOTO      ADMC8000
          ENDIF
.
          GOTO      ADMC6000
.
. No qualified/unqualified changes for this patient so use discharge date
. as the end date if discharged, else no end date if current admission
.
ADMC7000  IF        ASTAT=3
            MOVE      DDATE,SAVCHDAT     * Save discharge date as end date
            MOVE      DTIME,SAVCHTIM     * Save discharge time as end time
          ENDIF
.
ADMC8000  MOVE      "01",ATTRTYPE
          MOVE      SP70,ATTRVALU
          MOVE      ADATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      ATIME,PRIOTIMA
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADMC9999
.
          MOVE      PTCDUDF3,ATTRVALU
.
          MATCH     ANSP,TCINDC1          * Public - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
               MATCH    "5",TCINDC9   * public/qualified
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
               MATCH    "1",TCINDC9   * public/qualified
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
               COMPARE  "13",TCFORM6
               IF       @EQUAL
                 MOVE     PTCDASC3,ATTRVALU
               ENDIF
             ENDIF
          ENDIF
          MATCH     "11",PTCDNHCP         * reciprocal - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
.
          MATCH     SP70,SAVCHDAT
          IF        !@EQUAL
            MOVE      SAVCHDAT,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      SAVCHTIM,PRIOTIMB
          ENDIF
.
          CALL      WR600000     * write object type 60 record
.
ADMC9999  RETURN
.
.******************************************************************************
.* End/Start qualification changes
.******************************************************************************
USQU0000  PACK      NEWCODE,SP70
.
          MOVE      ZERO,F1 * 0=not newborn
          PACK      KEY5,ANSC,ANSC,CHCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,USQU9999
.
. * only update if  qualified/unqualified old code was qual/unqual OR new
.
          MATCH     "5",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
          MATCH     "1",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
. * get the new care type (either next record on patchcof or current acare)
.
USQU0100  MOVE      SP70,SAVCHDAT      * Clear end date for current record
          MOVE      SP70,SAVCHTIM      * Clear end time for current record
.
          PACK      SAVKEY24,DCHADMN,CHDATE,CHTIME,SP70
          PACK      KEY24,DCHADMN,CHDATE,CHTIME,SP70
          CALL      RDCHCO1
USQU0200  CALL      RDKCHCO1
          BRANCH    OVRCD,USQU0500
.
          MATCH     DCHADMN,DAADMNO
          GOTO      USQU0500 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      USQU0200 IF NOT EQUAL
.
          PACK      NEWCODE,CHCODE,SP70
          MOVE      CHDATE,SAVCHDAT * Save end date
          MOVE      CHTIME,SAVCHTIM * Save end date
.
          GOTO      USQU1000
.
USQU0500  PACK      NEWCODE,ACARE,SP70
          IF        ASTAT=3
            MOVE      DDATE,SAVCHDAT     * Save discharge date as end date
            MOVE      DTIME,SAVCHTIM     * Save discharge time as end time
          ENDIF
.
USQU1000  PACK      KEY5,ANSC,ANSC,NEWCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,USQU9999
.
. * only update if  qualified/unqualified old code was qual/unqual OR new
          MATCH     "5",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
          MATCH     "1",TCINDC9
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
.
. ** if old or new care type are not qual/unqual, don't send
          COMPARE   ONE,F1
          GOTO      USQU9999 IF NOT EQUAL
.
          PACK      KEY24,SAVKEY24
          CALL      RDCHCO1
          BRANCH    OVRCD,USQU9999
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,USQU9999
.
          MATCH     ANSP,TCINDC1          * Public - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,NEWCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC3,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC3,ATTRVALU
              ENDIF
.
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.             IF       @EQUAL
.               MOVE     "MW",ATTRVALU
.             ENDIF
            ENDIF
          ENDIF
          MATCH     "11",PTCDNHCP         * reciprocal - check qual/unqual
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSC,NEWCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH    "5",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
              MATCH    "1",TCINDC9   * public/qualified
              IF       @EQUAL
                MOVE     PTCDASC4,ATTRVALU
              ENDIF
.
. removed for task 0899679 as line above changed to from hardcoded
.             MATCH    "1",TCINDC9   * public/qualified
.             IF       @EQUAL
.               MOVE     "RW",ATTRVALU
.             ENDIF
            ENDIF
          ENDIF
.
          MOVE      "01",ATTRTYPE
          MOVE      CHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      CHTIME,PRIOTIMA
.
. * start new obj 60 attr 01
.
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MATCH     SP70,SAVCHDAT
          IF        !@EQUAL
            MOVE      SAVCHDAT,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      SAVCHTIM,PRIOTIMB
          ENDIF
.
          PACK      KEY20,ATTRTYPE,CHDATE,CHTIME,ATTRVALU,SP70
          STRIP     KEY20
          PACK      OBJECTKY,DTADMN,ATTRTYPE,CHCRDATE,CHCRTIME,SP70,SP70
          PACK      DIM8,DTADMN
          SQUEEZE   DIM8
          STRIP     ATTRVALU
          PACK      OBJECTTX,TWO,TILDA:      * SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             DIM8,TILDA:     * SERVICE_ENCOUNTER_RECORD_ID
                             ONE,TILDA:      * SERVICE_EVENT_RECORD_ID
                             KEY20,TILDA: * ATTRIBUTE_RECORD_ID
                             ATTRTYPE,TILDA: * ATTRIBUTE_TYPE_CODE
                             TILDA:          * ATTRIBUTE_LOCAL_CODE
                             ATTRVALU,TILDA: * ATTRIBUTE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * START_DATETIME
                             DIM10B,SP1,PRIOTIMB,SP900  * END_DATETIME
.
          PACK      SRCRDATE,CHCRDATE,SP70
          PACK      SRCRTIME,CHCRTIME,SP70
          PACK      SRMDDATE,PMAWCDAT,SP70
          PACK      SRMDTIME,PMAWCTIM,SP70
.
          CALL      WRCOND00     * write record to container detail table
.
USQU9999  RETURN
