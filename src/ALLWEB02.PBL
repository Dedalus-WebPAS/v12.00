.------------------------------------------------------------------------------
. Program        : ALLWEB02
.
. Function       : Allied Health (ALLWEB02) Web Server
.
. Modifications  :
.------------------------------------------------------------------------------
. V12.00.02  13/08/2025  Nikitha B     TSK 0961969
.            Added a new tag at ADDR0320 to check the visit if ever been active
.            Added Medi-Hotel check at SACER900 & SACR9000 to skip if no contact
. V12.00.01 13/05/2025  Ebon Clements   TSK 0955096
.            Added alpanumeric visit number generation - ADDREF70 - GENANVIS
. V11.05.02  07/05/2025  Nikitha B      TSK 0959601
.            Recomplied for PATMISTM.
. V11.05.01  19.12.2024 DA Sarkies     TSK 0954547 
.            Recompiled for ALLREFTM
. V11.04.17  15/10/2024 PJ Le Febour   TSK 0951542e
.            added condition MATCH ALRECONT and ALCCCONT to determine 
.            if to test PTCOACTV if ACTIVE  
. V11.04.16  14/10/2024 PJ Le Febour   TSK 0951542d
.            ADDR0260 moved test of PTCOACTV if ACTIVE  
. V11.04.15  02/10/2024 PJ Le Febour   TSK 0951542a
.            ADDR0260 moved test of PTCOACTV if ACTIVE after 
. V11.04.14  14/08/2024 Thanh T        TSK 0920849
.            Changed RFNACT30 to remove the checking for ignoring current
.            patient   
. V11.04.13  26/07/2024 PJ Le Febour   TSK 0912348a
.            Added ALLH0480 get Desc for CatCode=DL to display in heading
. V11.04.12  03/07/2024 Thanh T        TSK 0920849
.            Added RMOT0300
. V11.04.11  27.06.2024 DA Sarkies     TSK 0948535
.            Recompiled for PATMSXTM
. V11.04.10  20/06/2024 PJ Le Febour   TSK 0912348
.            new Filter HCP Class Added variables HCPCLASD HCPCLASF HCPDLDES          
.            Added procedure PROFL170 ALLH0460 AHCP0000          
. V11.04.09  14/05/2024 Ebon Clements  TSK 0923284
.            Calculate last main health condition unique count - MCHT0000
. V11.04.08  11/04/2024 Nikitha B      TSK 0941763
.            Added new Remote script at REMOTE94 and added new routine INPF0000 
.            to check for Inpatient visit for Add contact page at REMOTE94.
. V11.04.07  18.03.2024 DA Sarkies     TSK 0939978
.            Added subroutines to load Allied Health Referrals as JSON
. V11.04.06  15.03.2024 Ebon Clements  TSK 0911338
.            Added clear of admission and discharge file fields - ASCOR800
. V11.04.05  08/02/2024 Thanh T        TSK 0903618
.            Changed ADDR0260 to fix issue with incorrect contract list
. V11.04.04  17/01/2024 Thanh T        TSK 0903618
.            Recompiled for ALLCCTFD changes
. V11.04.03  16/01/2024 Ebon Clements  TSK 0940002
.            Added display of all booking instruction comments - AVNT0000
. V11.04.02  09/01/2024 Thanh T           TSK 0936263                  
.            Added CLPMSQPX to clear pmsqpxaf table variables          
. V11.04.01  27/11/2023 Thanh T        TSK 0903618
.            Recompiled for ALLCCTFD changes
. V11.03.11  15.03.2024 Ebon Clements  TSK 0911338
.            Added clear of admission and discharge file fields - ASCOR800
. V11.03.10  14.03.2024 DA Sarkies     TSK 0939978
.            Added subroutines to load Allied Health Referrals as JSON
. V11.03.09  16/01/2024 Ebon Clements  TSK 0940002
.            Added display of all booking instruction comments - AVNT0000
. V11.03.08  11/01/2024 Ebon Clements  TSK 0941629
.            Recompiled for WEBPRTCD - Inactive printers
. V11.03.07  13/11/2023  Nikitha B     TSK 0939472
.            Added a condition to skip the deleted referal notes at TABL0185.
. V11.03.06  05/10/2023 Thanh T        TSK 0935874
.            Changed ADDREF75 to comment out the codes for PTCNUNET = '1'
.            since it is no longer used           
. V11.03.05  12.09.2023  DA Sarkies    TSK 0892939
.            added check for NZ and if so, write an after audit note 
. V11.03.04  09/11/2023  Alina Bbhari  TSK 0935499
.            Dont display acc no for non accident referral - RLRW5000
. V11.03.03  17/05/2023  Ebon Clements TSK 0932616
.            Recompiled for PMSPX2TM - Current IP
. V11.03.02  12/05/2023  Ebon Clements TSK 0928369
.            Added linked attended OP booking exists tag - TABL0900
. V11.03.01  11/01/2023  J.Tan         TSK 0906597
.            Recompiled for ABFRFINV - added Residential remoteness adjustmnet
. V11.02.10  10.10.2022  DA Sarkies    TSK 0924898
.            Inserted check to skip over sites that are inactive
. V11.02.09  03.10.2022  DA Sarkies    TSK 0889650
.            Added variable to hold a flag to notify that a referral will be
.            rejected. Variable is REFREJCT.
. V11.02.08  15/09/2022  Ebon Clements TSK 0899362
.            Write referral renewal aidit records for SCS and SOP - RNWA0000
. V11.02.07  15/08/2022  Davin         TSK 0918185
.            Trigger an HL7 Outpatient A08 message when an outpatient visit is
.            linked or unlinked to/from a referral (OA08R000/OA08V000/OA08M000)
. V11.02.06  22/07/2022  Ebon Clements TSK 0921629
.            Added write of EDWARD OP visit update trigger after linking 
.            and unlinking a referral to an OP visit - WEDT0000
. V11.02.05  07/06/2022  Ebon Clements TSK 0920135 
.            Fixed all referrals display if end of file reached when filtering
.            by a status - ALRT0000
. V11.02.04  07.03.2022  DA Sarkies    TSK 0896905 
.            Reconfigured code so that values over 9 for Allied Health
.            Department Details can be read. Added call to load whether linked
.            referral can be copied
. V11.02.03  09/02/2022  Thanh T       TSK 0905641 
.            Recompiled as OUTHEDFD/OUTMA1FD/WATTR1FD changes
. V11.02.02  07/02/2022  Thanh T       TSK 0896905
.            Recompiled for ALLDEPFD changes 
. V11.02.01  31/01/2022  Alina Bhari   TSK 0864233
.            Read OUTBB1FD
.            Added contacttime in remote script returnvalue in OUTAPP80
. V11.01.11  19/01/2022  P Le Febour   TSK 0903524
.            Exclude WAHEALTH when test if referral date is retrospective
. V11.01.10  21/12/2021  P Le Febour   TSK 0891395
.            Added update of Preferred-Hospital Preferred-Site 
.                            Clinic-Type Clinic-Id Slot-Type 
. V11.01.09  21/12/2021  DA Sarkies    TSK 0889010
.            Added DB call to extract ACC Number and date for list to display to
.            RLRW5000 and to display in referral list. Added include to clear
.            ACC fields.
. V11.01.08  23/11/2021  Ebon Clements TSK 0913624
.            Set AGEDATE to deceased date if deceased 
. V11.01.07  14/10/2021  Ebon Clements TSK 0911959
.            Fixed position of pmi extn file 2 read for the patient name
.            format display - WRTHTM00 PATLN000
. V11.01.06  11/10/2021  Ebon Clements TSK 0912546
.            Recompiled for VINAHDEF - Reject program referral audit records
. V11.01.05  27/08/2021  Ebon Clements TSK 0908767
.            Added chkvinah cgi and tag                                 
. V11.01.04  27.08.2021  DA Sarkies     TSK 0910494
.            Changed 'Inactive' to 'Active' in warning at ADDREF88        
. V11.01.03  05/07/2021  Ebon Clements  TSK
.            Recompiled for ALLRHLTM - Episode health condition HDP output
. V11.01.02  16/06/2021  Ebon Clements  TSK 0907357
.            Allow HBD referral to be closed without contacts 
.            SACR9000 & SACER900
. V11.01.01  15/02/2021  Ebon Clements  TSK 0902587
.            Recompiled for ALLREFTM - Procedure selection list
. V11.00.17  09/12/2020  Thanh T        TSK 0872840
.            Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.16 19/10/2020  Ebon Clements     TSK 0894313
.           Fixed responsible HCP name when displaying addition HCP
.           names  - RLRW0000 field 26 - DOCFNAME - DISHCS00
. V11.00.15 12/10/2020  Ebon Clements     TSK 0890602
.           Added EXPRFLAG cgi - Show expiry date red when called from the
.           follow up referral list
. V11.00.14 11/08/2020  Ebon Clements     TSK 0890822
.           Moved Don't Allow Encounters on Primary Referral test
.           from ALRL0000 to RLRW0000
. V11.00.13 06/08/2020  Ebon Clements     TSK 0890822
.           Added LINKSRCH Don't Allow Encounters on Primary Referral test to
.           the link referral list search - ALRL0000, ULNKT000 & ULNKC000
. V11.00.12 09/07/2020  Tracey Nguyen     TSK 0888305
.           Stopped printing of copied linked referral letters and labels
.           - ALLEVT10
. V11.00.11 10/06/2020  Thanh T           TSK 0857573
.           Changed GPATCD00 to return description for Category field dsec   
. V11.00.10 20/05/2020  Thanh T           TSK 0857573
.           Changed GPATCD00 to return description for Category field desc   
. V11.00.09 22/04/2020  Ebon Clements     TSK 0850105 
.           Clear PMCUTSTA and PMCUTLOC before write to pmscuraf
. V11.00.08 16/04/2020  Thanh T           TSK 0857573
.           Added TABL0840, TABL0850
. V11.00.07 16/04/2020  Thanh T           TSK 0857573
.           Added TABL0840, TABL0850   
. V11.00.06 09/04/2020  J.Tan             TSK 0868813
.           Mod to set PACFRMT to 3 for PKNAME
. V11.00.05 08/04/2020  Thanh T           TSK 0879163
.           Recompiled for ALLLETFD
. V11.00.04 01/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.03 20/03/2020  Peter Vela    TSK 0889143
.           Fixed ALLLET IO calls
. V11.00.02 19/03/2020  Peter Vela    TSK 0889143
.           Recompiled for ALLLETFD
. V11.00.01 11/03/2020  Ebon Clements    TSK 0888624
.           Recompiled for ALLREFFD - new field ALREFTSC
.------------------------------------------------------------------------------
. V10.15.08 18/02/2020  Tracey Nguyen    TSK 0881801
.           Corrected hospital code as PMVXMHOS instead of ALREHOSN for
.           Inpatient visit Location - LLOCN310 to LLOCN350
. V10.15.07 04/02/2020  Tracey Nguyen    TSK 0881801
.           1)Added remote script to get current IP details - IPDET000
.           2)Added ALREDREV for sortflag=1 - ACTDIS00, WRTHTM00
.           3)Added LLOCN000 to display Linked Visit/Reason for Adm and
.             Location columns - ACTDIS00, WRTHTM00
.           28/01/2020  Nicole Torrisi   TSK 0883895
.           Changed to display HCPs when not blank to prevent excessive row
.           height with no content - DISHCP00, DISHCS00
. V10.15.06 09/01/2020  Ebon Clements    TSK 0882475
.           Added ignore current OP visit option to referral linked OP booking
.           remote script  - CHKAPP00
. V10.15.05 09/12/2019  Ebon Clements    TSK 0881979
.           Added check for group contacts when closing a referral - GDAT0000
. V10.15.04 19/11/2019  Ebon Clements    TSK 0872933
.           Added triage status to unlinked referral list UREFT600 - CheckLink()
. V10.15.03 07/11/2019  Tracey Nguyen    TSK 0865480
.           Added MULTILRF flag for CPRI0000 to replace the use of the common
.           EXIT flag to fix premature end of script headers error
. V10.15.02 16/10/2019  Richa Phogat     TSK 0865482
.           Updated ReferralLink() by adding ALREUYN4 & ALDEPENC under RLRW1500
. V10.15.01 07/10/2019  Tracey Nguyen    TSK 0865480
.           1)Added functionality to automatically create a copy of the Primary
.           referral as a Linked referral - ALLEVT10, AUTOCPRF 
.           2)Added functionality to automatically close a Primary referral
.           from a Linked referral - ALLEVT70, CPRI0000, MVPRI000
.------------------------------------------------------------------------------
. V10.14.29 24/09/2019  Tracey Nguyen    TSK 0855163
.           Added extra checks for activity - ATCAS300, ATCAS400              
. V10.14.28 13/09/2019  Tracey Nguyen    TSK 0855163
.           Added remote script in reportno 17 to validate if the case team for 
.           an MH visit can be updated - REMOTSNO, VALDTEAM, RMOT0000,ATCAS000
. V10.14.27 09/09/2019  Ebon Clements    TSK 0877014
.           Check for OP attendances as well as bookings after the proposed
.           referral closure date - CHKOUT00
. V10.14.26 06/08/2019  Peter Vela       TSK 0876649
.           Recompiled for ALLENCTM
. V10.14.25 31/07/2019  Peter Vela       TSK 0874259
.           Validate for existing patwc1af record before update in DEWCOM00
. V10.14.24 30/07/2019  Ebon Clements   TSK 0875144
.           Added all hospital filter option to active referral lists 
.           AART0000,AARTH000,ALAC0000 and ALACH000
. V10.14.23 17/07/2019  Ebon Clements   TSK 0877986
.           Added 20 zero test to PTCNNSSI using EDWARD
.           17/07/2019  Peter Vela      TSK 0858824
.           Added Additional HCPs functionality
. V10.14.22 10/07/2019  Ebon Clements   TSK 0877824
.           Added VINAH audit trigger flags VINAHFLG, EPAUDFLG, RIAUDFLG and
.           VINAHREF to CLRPAR00
. V10.14.21 05/07/2019  Tracey Nguyen   TSK 0872044
.           Added filtspit and filthosp in NREV0000 
. V10.14.20 19/06/2019  Steve Armstrong TSK 0869966
.           Mods to AMAS0000 when writing allaudre records, to check
.           value of VINAHFLG and process accordingly.
. V10.14.19 06/06/2019  Sunny           TSK 0872830
.           Added CLSREF05 to check HoNOS Active/Inactive   
. V10.14.18 30/05/2019  Sunny           TSK 0874427
.           Added SUPD0000 for Supervisor Referral function 
.           04/06/2019  Davin           TSK 0862992
.           Added output tag thetkeys for theatre casekeys (TABL0830)
. V10.14.17 29/05/2019  Steve Armstrong TSK 0869966
.           Added initialisation of EPAUDFLG and RIAUDFLG in INIT0000
. V10.14.16 24/05/2019  Ebon Clements   TSK 0868837
.           Recompiled for VINAHDEF - Episode patient ready for care date clear
. V10.14.15 23/05/2019  Steve Armstrong TSK 0869966
.           Added reset of EPAUDFLG and RIAUDFLG on exiting UPDREF00.
. V10.14.14 13/05/2019  Steve Armstrong TSK 0869966
.           Recompiled for changes to VINAHDEF.
.           Mods to minimize the number of audit records (allaudre) being
.           written when an Episode is activated (UPDREF00).
. V10.14.13 08/05/2019  Thanh T         TSK 0868837
.           Changed ACTAUD00 to get the correct web user name for the referral 
.           action list 
. V10.14.12 07/05/2019  Thanh T         TSK 0868837
.           Added IOUTAR00,MISC0300 and REFOUT00 
. V10.14.11 06/05/2019  Ebon Clements   TSK 0869558
.           Added RequestLink() to APPRQS00
. V10.14.10 01/05/2019  Ebon Clements   TSK 0868837
.           Allow blank referral out date for TCP - RDTU0000              
. V10.14.09 01/05/2019  Ebon Clements   TSK 0868837
.           Recompiled for VINAHDEF - Episode patient ready for care date
. V10.14.08 17/04/2019  Steve Armstrong  TSK 0868837
.           Recompiled for changes to ALLHDTFD.
.           17/04/2019  Tracey Nguyen    TSK 0872253
.           Added check for ACTIVREF in ADDREF30
. V10.14.07 05/04/2019  Tracey Nguyen     TSK 0871443
.           Added BCTBL000 for AIMS Breathlessness Assessment List
. V10.14.06 29/03/2019  Thanh T.          TSK 0869558
.           Added ALRLAQ00 for Re-link appointment request list
. V10.14.05 26/03/2019  Thanh T.          TSK 0869558
.           Changed APPRQS00 to display the request date in the correct
.           format
. V10.14.04 19/03/2019  Richa Phoagt      TSK 0869550
.           Added ACCAUDFD/IO, CLACCAUD, MVACCREM
.           15/03/2019  Thanh T.          TSK 0869558
.           Added UPOART00. When the appointment request in transfer
.           referral control parameter is turned on, if the department
.           required (outartaf.otaradep) matches the department from
.           field, it will be updated with the department to field
.           Added MISC0280/APPRQS00 to retrieve outpatient appointment requests
. V10.14.03 12/03/2019  Tracey Nguyen   TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.02 27/02/2019  Ken Bell        TSK 0869548
.           Added ACCDIAFD, EMRICDFD for EA Diagniosis codes in PATCLMTM
. V10.14.01 12/02/2019  Nicole Torrisi  TSK 0869113
.           Added output of CLINDATE (ADDR0300)
.           Added ALRERDAT to ReferralLink() in RLRW1500, APRL1500
. V10.13.10 07/01/2019  Thanh T         TSK 0867136
.           Added Perferred date, Department Required, removed clinic id 
.           from RQAPT000 
. V10.13.09 21/12/2018  Thanh T         TSK 0867136
.           Added TABL0800 and REMOTE93 routines
. V10.13.08 07/11/2018  Don Nguyen      TSK 0853817
.           Modified DEWCOM00 (Delete Workers Comp. details) to set
.           Claim Status to 'Cancelled' if only one visit for the Claim Number
.           exists (NZ Only); instead of deleting it.
. V10.13.07 22/10/2018  Ebon Clements   TSK 0865146
.           Write linked OP visit EDWARD alteration record  - WEDR0000
. V10.13.06 24/08/2018  Steve Armstrong TSK 0845563
.           Mods to use CLALLAUD and pass update type via UPDTTYPE for both
.           WRTRAT00 and WRTRAU00 routines.
. V10.13.05 02/10/2018  Thanh T         TSK 0859743
.           Added new MAIN2600
. V10.13.04 05/09/2018  Ebon Clements   TSK 0862246
.           Added edward alterations table referral update write - WEDR0000
. V10.13.03 20/08/2018  Don Nguyen      TSK 0848756
.           Added call to CLPMSVX1 in ADDREF00
. V10.13.02 13/08/2018  Ebon Clements   TSK 0861019
.           Don't check for contacts when closing HEN and TPN referrals
.           SACR9300 and SACER930
. V10.13.01 30/07/2018  Ebon Clements   TSK 0815359
.           Don't display IP department in selection lists
.           25/07/2018  Thanh T         TSK 0845563
.           Changed ACTT0000 to add the icon for switching to new supervisor
.           action code maintenance template 
. V10.12.15 20/07/2018  Peter Vela      TSK 0852218
.           Added replace of double quotes in RLRW0000 for ALREUFR1
. V10.12.14 11/07/2018  Tracey Nguyen   TSK 0318661
.           1) Added allaudaf.ALAUUPDT=R to record when the referral priority is
.           changed in UPDREF80
.           2) Modified ARASUP00 to display "Priority" when ALAUUPDT=R
. V10.12.13 25/05/2018  Ania P          TSK 0857182
.           Added mehhonaf table check to SUPREF00
. V10.12.12 24/05/2018  Don Nguyen      TSK 0846099
.           Modified FTAB0000 & GTABW000 to output FIM Assessment Type
.           descriptions (Admission, Discharge, Progress or VINAH).
.           Recompiled for changes to PATFIMTM - Added PTFI0920.
. V10.12.11 18/05/2018  Thanh T.        TSK 0851528
.           Recompiled for PATVISTM changed
. V10.12.10 18/05/2018  Ania P          TSK 0857182
.           Added CDAT0000 check to SUPREF00
. V10.12.09 26/04/2018  Thanh Tieu      Task 0851975
.           Added triage status filer FILTTRGS.
. V10.12.08 24/04/2018  Tracey Nguyen   TSK 0841644
.           Recompiled for PMSIMPFD - added impairment code
. V10.12.07 28/03/2018  Thanh T.        TSK 0851975
.           Changed for triage status enhancement. Added codes to
.           output the triage status description TRGSDESC to show on various  
.           templates.
. V10.12.06 23/03/2018  Thanh T.        TSK 0854273
.           Recompiled as ALLENCTM changed
. V10.12.05 15/03/2018  Ebon Clements   TSK 0851816
.           Recompiled for PATMASTM - Advance care directive
. V10.12.04 13/02/2018  Thanh Tieu      TSK 0306843
.           Added RESADM00 section to determine if there is any residential
.           admisson data to show the admission icon
. V10.12.03 29/01/2018  Ebon Clements   TSK 0845295
.           Added ereferral id tag to TABL0000              
. V10.12.02 24/01/2018  Ebon Clements   TSK 0845295
.           Added eReferral functionality  - cgi erefrlid
. V10.12.01 10/01/2018  Don Nguyen      TSK 0323414
.           Modified CHKOUT00 to also check booking time if same date
. V10.11.18 12/12/2017  Thanh Tieu      TSK 0306843
.           Added RESADM00 section to determine if there is any residential
.           admisson data to show the admission icon
. V10.11.17 18/12/2017  Ebon Clements   TSK 0846952
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.16 27/11/2017  Thanh Tieu      TSK 0821710
.           Recompiled as PATMASTM changed
. V10.11.15 06/10/2017  Jill Parkinson Task 0846099
.           Added check for category A in GTABW000
. V10.11.14 02/10/2017  Peter Vela      TSK 0845320
.           Added spaces validation for mhcon001 and mhcon002 in MHCA0000
. V10.11.13 27/09/2017  Richa Phogat    TSK 0841069
.           Updated ALCD0000 to display striked row for deleted document
. V10.11.12 11/09/2017  Thanh T.        TSK 0821710
.           Audit Amission/outpatient visit comments. Removed PATCOMFD/IO
. V10.11.11 04/09/2017  Jill Parkinson Tsk 0840856 
.           Changed QLDCAR00 to use 5=HONOS 6=FIM (instead of 6=HONOS 7=FIM)
.           to match standard AddAssCareType js function in allweb0210.js
. V10.11.10 23/08/2017  Ebon Clements   TSK 0841314
.           Added display triage status on referral lists - ALCNDTRG
. V10.11.09 23/08/2017  Ebon Clements   TSK 0842117
.           Added triage status tag for OP booking edit - TABL0760
. V10.11.08 18/08/2017  Ania P          TSK 0843179
.           Recompiled for IBAWEBCD
. V10.11.07 04/08/2017  Ebon Clements   TSK 0843265
.           Recompiled for VINAHDEF - Program referral triage statu
. V10.11.06 28/07/2017  Thanh T.        TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.05 26/07/2017  Richa Phogat    TSK 0842424
.           Added code to turn "Assessments. button Red if there is any
.           detail behind it
. V10.11.04 26/07/2017  Thanh T.        TSK 0821710
.           Recompiled PATMISTM
. V10.11.03 21/07/2017  Ebon Clements   TSK
.           Recompiled for VINAHDEF - Program referral triage status
. V10.11.02 14/07/2017  Thanh T.        TSK 0821710
.           Audit Admission/outpatient visit comments. PATMISTM changed.
. V10.11.01 18/07/2017  Tracey Nguyen   TSK 0306959
.           Added missing FILTHOSP and FILTPSIT to NEXT0000 and PREV0000 for
.           Next/Previous Date range
. V10.10.16 11/07/2017   Ebon Clements  TSK 0841926
.           Write delete audit when unlinking an episode referral
.           from a program referral -  USAC0000
.           07/07/2017   Tracey Nguyen  TSK 0306959
.           Added OVRHOSP to NEXT0000 and PREV0000 for Next/Previous Date range
.           04/07/2017  Richa Phogat    TSK 0817112
.           Rollback changes done for task 0817112
. V10.10.15 03/07/2017  Ebon Clements   TSK 0837701
.           Added get PMI local GP/Practice remote script - GETLGP00
. V10.10.14 28/06/2017  Ebon Clements   TSK 0841110
.           Added triage status output to VALREF00
. V10.10.13 23/06/2017  Tracey Nguyen   TSK 0306959
.           Added validation for override hospital filter to list referrals
.           based on the user hospital access in AWRT0000,AWRTD000 & OVRT0000
. V10.10.12 21/06/2017  Richa Phogat    TSK 0817112
.           Add a row to Patient Polling Table (IBAPOLFD:IBPLTYPE=016) under
.           UPDREF00. Added WAHEALTH cgi to add record in IBAPOLFD 
. V10.10.11 15/06/2017  Don Nguyen      TSK 0823705
.           Modified AWRTD000 to also filter on Priority.
.           Modified AARTH000 to also filter on Clinic Type/ID.
. V10.10.10 09/06/2017  Tracey Nguyen   TSK 0306959
.           Added new CGI variable OVRDHOSP for hospital filter override to
.           output HOSPNAME if value is set to 1
. V10.10.09 05/06/2017  Don Nguyen      TSK 0823705
.           Added call to AARTH000 & ALACH000 when Department code blank (All).
.           Added ALLH0440 - Output OVRDDEPT. 
. V10.10.08 23/05/2017  Ebon Clements   TSK 0828866
.           Recompiled for VINAHDEF - Date referral accepted
. V10.10.07 23/05/2017  Ebon Clements   TSK 0839024
.           Write audit when unlinking a referral -  ULNK0000 & UNKR0000
. V10.10.06 06/04/2017  Ebon Clements   TSK 0833052 
.           Recompiled for ALLRHLTM - Main health condition count tag           
.           Added main health condition add/update/del - MHCA0000 - MHCQ0000
. V10.10.05 31/03/2017  B.G.Ackland     TSK 0836043 
.           Check for Merged UR in Booking Comments for FHIR
. V10.10.04 30/03/2017  Ebon Clements   TSK 0833052
.           Added using triage status and using priority tags - EXDEPT00
. V10.10.03 30/03/2017  Ebon Clements   TSK 0833052
.           Recompile for ALLREFFD - New fields triage status and date
. V10.10.02 22/03/2017  Tracey Nguyen   TSK 0833454
.           Added ATAB0000 for AIMS Pain Assessment List
. V10.10.01 17/03/2017  Ania P          TSK 0835110
.           Fixed output for LSTENDAT
. V10.09.11 27/01/2017  Ebon Clements   TSK 0828785
.           Recompiled for ALLREFTM - OP Site selection list security test
. V10.09.10 23/01/2017  Ania P          CAR 831984
.           Fixed output of LSTENDAT
. V10.09.09 18/01/2017  B.G.Ackland     TSK 0829696
.           FHIR Reverse Order of Notes Output
. V10.09.08 18/01/2017  Don Nguyen     TSK 0822763
.           Modified REJREF00 to check 'allgrpaf' for matching referral record
. V10.09.07 18/01/2017  B.G.Ackland     TSK 0829696
.           Fixed Comments Output for FHIR interface
. V10.09.06 18/01/2017  B.G.Ackland     TSK 0829696
.           Corrected processing billing notes for FHIR interface
.           Interface allows lines longer than the 100 characters 
. V10.09.05 12/01/2017  Jill Parkinson TSK 0831872
.           Corrected goto in GTLENC00 to stop P*K
. V10.09.04 09.12.2016  B.G.Ackland     TSK 0829696
.           Added FHIR Formatted Output for Billing Instruction Comments
.           Added Parameter for External Referral ID
. V10.09.03 08/12/2016  Peter Vela     TSK 0822763
.           Added new zealand validations to REJREF30
. V10.09.02 01/12/2016  Jill Parkinson TSK 0822329
.           Added ACC Purchase Order number cgi and call to write pmswx1af
. V10.09.01 29/11/2016  Nicole Torrisi TSK 0290345
.           Changed GTLENC00 to include group contacts and OP visits
. V10.08.33 22/11/2016  Nicole Torrisi TSK 0829184
.           Changed GTLENC00 to use Index 6 on allencaf
. V10.08.32 18/11/2016  Peter Vela     TSK 0827671
.           Added single space after Parent of <Initial>.
.           before write to patre1af
. V10.08.31 15/11/2016  Nicole Torrisi TSK 0815159
.           Recompiled for ALLENCTM/ALLENCTD
. V10.08.30 09/11/2016  Ebon Clements  TSK 0822228
.           Changed priority text colour classes - WRTHTM00           
. V10.08.29 04/11/2016  Peter Vela     TSK 0823385
.           Moved tag for OSTCATG to ADDR0000
. V10.08.28 02/11/2016  Peter Vela     TSK 0823385
.           Added tag for OSTCATG in MISC0000
. V10.08.27 28/10/2016  Ken Bell       TSK 0299071
.           Modified Error RECV/RECU000 for Referral Dates to also apply to NZ
. V10.08.26 27/10/2016  Ebon Clements  TSK 0822228
.           Added PRTYCLAS priority text colour class - WRTHTM00           
. V10.08.25 14/10/2016  Ebon Clements  TSK 0817582
.           Recompiled for VINAHDEF - Notified of first appointment default
. V10.08.24 14/10/2016  Ebon Clements  TSK 0320806
.           Added vina error correction flag cgi - VINAHERR
. V10.08.23 03/10/2016  Ebon Clements  TSK 0826558
.           Use department default label type - PRAL0800
. V10.08.22 28/09/2016  Ebon Clements  TSK 0815342
.           Added rejected/cancelled date edit to unlinked internal            
.           referral list - ULNKR000 
. V10.08.21 15/09/2016  Ebon Clements  TSK 0822282
.           Added nz tag for overdue referrals list display - OVRT0000
. V10.08.20 02/09/2016  Ebon Clements  TSK 0320806
.           Recompiled for PATCODTM - Include inactive codes
. V10.08.19 18/08/2016  Jill Parkinson TSK 0822940
.           Changed to allow 400 records on lists
. V10.08.18 11/08/2016  Peter Vela     TSK 0823842
.           Added nz tag for referrals list
. V10.08.17 26/07/2016  Ania P         CAR 819009
.           Recompile for MEHHONTM
. V10.08.16 08/07/2016  Jill Parkinson TSK 0822002
.           Recompiled for PATMASTM
. V10.08.15 28/06/2016  Nicole Torrisi TSK 0816561
.           Changes to CHKPRI00 and setting of SAVEPRIM
. V10.08.14 21/06/2016  Ebon Clements  TSK 0246291
.           Fix loop when copy medications, supplies, notes contacts and
.           interventions.
. V10.08.13 17/06/2016  Ebon Clements  TSK 0820933
.           Fixed read of referral to get department for label print - ALBT0000
. V10.08.12 09/06/2016  Ebon Clements  TSK 0246291
.           Copy medications, supplies and notes to new contact when using
.           quick re link functions -  ALLLNK30 and ALLLNK40
. V10.08.11 31/05/2016  Nicole Torrisi TSK 0816561
.           Added CHKPRI00 remote script
.           Changed ADDREF88 error message
.           09/06/2016  Peter Vela     TSK 0820521
.           Recompiled for PMSRUGTM
. V10.08.10 08/06/2016  Don Nguyen     TSK 0323386
.           Modified WRTHTM00 to output Presenting Complaint column data.
.           Added PTCOLUMN for Presenting Complaint display flag.
. V10.08.09 27/05/2016  Ebon Clements  TSK 0819688
.           Output dates PMRUPSDT and PMRUPEDT without formatting - RTABW000
. V10.08.08 20/05/2016  Ebon Clements  TSK 0813012
.           Added auto reject program referral functionality - RMAS0000
. V10.08.07 18/05/2016  Ebon Clements  TSK 0813012
.           Show create program button for waiting, active and rejected
.           referrals - PROG0000
. V10.08.06 28/04/2016   Ebon Clements  TSK 0813977   
.           Added resposible and referring HCP to renewal audit - RNTB0000
. V10.08.05 27/04/2016   Ebon Clements  TSK 0813977   
.           Added display of created date/time to referral renewal - RNTB0000
. V10.08.04 21/04/2016   Jill Parkinson TSK 0817301   
.           Changed QLD assessment list to use either Cat A or Cat CC
. V10.08.03 20/04/2016   J.Tan          TSK 0814716   
.           Mods Usual PRFA catg tc to update PRFA details (PTCNNEWC)
. V10.08.02 19/04/2016   Jill Parkinson TSK 0817301   
.           Added QLD care type assessment list options (QLDCAR00)
. V10.08.01 19/04/2016   Ania P            CAR 319862
.           Further business rules for Assessments
. V10.07.16 17/03/2016  Peter Vela     CAR 0814969
.           Added indicator to OUTCTY00, to display all Clinic Types
. V10.07.15 10/03/2016  Peter Vela     CAR 0815454
.           Added tag for rejected referral comment field
.           Added tag for cancel refferal comment field
. V10.07.14 03/03/2016  Ania P         CAR 319862
.           Fixed update of record key in ASCORE94
. V10.07.13 23/02/2016  Nicole Torrisi CAR 246291
.           Fixed cancelling of contacts when moving visits between referrals
. V10.07.12 23/02/2016  Ania P         CAR 323728
.           Separated FIM/GEM Assessment Links to
.           point to separate update tempaltes.
. V10.07.11 03/02/2016  Ania P         CAR 323964
.           Fixed update of record key in ASCORE60
. V10.07.10 03/02/2016  Ania P         CAR 323978
.           Fixed update of record key in ASCORE90
. V10.07.09 03/02/2016  Ania P         CAR 323968
.           Fixed update of record key in ASCORE94 
. V10.07.08 01/02/2016  Peter Vela     CAR 0809314
.           Added ALREPURC to OUTAPP00
.           28/01/2016  Ania P         CAR 319862
.           Reversed below change after spec edit 
. V10.07.07 04/01/2016  Ania P         CAR 319862
.           Uncommented Phase of Care button in RTABW500
. V10.07.06 04/12/2015  Ania P         CAR 299199
.           Added ALREUFR1 to WRTHTM00          
. V10.07.05 01/12/2015  Peter Vela     CAR 324184
.           Changed error message at ASCOR992
. V10.07.04 16.11.2015  Ebon Clements  CAR 320392
.           Recompiled for ALLREFTM - New user defined date/time tags
. V10.07.03 16.10.2015  Ebon Clements  CAR 321253
.           Added active/inactive indicator to AH letters
. V10.07.02 06/10/2015  Ebon Clements  CAR 316633
.           Added link waiting list to referral functionality
. V10.07.01 05/10/2015  Ebon Clements  CAR 316634
.           Added Allow only one Waiting/Active Primary Referral by department
.           functionality for NZ
. V10.06.21 30/09/2015  Peter Vela     CAR 320143
.           Clear ALLEID variables before write to table
. V10.06.20 17/09/2015  Peter Vela     CAR 319784
.           Added validation for episode/internal referral close in CLSREF20
. V10.06.19 27/08/2015  Jill Parkinson CAR 321081 
.           Changed Palliative Care Assessment selection list description 
. V10.06.18 14/08/2015  Ebon Clements  CAR 316109 
.           Added non vinah referral test to create program button display
. V10.06.17 13/08/2015  Don Nguyen     CAR 308621 
.           Recompiled for PATVISTM - Added VISS6100
.           11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.16 06/08/2015  Peter Vela     CAR 320050
.           Fixed Phase End Date tag MISC0180
. V10.06.15 05/08/2015  Peter Vela     CAR 320054
.           Fixed update in ASCORE75
. V10.06.14 24/07/2015  Ebon Clements  CAR 316109
.           Added report 13 - Referral booking comments
.           Added create program button to referral lists - PROG0000
.           29/07/2015  Peter Vela     CAR 320048
.           Recompiled for PMSRUGTM
. V10.06.13 23/07/2015  Ebon Clements  CAR 319781
.           Check master referral status when reinstating 
.           an internal referral - REIS0000
. V10.06.12 21/07/2015  Nicole Torrisi CAR 246291
.           Added unqie HL7TRGIDs into QIKMOV00
. V10.06.11 20/07/2015  Peter Vela     CAR 319533
.           Changed value of "Palliative Problem Severity Scores" to 3
.           in ASTYPE00 and WAHAS000
.           Changed value of "Palliative RUG-ADL" to 3 in ASTYPE00 WAHAS000
.           Changed value of "Maintenance" to 5 in ASTYPE00 and WAHAS000
.           Fixed validation PMRUATYP in RTABW000
.           Commented out call to CTABW000 in WAHAS00
. V10.06.10 13/07/2015  Ebon Clements  CAR 309624
.           Added referral department display - LREFT000 and UREFT000
. V10.06.09 03/07/2015  Don Nguyen     CAR 318942
.           Added PROF1010 - MEH HONOS Details (MHON0000)
.           Corrected MISC0200 to use MHHNHVER instead of MHHNFOCU
.           Modified HTABW000 - removed time from Assessment Date output
. V10.06.08 02/07/2015  Don Nguyen     CAR 316310
.           Modified SUPREF00 to ignore Encounters that are cancelled
. V10.06.07 01/06/2015  Peter Vela        CAR 318842
.           Added ASTYP100 with old values of ASTYPE00 for 
.            allweb0210010/standard
. V10.06.06 04/06/2015  Peter Vela        CAR 315883
.           Fixed default labels and forms in PRNT0000
. V10.06.05 25/05/2015  Davin             CAR 313320 Northland NZ
.           Added TABL0640 - output tag for NHI Domicile DHB Code (NHIDHBDS)
.           Added REMOTE70 - Check if patient's DHB = hospital DHB (CHKDHB00)
. V10.06.04 13/05/2015  Ebon Clements     CAR 303890
.           Added ALLPROFD and open
. V10.06.03 06/05/2015  Patrick Adair    CAR 271541
.           Added AN-SNAP changes for WA Health
. V10.06.02 01/04/2015  Ebon Clements  CAR 310669
.           Removed cancelled booking test from DATR0000, DATK0000, URSR0000 and
.           URSK0000. Cancelled appintments are included in first appointment
.           booked date calculation.
.           31/03/2015  Ebon Clements    CAR 303886
.           Added OP site and clinic type to department tags - EXDEPT00
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer in use
.------------------------------------------------------------------------------
. V10.05.22 23/02/2015  Peter Vela     CAR 311583
.           Fixed old goto bug in LINKC000
. V10.05.21 23/02/2015  Peter Vela     CAR 311583
.           Added wahealth indicator for LINKT400
.           23/02/2015 Ebon Clements   CAR 303884
.           Added nodelete cgi and tag
. V10.05.20 12/12/2014  Ebon Clements  CAR 308254
.           Added inactive until date and class for tablesort - INADIS00
. V10.05.19 08/12/2014  Ebon Clements  CAR 305618
.           Added VINAHDEF - Default VINAH field functionality
. V10.05.18 14/11/2014  Ebon Clements  CAR 292656
.           Added ability to link/unlink cancelled OP visit to a referral
.           21/10/2014  Nicole Torrisi CAR 246291
.           Fixed use of SHOWCONT
. V10.05.17 15/10/2014  Ebon Clements   CAR 291413
.           Recompiled for ALLRNWFD - Completed status
. V10.05.16 10/10/2014  Ebon Clements   CAR 301492
.           When reactivating a referral set active date to today if blank
.           ACTREF00
. V10.05.15 10/10/2014  Ebon Clements   CAR 301523
.           Added Z70 test to ALREF107 ALREHOSP move in update referral UPDREF00
. V10.05.14 07/10/2014  Nicole Torrisi  CAR 303684
.           Changed ULNKT0000 to use PMVXUDF1 for presenting complaint
. V10.05.13 03/10/2014  Ebon Clements  CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
. V10.05.12 30/09/2014  Nicole Torrisi CAR 246291
.           Corrected MISC0000 numbering and column 39 in RLRW0000
. V10.05.11 30/09/2014  Nicole Torrisi CAR 246291
.           Added Quick relink of referral to different visit
.           Added Quick relink of encounter to different visit
. V10.05.10 23/09/2014  Ebon Clements   CAR 306160
.           Delete referral renewal records on deletion of a referral SUPDEL00
. V10.05.09 23/09/2014  Ebon Clements   CAR 306160
.           Added ALCNCLNK Allow cross campus linking of referrals to OP
. V10.05.08 22/09/2014  Ania P          CAR 305746
.           Added SORTFLAG unpack to ALLH0410
. V10.05.07 15/09/2014  Ebon Clements   CAR 291413
.           Added report 12 - Renew referral expiry date audit
. V10.05.06 11/09/2014  Ebon Clements   CAR 291413
.           Recompiled for ALLREFFD -  Added renew referral expiry date
. V10.05.05 03/09/2014  Don Nguyen      CAR 305074
.           Modified ADDPEI00 to exclude non-discharged visits as well as only
.           include visits (admission dates) within the report date range.
. V10.05.04 28/08/2014  Ania P          CAR 304023
.           Added output for ALREOUTP
. V10.05.03 26/08/2014  Ania P          CAR 303210                     
.           Recompiled for MEHHONFD                                   
. V10.05.02 22.08.2014  Peter Vela      CAR 301644
.           Added multihospital to UREFT000 ULNKT000
. V10.05.01 01.08.2014  Patrick Adair   CAR 298078
.           Added new default letter templates to Referral Department for NZ
. V10.04.25 08.07.2014  Peter Vela      CAR 303246
.           Added functionality to drop out of ALRL0000/RLRW0000
.           to avoid looping display of >200 records error messaged
. V10.04.24 04.07.2014  Peter Mc        CAR 298491 
.           Prevent  runaway read in Clinical Doc list   ALCD0000
. V10.04.23 25.06.2014  Ania P          CAR 301554
.           Added output 37 in RLRW0000 - New sort order for allweb0202001
. V10.04.22 30/05/2014  Don Nguyen      CAR 301735
.           Modified ADDPEI00 to NOT write record if NOT Inpatient visit type
. V10.04.21 27/05/2014  Patrick Adair   CAR 298078
.           Added printing of referral patient GP letters (PRAL0000)
. V10.04.20 22/05/2014  Don Nguyen      CAR 301238
.           Added ability to record 'Waiting' audit action (ALAUUPDT)
.           21/05/2014  Ania P          CAR 298135
.           Added PROFLD13
. V10.04.19 16/05/2014  Patrick Adair   CAR 298073/298077
.           Recompiled for changes to ALLREFTM     
. V10.04.18 15/05/2014  Steve Armstrong CAR 285465
.           Recompiled for changes to ALLHDTFD
. V10.04.17 14/05/2014  Ebon Clements   CAR 299072
.           Added group contacts and OP visits exits tag TABL0000
. V10.04.16 09/05/2014  Ebon Clements   CAR 298138
.           Added remote script to check for future linked OP visits CHKOUT0
. V10.04.15 06.05.2014  Ania P          CAR 208234
.           Added sections for new contract code tables
. V10.04.14 28/04/2014  Ebon Clements   CAR 294603
.           Added referral out / cancel date edit to cancel referral NDAT0000
.           Added referral out / reject date edit to reject referral JDAT0000
.           Added cancelled/Rejected date edit to referral date
. V10.04.13 07/04/2014  Ebon Clements   CAR 294603
.           Added referral out and close date edit to close referral ODAT0000
. V10.04.12 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.11 03/04/2014  Ebon Clements   CAR 296599
.           Fixed linked primary referral test - VALMAS00
. V10.04.10 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.09 24/03/2014  Patrick Adair     CAR 256037
.           Recompiled for changes to ALLREFTM
. V10.04.08 14/03/2014  Don Nguyen        CAR 285773
.           Recompiled for changes to ALLENCTM
.           27/02/2014  Don Nguyen        CAR 291879
.           Call WIPL0000 for add Referral (ADDREF00)
. V10.04.07 06/02/2013  Peter Vela        CAR 295606
.           Added ALCNDAMR to AMAS0000
. V10.04.06 30/01/2014  Ebon Clements     CAR 295598
.           Fixed read of referral file for Barthel scores - ASCORE82
. V10.04.05 16/01/2014  Ebon Clements     CAR 285465
.           Added CG ind 21 test to combined internal department list - DEPI0000
. V10.04.04 14/01/2014  Ania P            CAR 289882
.           Changed LTHS0000 to use RSALLHI3 and read backwards.
. V10.04.03 13/01/2014  Ebon Clements     CAR 295598
.           Added allow contacts on primary referrals test  - UREFT200
. V10.04.02 09/01/2014  Don Nguyen        CAR 286304
.           Added calls to ADDPEI00 - add new PRS2 inc/exc file record
. V10.04.01 17/12/2013  Ania P            CAR 293541
.           Added output for ALREPRCM
.------------------------------------------------------------------------------
. V10.03.94 11/12/2013  Patrick Adair     CAR 292200
.            Corrected report option 10 to display Barthel scores correctly
. V10.03.93 21/11/2013  Patrick Adair     CAR 256107
.           Added Claim Code to Contact list - EVTR0000
. V10.03.92 20/11/2013  Ebon Clements     CAR 294205
.           Fixed selection list value for FIM scores - ASTYPE00
. V10.03.91 31/10/2013  Ebon Clements     CAR 293103
.           Removed clinic id and type edits from link referral to OP visit
.           function - ULNKT000 and UREFT000
. V10.03.90 31/10/2013  Ebon Clements     CAR 286042
.           Recompiled for ALLREFTM - Problems/Other factors affecting health 
. V10.03.89 21/10/2013  Patrick Adair     CAR 237397
.           Added extra referral field for CT default status in OP - OUTAPP00
. V10.03.88 11/10/2013  Patrick Adair     CAR 289129
.           Added extra referral status filter options for REVT0000 & NREV0000
. V10.03.87 10/10/2013  Patrick Adair     CAR 237397
.           Added extra referral field for Doctor defaults in OP - OUTAPP00
. V10.03.86 09/10/2013  Ebon Clements  CAR 275205
.           Added EBS unknown U/R edits to limit U/R usage
. V10.03.85 09/10/2013  Patrick Adair     CAR 269767
.           Amended VALMASOO to process master referrals correctly.
. V10.03.84 08/10/2013  Don Nguyen        CAR 286923
.           Added tests on OVRCD around reads of alleidaf. Added EIDEXIST.
. V10.03.83 08/10/2013  Don Nguyen        CAR 286923
.           Added processing for Extra Inbound Referral Data table (alleidaf)
.           Added Report 11 (BOKINS00), VNOT0000
. V10.03.82 02/10/2013  Peter Vela        CAR 291757
.           Recompiled for ALLREFTM
. V10.03.81 23/09/2013  Patrick Adair     CAR 269767
.           Do not re-activate closed linked referral if Primary ref is closed
. V10.03.80 06/09/2013  Don Nguyen        CAR 285773
.           Modified WRSE0000 to use ALENSDEP if populated
. V10.03.79 05/09/2013  Peter Vela        CAR 290696
.           Commented out validations for Referral Expiry Date in UNLNKT000
.           and UREFT000
. V10.03.78 30/08/2013  Don Nguyen        CAR 273426
.           Added check in ALRL0000 for Non-VINAH referrals to exclude from 
.           VINAH views.
. V10.03.77 16/08/2013  Patrick Adair     CAR 290378
.           Correct call for ALLH0410, ALLH0420 and ALLH0430
. V10.03.76 13/08/2013  Patrick Adair     CAR 289276
.           Added filtclid check to ALLH0340 for correct clinic id
.           filter defaulting to match other filters (as per EC)
. V10.03.75 12/08/2013  Ebon Clements     CAR 286042
.           Recompiled for ALLREFTM - Problems/Other factors affecting health 
. V10.03.74 12/08/2013  Nicole Torrisi    CAR 272671
.           Changed LNKR0000 to prevent linking outpatient appointments to
.           cancelled/rejected referrals
. V10.03.73 09/08/2013  Patrick Adair     CAR 289338
.           Added ALREUFR1 to various table outputs
. V10.03.72 08/08/2013  Ebon Clements     CAR 289850
.           Added replace space with zero to ALDEUAHP tag - ALDEDT12
. V10.03.71 30/07/2013  Ebon Clements    CAR 283202
.           Recompiled for PMSPX2TM - Preferred method of contact
.           29/07/2013  Ebon Clements     CAR 284419
.           Added do active encounters exist for this referral tag -  TABL0510 
. V10.03.70 25/07/2013  Ebon Clements     CAR 289177
.           Increased LINKVIST and UNLKVIST arrays for 99 from 250
. V10.03.69 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.68 02/07/2013  Ania P            CAR 287457
.           Added check for HCP 11,12,13 to MVPMI000.
. V10.03.67 30/06/2013  Davin             CAR 279183
.           Recompiled for changes to hl7 messaging (allquefd)
. V10.03.66 26/06/2013  Ebon Clements     CAR 284897
.           Added referral date to referreal in received date edit - RECU0000
. V10.03.65 17/06/2013  Ebon Clements  CAR 244879   
.           Update outbocaf referral date from supervisor referral update
. V10.03.64 05/06/2013  Jill Parkinson CAR 282743   
.           Added HTAB000 - Assessment list including HONOS
. V10.03.63 04/06/2013  Ania P            CAR 285833
.           Added output for ALLDEPFD.ALDEUAHP
. V10.03.62 27/05/2013  Ebon Clements     CAR 274967
.           Added referral date edit to unlinked referral list - ULNKR000
. V10.03.61 24/05/2013  Ebon Clements     CAR 284419
.           Added vinah related referral test to referral list - VVEW0000
. V10.03.60 22/04/2013  Patrick Adair    CAR 234212
.           Ouput Case Team Description
. V10.03.59 17/05/2013  Don Nguyen       CAR 285039
.           Now also clear ALREDREV and ALREUC33 in ACTREF00 (Activate Referral)
. V10.03.58 16/05/2013  Ebon Clements    CAR 284897
.           Added referral date to referreal in received date edit - RECV0000
. V10.03.57 07/05/2013  J.Tan            CAR 284694
.           Mods Overseas Student PRFA to default to Local address
. V10.03.56 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.55 22/04/2013  Patrick Adair    CAR 234212
.           Added NZ functionality to display Case Team in table
. V10.03.54 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.53 25/03/2013  Peter Vela     CAR 282472
.           Fixed Preferred Site and Hospital @ RLRW0000
. V10.03.52 19/03/2013  Jill Parkinson CAR 282814    
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.51 18/03/2013  Ebon Clements     CAR 282203 
.           Added edit so you can't close a VINAH master referral unless one if 
.           its linked espisode referrals has a contact - CLSREF00
. V10.03.50 18/03/2013  Peter Vela        CAR 277267
.           Commented out SOP referral validation in FAPD0000
. V10.03.49 13/03/2013  Peter Vela        CAR 279686
.           Added VINAH Referral List functionality to ALRL0000
.           08/03/2013  Ania P            CAR 282155
.           Added functionality if NZ template: Hide Sex/DOB/UR and show 
.           "Must Be Seen By Date"
. V10.03.48 04/03/2013  Ebon Clements     CAR 282076
.           Fixed update of referral in service type - REFU0000
. V10.03.47 29/01/2013  Peter Vela        CAR 277267
.           Changed first booked date in FAPD0000
.           17/01/2013  Ebon Clements    CAR 262292
.           Recompiled for PATVISTM - Interpreter tag
.           Added visit based interpreter functionality
.           23/01/2013  Don Nguyen        CAR 267587
.           Added ALRL0000 to output Referral List by Master - Internal groups
. V10.03.46 16/01/2013  Ania P           CAR 278201
.           Added filtclid check to ALLH0320/ALLH0330 for correct clinic id 
.           filter defaulting
. V10.03.45 16/01/2013  Don Nguyen        CAR 266855
.           Added PROFLD38,PROFLD39,ADDR0220,MISC0020.
.           Added cgi vars for Add Referral template; ALLRF019, ALLRF022, etc...
.           Fixed ADDR0110 for case F1=1.
. V10.03.44 17/12/2012  Ebon Clements     CAR 247890
.           Added deftview cgi and comments to patient level referral list
. V10.03.43 07/12/2012  Ebon Clements     CAR 263296
.           Added close master referral warning tag - CMAS0000
. V10.03.42 10/12/2012  Ebon Clements     CAR 261630
.           Removed port number from temp file name
. V10.03.41 07/12/2012  Ebon Clements     CAR 276272
.           Pack sacsvisn with SP70 in setpar to fix SP70 test
. V10.03.40 06/12/2012  Steve Armstrong   CAR 272756
.           Recompiled for changes to ALLHDTFD for VINAH8
.           Added longer redirec1 cgi for nextpage 7 redirect
. V10.03.39 15/11/2012  Ebon Clements     CAR 256224
.           Changed Date Active to current date in URSR0000
. V10.03.38 14/11/2012  Peter Vela        CAR 275029
.           Recompiled for PATFIMTM
. V10.03.37 30/10/2012  Ania P           CAR 273662
.           Added filter to tag %ALLWEB02.01.026 
.           (show status of Active/Waiting/Both('All') records)
. V10.03.36 23/08/2012 J.Tan              CAR 263723
.           Mods updating PRFA
. V10.03.35 15/08/2012 Ebon Clements      CAR 261277
.           Assigned new cat code to ALREUC32
. V10.03.34 03/08/2012  Peter Vela        CAR 267421
.           Changed Date Active to current date in URSK0000
. V10.03.33 27/07/2012  Ebon Clements     CAR 267412
.           Don't display cancelled, inactive or rejected referrals on the
.           unlinked referral list - UREFT000
. V10.03.32 27/07/2012  Peter Vela        CAR 267858
.           Added tag for Palliative Care referral
. V10.03.31 27/07/2012  Ebon Clements     CAR 268691
.           Fixed referral date active for first linked booking - URSK1000
. V10.03.30 11/07/2012  Nicole Torrisi   CAR 256420
.           Fixed updating/writing of outbokcf.otbcrdat when linking/unlinking visit to referral
. V10.03.29 09/07/2012  Nicole Torrisi   CAR 256420
.           Corrected OBAOUTNO to ADMISSNO when updating/writing outbokcf.otbcrdat
. V10.03.28 09/07/2012  Nicole Torrisi   CAR 256420
.           Corrected ADMISSNO to OBAOUTNO when updating/writing outbokcf.otbcrdat
. V10.03.26 06/07/2012  B.G.Ackland
.           New Tags for AJAX Calls from iPAD for
.            1. List Encounters for a Referral
. V10.03.25 05/07/2012  Don Nguyen       CAR 264682
.           Added TABL0470 - Output whether or not there is a Residential Adm
. V10.03.24 02/07/2012  Nicole Torrisi   CAR 256420
.           Added setting/clearing of outbokcf.otbcrdat when linking/unlinking a visit from a referral
. V10.03.23 25/06/2012  Nicole Torrisi   CAR 259239
.           Changed prevent linking outpatient appointments to cancelled/rejected referrals
. V10.03.22 19/06/2012  Nicole Torrisi   CAR 260245
.           Changed to allow supervisor deletion of referral with cancelled encounters
. V10.03.21 25/05/2012  Ebon Clements    CAR 255924
.           Added group contacts exist edit to delete referral - SUPDEL00
. V10.03.20 23/05/2012  Ebon Clements     CAR 250153
.           Added patient folder suffix to referral sort lists
. V10.03.19 23/05/2012  Don Nguyen        CAR 264682
.           Added ALDEDT00 for other Patient Referral Details display tags
. V10.03.18 02.05.2012  Ebon Clements     CAR 261277
.           Added add combined referral functionality
. V10.03.17 01.05.2012  Ebon Clements     CAR 261277
.           Populate first linked uncounter tag - TABL0440
. V10.03.16 26.04.2012  Ebon Clements     CAR 261277
.           Populate first appointment booked on SOP int referral - FAPD0000
. V10.03.15 24.04.2012  Jill Parkinson    CAR 264099
.           Added INVADMNO to CLRPAR00                     
. V10.03.14 13.04.2012  Peter Vela        CAR 261277
.           Added Update Referral In Service Type REFU0000
. V10.03.13 12.04.2012  Ebon Clements     CAR 261277
.           Auto activate master referral if internal is activated  - AMAS0000
. V10.03.12 12/04/2012  Don Nguyen     CAR 261277
.           Added ADDR0160 to output Referral Link indicator
. V10.03.11 11/04/2012  Don Nguyen     CAR 261277
.           Recompiled for ALLREFTM
. V10.03.10 10/04/2012  Ebon Clements  CAR 261277
.           Fixed date active when only encounters exist - URSK9200 & URSR9200
. V10.03.09 28/03/2012  Peter Vela     CAR 261277
.           Recompiled for ALLREFTM
. V10.03.08 15/02/2012  Patrick Adair    CAR 243516
.           Added LISTFLAG, ALLH0410, ALLH0420 & ALLH0430 to cater for new 
.           referral search templates allweb0201025/6/7
. V10.03.07 14/02/2012  Patrick Adair    CAR 259054
.           Amended error message for NZ to read Encounters rather than Episode
.           REJREF95 and CANREF95
. V10.03.06 06/02/2012  Peter Vela      CAR 258382
.           Added tag for Disaster Description
. V10.03.05 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.04 04/01/2012  Ebon Clements   CAR 253762
.           Don't save OPD actions for hospital based OPD users 
. V10.03.03 20/12/2011  Ebon Clements   CAR 257419
.           Recompiled for IBAWEBCD - Hospital security redirect
. V10.03.02 21/11/2011  Nicole Torrisi  CAR 249793
.           Added setting/clearing of outbokcf.otbcrdat when linking/unlinking
.           outpatient referrals
. V10.03.01 17/11/2011  Mike Laming     CAR 240184
.           Changes to IBAPOSTF Post Code table - added State to Keys
. V10.02.19 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.18 03/10/2011  Ebon Clements  CAR 252187
.           Fixed visit extn file hospital id - ALREF107 - UPVX0000
. V10.02.17 29/09/2011  Jill Parkinson CAR 248486
.           Recompiled for IBAWEBCD - Restrict hospital access
. V10.02.16 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.15 12/09/2011  Ebon Clements    CAR 248726
.           Added remote script to get departments clinic types -  OUTCTY00
. V10.02.14 01/09/2011  Ebon Clements    CAR 242014
.           Added outpatient direct functionality
. V10.02.13 02.09.2011  Peter Vela       CAR 249285
.           Added Disaster Codes functionality
. V10.02.12 30.08.2011  Saroeun Soeur    CAR 246157
.           added ALLEV180 to change referral status
. V10.02.11 28/08/2011  Peter McMullen   CAR 248857 
.           show priority description in referrals on waiting list 
. V10.02.10 27/07/2011  Ebon Clements    CAR 242070 
.           Added PMSVX141 - funding source
. V10.02.09 19/07/2011  Ebon Clements    CAR 242070 
.           Added hospital and preferred site filters to referral lists
. V10.02.08 19/07/2011  Ebon Clements    CAR 242070 
.           Restored ALREF107 hospital functionality
. V10.02.07 30/06/2011  Ebon Clements    CAR 243794
.           Added extra referral fields for Enc defaults in OP - OUTAPP00
. V10.02.06 02/06/2011  Ebon Clements    CAR 239551
.           Added triage referral functionality
. V10.02.05 09/05/2011  Ebon Clements    CAR 240720
.           Added requested appointment functionality
. V10.02.04 05/05/2011  Ebon Clements    CAR 239576
.           Recompiled for ALLRHLTM - Removed referral in place
. V10.02.03 28/04/2011  Ebon Clements    CAR 239576
.           Added edit checks to transition care dates add and update
. V10.02.02 05/04/2011  Ebon Clements    CAR 239576
.           Allow one waiting/active/inactive master ref per VINAH department
. V10.02.01 R05/042011  Peter McMullen   CAR 237535
.           Delete compensible claims if ref claim code not compensible.
. V10.01.10 22/03/2011  Ebon Clements    CAR 239576
.           Added transition care dates functionality
. V10.01.09 21/03/2011  Jill Parkinson   CAR 239574
.           Increased printer variables
. V10.01.08 17/03/2011  Ebon Clements    CAR 239576
.           Recompiled for ALLREFFD - User defined date 10
. V10.01.07 15/03/2011  Jill Parkinson   CAR 238493
.           Changed report option 10 to allow inpatient FIM scores
. V10.01.06 03/02/2011  Ebon Clements     CAR 236328
.           Added case end date to error description - SACR9200
. V10.01.05 05/01/2011  Ebon Clements     CAR 235441
.           Added referral closed date/time test to ULNKT000 and UREFT000
. V10.01.04 24/08/2010  Mike Laming       CAR 195158
.           Add "filtteam" to NEXTGR00 & PREVGR00 for Case Team filter
. V10.01.03 03/12/2010  Ebon Clements     CAR 232285
.           Added DNA appointments to unlinked visit list - ULNKT000
. V10.01.02 17/11/2010  Jill Parkinson    CAR 233088
.           Increased PTMAS038 from 10 to 19
. V10.01.01 09/11/2010  Mike Laming       CAR 232086
.           Added code to change Hospital (ALREHOSN) when required in TRNREF00
. V10.00.16 21/09/2010  Ebon Clements     CAR 227078
.           Clear enc service description if service code blank - WRSE0000
. V10.00.15 30/08/2010  Mike Laming       CAR 228896
.           Added test for Cancelled Encounters in CDAT0000     
. V10.00.14 24/08/2010  Mike Laming       CAR 195158
.           Recompiled for PATMASTM - Legal Status Icon changes
. V10.00.13 18/08/2010  Davin             CAR 223805
.           Recompiled for PATVISTM
. V10.00.12 17/08/2010  Peter Vela        CAR 223793
.           Added Folder colours to sortlists in ALRDIS00
. V10.00.11 11/08/2010  Saroeun Soeur     CAR 227480
.           fixed presenting complaint LINKT400 - PMVXUDF1 instead of
.           ALREPRCM            
. V10.00.10 11/08/2010  Mike Laming       CAR 226078
.           Add "Responsible HCP to LINKR000 & ULNKR000, Add test for Referral
.           already linked at ULNKR700
. ......... 10/08/2010  Mike Laming       CAR 223963
.           Correct DAYSEP statement in NRVDIS00 - typo in ALREDREV variable
. ....      Change Referring HCP to Responsible HCP for NZ only in NREV0000
. V10.00.09 06/08/2010 Ebon Clements      CAR 227474
.           Added case team filter to next a prev button url
. V10.00.08 03/08/2010 Saroeun Soeur      CAR 227414
.           remove class=IconButton from EVTR0030 HTML output
. V10.00.07 02/08/2010 Ebon Clements      CAR 225750
.           Fixed pack of KEY8 in supervisor referral delete - SUPDEL00
. V10.00.06 16/07/2010 Ebon Clments       CAR 186250
.           Added TRNREF00 transfer a referral functionality
. V10.00.05 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.04 28/05/2010  Steve Armstrong   CAR 220289
.           Recompiled for changes to ALLHDTFD
. V10.00.03 22/04/2010  Steve Armstrong   CAR 220289
.           Recompiled for changes to ALLHDTFD
.           10/05/2010  Ebon Clements     CAR 220289
.           Added report 10 - Referral assessment scores
. V10.00.02 31/03/2010  Mike Laming  CAR 217575
.           Recompiled for changes to MEHDIAFD
. V10.00.01 01/02/2010  Steve Armstrong   CAR 135505
.           Added DGCLII12, DGCLII13 and DGCLII14 triggers.
.           Also added HL7TRGID & HL7INCLD setting for all broadcast messages.
.------------------------------------------------------------------------------
. V9.12.28  21/01/2010  Peter Vela    CAR 211798
.           Added date validation for HONOS @ CLSREF00
. V9.12.27  05/01/2010  Ebon Clements CAR 213439 
.           Don't allow deletion of a ref if reported to DHS for SACS - SUPDEL00
. V9.12.26  10/12/2009  Ebon Clements CAR 212145
.           Added close date edit check with the referral date CLSREF00
. V9.12.25  02/12/2009  Saroeun Soeur CAR 202063
.           LTHS0000 - added Tag for letter history audit
. V9.12.24  24/11/2009  Saroeun Soeur CAR 210857
.           Recomplied for  ALLREFTM
. V9.12.23  24/11/2009  WeeLee Koo    CAR 209759
.           Display date active only when ALRESTAT= 0.
. V9.12.22  23/11/2009  WeeLee Koo    CAR 209759
.           Fixed active referrals with date active blank (URSK9100)
.           Fixed active referrals with date active blank (URSR9100)
. V9.12.21  20/11/2009  Ebon Clements CAR       
.           Fixed syntax error on OP ref letter list - PATREF00
. V9.12.20  13/11/2009  Saroeun Soeur CAR 207550
.           added ALRH0000.  PROFL29 - report 2 and PROFLD36 - report 3
. V9.12.19  11/11/2009  WeeLee Koo    CAR 209764
.           Fixed PMSVX1AF.PMVXCDTE when adding referral.(ADDREF70)
.           Fixed PMSVX1AF.PMVXLUPD when updating referral. (UPVX0000)
. V9.12.18  26/10/2009  Ebon Clements CAR 192758
.           Added combined status filters and class to APRL0000 and PATREF00
. V9.12.17  22/10/2009  Ebon Clements CAR 189209
.           Fixed js error one table sort lists when security is summary only
. V9.12.16  20/10/2009  Ebon Clements CAR 207663
.           Fixed date inactive until test - INAREF00
. V9.12.15  14/10/2009  Ebon Clements CAR 206908
.           Perform sacs link edits on supervisor update if NZ- SACL0000
. V9.12.14  05/10/2009 Sandra Barcham CAR 207122
.           Read security id in ALLCD000 using obpcinus not opcindt (input date)
. V9.12.13  30/09/2009  Saroeun Soeur CAR 205298
.        used ALREHCP instead of ALREFHCP in subroutines-OVRDIS00 and OVRT0000
. V9.12.12  29/09/2009  Mike Laming  CAR 205366
.           Add other Primary Referrals to the Linked/Unlinked list in ULNKR000
. V9.12.11  25/09/2009  Mike Laming  CAR 173274
.           Recompiled for ALLENCTM - added Icons to Referral/Encounters List 
. V9.12.10  23/09/2009  Mike Laming  CAR 205251
.           Add test to allow NZ Ref.Status to stay "Active" if no Encounters at
.           URSK9000 & URSR9000
. V9.12.09  25/08/2009 Ebon Clements CAR 202965
.           Added visit based CDM details to the referral list - APRL0000
. V9.12.08  18/08/2009 Ebon Clements CAR 193151
.           Added contract and type/link to waiting and active ref lists
. V9.12.07  30/07/2009 Jill Habasque CAR 145706
.           Added DEPD0000 - copy of ARFD0000 without hospital checking
. V9.12.06  21/07/2009 Jill Habasque CAR 145706
.           Mods to check pmvxingp for gp access list
. V9.12.05  01/07/2009 Saroeun Soeur CAR 199907
.           created tag for close all health ref. %ALLWEB02.02.233
.           TABL0330, subroutine AUDC0000
. V9.12.04  26/05/2009 Saroeun Soeur CAR 194317
.           created subroutine ALBT0000 - all health labels, dynamic selection
.           by all health department default labels
. V9.12.03  27/05/2009 Ebon Clements CAR 190873
.           When closing a SACS master check all linked internal referral
.           closed date/times are not after the SACS master close date or
.           case end date - SACR0000
.           If SACS master is closed only allow linking of closed internal
.           referrals that are within the case start/end date range - ULNKR000
. V9.12.02  07/05/2009 Ebon Clements CAR 190873
.           Added edit so you can't have more than one waiting SACS referral
.           to the supervisor update and status updates
. V9.12.01  06/05/2009 Jill Habasque CAR 145706
.           Added pmsvx010 cgi
. V9.11.09  07/04/2009 Peter Vela    CAR 183976
.           Move spaces to PMVXPILC before WRPMVX11
. V9.11.08  25/02/2009 Ebon Clements CAR 187703
.           Added hospital security tests to department selection lists
.           DEPF0000 and ARFD0000
. V9.11.07  19/02/2009 Ebon Clements CAR 188155
.           Ignore cancelled encounters in get last encounter - GTLENC00
. V9.11.06  16/02/2009 Peter Vela    CAR 183976
.           Move spaces to PMVXPOEC before WRPMVX11
. V9.11.05  11/02/2009 Mike Laming   CAR 189239
.           Recompiled for ALLREFTM - add Tag for Cat."S " for Healthscope
. V9.11.04  27/01/2009 Mike Laming   CAR 182798
.           Fix Case Team Description code at APRL1750
. V9.11.03  07/01/2009 Ebon Clements CAR 184260
.           Added all referrals list - ALRT0000
. V9.11.02  31/10/2008 Peter McMullen CARS 91011, 174725
.           make inline javascript W3C compliant, fix reload function
. V9.11.01  20/10/2008 Ebon Clements CAR 181115
.           Write missing mehvisaf records when updating MEH referrals-UPMEH000
. V9.10.06  01/07/2008 Mike Laming   CAR 143777
.           Clear DOCFNAME (referring Doctor namefield) at APRL1720
. V9.10.05  20/06/2008 Ebon Clements CAR 148734
.           Added primary/sacs referral description to ACTDIS00
. V9.10.04  03/06/2008 Ebon Clements CAR 155717
.           Added edit so you can't have more than one waiting SACS referral
. V9.10.03  02/06/2008 Ebon Clements CAR 169690
.           Allow addition of active referrals to temp ur numbers if not public
. V9.10.02  02/06/2008 Ebon Clements CAR 169077
.           Added quotes to value in the department selection list ARFD0000
. V9.10.01  15/05/2008  Mike Laming  CAR 152286
.           Recompiled for ALLREFTD & ALREFTM - RCH Edu.Institute changes
. V9.09.28  25/04/2008  Mike Laming  CAR 141199
.           Added RedButton code for List-EOC, Notes & Extern.Refs in TABL0000
. V9.09.27  20/03/2008 J.Tan         CAR 156964
.           Added User ID, Create date/time to mehdiaaf
. V9.09.26  04/03/2008 Ebon Clements CAR 163115
.           Recompiled for ALLREFTM - Date inactive until tag
. V9.09.25  12/02/2008 J.Tan         CAR 135498
.           Mods for MHINC Extract
. V9.09.24  05/02/2008 Ebon Clements CAR 159354
.           Added preferred site to sort table referral list
. V9.09.23  31/01/2008  Mike Laming    CAR 152286
.           Change PATEORFD fields' prefix to PTER (from PTEO - is ICD10)
. V9.09.22  30/01/2008 Ebon Clements CAR 159934
.           Fixed cancel referral so it will use the cgi for the date cancelled
. V9.09.21  29/01/2008 Ebon Clements CAR 135498
.           Added ALCNMDES - master referral description 
. V9.09.20  24/01/2008 Ebon Clements CAR 159945
.           Don't update referral created by when updating referral details
. V9.09.19  17/01/2008 Ebon Clements CAR 159268
.           Added health fund member number to pmi update
. V9.09.18  20/12/2007  J.Tan         CAR 135498
.           Mods for NZ MHINC Extract
. V9.09.17  19/12/2007 Ebon Clements CAR 157606
.           Changed status description of Open to Active
. V9.09.16  12/12/2007  Ebon Clements CAR 157462
.           Added health fund and table to pmi update
. V9.09.15  07/12/2007  Ebon Clements CAR 149304
.           Added BSTATUS to OPReferralLink() link
. V9.09.14  28/11/2007  Mike Laming   CAR 145553
.           Added Report 09 - Issues and Issues Details Table ALLISSaf
. V9.09.13  10/10/2007  J.Tan         CAR 135498
.           Mods to ignore deleted record status for MHINC(Commented out)
. V9.09.12  19/09/2007  Ebon Clements CAR 149442  
.           Added remote script OUTAPP00 - get appointment defaults
. V9.09.11  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
. V9.09.10  07/09/2007  Ebon Clements CAR 149445
.           Added red highlight to inactive until date for table sort - INADIS00
. V9.09.09  07/09/2007  Davin         CAR 149192
.           Display 'No more Encounters' at the bottom of nz encounter lists
. V9.09.08  31/08/2007  Ebon Clements CAR 149108
.           Fixed display of referral status in PATREF00
. V9.09.07  27/08/2007  Ebon Clements CAR 148809
.           Added group contact enrolment list by U/R - PTAB0000
. V9.09.06  24/08/2007  Ebon Clements CAR 133923
.           Changed department selection lists to be in alphabetical order
. V9.09.05  15/08/2007  Ebon Clements  CAR 125966  
.           Added cancel linked booking functionality on close of a referral
. V9.09.04  25/07/2007  Ebon Clements  CAR 122389  
.           Fixed test for active encounters in CANREF00
. V9.09.03  24/07/2007  Jill Habasque  CAR 140983  
.           Added REVDIS00 - Next Review Date lists
. V9.09.02  23/07/2007  Ebon Clements  CAR 140983  
.           Added ALCNACTW - Auto activate a single waiting referral
.           for the same department when closing a referral
. V9.09.01  12/07/2007  Jill Habasque  CAR 135504  
.           Added PATREF00 - OP/AH Referral list
. V9.08.21  21/05/2007  Ebon Clements  CAR 141095  
.           Fixed loop to generate external referral number in EXTREF10
. V9.08.20  17/05/2007  Ebon Clements  CAR 140983  
.           Added event program to the referral file
. V9.08.19  17/04/2007  Jill Habasque  CAR 135528
.           Added printing of referral letters and labels (PRAL0000)
. V9.08.18  11/04/2007  Ebon Clements  CAR 135527
.           Added skip of sacs tests if NZ
. V9.08.17  04/04/2007  Ebon Clements  CAR 135530
.           Added report 8 - external referrals
. V9.08.16  02/04/2007  Neelkamal Pyla CAR 135735
.           Changed Index in SRFL0000 to Sort the records based on 
.           'Referral Received Date' and added code to SACDIS00 to display 
.           'Referral Received Date'.
. V9.08.15  28/03/2007  Ebon Clements  CAR 135526
.           Added WRSE0000 last 5 encounter list for a referal
. V9.08.14  23/03/2007  Neelkamal Pyla CAR 133020
.           Modified SRFL000 to display the "No More Entries" indicator only
.           on the last page of matching entries.
. V9.08.13  16.03/2007 Ebon Clements  CAR 135528  
.           Added referral label printing functionality to PRNT0000
. V9.08.12  15/03/2007 Jill Habasque  CAR 135513  
.           Added write to mehvi1af
. V9.08.11  14/03/2007 Ebon Clements  CAR 135522  
.           Added filters,c/code,case team,resp HCP and linked ref to APRL0000
. V9.08.10  13/03/2007 Jill Habasque  CAR 135519  
.           Added alldadaf - referred from/to codes
. V9.08.09  27/02/2007 Ebon Clements   CAR        
.           Added new tag ACTT0000 display referral actions          
. V9.08.08  23/02/2007 Ebon Clements   CAR 132585 
.           Only write view referral audit records when viewing allweb0202002
.           Added a new update type for referral actions to audit
. V9.08.07  01/02/2007 Ebon Clements   CAR 132483 
.           Added close/last enc date edit checks to CLSREF00 
. V9.08.06  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.05  19/01/2007  Neelkamal Pyla CAR 123428
.           Added SACR0000 in CLSREF00 to check for Waiting/Active SACS linked
.           Referrals
. V9.08.04  15/01/2007  Neelkamal Pyla CAR 120448
.           Changed the index to ALLREFA6 in SRFL0000 to display records based
.           on Department and Referral Status
. V9.08.03  16/11/2006  Ebon Clements  CAR 122378 122022
.           Added read of websecaf at ARFD0000 to ensure correct hospital id
.           Added rejected status to ASHTST00 and fixed cancel/reject sacs edits
. V9.08.02  19/10/2006  Ebon Clements  CAR 119559
.           Recompiled for PATCODTM - Include/Exclude cat codes with indicator
. V9.08.01  29/09/2006  Ebon Clements  CAR 119933
.           Don't set ALREDACT to current date if cgi ALREF004 if populated
. V9.07.08  15/08/2006  Ebon Clements  CAR 112175
.           Allow multi hospital A/H department with a blank hospital
. V9.07.07  02/08/2006  Ebon Clements  CAR 113925
.           Added case review date to the referral and encounter files
. V9.07.06  05/07/2006  Ebon Clements  CAR 109701
.           Display free format HCP details in APRL0000 if no coded HCP
. V9.07.05  04/07/2006  Ebon Clements  CAR 102413
.           Fixed closed and cancelled referral list date checks.
.           It is now by referral date not date closed/cancelled
. V9.07.04  30/06/2006  Ebon Clements  CAR 110034
.           Fixed edit check in reactivate referral - ACTREF00 
. V9.07.03  30/06/2006  Ebon Clements  CAR 110034
.           Changed WRTHTM00 to display ALREUC34 description not code
. V9.07.02  29/06/2006  Ebon Clements  CAR 108363
.           Added referral notes available tag - TABL0180
. V9.07.01  28/06/2006  Peter Vela     CAR 110110
.           Added direct read of alldepaf ALLEVT40
.           Added tag for ALDESREQ
. V9.06.02  31/05/2006  Chandan Navara CAR 102408
.           Added SUPREF00(Supervisor Update Referral) is changed for Referral
.           date mustbe lessthan or equal to earliest EOC date.
. V9.06.01  18/05/2006  Ebon Clements CAR 105049
.           Added multi hospital test to ARFD0000
. V9.05.02  13/04/2006  Ebon Clements CAR 99070
.           Changed CLSREF00 to allow closing of a waiting referral
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B15 20/02/2006  Ebon Clements CAR 76341
.           Added referral and encounter file audits
. V9.05.B14 10/02/2006  Ebon Clements CAR 76341
.           Added ALREUC34 appointment type to waiting referral list
. V9.05.B13 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B12 23/01/2006 Mike Laming    CAR 76341
.           Added Templated Forms - PRNT0000 
. V9.05.B11 11/01/2006 Mike Laming    CAR 76341
.           Added 'Referral letters & Labels' - PRNT0000 
. V9.05.B10 09/01/2006 Davin          CAR 76341
.           Added 'SACS Referral List' (srfl0000 & sacdis00)
. V9.05.B09 21/12/2005 Mike Laming    CAR 76341
.           Add "Other Active Referrals" Indicator & List to WRTHTM00
. V9.05.B08 20/12/2005 Ebon Clements  CAR 76341
.           Key length changes for encounter number
. V9.05.B07 14/12/2005 Ebon Clements  CAR 76341
.           Added reinstate referral functionality
. V9.05.B06 14/12/2005 Ebon Clements  CAR 76341
.           Added edits for linked SACS referrals to supervisor functions
. V9.05.B05 14/12/2005 Ebon Clements  CAR 76341
.           Added type / linked referral description to APRL0000
. V9.05.B04 14/12/2005 Ebon Clements  CAR 76341
.           Added rejected referral functionality
. V9.05.B03 13/12/2005 Ebon Clements  CAR 76341
.           Added edit to check for internal referrals when cancelling SACS ref
. V9.05.B02 09/12/2005      Ebon Clements  CAR 76341
.                           Added SACS referral functionality
. V9.04.32  07/12/2005      Davin S        CAR 87257
.                           Changed 'gp suburb' tag (argp0000) to use practice
.                           suburb if a practice exists against the patient pmi
. V9.04.31  29/11/2005      Davin S        CAR 86572
.                           Added broadcast PMI update message calls (dgclicup)
. V9.04.30  17/10/2005      Ebon Clements  CAR 76132
.                           Added edit check for active referrals when 
.                           using the reactivate function
. V9.04.29  17/10/2005      Ebon Clements  CAR 76170
.                           Added edit so you can't cancel a referral
.                           with an active EOC
. V9.04.28  07/09/2005      Ebon Clements  CAR 73702
.                           Added active status check to department
.                           selection list ARFD0000
. V9.04.27  05/09/2005      Ebon Clements  CAR 72916
.                           Added EXIT=2 to WEBWAR00 to fix fifo not found
. V9.04.26  01.10.2005      Ebon Clements  CAR 72916
.                           Recompiled for IBAWEBCD - fifo not found date/time
. V9.04.25  19.08.2005      J.Tan          CAR 62750
.                           Removed redefined amount variables
. V9.04.24  26.07.2005      Davin          CAR 68945
.                           Recompiled for ALLREFTM - provider number tag change
. V9.04.23  04.07.2005      Ebon Clements  CAR 66205 
.                           Unlinked referrals should not have an exiry date.
.                           Added calculate expiry when linking and unlinking.
. V9.04.22  09.06.2005      Ebon Clements  CAR 63045
.                           Changed APRL0000 to get the provider number from 
.                           pmshclaf not pmshcpaf
. V9.04.21  30.05.2005      Davin          CAR 22680
.                           Added default provider number tag (gdhcp000)
. V9.04.20  25.05.2005      Ebon Clements  CAR 62018
.                           Mods to DEFMBS00 for the auto apply clinic default
.                           CMBS items template to booking
. V9.04.19  23.05.2005      Ebon Clements  CAR 62018
.                           Recompiled for ALLRITFD - Added provider usage
.                           Davin          CAR 22680
.                           Recompiled for ALLREFTM - Changed hcp practice & 
.                           provider number tags
. V9.04.18  17.05.2005      Ebon Clements  CAR 60889
.                           Recompiled for ALLREFTM - Allow delete of dates     
. V9.04.17  17.05.2005      Ebon Clements  CAR 60889
.                           Removed zzzzzz tests from filtclid and added default
.                           of filtclid from user id to all lists
.                           Added report 6 for remote scripts
. V9.04.16  13.05.2005      Ebon Clements  CAR 60929
.                           Recompiled for IBAWEBCD - User department tag
. V9.04.15  09.05.2005      J.Tan          CAR 6112
.                           Highlight if no medicare details
. V9.04.14  04.05.2005      Ebon Clements  CAR 61122
.                           Added BookingLink to referral list               
. V9.04.13  02.05.2005      J.Tan          CAR 60991
.                           Mods redirect to referral master after adding ref
. V9.04.12  27.04.2005      J.Tan          CAR 60929
.                           Updating expiry date as referral type changed
.                           J.Tan          CAR 60991
.                           Added focusflg for 'Add referral' screen
. V9.04.11  27.04.2005      J.Tan          CAR 60889
.                           Added filters (clinic id & type) to all referrals
. V9.04.10  22.04.2005      Ebon Clements  CAR 56697
.                           Fixed bug in SPRIT000 save of mbs items
. V9.04.09  23.03.2005      Ebon Clements  CAR 56375
.                           Recompiled for new field ALREPRDT - Priority date
.           10.03.2005      Davin          CAR 56697
.                           Added 'default mbs' remote script (for HIC claims)
. V9.04.08  10.02.2005      Ebon Clements  CAR 56666 53675 56665 56682 56673
.                           Mods for HIC claims
. V9.04.07  31.01.2005      Guomin Fu      CAR 37051
.                           Mods to security setup to allow user to be able to
.                           drill down to view, amend patiens when user is from
.                           the department selected. For details for different 
.                           senarios of security setting, refer to doc attached
.                           in touchpaper.
. V9.04.06  22.11.2004      Ebon Clements  CAR 55239
.                           Recompiled for ALLREFTM and added FILTTEAM
.           09.11.2004      Peter Vela     CAR 53371
.                           Recompiled for PATVISTM
. V9.04.05  07.10.2004      Ebon Clements  CAR 54111
.                           Mods to open correct outpatient prefixed files
. V9.04.04  09.09.2004      Lina Vo        CAR 53211
.                           Changed web security to use old GP Code Field
. V9.04.03  08.09.2004      Lina Vo        CAR 53211
.                           Changed web security to use new GP Code Field
. V9.04.02  31.08.2004      Ebon Clements  CAR 53089
.                           Populate hospital id in referral and visit extn when
.                           creating new referrals
. V9.04.01  18.08.2004      Lina Vo        CAR 52746
.                           Added open of pathspaf and included PATHSPFD & IO 
.                           for PATVISTM              
. V9.03.08  01.07.2004      Ebon Clements  CAR 51243
.                           Unlock referral file if weberror received
. V9.03.07  07.06.2004      Peter Vela     CAR 49016
.                           2004 Statutory Changes - Recompiled for PMSPX2TM
. V9.03.06  26.03.2004      Peter Vela     CAR 13038
.                           Recompiled for PATDOCCD - Doctor Name format 
.                           Parameter
. V9.03.05  10.03.2004      Ebon Clements  CAR 46515
.                           Added outpatient site to the referral file
.                           Fixed PVISITE allocation in ADDREF00
. V9.03.04  10.02.2004      Ebon Clements  CAR 47360
.                           Changed cancel,active and closed referral lists
.                           to use index 6
. V9.03.03  11.12.2003      Peter Vela     CAR 40355
.                           Recompiled for PATNAMCD
. V9.03.02  14.07.2003      Davin          CAR 37388
.                           Added addtnl ERC fields file to add/update referrals
.                           Tracey Nguyen  CAR 40986
.                           Recompiled for ALLREFTM.PBL
. V9.03.01  29.05.2003      Lina Vo       CAR 37504
.                           Write SLA/ASGC code from ibapostf to visit
.                           extension table for allied health referrals.
.------------------------------------------------------------------------------
. v9.02.38  04.04.2003      Tracey Nguyen CAR 37501
.                           Added Supervisory Referral Delete option
.           04.04.2003      Ebon Clements  SRF 37705
.                           Changed ADDREF70 to read the vist file when
.                           generating visit numbers
. V9.02.37  31.03.2003      Jill Habasque SRF 37658 
.                           Added lock of controlf when generating new visit no.
. V9.02.36  11.03.2003      Lina Vo       SRF 37177 
.                           Changed deceased patient msg to warning only. 
.                           Set EXIT=2 to call WEBWAR00 to display warning. 
.                           Set WINCLFLG=1 when REDIRECT is empty for WEBWAR00.
. V9.02.35  24.01.2003      Tracey Nguyen SRF 22693 
.                           Added PTCNUEOC & Modified ALLREF00 to append 
.                           admissno to REDIRECT.
. V9.02.34  05.12.2002      Lina Vo       SRF 22709
.                           Added OPNOUT00 to open outpatient file
. V9.02.33  25.10.2002      Lina Vo       SRF 23710
.                           Recompile for ALLREFTM
. V9.02.32  03.10.2002      Peter Vela    SRF 17693
.                           Recompiled for PATVISTM - Admitting Point
. V9.02.31  29.06.2002      Ebon Clements 19121 
.                           Added supervisor referral update option
. V9.02.30  31.05.2002      Ebon Clements 18229
.                           Added trap if sigpipe
. V9.02.29  18.05.2002      Ebon Clements 17796
.                           Added edit checks to allow referrals to be added  
.                           to a deceased patient before the date of death
. V9.02.28  15.05.2002      Ebon Clements 17468
.                           Added new key to ALLREFFD - for active referrals
. V9.02.27  03.04.2002      Ebon Clements
.                           Recompiled for CLALLREF - move zero to ALREBULK  
. V9.02.26  13.03.2002      Ebon Clements
.                           Recompiled for ALLREFTM - selection list orders  
. V9.02.25  07.03.2002      Ebon Clements
.                           Changed Active referral list to use the referral
.                           date not the date activated.
. V9.02.24  06.03.2002      Ebon Clements
.                           Fixed referral lists to use GETCOD00
. V9.02.23  04.03.2002      Ebon Clements
.                           Added a new tag for all active referrals ALAC0000
. V9.02.22  01.03.2002      Ebon Clements
.                           Changed ADDREF00 so the ALRERDAT can be set from
.                           a cgi variable if you like.
. V9.02.21  18.02.2002      Ebon Clements
.                           Fixed keys for referral lists 
. V9.02.20  08.02.2002      Ebon Clements
.                           Move zero to F1 not SP70 in referral lists
. V9.02.19  06.02.2002      Ebon Clements
.                           Fixed template map from update screens
.                           Assign ALREDEPT a value with cgi alredept
. V9.02.18  02.02.2002      Ebon Clements
.                           Recompiled for ALLREFTM - inactive codes
. V9.02.17  14.12.2001      Ebon Clements
.                           Set AGEDATE before calling calcage
. V9.02.16  05.12.2001      Ebon Clements
.                           Added indicator 1 cat TP to waiting sort list
. V9.02.15  04.12.2001      Katie Nelson/Harvinder   SRF 648628(nz)
.                           Recompiled for NHI tags added to PATMASTM
. V9.02.14  30.11.2001      Raghunandan Surve - HPS 
.                           Fixed active referrals for diff. security levels
. V9.02.13  21.11.2001      Raghunandan Surve - HPS 
.                           Fixed date sorting
. V9.02.12  20.11.2001      Raghunandan Surve - HPS 
.                           Referrals sorted, fixed cancelled referrals     
. V9.02.11  17.11.2001      Raghunandan Surve - HPS 
.                           Referrals sorted     
. V9.02.10  13.11.2001      Ebon Clements 
.                           Recompiled for ALLREFTM - job number ALREUNO2     
. V9.02.09  12.11.2001      Ebon Clements 
.                           Clear allprraf file variables if overcond on read
. V9.02.08  09.11.2001      Ebon Clements 
.                           Stop referral creation for deceased patients
. V9.02.07  31.10.2001      Ebon Clements 
.                           Pack ALLRF001 with SP70 when cgi is set
. V9.02.06  27.10.2001      Ebon Clements 
.                           Set value of ALREDEPT when cgi ALLRF001 is used to
.                           add a referral so template map works.
. V9.02.05  09.10.2001      Ebon Clements 
.                           Add code so duplicate problem codes can't be used
. V9.02.04  06.10.2001      Glenn Saunders
.                           Use different Patient Folder icons from PATFLD00
. V9.02.03  11.09.2001      Ebon Clements 
.                           Changed priority from category TP to PR
. V9.02.02  08.09.2001      Sandra Barcham
.                           Add Calcage before PTLN0000
. V9.02.01  22.08.2001      Ebon Clements
.                           Changed referral lists to show problem not status   
. V9.01.04  14.08.2001      Ebon Clements
.                           Added update of referral status on waiting referrals
. V9.00.03  14.08.2001      J.Tan
.                           Recompiled for PATMASTM
. V9.00.02  13.08.2001	    Ebon Clements
.                           Recompiled for ALLREFTM                 
. V9.00.01  09.08.2001	    J.Tan
.                           Fixed Visit system for Allied Health
. V9.00.B12 25.07.2001	    HPS
.			    Modification for the Active and Inactive ref.
.                           Defect no - 107-R1 
. V9.00.B11 24.07.2001	    HPS
.			    Defect 89 - Add file button
. V9.00.B10 19.07.2001      HPS
.                           Defect No.s
.                            (45 72, 87, 92, 107, 109, 110)

. V9.00.B09 18.07.2001      HPS
.                           Defect No.s
.                            (1 16 17 18 20 24 25 46 48 64 65 66
.                              68 74 85  86 94  97 98  99 103 105 106)
.
. V9.00.B08 15.07.2001      Sandra Barcham
.                           Replace GP with HCP
.
. V9.00.B05 10.07.2001      HPS (Sunil)
.                           Fixed Department filters Defect Nos. 15, 20, 27
. V9.00.B04 06.07.2001      HPS
.                           Fixed the clinic type drop down list
.                           changed (ALLREFTM- ARFCTY00)
. V9.00.B03 05.06.2001      Ebon Clements
.                           Fixed some next and prev buttons
. V9.00.B02 05.06.2001      Ebon Clements
.                           Fixed up defaults on tags
. V9.00.B01 14.06.2001      B.G.Ackland
.                           Recompile for Changes to PATMASTM
. V9.00.B00 28/5/2001       HPS
.                           Created Program
.------------------------------------------------------------------------------
          INC       IBAWEBDF
          INC       WEBDATDF
          INC       ACCAUDFD/INC            * New ACC Audit file
          INC       ACCDIAFD/INC            * Accident Claim via PATCLMTM
          INC       ALLAEFFD/INC
          INC       ALLCCTFD/INC
          INC       ALLHDTFD/INC
          INC       ALLLNKFD/INC
          INC       ALLBIAFD/INC
          INC       ALLBIATD/INC
          INC       ALLCASFD/INC
          INC       ALLDADFD/INC
          INC       ALLEIDFD/INC
          INC       ALLEXTTD/INC
          INC       ALLEXTFD/INC
          INC       ALLGROFD/INC
          INC       ALLGRPFD/INC
          INC       ALLGPAFD/INC
          INC       ALLGREFD/INC
          INC       ALLQUEFD/INC
          INC       ALLREFFD/INC
          INC       ALLRSAFD/INC            * Residential Admissions
          INC       ALLSASFD/INC
          INC       ALLSASTD/INC
          INC       ALLAUDFD/INC
          INC       ALLCONFD/INC
          INC       ALLDEPFD/INC
          INC       ALLDLLFD/INC
          INC       ALLDIAFD/INC
          INC       ALLISSFD/INC            * AH (Patient) Issues Details
          INC       ALLLINFD/INC
          INC       ALLLETFD/INC
          INC       ALLLPCFD/INC
          INC       ALLRLNFD/INC
          INC       ALLPROFD/INC
          INC       ALLPRRFD/INC
          INC       ALLRITFD/INC
          INC       ALLRNWFD/INC
          INC       ALLRNWTD/INC
          INC       ALLSERFD/INC
          INC       ALLSTSFD/INC
          INC       ALLTMPFD/INC
          INC       ALLADSFD/INC
          INC       ALLRIOFD/INC
          INC       APSMASFD/INC
          INC       DISMASFD/INC
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
          INC       EMRICDFD/INC        * Diagnosis Codes for PATCLMTM
          INC       EMRLOCFD/INC        * Emergency location          *T0881801
          INC       EMRVISFD/INC        * Emergency visit             *T0881801
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       IBAALVFD/INC
          INC       IBAPOLFD/INC
          INC       IBAPOSFD/INC
          INC       IBALPCFD/INC
          INC       OUTARTFD/INC
          INC       OUTCTYFD/INC
          INC       OUTCLIFD/INC
          INC       OUTDCOFD/INC        * OP direct comments
          INC       OUTDANFD/INC        * OP direct actions
          INC       OUTDANTD/INC
          INC       OUTBOAFD/INC
          INC       OUTBOCFD/INC
          INC       OUTCONFD/INC
          INC       OUTRSHFD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       MEHCJAFD/INC
          INC       MEHLEGFD/INC
          INC       MEHDIAFD/INC
          INC       MEHHONFD/INC
          INC       MEHHLSFD/INC
          INC       MEHDLSFD/INC
          INC       MEHVI1FD/INC
          INC       PATASFFD/INC
          INC       PATATRFD/INC        * Patient Atrributes
          INC       PATCONFD/INC
          INC       PATCMCFD/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATEORFD/INC
          INC       PATDADFD/INC
          INC       PATITMFD/INC
          INC       PATRE1FD/INC
          INC       PATVADFD/INC
          INC       PATIN1FD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PATNIDFD/INC
          INC       PMSCEXFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPFD/INC
          INC       PMSIMPTD/INC
          INC       PMSIMPFD/INC
          INC       PMSPX2TD/INC
          INC       PMSPX2FD/INC
          INC       PMSQPTFD/INC
          INC       PATVISFD/INC
          INC       PMSVX1FD/INC
          INC       ALLAEFTD/INC
          INC       ALLEIDTD/INC
          INC       ALLREFTD/INC
          INC       ALLENCTD/INC
          INC       ALLISSTD/INC
          INC       ALLEMDFD/INC            * medications details file
          INC       ALLITVFD/INC            * intervention details file
          INC       ALLSUPFD/INC            * supplies details file
          INC       ALLWLNFD/INC
          INC       PATDSCFD/INC
          INC       ALLMEDFD/INC
          INC       ALLMDTFD/INC
          INC       ALLMTXFD/INC
          INC       ALLITMFD/INC
          INC       PATCALAG/INC
          INC       OUTCANFD/INC
          INC       OUTDCHFD/INC
          INC       OUTMA1FD/INC
          INC       OUTSITFD/INC
          INC       PATALRFD/INC
          INC       PATMI1FD/INC
          INC       PATPR1FD/INC
          INC       PATFIMFD/INC
          INC       PATFIMTD/INC
          INC       MEHHONTD/INC
          INC       PMSMMSFD/INC
          INC       PMSMMSTD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       MLTSECFD/INC
          INC       MLTSITFD/INC
          INC       MRTMASFD/INC
          INC       PATDHEAD/INC
          INC       PMSAIDFD/INC
          INC       PMSADWFD/INC
          INC       OBSPCOFD/INC
          INC       OBSPCTFD/INC
          INC       OPRNURFD/INC
          INC       ALLENCFD/INC
          INC       ALLERCFD/INC
.
          INC       PMSCDNFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCLTD/INC
          INC       PMSHCPTD/INC
.          INC       PMSIPLFD/INC
          INC       PMSCURFD/INC
          INC       PMSCCDFD/INC            * Concession Card Details
.
          INC       OUTRF1FD/INC
.
.         INC       PATGPCFD/INC
.         INC       PATGPPFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PRIITMFD/INC
          INC       VISMTXFD/INC
          INC       VISMDTFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       ALLRHLFD/INC
          INC       ALLRHLTD/INC
          INC       ALLLHIFD/INC
.
          INC       PATWC1FD/INC
          INC       PMSWX1FD/INC
          INC       PATWMAFD/INC
          INC       PATWVEFD/INC
          INC       PMSCTCFD/INC
          INC       TFILEVAR/INC
          INC       PATPEIFD/INC
          INC       PMSRUGFD/INC
          INC       PMSRUGTD/INC
          INC       WATTR1FD/INC
          INC       PATMISTD/INC
          INC       PATMASTD/INC
          INC       TIMEDIFW/INC
          INC       OUTBB1FD/INC
.------------------------------------------------------------------------------
. CGI Parameters
.------------------------------------------------------------------------------
ACCPORDN  DIM       20
AEFFLAG   FORM      1                       * write to aef file? (0=No/1=Yes)
ACTIVREF  FORM      1                       * Activate referral
ALENCOMT  DIM       160                     * Encounter Comments
ALLOWLNK  FORM      1
DEFTVIEW  FORM      1
DISPDACT  DIM       12
DISPDAT2  DIM       11                      * Display date
DISPSTAT  DIM       11
DISPTYPE  DIM       30
DISPTYP2  DIM       30
DISPORTY  DIM       20
DISPNRTY  DIM       20
DISPRUID  DIM       30
DISPRRID  DIM       30
DISPCUID  DIM       30
DISPUUID  DIM       30
EPAUDFLG  FORM      1             * Episode audit flag
EXPRFLAG  DIM       1             * Show expiry date red
.                                    0 = no audits written
.                                    1 = before audit written
AUTOCMBS  FORM      1                       * Auto apply cmbs template
.------ *T0865480-start
AUTOCPRF  FORM      1             * Auto Copy/Close Referral
.                                   1 = Copy Primary ref to linked ref 
.                                   2 = Close Primary ref from linked ref
.------ *T0865480-end
BLNKFLAG  FORM      1
BOOKDATE  DIM       8                       * Date to calc ref expiry from
BOOKONLY  FORM      1
BOOKSTAT  DIM       9
BOOKWARN  DIM       1                       * Check for unlinked bookings 
BSTATUS   FORM      1
CANCFLAG  FORM      1                       * Linking cancelled booking flag
CANCLDAT  DIM       8
CHKVINAH  DIM       1     * VINAH check exit
REJECDAT  DIM       8
CASEKEYS  DIM       28                      * Outpatient case key
CATel     INIT      "el"                                              *T0881801
CATgb     INIT      "gb"
CATLhp    INIT      "hp"
CATLADES  DIM       20
CATLBDES  DIM       20
CATCG     INIT      "CG"
CATLH     INIT      "lH"
CATpu     INIT      "pu"
CATRF     INIT      "rf"
CATTS     INIT      "ts"
CATZW     INIT      "zW"
CATZG     INIT      "zG"
CHECKREF  DIM       8                       * Auto activate internal referral
CISMFLAG  FORM      1                       * for HL7 messaging
CLASDINU  DIM       7
CLINDATE  DIM       8
CLOSEDAT  DIM       8
CLOSMAST  FORM      1
COMFILVF  FILE      ASCII, FIXED=127        * Booking instruction comments
COMFILNV  DIM       8
CONTDATE  DIM       8                       * Contact Date filter
CONTDESC  DIM       20
CONTFLAG  FORM      1                       * Contacts exist flag 
COPYFLAG  FORM      1
CORSP001  DIM       100
CORSP003  DIM       3
LASTITEM  FORM      3                       * Last Item of FF Notes
LINKSRCH  FORM      1
LISTFLAG  FORM      1
LNKVLOCN  DIM       40                  * Linked Visit Location       *T0881801
LNKVREAS  DIM       40                  * Linked Visit Reason for Adm *T0881801
CATCL     INIT      "CL" 
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATTZ     INIT      "Tz"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
COMFILOF  FILE      ASCII, FIXED=128
COMFILNO  DIM       8
COMMURNO  DIM       8
COMMADAT  DIM       8
COMMATIM  DIM       8
COMMTYPE  DIM       2
CURRVIST  DIM       8
CHNGDATE  DIM       8
CHNGTIME  DIM       8
CHNGPORT  DIM       2
CHNGTYPE  DIM       1
CHNGOPER  DIM       4
DASH      INIT      "-"
DDQCKRLK  FORM      1
EREFRLID  DIM       20
EXPRICON  DIM       1                       * ExpiryIconX.gif
EXPRDATE  DATE      8                       * Expiry Date
FENCDATE  DIM       8                       * First encounter date
FRSTREAD  FORM      1
IBAMFLAG  FORM      1                       * for HL7 messaging
ICONLNK3  DIM       1                       * HTMLLNK3 icon name
INVADMNO  DIM       8
THETKEYS  DIM       23
RIAUDFLG  FORM      1             * Referral In audit flag
.                                    0 = no audits written
.                                    1 = before audit written
UPDTTYPE  DIM       2
USEINVAD  FORM      1
UNITDESC  DIM       20
VALDDATE  DIM       8
VALDTIME  DIM       8
VINAHERR  DIM       1
VINAHREF  DIM       8
VISDHOSP  DIM       50
VISITDTE  DIM       8                            * Date of Visit
VISITTME  DIM       8                            * Time of Visit
GPACCESS  FORM      1
GPCODE    DIM       10
.
DIM6      DIM       6
DIM24     DIM       24
DIM25     DIM       25
FORM10    FORM      10
NODELETE  FORM      1
NOTETYPE  DIM       3
NOTENUMB  DIM       6
NOTEFILT  DIM       3
NOTEORDR  FORM      1        * note display order
VISNOTES  DIM       100
XFORMAT   FORM      1         * output response format 0-Normal, 1-JSON
.
OVERRIDE  FORM      1                       * Override Warning Message
OVRDDEPT  DIM       1      
OVRDHOSP  DIM       1                       * Override hospital filter
NEXTPAGE  DIM       1                       * Nextpage parameter CGI parameter
REFERRAL  DIM       8                       * Referral for relinking
OTARTKEY  DIM       32                      * Appointment request key
UPDATETY  DIM       1                       * Update Type
.
CTR       FORM      1                       * Counter
DEPTCODE  DIM       3                       * Allied Health Department Code (CG)
DEPTCODD  DIM       3
DEPTINDC  DIM       1
DESCACTV  DIM       8
DESCDEPT  DIM       20
DISPPROV  DIM      12                       * Display provider number
DOCTCODE  DIM      10                       * Doctor Code
DOCFNAM2  DIM       50
DOCFNAM3  DIM       50
DOCFNAM4  DIM       50
DOCFNAM5  DIM       50
DOCFNAM6  DIM       50
DOCINDIC  DIM       1
DBOOKED   INIT     "Booked"
DUBOOKED  INIT     "UnBooked"
DATTEND   INIT     "Attended"
DNOATTN   INIT     "DNA"
ENCOUTKY  DIM       16                      * Encounter Key
ENCCNT    FORM      3
ENCNTRS   DIM       16[999]
ENCTNUMB  FORM      8
ISSUEKEY  DIM       8                       * Issue Key
ISSUENUM  DIM       8                       * Issue Key
.
AURECNT   FORM      1
AUREARCT  FORM      3
AURENAAR  DIM       8[300]
AUREDSAR  DIM       50[300]
AUREBEAR  DIM       60[300]
AUREAFAR  DIM       60[300]
FLDNAME   DIM       8
FLDDESC   DIM       50
FLDVALUE  DIM       60
DATEIN    DIM       8
DATEOUT   DIM       12
DISPCTDL  DIM       1                       * display HCP Category (DL) 
FLAGIN    DIM       1
FLAGOUT   DIM       3
USERIDIN  DIM       10
USERIDOU  DIM       30
PASCDEIN  DIM       4
PASCDEOU  DIM       30
GPATCAT   DIM       2
GPATCODE  DIM       3
GPATDDSC  DIM       30
GPATDESC  DIM       20
CATGNAME  DIM       14
CATEDESC  INIT      "Category" 
GPATFDSC  DIM       44
GHSPCODE  DIM       3
GHSPNAME  DIM       50
GDEPCODE  DIM       3
GDEPDESC  DIM       20
GDIADEPT  DIM       3
GDIACODE  DIM       9
GDIADESC  DIM       40
GPRBDEPT  DIM       3
GPRBCODE  DIM       9
GPRBDESC  DIM       40
GPRODEPT  DIM       3
GPROCODE  DIM       9
GPRODESC  DIM       40
GTEACODE  DIM       10
GTEADESC  DIM       40
GPRCCODE  DIM       10
GPRCCOUN  DIM       2
GPRCNAME  DIM       80
RECTYPE   DIM       14
DATETIME  DIM       16
TEXT100B  DIM       100
TEXT100A  DIM       100
RECFOUND  DIM       1  
CHKTYPE   DIM       1  
.
JAVSNAME  DIM       80
ENDNAME   DIM       80
REMOTSNO  FORM      2                       * Remote script number
VALDTEAM  DIM       10                      * Validate case team 
SAVDIM50  DIM       50
SAVVPRTY  DIM       3
SAVVREFN  DIM       8
SAVVTRGS  DIM       3
STATLOOP  FORM      1
SPACETOS  INIT      " to "
STRTNAME  DIM       80
STATCHEK  FORM      1                       * Referral Status check flag
STRIKETG  DIM       10                      * Strike tag
STRENDTG  DIM       11                      * Strike end tag
SUPERLEV  DIM       1
SAVKEY24  DIM       24
SAVKEY25  DIM       25
SAVKEY28  DIM       28
SAVELDAT  DIM       8
SAVEPSDT  DIM       8
SAVEPEDT  DIM       8
SAVEPRIM  DIM       1
SUPRFLAG  DIM       1                       * Supervisor flag for del pat notes
.
MASTREFN  DIM       8                       * Master referral number
MEHRFLAG  FORM      1
MESSAGID  DIM       20
MHCON001  DIM       10                      * Main Health Condition 1
MHCON002  DIM       10                      * Main Health Condition 2
MHUNQ001  DIM       3                       * Main Health Condition 1 unique no
MHUNQ002  DIM       3                       * Main Health Condition 2 unique no
NUMBITEM  DIM       9                       * item number
LINKEND   FORM      3                       * Last Item of Link visits
LINKVIST  DIM       8[250]                  * Visits to link to a referral
LINKWAIT  DIM       19[250]                 * WL to link to a referral
LINKWEND  FORM      3                       * Last Item of Link WL visits
LINKFLAG  FORM      1
LOSERDES  DIM       20                      * Location Of Service
UNLKEND   FORM      3                       * Last Item of Unlink visits
UNLKVIST  DIM       8[250]                  * Visits to Unlink from a referral
UNLKWAIT  DIM       19[250]                 * WL to Unlink from a referral
UNLKWEND  FORM      3                       * Last WL Item of Unlink visits
UNIQF5    FORM      5
.
CTYPDESC  DIM       30
DISPPRDT  DIM       11
ADEPDESC  DIM       30
OSTADESC  DIM       30
RACTVFLG  FORM      1
RECDSTAT  DIM       2
REDIREC1  DIM       240
REFLINK   DIM       327
REFRLDAT  DIM       8
REFSTATS  DIM       1
REF200IN  DIM       1
RENEWREF  FORM      1                       * Renew SOP episode referral
REQBDEPT  DIM       20
REQUESTB  DIM       30
REASNREQ  DIM       20
PREFHOSP  DIM       50
URNOTEMP  DIM       8                       * Temporary UR
URTEMP    DIM       1                       * Temperory UR No Test code
USERMEMR  DIM       1                       * User Confirmation Var
FLDCLASS  DIM       25
FORM3     FORM      3
FORM8     FORM      8
FOCUSFLG  FORM      1
STATUS    DIM       1                       * Referral Table Status Indicator
INDEXKEY  DIM       1                       * Filter Flag
DEPTSEC   FORM      1                       * Depatment Security Id
DISPDAT1  DIM       11                      * Display date
OPDFLAG   FORM      1
OPDWEND   FORM      2
PMSVX010  DIM       1
PMSVX093  DIM       1                       * Interpreter Required
PMSVX141  DIM       3                       * Funding Source
PREFSITE  DIM       30
HCPCLASD  DIM       3                       * Dr Classification display
HCPCLASF  DIM       3                       * Dr Classification code 
HCPDLDES  DIM       20                      * Dr Classification desc 
PRIOCATE  DIM       2                       * Category priority
PRIMARYE  DIM       1                       * Allow enc in primary ref
PRIMSORT  DIM       35
PROGCODE  DIM       1
PROGDEPT  DIM       3
PRTYCLAS  DIM       10
MBSDESC   DIM       20
CURRDATE  DIM       8                       * Current Date
REFDDESC  DIM       50                  
REFEREAS  DIM       20
REFEREDT  DIM       20
SAVEDEPT  DIM       3
SAVEHCP   DIM       10
SAVEUHC4  DIM       10
SAVEADMI  DIM       8
SAVEVISN  DIM       8
SAVEORTY  DIM       3              * Save Original Type of Ref. (Cat RI)
SAVEOXDT  DIM       8              * Save Original Expiry Date (CCYYMMDD)
SAVEORDT  DIM       8              * Save Original Ref Renewal Date(CCYYMMDD)
SAVIADAT  DIM       8              * Save internal ref date active
SAVISREJ  DIM       3              * Save internal ref reason for rejection
SAVISRDT  DIM       8              * Save internal ref rejection date
SAVISRTM  DIM       8              * Save internal ref rejection time
SAVEORES  DIM       10             * Save Responsible HCP
SAVEORHC  DIM       10             * Save Referring HCP
SAVEORHP  DIM       10             * Save Referring HCP Practice
SAVKEY02  DIM       8              * Save new PTFIM002 variable for database key change
SAVKEY03  DIM       8              * Save new PTFIM003 variable for database key change
SAVEKY16  DIM       16
SAVKEY16  DIM       16
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SAVREPTN  FORM      2
SAVPRGID  DIM       8
SYSTCENT  DIM       2                       * Century
SYSTYEAR  DIM       2                       * Year
SYSTMONT  DIM       2                       * Month
SYSTDATE  DIM       2                       * Date
.
PROVUSGE  DIM       20                      * Provider Usage
PTMAS008  DIM       35                      * Address Line 1 (padd1)
PTMAS009  DIM       35                      * Address Line 2 (padd2)
PTMAS010  DIM       35                      * Address Line 3 (psubrb)
PTMAS011  DIM       35                      * Address Line 4 (padd4)
PTMAS012  DIM       8                       * Postcode (ppost)
PTMAS013  DIM       20                      * Private Telephone (ptelep)
PTMAS023  DIM       10                      * Medicare Number (pmedi)
PTMAS036  DIM       6                       * Health Fund
PTMAS037  DIM       8                       * Health Fund table
PTMAS038  DIM       19                      * Health Fund Member Number
.
PTMSX045  DIM       2                       * Medicare code
.
PATNTKEY  DIM       22                      * Key to Compare index4
FLAG      DIM       3                       * Flag Var
FILTDEPT  DIM       3                       * Department Filter
FILTSTAT  DIM       1                       * Status filter
FILTTEAM  DIM       10                      * HCP Case team code filter
FILTCLID  DIM       6                       * Clinic Id Filter
FILTCTYP  DIM       6                       * Clinic Type Filter
FILTHOSP  DIM       3                       * Hospital Filter
FILTPSIT  DIM       6                       * Preferred Site Filter
FILTTRGS  DIM       3                       * Triage status filter
HTMLLNK2  DIM       127                     * HTML link 2
HTMLLNK3  DIM       127                     * HTML link 3
HTMLLNK4  DIM       127                     * HTML link 4
HTMLLNK5  DIM       127                     * HTML link 5
HTMLLNK6  DIM       127                     * HTML link 6
COMPCATE  DIM       3                       * Compensation Category
PATNKEY1  DIM      27                       * Patient Key
ECOUNTN1  FORM      3                       * Count Key 1
ECOUNTN2  FORM      3                       * Encounter Key
REAFORCL  DIM       2                       * Reason for Closure
OUTCOMLL  DIM       2                       * Outcome
OLDPMM02  DIM       8                       
OLDPMM03  DIM       8
INREASON  DIM       2                       * Inactive Reason (CGI Parameter)
CRDATE    DIM       8                       * Closure Date
CMUN      DIM       2                       * Current Month
CDAT      DIM       2                       * Current Date
CCEN      DIM       2                       * Current Century
CYER      DIM       2                       * Current Year
IAREASON  DIM       3                       * Inactive Reason
ALRCANCL  DIM       2                       * Reason for Cancel
MASUPDFL  FORM      1
MORET200  DIM       20                      * More then 200 (Alert)
COLRFLAG  DIM       1                       * Color Flag
LSTENDAT  DIM       11                      * Last Encounter Date
DISPT001  DIM       9
DISPT002  DIM       20
.
PRVKEY40  DIM       40
NXTKEY40  DIM       40
.
DEPDESC   DIM       20                      * Department Description
DEPTDESC  DIM       20                      * Department Description
DESREQIN  DIM       1                       * SACS Referral Required (Dep)
DISPOVRD  DIM       31                      * Display overdue days
DISPDIAC  DIM       11
DISPCDAT  DIM       11
DISPUDAT  DIM       11
ALSTDESC  DIM       20                      * Status Description
PRIODESC  DIM       20                      * Priority Description
COMPDESC  DIM       20                      * Compensation Description
COUNTER   FORM      3                       * Count Var
TODAY     DIM       8
TODATDY   FORM      6                       * Days Between Two Dates
TIMELOOP  FORM      1                       * Time loop counter
FRDATDY   FORM      6                       * Days Between given Dates
TRIAGDES  DIM       20
TRGSDESC  DIM       20                      * Triage status description
TRNSFHOS  DIM       30
REFSTS    FORM      1                       * Referral Status
.
COUNT     FORM      3                       * Count Var
ACTCDESC  DIM       20                      * Action Description
ACTCCATE  DIM       2                       * Action Category
ALUPDATE  DIM       20                      * Update Variable (Summary Det)
ARUPDATE  DIM       10                      * Update Variable(Audit Table)
ACTNCODE  DIM       3                       * Action Code
ACTVONLY  FORM      1
COMMENTY  DIM       50                      * Comment
ALLAUDKY  DIM       24                      
ACTNDATE  DIM       8                       * Action Date
ACTNTIME  DIM       8                       * Action Time
ACTNADNO  DIM       8                       * Admission/Referral Number
AUDITKEY  DIM       24                      * Audit Key
ALSTATUS  DIM       20                      * Status of the Referral
CATGCODE  DIM       2                       * Category Code
CLNCID    DIM       6
SITECODE  DIM       6
.
ALLRF001  DIM       3                       * Department code
ALLRF019  DIM       11                      * Date of Referral
ALLRF022  DIM       10                      * Referring HCP
ALLRF023  DIM       10                      * Referring Practice
ALLRF024  DIM       2                       * Referring Group Count
ALLRF034  DIM       3                       * Source of Referral
ALLRF035  DIM       3                       * Compensation Code (Cat CL)
ALLRF039  DIM       11                      * Date Referral Received
ALLRF140  DIM       3                       * Purchaser (Cat HP)
ALLRF153  DIM       30                      * Referral Originator
DATASET0  DIM       16
DATASET1  DIM       16
DATASET2  DIM       16
DATASET3  DIM       16
DATASET4  DIM       16
F2A       FORM      2
F3A       FORM      3
F3P2      FORM      3.2
F3B       FORM      3
PREVHON   FORM      1
SECSCORE  DIM       3
TOTDSPLY  DIM       40
TOTSCORE  DIM       3
PRIORITY  DIM       3                       * priority
TEMPDATE  DIM       12                      * temp var to hold date
TEMPRDAT  DIM       8
TEMPDREC  DIM       8
CFILEPRE  DIM       3                       * site prefix
CRRDATE   DIM       8
DIM2A     DIM       2
DIM20     DIM       20
DIM2B     DIM       2
DIM3      DIM       3
DIM5      DIM       5
ITMCOUNT  FORM      2
ITEMN001  DIM       9                       * Item Number 1
ITEMN002  DIM       9                       * Item Number 2
ITEMN003  DIM       9                       * Item Number 3
ITEMN004  DIM       9                       * Item Number 4
ITEMN005  DIM       9                       * Item Number 5
ITEMN006  DIM       9                       * Item Number 6
ITEMN007  DIM       9                       * Item Number 7
ITEMN008  DIM       9                       * Item Number 8
ITEMN009  DIM       9                       * Item Number 9
ITEMN010  DIM       9                       * Item Number 10
ITEMIFLG  DIM       2
ITEMITMN  DIM       9
ITEMSUBN  DIM       3
FBOKDTTM  DIM       24
FBOKDATE  DIM       12
AT        INIT      "at"
TEMPDAT1  DIM       12
TEMPDAT2  DIM       12
TEMPDAT3  DIM       12
PRTPDATE  DIM       8                       * var for formatting the date
DIM4A     DIM       4
DIM8      DIM       8
DIM15     DIM       15
DIM16     DIM       16
DIM16A    DIM       16
LABELALL  INIT      "LABELALL"
REASCLOS  DIM       20
REASINAC  DIM       20
PROBLEM   DIM       40
REFSTAT   DIM       10
REFTDESC  DIM       16
OTHAREFS  FORM      1
TEMPSTAT  DIM       1
LOCKCNT   FORM      1                        * Lock Count
DATETILL  DIM       50
DAYSLIST  FORM      4                        * Days on list
FOLDERSF  DIM       3                        * Patient Folder suffix
HOUR      DIM       2
INTRVISN  DIM       8                        * Link to SACS referrral visit
MIN       DIM       2
NZ        INIT      "NZ"
NZFLAG    DIM       2                        * NZ Template?
SACSVISN  DIM       8                        * Link to SACS referrral visit
SEC       DIM       2
SORTFLAG  INIT      "0"
STATCODE  DIM       1
PRTYSORT  DIM       1                        * Priority sort variable
REFRLVIS  DIM       8
SERVFLAG  FORM      1
STATDESC  DIM       20
VISITTYP  DIM       3
NMPNUMB   DIM       20
NSLOTKEY  DIM       28
WAITST01  INIT      "Unscheduled  "
WAITST02  INIT      "Scheduled    "
WAITST03  INIT      "Pre-Admitted "
WAITST04  INIT      "Admitted     "
WAITST05  INIT      "Discharged   "
WAITST06  INIT      "Removed      "
WAITST07  INIT      "Performed    "
WAITST08  INIT      "Not Performed"
WAITST09  INIT      "Cancelled Booking"
WARCOUNT  FORM      2
WAITLIST  DIM       19
WEBWARNG  DIM       50[10]
WINCLFLG  FORM      1                       * Flag for window close
.
ALDAD001  DIM       5                       * Referred from hospital
ALDAD002  DIM       5                       * Referred to hospital
.
ALRIT001  DIM       2
ALRIT002  DIM       9
ALRIT003  DIM       3
ALRIT004  DIM       2
ALRIT005  DIM       9
ALRIT006  DIM       3
ALRIT007  DIM       2
ALRIT008  DIM       9
ALRIT009  DIM       3
ALRIT010  DIM       2
ALRIT011  DIM       9
ALRIT012  DIM       3
ALRIT013  DIM       2
ALRIT014  DIM       9
ALRIT015  DIM       3
ALRIT016  DIM       20                      * Item 1 provider usage
ALRIT017  DIM       20                      * Item 2 provider usage
ALRIT018  DIM       20                      * Item 3 provider usage
ALRIT019  DIM       20                      * Item 4 provider usage
ALRIT020  DIM       20                      * Item 5 provider usage
.
LNKDRGHT  FORM      1
LABELTYP  DIM       10      * Type of Label To Print Coded Field
STATNCOD  DIM       6       * Stationary Code Coded Field
PRNTTYPE  FORM      1
LETTNCOD  FORM      3
SECTIME   DIM       2
SCHDCOPY  FORM      3       * No of Copies
SCHDPRNT  DIM       6       * Printer
SHOWFLAG  FORM      1
SHOWTITL  FORM      1
SUBSYSKY  DIM       50
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
HOURTM    DIM       2
.                                           * CGI variables for printing
LETTERC   DIM       3
MINTIME   DIM       2
PRINTERC  DIM       6
PRTNEWPT  DIM       1
PRTNEWRF  DIM       1
PRTUPDPT  DIM       1
PRTUPDRF  DIM       1
PRTREJPT  DIM       1
PRTREJRF  DIM       1
PRTREFLB  DIM       1
PRTREFGP  DIM       3
PRTPLET1  DIM       3                       * Letter Code
PRTPFRM1  DIM       6                       * Form/Stationery Code
PRTPCK01  DIM       1                       * Check Box (1=print)
PRTPCK02  DIM       1
PRTPCK03  DIM       1
PRTPCK04  DIM       1
PRTPNO01  DIM       3                       * Number of copies
PRTPNO02  DIM       3
PRTPNO03  DIM       3
PRTPNO04  DIM       3
PRTPNO05  DIM       3
PRTPNO06  DIM       3
PRTPNO07  DIM       3
PRTPSL01  DIM       6                       * Selected Printer number
PRTPSL02  DIM       6
PRTPSL03  DIM       6
PRTPSL04  DIM       6
PRTPSL05  DIM       6
PRTPSL06  DIM       6
PRTPSL07  DIM       6
PRTPSL08  DIM       6
PRTPSIT1  DIM       8                       * Outpatient Visit Site  
PRTPSIT2  DIM       8
PRTPVIS1  DIM       8                       * Outpatient Visit Number
PRTPVIS2  DIM       8
REFERLIN  FORM      1
.
UC34DESC  DIM       20
VISITNO   DIM       8                       * Visit Number
.
MHCARRAY  DIM       9[99]
_MHCCNT   FORM      3                       * main health condition counter 
OFAARRAY  DIM       9[99]
_OFACNT   FORM      3
.
RFDARRAY  DIM       9[99]
_RFDCNT   FORM      3
.
RDAARRAY  DIM       9[99]
_RDDCNT   FORM      3
.
_RFPCNT   FORM      3
RFPARRAY  DIM       9[99]
.
TCDARRAY  DIM       9[99]
_TCDCNT   FORM      3
.
TDDARRAY  DIM       9[99]
_TDDCNT   FORM      3
.
UNIQCODE  DIM       3
XDATTIME  DIM       14     * Date/Time (ccyymmddhhmmss)
DIAGCODE  DIM       9
DIAGCOD2  DIM       9
DIAGDATE  DIM       8
VINAHFLG  FORM      1             * VINAH Flag
.                                   0 = writing after audits in VINAHDEF
.                                   1 = not writing after audits in VINAHDEF
VINREFLS  DIM       1
ZERO1     INIT      "01"
ZERO2     INIT      "02"
ZERO3     INIT      "03"
ZERO4     INIT      "04"
ZERO6     INIT      "000000"
.
DIM50     DIM       50
DIM100    DIM       100
.
LTTITLE   INIT      "  0"      * referral letter title line
VALDPSIT  DIM       6
VALDPDHB  DIM       3
.
REFRTYPE  FORM      1                  * Type of Referral (1=MASTER,2=INTERNAL)
REFRVISN  DIM       8                  * Referral/Visit Number
REFRLNKN  DIM       8                  * Linked Referral Number
.
EIDEXIST  FORM      1
.
HDPEQUIV  DIM       2                  * HDP Equivalent for reason (Cat RN)
.
VISCNT    FORM      2                  * Count of visits in MOVENC00
.
PTCOLUMN  DIM       1        * Display Presenting Complaint flag
.
REFERXID  DIM       20
RECCNT    FORM      3
DIM100A   DIM       100
DIM100B   DIM       100
DIM40     DIM       40
HOSPNAME  DIM       50                 * Hospital Name
INPDATE   DIM       8
OUTDATE   DIM       11
.
CHWCURNO  DIM       8        * Check UR Number (Workers Compensation)
CHWCADMN  DIM       8        * Check Admission Number (Workers Compensation)
.
OUTCARAY  DIM       63[20]
OUTCDESC  DIM       60
.
SAVEDATE  DIM       8        * Supervisor Referral Update Date
.------ *T0865480-start
AUTOCLOS  FORM      1             * Auto Close Referral flag
MULTILRF  FORM      1             * Multi Linked Referral found flag
SAVPRIRF  DIM       8             * Saved Primary referral
.------ *T0865480-end
REFREJCT  DIM       1		  * Flag whether to open reject referral DFrame
SHOWACTV  DIM       1             * Flag for showing active clinics only

.******************************************************************************
PRGID     INIT      "ALLWEB02"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "Allied Health Referral Information Server"
.******************************************************************************
          CALL      WEBINT00                * Initialise FIFO Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      WEBRED00                * Read FIFO WEBPID and USERID
          COMPARE   "999",REPORTNO    * Read Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      GETMAP00          * Get Template Mapping
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
MAIN1020  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
.
          CALL      WEBERR00     * Create Output File and Write HTML File Header
          GOTO      MAIN1000
.
MAIN1100  CALL      ALLLST00                *  Main Action Event
          GOTO      MAIN1000
.
MAIN1200  CALL      ALLEVT00
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      ALLEVT00
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      ALLLNK00                * Link Unlink visits to a referral
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      DEFMBS00                * Get slot MBS default charge
          GOTO      MAIN1000
.
MAIN1600  CALL      REMOTE00                * Remote scripts
          GOTO      MAIN1000
.
MAIN1700  CALL      LNKREF00                * Link Unlink referral to referrals
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      EXTREF00                * External referrals
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      ALISSU00                * Referral (Patient) Issues  
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      ASCORE00                * Assessment scores
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2100  CALL      BOKINS00                * Referral Booking Instructions
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      RENEWR00                 * Renewed referral audit 
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      BOKCOM00                 * Booking instruction comments
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      WATLNK00                 * Link Unlink W/L to a referral
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      ALLAUD00                 * Referral Audit table
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2600  CALL      REFBLK00                 * Referral Bulk Billing
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2700  CALL      RMOT0000                * Remote scripts
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.******************************************************************************
.           Output Next Page Based on CGI Parameter nextpage                  *
.******************************************************************************
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00      * Redirect Parent Content Page
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Content Page
          GOTO      NXTPAG99
.
NXTPAG50  CALL      TOPDIR00      * Top Content Redirect Content Page
          GOTO      NXTPAG99
.
NXTPAG60  CALL      AJAXRD00      * AJAX redirect to return referral number
          GOTO      NXTPAG99
.
NXTPAG70  CALL      PREDRL00      * Redirect Content Page using 
          GOTO      NXTPAG99      * redirect plus redirect1 as the url
.
NXTPAG99  RETURN
.******************************************************************************
.            Redirect Content URL                                             *
.******************************************************************************
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> ":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "</script>"
          CALL      CLOSHTML
.
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.******************************************************************************
.            Redirect Content long URL using cgi redirect plus redirec1       *
.******************************************************************************
PREDRL00  CALL      OPENHTML
          BRANCH    EXIT,PREDRL90
.
          MATCH     SP70,REDIREC1
          IF        !@EQUAL
            STRIP     REDIRECT
            ENDSET    REDIRECT
            STRIP     REDIREC1
            ENDSET    REDIREC1
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> ":
                            " parent.location.href=#"",REDIRECT,REDIREC1,"#";":
                               "</script>"
            RESET     REDIRECT
            RESET     REDIREC1
          ELSE
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> ":
                               " parent.location.href=#"",REDIRECT,"#";":
                               "</script>"
          ENDIF
          CALL      CLOSHTML
.
          GOTO      PREDRL99
.
PREDRL90  DISPLAY   "*** Fifo Not Found ***"
.
PREDRL99  RETURN
.------------------------------------------------------------
. Redirect Content URL 
.------------------------------------------------------------
TOPDIR00  CALL      OPENHTML
          BRANCH    EXIT,TOPDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                               "src=#"../js/Standard.js#"></script>":
                               "<script type=#"text/javascript#" ":
                               "src=#"../js/Custom.js#"></script>":
                               "<script type=#"text/javascript#"> {":
                            " redirectTopContent(#"",REDIRECT,"#");":
                               "}":
                               "</script>"
          CALL      CLOSHTML
          GOTO      TOPDIR99
.
TOPDIR90  DISPLAY   "*** Fifo Not Found ***"
.
TOPDIR99  RETURN
.******************************************************************************
.               Goes back 1 page                                              *
.******************************************************************************
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      OPENHTML
GOBACK99  RETURN
.******************************************************************************
. Open Files and Initialise variables                                         .
.******************************************************************************
INIT0000  CALL      INTMAS00
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATVADA1,"patvadaf"
          OPEN      MEHDIAA1,"mehdiaaf"
          OPEN      MEHHONA1,"mehhonaf"
          OPEN      MEHHONA2,"mehhonaf"
          OPEN      MEHHONA3,"mehhonaf"
          OPEN      MEHDLSA1,"mehdlsaf"
          OPEN      MEHHLSA1,"mehhlsaf"
          OPEN      MEHHLSA2,"mehhlsaf"
          OPEN      MEHDIAA1,"mehdiaaf"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      ALLEXTA1,"allextaf"
          OPEN      ALLHDTA3,"allhdtaf"
          OPEN      ALLLINA1,"alllinaf"
          OPEN      ALLSERA1,"allseraf"
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      ALLRNWA1,"allrnwaf"
          OPEN      ALLADSA1,"alladsaf"
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      OBSPCTA1,"obspctaf"
          OPEN      ALLAUDA1,"allaudaf"
          OPEN      ALLAUDA2,"allaudaf"
          OPEN      ALLAEFA1,"allaefaf"
          OPEN      ALLCCTA1,"allcctaf"
          OPEN      ALLDADA1,"alldadaf"
          OPEN      ALLWLNA1,"allwlnaf"
          OPEN      ALLWLNA2,"allwlnaf"
.
          OPEN      ALLEIDA1,"alleidaf"     * Extra Inbound Referral Data
.
          OPEN      ALLGRPA3,"allgrpaf"
          OPEN      ALLGROA1,"allgroaf"
          OPEN      ALLGPAA2,"allgpaaf"
          OPEN      ALLGREA1,"allgreaf"
.
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLREFA3,"allrefaf"
          OPEN      ALLREFA5,"allrefaf"
          OPEN      ALLREFA6,"allrefaf"
          OPEN      ALLREFA7,"allrefaf"
          OPEN      ALLRSAA1,"allrsaaf"
          OPEN      ALLMDTA1,"allmdtaf"
          OPEN      ALLMTXA1,"allmtxaf"
          OPEN      ALLEMDA1,"allemdaf"
          OPEN      ALLITVA1,"allitvaf"
          OPEN      ALLSUPA1,"allsupaf"
          OPEN      WEBSECA1,"websecaf"
          OPEN      ALLREFA4,"allrefaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATEORA1,"pateoraf"
          OPEN      PATEORA2,"pateoraf"
          OPEN      ALLREFA2,"allrefaf"
          OPEN      WEBSECA1,"websecaf"
          OPEN      ALLRITA1,"allritaf"
          OPEN      ALLPROA1,"allproaf"
          OPEN      ALLPROA2,"allproaf"
          OPEN      ALLPRRA1,"allprraf"
          OPEN      ALLPRRA2,"allprraf"
          OPEN      PATCODE3,"patcodes"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLDIAA2,"alldiaaf"
          OPEN      ALLAUDA1,"allaudaf"
          OPEN      ALLSTSA1,"allstsaf"
          OPEN      ALLDEPA1,"alldepaf"
          OPEN      ALLDLLA1,"alldllaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLENCA6,"allencaf"
          OPEN      ALLISSA1,"allissaf"
          OPEN      ALLITMA1,"allitmaf"
          OPEN      ALLLETR1,"allletaf"
          OPEN      ALLLETR2,"allletaf"
          OPEN      ALLLPCA1,"alllpcaf"
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPATA1,"dispataf"
          OPEN      DISPTLA1,"disptlaf"
          OPEN      MLTSITA1,"mltsitaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      CONTROLF,"controlf"
          OPEN      ALLTMPA1,"alltmpaf"
          OPEN      IBAPOST1,"ibapostf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      ALLCASA1,"allcasaf"
          OPEN      PRIITEM1,"priitemf"
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSADWA1,"pmsadwaf"
          OPEN      ALLRLNA1,"allrlnaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      OUTARTA1,"outartaf"
          OPEN      OUTARTA2,"outartaf"
          OPEN      OUTRF1A2,"outrf1af"
          OPEN      PMSCDNA1,"pmscdnaf"
          OPEN      ALLRHLA1,"allrhlaf"
          OPEN      ALLRHLA2,"allrhlaf"
          OPEN      ALLLHIA1,"alllhiaf"
          OPEN      ALLLHIA2,"alllhiaf"
          OPEN      ALLLHIA3,"alllhiaf"
          OPEN      ALLBIAA1,"allbiaaf"
          OPEN      PATFIMA1,"patfimaf"
          OPEN      PMSMMSA1,"pmsmmsaf"
          OPEN      ALLSASA1,"allsasaf"
          OPEN      OPRNURA1,"oprnuraf"
          OPEN      OUTDCOA1,"outdcoaf"
          OPEN      OUTDANA1,"outdanaf"
          OPEN      OUTDANA2,"outdanaf"
          OPEN      PATPEIO1,"patpeiaf"
          OPEN      PMSWX1A1,"pmswx1af"
.          OPEN      PMSIPLA1,"pmsiplaf"     * Polling table for DHS Medicare
          OPEN      PMSRUGA1,"pmsrugaf"
          OPEN      PMSIMPA1,"pmsimpaf"
.
          OPEN      WATTR1A1,"wattr1af"
          OPEN      IBAALVA2,"ibaalvaf"
          OPEN      ACCAUDA1,"accaudaf"
          OPEN      ACCDIAA1,"accdiaaf"     * Diagnosis Codes for PATCLMTM
          OPEN      EMRICDA1,"emricdaf"     * A/E Diagnosis codes
          OPEN      EMRVISA1,"emrvisaf"     * EMR Visit              *T0881801
          OPEN      EMRLOCA1,"emrlocaf"     * EMR Location           *T0881801
          OPEN      ALLRIOA1,"allrioaf"     * Referral In Outcome History
          OPEN      PATWC1A1,"patwc1af"     * WC/ACC Details
.
          READ      CONTROLF,TWENTY1;*237,PTCNPAOF,*238,PTCNAGEC
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD,*201,ALCNACTW:
                                    *203,ALCNMDES,*213,ALCNLAUD,*224,ALCNDHOS:
                                    *225,ALCNDEVP
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND12;*101,PTCNUFFR
          READ      CONTROLF,TEN3;*245,CHOSTYP
          READ      CONTROLF,HUND16;*222,PTCNXCOM
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,HUND21;*1,ALCNLNKT,*101,ALCNDAMR,*102,ALCNCLNK:
                                    *125,ALCNDTRG,*126,ALCNUPAR,*128,ALCNLKVM
.          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          READ      CONTROLF,SEVENTY9;*80,PTCNQLDB
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTSECA1,"mltsecaf"
          ENDIF
.
          MATCH     "1",ALCNRAUD
          IF        @EQUAL
            OPEN      ALLAUDRE,"allaudre"
            OPEN      ALLAUDR2,"allaudre"
          ENDIF
.
          MATCH     "1",ALCNEAUD
          IF        @EQUAL
            OPEN      ALLAUDEN,"allauden"
          ENDIF
.
          MOVE      "out",CFILEPRE
          OPEN      OUTSITA2,"outsitaf"
          OPEN      OUTDCHA1,"outdchaf"
          CALL      OPNOUT00
          MOVE      ZERO,MASUPDFL
.
          MATCH     "1",ALCNLAUD
          IF        @EQUAL
            OPEN      ALLAUDLN,"allaudln"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNO
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNV
.
          OPEN      PATATRA3,"patatraf"
.  
          CALL      IOUTAR00
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no.
.
INIT9999  RETURN
.
.******************************************************************************
.*                      Check Correct Files are Open for System               *
.******************************************************************************
OUTFIL00  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE        * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Outpatient Files
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the preferred site of the referral                
.*******************************************************************************
COTFIL00  MATCH     SP70,ALREPSIT            * Does the visit have a site
          GOTO      COTFIL99 IF EQUAL
.
COTFIL50  MOVE      ALREPSIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL99           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
COTFIL99  RETURN
.
.*******************************************************************************
. ROTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the preferred site of the linked visit
.*******************************************************************************
ROTFIL00  MATCH     SP70,ALLNSITE            * Does the linked visit have a site
          GOTO      ROTFIL99 IF EQUAL
.
ROTFIL50  MOVE      ALLNSITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,ROTFIL99           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
ROTFIL99  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  CLOSE     OUTCTYA1
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          OPEN      OUTCTYA1,CFNAME    
.
          CLOSE     OUTCTYA2
          PACK      CFNAME,CFILEPRE,FILCTYA2  * Get the name of the CTYA2 file
          OPEN      OUTCTYA2,CFNAME    
.
          CLOSE     OUTCTYA3
          PACK      CFNAME,CFILEPRE,FILCTYA3  * Get the name of the CTYA3 file
          OPEN      OUTCTYA3,CFNAME    
.
          CLOSE     OUTCLIA1
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          OPEN      OUTCLIA1,CFNAME
.
          CLOSE     OUTBOKA6
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          OPEN      OUTBOKA6,CFNAME
.
          CLOSE     OUTBOKA3
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          OPEN      OUTBOKA3,CFNAME
.
          CLOSE     OUTBOKA1
          PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          OPEN      OUTBOKA1,CFNAME
.
          CLOSE     OUTMA1A1
          PACK      CFNAME,CFILEPRE,FILMA1A1  * Get the name of the MA1A1 file
          OPEN      OUTMA1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKC1  * Get the name of the BOKC1 file
          CLOSE     OUTBOKC1
          OPEN      OUTBOKC1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCANA1  * Get the name of the CANA1 file
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCANA2  * Get the name of the CANA2 file
          CLOSE     OUTCANA2
          OPEN      OUTCANA2,CFNAME           * Open the file
.

          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the FILBB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME           * Open the file

.
OPNOUT99  RETURN
.-----------------------------------------------------------------------------.
. Determine Template from Mapping Table                                       .
.-----------------------------------------------------------------------------.
GETMAP00  MOVE      REPORTNO,F2
          MOVE      F2,ALTMMPRP
          REP       " 0",ALTMMPRP
          MOVE      TEMPLATE,F3
          MOVE      F3,ALTMMPTP
          REP       " 0",ALTMMPTP
          PACK      KEY16,ALREDEPT,PRGID,ALTMMPRP,ALTMMPTP,SP70
          CALL      RDALTMP1
          IF        OVRCD=0
            MOVE     ALTMMPTT,TEMPLATE
          ENDIF
          RETURN
.
.-----------------------------------------------------------------------------
. Set up the description for Referral in outcome description array
.-----------------------------------------------------------------------------
IOUTAR00  MOVE      "010Referral accepted - New appointment",OUTCARAY[1]
          MOVE      "020Referral accepted - Review appointment",OUTCARAY[2]
          MOVE      "1  Referral accepted",OUTCARAY[3]
          MOVE      "3  Referral accepted - Renewed referral",OUTCARAY[4]
          MOVE      "21 Patient/client died",OUTCARAY[5]
          MOVE      "22 Patient/client safety issue",OUTCARAY[6]
          MOVE      "23 Patient/client not medically fit",OUTCARAY[7]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "36 Recommended to present to ED for medi",KEY40
          MOVE      "cal reasons",KEY23 
          PACK      OUTCARAY[8],KEY40,KEY23,SP70
.
          MOVE      "24 Patient/client not contactable",OUTCARAY[9]
          MOVE      "25 Services declined or not required",OUTCARAY[10]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "30 Patient/client out of catchment area ",KEY40
          MOVE      "for program",KEY23 
          PACK      OUTCARAY[11],KEY40,KEY23,SP70
.
          MOVE      "31 Clinician safety issue",OUTCARAY[12]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "32 More appropriate program/service iden",KEY40
          MOVE      "tified",KEY23 
          PACK      OUTCARAY[13],KEY40,KEY23,SP70
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "33 Patient/client does not meet the prog",KEY40
          MOVE      "ram/service criteria",KEY23 
          PACK      OUTCARAY[14],KEY40,KEY23,SP70
.
          MOVE      "34 Required services not available",OUTCARAY[15]
          MOVE      "35 No program/service capacity",OUTCARAY[16]
          MOVE      "40 Other reason for cancellation",OUTCARAY[17]
          MOVE      "41 Referral withdrawn by referrer",OUTCARAY[18]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "98 Referral awaiting additional informat",KEY40
          MOVE      "ion from referrer",KEY23 
          PACK      OUTCARAY[19],KEY40,KEY23,SP70
.
          MOVE      "99 Referral processing in progress",OUTCARAY[20]
.
IOUTAR99  RETURN
.-----------------------------------------------------------------------------.
.             Clear Parameters                                                .
.-----------------------------------------------------------------------------.
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,OVERRIDE
          MOVE      ZERO,NORECORD
          MOVE      ZERO,GPACCESS
          MOVE      SP70,TEMPLATE
          MOVE      SP70,REFSTATS
          MOVE      Z70,PMSVX010
          MOVE      Z70,PMSVX093
          MOVE      Z70,PMSVX141
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,REFERXID
          MOVE      SP70,SACSVISN
          MOVE      SP70,INTRVISN
          MOVE      SP70,UPDATETY
          MOVE      SP70,URNOTEMP
          MOVE      SP70,NEXTPAGE
          MOVE      ZERO,MEHRFLAG
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,ACTNCODE
          MOVE      SP70,ALLAUDKY
          MOVE      SP70,ACTNDATE
          MOVE      SP70,ACTNTIME
          MOVE      SP70,COMMENTY
          MOVE      SP70,AUDITKEY
          MOVE      SP70,DOCTCODE
          MOVE      SP70,DEPTCODE
          MOVE      SP70,DEPTINDC
          MOVE      SP70,DESREQIN
          MOVE      ZERO,PRIMARYE
          MOVE      SP70,PRIORITY
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,ACTIVREF
          MOVE      SP70,IAREASON
          MOVE      SP70,ALLRF001
          MOVE      SP70,ALLRF019
          MOVE      SP70,ALLRF022
          MOVE      SP70,ALLRF023
          MOVE      SP70,ALLRF024
          MOVE      SP70,ALLRF034
          MOVE      SP70,ALLRF035
          MOVE      SP70,ALLRF039
          MOVE      SP70,ALLRF140
          MOVE      SP70,ALLRF153
          MOVE      SP70,FILTTEAM
          MOVE      SP70,FILTCLID
          MOVE      SP70,FILTCTYP
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTPSIT
          MOVE      SP70,FILTTRGS
          MOVE      ZERO,LINKEND
          MOVE      ZERO,LINKWEND
          MOVE      ZERO,UNLKEND
          MOVE      ZERO,UNLKWEND
          MOVE      ZERO,FOCUSFLG
          MOVE      SP70,FILTDEPT
          MOVE      SP70,FILTSTAT
          MOVE      SP70,PRTNEWPT
          MOVE      SP70,PRTNEWRF
          MOVE      SP70,PRTUPDPT
          MOVE      SP70,PRTUPDRF
          MOVE      SP70,PRTREJPT
          MOVE      SP70,PRTREJRF
          MOVE      SP70,PRTREFLB
          MOVE      SP70,PRTREFGP
          MOVE      SP70,OVRDDEPT
          MOVE      SP70,OVRDHOSP
          MOVE      SP70,DISPCTDL                            
          MOVE      SP70,HCPCLASD                            
          MOVE      SP70,HCPCLASF                            
          MOVE      SP70,HCPDLDES                            
          MOVE      ZERO,COPYFLAG
          MOVE      ZERO,DEFTVIEW
          MOVE      ZERO,LISTFLAG
          MOVE      SP70,VALDPSIT
          MOVE      SP70,VALDPDHB
          MOVE      SP70,INVADMNO
          MOVE      ZERO,USEINVAD
          PACK      REDIREC1,SP70,SP70,SP70,SP70,SP70
          MOVE      ZERO,RENEWREF
          MOVE      ZERO,NODELETE
          MOVE      SP70,CONTDATE
          MOVE      SP70,VINAHERR
          MOVE      Z70,MHCON001
          MOVE      Z70,MHCON002
          MOVE      Z70,MHUNQ001
          MOVE      Z70,MHUNQ002
.
          MOVE      ZERO,AEFFLAG
          MOVE      ZERO,WARCOUNT
.
          CALL      CPALEX00
          CALL      CLALRN00
          CALL      CPALRE00
          CALL      CPALEI00
          CALL      CPALAE00
          CALL      CPALIS00
          CALL      CPALBI00
          CALL      CPPTFI00
          CALL      CPALSA00
          MOVE      SP70,ISSUENUM
.
          MOVE      Z70,PTMAS008
          MOVE      Z70,PTMAS009
          MOVE      Z70,PTMAS010
          MOVE      Z70,PTMAS011
          MOVE      Z70,PTMAS012
          MOVE      Z70,PTMAS013
          MOVE      Z70,PTMAS023
          MOVE      Z70,PTMAS036
          MOVE      Z70,PTMAS037
          MOVE      Z70,PTMAS038
.
          MOVE      Z70,PMPXI059
          MOVE      Z70,PMPXI060
          MOVE      Z70,PMPXI061
          MOVE      Z70,PTMSX045
.
          MOVE      Z70,ALDAD001
          MOVE      Z70,ALDAD002
          MOVE      ZERO,REFERLIN
.
          MOVE      Z70,ACCPORDN
          MOVE      Z70,ALRIT001
          MOVE      Z70,ALRIT002
          MOVE      Z70,ALRIT003
          MOVE      Z70,ALRIT004
          MOVE      Z70,ALRIT005
          MOVE      Z70,ALRIT006
          MOVE      Z70,ALRIT007
          MOVE      Z70,ALRIT008
          MOVE      Z70,ALRIT009
          MOVE      Z70,ALRIT010
          MOVE      Z70,ALRIT011
          MOVE      Z70,ALRIT012
          MOVE      Z70,ALRIT013
          MOVE      Z70,ALRIT014
          MOVE      Z70,ALRIT015
          MOVE      Z70,ALRIT016
          MOVE      Z70,ALRIT017
          MOVE      Z70,ALRIT018
          MOVE      Z70,ALRIT019
          MOVE      Z70,ALRIT020
          MOVE      SP70,CASEKEYS
          MOVE      SP70,THETKEYS
.
          CALL      CVPMI000
.
          MOVE      SP70,NSLOTKEY
          MOVE      SP70,VISITTYP
          MOVE      SP70,REFRLVIS
          MOVE      SP70,BOOKWARN
          MOVE      SP70,STATCODE
.
          MOVE      SP70,PRTNEWPT
          MOVE      SP70,PRTNEWRF
          MOVE      SP70,PRTUPDPT
          MOVE      SP70,PRTUPDRF
          MOVE      SP70,PRTREJPT
          MOVE      SP70,PRTREJRF
          MOVE      SP70,PRTREFLB
          MOVE      SP70,PRTREFGP
          MOVE      SP70,PRTPLET1
          MOVE      SP70,PRTPFRM1
          MOVE      SP70,PRTPCK01
          MOVE      SP70,PRTPCK02
          MOVE      SP70,PRTPCK03
          MOVE      SP70,PRTPCK04
          MOVE      SP70,PRTPNO01
          MOVE      SP70,PRTPNO02
          MOVE      SP70,PRTPNO03
          MOVE      SP70,PRTPNO04
          MOVE      SP70,PRTPNO05
          MOVE      SP70,PRTPNO06
          MOVE      SP70,PRTPNO07
          MOVE      SP70,PRTPSL01
          MOVE      SP70,PRTPSL02
          MOVE      SP70,PRTPSL03
          MOVE      SP70,PRTPSL04
          MOVE      SP70,PRTPSL05
          MOVE      SP70,PRTPSL06
          MOVE      SP70,PRTPSL07
          MOVE      SP70,PRTPSL08
          MOVE      SP70,PRTPSIT1
          MOVE      SP70,PRTPSIT2
          MOVE      SP70,PRTPVIS1
          MOVE      SP70,PRTPVIS2
.
          MOVE      ZERO,RACTVFLG
          MOVE      ZERO,_MHCCNT       
          MOVE      ZERO,_OFACNT
          MOVE      ZERO,_RFDCNT
          MOVE      ZERO,_RDDCNT
          MOVE      ZERO,_RFPCNT
          MOVE      ZERO,_TCDCNT
          MOVE      ZERO,_TDDCNT
          MOVE      SP70,DIAGCODE
          MOVE      SP70,DIAGCOD2
          MOVE      SP70,DIAGDATE
          MOVE      SP70,UNIQCODE
          MOVE      SP70,DISPT001
          MOVE      SP70,DISPT002
.
          MOVE      ZERO,OPDWEND
          MOVE      ONE,OPDFLAG
.
          MOVE      SP70,NOTETYPE
          MOVE      SP70,NOTENUMB
.
          MOVE      SP70,ENCOUTKY
          MOVE      SP70,REFERRAL
          MOVE      SP70,OTARTKEY
.
          MOVE      SP70,ITEMN001
          MOVE      SP70,ITEMN002
          MOVE      SP70,ITEMN003
          MOVE      SP70,ITEMN004
          MOVE      SP70,ITEMN005
          MOVE      SP70,ITEMN006
          MOVE      SP70,ITEMN007
          MOVE      SP70,ITEMN008
          MOVE      SP70,ITEMN009
          MOVE      SP70,ITEMN010
          MOVE      SP70,SUPRFLAG
.
          MOVE      SP70,SUPERLEV
          CALL      CPPMMS00
          CALL      CPPRUG00
          CALL      CPMHHN00
.
          MOVE      SP70,OLDPMM02
          MOVE      SP70,OLDPMM03
          MOVE      SP70,WAITLIST
          MOVE      SP70,SAVKEY02
          MOVE      SP70,SAVKEY03
          MOVE      SP70,PRVKEY40
          MOVE      SP70,NXTKEY40
.
          MOVE      ZERO,PTCOLUMN
          MOVE      "1",SAVEPRIM
          MOVE      SP70,EREFRLID
          MOVE      SP70,CASEKEYS
.
          MOVE      ZERO,VINAHFLG
          MOVE      ZERO,EPAUDFLG            * reset flag for no before audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF             * initialise VINAH master visit no
          MOVE      ZERO,REMOTSNO            * Remote Script number
          MOVE      SP70,VALDTEAM            * Validate case team  
          MOVE      ZERO,AUTOCPRF            * Auto copy referral    *T0865480
          MOVE      SP70,CURRVIST
          MOVE      SP70,CHNGDATE
          MOVE      SP70,CHNGTIME
          MOVE      SP70,CHNGPORT
          MOVE      SP70,CHNGTYPE
          MOVE      SP70,CHNGOPER
          MOVE      ZERO,LINKSRCH
          MOVE      SP70,EXPRFLAG
          MOVE      SP70,CHKVINAH
          MOVE      SP70,VALDDATE
          MOVE      SP70,VALDTIME
          MOVE      ZERO,REFREJCT
          MOVE      ZERO,SHOWACTV
.
CLRPAR99  RETURN
+
.******************************************************************************
.                  Set Parameters                                             *
.******************************************************************************
SETPAR00  MATCH    "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notetype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTETYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "referxid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFERXID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notenumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTENUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accpordn=",QRYNAME
          IF        @EQUAL
            PACK      ACCPORDN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "usermemr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USERMEMR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refstats=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFSTATS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "override=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRIDE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invadmno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVADMNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "useinvad=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USEINVAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehrflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEHRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx010=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX010
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx093=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX093
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx141=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX141
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alref",QRYNAME
          IF        @EQUAL
            CALL      SPALR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aleid",QRYNAME         * Allied Health Extra Inbound Data
          IF        @EQUAL
            CALL      SPAEI000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "eidexist=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EIDEXIST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alext",QRYNAME
          IF        @EQUAL
            CALL      SPALX000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alaef",QRYNAME
          IF        @EQUAL
            MOVE      ONE,AEFFLAG           * using aef file
            CALL      SPALA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aliss",QRYNAME
          IF        @EQUAL
            CALL      SPALIS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "issuekey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ISSUEKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "issuenum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ISSUENUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrejct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFREJCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showactv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWACTV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrit",QRYNAME
          IF        @EQUAL
            CALL      SPRIT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "albia",QRYNAME
          IF        @EQUAL
            CALL      SPBIA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptfim",QRYNAME
          IF        @EQUAL
            CALL      SPPTF000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhhon",QRYNAME
          IF        @EQUAL
            CALL      STMHN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrnw",QRYNAME
          IF        @EQUAL
            CALL      SPALN000SPALN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alsas",QRYNAME
          IF        @EQUAL
            CALL      SPALS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmas",QRYNAME
          IF        @EQUAL
            MOVE      ONE,MASUPDFL
            CALL      SPMAS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmsx",QRYNAME
          IF        @EQUAL
            MOVE      ONE,MASUPDFL
            CALL      SPMSX000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmpmi",QRYNAME
          IF        @EQUAL
            MOVE      ONE,MASUPDFL
            CALL      SVPMI000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "prtp",QRYNAME
          IF        @EQUAL
            CALL      PRTLL000              * setup Letter & Label Print parms
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptcode=",QRYNAME
          IF        @EQUAL
            PACK      DEPTCODE,QRYDATA,SP70
            MOVE      DEPTCODE,DEPTCODD
            MOVE      DEPTCODE,ALREDEPT          * Added for template map
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptindc=",QRYNAME
          IF        @EQUAL
            PACK      DEPTINDC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            PACK      DOCTCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtnewpt=",QRYNAME
          IF        @EQUAL
            PACK      PRTNEWPT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtnewrf=",QRYNAME
          IF        @EQUAL
            PACK      PRTNEWRF,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtupdpt=",QRYNAME
          IF        @EQUAL
            PACK      PRTUPDPT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtupdrf=",QRYNAME
          IF        @EQUAL
            PACK      PRTUPDRF,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtrejpt=",QRYNAME
          IF        @EQUAL
            PACK      PRTREJPT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtrejrf=",QRYNAME
          IF        @EQUAL
            PACK      PRTREJRF,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtreflb=",QRYNAME
          IF        @EQUAL
            PACK      PRTREFLB,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            PACK      FILTSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtdept=",QRYNAME
          IF        @EQUAL
            PACK      FILTDEPT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "priority=",QRYNAME
          IF        @EQUAL
            PACK      PRIORITY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtteam=",QRYNAME
          IF        @EQUAL
            PACK      FILTTEAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "indexkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INDEXKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "iareason=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IAREASON
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "commenty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,COMMENTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actncode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allaudky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLAUDKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actndate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actntime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "auditkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AUDITKEY
            GOTO      SETPAR99
          ENDIF
.      adding here to get the deptcode from the add dropdown list
          MATCH     "allrf001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF001
            PACK      ALLRF001,ALLRF001,SP70
            MOVE      ALLRF001,ALREDEPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf019=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF019
            UNPACK    ALLRF019,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                      *Set CMON from MTHNAM3
            PACK      ALRERDAT,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf022=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF022
            MOVE      ALLRF022,ALRERHCP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf023=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF023
            MOVE      ALLRF023,ALRERHCR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf024=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF024
            MOVE      ALLRF024,ALRERHCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf034=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF034
            MOVE      ALLRF034,ALRESRCE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf035=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF035
            MOVE      ALLRF035,ALRECOMP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf039=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF039
            UNPACK    ALLRF039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                      *Set CMON from MTHNAM3
            PACK      ALREDREC,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf140=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF140
            MOVE      ALLRF140,ALREPURC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allrf153=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLRF153
            MOVE      ALLRF153,ALREORIG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "activref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTIVREF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtclid=",QRYNAME
          IF        @EQUAL
            PACK      FILTCLID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtctyp=",QRYNAME
          IF        @EQUAL
            PACK      FILTCTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkvist=",QRYNAME
          IF        @EQUAL
            ADD       ONE,LINKEND
            PACK      LINKVIST[LINKEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "unlkvist=",QRYNAME
          IF        @EQUAL
            ADD       ONE,UNLKEND
            PACK      UNLKVIST[UNLKEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            PACK      CASEKEYS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thetkeys=",QRYNAME
          IF        @EQUAL
            PACK      THETKEYS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VISITTYP
            PACK      VISITTYP,VISITTYP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nslotkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NSLOTKEY
            PACK      NSLOTKEY,NSLOTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrlvis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFRLVIS
            PACK      REFRLVIS,REFRLVIS,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "focusflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FOCUSFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aldad001=",QRYNAME
          IF        @EQUAL
            PACK      ALDAD001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aldad002=",QRYNAME
          IF        @EQUAL
            PACK      ALDAD002,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sacsvisn=",QRYNAME
          IF        @EQUAL
            PACK      SACSVISN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "intrvisn=",QRYNAME
          IF        @EQUAL
            PACK      INTRVISN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statcode=",QRYNAME
          IF        @EQUAL
            PACK      STATCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ovrddept=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVRDDEPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ovrdhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVRDHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhctr",QRYNAME
          IF        @EQUAL
            COMPARE   NINTY9,_MHCCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,_MHCCNT
            MOVE      QRYDATA,MHCARRAY[_MHCCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rfdtr",QRYNAME
          IF        @EQUAL
            COMPARE   NINTY9,_RFDCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,_RFDCNT
            MOVE      QRYDATA,RFDARRAY[_RFDCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rfdpl",QRYNAME
          IF        @EQUAL
            COMPARE   NINTY9,_RFPCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,_RFPCNT
            MOVE      QRYDATA,RFPARRAY[_RFPCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rfdat",QRYNAME
          IF        @EQUAL
            COMPARE   NINTY9,_RDDCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,_RDDCNT
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,RDAARRAY[_RDDCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tcdtr",QRYNAME
          IF        @EQUAL
            COMPARE   NINTY9,_TCDCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,_TCDCNT
            MOVE      QRYDATA,TCDARRAY[_TCDCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tcdat",QRYNAME
          IF        @EQUAL
            COMPARE   NINTY9,_TDDCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,_TDDCNT
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,TDDARRAY[_TDDCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ofatr",QRYNAME
          IF        @EQUAL
            COMPARE   NINTY9,_OFACNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,_OFACNT
            MOVE      QRYDATA,OFAARRAY[_OFACNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diagcode=",QRYNAME
          IF        @EQUAL
            PACK      DIAGCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diagcod2=",QRYNAME
          IF        @EQUAL
            PACK      DIAGCOD2,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diagdate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            PACK      DIAGDATE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQCODE
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "referlin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFERLIN
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "copyflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,COPYFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtpsit=",QRYNAME
          IF        @EQUAL
            PACK      FILTPSIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filttrgs=",QRYNAME
          IF        @EQUAL
            PACK      FILTTRGS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdcommt",QRYNAME
          IF        @EQUAL
            CALL      GETOPD00           * Get OPD comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdpsit",QRYNAME
          IF        @EQUAL
            PACK      VALDPSIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdpdhb",QRYNAME
          IF        @EQUAL
            PACK      VALDPDHB,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "listflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LISTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirec1=",QRYNAME
          IF        @EQUAL
            PACK      REDIREC1,QRYDATA,SP70,SP70,SP70,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prtrefgp=",QRYNAME
          IF        @EQUAL
            PACK      PRTREFGP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "renewref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RENEWREF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "encoutky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCOUTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "referral=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFERRAL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otartkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTARTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nodelete=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NODELETE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmmms",QRYNAME
          IF        @EQUAL
            CALL      SPPMMS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmrug",QRYNAME
          IF        @EQUAL
            CALL      SPPRUG00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
          ENDIF
.
          MATCH     "suprflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "binstcom=",QRYNAME
          IF        @EQUAL
            CALL      GETBIN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldpmm02=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            PACK      OLDPMM02,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldpmm03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDPMM03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkwait=",QRYNAME
          IF        @EQUAL
            ADD       ONE,LINKWEND
            PACK      LINKWAIT[LINKWEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "unlkwait=",QRYNAME
          IF        @EQUAL
            ADD       ONE,UNLKWEND
            PACK      UNLKWAIT[UNLKWEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitlist=",QRYNAME
          IF        @EQUAL
            PACK      WAITLIST,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "savkey02=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      SAVKEY02,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contdate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      CONTDATE,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savkey03=",QRYNAME
          IF        @EQUAL
            PACK      SAVKEY03,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prvkey40",QRYNAME
          IF        @EQUAL
            PACK      PRVKEY40,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nxtkey40",QRYNAME
          IF        @EQUAL
            PACK      NXTKEY40,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptcolumn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTCOLUMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "saveprim=",QRYNAME
          IF        @EQUAL
            PACK      SAVEPRIM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vinaherr=",QRYNAME
          IF        @EQUAL
            PACK      VINAHERR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhcon001=",QRYNAME
          IF        @EQUAL
            PACK      MHCON001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhcon002=",QRYNAME
          IF        @EQUAL
            PACK      MHCON002,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhunq001=",QRYNAME
          IF        @EQUAL
            PACK      MHUNQ001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhunq002=",QRYNAME
          IF        @EQUAL
            PACK      MHUNQ002,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "erefrlid=",QRYNAME
          IF        @EQUAL
            PACK     EREFRLID,QRYDATA,SP70
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "clindate=",QRYNAME
          IF        @EQUAL
            PACK      CLINDATE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remotsno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdteam=",QRYNAME
          IF        @EQUAL
            PACK      VALDTEAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "autocprf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AUTOCPRF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "currvist=",QRYNAME
          IF        @EQUAL
            PACK      CURRVIST,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngdate=",QRYNAME
          IF        @EQUAL
            PACK      CHNGDATE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngtime=",QRYNAME
          IF        @EQUAL
            PACK      CHNGTIME,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngport=",QRYNAME
          IF        @EQUAL
            PACK      CHNGPORT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngtype=",QRYNAME
          IF        @EQUAL
            PACK      CHNGTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngoper=",QRYNAME
          IF        @EQUAL
            PACK      CHNGOPER,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exprflag=",QRYNAME
          IF        @EQUAL
            PACK      EXPRFLAG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chkvinah=",QRYNAME
          IF        @EQUAL
            PACK      CHKVINAH,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      VALDDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtime=",QRYNAME
          IF        @EQUAL
            PACK      VALDTIME,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.                                                               
          MATCH     "dispctdl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPCTDL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hcpclasf=",QRYNAME
          IF        @EQUAL
.           MOVE      QRYDATA,HCPCLASF
            PACK      HCPCLASF,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
.   Set Parameters for allied health item code file
.------------------------------------------------------------
SPITM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPITM001,SPITM002,SPITM003,SPITM004,SPITM005:
                       SPITM006,SPITM007,SPITM008,SPITM009,SPITM010
.
          MOVE      ONE,EXIT
          GOTO      SPITM999
.
SPITM001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN001
          PACK      ITEMN001,ITEMN001,SP70
          GOTO      SPITM999
.
SPITM002  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN002
          PACK      ITEMN002,ITEMN002,SP70
          GOTO      SPITM999
.
SPITM003  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN003
          PACK      ITEMN003,ITEMN003,SP70
          GOTO      SPITM999
.
SPITM004  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN004
          PACK      ITEMN004,ITEMN004,SP70
          GOTO      SPITM999
.
SPITM005  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN005
          PACK      ITEMN005,ITEMN005,SP70
          GOTO      SPITM999
.
SPITM006  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN006
          PACK      ITEMN006,ITEMN006,SP70
          GOTO      SPITM999
.
SPITM007  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN007
          PACK      ITEMN007,ITEMN007,SP70
          GOTO      SPITM999
.
SPITM008  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN008
          PACK      ITEMN008,ITEMN008,SP70
          GOTO      SPITM999
.
SPITM009  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN009
          PACK      ITEMN009,ITEMN009,SP70
          GOTO      SPITM999
.
SPITM010  SQUEEZE   QRYDATA
          MOVE      QRYDATA,ITEMN010
          PACK      ITEMN010,ITEMN010,SP70
          GOTO      SPITM999
.
SPITM999  RETURN
.
.------------------------------------------------------------
.  Write computer generated items to allitmaf
.------------------------------------------------------------
CITM0000  MOVE      ONE,F2
          PACK      KEY18,ALENVISN,ALENENCT,Z70
          CALL      RSALITM1
          CALL      RPALITM1
          BRANCH    OVRCD,CITM4000
.
          MATCH     ALENVISN,ALITVISN            * Same visit number
          GOTO      CITM4000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALITENCN            * Same encounter number
          GOTO      CITM4000 IF NOT EQUAL
.
          MOVE     ALITITMC,F2                   * Add one to unique count
          ADD      ONE,F2
.
CITM4000  MOVE      ALENVISN,ALITVISN
          MOVE      ALENENCT,ALITENCN
          MOVE      F2,ALITITMC
          MOVE      NUMBITEM,ALITITMN
          MOVE      SP70,ALITSPAR
.
          PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
          CALL      RAALITM1
          IF        OVRCD=1
             CALL     WRALITM1                   * Write to item file
          ELSE
             GOTO     CITM0000                   * Get next unique number
          ENDIF
.
CITM9999  RETURN
.
.-----------------------------------------------------------------------------.
.         Set parameters for alrit
.-----------------------------------------------------------------------------.
SPRIT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRIT010,SPRIT020,SPRIT030,SPRIT040,SPRIT050:
                       SPRIT060,SPRIT070,SPRIT080,SPRIT090,SPRIT100:
                       SPRIT110,SPRIT120,SPRIT130,SPRIT140,SPRIT150:
                       SPRIT160,SPRIT170,SPRIT180,SPRIT190,SPRIT200
.
          MOVE      ONE,EXIT
          GOTO      SPRIT999
.
SPRIT010  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",ALRIT001
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",ALRIT001
          ENDIF
.
          GOTO      SPRIT999
.
SPRIT020  PACK      ALRIT002,QRYDATA,SP70
          GOTO      SPRIT999
.
SPRIT030  MOVE      QRYDATA,ALRIT003
          GOTO      SPRIT999
.
SPRIT040  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",ALRIT004
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",ALRIT004
          ENDIF     
. 
          GOTO      SPRIT999
.
SPRIT050  PACK      ALRIT005,QRYDATA,SP70
          GOTO      SPRIT999
.
SPRIT060  MOVE      QRYDATA,ALRIT006
          GOTO      SPRIT999
.
SPRIT070  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",ALRIT007
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",ALRIT007
          ENDIF     
.
          GOTO      SPRIT999
.
SPRIT080  PACK      ALRIT008,QRYDATA,SP70
          GOTO      SPRIT999
.
SPRIT090  MOVE      QRYDATA,ALRIT009
          GOTO      SPRIT999
.
SPRIT100  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",ALRIT010
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",ALRIT010
          ENDIF     
.
          GOTO      SPRIT999
.
SPRIT110  PACK      ALRIT011,QRYDATA,SP70
          GOTO      SPRIT999
.
SPRIT120  MOVE      QRYDATA,ALRIT012
          GOTO      SPRIT999
.
SPRIT130  MATCH     "MBS",QRYDATA
          IF        @EQUAL
            MOVE      " 0",ALRIT013
          ENDIF
.
          MATCH     "AMA",QRYDATA
          IF        @EQUAL
            MOVE      " 1",ALRIT013
          ENDIF     
.
          GOTO      SPRIT999
.
SPRIT140  PACK      ALRIT014,QRYDATA,SP70
          GOTO      SPRIT999
.
SPRIT150  MOVE      QRYDATA,ALRIT015
          GOTO      SPRIT999
.
SPRIT160  MOVE      QRYDATA,ALRIT016
          GOTO      SPRIT999
.
SPRIT170  MOVE      QRYDATA,ALRIT017
          GOTO      SPRIT999
.
SPRIT180  MOVE      QRYDATA,ALRIT018
          GOTO      SPRIT999
.
SPRIT190  MOVE      QRYDATA,ALRIT019
          GOTO      SPRIT999
.
SPRIT200  MOVE      QRYDATA,ALRIT020
          GOTO      SPRIT999
.
SPRIT999  RETURN
+
.-----------------------------------------------------------------------------.
.         Set parameters for RLetter & Label Printing
.-----------------------------------------------------------------------------.
PRTLL000  MOVE      ZERO,EXIT
          MATCH     "prtplet",QRYNAME      * letters
          IF        @EQUAL
            UNPACK    QRYNAME,KEY7,KEY1
            MOVE      KEY1,F1
            STORE     QRYDATA,F1,PRTPLET1
            GOTO      PRTLL999
          ENDIF
.
          MATCH     "prtpfrm",QRYNAME      * forms (templated)
          IF        @EQUAL
            UNPACK    QRYNAME,KEY7,KEY1
            MOVE      KEY1,F1
            STORE     QRYDATA,F1,PRTPFRM1
            GOTO      PRTLL999
          ENDIF
.
          MATCH     "prtpvis",QRYNAME      * outpatient visit
          IF        @EQUAL
            UNPACK    QRYNAME,KEY7,KEY1
            MOVE      KEY1,F1
            STORE     QRYDATA,F1,PRTPVIS1,PRTPVIS2
            GOTO      PRTLL999
          ENDIF
.
          MATCH     "prtpsit",QRYNAME      * outpatient site 
          IF        @EQUAL
            UNPACK    QRYNAME,KEY7,KEY1
            MOVE      KEY1,F1
            STORE     QRYDATA,F1,PRTPSIT1,PRTPSIT2
            GOTO      PRTLL999
          ENDIF
.
          MATCH     "prtpck",QRYNAME        * Check Box     
          IF        @EQUAL
            UNPACK    QRYNAME,KEY6,KEY2
            MOVE      KEY2,F2
            STORE     QRYDATA,F2,PRTPCK01,PRTPCK02,PRTPCK03,PRTPCK04
            GOTO      PRTLL999
          ENDIF
.
          MATCH     "prtpno",QRYNAME        * No. of copies
          IF        @EQUAL
            UNPACK    QRYNAME,KEY6,KEY2
            MOVE      KEY2,F2
            STORE     QRYDATA,F2,PRTPNO01,PRTPNO02,PRTPNO03,PRTPNO04:
                                 PRTPNO05,PRTPNO06,PRTPNO07
            GOTO      PRTLL999
          ENDIF
.
          MATCH     "prtpsl",QRYNAME        * Selected Printer No.
          IF        @EQUAL
            UNPACK    QRYNAME,KEY6,KEY2
            MOVE      KEY2,F2
            STORE     QRYDATA,F2,PRTPSL01,PRTPSL02,PRTPSL03,PRTPSL04:
                                 PRTPSL05,PRTPSL06,PRTPSL07,PRTPSL08
            GOTO      PRTLL999
          ENDIF
.
PRTLL999  RETURN
+
.-----------------------------------------------------------------------------.
. Main Action Routine - Report 1
.-----------------------------------------------------------------------------.
ALLLST00
.  Need to check on Doctor Code / HCP Relationship before Implementing Following
.          MATCH     SP70,DOCTCODE
.          IF        @EQUAL
.            MOVE      WBSEGPCD,DOCTCODE
.          ENDIF
.
          MATCH     "1",OVRDDEPT
          IF        !@EQUAL
            MATCH     SP70,DEPTCODE
            IF        @EQUAL
              MOVE      WBSEDALL,DEPTCODE
            ENDIF
          ENDIF
.
.         If Override hospital filter is set then do not default filthosp
.
          MATCH     "1",OVRDHOSP         *Is override hosp filter set?
          GOTO      ALLLST10 IF EQUAL    *Yes, do not default filthosp
.
          MATCH     "1",ALCNDHOS
          IF        @EQUAL
            MATCH     SP70,FILTHOSP         
            IF        @EQUAL
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
            MATCH     SP70,FILTPSIT
            IF        @EQUAL
              MOVE      WBSESIT,FILTPSIT
            ENDIF
          ENDIF
.
ALLLST10  CALL      CURPER00   * Display Routine
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "List Referrals",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALLLST99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
ALLLST99  RETURN
.
.-----------------------------------------------------------------------------.
.                   Main Action Routine                                       .
.-----------------------------------------------------------------------------.
.
ALLEVT00  RESET     UPDATETY
          MATCH     SP70,INVADMNO
          IF        !@EQUAL
            CALL      OHVIS000
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
.
          MATCH     SP70,UPDATETY
          GOTO      ALLEVT40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Referral
          GOTO      ALLEVT10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Referral
          GOTO      ALLEVT20 IF EQUAL
.
          MATCH     "T",UPDATETY            * Activate a Referral
          GOTO      ALLEVT30 IF EQUAL
.
          MATCH     "N",UPDATETY            * Cancel a Referral
          GOTO      ALLEVT50 IF EQUAL
.
          MATCH     "J",UPDATETY            * Reject a Referral
          GOTO      ALLEVT55 IF EQUAL
.
          MATCH     "S",UPDATETY            * Save Audit Action
          GOTO      ALLEVT60 IF EQUAL
.
          MATCH     "E",UPDATETY            * Reinstate Referral
          GOTO      ALLEVT65 IF EQUAL
.
          MATCH     "C",UPDATETY            * Close Referral
          GOTO      ALLEVT70 IF EQUAL
.
          MATCH     "I",UPDATETY            * Inactivate a Referral
          GOTO      ALLEVT80 IF EQUAL
.
          MATCH     "R",UPDATETY            * Supervisor referral update
          GOTO      ALLEVT85 IF EQUAL
.
          MATCH     "D",UPDATETY            * Supervisor referral delete
          GOTO      ALLEVT90 IF EQUAL
.
          MATCH     "P",UPDATETY            * Print Letters & Labels
          GOTO      ALLEV100 IF EQUAL
.
          MATCH     "M",UPDATETY
          GOTO      ALLEV110 IF EQUAL       * Main health removal
.
          MATCH     "O",UPDATETY
          GOTO      ALLEV125 IF EQUAL       * Other Factors removal
.
          MATCH     "Q",UPDATETY
          GOTO      ALLEV130 IF EQUAL       * Main health addition
.
          MATCH     "W",UPDATETY
          GOTO      ALLEV135 IF EQUAL       * Other Factors addition
.
          MATCH     "X",UPDATETY            * Referral Destination addition
          GOTO      ALLEV140 IF EQUAL
.
          MATCH     "Y",UPDATETY            * Referral Destination removal
          GOTO      ALLEV145 IF EQUAL
.
          MATCH     "Z",UPDATETY            * Referral Destination date update
          GOTO      ALLEV150 IF EQUAL
.
          MATCH     "B",UPDATETY            * Transfer Referral
          GOTO      ALLEV160 IF EQUAL
.
          MATCH     "G",UPDATETY            * Add Transition Care Dates
          GOTO      ALLEV165 IF EQUAL
.
          MATCH     "H",UPDATETY            * Delete Transition Care Dates
          GOTO      ALLEV170 IF EQUAL
.
          MATCH     "F",UPDATETY            * Update Transition Care Update
          GOTO      ALLEV175 IF EQUAL
.
          MATCH     "K",UPDATETY            * Waiting a Referral
          GOTO      ALLEV180 IF EQUAL
.
          GOTO      ALLEV998
.
.-------- *T0865480-start
.---ALLEVT10 CALL      ADDREF00                * Add Referral
.---         GOTO      ALLEV999
.
ALLEVT10  CALL      ADDREF00                * Add Referral
          BRANCH    EXIT,ALLEV999           * Exit,if issues found
.
          COMPARE   ONE,AUTOCPRF            * Template Auto copy ref option on?
          GOTO      ALLEV999 IF NOT EQUAL   * No, exit
.
.-------  MATCH     ALREF005,Z70            * Link to visit on template?
.-------  GOTO      ALLEV999 IF EQUAL       * No, exit
.
.-------  MATCH     SP70,ALREF005           * Link to visit entered?
.-------  GOTO      ALLEV999 IF NOT EQUAL   * Yes, exit
.
          MATCH     "1",ALREF083            * Just created a primary referral?
          GOTO      ALLEV999 IF NOT EQUAL   * No, exit
.
          PACK      KEY5,CATCG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ALLEV999
.
          MATCH     ANSL,TCINDC23           * Dept Auto-create Linked ref on?
          GOTO      ALLEV999 IF NOT EQUAL   * No, exit
.
.         Create a copy of the Primary referral as a Linked referral           
          MOVE      "0",ALREF083            * Set to create a linked referral
          MOVE      "0",ALREUYN4            * Set link referral type
          MOVE      ADMISSNO,SACSVISN       * Set Primary referral
.
.         *T0888305 - Do not print linked referral letter or labels
          MOVE      SP70,PRTNEWPT           * Referral letter to patient
          MOVE      SP70,PRTNEWRF           * Referral letter to referrer
          MOVE      SP70,PRTREFLB           * Referral labels
.
          CALL      ADDREF00                * Add a linked referral  
          GOTO      ALLEV999
.-------- *T0865480-end
.
ALLEVT20  CALL      UPDREF00                * Update Referral
          GOTO      ALLEV999
.
ALLEVT30  CALL      ACTREF00                * Activate Referral
          GOTO      ALLEV999
.
ALLEVT40  CALL      CURPER00                * Display Routine
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      ALLEV992 IF EQUAL
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
            CALL      RDVISA1
            IF        OVRCD=1
              CALL      CLPATVIS
            ENDIF
            CALL      RDPMVX11
            IF        OVRCD=1
              CALL      CLPMSVX1
            ENDIF
.
            CALL      RDALREF1
            IF        OVRCD=0
              CALL      RDALEID1
              IF        OVRCD=1
                CALL      CLALLEID
              ENDIF
              IF        REPORTNO=2
                MATCH     "002",TEMPLATE
                IF        @EQUAL 
                  CALL      AUDV0000          * View record for allweb0202002
                ENDIF
              ENDIF
            ELSE
              CALL      CLALLREF
              CALL      CLALLEID
.
              MOVE      DOCTCODE,ALREHCP
              MOVE      ALLRF001,ALREDEPT   
              MOVE      ALLRF001,DEPTCODE
.
              UNPACK    ALLRF019,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00                      *Set CMON from MTHNAM3
              PACK      ALRERDAT,CCENT,CYEAR,CMON,CDAY
.
              UNPACK    ALLRF039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00                      *Set CMON from MTHNAM3
              PACK      ALREDREC,CCENT,CYEAR,CMON,CDAY
.
              MOVE      ALLRF022,ALRERHCP
              MOVE      ALLRF023,ALRERHCR
              MOVE      ALLRF024,ALRERHCT
              MOVE      ALLRF034,ALRESRCE
              MOVE      ALLRF035,ALRECOMP
              MOVE      ALLRF140,ALREPURC
              MOVE      ALLRF153,ALREORIG
              MOVE      PMSVX010,PMVXINGP
              MOVE      ALDAD001,ALDAFHOS
              MOVE      SAVEPRIM,ALREUYN4
            ENDIF
.
            PACK      KEY8,ALREVISN
            CALL      RDALAEF1
            IF        OVRCD=1
              CALL      CLALLAEF
            ENDIF
          ELSE
              CALL      CLALLREF
              CALL      CLALLEID
.
              MOVE      DOCTCODE,ALREHCP
              MOVE      ALLRF001,ALREDEPT
              MOVE      ALLRF001,DEPTCODE
.
              UNPACK    ALLRF019,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00                      *Set CMON from MTHNAM3
              PACK      ALRERDAT,CCENT,CYEAR,CMON,CDAY
.
              UNPACK    ALLRF039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00                      *Set CMON from MTHNAM3
              PACK      ALREDREC,CCENT,CYEAR,CMON,CDAY
.
              MOVE      ALLRF022,ALRERHCP
              MOVE      ALLRF023,ALRERHCR
              MOVE      ALLRF024,ALRERHCT
              MOVE      ALLRF034,ALRESRCE
              MOVE      ALLRF035,ALRECOMP
              MOVE      ALLRF140,ALREPURC
              MOVE      ALLRF153,ALREORIG
              MOVE      PMSVX010,PMVXINGP
              MOVE      ALDAD001,ALDAFHOS
              MOVE      SAVEPRIM,ALREUYN4
          ENDIF   
.
          IF        COPYFLAG=1
            MOVE      DEPTCODE,ALREDEPT
            MOVE      SAVEPRIM,ALREUYN4
          ENDIF
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                      * Read department table
          IF        OVRCD=0
            MOVE      ALDESREQ,DESREQIN
            MATCH     "1",ALREUYN4
            IF        @EQUAL
              MOVE      ALDEPENC,PRIMARYE
            ENDIF
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Allied Health Referrals",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALLEV999
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALLEV999
.
ALLEVT50  CALL      CANREF00                * Cancel a Referral
          GOTO      ALLEV999
.
ALLEVT55  CALL      REJREF00                * Reject a Referral
          GOTO      ALLEV999
.
ALLEVT60  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          MOVE      "M ",UPDTTYPE           * Add an Action
          CALL      WRTRAU00
.
          MOVE      ZERO,EXIT
          GOTO      ALLEV999
.
ALLEVT65  CALL      REIREF00                *  Reinstate Referral
          GOTO      ALLEV999
.
.-------- *T0865480-start
.---ALLEVT70 CALL      CLSREF00                * Close a Referral
.---         GOTO      ALLEV999                                   
.
ALLEVT70  MOVE      ZERO,AUTOCLOS           * Use MVALRE00 for ref cgi vars
          CALL      CLSREF00                * Close a Referral
          BRANCH    EXIT,ALLEV999           * Exit, if error found
.
          COMPARE   TWO,AUTOCPRF            * Template Auto close Prim ref on?
          GOTO      ALLEV999 IF NOT EQUAL   * No, exit
.
          MATCH     "1",ALREUYN4            * Just closed a Primary ref?
          GOTO      ALLEV999 IF EQUAL       * Yes, exit 
.
          PACK      KEY5,CATCG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ALLEV999
.
          MATCH     ANSC,TCINDC24           * Dept Auto-close Primary ref on?
          GOTO      ALLEV999 IF NOT EQUAl   * No, exit
.
          CALL      CPRI0000                * Can primary referral be closed?
          BRANCH    MULTILRF,ALLEV999       * No, multi linked referrals found
.
          MOVE      SAVPRIRF,ADMISSNO       * Set primary referral
          MOVE      ONE,AUTOCLOS            * Use selective cgi vars
          CALL      CLSREF00                * Close primary referral
          GOTO      ALLEV999                               
.-------- *T0865480-end
.
ALLEVT80  CALL      INAREF00                *  Inactivate  a referral
          GOTO      ALLEV999
.
ALLEVT85  CALL      SUPREF00                * Supervisor Update
          GOTO      ALLEV999
.
ALLEVT90  CALL      SUPDEL00                * Supervisor referral delete
          GOTO      ALLEV999
.
ALLEV100  CALL      PRNT0000                * Print letters & Labels
          GOTO      ALLEV999
.
ALLEV110  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      ADST0000                * before audit
          CALL      MHCR0000                * main health condition item removal
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV125  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      ADST0000                * before audit
          CALL      OFAR0000
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV130  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      ADST0000                * before audit
          CALL      MHCU0000
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV135  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      ADST0000                * before audit
          CALL      OFAU0000
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV140  PACK      KEY8,ADMISSNO,SP70      * Add Referral Destination
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      ADST0000                * before audit
          CALL      RFDU0000
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV145  PACK      KEY8,ADMISSNO,SP70      * Delete Referral Destination 
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      ADST0000                * before audit
          CALL      RFDR0000
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV150  PACK      KEY8,ADMISSNO,SP70      * Update Referral Destination
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      ADST0000                * before audit
          CALL      RDTU0000
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV160  CALL      TRNREF00                * Transfer Referral
          GOTO      ALLEV999
.
ALLEV165  PACK      KEY8,ADMISSNO,SP70      * Add Transition Care Date
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      VATC0000                * Validate Add
          BRANCH    EXIT,ALLEV999
.
          CALL      ADST0000                * before audit
          CALL      ATCD0000
          CALL      ADEN0000                * after audit

          GOTO      ALLEV999
.
ALLEV170  PACK      KEY8,ADMISSNO,SP70      * Delete Transition Care Date
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      VDTC0000                * Validate Delete
          BRANCH    EXIT,ALLEV999
.
          CALL      ADST0000                * before audit
          CALL      RTCD0000
          CALL      ADEN0000                * after audit

          GOTO      ALLEV999
.
ALLEV175  PACK      KEY8,ADMISSNO,SP70      * Update Transition Care Date
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          CALL      VUTC0000                * Validate update
          BRANCH    EXIT,ALLEV999
.
          CALL      ADST0000                * before audit
          CALL      UTCD0000
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV180  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEV990
.
          MATCH     ADMISSNO,ALREVISN
          GOTO      ALLEV990 IF NOT EQUAL
.
          MATCH     ALREURNO,URNUMBER
          GOTO      ALLEV990 IF NOT EQUAL
.
          CALL      ADST0000                * before audit
          MOVE      "0",ALRESTAT
          CALL      UPALREF1
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALEID1
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      "W ",UPDTTYPE           * Add a 'Waiting' audit action
          CALL      WRTRAU00
.
          CALL      ADEN0000                * after audit
.
          GOTO      ALLEV999
.
ALLEV990  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEV999
.
ALLEV991  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEV999
.
ALLEV992  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEV999
.
ALLEV997  MOVE      "Invalid Audit Key.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEV999
.
ALLEV998  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEV999
.
ALLEV999  RETURN
+
.--------------------------------------------------------------------------
. Referral Bulk Billing Maintenance
.--------------------------------------------------------------------------
REFBLK00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      REFBLK40 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Formaction
          GOTO      REFBLK20 IF EQUAL
.
          GOTO      REFBLK93
.
.         ************ UPDATE FORMACTION **********
.
REFBLK20  PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1  
          BRANCH    OVRCD,REFBLK92
.
. Moves cgi to file variables
.
          CALL      MVALRE00
.
          CALL      UPALREF1                * Update the record
          BRANCH    OVRCD,REFBLK92
.
          MOVE      ZERO,EXIT
          GOTO      REFBLK99
.
REFBLK40  MOVE      ZERO,EXIT
          PACK      KEY8,URNUMBER,SP70      * Patient Details
          CALL      RDMAST1
          BRANCH    OVRCD,REFBLK91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,REFBLK92
.
          MATCH     "1",ALRESTAT
          GOTO      REFBLK94 IF NOT EQUAL
.
          CLEAR     WEBTITLE
          MOVE      "Bulk Billing Referral Details.",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,REFBLK99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK91  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK94  MOVE      "Referral Not Active.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFBLK99
.
REFBLK99  RETURN
.
.******************************************************************************
.*        VUTC0000 - Validate transition care date update
.******************************************************************************
VUTC0000  PACK      KEY13,ADMISSNO,ZERO,FIVE,UNIQCODE,SP70
          CALL      RDALRHL1
          BRANCH    OVRCD,VUTC9000
.
          MATCH     DIAGDATE,ALRHDATE            * No change to transition date
          GOTO      VUTC8000 IF EQUAL
.
          CALL      RPALRHL1
          BRANCH    OVRCD,VUTC5000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      VUTC5000 IF NOT EQUAL
.
          MATCH     "05",ALRHTYPE
          GOTO      VUTC5000 IF NOT EQUAL
.
          MATCH     ALRHDATE,DIAGDATE
          GOTO      VUTC9100 IF LESS
.
VUTC5000  PACK      KEY13,ADMISSNO,ZERO,FIVE,UNIQCODE,SP70
          CALL      RDALRHL1
          BRANCH    OVRCD,VUTC9000
.
          CALL      RKALRHL1
          BRANCH    OVRCD,VUTC8000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      VUTC8000 IF NOT EQUAL
.
          MATCH     "05",ALRHTYPE
          GOTO      VUTC8000 IF NOT EQUAL
.
          MATCH     DIAGDATE,ALRHDATE
          GOTO      VUTC9200 IF LESS
.
VUTC8000  MOVE      ZERO,EXIT
          GOTO      VUTC9999
.
VUTC9000  MOVE      "Invalid transition care record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VUTC9999
.
VUTC9100  CLEAR     WEBTITLE
          APPEND    "Transition date overlap with previous ",WEBTITLE
          APPEND    "transition record.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VUTC9999
.
VUTC9200  CLEAR     WEBTITLE
          APPEND    "Transition date overlap with next ",WEBTITLE
          APPEND    "transition record.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VUTC9999
.
VUTC9999  RETURN
+
.******************************************************************************
.*        VDTC0000 - Validate transition care delete
.******************************************************************************
VDTC0000  PACK      KEY13,ADMISSNO,ZERO,FIVE,Z70
          CALL      RSALRHL1
          CALL      RPALRHL1
          BRANCH    OVRCD,VDTC9000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      VDTC9000 IF NOT EQUAL
.
          MATCH     "05",ALRHTYPE
          GOTO      VDTC9000 IF NOT EQUAL
.
          MATCH     UNIQCODE,ALRHUNIQ
          GOTO      VDTC9100 IF NOT EQUAL
.
VDTC8000  MOVE      ZERO,EXIT
          GOTO      VDTC9999
.
VDTC9000  MOVE      "Invalid transition care record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VDTC9999
.
VDTC9100  CLEAR     WEBTITLE
          APPEND    "Only the last transtition record ",WEBTITLE
          APPEND    "can be deleted.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VDTC9999
.
VDTC9999  RETURN
+
.******************************************************************************
.*        VATC0000 - Validate transition care date update
.******************************************************************************
VATC0000  PACK      KEY13,ADMISSNO,ZERO,FIVE,Z70
          CALL      RSALRHL1
          CALL      RPALRHL1
          BRANCH    OVRCD,VATC8000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      VATC8000 IF NOT EQUAL
.
          MATCH     "05",ALRHTYPE
          GOTO      VATC8000 IF NOT EQUAL
.
          MATCH     ALRHDATE,DIAGDATE
          GOTO      VATC9100 IF LESS
.
          PACK      KEY5,CATZW,ALRHCODE,SP70
          CALL      RDCODE1                      * Get the last transition
          BRANCH    OVRCD,VATC8000               * care records type
.                                                * home or bed based
          MATCH     SP70,TCINDC1
          GOTO      VATC8000 IF EQUAL
.
          MOVE      TCINDC1,KEY1
.
          PACK      KEY5,CATZW,DIAGCODE,SP70     * Get the new transition
          CALL      RDCODE1                      * care records type
          BRANCH    OVRCD,VATC8000               * home or bed based
.
          MATCH     SP70,TCINDC1
          GOTO      VATC8000 IF EQUAL
.
          MATCH     TCINDC1,KEY1                 * transition type must
          GOTO      VATC9200 IF EQUAL            * alternate from home and bed
.                                                * based care
VATC8000  MOVE      ZERO,EXIT
          GOTO      VATC9999
.
VATC9000  MOVE      "Invalid transition care record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VATC9999
.
VATC9100  CLEAR     WEBTITLE
          APPEND    "Transition date must be equal to or greater than ",WEBTITLE
          APPEND    "the last transition date.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VATC9999
.
VATC9200  CLEAR     WEBTITLE
          APPEND    "Transition type must alternate between home and ",WEBTITLE
          APPEND    "bed based care.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VATC9999
.
VATC9999  RETURN
+
.******************************************************************************
.*        ADST0000 - start audit before
.******************************************************************************
.
ADST0000  MOVE      TWO,AUDTTYPE
          CALL      WAALRE00
.
ADST9999  RETURN
+
.******************************************************************************
.*        ADEN0000 - end audit after
.******************************************************************************
.
ADEN0000  MOVE      THREE,AUDTTYPE
          CALL      WAALRE00
.
ADEN9999  RETURN
+
.******************************************************************************
.         RDTU0000 - Update referral In/Out destination date
.******************************************************************************
.
RDTU0000  IF        REFERLIN=1
            PACK      KEY22,DIAGCODE,ADMISSNO,ZERO4,UNIQCODE,SP70
          ELSE
            PACK      KEY22,DIAGCODE,ADMISSNO,ZERO3,UNIQCODE,SP70
          ENDIF
.
          CALL      RDALRHL2
          BRANCH    OVRCD,RDTU9999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,RDTU9999
.
          CLOCK     TIME,CTIMEIS
          PACK      CDATE,CCC,CYY,CMM,CDD
          REP       " 0",CDATE
          MOVE      ZERO,EXIT
          MATCH     "4",ALRESTAT            * Cancelled(4) referral
          GOTO      RDTU8000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RDTU0500
.
          MATCH     ANST,TCINDC8            * TCP
          IF        @EQUAL
            MATCH     SP70,DIAGDATE         * Allow blank date
            GOTO      RDTU6000
          ENDIF

RDTU0500  MATCH     ALRERDAT,DIAGDATE
          GOTO      RDTU8100 IF LESS  
.
          MOVE      ALRESTAT,F1
          ADD       ONE,F1
          BRANCH    F1,RDTU1000,RDTU2000,RDTU3000,RDTU4000,RDTU9999,RDTU5000
          GOTO      RDTU9999
.
RDTU1000
RDTU2000  MATCH     DIAGDATE,CDATE          * Same for Active(1)
          GOTO      RDTU82000 IF LESS
.
          GOTO      RDTU6000
.                                           * Referral Closed (2)
RDTU3000  MATCH     DIAGDATE,ALREDCLO       * Check closed date
          GOTO      RDTU8300 IF LESS
.
          GOTO      RDTU6000
.                                           * Referral Inactive(3)
RDTU4000  MATCH     DIAGDATE,ALREDINA       * Check inactive code
          GOTO      RDTU8400 IF LESS
.
          GOTO      RDTU6000
.
RDTU5000  MATCH     DIAGDATE,ALRESRDT       * Referral Rejected(5)
          GOTO      RDTU8500 IF LESS
.
          GOTO      RDTU6000
.
RDTU6000  MOVE      DIAGDATE,ALRHDATE
          CALL      UPALRHL2
          GOTO      RDTU9999
.
RDTU8000  MOVE     "Cannot be added to a cancelled referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RDTU9999
.
RDTU8100  MOVE      "Date must be greater than referral date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RDTU9999
.
RDTU8200  MOVE      "Date should not be in future.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RDTU9999
.
RDTU8300  MOVE      "Date must be less than closed referral date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RDTU9999
.
RDTU8400  MOVE      "Date must less than inactive date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RDTU9999
.
RDTU8500  CLEAR     WEBTITLE
          APPEND    "Date must less than ",WEBTITLE
          APPEND    "rejected date. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RDTU9999
.
RDTU9999  RETURN
+
.******************************************************************************
.         MHCU0000 - Update main health condition
.******************************************************************************
.
MHCU0000  PACK      KEY12,DEPTCODE,DIAGCODE,SP70
          CALL      RDALDIA1
          IF        OVRCD=1
            MOVE    "N/A",ALDIDESC
          ENDIF
.
          PACK      KEY22,DIAGCODE,ADMISSNO,ZERO1,SP70
          CALL      RSALRHL2 
MHCU1000  CALL      RKALRHL2
          BRANCH    OVRCD,MHCU1500
.
          MATCH     DIAGCODE,ALRHCODE
          IF        @EQUAL
            MATCH     ADMISSNO,ALRHVISN
            IF        @EQUAL
              MATCH     ZERO1,ALRHTYPE
              GOTO      MHCU9000 IF EQUAL
            ENDIF
          ENDIF
.
MHCU1500  PACK      KEY13,ADMISSNO,ZERO1,Z70
          CALL      RSALRHL1
          CALL      RPALRHL1
          BRANCH    OVRCD,MHCU2000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      MHCU2000 IF NOT EQUAL
.
          MATCH     ZERO1,ALRHTYPE
          GOTO      MHCU2000 IF NOT EQUAL
.
          GOTO      MHCU3000    
.
MHCU2000  MOVE      ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
          GOTO      MHCU4000
.
MHCU3000  MOVE      ALRHUNIQ,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
.
MHCU4000  MOVE      DIAGCODE,ALRHCODE
          MOVE      ADMISSNO,ALRHVISN
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
.
          MOVE      ZERO1,ALRHTYPE
          PACK      KEY13,ADMISSNO,ZERO1,FORM3,SP70
.
          CALL      RAALRHL1
          IF        OVRCD=1
            CALL      WRALRHL1
          ENDIF
.
          
          GOTO      MHCU9999
.
MHCU9000  MOVE      "Warning diagnosis already exist:",DIM50
          PACK      DIM100,DIM50,DIAGCODE,ALDIDESC
          MOVE      DIM100,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MHCU9999          
.
MHCU9999  RETURN
+
.******************************************************************************
.         RFDU0000 - Add Referral In/Out Destination
.******************************************************************************
.
RFDU0000  MOVE      "zU",CATEGORY 
          PACK     KEY5,CATEGORY,DIAGCODE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE    "N/A",TDESC
          ENDIF
.
          IF        REFERLIN=1
            PACK      KEY22,DIAGCODE,ADMISSNO,ZERO4,SP70
          ELSE
            PACK      KEY22,DIAGCODE,ADMISSNO,ZERO3,SP70
          ENDIF
          CALL      RSALRHL2
RFDU1000  CALL      RKALRHL2
          BRANCH    OVRCD,RFDU1500
.
          MATCH     DIAGCODE,ALRHCODE
          IF        @EQUAL
            MATCH     ADMISSNO,ALRHVISN
            IF        @EQUAL
              IF        REFERLIN=1
                MATCH     ZERO4,ALRHTYPE
                GOTO      RFDU9000 IF EQUAL
              ELSE
                MATCH     ZERO3,ALRHTYPE
                GOTO      RFDU9000 IF EQUAL
              ENDIF
            ENDIF
          ENDIF
.
RFDU1500  IF        REFERLIN=1
            PACK      KEY13,ADMISSNO,ZERO4,Z70
          ELSE
            PACK      KEY13,ADMISSNO,ZERO3,Z70
          ENDIF
          CALL      RSALRHL1
          CALL      RPALRHL1
          BRANCH    OVRCD,RFDU2000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      RFDU2000 IF NOT EQUAL
.
          IF        REFERLIN=1
            MATCH     ZERO4,ALRHTYPE
            GOTO      RFDU2000 IF NOT EQUAL
          ELSE
            MATCH     ZERO3,ALRHTYPE
            GOTO      RFDU2000 IF NOT EQUAL
          ENDIF
.
          GOTO      RFDU3000
.
RFDU2000  MOVE      ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
          GOTO      RFDU4000
.
RFDU3000  MOVE      ALRHUNIQ,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
.
RFDU4000  MOVE      DIAGCODE,ALRHCODE
          MOVE      DIAGDATE,ALRHDATE
          MOVE      ADMISSNO,ALRHVISN
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
          MOVE      DIAGCOD2,ALRHCOD2
.          
          IF        REFERLIN=1
            MOVE      ZERO4,ALRHTYPE
          ELSE
            MOVE      ZERO3,ALRHTYPE
          ENDIF
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      RAALRHL1
          IF        OVRCD=1
            CALL      WRALRHL1
          ENDIF
.
          GOTO      RFDU9999
.
RFDU9000  MOVE      "Warning referral destination already exist:",DIM50
          PACK      DIM100,DIM50,DIAGCODE,TDESC
          MOVE      DIM100,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFDU9999
.
RFDU9999  RETURN
+
.******************************************************************************
.         OFAU0000 - Update main health condition
.******************************************************************************
.
OFAU0000  PACK      KEY12,DEPTCODE,DIAGCODE,SP70
          CALL      RDALPRR1
          IF        OVRCD=1
            MOVE    "N/A",ALPRDESC
          ENDIF
.
          PACK      KEY22,DIAGCODE,ADMISSNO,ZERO2,SP70
          CALL      RSALRHL2
OFAU1000  CALL      RKALRHL2
          BRANCH    OVRCD,OFAU1500
.
          MATCH     DIAGCODE,ALRHCODE
          IF        @EQUAL
            MATCH     ADMISSNO,ALRHVISN
            IF        @EQUAL
              MATCH     ZERO2,ALRHTYPE
              GOTO      OFAU9000 IF EQUAL
            ENDIF
          ENDIF
.
OFAU1500  PACK      KEY13,ADMISSNO,ZERO2,Z70
          CALL      RSALRHL1
          CALL      RPALRHL1
          BRANCH    OVRCD,OFAU2000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      OFAU2000 IF NOT EQUAL
.
          MATCH     ZERO2,ALRHTYPE
          GOTO      OFAU2000 IF NOT EQUAL
.
          GOTO      OFAU3000
.
OFAU2000  MOVE      ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
          GOTO      OFAU4000
.
OFAU3000  MOVE      ALRHUNIQ,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
.
OFAU4000  MOVE      DIAGCODE,ALRHCODE
          MOVE      ADMISSNO,ALRHVISN
          MOVE      ZERO2,ALRHTYPE
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
.
          PACK      KEY13,ADMISSNO,ZERO2,FORM3,SP70
.
          CALL      RAALRHL1
          IF        OVRCD=1
            CALL      WRALRHL1
          ENDIF
.
          GOTO      OFAU9999
.
OFAU9000  MOVE      "Warning other factors already exist:",DIM50
          PACK      DIM100,DIM50,DIAGCODE,ALPRDESC
          MOVE      DIM100,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OFAU9999
.
OFAU9999  RETURN

.******************************************************************************
. Add Referral
.******************************************************************************
ADDREF00  MATCH     SP3,DEPTCODD            * Check If Dept is Blank
          GOTO      ADDREF91 IF EQUAL
.
          PACK      KEY3,DEPTCODD,SP70      * Checks if Using Referral is '0'
          CALL      RDALDEP1
          BRANCH    OVRCD,ADDREF99
.
          MATCH     "0",ALDEREFE
          GOTO      ADDREF93 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      ADDREF87 IF EQUAL
.
          IF        CHOSTYP=1
            MATCH     "1",ALREF003
            IF        @EQUAL
              MATCH     "T-",URNUMBER
              GOTO      ADDREF89 IF EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDREF84
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDREF84
.
          IF        PCEASE=1
            MATCH    SP70,PDECDTE
            IF       @EQUAL
              MOVE      "Patient is Deceased.",WEBTITLE
              ADD       ONE,WARCOUNT
              MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
              MOVE      TWO,EXIT
            ELSE
.
              MATCH     Z70,ALREF019
              IF        !@EQUAL
                MATCH     ALREF019,PDECDTE         * Check referral date
                IF        @LESS
                  MOVE      "Patient is Deceased.",WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                  MOVE      TWO,EXIT
                ENDIF
              ELSE 
                PACK      CURRDATE,CCC,CYY,CMM,CDD
                MATCH     CURRDATE,PDECDTE         * check referral date
                IF @LESS
                  MOVE      "Patient is Deceased.",WEBTITLE
                  ADD       ONE,WARCOUNT
                  MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                  MOVE      TWO,EXIT
                ENDIF
              ENDIF
.
            ENDIF
          ENDIF
.
          CALL      RECV0000                  * Vic and NZ - Received date edit
          BRANCH    EXIT,ADDREF99
.
          COMPARE   ONE,MASUPDFL
          GOTO      ADDREF08 IF NOT EQUAL
.
          CALL      MVPMI000         * move cgi variables 
          CALL      UPMAST1          * update pmi file
.
          CALL      UPPMPX21         * update extension file
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP              * broadcast PMI update message
.
ADDREF08  MOVE      ZERO,WINCLFLG
          MATCH     SP70,REDIRECT    * check if redirect is set
          IF        @EQUAL
            MOVE    ONE,WINCLFLG     * if not do window close in WEBWAR00
          ENDIF
.
          MATCH     ALREF028,ALREF029
          GOTO      ADDREF86 IF EQUAL
.
          MATCH     ALREF028,ALREF030
          GOTO      ADDREF86 IF EQUAL
.
          MATCH     Z70,ALREF030
          IF        !@EQUAL
            MATCH     SP70,ALREF030
            IF        !@EQUAL
              MATCH     ALREF030,ALREF029
              GOTO      ADDREF86 IF EQUAL
            ENDIF
          ENDIF
.
.  Check for Active/Inactive Referral in This Department
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
ADDREF10  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,ADDREF30
          MATCH     URNUMBER,ALREURNO
          GOTO      ADDREF30 IF NOT EQUAL
.
          MATCH     "1",ALREF083            * Are we adding a VINAH Referral
          GOTO      ADDREF12 IF NOT EQUAL
.
          MATCH     "1",ALREUYN4            * Is this a VINAH master Referral
          GOTO      ADDREF10 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Match department for VINAH
          GOTO      ADDREF10 IF NOT EQUAL   * master referrals
.
          GOTO      ADDREF13
.
ADDREF12  MATCH     DEPTCODE,ALREDEPT       * Match department for non
          GOTO      ADDREF10 IF NOT EQUAL   * SACS referrals
.
ADDREF13  MATCH     "1",ALREF083            * Are we adding a SACS Referral
          IF        @EQUAL
            MATCH     "0",ALRESTAT
            GOTO      ADDREF19 IF EQUAL
          ENDIF     
          MATCH     "1",ALRESTAT
          GOTO      ADDREF19 IF EQUAL
          MATCH     "3",ALRESTAT
          GOTO      ADDREF19 IF EQUAL
          GOTO      ADDREF10
.
ADDREF19  IF        PTCNHDPS=1
            MATCH     "1",ALREF083          * Are we adding a master referral
            IF        @EQUAL
              MATCH     "1",ALDEAONE        * If NZ check deprtment file
              IF        @EQUAL
                MOVE      ZERO,OVERRIDE     * Only allow 1 Waiting/Active
              ELSE
                MOVE      TWO,OVERRIDE      * Allow multiple Waiting/Active
              ENDIF
            ENDIF
          ENDIF
.
          BRANCH    OVERRIDE,ADDREF20,ADDREF30
          GOTO      ADDREF88
.
ADDREF20  MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MOVE      "2",ALRESTAT
          CALL      URMHI000                * Set MHINC indicator
.
          PACK      ALREDCLO,CCC,CYY,CMM,CDD
          REP       " 0",ALREDCLO
          CLOCK     TIME,ALRETCLO
          MOVE      USERID,ALREUCLO
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          PACK      KEY16,ALREURNO,ALREVISN,SP70
          CALL      UPALREF2
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1              * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          MOVE      ALREDINA,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
.        Insertion for fix ends here
.
ADDREF30  CALL      CLALLREF
          CALL      CLALLEID
          MOVE      "0",ALRESTAT
.
.-------- Check if activate referral option is turned on       *T0872253
          IF        ACTIVREF=1
            MOVE      "1",ALRESTAT          * Activate Referral
          ENDIF
.
          MOVE      SP70,SAVVPRTY           * Save referral priority
          MOVE      SP70,SAVVTRGS           * Save referral triage status
          CALL      MVALRE00
.
          MOVE      DEPTCODE,ALREDEPT       * populate the CGI parameters
          MOVE      USERID,ALRECUID         * Entered By
.
          MATCH     "1",ALRESTAT            * status
          IF        @EQUAL
            MATCH     Z70,ALREF004
            IF        @EQUAL
              PACK      ALREDACT,CCC,CYY,CMM,CDD
              REP       " 0",ALREDACT
            ENDIF
          ENDIF
.
          PACK      ALRECDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRECDAT
.
          MATCH     SP70,ALRERDAT
          IF        @EQUAL
            PACK      ALRERDAT,CCC,CYY,CMM,CDD    * Set referral date to today
            REP       " 0",ALRERDAT               * if it is not on the template
          ENDIF
.
          CLOCK     TIME,ALRECTIM           * time record created
          MOVE      USERID,ALRECUID         * webuser id created
.                                           * Generating Visit Number
ADDREF70  READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,AADMNO
          ELSE 
            MOVE      " 10",PRXCODE   * System Lock Sector 10
            CALL      GETSLK00        * Get System Lock of Sector 10
            READ      CONTROLF,TEN;*1,FORM8V
            ADD       ONE,FORM8V
            WRITAB    CONTROLF,TEN;*1,FORM8V
            CALL      RELSLK00        * Release System Lock of Sector 10
            SUB       ONE,FORM8V
            MOVE      FORM8V,AADMNO
          ENDIF
.
          MOVE      AADMNO,ADMISSNO         * got visit number
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDAVISA1
          COMPARE   ZERO,OVRCD
          GOTO      ADDREF70 IF EQUAL       * get the next Admission Number
.
          CALL      MHCA0000           * Add main health condition 1 and 2 (SOP)
          CALL      MHCT0000
          CALL      OFAH0000
          CALL      REFD0000
          CALL      TCDT0000
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAALREF1
          COMPARE   ZERO,OVRCD
          GOTO      ADDREF70 IF EQUAL
.                                            * Creating record in Visit  Table
          MOVE      URNUMBER,PVIURNO
          MATCH     ALREF019,Z70
          IF        @EQUAL
            PACK      ALREF019,CCC,CYY,CMM,CDD
            REP       " 0",ALREF019
            PACK      PVIDATE,CCC,CYY,CMM,CDD
            REP       " 0",PVIDATE
          ELSE
            REP       " 0",ALREF019
            MOVE      ALREF019,PVIDATE
          ENDIF
.
          MOVE      AADMNO,PVIBILL
          MOVE      "9",PVITYPE
          MOVE      " 2",PVISYST
          MOVE      ALREHCP,PVIDOCT
          MOVE      "2",PVISTAT
          MOVE      "1",PVITRAN
          MOVE      WBSESIT,PVISITE
          PACK      KEY8,AADMNO,SP70
          CALL      RDAVISA1
          COMPARE   ZERO,OVRCD
          GOTO      ADDREF70 IF EQUAL
          CALL      WRPTVIS1                * write to the patvisaf file
.                                           * write to Visit extension table
          CALL      CLPMSVX1
          MOVE      AADMNO,PMVXVISN
          MATCH     ALREF019,Z70
          IF        @EQUAL
            PACK      PMVXVSDT,CCC,CYY,CMM,CDD
            REP       " 0",PMVXVSDT
          ELSE
            MOVE      ALREF019,PMVXVSDT
          ENDIF
          MOVE      ALREHCP,PMVXDOCA
          MOVE      "0",PMVXCSNR
          MOVE      PPOST,PMVXPOST
          MOVE      "0",PMVXCFSG
          MOVE      "0",PMVXINGP
          MOVE      "0",PMVXHCP1
          MOVE      "0",PMVXHCP2
          MOVE      "0",PMVXHCP3
          MOVE      "0",PMVXHCP4
          MOVE      ALRERHCP,PMVXRHC1
          MOVE      ALRERHCR,PMVXRH1G
          MOVE      "1",PMVXRH1C
          MOVE      "0",PMVXPSTY
          MOVE      "0",PMVXVALW
          MOVE      "0",PMVXPALW
          MOVE      "0",PMVXINDC
          MOVE      "0",PMVXHOME
          CALL      IBACLOCK
          PACK      PMVXCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMVXCDTE
          MOVE      CTIMEIS,PMVXCTIM
          MOVE      WBSEUID,PMVXWEBC
          CALL      GTASGC00                * get SLA/ASGC code
.
          MATCH     Z70,ALREF107
          IF        !@EQUAL
            MOVE      ALREF107,PMVXMHOS
          ELSE
            MOVE      ALDEHOSP,PMVXMHOS
          ENDIF
.
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXPILC
.
          MATCH     Z70,PMSVX010
          IF        !@EQUAL
            PACK      PMVXINGP,PMSVX010,SP70
          ENDIF
.
          MATCH     PMSVX093,Z70
          IF        !@EQUAL
            MOVE      PMSVX093,PMVXINTR
          ENDIF
.
          MATCH     PMSVX141,Z70
          IF        !@EQUAL
            MOVE      PMSVX141,PMVXFSRC
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RAPMVX11                * write to the Visit Extenson file
          IF        OVRCD=1
            CALL      WRPMVX11                * write to the Visit Extenson file
          ENDIF
.                                           * Creating record in Referral Table
          MOVE      URNUMBER,ALREURNO
          MOVE      ADMISSNO,ALREVISN
          MOVE      DEPTCODE,ALREDEPT
.
          MATCH     Z70,ALREF107
          IF        !@EQUAL
            MOVE      ALREF107,ALREHOSN
          ELSE
            MOVE      ALDEHOSP,ALREHOSN
          ENDIF
.
          CALL      CMBS0000                * Check for any CMBS item
.
          CALL      ALJOBN00                * Check if job number is needed
.
          CALL      ARMHI000                * Set to 'Unsent' - MHINC extract
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII12                * broadcast Add Referral (REF^I12)
.
          PACK      KEY8,ADMISSNO,SP70      * Writing D/B Fields
          CALL      WRALREF1                * write to the referral table
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN           
            CALL      RDALAEF1
            IF        OVRCD=1
              CALL      MVALAE00              
              CALL      WRALAEF1            * write to aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          IF        EIDEXIST=1
            CALL      CLALLEID
            CALL      MVALEI00                * Extra Inbound Data
            MOVE      ALREVISN,ALEIVISN
            CALL      WRALEID1                * write to alleidaf
          ENDIF
.
          CALL      PRAL0000                * print letters and labels
.
          IF        PTCNHDPS=1
            CALL      WRPORD00                * write ACC Purchase order number
          ENDIF
.
          MATCH     Z70,ALDAD001
          IF        !@EQUAL
            CALL      WRDAD000
          ENDIF
.
          COMPARE   ONE,MEHRFLAG
          IF        @EQUAL
            CALL      WRMEH000
          ENDIF
.
          MATCH     SP70,SACSVISN
          IF        !@EQUAL
            MOVE      SACSVISN,ALRLVISN
            MOVE      ADMISSNO,ALRLLNKV
            PACK      ALRLCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALRLCDAT
            CLOCK     TIME,ALRLCTIM
            MOVE      USERID,ALRLCUID
            MOVE      SP70,ALRLSPAR
            PACK      KEY16,SACSVISN,ADMISSNO
            CALL      RDALRLN1
            IF        OVRCD=1
              CALL      WRALRLN1            * Write to SAC referral link file
            ENDIF
          ENDIF
.
          MATCH     SP70,INTRVISN
          IF        !@EQUAL
            MATCH     "1",ALREUYN4
            IF        @EQUAL
              MOVE      ADMISSNO,ALRLVISN
              MOVE      INTRVISN,ALRLLNKV
              PACK      ALRLCDAT,CCC,CYY,CMM,CDD
              REP       " 0",ALRLCDAT
              CLOCK     TIME,ALRLCTIM
              MOVE      USERID,ALRLCUID
              MOVE      SP70,ALRLSPAR
              PACK      KEY16,ADMISSNO,INTRVISN,SP70
              CALL      RDALRLN1
              IF        OVRCD=1
                CALL      WRALRLN1            * Write to SAC referral link file
              ENDIF
              PACK      KEY13,INTRVISN,ZERO4,SP2,ONE,SP70  * Delete referral in
              CALL      DEALRHL1                 * service type from episode ref
            ENDIF
          ENDIF
. 
          MOVE      AADMNO,ALSTVISN
          MOVE      ALRESTAT,ALSTSTAT
          MOVE      ALRERDAT,ALSTSDAT
          PACK      ALSTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSTCDAT
          CLOCK     TIME,ALSTCTIM
          MOVE      WBSEUID,ALSTCUID
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT,SP70
          CALL      WRALSTS1                * write to Ref Status History Table
.                                           * write record Referral Audit Table
          MOVE      "A ",UPDTTYPE
          CALL      WRTRAU00
.
          MOVE      ONE,AUDTTYPE            * write history record
          CALL      WAALRE00
.
          MATCH     SP70,EREFRLID
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      " 8",KEY2
            MOVE      ALREVISN,KEY8
            MOVE      SP70,KEY19
            PROC      UPEREFVS              * Update eReferral Details
          ENDIF
.                                      * Save referral priority set above
          MOVE      ALREVISN,SAVVREFN  * Referral number
          PROC      VDEF0000           * VINAH Field defaults
.
          MATCH     SP70,INTRVISN      * Linking program ref to episode ref
          IF        !@EQUAL
            MATCH     "1",ALREUYN4     * Program referral
            IF        @EQUAL
              MOVE      INTRVISN,CHECKREF     * Episode referral number
              CALL      AMAS0000              * Auto activate master referral
.
              MOVE      INTRVISN,CHECKREF     * Episode referral number
              CALL      RMAS0000              * Auto reject master referral
.
              PACK      KEY8,ADMISSNO,SP70    * Re Read master referral
              CALL      RDALREF1
            ENDIF
          ENDIF
.
          CALL      DISWAR00 
          BRANCH    EXIT,ADDREF99
.
          COMPARE   ONE,PTCNUEOC
          GOTO      ADDREF71 IF EQUAL
          GOTO      ADDREF75
.
ADDREF71  PACK      KEY5,ANSC,ANSL,ALREF035
          CALL      RDCODE1
          BRANCH    OVRCD,ADDREF83            
.
          MATCH     ANSA,TCINDC3                 * Concessional Indicator?
          IF        @EQUAL 
            MATCH     SP70,ADMISSNO               
            IF        !@EQUAL
              REP       " +",ADMISSNO            * Redirect admission number  
              ENDSET    REDIRECT                  
              APPEND    ADMISSNO,REDIRECT
              RESET     REDIRECT
              SQUEEZE   REDIRECT
              REP       "+ ",ADMISSNO
            ENDIF
          ENDIF
.
ADDREF75  MATCH     "6",NEXTPAGE    // AJAX Add Primary Referral
          IF        @EQUAL
            CALL      AJAXRD00
            GOTO      ADDREF99
          ENDIF
.
          IF        EXIT=TWO
            CALL      WEBWAR00
          ELSE
            MOVE      ZERO,EXIT
            MATCH     SP70,ADMISSNO               
            IF        !@EQUAL
              REP       " +",ADMISSNO            * Redirect admission number  
              ENDSET    REDIRECT                  
              APPEND    "&admissno=",REDIRECT    * redirect may have admission
              APPEND    ADMISSNO,REDIRECT        * no twice (first adm=0)
              APPEND    "&bookwarn=",REDIRECT    * Check for unlinked bookings
              APPEND    BOOKWARN,REDIRECT        * warning for hic referrals
              RESET     REDIRECT
              SQUEEZE   REDIRECT
              REP       "+ ",ADMISSNO
            ENDIF
          ENDIF
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            MOVE      "01",KEY2                 * IHI Validation
.            PACK      KEY11,WBSEUID,SP70        * User ID
.            PACK      KEY50,ALREURNO,SP70
.            CALL      WIPL0000                  * Write to polling table
.          ENDIF
.
          GOTO      ADDREF99
.
ADDREF83  MOVE      "Category CL not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF84  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF85  MOVE      "Patient is Deceased.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF86  MOVE      "Duplicate problem codes can not be used.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF87  MOVE      "The UR Number can not be blank/alredy exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF88  MATCH     "1",ALREF083
          IF        @EQUAL
            PACK      KEY5,CATCG,ALREDEPT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              SQUEEZE   ALCNMDES
              STRIP     TDESC
              CLEAR     WEBTITLE
              APPEND    "A Waiting or Active ",WEBTITLE
              APPEND    ALCNMDES,WEBTITLE
              APPEND    " Referral for ",WEBTITLE
              APPEND    TDESC,WEBTITLE
              APPEND    " already exists",WEBTITLE
              RESET     WEBTITLE
              RESET     ALCNMDES
            ENDIF
          ELSE
            MOVE      "Patient has an Active/Inactive Referral.",WEBTITLE
          ENDIF
.
          CALL      WEBOVR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF89  MOVE      "You must have a valid U/R and this must be merged",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF90  MOVE      "Event Already Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF92  MOVE      "Invalid or No Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF93  MOVE      "Invalid Referral Department.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF94  MOVE      "Invalid Referral Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF95  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF96  MOVE      "Date Closed must be > Date Active",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF97  MOVE      "Date Inactive must be > Date Active",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99

ADDREF98  MOVE      "Date Inactive until be > Date Inactive",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF99  RETURN
+
.******************************************************************************
.         MHCR0000 - main health condition removal 
.******************************************************************************
.
MHCR0000  PACK      KEY13,ADMISSNO,ZERO1,SP70
          CALL      RSALRHL1
MHCR1000  CALL      RKALRHL1
          BRANCH    OVRCD,MHCR9999
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      MHCR9999 IF NOT EQUAL
.
          MATCH     ZERO1,ALRHTYPE
          GOTO      MHCR1000 IF NOT EQUAL
.
          MATCH     ALRHCODE,DIAGCODE
          GOTO      MHCR1000 IF NOT EQUAL
.
          PACK      KEY13,ADMISSNO,ZERO1,ALRHUNIQ
          CALL      DEALRHL1
.
          GOTO      MHCR9999
.
MHCR9999  RETURN
+
.******************************************************************************
.         RFDR0000 - referral In/Out destination removal
.******************************************************************************
.
RFDR0000  IF        REFERLIN=1
            PACK      KEY13,ADMISSNO,ZERO4,SP70
          ELSE
            PACK      KEY13,ADMISSNO,ZERO3,SP70
          ENDIF
.
          CALL      RSALRHL1
RFDR1000  CALL      RKALRHL1
          BRANCH    OVRCD,RFDR9999
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      RFDR9999 IF NOT EQUAL
.
          IF        REFERLIN=1
            MATCH     ZERO4,ALRHTYPE
            GOTO      RFDR1000 IF NOT EQUAL
          ELSE
            MATCH     ZERO3,ALRHTYPE
            GOTO      RFDR1000 IF NOT EQUAL
          ENDIF
.
          MATCH     ALRHCODE,DIAGCODE
          GOTO      RFDR1000 IF NOT EQUAL
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      DEALRHL1
.
          GOTO      RFDR9999
.
RFDR9999  RETURN
+
.******************************************************************************
.         OFAR0000 - main health condition removal
.******************************************************************************
.
OFAR0000  PACK      KEY13,ADMISSNO,ZERO2,SP70
          CALL      RSALRHL1
OFAR1000  CALL      RKALRHL1
          BRANCH    OVRCD,OFAR9999
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      OFAR9999 IF NOT EQUAL
.
          MATCH     ZERO2,ALRHTYPE
          GOTO      OFAR1000 IF NOT EQUAL
.
          MATCH     ALRHCODE,DIAGCODE
          GOTO      OFAR1000 IF NOT EQUAL
.
          PACK      KEY13,ADMISSNO,ZERO2,ALRHUNIQ
          CALL      DEALRHL1
.
          GOTO      OFAR9999
.
OFAR9999  RETURN
+
.******************************************************************************
.         MHINC - Add Referral for MH Department and Primary Ref.
.******************************************************************************
ARMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ARMHI999
.
          MATCH     "M",TCINDC4
          GOTO      ARMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      ARMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MOVE      "0",ALREMOHR               * Unsent
.
ARMHI999  RETURN
+
.******************************************************************************
.         MHINC - Update Referral
.******************************************************************************
URMHI000  MATCH     "1",ALREUYN4
          GOTO      URMHI900 IF NOT EQUAL      * Not Primary Referral
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,URMHI900
.
          MATCH     "M",TCINDC4
          GOTO      URMHI900 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "0",ALREMOHR
          GOTO      URMHI200 IF EQUAL          * Unsent
.
          MATCH     "1",ALREMOHR
          GOTO      URMHI400 IF EQUAL          * Sent
.
          GOTO      URMHI900
.
.         if Closing referral for Unsent - then set indicator to 4
.
URMHI200  MATCH     "2",ALRESTAT
          GOTO      URMHI900 IF NOT EQUAL     * not Close status
.
          MOVE      "4",ALREMOHR              * 'Send RF and Discharge required'
          GOTO      URMHI900
.
.         Already sent
.
URMHI400  MATCH     "2",ALRESTAT
          GOTO      URMHI500 IF EQUAL          * Close Referral
.
          MATCH     "4",ALRESTAT
          GOTO      URMHI600 IF EQUAL          * Cancelled
.
          MATCH     "5",ALRESTAT
          GOTO      URMHI600 IF EQUAL          * Rejected
.
          MOVE      "0",ALREMOHR               * Unsent/Resend
.
.         If this was re-actived from Closed sent Referral - set indicator to 5
.
          IF        RACTVFLG=1
            MOVE      "5",ALREMOHR             * 'Send Delete Discharge'
          ENDIF
            
          GOTO      URMHI900
.
URMHI500  MOVE      "3",ALREMOHR               * Send Discharge required
          GOTO      URMHI900
.
URMHI600  MOVE      "2",ALREMOHR               * Send delete
          GOTO      URMHI900
.
URMHI900  MOVE      ZERO,RACTVFLG
URMHI999  RETURN
+
.------------------------------------------------------------
. MCHT0000 - Main health condition array populating 
.            from add screen with no admissno
.------------------------------------------------------------
.
MHCT0000  MOVE      ZERO,FORM2
          MOVE      ZERO,FORM3
          MATCH     SP70,ADMISSNO
.
          PACK      KEY13,ADMISSNO,ZERO1,Z70
          CALL      RSALRHL1
          CALL      RPALRHL1                * Get last main health condition
          BRANCH    OVRCD,MHCT0500          * unique count
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      MHCT0500 IF NOT EQUAL
.
          MATCH     ZERO1,ALRHTYPE
          GOTO      MHCT0500 IF NOT EQUAL
.
          MOVE      ALRHUNIQ,FORM3
.
MHCT0500  ADD       ONE,FORM3
          PACK      KEY13,ADMISSNO,ZERO1,FORM3,SP70
          CALL      RDALRHL1
          IF        OVRCD=1
.
            PACK      ALRHVISN,ADMISSNO
            PACK      ALRHTYPE,ZERO1
.
MHCT1000    IF        FORM2 < _MHCCNT
              ADD       ONE,FORM2
              PACK      ALRHUNIQ,FORM3
              PACK      ALRHCUID,USERID
              PACK      ALRHCDAT,CCC,CYY,CMM,CDD
              REP       " 0",ALRHCDAT
              CLOCK     TIME,ALRHCTIM            
              PACK      ALRHCODE,MHCARRAY[FORM2]
              ADD       ONE,FORM3
              CALL      WRALRHL1           * write to file health condition
              GOTO      MHCT1000
            ENDIF
.
          ENDIF
.            
MHCT9999  RETURN
+
.------------------------------------------------------------
.         REFD0000 - Referral destination array populating
.                    from add screen with no admissno
.------------------------------------------------------------
.
REFD0000  MOVE      ZERO,FORM2
          MATCH     SP70,ADMISSNO
.
          MOVE      ONE,FORM3
          IF        REFERLIN=1
            PACK      KEY13,ADMISSNO,ZERO4,FORM3,SP70
          ELSE
            PACK      KEY13,ADMISSNO,ZERO3,FORM3,SP70
          ENDIF
          CALL      RDALRHL1
          IF        OVRCD=1
.
            PACK      ALRHVISN,ADMISSNO
            IF        REFERLIN=1
              PACK      ALRHTYPE,ZERO4
            ELSE
              PACK      ALRHTYPE,ZERO3
            ENDIF
.
REFD1000    IF        FORM2 < _RFDCNT
              ADD       ONE,FORM2
              PACK      ALRHUNIQ,FORM3
              PACK      ALRHCUID,USERID
              PACK      ALRHCDAT,CCC,CYY,CMM,CDD
              REP       " 0",ALRHCDAT
              CLOCK     TIME,ALRHCTIM
              PACK      ALRHDATE,RDAARRAY[FORM2]
              PACK      ALRHCODE,RFDARRAY[FORM2]
              PACK      ALRHCOD2,RFPARRAY[FORM2]
              ADD       ONE,FORM3
              CALL      WRALRHL1              * write to file health condition
              GOTO      REFD1000
            ENDIF
.
          ENDIF
.
REFD9999  RETURN
+
.------------------------------------------------------------
.         REFU0000 - Update allrhl
.------------------------------------------------------------
REFU0000  PACK      KEY13,ADMISSNO,ZERO4,SP1,SP1,ONE,SP70
          CALL      RDALRHL1
          BRANCH    OVRCD,REFU5000
.
          MATCH     SP70,RDAARRAY[1]
          IF        !@EQUAL
            PACK      ALRHDATE,RDAARRAY[1]
          ENDIF
.
          PACK      ALRHCODE,RFDARRAY[1]
          PACK      ALRHCOD2,RFPARRAY[1]
.
          CALL      UPALRHL1
          GOTO      REFU9999
.
REFU5000  MATCH     SP70,RDAARRAY[1]
          GOTO      REFU6100 IF NOT EQUAL
.
          MATCH     SP70,RFDARRAY[1]
          GOTO      REFU6100 IF NOT EQUAL
.
          MATCH     SP70,RFPARRAY[1]
          GOTO      REFU6100 IF NOT EQUAL
.
          GOTO      REFU9999

REFU6100  CALL      CLALLRHL
.
          PACK      ALRHVISN,ADMISSNO
          PACK      ALRHTYPE,ZERO4
.
          MOVE      ONE,FORM3
          PACK      ALRHUNIQ,FORM3
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
.
          PACK      ALRHDATE,RDAARRAY[1]
          PACK      ALRHCODE,RFDARRAY[1]
          PACK      ALRHCOD2,RFPARRAY[1]
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      WRALRHL1
.
REFU9999  RETURN
+
.------------------------------------------------------------
.         TCDT0000 - transition care date array populating
.                    from add screen with no admissno
.------------------------------------------------------------
TCDT0000  MOVE      ZERO,FORM2
.
          MOVE      ONE,FORM3
          PACK      KEY13,ADMISSNO,ZERO,FIVE,FORM3,SP70
          CALL      RDALRHL1
          IF        OVRCD=1
.
            PACK      ALRHVISN,ADMISSNO
            PACK      ALRHTYPE,ZERO,FIVE,SP70
.
TCDT1000    IF        FORM2 < _TCDCNT
              ADD       ONE,FORM2
              PACK      ALRHUNIQ,FORM3
              PACK      ALRHCUID,USERID
              PACK      ALRHCDAT,CCC,CYY,CMM,CDD
              REP       " 0",ALRHCDAT
              CLOCK     TIME,ALRHCTIM
              PACK      ALRHDATE,TDDARRAY[FORM2]
              PACK      ALRHCODE,TCDARRAY[FORM2]
              MOVE      SP70,ALRHCOD2
              ADD       ONE,FORM3
              CALL      WRALRHL1                    * write transition care date
              GOTO      TCDT1000
            ENDIF
          ENDIF
.
TCDT9999  RETURN
+
.------------------------------------------------------------
. OFAH0000 - Other factors affecting health array populating
.            from add screen with no admissno
.------------------------------------------------------------
.
OFAH0000  MOVE      ZERO,FORM2
          MATCH     SP70,ADMISSNO
.
          MOVE      ONE,FORM3
          PACK      KEY13,ADMISSNO,ZERO2,FORM3,SP70
          CALL      RDALRHL1
          IF        OVRCD=1
.
            PACK      ALRHVISN,ADMISSNO
            PACK      ALRHTYPE,ZERO2
.
OFAH1000    IF        FORM2 < _OFACNT
              ADD       ONE,FORM2
              PACK      ALRHUNIQ,FORM3
              PACK      ALRHCUID,USERID
              PACK      ALRHCDAT,CCC,CYY,CMM,CDD
              REP       " 0",ALRHCDAT
              CLOCK     TIME,ALRHCTIM
              PACK      ALRHCODE,OFAARRAY[FORM2]
              ADD       ONE,FORM3
              CALL      WRALRHL1        * write to file health condition
              GOTO      OFAH1000
            ENDIF
.
          ENDIF
.
OFAH9999  RETURN
+
.------------------------------------------------------------
. Write to alldadaf if required
.------------------------------------------------------------
WRDAD000  PACK      KEY8,ALREVISN,SP70
          CALL      RDALDAD1
          IF        OVRCD=1
            PACK      ALDAFHOS,SP70
            PACK      ALDATHOS,SP70
          ENDIF
.
          PACK      ALDAVISN,ALREVISN,SP70
          MATCH     Z70,ALDAD001
          IF        !@EQUAL
            PACK      ALDAFHOS,ALDAD001,SP70
          ENDIF
.
          MATCH     Z70,ALDAD002
          IF        !@EQUAL
            PACK      ALDATHOS,ALDAD002,SP70
          ENDIF
          PACK      ALDASPAR,SP70
.
          PACK      KEY8,ALDAVISN,SP70
          CALL      RAALDAD1
          IF        OVRCD=1
            CALL      WRALDAD1
          ELSE
            CALL      UPALDAD1
          ENDIF
.
WRDAD999  RETURN
.------------------------------------------------------------
. Check for CMBS items
.------------------------------------------------------------
CMBS0000  PACK      KEY10,ADMISSNO,SP10
          CALL      RSALRIT1
          CALL      RKALRIT1
          BRANCH    OVRCD,CMBS1000
          MATCH     ADMISSNO,ALRTVISN
          GOTO      CMBS1000 IF NOT EQUAL    * Different visit number
.
          PACK      KEY10,ALRTVISN,ALRTITMC
          CALL      DEALRIT1
          GOTO      CMBS0000
.
CMBS1000  MOVE      ZERO,F2
          MOVE      ZERO,FORM2
          MOVE      ADMISSNO,ALRTVISN         * Visit number
.
CMBS1200  COMPARE   FIVE,F2
          GOTO      CMBS9999 IF EQUAL         * reach maximum of 5 MBS items
          ADD       ONE,F2
          LOAD      ALRTIFLG,F2,ALRIT001,ALRIT004,ALRIT007,ALRIT010,ALRIT013
.
          MATCH     Z70,ALRTIFLG
          GOTO      CMBS1200 IF EQUAL
.
          MATCH     SP70,ALRTIFLG
          GOTO      CMBS1200 IF EQUAL
.
          LOAD      ALRTITMN,F2,ALRIT002,ALRIT005,ALRIT008,ALRIT011,ALRIT014
          LOAD      ALRTSUBN,F2,ALRIT003,ALRIT006,ALRIT009,ALRIT012,ALRIT015
          LOAD      ALRTPUSE,F2,ALRIT016,ALRIT017,ALRIT018,ALRIT019,ALRIT020
.
          MATCH     SP70,ALRTITMN
          GOTO      CMBS1200 IF EQUAL
.
          MATCH     Z70,ALRTITMN
          GOTO      CMBS1200 IF EQUAL
.
          ADD       ONE,FORM2
          MOVE      FORM2,ALRTITMC
.
          PACK      KEY10,ALRTVISN,ALRTITMC
          CALL      RAALRIT1
          IF        OVRCD=1
            PACK      ALRTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALRTCDAT             * date created
            CLOCK     TIME,ALRTCTIM             * time created
            MOVE      USERID,ALRTCUID           * web user id
            UNPACK    SP70,ALRTUDAT,ALRTUTIM,ALRTUUID
            CALL      WRALRIT1
          ELSE
            PACK      ALRTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALRTUDAT             * date updated
            CLOCK     TIME,ALRTUTIM             * time updated
            MOVE      USERID,ALRTUUID           * web user id
            CALL      UPALRIT1
          ENDIF
          GOTO      CMBS1200
.
CMBS9999  RETURN
.
.------------------------------------------------------------
. Calculate referral expiry date if required
. Requires - BOOKDATE - Calculate referral expiry date from booking date
.------------------------------------------------------------
CALX0000  MATCH     SP70,ALRERTYP           * No referral type
          GOTO      CALX9999 IF EQUAL
.
          MATCH     SP70,BOOKDATE           * No booking date
          GOTO      CALX9999 IF EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CALX9999
.
          COMPARE   ZERO,TCFORM6            * No days for expiry warning
          GOTO      CALX9999 IF EQUAL
.
          MOVE      BOOKDATE,EXPRDATE
          ADD       TCFORM6,EXPRDATE
          MOVE      EXPRDATE,ALREREXP 

CALX9999  RETURN
.------------------------------------------------------------
. Get SLA/ASGC code from ibapostf
.------------------------------------------------------------
GTASGC00  MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,GTASGC99
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
GTASGC99  RETURN
.------------------------------------------------------------
. Display Warnings
.------------------------------------------------------------
WEBWAR00  CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                              "<script type=#"text/javascript#">{ "
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR20 IF LESS
          GOTO      WEBWAR10
.
WEBWAR20  WRITE     HTMLFILE;"}</script>"
          MATCH     "5",NEXTPAGE
          IF        @EQUAL
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{ ":
                            " redirectTopContent(#"",REDIRECT,"#");":
                               "}":
                               "</script>"
            GOTO      WEBWAR90
          ENDIF
.
          IF        WINCLFLG=1
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{":
                               " if (self.name.match(/PopUpFrame/)) {":
                               "  reloadParentFrame(); ":
                               " else { ":
                               "  opener.history.go(0);":
                               "  self.close(); }":
                               "}":
                               "</script>"
            GOTO      WEBWAR90
          ELSE
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{":
                               " if (self.name.match(/PopUpFrame/)) {":
                               "  redirectParentFrame(#"",REDIRECT,"#");}":
                               " else {":
                               "  location.href=#"",REDIRECT,"#"}":
                               "}":
                               "</script>"
          ENDIF
.
WEBWAR90  CALL      CLOSHTML
          MOVE      TWO,EXIT
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBWAR99  RETURN
.
.******************************************************************************
. Update Referral                                                             *
.******************************************************************************
UPDREF00  MOVE      ONE,VINAHFLG            * set for no after VINAHDEF audits
.
.         Initialise flags to show no audit records have been written
.
          MOVE      ZERO,EPAUDFLG
          MOVE      ZERO,RIAUDFLG
.
          MATCH     SP70,DEPTCODE
          GOTO      UPDREF91 IF EQUAL       * Department code is blank
.
          MATCH     SP70,URNUMBER
          GOTO      UPDREF92 IF EQUAL       * U/R Number is blank
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPDREF92
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDREF92
.
          MATCH     SP70,ADMISSNO
          GOTO      UPDREF93 IF EQUAL       * Visit/Ref is blank
.
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          IF        OVRCD=1
            GOTO    UPDREF99
          ENDIF
.
          MATCH     "0",ALDEREFE
          GOTO      UPDREF91 IF EQUAL       * Department not using referral
.
          MOVE      ZERO,RACTVFLG
          IF        ACTIVREF = 1
            BRANCH    OVERRIDE,UPDREF05,UPDREF05
            CALL      ATVREF00                * Validate and Activate referral
            BRANCH    EXIT,UPDREF94
          ENDIF
.
UPDREF05  MATCH     ALREF028,ALREF029
          GOTO      UPDREF95 IF EQUAL
.
          MATCH     ALREF028,ALREF030
          GOTO      UPDREF95 IF EQUAL
.         
          MATCH     Z70,ALREF030
          IF        !@EQUAL
            MATCH     SP70,ALREF030
            IF        !@EQUAL
              MATCH     ALREF030,ALREF029
              GOTO      UPDREF95 IF EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
.
UPDREF10  CALL      RLALREF1                * read lock
          BRANCH    OVRCD,UPDREF93,UPDREF90
.
          CALL      RECU0000                * Vic and NZ - Received date edit
          BRANCH    EXIT,UPDREF99
.
.         Write a before audit record for the referral, then set the
.         flag to show that we just wrote a before audit record for either
.         an Episode Referral or a Referral In
.
          MOVE      TWO,AUDTTYPE
          CALL      WAALRE00
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ONE,RIAUDFLG
          ELSE
            MOVE      ONE,EPAUDFLG
          ENDIF
.                                      * Save fields for SOP episode 
.                                      * referral  renewal audit
          MOVE      ALRERTYP,SAVEORTY  * Original Type of Ref. (Cat RI)
          MOVE      ALREREXP,SAVEOXDT  * Original Expiry Date (CCYYMMDD)
          MOVE      ALRERRDT,SAVEORDT  * Original Ref Renewal Date(CCYYMMDD
          MOVE      ALREPRTY,SAVVPRTY  * Save referral priority
          MOVE      ALRETRGS,SAVVTRGS  * Save referral triage status
.
          MOVE      ALREHCP,SAVEORES   * Original Responsible HCP (pmshcpaf)
          MOVE      ALRERHCP,SAVEORHC  * Original Referring HCP (pmshcpaf)
          MOVE      ALRERHCR,SAVEORHP  * Original Referring HCP Practice
.
.         * populate the CGI parameters from the screen
          CALL      MVALRE00
.
          MOVE      DEPTCODE,ALREDEPT       * Deptcode
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD  * Populate date record updated
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          IF        ACTIVREF = 1
            PACK      ALREUDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALREUDAT
            CLOCK     TIME,ALREUTIM
            MOVE      USERID,ALREUUID
.
            MATCH     Z70,ALREF004
            IF        @EQUAL
              PACK      ALREDACT,CCC,CYY,CMM,CDD
              REP       " 0",ALREDACT
            ENDIF
.
            MATCH     "2",ALRESTAT          * Closed?
            IF        @EQUAL
              MOVE      ONE,RACTVFLG        * Re-activate referral
            ENDIF
            MOVE      ONE,ALRESTAT          * Activate referral
            MOVE      ALREDACT,ALSTSDAT     * write to Referral History Table
            CALL      WRTRSH00              * write a record to allstsaf
          ENDIF
.
          MATCH     Z70,ALREF107
          IF        !@EQUAL
            MOVE      ALREF107,ALREHOSN
          ELSE
            MOVE      ALDEHOSP,ALREHOSN
          ENDIF
.
          CALL      DOCLMN00                * remove non-compensible claims
          CALL      URMHI000                * Set MHINC indicator
          CALL      UPALREF1                * Update the record
          CALL      UUALREF1
.
          CALL      WEDR0000                * Write EDWARD visit alteration
.
          CALL      MHCQ0000      * main health condition 1 and 2 (SOP)
.
          IF        PTCNHDPS=1
            CALL      WRPORD00             * write/update ACC Purchase Order No
          ENDIF
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          CALL      UPVX0000                * Update visit extension
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          CALL      PRAL0000                * print letters and labels
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1            * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          CALL      WRDAD000                * Update alldadaf
          CALL      CMBS0000                * Check for any CMBS item
          CALL      RNWA0000                * Write referral renewal audit
.
          COMPARE   ONE,MASUPDFL
          GOTO      UPDREF80 IF NOT EQUAL
.
          CALL      MVPMI000         * move cgi variables
          CALL      UPMAST1          * update pmi file
.
          CALL      UPPMPX21         * update extension file
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FIVE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP              * broadcast PMI update message
.
UPDREF80  IF        ACTIVREF = 1
            MOVE      "T",UPDTTYPE           * Activated
            GOTO      UPDREF82                                *T0318661-Start
          ENDIF
.
          MOVE      "U",UPDTTYPE           * Updated
.
.-------- Check if the priority has been updated
.-------- set update type (alauupdt) = R and comments (alaucomm) = xxx to yyy
          MATCH     SAVVPRTY,ALREPRTY      * Priority changed?
          GOTO      UPDREF82 IF EQUAL      * No
.
          MOVE      "R ",UPDTTYPE          * Priority Updated
          MOVE      SAVVPRTY,DIM3
          SQUEEZE   DIM3
          PACK      COMMENTY,DIM3,SPACETOS,ALREPRTY
          GOTO      UPDREF82
.
UPDREF82  CALL      WRTRAU00                                   *T0318661-End
.
          COMPARE   ONE,MEHRFLAG
          IF        @EQUAL
            CALL      UPMEH000               * Write any missing mehvisaf
          ENDIF                              * records for MEH referrals
.
          MOVE      ALREVISN,CHECKREF        * save the referral number
.
          CALL      DISWAR00
          BRANCH    EXIT,UPDREF99
.
          CALL      REFU0000                * Update allrhl
.                                      * Save referral priority set above
          MOVE      ALREVISN,SAVVREFN  * Referral number
UPDREF85  PROC      VDEF0000           * VINAH Field defaults
.
          CALL      AMAS0000                * Auto activate master referral
.
.         Check if an after Episode audit is still required and if so,
.         write one.
.
          IF        EPAUDFLG = 1
            MOVE      THREE,AUDTTYPE             * write after history record
            CALL      WAALRE00
          ENDIF
.
.         Check if an after Referral In audit is still required and if so,
.         write one
.
          IF        RIAUDFLG = 1
            MATCH     SP8,VINAHREF
            IF        !@EQUAL
              MOVE      VINAHREF,KEY8
              CALL      RDALREF1
              IF        OVRCD = 0
                MOVE      THREE,AUDTTYPE         * write after history record
                CALL      WAALRE00
              ENDIF
            ENDIF
            IF        PTCNHDPS=1
              MOVE      ADMISSNO,KEY8
              CALL      RDALREF1
              IF        OVRCD=0        
                MOVE      THREE,AUDTTYPE
                CALL      WAALRE00               * write after history record
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      UPDREF99
.
UPDREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      UPDREF10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF92  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF94  MOVE      "Patient has an Active or Inactive Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF95  MOVE      "Duplicate problem codes can not be used.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF99  MOVE      ZERO,VINAHFLG            * reset flag for VINAHDEF audits
          MOVE      ZERO,EPAUDFLG            * reset flag for no after audit
          MOVE      ZERO,RIAUDFLG            * reset flag for no after audit
          MOVE      SP8,VINAHREF
          RETURN
.******************************************************************************
.Supervisor Update Referral                                                   *
.******************************************************************************
SUPREF00  MATCH     SP70,DEPTCODE
          GOTO      SUPREF91 IF EQUAL       * Department code is blank
.
          MATCH     SP70,URNUMBER
          GOTO      SUPREF92 IF EQUAL       * U/R Number is blank
.
          MATCH     SP70,ADMISSNO
          GOTO      SUPREF93 IF EQUAL       * Visit/Reff is blank
.
          CALL      CDAT0000
          BRANCH    EXIT,SUPREF99
.
          PACK      KEY16,ADMISSNO,Z70
          CALL      RSMHHON1
          CALL      RPMHHON1
          IF        OVRCD=0
            MATCH     ADMISSNO,MHHNVISN
            IF        @EQUAL
              MATCH     MHHNHDAT,ALREF007
              GOTO      SUPREF97 IF LESS
            ENDIF
          ENDIF
.
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          IF        OVRCD=1
            GOTO    SUPREF99
          ENDIF
.
          CALL      SACE0000                * Checks for multiple waiting
          BRANCH    EXIT,SUPREF99           * inactive or open SACS referrals
.
          MOVE      ZERO,RACTVFLG
          IF        ACTIVREF = 1
            BRANCH    OVERRIDE,SUPREF05,SUPREF05
            CALL      ATVREF00                * Validate and Activate referral
            BRANCH    EXIT,SUPREF94
          ENDIF
.
          PACK      KEY32,ADMISSNO,SP70
          CALL      RSALENC6
SUPREF03  CALL      RKALENC6
          BRANCH    OVRCD,SUPREF05
.
          MATCH     ADMISSNO,ALENVISN
          GOTO      SUPREF05 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA            * Cancelled?
          GOTO      SUPREF09 IF EQUAL       * Ignore validations
.
          MATCH     Z70,ALREF019
          IF        !@EQUAL
            MATCH     ALREF019,ALENSDAT
            GOTO      SUPREF96 IF LESS
          ENDIF
.
SUPREF05  MATCH     Z70,ALREF028
          IF        !@EQUAL
            MATCH     ALREF028,ALREF029
            GOTO      SUPREF95 IF EQUAL
          ENDIF
.
          MATCH     Z70,ALREF028
          IF        !@EQUAL
            MATCH     ALREF028,ALREF030
            GOTO      SUPREF95 IF EQUAL
          ENDIF
.
          MATCH     Z70,ALREF030
          IF        !@EQUAL
            MATCH     SP70,ALREF030
            IF        !@EQUAL
              MATCH     ALREF030,ALREF029
              GOTO      SUPREF95 IF EQUAL
            ENDIF
          ENDIF
.
SUPREF09  PACK      KEY8,ADMISSNO,SP70
.
SUPREF10  CALL      RLALREF1                * read lock
          BRANCH    OVRCD,SUPREF93,SUPREF90
.
          CALL      RECU0000                * Vic and NZ - Received date edit
          BRANCH    EXIT,SUPREF99
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MOVE      ALREMOHR,ALREF144       * Set to MOH Indicator
          MATCH     ALREF083,Z70
          GOTO      SUPREF30 IF EQUAL       * Not a primary referral
.
          MATCH     ALREF083,ALREUYN4
          GOTO      SUPREF40 IF EQUAL       * Primary not changed
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SUPREF40
.
          MATCH     "M",TCINDC4
          GOTO      SUPREF40 IF NOT EQUAL    * Not a Mental Health department
.
          MATCH     "1",ALREF083             * Check for Primary field
          GOTO      SUPREF30 IF NOT EQUAL
.
          MOVE      "0",ALREF144             * Set to unsent
          GOTO      SUPREF40
.
SUPREF30  MOVE      SP70,ALREF144            * Not Primary/No MHINC
.
.         * populate the CGI parameters from the screen
SUPREF40  CALL      MVALRE00
.
          CALL      SACL0000                * Checks for SAC referral links
          BRANCH    EXIT,SUPREF99
.
          MOVE      DEPTCODE,ALREDEPT       * Deptcode
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD  * Populate date record updated
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          IF        ACTIVREF = 1
            PACK      ALREUDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALREUDAT
            CLOCK     TIME,ALREUTIM
            MOVE      USERID,ALREUUID
.
            MATCH     Z70,ALREF004
            IF        @EQUAL
              PACK      ALREDACT,CCC,CYY,CMM,CDD
              REP       " 0",ALREDACT
            ENDIF
.
            MATCH     "2",ALREF003          * Closed?
            IF        @EQUAL
              MOVE      ONE,RACTVFLG        * Re-activate referral
            ENDIF
            MOVE      ONE,ALRESTAT          * Activate referral
            MOVE      ALREDACT,ALSTSDAT     * write to Referral History Table
            CALL      WRTRSH00              * write a record to allstsaf
          ENDIF
.
          CALL      UPALREF1                * Update the record
          CALL      UUALREF1
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1            * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          IF        ACTIVREF = 1
            MOVE      "T ",UPDTTYPE         * Activated
          ELSE
            MOVE      "U ",UPDTTYPE         * Updated
          ENDIF
          CALL      WRTRAU00
.
          PACK      KEY8,ADMISSNO
          CALL      RDPTVIS1
          BRANCH    OVRCD,SUPREF93
.
          MATCH     ALRERDAT,PVIDATE
          GOTO      SUPREF89 IF EQUAL
.
          MOVE      ALRERDAT,PVIDATE
          CALL      UPPTVIS1
.
SUPREF89  CALL      BOCF0000                * Update refarral date in outbocaf
.
          CALL      OUTFIL00                * Check Correct Site Files Are Open
          BRANCH    EXIT,SUPREF99
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          MOVE      ZERO,EXIT
          GOTO      SUPREF99
.
SUPREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      SUPREF10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF92  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF93  MOVE      "Invalid Referral / Visit",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF94  MATCH     "1",ALREF083
          IF        @EQUAL
            SQUEEZE   ALCNMDES
            CLEAR     WEBTITLE
            APPEND    "Patient has an Active/Inactive ",WEBTITLE
            APPEND    ALCNMDES,WEBTITLE
            APPEND    " Referral.",WEBTITLE
            RESET     WEBTITLE
            RESET     ALCNMDES
          ELSE
            MOVE      "Patient has an Active/Inactive Referral.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF95  MOVE      "Duplicate problem codes can not be used.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF96  MOVE      "Referral date can't be greater than 1st EOC Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF97  MOVE      "Date Closed must be >= the HONOS Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPREF99
.
SUPREF99  RETURN
+
.******************************************************************************
. SACE0000  - Edit check to make sure you only have one waiting, active
.             or inactive SACS referral at a given time (Supervisor Update)
.******************************************************************************
SACE0000  BRANCH    PTCNHDPS,SACE9000       * No Status edit for NZ
.
          BRANCH    OVERRIDE,SACE9000,SACE9000
.
          MATCH     "1",ALREF083            * SACS Referral
          GOTO      SACE9000 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * read referral to get status
          BRANCH    OVRCD,SACE9000,SACE9000
.
          MATCH     "0",ALRESTAT            * Waiting
          GOTO      SACE0500 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      SACE0500 IF EQUAL
.
          MATCH     "3",ALRESTAT            * Inactive
          GOTO      SACE0500 IF EQUAL
.
          GOTO      SACE9000
.
SACE0500  PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
SACE1000  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,SACE9000
.
          MATCH     URNUMBER,ALREURNO
          GOTO      SACE9000 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALREVISN       * Match to department
          GOTO      SACE1000 IF EQUAL
.
          MATCH     "1",ALREUYN4            * SACS referral
          GOTO      SACE1000 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Department Code
          GOTO      SACE1000 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * You can only have one waiting
          GOTO      SACE8000 IF EQUAL       * SACS referral
.
          MATCH     "1",ALRESTAT            * You can only have one active
          GOTO      SACE8000 IF EQUAL       * SACS referral
.
          MATCH     "3",ALRESTAT            * You can only have one Inactive
          GOTO      SACE8000 IF EQUAL       * SACS referral
.
          GOTO      SACE1000
.
SACE8000  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Patient has an Waiting/Active/Inactive ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referral.",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
.
          MOVE      ONE,EXIT
          GOTO      SACE9999
.
SACE9000  MOVE      ZERO,EXIT
          GOTO      SACE9999
.
SACE9999  RETURN
.
.******************************************************************************
. SACV0000  - Edit check to make sure you only have one waiting, active
.             or inactive SACS referral at a given time
.******************************************************************************
SACV0000  BRANCH    PTCNHDPS,SACV9000       * No Status edit for NZ
.
          BRANCH    OVERRIDE,SACV9000,SACV9000
.
          MATCH     "1",ALREF083            * SACS Referral
          GOTO      SACV9000 IF NOT EQUAL
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
SACV1000  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,SACV9000
.
          MATCH     URNUMBER,ALREURNO
          GOTO      SACV9000 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALREVISN       * Match to department
          GOTO      SACV1000 IF EQUAL
.
          MATCH     "1",ALREUYN4            * SACS referral
          GOTO      SACV1000 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Department Code
          GOTO      SACV1000 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * You can only have one waiting
          GOTO      SACV8000 IF EQUAL       * SACS referral
.
          MATCH     "1",ALRESTAT            * You can only have one active
          GOTO      SACV8000 IF EQUAL       * SACS referral
.
          MATCH     "3",ALRESTAT            * You can only have one Inactive
          GOTO      SACV8000 IF EQUAL       * SACS referral
.
          GOTO      SACV1000
.
SACV8000  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Patient has an Waiting/Active/Inactive ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referral.",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
.
          MOVE      ONE,EXIT
          GOTO      SACV9999
.
SACV9000  MOVE      ZERO,EXIT
          GOTO      SACV9999
.
SACV9999  RETURN
.
.******************************************************************************
.Check if this referral is linked in any way to a SACS referral according     *
.to the SACS referral type                                                    *
.******************************************************************************
SACL0000  MATCH     "1",ALREUYN4            * SACS Referral
          GOTO      SACL3000 IF NOT EQUAL
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,SACL9000
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          GOTO      SACL9000 IF NOT EQUAL
.
          GOTO      SACL9100
.
SACL3000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN1
          CALL      RKALRLN1
          BRANCH    OVRCD,SACL9000
.
          MATCH     ALREVISN,ALRLVISN       * Linked referrals
          GOTO      SACL9000 IF NOT EQUAL
.
          GOTO      SACL9100  
.
SACL9000  MOVE      ZERO,EXIT
          GOTO      SACL9999
.
SACL9100  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error changing ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " referral type - linked referrals exist",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      SACL9999
.        
SACL9999  RETURN
.
.
.******************************************************************************
.Check if this referral is linked in any way to a SACS referral               *
.******************************************************************************
SACD0000  MOVE      ZERO,EXIT
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,SACD3000
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          GOTO      SACD3000 IF NOT EQUAL
.
          GOTO      SACD9100
.
SACD3000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN1
          CALL      RKALRLN1
          BRANCH    OVRCD,SACD9000
.
          MATCH     ALREVISN,ALRLVISN       * Linked referrals
          GOTO      SACD9000 IF NOT EQUAL
.
          GOTO      SACD9100
.
SACD9000  MOVE      ZERO,EXIT
          GOTO      SACD9999
.
SACD9100  MOVE      ONE,EXIT
          GOTO      SACD9999
.
SACD9999  RETURN
.
.******************************************************************************
.Check if this referral has any records in allhdtaf with a status of RECDSTAT *
.******************************************************************************
RHDT0000  PACK      KEY42,URNUMBER,RECDSTAT,ADMISSNO,SP70
          CALL      RSALHDT3
RHDT1000  CALL      RKALHDT3
          BRANCH    OVRCD,RHDT9000
.         
          MATCH     URNUMBER,ALHDURNO
          GOTO      RHDT9000 IF NOT EQUAL
.
          MATCH     RECDSTAT,ALHDSTAT
          GOTO      RHDT9000 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALHDVISN
          GOTO      RHDT9000 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          GOTO      RHDT9999
.
RHDT9000  MOVE      ZERO,EXIT
          GOTO      RHDT9999
.
RHDT9999  RETURN
.
.******************************************************************************
.Check if this referral has any records in allwlnaf - WL Links                *
.******************************************************************************
CHKW0000  PACK      KEY27,ALREVISN,SP70
          CALL      RSALWLN2
CHKW1000  CALL      RKALWLN2                               * Loop linked WL
          BRANCH    OVRCD,CHKW9000
.
          MATCH     ALREVISN,ALWLVISN                      * Same referral
          GOTO      CHKW9000 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          GOTO      CHKW9999
.
CHKW9000  MOVE      ZERO,EXIT
          GOTO      CHKW9999
.
CHKW9999  RETURN
+
.******************************************************************************
.Supervisor Delete Referral                                                   *
.******************************************************************************
..
SUPDEL00  MATCH     SP70,DEPTCODE
          GOTO      SUPDEL91 IF EQUAL            * Department code is blank
.
          MATCH     SP70,URNUMBER
          GOTO      SUPDEL92 IF EQUAL            * U/R Number is blank
.
          MATCH     SP70,ADMISSNO
          GOTO      SUPDEL93 IF EQUAL            * Visit/Reff is blank
.
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          IF        OVRCD=1
            GOTO    SUPDEL99
          ENDIF
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALENC1         
SUPDEL02  CALL      RKALENC1
          BRANCH    OVRCD,SUPDEL03
. 
          MATCH     ADMISSNO,ALENVISN            * Encounters exist?
          GOTO      SUPDEL03 IF NOT EQUAL        * no more encounters, continue
.
          MATCH     "0",ALENRSTA                 * is this encounter active
          GOTO      SUPDEL94 IF EQUAL            * yes, display error 
.
          GOTO      SUPDEL02
.
SUPDEL03  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1         
          CALL      RKALLNK1
          BRANCH    OVRCD,SUPDEL05
. 
          MATCH     ADMISSNO,ALLNVISN            * outpatient links exist?
          GOTO      SUPDEL95 IF EQUAL            * yes, display error 
.
SUPDEL05  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALGPA2
          CALL      RKALGPA2
          BRANCH    OVRCD,SUPDEL07
.
          MATCH     ADMISSNO,ALGAREFN            * Group contacts exist?
          GOTO      SUPDEL98 IF EQUAL            * yes, display error
.
SUPDEL07  PACK      KEY24,URNUMBER,SP70
          CALL      RSALGRP3
SUPDEL08  CALL      RKALGRP3
          BRANCH    OVRCD,SUPDEL09
.
          MATCH     URNUMBER,ALGPURNO            * Group contacts exist?
          GOTO      SUPDEL09 IF NOT EQUAL        * yes, display error
.
          MATCH     ADMISSNO,ALGPREFN            * Group contacts exist?
          GOTO      SUPDEL98 IF EQUAL            * yes, display error
.
          GOTO      SUPDEL08
.
SUPDEL09  PACK      KEY8,ADMISSNO,SP10           * No, check allrefaf file  
SUPDEL10  CALL      RLALREF1                     * read lock
          BRANCH    OVRCD,SUPDEL93,SUPDEL80
.
          CALL      SACD0000                     * Checks for SAC referral links
          BRANCH    EXIT,SUPDEL96
.
          MOVE      " 0",RECDSTAT                * Waiting
          CALL      RHDT0000                     * Check for allhdtaf records  
          BRANCH    EXIT,SUPDEL97                * for DHS SACS reporting
.
          MOVE      " 6",RECDSTAT                * Extracted
          CALL      RHDT0000                     * Check for allhdtaf records  
          BRANCH    EXIT,SUPDEL97                * for DHS SACS reporting
.
          MOVE      " 7",RECDSTAT                * Submitted
          CALL      RHDT0000                     * Check for allhdtaf records  
          BRANCH    EXIT,SUPDEL97                * for DHS SACS reporting
.
          MOVE      "13",RECDSTAT                * Accepted
          CALL      RHDT0000                     * Check for allhdtaf records  
          BRANCH    EXIT,SUPDEL97                * for DHS SACS reporting
.
          CALL      CHKW0000                     * Check for WL links          
          BRANCH    EXIT,SUPDEL90                * allwlnaf              
.
.         Get PMI details prior to sending I14 HL7 message
.         
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF     
.         
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2              
          ENDIF     
.
          MOVE      SEVEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII14                * broadcast Delete Ref. (REF^I14)
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      DEALREF1                     * Delete the referral record
.
          MOVE      FOUR,AUDTTYPE            * delete history record
          CALL      WAALRE00
.
          PACK      KEY8,ADMISSNO
          CALL      RDPTVIS1
          BRANCH    OVRCD,SUPDEL93
.
          CALL      DEPTVIS1                     * Delete the visit record
.
          PACK      KEY8,ADMISSNO
          CALL      RDPMVX11
          BRANCH    OVRCD,SUPDEL93
.
          CALL      DEPMVX11                     * Delete visit extn record
.
          PACK      KEY17,ADMISSNO,SP70
SUPDEL20  CALL      RSALSTS1
          CALL      RKALSTS1
          BRANCH    OVRCD,SUPDEL30
.
          MATCH     ADMISSNO,ALSTVISN            * Status history exists?
          GOTO      SUPDEL30 IF NOT EQUAL        * No, check audit history rec
.
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT
          CALL      DEALSTS1                     * Yes, delete status record
          GOTO      SUPDEL20                     * read next record
.
SUPDEL30  PACK      KEY24,ADMISSNO,SP70
SUPDEL35  CALL      RSALAUD1 
          CALL      RKALAUD1 
          BRANCH    OVRCD,SUPDEL40
.
          MATCH     ADMISSNO,ALAUVISN            * Audit history exists?
          GOTO      SUPDEL40 IF NOT EQUAL        * No
.
          PACK      KEY24,ALAUVISN,ALAUADAT,ALAUATIM
          CALL      DEALAUD1                     * Yes, delete audit record
          GOTO      SUPDEL35   
.
SUPDEL40  PACK      KEY24,ADMISSNO,SP70
SUPDEL41  CALL      RSALRNW1 
          CALL      RKALRNW1
          BRANCH    OVRCD,SUPDEL50
.
          MATCH     ADMISSNO,ALRNVISN            * Renewal records exists?
          GOTO      SUPDEL50 IF NOT EQUAL        * No
.
          PACK      KEY24,ALRNVISN,ALRNRDAT,ALRNRTIM,SP70
          CALL      DEALRNW1
          GOTO      SUPDEL41
.
SUPDEL50  MOVE      ZERO,EXIT
          GOTO      SUPDEL99
.
SUPDEL80  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      SUPDEL10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL90  MOVE      "Waiting List Links unable to delete",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL92  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL93  MOVE      "Invalid Referral / Visit",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL94  MOVE      "Encounters present unable to delete",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL95  MOVE      "Outpatient links unable to delete",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL96  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          MOVE      " referral links unable to delete",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          CALL      UUALREF1
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL97  MOVE      "VINAH records present unable to delete",WEBTITLE
          CALL      WEBERR00
          CALL      UUALREF1
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL98  MOVE      "Group contacts present unable to delete",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUPDEL99
.
SUPDEL99  RETURN
+
.******************************************************************************
. ATVREF00  Activate a referral and vaidate status
.******************************************************************************
ATVREF00  PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
ATVREF10  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,ATVREF90
.
          MATCH     URNUMBER,ALREURNO
          GOTO      ATVREF90 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Match to department
          GOTO      ATVREF10 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT            * You can only have one active
          GOTO      ATVREF80 IF EQUAL       * referral per department
.
          MATCH     "3",ALRESTAT            * You can only have one Inactive
          GOTO      ATVREF80 IF EQUAL       * referral per department

          GOTO      ATVREF10
.
ATVREF80  MOVE      ONE,EXIT     
          GOTO      ATVREF99
.
ATVREF90  MOVE      ZERO,EXIT     
          GOTO      ATVREF99
.
ATVREF99  RETURN
.******************************************************************************
. Cancel a Referral
.******************************************************************************
CANREF00  MATCH     SP3,DEPTCODD            * Check If Dept is Blank
          GOTO      CANREF91 IF EQUAL
          MATCH     SP8,ADMISSNO            * Check If VisitNo is Blank
          GOTO      CANREF92 IF EQUAL
.
          PACK      KEY3,DEPTCODD,SP70      * If the Dept Does not use Referral
          CALL      RDALDEP1
          BRANCH    OVRCD,CANREF91
          MATCH     "0",ALDEREFE
          GOTO      CANREF93 IF EQUAL
.                                           * Checks Valid Referral Status
          PACK      KEY8,ADMISSNO,SP70
CANREF10  CALL      RDALREF1                * Read the referral table
          BRANCH    OVRCD,CANREF92
.
          MATCH     "4",ALRESTAT            * Checks Valid Referral Status
          GOTO      CANREF94 IF EQUAL
.
          MATCH     ALRERDAT,ALREF011       * Validates the cancel date
          GOTO      CANREF97 IF LESS        * with the referral date
.
          CALL      NDAT0000                * Check cancel/referral out date
          BRANCH    EXIT,CANREF99
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALENC1
CANREF15  CALL      RKALENC1
          BRANCH    OVRCD,CANREF20
.
          MATCH     ADMISSNO,ALENVISN       * Encounters exist?
          GOTO      CANREF20 IF NOT EQUAL
.
          MATCH     "0",ALENRSTA            * Active encounter
          GOTO      CANREF95 IF EQUAL
.
          MATCH     " ",ALENRSTA            * Active encounter
          GOTO      CANREF95 IF EQUAL
.
          GOTO      CANREF15
.
CANREF20  MATCH     "1",ALREUYN4            * Is this a SACS referral
          GOTO      CANREF30 IF NOT EQUAL
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
CANREF25  CALL      RKALRLN1
          BRANCH    OVRCD,CANREF30
.
          MATCH     ADMISSNO,ALRLVISN       * Is there linked referrals
          GOTO      CANREF30 IF NOT EQUAL   * for this admission number that
.                                           * are not cancelled or rejected
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1                * Read the referral table
          BRANCH    OVRCD,CANREF25
.
          MATCH     "4",ALRESTAT            * Cancelled
          GOTO      CANREF25 IF EQUAL
.
          MATCH     "5",ALRESTAT            * Rejected
          GOTO      CANREF25 IF EQUAL
.
          GOTO      CANREF96
.
CANREF30  PACK      KEY8,ADMISSNO,SP70
          CALL      RLALREF1                * Read the referral table
          BRANCH    OVRCD,CANREF92,CANREF90
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MOVE      ALREPRTY,SAVVPRTY       * Save referral priority
          MOVE      ALRETRGS,SAVVTRGS       * Save referral triage status
.
          CALL      MVALRE00                * get the cgi parameters
.                                           * Update allrefaf file variables
          MOVE      "4",ALRESTAT
          CALL      URMHI000                * Set MHINC indicator
.
          MOVE      SP70,ALRERCLO
          MOVE      SP70,ALREDCLO
          MOVE      SP70,ALRETCLO
          MOVE      SP70,ALREUCLO
.
          MOVE      SP70,ALRESREJ
          MOVE      SP70,ALRESRDT
          MOVE      SP70,ALRESRTM
          MOVE      SP70,ALRESRUI
.
          MOVE      SP70,ALRERINA
          MOVE      SP70,ALREDINA
          MOVE      SP70,ALRETINA
          MOVE      SP70,ALREDINU
          MOVE      SP70,ALREUINA
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          REP       " 0",ALREDCAN
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      UPALREF1                * Update referral Table (allrefaf)
          CALL      UUALREF1                * Unlock Record
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      EIGHT,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          CALL      PRAL0000                * print letters and labels
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1            * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          MOVE      ALREDCAN,ALSTSDAT
          CALL      WRTRSH00
.
          MOVE      "N ",UPDTTYPE
          CALL      WRTRAU00
.
.                                      * Save referral priority set above
          MOVE      ALREVISN,SAVVREFN  * Referral number
          PROC      VDEF0000           * VINAH Field defaults
.
          MOVE      ZERO,EXIT
          GOTO      CANREF99
.
CANREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      CANREF10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANREF99
.
CANREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANREF99
.
CANREF92  MOVE      "Invalid or No Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANREF99
.
CANREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANREF99
.
CANREF94  MOVE      "Invalid Referral Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CANREF99
.
CANREF95  IF        PTCNHDPS=1
            MOVE      "Invalid cancellation - Encounters exist",WEBTITLE
          ELSE
            MOVE      "Invalid cancellation - Episodes of care exist",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CANREF99
.
CANREF96  MOVE      "Invalid cancellation - Linked referrals exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CANREF99
.
CANREF97  MOVE      "Date Cancelled must be >= the Referral Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CLSREF99
.
CANREF99  RETURN
.
.******************************************************************************
. Reject a Referral
.******************************************************************************
REJREF00  MATCH     SP3,DEPTCODD            * Check If Dept is Blank
          GOTO      REJREF91 IF EQUAL
          MATCH     SP8,ADMISSNO            * Check If VisitNo is Blank
          GOTO      REJREF92 IF EQUAL
.
          PACK      KEY3,DEPTCODD,SP70      * If the Dept Does not use Referral
          CALL      RDALDEP1
          BRANCH    OVRCD,REJREF91
          MATCH     "0",ALDEREFE
          GOTO      REJREF93 IF EQUAL
.                                           * Checks Valid Referral Status
          PACK      KEY8,ADMISSNO,SP70
REJREF10  CALL      RDALREF1                * Read the referral table
          BRANCH    OVRCD,REJREF92
.
          MATCH     "5",ALRESTAT            * Checks Valid Referral Status
          GOTO      REJREF94 IF EQUAL
.
          MATCH     ALRERDAT,ALREF129       * Validates the rejected date
          GOTO      REJREF97 IF LESS        * with the referral date
.
          CALL      JDAT0000                * Check cancel/referral out date
          BRANCH    EXIT,CANREF99
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALENC1
REJREF15  CALL      RKALENC1
          BRANCH    OVRCD,REJREF20
.
          MATCH     ADMISSNO,ALENVISN       * Encounters exist?
          GOTO      REJREF20 IF NOT EQUAL
.
          MATCH     "0",ALENRSTA            * Active encounter
          GOTO      REJREF95 IF EQUAL
.
          GOTO      REJREF15
.
REJREF20  MATCH     "1",ALREUYN4            * Is this a SACS referral
          GOTO      REJREF30 IF NOT EQUAL
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
REJREF25  CALL      RKALRLN1
          BRANCH    OVRCD,REJREF30
.
          MATCH     ADMISSNO,ALRLVISN       * Is there linked referrals
          GOTO      REJREF30 IF NOT EQUAL   * for this admission number that
.                                           * are not cancelled or rejected
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1                * Read the referral table
          BRANCH    OVRCD,REJREF25
.
          MATCH     "4",ALRESTAT            * Cancelled
          GOTO      REJREF25 IF EQUAL
.
          MATCH     "5",ALRESTAT            * Rejected
          GOTO      REJREF25 IF EQUAL
.
          GOTO      REJREF96
.
REJREF30  COMPARE   ONE,PTCNHDPS
          GOTO      REJREF60 IF NOT EQUAL
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
REJREF35  CALL      RKALLNK1
          BRANCH    OVRCD,REJREF40
.
          MATCH     ADMISSNO,ALLNVISN    
          GOTO      REJREF40 IF NOT EQUAL
.
          PACK      KEY8,ALLNLNKV,SP70
          CALL      RDOTCAN1
          BRANCH    OVRCD,REJREF98      
.
          GOTO      REJREF35
.
REJREF40  PACK      KEY27,ADMISSNO,SP70
          CALL      RSALWLN2         
REJREF45  CALL      RKALWLN2
          BRANCH    OVRCD,REJREF50 
.
          MATCH     ADMISSNO,ALWLVISN
          GOTO      REJREF50 IF NOT EQUAL
.
          PACK      KEY19,ALWLURNO,ALWLPCOD,ALWLPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,REJREF45
.
          COMPARE   SIX,WMSTAT
          GOTO      REJREF89 IF NOT EQUAL
.
          GOTO      REJREF45
.
REJREF50  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALGPA2
          CALL      RKALGPA2
          BRANCH    OVRCD,REJREF60
.
          MATCH     ADMISSNO,ALGAREFN
          GOTO      REJREF88 IF EQUAL
.
.
.         Check Group Contact Session Patients...
.
REJREF60  PACK      KEY24,URNUMBER,SP70
          CALL      RSALGRP3
REJREF61  CALL      RKALGRP3
          BRANCH    OVRCD,REJREF70
.
          MATCH     URNUMBER,ALGPURNO       * Group session patient matching UR?
          GOTO      REJREF70 IF NOT EQUAL   * no, skip
.
          MATCH     ADMISSNO,ALGPREFN       * Same referral?
          GOTO      REJREF61 IF NOT EQUAL   * no, get next referral
.
          MATCH     "0",ALGPACTV            * Group session Active?
          GOTO      REJREF87 IF EQUAL       * yes, display error
.
          GOTO      REJREF61
.
REJREF70  PACK      KEY8,ADMISSNO,SP70
          CALL      RLALREF1                * Read the referral table
          BRANCH    OVRCD,REJREF92,REJREF90
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MOVE      ALREPRTY,SAVVPRTY       * Save referral priority
          MOVE      ALRETRGS,SAVVTRGS       * Save referral triage status
.
          CALL      MVALRE00                * get the cgi parameters
.                                           * Update allrefaf file variables
          MOVE      "5",ALRESTAT
          CALL      URMHI000                * Set MHINC indicator
.
          MOVE      SP70,ALRERCLO
          MOVE      SP70,ALREDCLO
          MOVE      SP70,ALRETCLO
          MOVE      SP70,ALREUCLO
.
          MOVE      SP70,ALRERINA
          MOVE      SP70,ALREDINA
          MOVE      SP70,ALRETINA
          MOVE      SP70,ALREDINU
          MOVE      SP70,ALREUINA
.
          MOVE      SP70,ALRERCAN           * fileds related to Cancellation
          MOVE      SP70,ALREDCAN
          MOVE      SP70,ALRETCAN
          MOVE      SP70,ALREUCAN
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          MOVE      USERID,ALRESRUI
.
          CALL      UPALREF1                * Update referral Table (allrefaf)
          CALL      UUALREF1                * Unlock Record
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      NINE,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          CALL      PRAL0000                 * print letters and labels
.
          COMPARE   THREE,PTCNHDPS           * Victoria - VINAH audits
          IF        @EQUAL
            MATCH     "1",ALREUYN4
            IF        !@EQUAL
              MOVE      THREE,AUDTTYPE       * Write after history record for a 
              CALL      WAALRE00             * Victoria episode referral 
            ENDIF
          ELSE 
            MOVE      THREE,AUDTTYPE         * after history record
            CALL      WAALRE00
          ENDIF
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1              * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          MOVE      ALRESRDT,ALSTSDAT
          CALL      WRTRSH00
.
          MOVE      "J ",UPDTTYPE
          CALL      WRTRAU00
.
          COMPARE   THREE,PTCNHDPS           * Victoria - VINAH audits
          IF        @EQUAL
            MATCH     "1",ALREUYN4
            IF        @EQUAL
              MOVE      TWO,RIAUDFLG         * Don't write referral in audits
            ENDIF
.
            MOVE      ALREVISN,SAVVREFN      * Referral number
            PROC      VDEF0000               * VINAH Field defaults
.
            PACK      KEY8,ADMISSNO,SP70
            CALL      RLALREF1               * Read the referral table
            BRANCH    OVRCD,REJREF80
.
            MATCH     "1",ALREUYN4
            IF        @EQUAL
              MOVE      THREE,AUDTTYPE       * Write after history record
              CALL      WAALRE00             * audit for referral in
            ENDIF
          ENDIF
.
REJREF80  MOVE      ZERO,EXIT
          GOTO      REJREF99
.
REJREF87  MOVE      "Invalid Rejection - Group booking exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REJREF99
.
REJREF88  MOVE      "Invalid Rejection - Group bookings exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REJREF99
.
REJREF89  MOVE      "Invalid Rejection - linked WL procedures exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REJREF99
.
REJREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      REJREF10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REJREF99
.
REJREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REJREF99
.
REJREF92  MOVE      "Invalid or No Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REJREF99
.
REJREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REJREF99
.
REJREF94  MOVE      "Invalid Referral Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REJREF99
.
REJREF95  IF        PTCNHDPS=1
            MOVE      "Invalid rejection - Encounters exist",WEBTITLE
          ELSE
            MOVE      "Invalid rejection - Episodes of care exist",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REJREF99
.
REJREF96  MOVE      "Invalid rejection - Linked referrals exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REJREF99
.
REJREF97  MOVE      "Date Rejected must be >= the Referral Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CLSREF99
.
REJREF98  MOVE      "Invalid Rejection - linked outpatient appts exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REJREF99
.
REJREF99  RETURN
.
.******************************************************************************
. Activate Referral
.******************************************************************************
ACTREF00  MATCH     SP3,DEPTCODD            * Check If Dept is Blank
          GOTO      ACTREF91 IF EQUAL
          MATCH     SP8,ADMISSNO            * Check If VisitNo is Blank
          GOTO      ACTREF92 IF EQUAL
.
          PACK      KEY3,DEPTCODD,SP70      * If the Dept Does not use Referral
          CALL      RDALDEP1
          BRANCH    OVRCD,ACTREF91
          MATCH     "0",ALDEREFE            * Dept uses referrals
          GOTO      ACTREF93 IF EQUAL       * no report error
.
          CALL      VALMAS00                * Check ref/master is not closed
          BRANCH    EXIT,ACTREF96,ACTREF97  * Display error if yes
.
ACTREF04  CALL      SACV0000                * Checks for multiple waiting
          BRANCH    EXIT,ACTREF99           * inactive or open SACS referrals
.
.  Check for Active/Inactive Referral in This Department
.
          MOVE      ZERO,RACTVFLG
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
ACTREF05  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,ACTREF10
.
          MATCH     URNUMBER,ALREURNO
          GOTO      ACTREF10 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Match to department
          GOTO      ACTREF05 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALREVISN       * Skip if this is the referral
          GOTO      ACTREF05 IF EQUAL       * you are updating
.
          MATCH     "1",ALRESTAT
          GOTO      ACTREF08 IF EQUAL
.
          MATCH     "3",ALRESTAT
          GOTO      ACTREF08 IF EQUAL
.
          GOTO      ACTREF05
.
ACTREF08  BRANCH    OVERRIDE,ACTREF10,ACTREF10
          GOTO      ACTREF95
.                                           * Checks Valid Referral Status
ACTREF10  MOVE      ZERO,LOCKCNT            * Count for Locking Wait
          PACK      KEY8,ADMISSNO,SP70
ACTREF20  CALL      RLALREF1                * Read the referral table & lock
          BRANCH    OVRCD,ACTREF92,ACTREF90 * Invalid , Locked
.
          MOVE      "234",D3
          SCAN      ALRESTAT,D3             * Checks Valid Referral Status
          GOTO      ACTREF94 IF NOT EQUAL
.
          MATCH     "2",ALRESTAT            * Current status is 'Closed' ?
          IF        @EQUAL
            MOVE      ONE,RACTVFLG          * Re-activate flag
          ENDIF
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          CALL      MVALRE00                * get the cgi parameters
.
.                                           * Update allrefaf file variables
          MOVE      "1",ALRESTAT
.
          MATCH     SP70,ALREDACT
          IF        @EQUAL
            PACK      ALREDACT,CCC,CYY,CMM,CDD   * Set date active to today
            REP       " 0",ALREDACT              * if blank
          ENDIF
.
          CALL      URMHI000                * Set MHINC indicator
.
          MOVE      SP70,ALRERCLO           * fileds related to closure
          MOVE      SP70,ALREDCLO
          MOVE      SP70,ALRETCLO
          MOVE      SP70,ALREUCLO
.
          MOVE      SP70,ALRERINA           * fileds related to Inactivation
          MOVE      SP70,ALREDINA
          MOVE      SP70,ALRETINA
          MOVE      SP70,ALREDINU
          MOVE      SP70,ALREUINA
.
          MOVE      SP70,ALRESREJ
          MOVE      SP70,ALRESRDT
          MOVE      SP70,ALRESRTM
          MOVE      SP70,ALRESRUI
.
          MOVE      SP70,ALRERCAN           * fields related to Cancellation
          MOVE      SP70,ALREDCAN
          MOVE      SP70,ALRETCAN
          MOVE      SP70,ALREUCAN
.
          MOVE      SP70,ALREDREV           * Date of Next Review
          MOVE      SP70,ALREUC33           * Category lG
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      UPALREF1                * Update referral Table (allrefaf)
          CALL      UUALREF1                * Unlock Record
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      TEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1              * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          MOVE      ALREDACT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "T ",UPDTTYPE           * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          MOVE      ZERO,EXIT
          GOTO      ACTREF99
.
ACTREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      ACTREF20
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTREF99
.
ACTREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTREF99
.
ACTREF92  MOVE      "Invalid or No Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTREF99
.
ACTREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTREF99
.
ACTREF94  MOVE      "Invalid Referral Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      ACTREF99
.
ACTREF95  MOVE      "Patient has an Active or Inactive Referral.",WEBTITLE
          CALL      WEBOVR00
          MOVE      ONE,EXIT
          GOTO      ACTREF99
.
ACTREF96  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referral closed. Re-activate it before ",WEBTITLE
          APPEND    "re-activating the linked referral",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTREF99
.
ACTREF97  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referral cancelled. Re-activate it before ",WEBTITLE
          APPEND    "re-activating linked referral",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTREF99
.
ACTREF99  RETURN
.
.******************************************************************************
. Check if Primary Referral is closed when activating a closed linked referral
.******************************************************************************
VALMAS00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Read the linked referral
          BRANCH    OVRCD,VALMAS96          * No Record - current procesing
.
          MATCH     "2",ALRESTAT            * Referral is closed
          IF        !@EQUAL 
            MATCH     "4",ALRESTAT          * Referral cancelled
            GOTO      VALMAS96 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",ALREUYN4            * Check if Master record
          GOTO      VALMAS96 IF EQUAL
.
          PACK      KEY16,ADMISSNO,SP70     * Get master referral
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,VALMAS96          * No Record - current processing
.
          MATCH     ADMISSNO,ALRLLNKV       * Linked referrals
          GOTO      VALMAS96 IF NOT EQUAL
.
          PACK      KEY8,ALRLVISN,SP70
          CALL      RDALREF1                * Read the master referral table
          BRANCH    OVRCD,VALMAS96          * No Record - current procesing
.
          MATCH     "1",ALREUYN4            * Check if Master record
          GOTO      VALMAS96 IF NOT EQUAL
.
          MATCH     "2",ALRESTAT            * Master referral is closed
          GOTO      VALMAS97 IF EQUAL       * Error
.
          MATCH     "4",ALRESTAT            * Master referral cancelled
          GOTO      VALMAS98 IF EQUAL       * Error
.
VALMAS96  MOVE      ZERO,EXIT
          GOTO      VALMAS99
.
VALMAS97  MOVE      ONE,EXIT
          GOTO      VALMAS99
.
VALMAS98  MOVE      TWO,EXIT
          GOTO      VALMAS99
.
VALMAS99  RETURN
.
.******************************************************************************
. Reinstate Referral
.******************************************************************************
REIREF00  MATCH     SP3,DEPTCODD            * Check If Dept is Blank
          GOTO      REIREF91 IF EQUAL
          MATCH     SP8,ADMISSNO            * Check If VisitNo is Blank
          GOTO      REIREF92 IF EQUAL
.
          PACK      KEY3,DEPTCODD,SP70      * If the Dept Does not use Referral
          CALL      RDALDEP1
          BRANCH    OVRCD,REIREF91
          MATCH     "0",ALDEREFE            * Dept uses referrals
          GOTO      REIREF93 IF EQUAL       * no report error
.
          CALL      REIS0000                * Reinstate referral status edit
          BRANCH    EXIT,REIREF99           * check on internal referral
.
          CALL      SACV0000                * Checks for multiple waiting
          BRANCH    EXIT,REIREF99           * inactive or open SACS referrals
.
REIREF10  MOVE      ZERO,LOCKCNT            * Count for Locking Wait
          PACK      KEY8,ADMISSNO,SP70
REIREF20  CALL      RLALREF1                * Read the referral table & lock
          BRANCH    OVRCD,REIREF92,REIREF90 * Invalid , Locked
.
          MATCH     "5",ALRESTAT            * Checks Valid Referral Status
          GOTO      REIREF94 IF NOT EQUAL
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          CALL      MVALRE00                * get the cgi parameters
.
.                                           * Update allrefaf file variables
          MOVE      "0",ALRESTAT
          MOVE      SP70,ALRERCLO           * fileds related to closure
          MOVE      SP70,ALREDCLO
          MOVE      SP70,ALRETCLO
          MOVE      SP70,ALREUCLO
.
          MOVE      SP70,ALRERINA           * fileds related to Inactivation
          MOVE      SP70,ALREDINA
          MOVE      SP70,ALRETINA
          MOVE      SP70,ALREDINU
          MOVE      SP70,ALREUINA
.
          MOVE      SP70,ALRESREJ
          MOVE      SP70,ALRESRDT
          MOVE      SP70,ALRESRTM
          MOVE      SP70,ALRESRUI
.
          MOVE      SP70,ALRERCAN           * fileds related to Cancellation
          MOVE      SP70,ALREDCAN
          MOVE      SP70,ALRETCAN
          MOVE      SP70,ALREUCAN
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      URMHI000                * Set MHINC indicator
          CALL      UPALREF1                * Update referral Table (allrefaf)
          CALL      UUALREF1                * Unlock Record
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      TEN1,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1              * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
          MOVE      ALREUDAT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "E ",UPDTTYPE           * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
          MOVE      ZERO,EXIT
          GOTO      REIREF99
.
REIREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      REIREF20
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REIREF99
.
REIREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REIREF99
.
REIREF92  MOVE      "Invalid or No Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REIREF99
.
REIREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REIREF99
.
REIREF94  MOVE      "Invalid Referral Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      REIREF99
.
REIREF95  MOVE      "Patient has an Active or Inactive Referral.",WEBTITLE
          CALL      WEBOVR00
          MOVE      ONE,EXIT
          GOTO      REIREF99
.
REIREF99  RETURN
.
.******************************************************************************
. Inactivate a Referral
.******************************************************************************
INAREF00  MATCH     SP3,DEPTCODE            * Check If Dept is Blank
          GOTO      INAREF91 IF EQUAL
          MATCH     SP8,ADMISSNO            * Check If VisitNo is Blank
          GOTO      INAREF92 IF EQUAL
.
          PACK      KEY3,DEPTCODE,SP70      * Check if dept using referral
          CALL      RDALDEP1
          BRANCH    OVRCD,INAREF91
          MATCH     "0",ALDEREFE
          GOTO      INAREF93 IF EQUAL
.
          CALL      SACV0000                * Checks for multiple waiting
          BRANCH    EXIT,INAREF99           * inactive or open SACS referrals
.                                           * Checks Valid Referral Status
          PACK      KEY8,ADMISSNO,SP70
INAREF10  CALL      RLALREF1                * Read the referral table
          BRANCH    OVRCD,INAREF92,INAREF90
.
          MATCH     "1",ALRESTAT
          IF        !@EQUAL
            GOTO      INAREF94
          ENDIF
.
          MOVE      ALREF015,CDYSTDTE       * Validates the Inactivate Date
          MOVE      ALREDACT,CDYSFDTE
          CALL      CALCDAYS
          IF        CDYSDAYS<0
            GOTO      INAREF97
          ENDIF
.
          MATCH     SP70,ALREF017
          IF        !@EQUAL
            MOVE      ALREF017,CDYSTDTE       * Validates the Inactivate Until
            MOVE      ALREF015,CDYSFDTE       * Date
            CALL      CALCDAYS              
            IF        CDYSDAYS<=0
              GOTO      INAREF98            
            ENDIF   
          ENDIF
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          CALL      MVALRE00                * get the cgi para (ALLREFTM)
.
          MOVE      "3",ALRESTAT            * Populate all the fields and write
          CALL      URMHI000                * Set MHINC indicator
          PACK      ALREUDAT,CCC,CYY,CMM,CDD * current date
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM           * current time
          MOVE      WBSEUID,ALREUUID        * web userid
          CALL      UPALREF1                * update the referral table
          CALL      UUALREF1                * unlock the referral table
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      TEN2,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1              * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.                                   ***** write to Referral History Table
          MOVE      ALREDINA,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "I ",UPDTTYPE           * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
          MOVE      ZERO,EXIT
          GOTO      INAREF99
.
INAREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      INAREF10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INAREF99
.
INAREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INAREF99
.
INAREF92  MOVE      "Invalid or No Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INAREF99
.
INAREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INAREF99
.
INAREF94  MOVE      "Invalid Referral Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      INAREF99
.
INAREF97  MOVE      "Date Inactive must > Date Active",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      INAREF99

INAREF98  MOVE      "Inactive Until Date must be > Date Inactive",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      INAREF99
.
INAREF99  RETURN
.******************************************************************************
. Close a Referral
.******************************************************************************
CLSREF00  MATCH     SP3,DEPTCODD            * Check If Dept is Blank
          GOTO      CLSREF91 IF EQUAL
          MATCH     SP8,ADMISSNO            * Check If VisitNo is Blank
          GOTO      CLSREF92 IF EQUAL
.
          PACK      KEY3,DEPTCODD,SP70      * If the Dept Does not use Referral
          CALL      RDALDEP1
          BRANCH    OVRCD,CLSREF91
.
          PACK      KEY16,ADMISSNO,Z70       
          CALL      RSMHHON1
CLSREF05  CALL      RPMHHON1
          BRANCH    OVRCD,CLSREF10          
.
          MATCH     ADMISSNO,MHHNVISN       
          GOTO      CLSREF10 IF NOT EQUAL
.
          MATCH     "1",MHHNACTV            * Check to see Active HoNOS 
          GOTO      CLSREF05 IF NOT EQUAL
.
          MATCH     MHHNHDAT,ALREF007       * Check Close date   
          GOTO      CLSREF98 IF LESS
.         
          GOTO      CLSREF05                * Checks Valid Referral Status
.
CLSREF10  PACK      KEY8,ADMISSNO,SP70
          CALL      RLALREF1                * Read the referral table
          BRANCH    OVRCD,CLSREF92,CLSREF90
.
          MOVE      "013",D3
          SCAN      ALRESTAT,D3             * Checks Valid Referral Status
          GOTO      CLSREF94 IF NOT EQUAL
.
CLSREF20  MATCH     ALRERDAT,ALREF007       * Validates the Closing Date
          GOTO      CLSREF97 IF LESS        * with the referral date
.
          CALL      SACR0000                * Checks for SAC referral links
          BRANCH    EXIT,CLSREF99
.
          CALL      CDAT0000                * Check close/last enc date edit
          BRANCH    EXIT,CLSREF99
.
          CALL      ODAT0000                * Check close/referral out date
          BRANCH    EXIT,CLSREF99
.
          CALL      GDAT0000                * Check close/group contact date
          BRANCH    EXIT,CLSREF99
.
          PACK      KEY8,ADMISSNO,SP70      * Re read correct record after
          CALL      RLALREF1                * check for linked referrals
          BRANCH    OVRCD,CLSREF92,CLSREF90
.
          CALL      SACER000                * Validate episode referral
          BRANCH    EXIT,CLSREF99
.
.                                           * exclude if WA 
          COMPARE   SIX,PTCNHDPS
          IF        !@EQUAL
            MOVE      ALREF007,CDYSTDTE       * Validates the Closing Date
            MOVE      ALREDACT,CDYSFDTE
            CALL      CALCDAYS
            IF        CDYSDAYS<0
              GOTO      CLSREF96
            ENDIF
          ENDIF
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
.--------*T0865480-start
.-------- CALL      MVALRE00                * get the cgi parameters
          IF        AUTOCLOS = 1
            CALL      MVPRI000       * Selective CGI pars to update primary ref
          ELSE
            CALL      MVALRE00       * CGI parameters for referral
          ENDIF
.--------*T0865480-end
.
          MOVE      "2",ALRESTAT            * Populate all the fields and write
          CALL      URMHI000                * Set MHINC indicator
          MOVE      SP3,ALRERINA            * in database
          MOVE      SP8,ALREDINA
          MOVE      SP8,ALRETINA
          MOVE      SP8,ALREDINU
          MOVE      SP10,ALREUINA
.
          MOVE      SP70,ALRESREJ
          MOVE      SP70,ALRESRDT
          MOVE      SP70,ALRESRTM
          MOVE      SP70,ALRESRUI
.
          CALL      IBACLOCK
          PACK      ALREUDAT,CCC,CYY,CMM,CDD * current date
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM           * current time
          MOVE      WBSEUID,ALREUUID        * user id
          CALL      UPALREF1                * update the referral table
          CALL      UUALREF1                * unlock` the referral table
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          CALL      COPD0000                * Write OPD Close action
.
          MOVE      TEN3,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          IF        AEFFLAG=1
            MOVE      ALREVISN,ALAEVISN
            PACK      KEY8,ALAEVISN
            CALL      RDALAEF1
            IF        OVRCD<>1
              CALL      MVALAE00
              CALL      UPALAEF1              * update aef file
            ELSE
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLAEF
          ENDIF
.
.                                   ***** write to Referral History Table
          MOVE      ALREDCLO,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "C ",UPDTTYPE           * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
          CALL      ACTW0000                * Auto Activate waiting referral
.
          MOVE      ZERO,EXIT
          GOTO      CLSREF99
.
CLSREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      CLSREF10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLSREF99
.
CLSREF91  MOVE      "Department does not exist/blank or not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLSREF99
.
CLSREF92  MOVE      "Invalid or No Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLSREF99
.
CLSREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLSREF99
.
CLSREF94  MOVE      "Invalid Referral Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CLSREF99
.
CLSREF96  MOVE      "Date Closed must be > Date Active",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CLSREF99
.
CLSREF97  MOVE      "Date Closed must be >= the Referral Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          CALL      UUALREF1                * Unlock Record
          GOTO      CLSREF99
.
CLSREF98  MOVE      "Date Closed must be >= the HONOS Date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLSREF99
.
CLSREF99  CLOSE     COMFILOF,DELETE
          RETURN
.
.******************************************************************************
.Check for any Waiting/Active SACS Linked Referrals                           *
.                                                                             *
.******************************************************************************
SACR0000  MATCH     "1",ALREUYN4            * SACS Referral
          GOTO      SACR9050 IF NOT EQUAL
.
          MOVE      ZERO,CONTFLAG           * Linked contact exists flag
.
SACR2000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
SACR3000  CALL      RKALRLN1
          BRANCH    OVRCD,SACR9000
.
          MATCH     ADMISSNO,ALRLVISN       * Linked referrals
          GOTO      SACR9000 IF NOT EQUAL
.
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,SACR3000
.
          MATCH     "0",ALRESTAT            * Error if waiting
          GOTO      SACR9100 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Error if active
          GOTO      SACR9100 IF EQUAL
.
          MATCH     "2",ALRESTAT            * Closed so check internal ref
          GOTO      SACR3000 IF NOT EQUAL   * closed date is not after the
.                                           * sacs ref close dates
          MATCH     Z70,ALREF007
          GOTO      SACR5000 IF EQUAL
.
          MATCH     SP70,ALREF007
          GOTO      SACR5000 IF EQUAL
.
          MATCH     ALREDCLO,ALREF007
          GOTO      SACR9200 IF LESS
.
SACR5000  BRANCH    CONTFLAG,SACR6000       * A linked contact exist
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1
SACR5100  CALL      RKALENC1
          BRANCH    OVRCD,SACR6000
.
          MATCH     ALREVISN,ALENVISN
          GOTO      SACR6000 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA            * Cancelled encounter
          GOTO      SACR5100 IF EQUAL
.
          MOVE      ONE,CONTFLAG            * Linked contact exists

SACR6000  MATCH     Z70,ALREF136            * Case end date
          GOTO      SACR3000 IF EQUAL
.
          MATCH     SP70,ALREF136
          GOTO      SACR3000 IF EQUAL
.
          MATCH     ALREDCLO,ALREF136
          GOTO      SACR9200 IF LESS
.
          GOTO      SACR3000
.
SACR9000  PACK      KEY5,ANSC,ANSG,DEPTCODD,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SACR9050          * A closed VINAH master referral
.                                           * must have a linked contact
          MATCH     ANSE,TCINDC8            * HEN
          GOTO      SACR9050 IF EQUAL
.
          MATCH     ANSL,TCINDC8            * TPN
          GOTO      SACR9050 IF EQUAL
.
          MATCH     ANSD,TCINDC8            * HBD
          GOTO      SACR9050 IF EQUAL
.
          MATCH     ANSM,TCINDC8            * Medi-Hotel
          GOTO      SACR9050 IF EQUAL
.
          MATCH     SP70,TCINDC8
          IF        !@EQUAL
            COMPARE   ZERO,CONTFLAG
            GOTO      SACR9300 IF EQUAL
          ENDIF
.
SACR9050  MOVE      ZERO,EXIT
          GOTO      SACR9999
.
SACR9100  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error closing ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    "referral - Waiting/Active Linked referrals exist",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      SACR9999
.
SACR9200  MOVE      SP70,DISPDAT1                * Referral close date
          UNPACK    ALREDCLO,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Close/Case End date must be after internal",WEBTITLE
          APPEND    " referral Close date. ",WEBTITLE
          APPEND    DISPDAT1,WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      SACR9999
.
SACR9300  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error closing ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " referral - Please Reject/Cancel as no linked ",WEBTITLE
          APPEND    "contacts exist",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      SACR9999
.
SACR9999  RETURN
.
.******************************************************************************
.*T0865480 - CPRI0000
. Check if there are other linked referrals for the Primary this linked
. referral is linked to.  If there are no other waiting, active or inactive 
. linked referrals, then will allow to also close the Primary Referral at the 
. same time as the Linked Referral is closed with the same information for 
. Referral Reason for Closure, Referral to, Closure date/time and Next Review 
. Date.
.******************************************************************************
CPRI0000  MOVE      ZERO,MULTILRF
          MOVE      SP70,SAVPRIRF
.  
.-------- Get Primary referral from the closed Linked referral
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,CPRI9100
.
          MATCH     ADMISSNO,ALRLLNKV       * Same Linked referral?
          GOTO      CPRI9100 IF NOT EQUAL   * No, exit
.
          MOVE      ALRLVISN,SAVPRIRF       * Save Primary referral
.
.-------- Using the Primary referral, check if there are any linked referrals
.-------- still waiting/active/inactive
          PACK      KEY16,SAVPRIRF,SP70
          CALL      RSALRLN1
CPRI1000  CALL      RKALRLN1
          BRANCH    OVRCD,CPRI9800
.
          MATCH     SAVPRIRF,ALRLVISN       * Same primary referral?
          GOTO      CPRI9800 IF NOT EQUAL   * No, exit
.
          PACK      KEY8,ALRLLNKV,SP70      * Get status for linked referral
          CALL      RDALREF1
          BRANCH    OVRCD,CPRI1000
.          
          MATCH     "0",ALRESTAT            * Error if waiting
          GOTO      CPRI9100 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Error if active
          GOTO      CPRI9100 IF EQUAL
.
          MATCH     "3",ALRESTAT            * Error if inactive
          GOTO      CPRI9100 IF EQUAL
.
          GOTO      CPRI1000                                              
.
CPRI9100  MOVE      ONE,MULTILRF
          GOTO      CPRI9800
.
CPRI9800  PACK      KEY8,ADMISSNO,SP70      * Restore original referral
          CALL      RDALREF1
          IF        OVRCD=1
           CALL      CLALLREF
          ENDIF
          GOTO      CPRI9999
.
CPRI9999  RETURN
.
.******************************************************************************
.*T0865480 - MVPRI000
. Move selective CGI parameters to close the Primary referral from a linked   
. referral for template allweb0202004.html
. NOTE: this routine is created to avoid yes/no fields being set for the 
. linked referral are incorrectly updated for the Primary referral when 
. closing the Primary referral from the linked referral
.******************************************************************************
MVPRI000  MATCH     ALREF007,Z70
          IF        !@EQUAL
            MOVE      ALREF007,ALREDCLO          * Close Date
          ENDIF
.
          MATCH     ALREF008,Z70
          IF        !@EQUAL
            MOVE      ALREF008,ALRETCLO          * Close Time
          ENDIF
.     
          MATCH     ALREF006,Z70
          IF        !@EQUAL
            MOVE      ALREF006,ALRERCLO          * Close Reason
          ENDIF
.
          MATCH     ALREF072,Z70
          IF        !@EQUAL
            MOVE      ALREF072,ALREUC33          * Referral To
          ENDIF
.
          MATCH     ALREF037,Z70
          IF        !@EQUAL
            MOVE      ALREF037,ALREDREV          * Date of Next Review
          ENDIF
.
          MATCH     ALREF136,Z70
          IF        !@EQUAL
            MOVE      ALREF136,ALREUDT6          * Case End Date
          ENDIF
.
          MATCH     ALREF137,Z70
          IF        !@EQUAL
            MOVE      ALREF137,ALREUTM6          * Case End Time
          ENDIF
.
MVPRI999  RETURN
.
.******************************************************************************
. Auto activate a single waiting referral                                     *
.******************************************************************************
ACTW0000  MATCH     "1",ALCNACTW
          GOTO      ACTW9999 IF NOT EQUAL
.
          MATCH     SP70,DEPTCODD           * Check If Dept is Blank
          GOTO      ACTW9999 IF EQUAL
.
          MATCH     SP70,ADMISSNO           * Check If VisitNo is Blank
          GOTO      ACTW9999 IF EQUAL
.
          PACK      KEY3,DEPTCODD,SP70      * If the Dept Does not use Referral
          CALL      RDALDEP1
          BRANCH    OVRCD,ACTW9999
.
          MATCH     "0",ALDEREFE            * Dept uses referrals
          GOTO      ACTW9999 IF EQUAL       * no report error
.
.  Check for Active/Inactive Referral in This Department and
.  check for a single waiting referral. 
.
          MOVE      SP70,SAVEVISN
          MOVE      ZERO,RACTVFLG
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
ACTW0500  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,ACTW1000
.
          MATCH     URNUMBER,ALREURNO
          GOTO      ACTW1000 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Match to department
          GOTO      ACTW0500 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * Waiting
          IF        @EQUAL
            MATCH     SP70,SAVEVISN
            IF        @EQUAL
              MOVE      ALREVISN,SAVEVISN   * Referral to activate
            ELSE
              MOVE      SP70,SAVEVISN
              GOTO      ACTW9999            * Exit if multiple waiting referrals
            ENDIF
          ENDIF
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      ACTW0800 IF EQUAL
.
          MATCH     "3",ALRESTAT            * Inactive
          GOTO      ACTW0800 IF EQUAL
.
          GOTO      ACTW0500
.
ACTW0800  BRANCH    OVERRIDE,ACTW0500,ACTW0500
          GOTO      ACTW9999
.                                                                           
ACTW1000  MATCH     SP70,SAVEVISN           * Is there a referral to activate
          GOTO      ACTW9999 IF EQUAL
.
          PACK      KEY8,SAVEVISN,SP70
ACTW2000  CALL      RDALREF1                * Read the referral table
          BRANCH    OVRCD,ACTW9999
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MATCH     "2",ALRESTAT            * Current status is 'Closed' ?
          IF        @EQUAL
            MOVE      ONE,RACTVFLG          * Re-activate flag
          ENDIF
.
          MOVE      "1",ALRESTAT
          MATCH     Z70,ALREF007            * Referral closed date
          IF        !@EQUAL
            MOVE      ALREF007,ALREDACT
          ELSE
            PACK      ALREDACT,CCC,CYY,CMM,CDD * Date activated
            REP       " 0",ALREDACT
          ENDIF
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      URMHI000                * Set MHINC indicator
          CALL      UPALREF1                * Update referral Table (allrefaf)
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MOVE      TEN4,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      ALREDACT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "T ",UPDTTYPE           * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Re read original referral
          BRANCH    OVRCD,ACTW9999
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          MOVE      ZERO,EXIT
.
ACTW9999  RETURN
.
.******************************************************************************
.Check the close dates are after the last enc date                            *
.******************************************************************************
CDAT0000  PACK      KEY32,ADMISSNO,Z70
          CALL      RSALENC6
CDAT1000  CALL      RPALENC6
          BRANCH    OVRCD,CDAT9000
.
          MATCH     ADMISSNO,ALENVISN       * Correct referral
          GOTO      CDAT9000 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA            * has Encounter been cancelled ?
          GOTO      CDAT1000 IF EQUAL       * bypass Encounter if cancelled
.
          MATCH     Z70,ALREF007            * Close date
          GOTO      CDAT5000 IF EQUAL
.
          MATCH     SP70,ALREF007
          GOTO      CDAT5000 IF EQUAL
.
          MATCH     ALENSDAT,ALREF007
          GOTO      CDAT9100 IF LESS
.
CDAT5000  MATCH     Z70,ALREF136            * Case end date
          GOTO      CDAT9000 IF EQUAL
.
          MATCH     SP70,ALREF136 
          GOTO      CDAT9000 IF EQUAL
.
          MATCH     ALENSDAT,ALREF136
          GOTO      CDAT9100 IF LESS
.
CDAT9000  MOVE      ZERO,EXIT
          GOTO      CDAT9999
.
CDAT9100  MOVE      SP70,DISPDAT1                * Visit Date
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
. 
          CLEAR     WEBTITLE
          APPEND    "Close date(s) must be after the last ",WEBTITLE
          APPEND    "episode date - ",WEBTITLE
          APPEND    DISPDAT1,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      CDAT9999
.
CDAT9999  RETURN
.
.******************************************************************************
.Check the close date is after the last attended/booked group contact         *
.******************************************************************************
GDAT0000  MATCH     Z70,ALREF007            * Close date
          GOTO      GDAT9000 IF EQUAL
.
          MATCH     SP70,ALREF007
          GOTO      GDAT9000 IF EQUAL
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALGPA2
GDAT1000  CALL      RKALGPA2
          BRANCH    OVRCD,GDAT9000
.
          MATCH     ADMISSNO,ALGAREFN       * Correct referral
          GOTO      GDAT9000 IF NOT EQUAL
.
          MATCH     "1",ALGARCST            * Deleted
          GOTO      GDAT1000 IF EQUAL
.
          PACK      KEY8,ALGACONT,SP70
          CALL      RDALGRE1
          BRANCH    OVRCD,GDAT1000
.
          MATCH     ALGEGDTE,ALREF007      * Close date < group contact date
          GOTO      GDAT9100 IF LESS
.
          GOTO      GDAT1000
.
GDAT9000  MOVE      ZERO,EXIT
          GOTO      GDAT9999
.
GDAT9100  PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1                      * Read status
          IF        OVRCD=1
            MOVE      SP70,TCINDC3               * Clear ind 3
          ENDIF
.
          MATCH     "A",TCINDC3                  * Attended
          IF        @EQUAL
            CLEAR     WEBTITLE
            APPEND    "Attended group contacts exist for this ",WEBTITLE
            APPEND    "referral after the proposed closure ",WEBTITLE
            APPEND    "date",WEBTITLE
            RESET     WEBTITLE
          ELSE
            CLEAR     WEBTITLE
            APPEND    "Linked group contacts exist for this ",WEBTITLE
            APPEND    "referral after the proposed closure ",WEBTITLE
            APPEND    "date",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      GDAT9999
.
GDAT9999  RETURN
.
.******************************************************************************
. Check the close dates is on or after the last referral out date              *
.******************************************************************************
ODAT0000  MATCH     Z70,ALREF007            * Close date
          GOTO      ODAT9000 IF EQUAL
.
          MATCH     SP70,ALREF007           * Close date blank
          GOTO      ODAT9000 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70      * Re read correct record
          CALL      RLALREF1
          BRANCH    OVRCD,ODAT9000
.
          MATCH     "1",ALREUYN4            * Is this a VINAH master Referral
          GOTO      ODAT9000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ODAT9000
.
          MATCH     SP70,TCINDC8                  * Check if VINAH
          GOTO      ODAT9000 IF EQUAL
.
          PACK      KEY13,ADMISSNO,ZERO,THREE,SP70
          CALL      RSALRHL1
ODAT1000  CALL      RKALRHL1
          BRANCH    OVRCD,ODAT9000
.
          MATCH     ADMISSNO,ALRHVISN       * Correct referral
          GOTO      ODAT9000 IF NOT EQUAL
.
          MATCH     "03",ALRHTYPE           * Referral out
          GOTO      ODAT9000 IF NOT EQUAL
.
          MATCH     ALRHDATE,ALREF007       * Close date < referral out date
          GOTO      ODAT9100 IF LESS
.
          GOTO      ODAT1000
.
ODAT9000  MOVE      ZERO,EXIT
          GOTO      ODAT9999
.
ODAT9100  MOVE      SP70,DISPDAT1                * Referral out date
          UNPACK    ALRHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     WEBTITLE
          APPEND    "Episode End Date must be >= to the referral out ",WEBTITLE
          APPEND    "date  - ",WEBTITLE
          APPEND    DISPDAT1,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      ODAT9999
.
ODAT9999  RETURN
.
.
.******************************************************************************
. Check the cancel dates is on or after the last referral out date            *
.******************************************************************************
NDAT0000  MATCH     Z70,ALREF011            * Cancel date
          GOTO      NDAT9000 IF EQUAL
.
          MATCH     SP70,ALREF011           * Cancel date blank
          GOTO      NDAT9000 IF EQUAL
.
          MATCH     "1",ALREUYN4            * Is this a VINAH master Referral
          GOTO      NDAT9000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,NDAT9000
.
          MATCH     SP70,TCINDC8                  * Check if VINAH
          GOTO      NDAT9000 IF EQUAL
.
          PACK      KEY13,ADMISSNO,ZERO,THREE,SP70
          CALL      RSALRHL1
NDAT1000  CALL      RKALRHL1
          BRANCH    OVRCD,NDAT9000
.
          MATCH     ADMISSNO,ALRHVISN       * Correct referral
          GOTO      NDAT9000 IF NOT EQUAL
.
          MATCH     "03",ALRHTYPE           * Referral out
          GOTO      NDAT9000 IF NOT EQUAL
.
          MATCH     ALRHDATE,ALREF011       * Cancel date < referral out date
          GOTO      NDAT9100 IF LESS
.
          GOTO      NDAT1000
.
NDAT9000  MOVE      ZERO,EXIT
          GOTO      NDAT9999
.
NDAT9100  MOVE      SP70,DISPDAT1                * Referral out date
          UNPACK    ALRHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     WEBTITLE
          APPEND    "Episode End Date must be >= to the referral out ",WEBTITLE
          APPEND    "date  - ",WEBTITLE
          APPEND    DISPDAT1,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      NDAT9999
.
NDAT9999  RETURN
.
.******************************************************************************
. Check the rejected dates is on or after the last referral out date          *
.******************************************************************************
JDAT0000  MATCH     Z70,ALREF129            * Rejected date
          GOTO      JDAT9000 IF EQUAL
.
          MATCH     SP70,ALREF127           * Rejected date blank
          GOTO      JDAT9000 IF EQUAL
.
          MATCH     "1",ALREUYN4            * Is this a VINAH master Referral
          GOTO      JDAT9000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,JDAT9000
.
          MATCH     SP70,TCINDC8                  * Check if VINAH
          GOTO      JDAT9000 IF EQUAL
.
          PACK      KEY13,ADMISSNO,ZERO,THREE,SP70
          CALL      RSALRHL1
JDAT1000  CALL      RKALRHL1
          BRANCH    OVRCD,JDAT9000
.
          MATCH     ADMISSNO,ALRHVISN       * Correct referral
          GOTO      JDAT9000 IF NOT EQUAL
.
          MATCH     "03",ALRHTYPE           * Referral out
          GOTO      JDAT9000 IF NOT EQUAL
.
          MATCH     ALRHDATE,ALREF129       * Rejected date < referral out date
          GOTO      JDAT9100 IF LESS
.
          GOTO      JDAT1000
.
JDAT9000  MOVE      ZERO,EXIT
          GOTO      JDAT9999
.
JDAT9100  MOVE      SP70,DISPDAT1                * Referral out date
          UNPACK    ALRHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     WEBTITLE
          APPEND    "Episode End Date must be >= to the referral out ",WEBTITLE
          APPEND    "date  - ",WEBTITLE
          APPEND    DISPDAT1,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      JDAT9999
.
JDAT9999  RETURN
.
.*******************************************************************************
.                        AH (Patient) Issues      
.*******************************************************************************
ALISSU00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ALISSU40 IF EQUAL
.         
          MATCH     "A",UPDATETY            * Add Issue
          GOTO      ALISSU10 IF EQUAL
.         
          MATCH     "U",UPDATETY            * Update Issue
          GOTO      ALISSU20 IF EQUAL
.         
          MATCH     "D",UPDATETY            * Delete Issue
          GOTO      ALISSU30 IF EQUAL
.
          GOTO      ALISS998
.         
.         
ALISSU10  MOVE      ZERO,F8                 * Add Referral Issue
          PACK      KEY16,ADMISSNO,Z70
          CALL      RSALISS1
          CALL      RPALISS1
          BRANCH    OVRCD,ALISSU11
.
          MATCH     ADMISSNO,ALISVISN
          GOTO      ALISSU11 IF NOT EQUAL
.
          MOVE      ALISISNO,F8
.
ALISSU11  CALL      CLALLISS                * clear "allissaf" record vars
          ADD       ONE,F8
          CALL      MVALIS00                * move in the cgi-parameters
          MOVE      ADMISSNO,ALISVISN
          MOVE      F8,ALISISNO
.
          PACK      ALISCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALISCDAT
          CLOCK     TIME,ALISCTIM
          MOVE      USERID,ALISCUID
.
          PACK      KEY16,ALISVISN,ALISISNO,SP70
          CALL      RAALISS1
          COMPARE   ONE,OVRCD
          GOTO      ALISSU11 IF NOT EQUAL
.
          CALL      WRALISS1                * write referral issue
.
          MOVE      ZERO,EXIT
          GOTO      ALISS999
.
ALISSU20  PACK      KEY16,ADMISSNO,ALISS002,SP70      * update referral issue
          CALL      RDALISS1
          BRANCH    OVRCD,ALISSU93
.
          CALL      MVALIS00                * move in the cgi-parameters
.
          PACK      ALISUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALISUDAT
          CLOCK     TIME,ALISUTIM
          MOVE      USERID,ALISUUID
.
          CALL      UPALISS1
.
          MOVE      ZERO,EXIT
          GOTO      ALISS999
.
ALISSU30  PACK      KEY16,ADMISSNO,ALISS002,SP70      * delete referral issue
          CALL      RDALISS1
          BRANCH    OVRCD,ALISSU93
.
          CALL      DEALISS1
.
          MOVE      ZERO,EXIT
          GOTO      ALISS999
.         
ALISSU40  MOVE      ZERO,EXIT
          PACK      KEY8,URNUMBER,SP70      * Patient Details
          CALL      RDMAST1
          BRANCH    OVRCD,ALISSU91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,ALISSU92
.
          PACK      KEY16,ADMISSNO,ISSUENUM,SP70  * Patient Issue Details
          CALL      RDALISS1
          IF        OVRCD = 1
            CALL      CLALLISS
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Allied Health Referral Issues",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALISS999
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALISS999
.
.
ALISSU91  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALISS999
.
ALISSU92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALISS999
.
ALISSU93  MOVE      "Invalid Issue.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALISS999
.
ALISS998  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALISS999
.
ALISS999  RETURN
.
.*******************************************************************************
.                        Print Request Processing
.*******************************************************************************
PRNT0000  MOVE      ZERO,EXIT
.
          MOVE      ZERO,UNIQF5
          PACK      KEY5,Z70
          CALL      RSALLPC1
          CALL      RPALLPC1
          BRANCH    OVRCD,PRNT0100
          MOVE      ALLPSCHE,UNIQF5
.
PRNT0100  MOVE      URNUMBER,ALLPURNO
          MOVE      ADMISSNO,ALLPVISN
          MOVE      SP70,ALLPOUNO
          MOVE      SP70,ALLPOUST
          MOVE      SP70,STATNCOD
.
          MATCH     "1",PRTPCK01                 * Print a Letter ?
          GOTO      PRNT0200 IF NOT EQUAL
.
          MOVE      PRTPSL01,ALLPPRNT
....      MOVE      PRTPNO01,ALLPCOPY            * no.of copies from template
          MOVE      ONE,ALLPCOPY                 * std. 1 copy for letters
          MOVE      SP10,ALLPSTAT
          MOVE      PRTPLET1,ALLPLETT
          MOVE      ONE,ALLPPTYP
          MATCH     SP8,PRTPVIS1
          IF        !@EQUAL
            MOVE      PRTPVIS1,ALLPOUNO          * Outpatient Visit
            MOVE      PRTPSIT1,ALLPOUST          * Outpatient Site
          ENDIF
          MOVE      USERID,ALLPWEBU
          PACK      ALLPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALLPRDAT
          MOVE      CTIMEIS,ALLPRTIM
.
PRNT0150  ADD       ONE,UNIQF5
          MOVE      UNIQF5,KEY5
          MOVE      UNIQF5,ALLPSCHE
          CALL      RAALLPC1
          COMPARE   ZERO,OVRCD
          GOTO      PRNT0150 IF EQUAL
.
          MOVE      PRTPSL01,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      "ALLLETRS",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      WRALLPC1
.
.
PRNT0200  MATCH     "1",PRTPCK02                 * Print a Form ?
          GOTO      PRNT0300 IF NOT EQUAL
.
          MOVE      PRTPSL02,SCHDPRNT
          MOVE      PRTPSL02,ALLPPRNT
....      MOVE      PRTPNO01,ALLPCOPY            * no.of copies from template
          MOVE      ONE,ALLPCOPY                 * std. 1 copy for letters
          MOVE      PRTPFRM1,ALLPSTAT
          MOVE      SP10,ALLPLETT
          MOVE      TWO,ALLPPTYP
          MATCH     SP8,PRTPVIS2
          IF        !@EQUAL
            MOVE      PRTPVIS2,ALLPOUNO          * Outpatient Visit
            MOVE      PRTPSIT2,ALLPOUST          * Outpatient Site
          ENDIF
          MOVE      USERID,ALLPWEBU
          PACK      ALLPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALLPRDAT
          MOVE      CTIMEIS,ALLPRTIM
.
PRNT0250  ADD       ONE,UNIQF5
          MOVE      UNIQF5,KEY5
          MOVE      UNIQF5,ALLPSCHE
          CALL      RAALLPC1
          COMPARE   ZERO,OVRCD
          GOTO      PRNT0250 IF EQUAL
.
          MOVE      PRTPSL02,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      "ALLFORMS",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      WRALLPC1
.
.
PRNT0300  MATCH     "1",PRTPCK03                 * Print Referral Labels ?
          GOTO      PRNT0400 IF NOT EQUAL
.
          PACK      SUBSYSKY,SP70
          MOVE      PRTPSL03,SCHDPRNT
          MOVE      PRTPNO03,SCHDCOPY
          MOVE      SP70,STATNCOD
          MOVE      SP70,ALDLPLAB
.
          CALL      ALBT0000                    * AH label type
.
          MOVE      "LABELALL",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0400  MATCH     "1",PRTPCK04                 * Print PMI/Mailing Labels ?
          GOTO      PRNT9999 IF NOT EQUAL
.
          MOVE      PRTPSL04,SCHDPRNT
          MOVE      PRTPNO04,SCHDCOPY
          MOVE      "LABELPMI01",LABELTYP
.
          MOVE      "LABELPMI",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
          GOTO      PRNT9999
.
PRNT9000  CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRNT9999
.
PRNT9999  RETURN
.
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
.*******************************************************************************
.                        Print Request Processing
.*******************************************************************************
PRAL0000  MOVE      ZERO,EXIT
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDLL1
          BRANCH    OVRCD,PRAL9999
.
          MATCH     "1",PRTNEWPT                 * Print a new patient Letter ?
          GOTO      PRAL0200 IF NOT EQUAL
.
          MOVE      PRTPSL01,PRINTERC
          MOVE      ALDLRACP,LETTERC
          MOVE      "ALLNEWPT",SETDFPRG
          CALL      PRLT0000
.
PRAL0200  MATCH     "1",PRTNEWRF                 * Print a new referrer Letter ?
          GOTO      PRAL0300 IF NOT EQUAL
.
          MOVE      PRTPSL02,PRINTERC
          MOVE      ALDLRACR,LETTERC
          MOVE      "ALLNEWRF",SETDFPRG
          CALL      PRLT0000
.
PRAL0300  MATCH     "1",PRTUPDPT             * Print an update patient letter ?
          GOTO      PRAL0400 IF NOT EQUAL
.
          MOVE      PRTPSL03,PRINTERC
          MOVE      ALDLURAP,LETTERC
          MOVE      "ALLUPDPT",SETDFPRG
          CALL      PRLT0000
.
PRAL0400  MATCH     "1",PRTUPDRF             * Print an update referrer letter ?
          GOTO      PRAL0500 IF NOT EQUAL
.
          MOVE      PRTPSL04,PRINTERC
          MOVE      ALDLURAR,LETTERC
          MOVE      "ALLUPDRF",SETDFPRG
          CALL      PRLT0000
.
PRAL0500  MATCH     "1",PRTREJPT             * Print an reject patient letter ?
          GOTO      PRAL0600 IF NOT EQUAL
.
          MOVE      PRTPSL05,PRINTERC
          MOVE      ALDLRPAT,LETTERC
          MOVE      "ALLREJPT",SETDFPRG
          CALL      PRLT0000
.
PRAL0600  MATCH     "1",PRTREJRF             * Print an reject patient letter ?
          GOTO      PRAL0700 IF NOT EQUAL
.
          MOVE      PRTPSL06,PRINTERC
          MOVE      ALDLRREF,LETTERC
          MOVE      "ALLREJRF",SETDFPRG
          CALL      PRLT0000
.
PRAL0700  MATCH     SP70,PRTREFGP            * Print reject patient GP letter?
          GOTO      PRAL0800 IF EQUAL
.
          MOVE      PRTPSL08,PRINTERC
          MOVE      PRTREFGP,LETTERC
          MOVE      "ALLNEWGP",SETDFPRG
          CALL      PRLT0000
.
PRAL0800  MATCH     "1",PRTREFLB                 * Print Referral Labels ?
          GOTO      PRNT9999 IF NOT EQUAL
.
          PACK      SUBSYSKY,SP70
          MOVE      PRTPSL07,SCHDPRNT
          MOVE      PRTPNO07,SCHDCOPY
          MOVE      SP70,STATNCOD
          PACK      LABELTYP,LABELALL,ALDLPLAB
.
          MOVE      "LABELALL",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRAL9999  RETURN
.
PRLT0000  MOVE      ZERO,UNIQF5
          PACK      KEY5,Z70
          CALL      RSALLPC1
          CALL      RPALLPC1
          BRANCH    OVRCD,PRLT0100
          MOVE      ALLPSCHE,UNIQF5
.
PRLT0100  MOVE      URNUMBER,ALLPURNO
          MOVE      ADMISSNO,ALLPVISN
          MOVE      SP70,ALLPOUNO
          MOVE      SP70,ALLPOUST
          MOVE      SP70,STATNCOD
.
          MOVE      PRINTERC,ALLPPRNT
          MOVE      ONE,ALLPCOPY                 * std. 1 copy for letters
          MOVE      SP10,ALLPSTAT
.
          MOVE      LETTERC,ALLPLETT
          MOVE      ONE,ALLPPTYP
          MOVE      USERID,ALLPWEBU
          PACK      ALLPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALLPRDAT
          MOVE      CTIMEIS,ALLPRTIM
.
PRLT0150  ADD       ONE,UNIQF5
          MOVE      UNIQF5,KEY5
          MOVE      UNIQF5,ALLPSCHE
          CALL      RAALLPC1
          COMPARE   ZERO,OVRCD
          GOTO      PRLT0150 IF EQUAL
.
          MOVE      PRINTERC,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      WRALLPC1
.
PRLT9999  RETURN
+
.******************************************************************************
. Process Fields in Body of HTML Template                                     .
.******************************************************************************
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD99:
                             PROFLD99,PROFLD70,PROFLD80,PROFLD90,PROFL100:
                             PROFL110,PROFL120,PROFL130,PROFL140,PROFL150:
                             PROFL160,PROFL170
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
          GOTO      PROFLD99
.
PROFLD11  CALL      ALLH0000                * Patient Referral Table Details
          GOTO      PROFLD99
.
PROFLD12  CALL      DOCF0000                * Patient Doctor Details
          GOTO      PROFLD99
.
PROFLD13  CALL      TABL0000                * Patient Referral Tables
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23,PROFLD24,PROFLD25:
                             PROFLD26,PROFLD27,PROFLD28,PROFLD29,PROFL29X
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD23  CALL      TABL0000                * Patient Referral Tables
          GOTO      PROFLD99
.
PROFLD24  CALL      VISF0000                * Patient Visit Details
          GOTO      PROFLD99
.
PROFLD25  CALL      ALAE0000                * Additional ERC fields
          GOTO      PROFLD99
.
PROFLD26  CALL      ADDR0000                * Add Patient Referral Details
          GOTO      PROFLD99
.
PROFLD27  CALL      PMIX0000                * Master extension file
          GOTO      PROFLD99
.
PROFLD28  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFLD29  CALL      ALRH0000                 * Main health and Other Factors
          GOTO      PROFLD99
.
PROFL29X  CALL      MISC0000 
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35:
                             PROFLD36,PROFLD37,PROFLD38,PROFLD39
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFLD33  CALL      ADDR0000                * Add Patient Referral Details
          GOTO      PROFLD99
.
PROFLD34  CALL      VISF0000                * Patient Visit Details
          GOTO      PROFLD99
.
PROFLD35  CALL      PMIX0000                * Master extension file
          GOTO      PROFLD99
.
PROFLD36  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFLD37  CALL      ALRH0000                 * Main health and Other Factors
          GOTO      PROFLD99
.
PROFLD38  CALL      TABL0000                 * Patient Referral Tables
          GOTO      PROFLD99
.
PROFLD39  CALL      MISC0000                 * Miscellaneous Outputs
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD42  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD43  CALL      TABL0000                * Patient Referral Tables
          GOTO      PROFLD99
.
PROFLD44  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD72  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD73  CALL      TABL0000                * Patient Referral Tables
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000                
          GOTO      PROFLD99
.
PROFLD82  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD83  CALL      ALEX0000
          GOTO      PROFLD99
.
PROFLD84  CALL      TABL0000                * Patient Referral Tables
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD92  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD93  CALL      ALIS0000                * Patient Referral Issues 
          GOTO      PROFLD99
.
PROFL100  BRANCH    FLDSETNO,PROFL101,PROFL102,PROFL103,PROFL104,PROFL105:
                             PROFL106,PROFL107,PROFL108,PROFL109,PROF1010
          GOTO      PROFLD99
.         
PROFL101  CALL      MASF0000
          GOTO      PROFLD99
.         
PROFL102  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99                
.         
PROFL103  CALL      TABL0000
          GOTO      PROFLD99
.
PROFL104  CALL      ALBI0000                * Barthel scores
          GOTO      PROFLD99
.
PROFL105  CALL      PTFI0000                * FIM scores
          GOTO      PROFLD99
.
PROFL106  CALL      ALSA0000                * PC scores
          GOTO      PROFLD99
.
PROFL107  CALL      MISF0000                * Admission Details
          GOTO      PROFLD99
.
PROFL108  CALL      DSCF0000                * Discharge Details
          GOTO      PROFLD99
.
PROFL109  CALL      MISC0000                * Miscellaneous Outputs
          GOTO      PROFLD99
.
PROF1010  CALL      MHON0000                * MEH HONOS Details
          GOTO      PROFLD99
.
PROFL110  BRANCH    FLDSETNO,PROFL111,PROFL112,PROFL113
          GOTO      PROFLD99
.         
PROFL111  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL112  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFL113  CALL      ADDR0000                * Add Patient Referral Details
          GOTO      PROFLD99
.
PROFL120  BRANCH    FLDSETNO,PROFL121,PROFL122,PROFL123,PROFL124
          GOTO      PROFLD99
.
PROFL121  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL122  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFL123  CALL      ALRN0000
          GOTO      PROFLD99
.
PROFL124  CALL      TABL0000                * Patient Referral Tables
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131,PROFL132
          GOTO      PROFLD99
.
PROFL131  CALL      MASF0000                * Patient Master
          GOTO      PROFLD99
.
PROFL132  CALL      VSMD0000                * Visit based comments
          GOTO      PROFLD99
.
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142,PROFL143,PROFL144
          GOTO      PROFLD99
.
PROFL141  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL142  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFL143  CALL      TABL0000                * Patient Referral Tables
          GOTO      PROFLD99
.
PROFL144  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151
          GOTO      PROFLD99
.
PROFL151  CALL      ALAU0000 
          GOTO      PROFLD99
.
PROFL160  BRANCH    FLDSETNO,PROFL161
          GOTO      PROFLD99
.
PROFL161  CALL      ALRE0000 
          GOTO      PROFLD99
.
PROFL170  CALL      ALLH0000                 
          GOTO      PROFLD99
.
PROFLD99  RETURN
.******************************************************************************
.MISC0000   Miscellaneous outputs
.******************************************************************************
MISC0000  BRANCH    FLDITMNO,MISC0010,MISC0020,MISC0030,MISC0040,MISC0050:
                             MISC0060,MISC0070,MISC0080,MISC0090,MISC0100:
                             MISC0110,MISC0120,MISC0130,MISC0140,MISC0150:
                             MISC0160,MISC0170,MISC0180,MISC0190,MISC0200:
                             MISC0210,MISC0220,MISC0230,MISC0240,MISC0250:
                             MISC0260,MISC0270,MISC0280,MISC0290,MISC0300:
                             MISC0310,MISC0320,MISC0330,MISC0340,MISC0350:
                             MISC0360,MISC0370
          GOTO      MISC9999
.
MISC0010  WRITE     HTMLFILE;PTVITYPE;       * Type of visit
          GOTO      MISC9999
.
MISC0020  WRITE     HTMLFILE;PMVXINGP;       * Inform GP?
          GOTO      MISC9999
.
MISC0030  CALL      ASTYPE00                 * Output Assessment Type List
          GOTO      MISC9999                 * based on care type
.
MISC0040  WRITE     HTMLFILE;REFERRAL;       * Referral for relinking
          GOTO      MISC9999
.
MISC0050  
          GOTO      MISC9999
.
MISC0060  WRITE     HTMLFILE;ENCOUTKY;
          GOTO      MISC9999
.
MISC0070  MOVE      ZERO,TCFORM6
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;TCFORM6;
          GOTO      MISC9999
.
MISC0080  UNPACK    DIM127,D1,KEY3,DIM127    * Output SMMSE tags             
          MOVE      KEY3,FLDITMNO
          CALL      PMMS0000
          GOTO      MISC9999
.
MISC0090  UNPACK    DIM127,D1,KEY3,DIM127    * Output RUG-ADL tags
          MOVE      KEY3,FLDITMNO
.
          PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          CALL      RDPMRUG1
          IF        OVRCD = 1 & (FLDITMNO<29 | FLDITMNO>30) 
            GOTO      MISC9999
          ENDIF
.
          CALL      PRUG0000
          GOTO      MISC9999
.
MISC0100  MOVE      "hf",CATEGORY
          MOVE      MHHNFOCU,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC0110  WRITE     HTMLFILE;SUPERLEV;
          GOTO      MISC9999
.
MISC0120  MOVE      "pu",CATEGORY
          MOVE      PMRUPTYP,CODE
          CALL      CODITM00
          GOTO      PRUG9999
.
MISC0130  MOVE      "pv",CATEGORY
          MOVE      PMRUMTYP,CODE
          CALL      CODITM00
          GOTO      PRUG9999
.
MISC0140  MOVE      "AW",CATEGORY
          MOVE      PMRUDRES,CODE
          CALL      CODITM00
          GOTO      PRUG9999
.
MISC0150  PACK      SAVKEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          PACK      KEY24,PMRUG001,Z70
.
          CALL      RSPMRUG1
MISC0151  CALL      RPPMRUG1
          IF        OVRCD = 1
            CALL      CLPRUG00
            GOTO      MISC0155
          ENDIF
.
          MATCH     "0",PMRUATYP
          GOTO      MISC0151 IF NOT EQUAL
.
          PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          MATCH     SAVKEY24,KEY24
          GOTO      MISC0155 IF EQUAL
.
          CALL      CLPRUG00
          GOTO      MISC0155
.
MISC0155  WRITE     HTMLFILE;PMRUPSDT;
.
          PACK      KEY24,SAVKEY24
          CALL      RDPMRUG1
.
          GOTO      MISC9999
.
MISC0160  MOVE      ADATE,FIRSTDAT
          MOVE      ATIME,D5
          REP       ": ",D5
          SQUEEZE   D5
          PACK      FIRSTIME,D5,SP70
.
          MOVE      DDATE,LASTDATE
          MOVE      DTIME,D5
          REP       ": ",D5
          SQUEEZE   D5
          PACK      LASTTIME,D5,SP70
.
          CALL      TIMEDIFF
.
          IF        CALCTIME > 1440
            WRITE     HTMLFILE;ONE;
          ELSE
            WRITE     HTMLFILE;ZERO;
          ENDIF
          GOTO      MISC9999
.
MISC0170  MOVE      "hb",CATEGORY
          MOVE      MHHNAQ8A,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC0180  PACK      SAVKEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          PACK      KEY24,PMRUG001,Z70
.
          CALL      RSPMRUG1
MISC0181  CALL      RPPMRUG1
          IF        OVRCD = 1
            CALL      CLPRUG00
            GOTO      MISC0185
          ENDIF
.
          MATCH     "0",PMRUATYP
          GOTO      MISC0181 IF NOT EQUAL
.
          PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          MATCH     SAVKEY24,KEY24
          GOTO      MISC0185 IF EQUAL
.
          CALL      CLPRUG00
          GOTO      MISC0185
.
MISC0185  UNPACK    DIM127,D1,KEY1,DIM127
.
          MATCH     "1",KEY1
          IF        @EQUAL
            MATCH     SP70,PMRUPEDT
            GOTO      MISC0187 IF EQUAL
.
            MOVE      SP70,DISPDAT1
            UNPACK    PMRUPEDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            WRITE     HTMLFILE;DISPDAT1;
          ELSE
            WRITE     HTMLFILE;PMRUPEDT;
          ENDIF
.
MISC0187  PACK      KEY24,SAVKEY24
          CALL      RDPMRUG1
.
          GOTO      MISC9999
.
.
MISC0190  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
.          
          PACK      KEY16,MHHON001,MHHON002,SP70
          CALL      RDMHHON1
          IF        OVRCD = 1
            GOTO      MISC9999
          ENDIF
          CALL      MHON0000
          GOTO      MISC9999
.
MISC0200  MOVE      "hv",CATEGORY
          MOVE      MHHNHVER,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC0210  CALL      ASTYP100                 * Output Assessment Type List
          GOTO      MISC9999                 * based on care type
.
MISC0220  WRITE     HTMLFILE;WAITLIST;       * WL Key
          GOTO      MISC9999                                         
.
MISC0230  PACK      KEY24,ENCOUTKY,Z70      * Do interventions exists
          CALL      RSALITV1                * for this contact
          CALL      RPALITV1
          BRANCH    OVRCD,MISC9999
.
          PACK      DIM16,ALIVVISN,ALIVENCT,SP70
          MATCH     DIM16,ENCOUTKY
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      MISC9999
.
MISC0240  PACK      KEY24,ADMISSNO,Z70      * Do interventions exists
          CALL      RSALITV1                * for this referral
          CALL      RPALITV1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ADMISSNO,ALIVVISN
          GOTO      MISC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      MISC9999
.
MISC0250  MATCH     SP70,CONTDATE
          GOTO      MISC9999 IF EQUAL
.
          UNPACK    CONTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC0260  WRITE     HTMLFILE;VINAHERR;       * VINAH Error Correction Flag
          GOTO      MISC9999                                         
.
MISC0270  WRITE     HTMLFILE;EREFRLID;       *eReferral Id              
          GOTO      MISC9999                                         
.
MISC0280  CALL      APPRQS00               
          GOTO      MISC9999                                         
.
MISC0290  WRITE     HTMLFILE;OTARTKEY;       * Apptt Request key for relinking
          GOTO      MISC9999
.
MISC0300  CALL      REFOUT00
          GOTO      MISC9999
.
MISC0310  WRITE     HTMLFILE;CHNGDATE;
          GOTO      MISC9999
.
MISC0320  WRITE     HTMLFILE;CHNGTIME;
          GOTO      MISC9999
.
MISC0330  WRITE     HTMLFILE;CHNGPORT;
          GOTO      MISC9999
.
MISC0340  WRITE     HTMLFILE;CHNGTYPE;
          GOTO      MISC9999
.
MISC0350  MATCH     SP70,CHNGDATE
          GOTO      MISC9999 IF EQUAL
          UNPACK    CHNGDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      MISC9999
.
MISC0360  WRITE     HTMLFILE;REFREJCT;
          GOTO      MISC9999
.
MISC0370  WRITE     HTMLFILE;VALDTIME;
          GOTO      MISC9999
.
MISC9999  RETURN
+
.******************************************************************************
. ASTYPE00   Output Assessment Type selection list based on care type         .
.******************************************************************************
ASTYPE00  WRITE     HTMLFILE;"<option></option>"
.
          MOVE      ZERO,TCFORM6
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ASTYPE99
.
          COMPARE   FOUR,PTCNHDPS
          IF        @EQUAL
            IF        PTCNQLDB=6
              PACK      KEY5,ANSA,SP1,ATYPE,SP70   * use atype for care class
              CALL      RDCODE1
              BRANCH    OVRCD,ASTYPE99
            ENDIF
            CALL      QLDCAR00       * QLD assessment options
            GOTO      ASTYPE99
          ENDIF
.
          COMPARE   EIGHT,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"1#">GEM</option>"
            WRITE     HTMLFILE;"<option value=#"2#">SMMSE</option>"
          ENDIF
.
          COMPARE   TEN,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"5#">Maintenance</option>"
          ENDIF
.
          COMPARE   SEVEN,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"3#">":
                               "Palliative Care Assessment</option>"
          ENDIF
.
          COMPARE   NINE,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"6#">HONOS</option>"
          ENDIF
.
          COMPARE   FOUR,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"7#">FIM Assessment</option>"
          ENDIF
.
ASTYPE99  RETURN
+
.******************************************************************************
. QLDCAR00   Output Assessment Type selection list based on care type         .
.            for Queensland care types                                        .
.******************************************************************************
QLDCAR00  MATCH     "09",THCSCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"1#">GEM</option>"
            GOTO      QLDCAR99
          ENDIF
.
          MATCH     "10",THCSCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"5#">HONOS</option>"
            GOTO      QLDCAR99
          ENDIF
.
          MATCH     "20",THCSCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"6#">FIM Assessment</option>"
            GOTO      QLDCAR99
          ENDIF
.
QLDCAR99  RETURN
.
.------------------------------------------------------------
. Retrieve outpatient appointment requests
.------------------------------------------------------------
APPRQS00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Reading For Web Security Id
          IF        OVRCD=1
            MOVE      SP70,ALDESECU
          ENDIF
.
          PACK      KEY32,URNUMBER,Z70
          CALL      RSOTART1                * positional read
APPRQS10  CALL      RPOTART1                * read a record
          BRANCH    OVRCD,APPRQS99
.
          MATCH     URNUMBER,OTARURNO       * same ur number
          GOTO      APPRQS99 IF NOT EQUAL
.
          PACK      KEY8,OTARREFN,SP70
          CALL      RDALREF1                * Read the referral
          BRANCH    OVRCD,APPRQS10
.
          MATCH     "0",OTARSTAT
          GOTO      APPRQS10 IF NOT EQUAL
.
          PACK      KEY3,OTARADEP,SP70
          CALL      RDALDEP1                * Reading For Department Security
          BRANCH    OVRCD,APPRQS10
.
          MATCH     "0",ALDESECU
          GOTO      APPRQS15 IF EQUAL
.
          MATCH     "1",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,OTARADEP
            GOTO      APPRQS15 IF EQUAL
            GOTO      APPRQS10 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,OTARADEP
            GOTO      APPRQS10 IF NOT EQUAL
          ENDIF
.
APPRQS15  UNPACK    OTARRQDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,REQBDEPT                     * Requested By Department
          MATCH     SP70,OTARRDEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARRDEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRDEP,TDESC
            ENDIF
            MOVE      TDESC,REQBDEPT
          ENDIF
.
          MOVE      SP70,ADEPDESC                     * Appointment Dept
          MATCH     SP70,OTARADEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARADEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARADEP,TDESC
            ENDIF
            MOVE      TDESC,ADEPDESC
          ENDIF
.
          MOVE      SP70,REASNREQ                      * Requested By Department
          MATCH     SP70,OTARRREQ
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSU,OTARRREQ,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRREQ,TDESC
            ENDIF
            MOVE      TDESC,REASNREQ
          ENDIF
.
          MOVE      SP70,PREFHOSP                     * Preferred Hospital
          MATCH     SP70,OTARPRHS
          IF        !@EQUAL
            PACK      KEY3,OTARPRHS,SP70
            CALL      RDPTHSP1
            IF        OVRCD=1
              MOVE      OTARPRHS,PTHSNAME
            ENDIF
            MOVE      PTHSNAME,PREFHOSP
          ENDIF
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OTARCLTY
          IF        !@EQUAL
            PACK      KEY12,OTARPRSI,OTARCLTY,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OTARCLTY,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
          MOVE      "Requested",OSTADESC 
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdateApptRequest('",HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARREFN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARRQTM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:",HTMLLNK2
          APPEND    "RequestLink('",HTMLLNK2
          APPEND    OTARURNO,HTMLLNK2
          APPEND    OTARREFN,HTMLLNK2
          APPEND    OTARRQDT,HTMLLNK2
          APPEND    OTARRQTM,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    ALRERDAT,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          WRITE     HTMLFILE;"t1.addRow(#"",HTMLLINK,"#",":         * 0
                             "#"",OTARRQDT,"#",":                   * 1
                             "#"",REQBDEPT,"#",":                   * 2
                             "#"",ADEPDESC,"#",":                   * 3
                             "#"",REASNREQ,"#",":                   * 4
                             "#"",PREFHOSP,"#",":                   * 5
                             "#"",CTYPDESC,"#",":                   * 6
                             "#"",OSTADESC,"#",":                   * 7
                             "#"",HTMLLNK2,"#");"                   * 8
.
          GOTO      APPRQS10
.
APPRQS99  RETURN
.
.------------------------------------------------------------
. Retrieve Referral In Outcome History
.------------------------------------------------------------
REFOUT00  PACK      KEY27,ADMISSNO,Z70
          CALL      RSALRIO1                * positional read
REFOUT20  CALL      RPALRIO1                * read a record
          BRANCH    OVRCD,REFOUT99
.
          MATCH     ADMISSNO,ALRIVISN       
          GOTO      REFOUT99 IF NOT EQUAL
.
REFOUT15  UNPACK    ALRIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      OUTDSC00
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1:
                             " ",ALRITIME,"</td>":                     
                             "<td>",OUTCDESC,"</td></tr>";    
          GOTO      REFOUT20
.
REFOUT99  RETURN
.
.------------------------------------------------------------
. Retrieve the correct referral in outcome description 
.------------------------------------------------------------
OUTDSC00  MOVE      SP70,OUTCDESC
          MOVE      ZERO,F2
.
          WHILE     F2 < 20
            ADD       ONE,F2
            PACK      KEY63,OUTCARAY[F2]
            UNPACK    KEY63,KEY3,KEY60
            MATCH     ALRIOUTC,KEY3
            IF        @EQUAL
              MOVE      KEY60,OUTCDESC
              GOTO      OUTDSC99
            ENDIF
          DO 
.
OUTDSC99  RETURN
+
.******************************************************************************
. ALLH0000   Allweb output routine!!!                                         .
.******************************************************************************
ALLH0000  BRANCH    FLDITMNO,ALLH0010,ALLH0020,ALLH0030,ALLH0040,ALLH0050:
                             ALLH0060,ALLH0070,ALLH0080,ALLH0090,ALLH0100:
                             ALLH0110,ALLH0120,ALLH0130,ALLH0140,ALLH0150:
                             ALLH0160,ALLH0170,ALLH0180,ALLH0190,ALLH0200:
                             ALLH0210,ALLH0220,ALLH0230,ALLH0240,ALLH0250:
                             ALLH0260,ALLH0270,ALLH0280,ALLH0290,ALLH0300:
                             ALLH0310,ALLH0320,ALLH0330,ALLH0340,ALLH0350:
                             ALLH0360,ALLH0370,ALLH0380,ALLH0390,ALLH0400:
                             ALLH0410,ALLH0420,ALLH0430,ALLH0440,ALLH0450:
                             ALLH0460,ALLH0470,ALLH0480                        

          GOTO      ALLH9999
.
ALLH0010  CALL      ANPL0000                * Next Page Day/Week/Month Link
          GOTO      ALLH9999
.
ALLH0020  CALL      APPL0000                * Previous Day/Week/Month Link
          GOTO      ALLH9999
.
ALLH0030  CALL      ACSD0000                * Current Start Date
          GOTO      ALLH9999
.
ALLH0040  CALL      ACED0000                * Current End Date
          GOTO      ALLH9999
.
ALLH0050  CALL      ACCY0000                * Current Year
          GOTO      ALLH9999
.
ALLH0060  CALL      ACCM0000                * Current Month
          GOTO      ALLH9999
.
ALLH0070  CALL      ASPO0000                * Select Period Options
          GOTO      ALLH9999
.
ALLH0080  CALL      AVVT0000                * View Type
          GOTO      ALLH9999
.
ALLH0090  CALL      ADPF0000                * Department Filter
          GOTO      ALLH9999
.
ALLH0100  CALL      APPF0000                * Priority Filter
          GOTO      ALLH9999
.
ALLH0110  CALL      ARRF0000                * Reason Filter
          GOTO      ALLH9999
.
ALLH0120  CALL      ARFD0000                * Referral Department
          GOTO      ALLH9999
.
ALLH0130  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          MOVE      SP2,NZFLAG
          UNPACK    DIM127,D1,NZFLAG,DIM127
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      AWRT0000              * Referral Waiting by department
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      AWRTD000
            ENDIF
          ENDIF
          GOTO      ALLH9999
.
ALLH0140  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      AART0000                * Active Referrals Table
          ENDIF
          GOTO      ALLH9999
.
ALLH0150  MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      ACRT0000                * Closed Referrals Table
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      ACRTH000
            ENDIF
          ENDIF
          GOTO      ALLH9999
.
ALLH0160  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      AIRT0000              * Inactive Referrals Table
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      AIRTH000
            ENDIF
          ENDIF
          GOTO      ALLH9999
.
ALLH0170  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      ACAR0000              * Cancel Referrals Table
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      ACARH000
            ENDIF
          ENDIF
          GOTO      ALLH9999
.
ALLH0180  CALL      NEXTGR00
          GOTO      ALLH9999                * Show Next of Records
.
ALLH0190  CALL      PREVGR00                * Show Previos Records
          GOTO      ALLH9999
.
ALLH0200  CALL      HCPCOD00                * Health Care Professional
          GOTO      ALLH9999
.
ALLH0210  CALL      NXTGRP00
          GOTO      ALLH9999                * Show Next of Records
.
ALLH0220  CALL      PRVGRP00                * Show Previos Records
          GOTO      ALLH9999
.
ALLH0230  MOVE      DEPTCODE,CODE
          MOVE      "CG",CATEGORY
          CALL      CODITM00
          GOTO      ALLH9999
.
ALLH0240  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      ALAC0000                * All Active Referrals Table
          ENDIF                               * for a given department
          GOTO      ALLH9999
.
ALLH0250  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,FILTTEAM
          GOTO      ALLH9999 IF EQUAL
.
          BRANCH    F1,ALLH0251
.
          PACK      KEY10,FILTTEAM,SP70
          CALL      RDALCAS1
          BRANCH    OVRCD,ALLH9999
.
          WRITE     HTMLFILE;ALCADESC;
          GOTO      ALLH9999
.
ALLH0251  WRITE     HTMLFILE;FILTTEAM;
          GOTO      ALLH9999
.
ALLH0260  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          CALL      OVRT0000                * Overdue Referrals Table
          GOTO      ALLH9999
.  
ALLH0270  WRITE     HTMLFILE;FILTCLID;      * Clinic Id Filter
          GOTO      ALLH9999
.
ALLH0280  WRITE     HTMLFILE;FILTCTYP;      * Clinic Type Filter
          GOTO      ALLH9999
.
ALLH0290  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      REJT0000              * Cancel Referrals Table
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      REJTH000
            ENDIF
          ENDIF
          GOTO      ALLH9999
.
ALLH0300  CALL      SRFL0000                * SACS Referrals Table
          GOTO      ALLH9999
.
ALLH0310  WRITE     HTMLFILE;STATCODE;      * Referral Status Filter
          GOTO      ALLH9999
.
ALLH0320  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          CALL      REVT0000                * Case Review Referrals Table
          GOTO      ALLH9999
.  
ALLH0330  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          CALL      NREV0000                * Next Review Referrals Table
          GOTO      ALLH9999
.  
ALLH0340  MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          CALL      ALRT0000                * All Referrals Table
          GOTO      ALLH9999
.
ALLH0350  WRITE     HTMLFILE;FILTSTAT;
          GOTO      ALLH9999
.
ALLH0360  MOVE      ONE,GPACCESS
          MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      ALAC0000                * All Active Referrals Table
          ENDIF                               * for a given department
          GOTO      ALLH9999
.
ALLH0370  WRITE     HTMLFILE;REFSTATS;
          GOTO      ALLH9999
.
ALLH0380  CALL      DEPD0000
          GOTO      ALLH9999
.
ALLH0390  CALL      FHSL0000                     * Hospital Filter
          GOTO      ALLH9999
.
ALLH0400  MOVE      FILTPSIT,SITECODE
          CALL      SLSITE00                     * Preferred Site Filter
          GOTO      ALLH9999
.
ALLH0410  IF        LISTFLAG=0
            GOTO      ALLH9999
          ENDIF
.
          UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          MOVE      SP2,NZFLAG
          UNPACK    DIM127,D1,NZFLAG,DIM127
.
          MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      AWRT0000              * Referral Waiting by department Search
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      AWRTD000
            ENDIF
          ENDIF
          GOTO      ALLH9999
.
ALLH0420  IF        LISTFLAG=0
            GOTO      ALLH9999
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      AART0000                * Active Referrals Table Search
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      AARTH000              * Active Referrals by HCP
            ENDIF
          ENDIF
          GOTO      ALLH9999
.
ALLH0430  IF        LISTFLAG=0
            GOTO      ALLH9999
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        @EQUAL
            MOVE      WBSECLI,FILTCLID
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            CALL      ALAC0000                * All Active Referrals Table
          ELSE
            MATCH     SP70,DOCTCODE
            IF        !@EQUAL
              CALL      ALACH000              * All Active Referrals by HCP
            ENDIF
          ENDIF                               * for a given department Search
          GOTO      ALLH9999
.
ALLH0440  WRITE     HTMLFILE;OVRDDEPT;
          GOTO      ALLH9999
.
ALLH0450  WRITE     HTMLFILE;OVRDHOSP;        * Override Hospital Filter
          GOTO      ALLH9999
.
ALLH0460  WRITE     HTMLFILE;DISPCTDL;        * HCP Desc Filter
          GOTO      ALLH9999
.
ALLH0470  CALL      AHCP0000                  * HCP Category Desc
          GOTO      ALLH9999
.
.
ALLH0480  PACK      KEY5,ANSD,ANSL,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ALLH9999
          WRITE     HTMLFILE;TDESC;
          GOTO      ALLH9999
ALLH9999  RETURN
+
.******************************************************************************
.  Patient Referral Details                                                   .
.******************************************************************************
TABL0000  BRANCH    FLDITMNO,TABL0010,TABL0020,TABL0030,TABL0040,TABL0050:
                             TABL0060,TABL0070,TABL0080,TABL0090,TABL0100:
                             TABL0110,TABL0120,TABL0130,TABL0140,TABL0150:
                             TABL0160,TABL0170,TABL0180,TABL0190,TABL0200:
                             TABL0210,TABL0220,TABL0230,TABL0240,TABL0250:
                             TABL0260,TABL0270,TABL0280,TABL0290,TABL0300:
                             TABL0310,TABL0320,TABL0330,TABL0340,TABL0350:
                             TABL0360,TABL0370,TABL0380,TABL0390,TABL0400:
                             TABL0410,TABL0420,TABL0430,TABL0440,TABL0450:
                             TABL0460,TABL0470,TABL0480,TABL0490,TABL0500:
                             TABL0510,TABL0520,TABL0530,TABL0540,TABL0550:
                             TABL0560,TABL0570,TABL0580,TABL0590,TABL0600:
                             TABL0610,TABL0620,TABL0630,TABL0640,TABL0650:
                             TABL0660,TABL0670,TABL0680,TABL0690,TABL0700:
                             TABL0710,TABL0720,TABL0730,TABL0740,TABL0750:
                             TABL0760,TABL0770,TABL0780,TABL0790,TABL0800:
                             TABL0810,TABL0820,TABL0830,TABL0840,TABL0850:
                             TABL0860,TABL0870,TABL0880,TABL0890,TABL0900:
                             TABL0910
          GOTO      TABL9999
.
TABL0010  MOVE      ZERO,ACTVONLY           * Display all Referrals
          MOVE      ZERO,LNKDRGHT
          MOVE      ZERO,LINKSRCH
          CALL      ALRL0000                * Patient Referral List
          GOTO      TABL9999
.
TABL0020  CALL      ALCD0000                * Linked Clinical Documents
          GOTO      TABL9999
.
TABL0030  CALL      ARAS0000                * Referral Audit Summary
          GOTO      TABL9999
.
TABL0040  CALL      ARAT0000                * Referral Audit Table
          GOTO      TABL9999
.
TABL0050  CALL      ASHT0000                * Status History Table
          GOTO      TABL9999
.
TABL0060  WRITE     HTMLFILE;AUDITKEY;
          GOTO      TABL9999
.
TABL0070  MOVE      SP70,CODE
          MOVE      "LF",CATEGORY
          CALL      CODITM00
          GOTO      TABL9999
.
TABL0080  CALL      ARFD0000
          GOTO      TABL9999
.
TABL0090  MOVE      ZERO,BOOKONLY
          MOVE      ZERO,DDQCKRLK
          CALL      LINKT000                 * Linked outpatient visits
          GOTO      TABL9999
.
TABL0100  CALL      ULNKT000                 * Unlinked outpatient visits
          GOTO      TABL9999
.
TABL0110  CALL      LREFT000                 * Linked referrals
          GOTO      TABL9999
.
TABL0120  CALL      UREFT000                 * Unlinked referrals
          GOTO      TABL9999
.
TABL0130  WRITE     HTMLFILE;BOOKWARN;       * Check for unlinked bookings 
          GOTO      TABL9999                 * after adding referral           
.
TABL0140  CALL      LINKR000                 * Linked referrals  
          GOTO      TABL9999                 * after adding referral           
.
TABL0150  CALL      ULNKR000                 * Unlinked referrals
          GOTO      TABL9999                 * after adding referral           
.
TABL0160  MOVE      ONE,ACTVONLY            * Display active Referrals
          MOVE      ZERO,LNKDRGHT
          CALL      APRL0000                * Patient Referral List
          GOTO      TABL9999
.
TABL0170  CALL      LETTY000                * Display Letter Types       
          GOTO      TABL9999
.
TABL0180  PACK      KEY17,ADMISSNO,ZERO,ZERO,EIGHT,SP70
          CALL      RSVSMDT1
TABL0185  CALL      RKVSMDT1                * Check for referral notes
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     "008",VSMDTYPE
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      TABL0185 IF EQUAL      * skip if there is a deleted note
.
          WRITE     HTMLFILE;ONE;
          GOTO      TABL9999 
.
TABL0190  CALL      PREVAU00                * Previous Audit               
          GOTO      TABL9999
.
TABL0200  CALL      NEXTAU00                * Next Audit
          GOTO      TABL9999
.
TABL0210  CALL      ACTT0000                * Referral Audit Action Summary
          GOTO      TABL9999
.
TABL0220  WRITE     HTMLFILE;FILTSTAT;      * Referral status filter
          GOTO      TABL9999
.
TABL0230  CALL      DEPF0000                * Department dropdown filter
          GOTO      TABL9999
.
TABL0240  CALL      ERTB0000                * External Referral List
          GOTO      TABL9999
.
TABL0250  MOVE      ZERO,XFORMAT
          CALL      WRSE0000                * List Encounters      
          GOTO      TABL9999
.
TABL0260  MOVE      ZERO,ACTVONLY           * Display all Referrals
          MOVE      ZERO,LNKDRGHT
          CALL      APRL0000                * Patient Referral List
          CALL      PATREF00                * OP Patient Referral List
          GOTO      TABL9999
.
TABL0270  MOVE      ONE,BOOKONLY
          MOVE      ZERO,DDQCKRLK
          CALL      LINKT000                 * Linked outpatient visits
          GOTO      TABL9999
.
TABL0280  CALL      PTAB0000                 * List Group Contact Enrolments
          GOTO      TABL9999
.
TABL0290  PACK      KEY16,ADMISSNO,SP70      * check for Referral Issues
          CALL      RSALISS1
          CALL      RKALISS1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALISVISN       
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           
          GOTO      TABL9999
.
TABL0300  PACK      KEY16,ADMISSNO,SP70      * check Referral Episode of Care
          CALL      RSALENC1
          CALL      RKALENC1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALENVISN       
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           
          GOTO      TABL9999
.
TABL0310  PACK      KEY16,ADMISSNO,SP20      * check for External Referrals
          CALL      RSALEXT1
TABL0311  CALL      RKALEXT1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALEXVISN
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           
          GOTO      TABL9999
.
TABL0320  PACK      KEY16,ADMISSNO,SP70      * check for Linked Referrals
          CALL      RSALRLN1
TABL0321  CALL      RKALRLN1 
          BRANCH    OVRCD,TABL9999
.         
          MATCH     ALRLVISN,ADMISSNO
          GOTO      TABL9999 IF NOT EQUAL
.           
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,TABL0321
.
          MATCH     "1",ALREUYN4            * Skip SACS master referrals
          GOTO      TABL0321 IF EQUAL
.
          WRITE     HTMLFILE;ONE;           
          GOTO      TABL9999
.
TABL0330  CALL      AUDC0000
          GOTO      TABL9999
.
TABL0340  CALL      LTHS0000                * audit letter history
          GOTO      TABL9999
.
TABL0350  CALL      BTAB0000                * Barthel Assessment List
          CALL      FTAB0000                * FIM Assessment List
          CALL      CTAB0000                * PC Assessment List
          CALL      ATAB0000                * AIMS Pain Assessment List
          CALL      BCTBL000            * AIMS Breathlessness Assessment List
          GOTO      TABL9999
.
TABL0360  CALL      CASS0000                * Check if visit has any assessments
          GOTO      TABL9999
.
TABL0370  CALL      CNTA0000                * Count visits assessments
          GOTO      TABL9999
.
TABL0380  CALL      ARFD0000                * department selction list 
          GOTO      TABL9999
.
TABL0390  PACK      KEY32,URNUMBER,ADMISSNO,SP70 * Requested Appointments
          CALL      RSOTART1
TABL0395  CALL      RKOTART1
          BRANCH    OVRCD,TABL9999
.
          MATCH     URNUMBER,OTARURNO
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTARREFN
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     "0",OTARSTAT                 * Requested or Pending Resch
          IF        !@EQUAL
            MATCH     "1",OTARSTAT
            GOTO      TABL0395 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;ONE;
          GOTO      TABL9999
.
TABL0400  MATCH     SP70,ALREPRTY                * Check for waiting on triage
          GOTO      TABL9999 IF EQUAL            * priority
.
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ANST,TCINDC2                 * Waiting on triage
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;TDESC;
          GOTO      TABL9999
.
TABL0410  CALL      FHSL0000                     * Hospital Filter
          GOTO      TABL9999
.
TABL0420  MOVE      FILTPSIT,SITECODE
          CALL      SLSITE00                     * Preferred Site Filter
          GOTO      TABL9999
.
TABL0430  MOVE      " 5",COMMTYPE                * OPD Closed Referral Comment
          MOVE      ALREURNO,COMMURNO            
          MOVE      ALREDCLO,COMMADAT
          MOVE      ALRETCLO,COMMATIM
.
          CALL      DISCOM00                     * Display OPD comments
          GOTO      TABL9999
.
TABL0440  CALL      FENC0000                     * First encounter added
          GOTO      TABL9999
.
TABL0450  CALL      DEPC0000                     * Add combined department list
          GOTO      TABL9999
.
TABL0460  CALL      ALDEDT00            * Other Allied Health Department flags
          GOTO      TABL9999
.
TABL0470  PACK      KEY16,ADMISSNO,SP70          * Check for Residential Adm
          CALL      RSALRSA1
TABL0471  CALL      RKALRSA1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALRAVISN
          GOTO      TABL9999 IF NOT EQUAL
.
          PACK      KEY8,ALRALADM,SP70           * Linked admission?
          CALL      RDMISS1
          BRANCH    OVRCD,TABL0471
.
          WRITE     HTMLFILE;ONE;
          GOTO      TABL9999
.
TABL0480  MOVE      ONE,XFORMAT
          CALL      WRSE0000                * List Encounters      
          GOTO      TABL9999
.
TABL0490  MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,NOTEORDR
          MOVE      KEY1,NOTEORDR
          CALL      CLVNOT00
          CALL      DISNOT00
          GOTO      TABL9999
.
TABL0500  CALL      BTAB0000                * Barthel Assessment List
          CALL      FTAB0000                * FIM Assessment List
          CALL      CTAB0000                * PC Assessment List
          CALL      HTAB0000                * HONOS Assessment List
          GOTO      TABL9999
.
TABL0510  PACK      KEY16,ADMISSNO,SP70      * check Referral Episode of Care
          CALL      RSALENC1                 * to see if they are all cancelled
TABL0511  CALL      RKALENC1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALENVISN
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA            * Cancelled encounter skip
          GOTO      TABL0511 IF EQUAL
.
          WRITE     HTMLFILE;ONE;           * Active encounters exits 
          GOTO      TABL9999
.
TABL0520  MOVE      SP70,PTHSHOSP
          PACK      KEY3,ALREDEPT,SP70
          CALL      RSALDEP1
          PACK      KEY3,ALDEHOSP,SP70
          CALL      RDPTHSP1
          WRITE     HTMLFILE;PTHSHOSP;
          GOTO      TABL9999
.
TABL0530  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALGPA2
          CALL      RKALGPA2
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALGAREFN
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           * Group contacts exist
          GOTO      TABL9999
.
TABL0540  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
TABL0541  CALL      RKALLNK1                * Linked OP visits
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelledx
          GOTO      TABL0541 IF EQUAL  
.
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,TABL0541
.
          MATCH     ALLNLNKV,DOBAOUTN
          GOTO      TABL0541 IF NOT EQUAL
.
          IF        OBASTAT<>1 & OBASTAT<>4
            GOTO      TABL0541
          ENDIF
.
          WRITE     HTMLFILE;ONE;      * Booked or Attended OP visit exists
          GOTO      TABL9999
.
TABL0550  CALL      LTTYNZ00               * Display Letter Types
          GOTO      TABL9999
.
TABL0560  CALL      RNTB0000               * Display Referral Renewal Audit List
          GOTO      TABL9999
.
TABL0570  PACK      KEY24,ADMISSNO,SP70      * check for Referral renewals
          CALL      RSALRNW1
          CALL      RKALRNW1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALRNVISN
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      TABL9999
.
TABL0580  CALL      ULNKC000                 * Unlinked cancelled OP visits
          GOTO      TABL9999
.
TABL0590  CALL      LINKC000                 * Linked cancelled OP visits
          GOTO      TABL9999
.
TABL0600  MOVE      ZERO,BOOKONLY
          MOVE      ONE,DDQCKRLK
          CALL      LINKT000                 * Linked outpatient visits
          GOTO      TABL9999
.
TABL0610  WRITE     HTMLFILE;NODELETE;       * Don't show delete button
          GOTO      TABL9999
.
TABL0620  CALL      EXDEPT00                 * Extra Department tags
          GOTO      TABL9999
.
TABL0630  CALL      WAHAS000                * WA Health Assessment List
          GOTO      TABL9999
.
TABL0640  MOVE      NHMADOMC,KEY4
          PROC      NHIDHBDS                * output NHI Domicile DHB Code (nz)
          GOTO      TABL9999
.
TABL0650  PACK      KEY17,ADMISSNO,ZERO,ZERO,FIVE,SP70
          CALL      RSVSMDT1
          CALL      RKVSMDT1                * Check for booking instruction
          BRANCH    OVRCD,TABL9999          * comments
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     "005",VSMDTYPE
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      TABL9999
.
TABL0660  CALL      LINKW000                 * Linked WL procedures
          GOTO      TABL9999
.
TABL0670  CALL      ULNKW000                 * Un-Linked WL procedures
          GOTO      TABL9999
.
TABL0680  MOVE      ZERO,ACTVONLY           * Display all Referrals
          MOVE      ZERO,LNKDRGHT
          MOVE      ZERO,LINKSRCH
          CALL      ALRL0000                * Patient Referral List
          GOTO      TABL9999
.
TABL0690  CALL      AUDJ0000
          GOTO      TABL9999
.
TABL0700  CALL      AUDN0000
          GOTO      TABL9999
.
TABL0710  CALL      QLHAS000                * QLD Health Assessment List
          GOTO      TABL9999
.
TABL0720  WRITE     HTMLFILE;PTCOLUMN;      * Presenting Complaint flag
          GOTO      TABL9999
.
TABL0730  MOVE      ZERO,ACTVONLY           * Display all Referrals
          MOVE      ONE,LNKDRGHT
          MOVE      ZERO,LINKSRCH
.         CALL      APRL0000                * Patient Referral List
          CALL      ALRL0000                * Patient Referral List
          GOTO      TABL9999
.
TABL0740  PACK      KEY8,ADMISSNO,SP20      * get ACC purchase order no
          CALL      RDPMWX11
          BRANCH    OVRCD,TABL9999
.
          WRITE     HTMLFILE;PMWXPORD;
          GOTO      TABL9999
.
TABL0750  PACK      KEY16,ADMISSNO,Z70
          CALL      RSALADS1
TABL0751  CALL      RPALADS1
          BRANCH    OVRCD,TABL9999
.
          MATCH     ADMISSNO,ALADREFN
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      TABL9999
.
TABL0760  PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                     * Referral department
          BRANCH    OVRCD,TABL9999
.
          MATCH     "1",ALDEUTRS                 * Using triage status
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     SP70,ALRETRGS                * Blank triage status
          GOTO      TABL9999 IF EQUAL
.
          PACK      KEY5,CATTS,ALRETRGS,SP70
          CALL      RDCODE1                      * Read triage status
          BRANCH    OVRCD,TABL9999
.
          MATCH     "99",THCSCOD                 * Insufficient Info
          IF        !@EQUAL
            MATCH     "98",THCSCOD               * Waiting on triage
            GOTO      TABL9999 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;TDESC;
          GOTO      TABL9999
.
TABL0770  MOVE      FILTTRGS,CODE                * Triage status filter
          MOVE      "ts",CATEGORY
          CALL      CODITM00
          GOTO      TABL9999
.
TABL0780  WRITE     HTMLFILE;EREFRLID;           * ereferral ID
          GOTO      TABL9999
.
TABL0790  WRITE     HTMLFILE;ALCNDTRG;           * Display Triage status
          GOTO      TABL9999
.
TABL0800  CALL      RQAPT000                     *Requested Appointments
          GOTO      TABL9999
.
TABL0810  MOVE      ZERO,ACTVONLY           * Display all Referrals
          MOVE      ZERO,LNKDRGHT
          CALL      ALRLAQ00                * Patient Referral List
          GOTO      TABL9999
.
TABL0820  CALL      SUPD0000                * Supervisor Referral function
          GOTO      TABL9999
.
TABL0830  WRITE     HTMLFILE;THETKEYS;           * Theatre Casekeys
          GOTO      TABL9999
.
TABL0840  CALL      AURE0000                 * List refaudre
          GOTO      TABL9999
.
TABL0850  CALL      AUREC000
          GOTO      TABL9999
.
TABL0860  MOVE      ZERO,ACTVONLY           * Display all Referrals
          MOVE      ZERO,LNKDRGHT
          MOVE      ONE,LINKSRCH
          CALL      ALRL0000                * Patient Referral List
          GOTO      TABL9999
.
TABL0870  WRITE     HTMLFILE;EXPRFLAG;      * Show expiry date red
          GOTO      TABL9999
.
TABL0880  WRITE     HTMLFILE;CHKVINAH;      * VINAH check exit
          GOTO      TABL9999
.
TABL0890  MATCH     VALDDATE,SP70                * End date
          GOTO      TABL9999 IF EQUAL
.
          UNPACK    VALDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TABL9999
.
TABL0900  MOVE      ZERO,F1                 * No attended OP bookings
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
TABL0901  CALL      RKALLNK1                * Linked OP visits
          BRANCH    OVRCD,TABL0902
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      TABL0902 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelledx
          GOTO      TABL0901 IF EQUAL
.
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,TABL0901
.
          MATCH     ALLNLNKV,DOBAOUTN
          GOTO      TABL0901 IF NOT EQUAL
.
          IF        OBASTAT = 4
            MOVE      ONE,F1                * Attended OP visit exists
          ENDIF
.
TABL0902  WRITE     HTMLFILE;F1;
          GOTO      TABL9999
.
TABL0910  CALL      DSCH0000
          GOTO      TABL9999
.
TABL9999  RETURN
+
.******************************************************************************
. Supervisor Referral function to change Master or Linked Referral(s)
.******************************************************************************
.
SUPD0000  MOVE      SP70,SAVEDATE
.
          MATCH     "1",ALREUYN4           * Check for Master
          GOTO      SUPD5000 IF EQUAL
.
          PACK      KEY16,ADMISSNO,SP70    * Otherwise Check Internal
          CALL      RSALRLN2
SUPD1000  CALL      RKALRLN2
          BRANCH    OVRCD,SUPD9000
.
          MATCH     ADMISSNO,ALRLLNKV      * Same internal referral
          GOTO      SUPD9000 IF NOT EQUAL
.
          PACK      KEY8,ALRLVISN,SP70
          CALL      RDALREF1                * Read master referral to get
          BRANCH    OVRCD,SUPD9000          * referral date
.
          MOVE      ALRERDAT,SAVEDATE       * Save referral date
.
          GOTO      SUPD9000
.
SUPD5000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
SUPD5500  CALL      RKALRLN1
          BRANCH    OVRCD,SUPD9000
.
          MATCH     ADMISSNO,ALRLVISN      * Same master referral
          GOTO      SUPD9000 IF NOT EQUAL
.
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1                * Read internal referral to get
          BRANCH    OVRCD,SUPD5500          * referral date
.
          MATCH     SP70,SAVEDATE
          IF        @EQUAL
            MOVE      ALRERDAT,SAVEDATE     * Save referral date
            GOTO      SUPD5500
          ENDIF
.
          MATCH     SAVEDATE,ALRERDAT       * Ref date less than save date
          IF        @LESS
            MOVE      ALRERDAT,SAVEDATE     * Save referral date
          ENDIF
.
          GOTO      SUPD5500
.
SUPD9000  WRITE     HTMLFILE;SAVEDATE;     * XXXXXXX
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1               * Restore original referral
.
SUPD9999  RETURN
+
.******************************************************************************
. Other Allied Health department details
.******************************************************************************
.
ALDEDT00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ALDEDT99
.
          BRANCH    F1,ALDEDT01,ALDEDT02,ALDEDT03,ALDEDT04,ALDEDT05:
                       ALDEDT06,ALDEDT07,ALDEDT08,ALDEDT09 
.
ALDEDT01  WRITE     HTMLFILE;ALDEUERF;      * Using External Referrals
          GOTO      ALDEDT99
.
ALDEDT02  WRITE     HTMLFILE;ALDEURAD;      * Using Residental Admission
          GOTO      ALDEDT99
.
ALDEDT03  WRITE     HTMLFILE;ALDEUASS;      * Using Assessments
          GOTO      ALDEDT99
.
ALDEDT04  WRITE     HTMLFILE;ALDEURAP;      * Using Request Appointments
          GOTO      ALDEDT99
.
ALDEDT05  WRITE     HTMLFILE;ALDEDLAS;      * Display Last 5 Contacts
          GOTO      ALDEDT99
.
ALDEDT06  WRITE     HTMLFILE;ALDEDCLI;      * Display Clinical Documentation
          GOTO      ALDEDT99
.
ALDEDT07  WRITE     HTMLFILE;ALDEDRAA;      * Display Referral Action Audit
          GOTO      ALDEDT99
.
ALDEDT08  WRITE     HTMLFILE;ALDEDLET;      * Display Letter History
          GOTO      ALDEDT99
.
ALDEDT09  CALL      ALDEDX00
          GOTO      ALDEDT99
.
ALDEDT99  RETURN
.
.******************************************************************************
. Other Allied Health department details
.******************************************************************************
.
ALDEDX00  UNPACK    DIM127,D1,KEY2,DIM127
          MOVE      ZERO,F2
          MOVE      KEY2,F2
          BRANCH    F2,ALDEDX01,ALDEDX02,ALDEDX03,ALDEDX04,ALDEDX05:
                       ALDEDX06,ALDEDX07
.
ALDEDX01  WRITE     HTMLFILE;ALDEUEME;      * Using Encounter Medications
          GOTO      ALDEDX99
.
ALDEDX02  WRITE     HTMLFILE;ALDEUEIN;      * Using Encounter Interventions
          GOTO      ALDEDX99
.
ALDEDX03  WRITE     HTMLFILE;ALDEUESU;      * Using Encounter Supplies
          GOTO      ALDEDX99
.
ALDEDX04  REP       " 0",ALDEUAHP
          WRITE     HTMLFILE;ALDEUAHP;      * Using Additional HCPs
          GOTO      ALDEDX99
.
ALDEDX05  WRITE     HTMLFILE;ALDESITE;      * OP Site
          GOTO      ALDEDX99
.
ALDEDX06  WRITE     HTMLFILE;ALDECTYP;      * OP Clinic Type
          GOTO      ALDEDX99
.
ALDEDX07  WRITE     HTMLFILE;ALDEDACP;     * Don't Display Copy Referral
          GOTO      ALDEDX99
.
ALDEDX99  RETURN
+
.******************************************************************************
. Extra Allied Health department details
.******************************************************************************
EXDEPT00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,EXDEPT99
.
          BRANCH    F1,EXDEPT01,EXDEPT02,EXDEPT03,EXDEPT04,EXDEPT05
          GOTO      EXDEPT99
.
EXDEPT01  WRITE     HTMLFILE;ALDESITE;      * OP Site
          GOTO      EXDEPT99
.
EXDEPT02  WRITE     HTMLFILE;ALDECTYP;      * OP Clinic Type
          GOTO      EXDEPT99
.
EXDEPT03  WRITE     HTMLFILE;ALDEUTRS;      * Using Triage Status (VINAH)
          GOTO      EXDEPT99
.
EXDEPT04  WRITE     HTMLFILE;ALDEUPRT;      * Using Priority (VINAH)
          GOTO      EXDEPT99
.
EXDEPT05  MOVE      "lF",CATEGORY           * Episode/Program stream
          MOVE      ALDEPRGS,CODE
          CALL      CODITM00
          GOTO      EXDEPT99
.
EXDEPT99  RETURN
+
.******************************************************************************
.
.******************************************************************************
.
LTHS0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY35,ADMISSNO,Z70      * Referral Audit Summary
          MOVE      ZERO,COUNT
          CALL      RSALLHI3                * positional read
LTHS0010  CALL      RPALLHI3                * read a record
          BRANCH    OVRCD,LTHS9999
.
          MATCH     ADMISSNO,ALLHREFN
          GOTO      LTHS9999 IF NOT EQUAL
.
          UNPACK    ALLHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      SP70,KEY11
          REP       " 0",CYEAR
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      LTHS0010
          ENDIF
.
          PACK      KEY6,ALLHLTNO,LTTITLE,SP70
          CALL      RDALLET1
          IF        OVRCD=1
            MOVE    "N/A",ALLTTEXT
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                      "<td>&nbsp;",ALLHUSER,"</td> ":
                      "<td>&nbsp;",KEY11," at ",ALLHTIME,"</td>":
                      "<td>&nbsp;",ALLTTEXT,"</td>":
                      "</tr>"
.
          ADD       ONE,DISNUMB
.
          COMPARE   NORECORD,DISNUMB
          GOTO      LTHS0010 IF NOT EQUAL
.
LTHS9999  RETURN
+
.******************************************************************************
.*        AUDC0000 - audit comment (all health ref close comment)
.******************************************************************************
.
AUDC0000  MOVE      "C ",KEY2
          PACK      KEY26,ADMISSNO,KEY2,Z70         * pack key
          CALL      RSALAUD2
          CALL      RPALAUD2
          BRANCH    OVRCD,AUDC9999
.
          MATCH     ADMISSNO,ALAUVISN
          GOTO      AUDC9999 IF NOT EQUAL
.
          MATCH     ALAUUPDT,KEY2                   * if this a close ref.?
          GOTO      AUDC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALAUCOMM;            * replace html tag with value
.
AUDC9999  RETURN
+
.******************************************************************************
.*        AUDJ0000 - audit comment (all health ref rejected comment)
.******************************************************************************
.
AUDJ0000  MOVE      "J ",KEY2
          PACK      KEY26,ADMISSNO,KEY2,Z70         * pack key
          CALL      RSALAUD2
          CALL      RPALAUD2
          BRANCH    OVRCD,AUDJ9999
.
          MATCH     ADMISSNO,ALAUVISN
          GOTO      AUDJ9999 IF NOT EQUAL
.
          MATCH     ALAUUPDT,KEY2                   * if this a close ref.?
          GOTO      AUDJ9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALAUCOMM;            * replace html tag with value
.
AUDJ9999  RETURN
+
.******************************************************************************
.*        AUDN0000 - audit comment (all health ref cancel comment)
.******************************************************************************
.
AUDN0000  MOVE      "N ",KEY2
          PACK      KEY26,ADMISSNO,KEY2,Z70         * pack key
          CALL      RSALAUD2
          CALL      RPALAUD2
          BRANCH    OVRCD,AUDN9999
.
          MATCH     ADMISSNO,ALAUVISN
          GOTO      AUDN9999 IF NOT EQUAL
.
          MATCH     ALAUUPDT,KEY2                   * if this a close ref.?
          GOTO      AUDN9999 IF NOT EQUAL

          WRITE     HTMLFILE;ALAUCOMM;            * replace html tag with value
.
AUDN9999  RETURN
+

.******************************************************************************
.         Add Patient Referral Details                                        .
.******************************************************************************
ADDR0000  BRANCH    FLDITMNO,ADDR0010,ADDR0020,ADDR0030,ADDR0040,ADDR0050:
                             ADDR0060,ADDR0070,ADDR0080,ADDR0090,ADDR0100:
                             ADDR0110,ADDR0120,ADDR0130,ADDR0140,ADDR0150:
                             ADDR0160,ADDR0170,ADDR0180,ADDR0190,ADDR0200:
                             ADDR0210,ADDR0220,ADDR0230,ADDR0240,ADDR0250:
                             ADDR0260,ADDR0270,ADDR0280,ADDR0290,ADDR0300:
                             ADDR0310,ADDR0320
          GOTO      ADDR9999
.
ADDR0010  CALL      ARGP0000                * Usual GP suburb
          GOTO      ADDR9999
.
ADDR0020  UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     SP70,PVIDATE
          GOTO      ADDR9999 IF EQUAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      ADDR9999
.
ADDR0030  WRITE     HTMLFILE;PTCNUEOC;      * Using episode of care
          GOTO      ADDR9999
.
ADDR0040  WRITE     HTMLFILE;URNUMBER;
          GOTO      ADDR9999
.
ADDR0050  WRITE     HTMLFILE;FOCUSFLG;
          GOTO      ADDR9999
.
ADDR0060  CALL      GDHCP000                * get default hcp provider number
          GOTO      ADDR9999
.
ADDR0070  WRITE     HTMLFILE;SACSVISN;      * Link to SAC referral visit number
          GOTO      ADDR9999
.
ADDR0080  PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,ADDR0085
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          GOTO      ADDR0085 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALRLVISN;      * linked to a SACS referral
          GOTO      ADDR9999
.
ADDR0085  WRITE     HTMLFILE;SP1;           * Not linked to a SACS referral
          GOTO      ADDR9999
.
ADDR0090  WRITE     HTMLFILE;DESREQIN;      * SACS Referral Required (Dep)
          GOTO      ADDR9999
.
ADDR0100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALDAD1
          IF        OVRCD=1
            PACK      ALDAFHOS,SP70
            PACK      ALDATHOS,SP70
          ENDIF
          BRANCH    F1,ADDR0105
.
          WRITE     HTMLFILE;ALDAFHOS;       * referred from hospital
          GOTO      ADDR9999
.
ADDR0105  PACK      KEY5,ALDAFHOS,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,ADDR9999
.
          WRITE     HTMLFILE;PTVADESC;
          GOTO      ADDR9999
. 
ADDR0110  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALDAD1
          IF        OVRCD=1
            PACK      ALDAFHOS,SP70
            PACK      ALDATHOS,SP70
          ENDIF
          BRANCH    F1,ADDR0115
.
          WRITE     HTMLFILE;ALDATHOS;       * referred to hospital
          GOTO      ADDR9999 
.
ADDR0115  PACK      KEY5,ALDATHOS,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,ADDR9999
.
          WRITE     HTMLFILE;PTVADESC;
          GOTO      ADDR9999
.
ADDR0120  WRITE     HTMLFILE;PRIMARYE;      * Department allow enc on primary 
          GOTO      ADDR9999
.
ADDR0130  CALL      DISSEL00
          GOTO      ADDR9999
.
ADDR0140  CALL      DISCOD00
          GOTO      ADDR9999
.
ADDR0150  CALL      DISDSC00
          GOTO      ADDR9999
.
ADDR0160  PACK      KEY16,ADMISSNO,SP70           * get Referral Link record
          CALL      RSALLNK1
          CALL      RKALLNK1
          BRANCH    OVRCD,ADDR0161                * no record with partial
.
          MATCH     ALLNVISN,ADMISSNO             * same admission number?
          GOTO      ADDR0161 IF NOT EQUAL         * no; output "0"
.
          WRITE     HTMLFILE;"1";
          GOTO      ADDR9999
.
ADDR0161  WRITE     HTMLFILE;"0";
          GOTO      ADDR9999
.
ADDR0170  PACK      KEY13,ADMISSNO,ZERO,FOUR,SP1,SP1,ONE,SP70
          CALL      RDALRHL1
          IF        OVRCD=ONE
            MOVE      SP70,ALRHCODE
          ENDIF
.
          MOVE      "zU",CATEGORY
          MOVE      ALRHCODE,CODE
          CALL      CODITM00
.
          GOTO      ADDR9999
.
ADDR0180  CALL      DEPI0000                * Add combined internal referral
          GOTO      ADDR9999                * department list
.
ADDR0190  MATCH     SP70,ALREDEPT
          GOTO      ADDR9999 IF EQUAL
          GOTO      ADDR9999 IF EOS
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDR9999
.
          MATCH     ANSP,TCINDC8
          GOTO      ADDR9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"1";
          GOTO      ADDR9999
.
ADDR0200  CALL      CMAS0000                * Close master referral warning 
          GOTO      ADDR9999           
.
ADDR0210  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      ADDR9999
.
ADDR0220  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY5,ALDAFHOS,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,ADDR9999
.
          BRANCH    F1,ADDR0225
.
          WRITE     HTMLFILE;ALDAFHOS;       * referred from hospital
          GOTO      ADDR9999
.
ADDR0225  WRITE     HTMLFILE;PTVADESC;
          GOTO      ADDR9999
.
ADDR0230  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      ALEID000                * Extra Inbound Data (ALLEIDTM)
          GOTO      ADDR9999
.
ADDR0240  CALL      VNOT0000                * Referral Booking Instructions
          GOTO      ADDR9999
.
ADDR0250  WRITE     HTMLFILE;ALCNLNKT;      * Link to Referral (Contextual URL)
          GOTO      ADDR9999
.
ADDR0260  MOVE      ONE,FRSTREAD
          PACK      KEY8,ALREDEPT,CATgb,SP70
          CALL      RSALCCT1
ADDR0261  CALL      RKALCCT1
          IF        OVRCD=1
            IF        FRSTREAD=1
              GOTO      ADDR0262
            ELSE
              GOTO      ADDR9999
            ENDIF
          ENDIF
.
          MATCH     ALREDEPT,ALCCDEPT
          IF        !@EQUAL
            IF        FRSTREAD=1
              GOTO      ADDR0262
            ELSE
              GOTO      ADDR9999
            ENDIF
          ENDIF
.
          MATCH     CATgb,ALCCTYPE
          GOTO      ADDR0262 IF NOT EQUAL
.
          PACK      KEY5,CATgb,ALCCCONT
          CALL      RDCODE1
.
          MATCH     ALRECONT,ALCCCONT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value='",ALCCCONT,"'>",TDESC,"</option>";
          ELSE
            MATCH     "A",PTCOACTV
            GOTO      ADDR0261 IF NOT EQUAL 
            WRITE     HTMLFILE;"<option value='",ALCCCONT,"'>",TDESC,"</option>";
          ENDIF     
.          
          MOVE      ZERO,FRSTREAD
          GOTO      ADDR0261
.
ADDR0262  MOVE      CATgb,CATEGORY
          CALL      CODSEL00
          GOTO      ADDR9999
.
ADDR0270  PACK      KEY8,ALREVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ADDR9999
.
          WRITE     HTMLFILE;ALRECONT;
          GOTO      ADDR9999
.
ADDR0280  WRITE     HTMLFILE;INTRVISN;      * Link to internal referral visit
          GOTO      ADDR9999                * number 
.
ADDR0290  PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1
          BRANCH    OVRCD,ADDR9999
.
          WRITE     HTMLFILE;OSTCATG;
          GOTO      ADDR9999
.
ADDR0300  WRITE     HTMLFILE;CLINDATE;
          GOTO      ADDR9999
.
ADDR0310  CALL      AVNT0000                * All Referral Booking Instructions
          GOTO      ADDR9999
.
ADDR0320  PACK      KEY17,ADMISSNO,SP70
          CALL      RSALSTS1
ADDR0325  CALL      RKALSTS1
          BRANCH    OVRCD,ADDR9999
.
          MATCH     ADMISSNO,ALSTVISN     * same admission number?
          GOTO      ADDR9999 IF NOT EQUAL
.
          MATCH     "1",ALSTSTAT          * active ?
          IF        !@EQUAL
            MATCH     "3",ALSTSTAT        * inactive ?
            GOTO      ADDR0325 IF NOT EQUAL
          ENDIF
.
ADDR0328  WRITE     HTMLFILE;ONE;         * is active/ have been active
          GOTO      ADDR9999
.
ADDR9999  RETURN
+
.------------------------------------------------------------------------------
. Output visit based notes 
.------------------------------------------------------------------------------
VNOT0000  CLEAR     VAR
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VNOT0910  CALL      RKVSMTX1
          BRANCH    OVRCD,VNOT9999
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VNOT9999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VNOT0910 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VNOT0910 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      VNOT0910
.
VNOT9999  RETURN
+
.------------------------------------------------------------------------------
. Output all referal booking instruction comments.
.------------------------------------------------------------------------------
AVNT0000  PACK      KEY17,ADMISSNO,ZERO,ZERO,FIVE,Z70
          CALL      RSVSMDT1
AVNT1000  CALL      RPVSMDT1                * Read last notes header
          BRANCH    OVRCD,AVNT9000
.
          MATCH     ADMISSNO,VSMDVISN       * Correct Visit
          GOTO      AVNT9000 IF NOT EQUAL
.
          MATCH     "005",VSMDTYPE          * Booking instructions
          GOTO      AVNT9000 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT            * Skip if deleted
          GOTO      AVNT1000 IF EQUAL
.
          MOVE      SP70,TEMPDATE
          MATCH     SP70,VSMDDATE
          IF        !@EQUAL
            UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      TEMPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     VISNOTES
          APPEND    TEMPDATE,VISNOTES
          APPEND    "  ",VISNOTES
          APPEND    VSMDTIME,VISNOTES
          APPEND    "  ",VISNOTES
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD<>1
            APPEND    WBSENAM,VISNOTES
          ELSE
            APPEND    VSMDUSER,VISNOTES
          ENDIF
          APPEND    "  ",VISNOTES
          MOVE      "w0",KEY2
          PACK      KEY5,KEY2,VSMDOCCG,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            APPEND    TDESC,VISNOTES
          ELSE
            APPEND    VSMDOCCG,VISNOTES
          ENDIF
          RESET     VISNOTES
.
          STRIP     VISNOTES
          MOVELPTR  VISNOTES,LENGTH
.
          SFORMAT   VAR,LENGTH
          MOVE      VISNOTES,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
AVNT2000  CALL      RKVSMTX1
          BRANCH    OVRCD,AVNT1000
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      AVNT1000 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      AVNT1000 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      AVNT1000 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      AVNT2000
.
AVNT9000  PACK      KEY10,USERID,SP70       * Restore logged in user
          CALL      RDWBSE1

AVNT9999  RETURN
+
.------------------------------------------------------------
.         Get default (from PMI) hcp practice provider number
.------------------------------------------------------------
GDHCP000  MATCH     SP70,PMPXRH1G
          GOTO      GDHCP500 IF EQUAL
.
          PACK      KEY20,PMPXRHC1,PMPXRH1G,SP70
          CALL      RDPMHCL1                * get hcp/hcg link provider number
          BRANCH    OVRCD,GDHCP500
.
          WRITE     HTMLFILE;PMHLPRV1;
          GOTO      GDHCP999
.
GDHCP500  MATCH     SP70,PMPXRHC1
          GOTO      GDHCP999 IF EQUAL
.
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1                * get hcp provider number
          BRANCH    OVRCD,GDHCP999
.
          WRITE     HTMLFILE;PMHCPRV1;
.
GDHCP999  RETURN
+
.******************************************************************************
ANPL0000  CALL      NEXT0000
          GOTO      ANPL9999
.
ANPL9999  RETURN
.
APPL0000  CALL      PREV0000
          GOTO      APPL9999
.
APPL9999  RETURN
.
ACSD0000  CALL      CURSTD00
          GOTO      ACSD9999
.
ACSD9999  RETURN
.
ACED0000  CALL      CUREND00
          GOTO      ACED9999
.
ACED9999  RETURN
.
ACCY0000  CALL      CURYR000
          GOTO      ACCY9999
.
ACCY9999  RETURN
.
ACCM0000  CALL      CURMON00
          GOTO      ACCM9999
.
ACCM9999  RETURN
.
ASPO0000  CALL      SELV0000
          GOTO      ASPO9999
.
ASPO9999  RETURN
.
AVVT0000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      AVVT9999
.
AVVT9999  RETURN
.
ADPF0000  MATCH     SP70,DEPTCODE           * Department Filter
          GOTO      ADPFLT10  IF NOT  EQUAL
          MOVE      "CG",CATEGORY
          MOVE      ALRERDEP,CODE
          CALL      CODITM00
          GOTO      ADPF9999
ADPFLT10  MOVE      "CG",CATEGORY
          MOVE      DEPTCODE,CODE
          CALL      CODITM00
.
ADPF9999  RETURN
.
APPF0000  MATCH     SP70,PRIORITY           * Priority Filter
          GOTO      APPFLT10  IF NOT EQUAL
          MOVE      "PR",CATEGORY
          MOVE      PRIORITY,CODE
          CALL      CODITM00
          GOTO      APPF9999
APPFLT10  MOVE      "PR",CATEGORY
          MOVE      PRIORITY,CODE
          CALL      CODITM00
.
APPF9999  RETURN
.
AHCP0000  MATCH     SP70,HCPCLASF           * HCP Filter     
          GOTO      AHCP0010  IF NOT EQUAL
          MOVE      "DL",CATEGORY
          MOVE      HCPCLASF,CODE  
          CALL      CODITM00
          GOTO      AHCP9999
AHCP0010  MOVE      "DL",CATEGORY
          MOVE      HCPCLASF,CODE  
          CALL      CODITM00
.
AHCP9999  RETURN
.
ARRF0000  MATCH     SP70,IAREASON
          GOTO      ARRFTR10 IF NOT EQUAL
          MOVE      "LI",CATEGORY
          MOVE      IAREASON,CODE
          CALL      CODITM00
          GOTO      ARRF9999
ARRFTR10  MOVE      "LI",CATEGORY
          MOVE      IAREASON,CODE
          CALL      CODITM00
.
ARRF9999  RETURN
.-------------------------------------------------------------------
.     writing here for allied health department drop down
.-------------------------------------------------------------------
ARFD0000  PACK      KEY10,USERID,SP70       * Read security id to get hospital
          CALL      RDWBSE1
          BRANCH    OVRCD,ARFD9999
.
          PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
ARFD0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,ARFD9999
.
          MATCH     "CG",TCODE
          GOTO      ARFD9999 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      ARFD0100 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,ARFD0100
.
          MATCH     "1",ALDEACTV
          GOTO      ARFD0100 IF EQUAL       * Skip Inactive
.
          MATCH     DEPTCODE,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     SP70,ALDEHOSP
              IF        !@EQUAL
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  IF        OVRCD=1
                    MATCH     WBSEHOSP,ALDEHOSP
                    GOTO      ARFD0100 IF NOT EQUAL
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ENDIF                             * HPS CODE Added (KSK)
          GOTO      ARFD0100
.
ARFD9999  RETURN
.-------------------------------------------------------------------
.     writing here for allied health department drop down
.-------------------------------------------------------------------
DEPD0000  PACK      PTCDKEY2,ANSC,ANSG,SP70 
          CALL      RDSCODE2                      * positional read
DEPD0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPD9999
.
          MATCH     "CG",TCODE
          GOTO      DEPD9999 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      DEPD0100 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPD0100
.
          MATCH     "1",ALDEACTV
          GOTO      DEPD0100 IF EQUAL       * Skip Inactive
.
          MATCH     "0",ALDESECU
          GOTO      DEPD0100 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ENDIF
          GOTO      DEPD0100
.
DEPD9999  RETURN
.-------------------------------------------------------------------
.   Waiting Referral Tables %ALLWEB02.01.013
.-------------------------------------------------------------------
AWRT0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY22,DEPTCODE,ZERO,SP70
          CALL      RSALREF4                * positional read
AWRT0010  CALL      RKALREF4                * read a record forward
          BRANCH    OVRCD,AWRT9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT
          GOTO      AWRT9999 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT
          GOTO      AWRT9999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN        * Hospital Filter matched?
            GOTO      AWRT0010 IF NOT EQUAL    * No, read next referral
            GOTO      AWRT0030                 * Yes,check pref site *C-0306959
          ENDIF
.
.         ----------------------------------------------------------------------
.         C-0306959
.         If no hospital filter (All hospital) and override hospital filter used
.         then only list referrals from the hospitals that the user has access
.         to as setup in the mlsecaf table for the user security id
.
          COMPARE   ONE,IBCNMHOS               * Multi Hospital?
          GOTO      AWRT0030 IF NOT EQUAL      * No, check pref site filter
.
          MATCH     "1",OVRDHOSP               * Override hosp filter used?
          GOTO      AWRT0030 IF NOT EQUAL      * No, check pref site filter
.
          PACK      KEY13,USERID,SP70          * User has All hosp access?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AWRT0025             * No, check referral hosp access
          GOTO      AWRT0030                   * Yes, check pref site filter
.
AWRT0025  PACK      KEY13,USERID,ALREHOSN,SP70 * User has access to ref hosp?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AWRT0010             * No, read next referral
          GOTO      AWRT0030                   * Yes, check pref site filter
.
.         ----------------------------------------------------------------------
.
AWRT0030  MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      AWRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTRGS
          IF        !@EQUAL
            MATCH     FILTTRGS,ALRETRGS               * Triage Status Filter
            GOTO      AWRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      AWRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      AWRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      AWRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      AWRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      AWRT0035 IF EQUAL
              GOTO      AWRT0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      AWRT0010 IF NOT EQUAL * HCP does not match don't disp
            ENDIF
          ENDIF
.
AWRT0035  MATCH     SP70,FILTTEAM
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      AWRT0010 IF NOT EQUAL * Team does not match don't disp
          ENDIF
.
          MATCH     SP70,PRIORITY
          IF        !@EQUAL
            MATCH     PRIORITY,ALREPRTY
            GOTO      AWRT0010 IF NOT EQUAL * priority does not match don't disp
          ENDIF
.
P
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      AWRT0010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      AWRT0010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.0937495 s
          MATCH     SP70,DISPCTDL
          IF        !@EQUAL
            MATCH     SP70,HCPCLASF
            IF        !@EQUAL
              PACK      KEY10,ALREHCP,SP70      * Health Care Professional
              CALL      RDPMHCP1
              IF        OVRCD=0
                MATCH     HCPCLASF,PMHCOSLV
                GOTO      AWRT0010 IF NOT EQUAL * hcp class does not match 
              ENDIF
            ENDIF
          ENDIF
.0937495 e
.
AWRT0040
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      AWRT0010
          ENDIF
.
          MATCH     "0",ALRESTAT            * Don't disp if status is not "0"
          GOTO      AWRT0010 IF NOT EQUAL
.
          CALL      WRTHTM00                * Display Row
.
          MATCH     "1",SORTFLAG
          IF        !@EQUAL 
            ADD       ONE,DISNUMB
            COMPARE   NORECORD,DISNUMB
            GOTO      AWRT0010 IF NOT EQUAL
          ELSE
            GOTO      AWRT0010
          ENDIF
.
AWRT9999  RETURN
.-------------------------------------------------------------------
.   Waiting Referral table By HCP
.-------------------------------------------------------------------
AWRTD000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY27,DOCTCODE,ZERO,SP70
          CALL      RSALREF5                * positional read
AWRTD010  CALL      RKALREF5                * read a record forward
          BRANCH    OVRCD,AWRTD999
.
          CALL      INDHCP00
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      AWRTD015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      AWRTD015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      AWRTD015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      AWRTD015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      AWRTD015 IF EQUAL
            GOTO      AWRTD999
          ELSE 
            MATCH     DOCTCODE,ALREHCP
            GOTO      AWRTD999 IF NOT EQUAL
          ENDIF
.
AWRTD015  MATCH     "0",ALRESTAT
          GOTO      AWRTD999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN        * Hospital Filter matched?
            GOTO      AWRTD010 IF NOT EQUAL    * No, read next referral
            GOTO      AWRTD030                 * Yes,check pref site *C-0306959
          ENDIF
.
.         ----------------------------------------------------------------------
.         C-0306959
.         If no hospital filter (All hospital) and override hospital filter used
.         then only list referrals from the hospitals that the user has access
.         to as setup in the mlsecaf table for the user security id
.
          COMPARE   ONE,IBCNMHOS               * Multi Hospital?
          GOTO      AWRTD030 IF NOT EQUAL      * No, check pref site filter
.
          MATCH     "1",OVRDHOSP               * Override hosp filter used?
          GOTO      AWRTD030 IF NOT EQUAL      * No, check pref site filter
.
          PACK      KEY13,USERID,SP70          * User has All hosp access?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AWRTD025             * No, check referral hosp access
          GOTO      AWRTD030                   * Yes, check pref site filter
.
AWRTD025  PACK      KEY13,USERID,ALREHOSN,SP70 * User has access to ref hosp?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AWRTD010              * No, read next referral
          GOTO      AWRTD030                    * Yes, check pref site filter
.
.         ----------------------------------------------------------------------
.
AWRTD030  MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      AWRTD010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTRGS
          IF        !@EQUAL
            MATCH     FILTTRGS,ALRETRGS               * Triage Status Filter
            GOTO      AWRTD010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALREDEPT
            GOTO      AWRTD010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTEAM
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      AWRTD010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PRIORITY
          IF        !@EQUAL
            MATCH     PRIORITY,ALREPRTY
            GOTO      AWRTD010 IF NOT EQUAL * priority does not match don't disp
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      AWRTD010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      AWRTD010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF

.0937495 s
          MATCH     SP70,DISPCTDL
          IF        !@EQUAL
            MATCH     SP70,HCPCLASF
            IF        @EQUAL                    
              GOTO      AWRTD040 IF EQUAL       * hcp class blank ALL
            ENDIF  
            IF        !@EQUAL
              MATCH     HCPCLASF,PMHCOSLV
              GOTO      AWRTD010 IF NOT EQUAL * hcp class does not match 
            ENDIF
          ENDIF
.0937495 e
.
AWRTD040  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      AWRTD010
          ENDIF
.
          CALL      WRTHTM00                * Display Row
.
          MATCH     "1",SORTFLAG
          IF        !@EQUAL
            ADD       ONE,DISNUMB
            COMPARE   NORECORD,DISNUMB
            GOTO      AWRTD010 IF NOT EQUAL
          ELSE
            GOTO      AWRTD010
          ENDIF
.
AWRTD999  RETURN
.
.-------------------------------------------------------------------
.   Active Referral Tables %ALLWEB02.01.014
.-------------------------------------------------------------------
AART0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY30,DEPTCODE,ONE,FRSTDATE,SP70
          CALL      RSALREF6                * positional read
AART0010  CALL      RKALREF6                * read a record forward
          BRANCH    OVRCD,AART9999
. 
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT       * Check correct department
          GOTO      AART9999 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT            * Don't disp if status is not "1"
          GOTO      AART9999 IF NOT EQUAL
.
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral   
          GOTO      AART9999 IF LESS
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN          * Hospital Filter matched?
            GOTO      AART0010 IF NOT EQUAL      * No, read next referral
            GOTO      AART0014                   * Yes,check pref site
          ENDIF
.
.         If no hospital filter (All hospital) and override hospital filter used
.         then only list referrals from the hospitals that the user has access
.         to as setup in the mltsecaf table for the user security id
.
          COMPARE   ONE,IBCNMHOS               * Multi Hospital?
          GOTO      AART0014 IF NOT EQUAL      * No, check pref site filter
.
          MATCH     "1",OVRDHOSP               * Override hosp filter used?
          GOTO      AART0014 IF NOT EQUAL      * No, check pref site filter
.
          PACK      KEY13,USERID,SP70          * User has All hosp access?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AART0013             * No, check referral hosp access
          GOTO      AART0014                   * Yes, check pref site filter
.
AART0013  PACK      KEY13,USERID,ALREHOSN,SP70 * User has access to ref hosp?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AART0010             * No, read next referral
          GOTO      AART0014                   * Yes, check pref site filter
.
AART0014  MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      AART0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE           * Check correct HCP
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      AART0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      AART0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      AART0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      AART0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      AART0015 IF EQUAL
              GOTO      AART0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      AART0010 IF NOT EQUAL
            ENDIF
          ENDIF
.
AART0015  MATCH     SP70,FILTTEAM           * Check correct team
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      AART0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      AART0010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      AART0010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      AART0010
          ENDIF
.
          CALL      ACTDIS00                * Display Row
.
          ADD       ONE,DISNUMB
AART0020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      AART0010 IF NOT EQUAL
          ELSE
            GOTO      AART0010
          ENDIF 
.
AART9999  RETURN
.
.-------------------------------------------------------------------
.   Active Referral table By HCP
.-------------------------------------------------------------------
AARTH000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY27,DOCTCODE,ONE,SP70
          CALL      RSALREF5                * positional read
AARTH010  CALL      RKALREF5                * read a record forward
          BRANCH    OVRCD,AARTH999
.
          CALL      INDHCP00
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      AARTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      AARTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      AARTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      AARTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      AARTH015 IF EQUAL
            GOTO      AARTH999
          ELSE
            MATCH     DOCTCODE,ALREHCP
            GOTO      AARTH999 IF NOT EQUAL
          ENDIF
.
AARTH015  MATCH     "1",ALRESTAT            * Don't disp if status is not "1"
          GOTO      AARTH999 IF NOT EQUAL
.
          MATCH     FRSTDATE,ALRERDAT       * Checks firstdate with referral   
          GOTO      AARTH010 IF LESS
.
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral  
          GOTO      AARTH010 IF LESS
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN          * Hospital Filter matched?
            GOTO      AARTH010 IF NOT EQUAL      * No, read next referral
            GOTO      AARTH017                   * Yes,check pref site
          ENDIF
.
.         If no hospital filter (All hospital) and override hospital filter used
.         then only list referrals from the hospitals that the user has access
.         to as setup in the mltsecaf table for the user security id
.
          COMPARE   ONE,IBCNMHOS               * Multi Hospital?
          GOTO      AARTH017 IF NOT EQUAL      * No, check pref site filter
.
          MATCH     "1",OVRDHOSP               * Override hosp filter used?
          GOTO      AARTH017 IF NOT EQUAL      * No, check pref site filter
.
          PACK      KEY13,USERID,SP70          * User has All hosp access?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AARTH016             * No, check referral hosp access
          GOTO      AARTH017                   * Yes, check pref site filter
.
AARTH016  PACK      KEY13,USERID,ALREHOSN,SP70 * User has access to ref hosp?
          CALL      RDMLSEC1
          BRANCH    OVRCD,AARTH010             * No, read next referral
          GOTO      AARTH017                   * Yes, check pref site filter
.
AARTH017  MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      AARTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALREDEPT
            GOTO      AARTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTEAM
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      AARTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      AARTH010 IF NOT EQUAL      * clinic type does not match
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      AARTH010 IF NOT EQUAL    * clinic id does not match
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      AARTH010
          ENDIF
.
          CALL      ACTDIS00                * Display Row
          ADD       ONE,DISNUMB
AARTH020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      AARTH010 IF NOT EQUAL
          ELSE
            GOTO      AARTH010
          ENDIF
.
AARTH999  RETURN
.
.-------------------------------------------------------------------
.   All Referrals Tables %ALLWEB02.01.034
.-------------------------------------------------------------------
ALRT0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
          MOVE      ZERO,STATLOOP
          GOTO      ALRT0005
.
ALRT0004  ADD       ONE,STATLOOP
          COMPARE   STATLOOP,SIX
          GOTO      ALRT9999 IF LESS
.
ALRT0005  MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            PACK      KEY17,FILTSTAT,FRSTDATE,SP70
          ELSE
            PACK      KEY17,STATLOOP,FRSTDATE,SP70    * Pack key for next status
          ENDIF
.
          CALL      RSALREF3                * positional read
ALRT0010  CALL      RKALREF3                * read a record forward
          IF        OVRCD=1
            MATCH     SP70,FILTSTAT         * Exit not more records
            GOTO      ALRT9999 IF NOT EQUAL
.
            GOTO      ALRT0004              * Check next status for records
          ENDIF
.
          CALL      INDHCP00
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALRESTAT     * Status edit
            GOTO      ALRT9999 IF NOT EQUAL
.
            MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral
            GOTO      ALRT9999 IF LESS
          ELSE
            MOVE      STATLOOP,DIM1
            MATCH     DIM1,ALRESTAT           * Status edit
            GOTO      ALRT0004 IF NOT EQUAL
.
            MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral
            GOTO      ALRT0004 IF LESS
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      ALRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      ALRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALREDEPT       * Check correct department
            GOTO      ALRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE           * Check correct HCP
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      ALRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      ALRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      ALRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      ALRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      ALRT0015 IF EQUAL
              GOTO      ALRT0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      ALRT0010 IF NOT EQUAL
            ENDIF 
          ENDIF
.
ALRT0015  MATCH     SP70,FILTTEAM           * Check correct team
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      ALRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      ALRT0010 IF NOT EQUAL * clinic type does not match
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      ALRT0010 IF NOT EQUAL * clinic id does not match
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALRT0010
          ENDIF
.
          CALL      ALRDIS00                * Display Row
.
          ADD       ONE,DISNUMB
ALRT0020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      ALRT0010 IF NOT EQUAL
          ELSE
            GOTO      ALRT0010
          ENDIF
.
ALRT9999  RETURN
.
.
.******************************************************************************
.           Write all Referral
.******************************************************************************
ALRDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      SP70,TRNSFHOS
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALDAD1
          BRANCH    OVRCD,ALRDIS05
.
          PACK      KEY5,ALDAFHOS,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            MOVE      ALDAFHOS,PTVADESC
          ENDIF
.
          MOVE      PTVADESC,TRNSFHOS
.
ALRDIS05  MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      SP70,UC34DESC
          MATCH     SP70,ALREUC34
          IF        !@EQUAL
            PACK      KEY5,CATLH,ALREUC34,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,UC34DESC
            ENDIF
          ENDIF
.
          MOVE      SP70,CATLADES
          MATCH     SP70,ALREUC01
          IF        !@EQUAL
            MOVE      "la",CATEGORY
            MOVE      ALREUC01,CODE
            CALL      GETCOD00
            MOVE      TDESC,CATLADES
          ENDIF
.
          MOVE      SP70,CATLBDES
          MATCH     SP70,ALREUC02
          IF        !@EQUAL
            MOVE      "lb",CATEGORY
            MOVE      ALREUC02,CODE
            CALL      GETCOD00
            MOVE      TDESC,CATLBDES
          ENDIF
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE    SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,REFTDESC
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC     * SACS referral
          ENDIF
.
          MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
          MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,ALRDIS10,ALRDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCS00
.              WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
            ELSE
              WRITE     HTMLFILE;"#"",DOCFNAME,"#",";              8
            ENDIF
.
            WRITE     HTMLFILE;"#"",ALREPRTY,"#",":                9
                             "#"",ALRECOMP,"#",":                  10
                             "#"",ALREUNIT,"#",":                  11
                             "#"",ALRERTYP,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",ALSTDESC,"#",":                  18
                             "#"",ALREUFR1,"#",":                  19
                             "#"",ALREUFR2,"#",":                  20
                             "#"",ALREUDT1,"#",":                  21
                             "#"",ALREUDT2,"#",":                  22
                             "#"",ALREUC01,"#",":                  23
                             "#"",ALREUC02,"#",":                  24
                             "#"",CATLADES,"#",":                  25
                             "#"",CATLBDES,"#",":                  26
                             "#"",PFUNDH,"#",":                    27
                             "#"",TRNSFHOS,"#",":                  28
                             "#"",FOLDERSF,"#",":                 *29
                             "#"",ALREUFR1,"#",":                 *30 
                             "#"",ALREPRCM,"#"":                  *31
                             ");"
          ENDIF
          GOTO      ALRDIS99
.
ALRDIS10  PACK      KEY10,USERID,SP70       * If Department Security is 1
          CALL      RDWBSE1
          BRANCH    OVRCD,ALRDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.               WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            8
              ENDIF
.
              WRITE     HTMLFILE;"#"",ALREPRTY,"#",":              9
                             "#"",ALRECOMP,"#",":                  10
                             "#"",ALREUNIT,"#",":                  11
                             "#"",ALRERTYP,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",ALSTDESC,"#",":                  18
                             "#"",ALREUFR1,"#",":                  19
                             "#"",ALREUFR2,"#",":                  20
                             "#"",ALREUDT1,"#",":                  21
                             "#"",ALREUDT2,"#",":                  22
                             "#"",ALREUC01,"#",":                  23
                             "#"",CATLADES,"#",":                  25
                             "#"",CATLBDES,"#",":                  26
                             "#"",PFUNDH,"#",":                    27
                             "#"",TRNSFHOS,"#",":                  28
                             "#"",FOLDERSF,"#",":                 *29
                             "#"",ALREUFR1,"#",":                 *30 
                             "#"",ALREPRCM,"#"":                  *31
                             ");"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon >":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
             WRITE     HTMLFILE;"</tr>"
          ENDIF
          GOTO      ALRDIS99
.
ALRDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,ALRDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.               WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.               WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            8
              ENDIF
.
              WRITE     HTMLFILE;"#"",ALREPRTY,"#",":              9
                             "#"",ALRECOMP,"#",":                  10
                             "#"",ALREUNIT,"#",":                  11
                             "#"",ALRERTYP,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",ALSTDESC,"#",":                  18
                             "#"",ALREUFR1,"#",":                  19
                             "#"",ALREUFR2,"#",":                  20
                             "#"",ALREUDT1,"#",":                  21
                             "#"",ALREUDT2,"#",":                  22
                             "#"",ALREUC01,"#",":                  23
                             "#"",CATLADES,"#",":                  25
                             "#"",CATLBDES,"#",":                  26
                             "#"",PFUNDH,"#",":                    27
                             "#"",TRNSFHOS,"#",":                  28
                             "#"",FOLDERSF,"#",":                 *29
                             "#"",ALREUFR1,"#",":                 *30 
                             "#"",ALREPRCM,"#"":                  *31
                             ");"
            ENDIF
          ENDIF
.
ALRDIS99  RETURN
.
.-------------------------------------------------------------------
.   All Active Referral Tables %ALLWEB02.01.024 
.-------------------------------------------------------------------
ALAC0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          MATCH     SP70,REFSTATS
          IF        @EQUAL
            PACK      REFSTATS,ONE,SP70
          ENDIF
          IF        GPACCESS=1
            PACK      KEY22,DEPTCODE,REFSTATS,SP70
          ELSE
            PACK      KEY22,DEPTCODE,ONE,SP70
          ENDIF
          CALL      RSALREF4                * positional read
ALAC0010  CALL      RKALREF4                * read a record forward
          BRANCH    OVRCD,ALAC9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT
          GOTO      ALAC9999 IF NOT EQUAL
.
          IF        GPACCESS=1
            MATCH     REFSTATS,ALRESTAT
            GOTO      ALAC9999 IF NOT EQUAL
          ELSE
            MATCH     "1",ALRESTAT            * Don't disp if status is not "0"
            GOTO      ALAC9999 IF NOT EQUAL
          ENDIF
.
          IF        GPACCESS=1
            PACK      KEY8,ALREURNO,SP70
            CALL      RDPMPX21
            BRANCH    OVRCD,ALAC0010
            MOVE      ZERO,EXIT
            CALL      CHGP0000
            BRANCH    EXIT,ALAC0010
            PACK      KEY8,ALREVISN,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,ALAC0010
            MATCH     "1",PMVXINGP
            GOTO      ALAC0010 IF NOT EQUAL 
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN          * Hospital Filter matched?
            GOTO      ALAC0010 IF NOT EQUAL      * No, read next referral
            GOTO      ALAC0014                   * Yes,check pref site
          ENDIF
.
.         If no hospital filter (All hospital) and override hospital filter used
.         then only list referrals from the hospitals that the user has access
.         to as setup in the mltsecaf table for the user security id
.
          COMPARE   ONE,IBCNMHOS               * Multi Hospital?
          GOTO      ALAC0014 IF NOT EQUAL      * No, check pref site filter
.
          MATCH     "1",OVRDHOSP               * Override hosp filter used?
          GOTO      ALAC0014 IF NOT EQUAL      * No, check pref site filter
.
          PACK      KEY13,USERID,SP70          * User has All hosp access?
          CALL      RDMLSEC1
          BRANCH    OVRCD,ALAC0013             * No, check referral hosp access
          GOTO      ALAC0014                   * Yes, check pref site filter
.
ALAC0013  PACK      KEY13,USERID,ALREHOSN,SP70 * User has access to ref hosp?
          CALL      RDMLSEC1
          BRANCH    OVRCD,ALAC0010             * No, read next referral
          GOTO      ALAC0014                   * Yes, check pref site filter
.
ALAC0014  MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      ALAC0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      ALAC0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      ALAC0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      ALAC0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      ALAC0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      ALAC0015 IF EQUAL
              GOTO      ALAC0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      ALAC0010 IF NOT EQUAL
            ENDIF
          ENDIF
.
ALAC0015  MATCH     SP70,FILTTEAM
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      ALAC0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      ALAC0010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      ALAC0010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALAC0010
          ENDIF
.
          CALL      ACTDIS00                * Display Row
.
          ADD       ONE,DISNUMB
ALAC0020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      ALAC0010 IF NOT EQUAL
          ELSE
            GOTO      ALAC0010
          ENDIF
.
ALAC9999  RETURN
.
.-------------------------------------------------------------------
.   All Active Referrals table by HCP
.-------------------------------------------------------------------
ALACH000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          MATCH     SP70,REFSTATS
          IF        @EQUAL
            PACK      REFSTATS,ONE,SP70
          ENDIF
.
          IF        GPACCESS=1
            PACK      KEY27,DOCTCODE,REFSTATS,SP70
          ELSE
            PACK      KEY27,DOCTCODE,ONE,SP70
          ENDIF
.
          CALL      RSALREF5                * positional read
ALACH010  CALL      RKALREF5                * read a record forward
          BRANCH    OVRCD,ALACH999
.
          CALL      INDHCP00
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      ALACH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      ALACH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      ALACH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      ALACH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      ALACH015 IF EQUAL
            GOTO      ALACH999
          ELSE
            MATCH     DOCTCODE,ALREHCP
            GOTO      ALACH999 IF NOT EQUAL
          ENDIF
.
ALACH015  IF        GPACCESS=1
            MATCH     REFSTATS,ALRESTAT
            GOTO      ALACH999 IF NOT EQUAL
          ELSE
            MATCH     "1",ALRESTAT            * Don't disp if status is not "1"
            GOTO      ALACH999 IF NOT EQUAL
          ENDIF
.
          IF        GPACCESS=1
            PACK      KEY8,ALREURNO,SP70
            CALL      RDPMPX21
            BRANCH    OVRCD,ALACH010
            MOVE      ZERO,EXIT
            CALL      CHGP0000
            BRANCH    EXIT,ALACH010
            PACK      KEY8,ALREVISN,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,ALACH010
            MATCH     "1",PMVXINGP
            GOTO      ALACH010 IF NOT EQUAL 
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN          * Hospital Filter matched?
            GOTO      ALACH010 IF NOT EQUAL      * No, read next referral
            GOTO      ALACH020                   * Yes,check pref site
          ENDIF
.
.         If no hospital filter (All hospital) and override hospital filter used
.         then only list referrals from the hospitals that the user has access
.         to as setup in the mltsecaf table for the user security id
.
          COMPARE   ONE,IBCNMHOS               * Multi Hospital?
          GOTO      ALACH020 IF NOT EQUAL      * No, check pref site filter
.
          MATCH     "1",OVRDHOSP               * Override hosp filter used?
          GOTO      ALACH020 IF NOT EQUAL      * No, check pref site filter
.
          PACK      KEY13,USERID,SP70          * User has All hosp access?
          CALL      RDMLSEC1
          BRANCH    OVRCD,ALACH019             * No, check referral hosp access
          GOTO      ALACH020                   * Yes, check pref site filter
.
ALACH019  PACK      KEY13,USERID,ALREHOSN,SP70 * User has access to ref hosp?
          CALL      RDMLSEC1
          BRANCH    OVRCD,ALACH010             * No, read next referral
          GOTO      ALACH020                   * Yes, check pref site filter
.
ALACH020  MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      ALACH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALREDEPT
            GOTO      ALACH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTEAM
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      ALACH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      ALACH010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      ALACH010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALACH010
          ENDIF
.
          CALL      ACTDIS00                * Display Row
.
          ADD       ONE,DISNUMB
          MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      ALACH010 IF NOT EQUAL
          ELSE
            GOTO      ALACH010
          ENDIF
.
ALACH999  RETURN
.
.-------------------------------------------------------------------
.   SACS Referral List
.-------------------------------------------------------------------
SRFL0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          MATCH     SP70,DEPTCODE
          GOTO      SRFL9999 IF EQUAL
.          
          MATCH     SP70,STATCODE
          GOTO      SRFL9999 IF EQUAL
.
          PACK      KEY30,DEPTCODE,STATCODE,SP70
          CALL      RSALREF7                * positional read
SRFL0010  CALL      RKALREF7                * read a record forward
          BRANCH    OVRCD,SRFL0095
.
          MATCH     DEPTCODE,ALREDEPT       * only want selected department
          GOTO      SRFL0095 IF NOT EQUAL
.
          MATCH     STATCODE,ALRESTAT       * only want selected status
          GOTO      SRFL0095 IF NOT EQUAL
.
          MATCH     "1",ALREUYN4            * only want SACS referrals
          GOTO      SRFL0010 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SRFL0010
          ENDIF
.
          CALL      SACDIS00                * Display SACS Row
.
          ADD       ONE,DISNUMB
SRFL0020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      SRFL0010 IF NOT EQUAL
          ELSE
            GOTO      SRFL0010
          ENDIF
.
          GOTO      SRFL9999
.
SRFL0095  WRITE     HTMLFILE;"<tr bgcolor=#FF0000>":
                             "<td colspan=10 align=center>":
                             "No more entries</td>"
SRFL9999  RETURN
+
.-------------------------------------------------------------------
.   Closed Referral Tables %ALLWEB02.01.015
.-------------------------------------------------------------------
ACRT0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY30,DEPTCODE,TWO,FRSTDATE,SP70
          CALL      RSALREF6                * positional read
ACRT0010  CALL      RKALREF6                * read a record forward
          BRANCH    OVRCD,ACRT9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT
          GOTO      ACRT9999 IF NOT EQUAL
.
          MATCH     "2",ALRESTAT            * Don't disp if status is not "0"
          GOTO      ACRT9999 IF NOT EQUAL
.
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral
          GOTO      ACRT9999 IF LESS
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      ACRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      ACRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      ACRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      ACRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      ACRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      ACRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      ACRT0015 IF EQUAL
              GOTO      ACRT0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      ACRT0010 IF NOT EQUAL * HCP does not match don't disp
            ENDIF
          ENDIF
.
ACRT0015  MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      ACRT0010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      ACRT0010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ACRT0010
          ENDIF
.
          CALL      CLSDIS00                * Display Row
          ADD       ONE,DISNUMB
ACRT0020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      ACRT0010 IF NOT EQUAL
          ELSE
            GOTO      ACRT0010
          ENDIF 
.
ACRT9999  RETURN
.
.-------------------------------------------------------------------
.    Closed Referral table By HCP
.-------------------------------------------------------------------
.
ACRTH000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY27,DOCTCODE,TWO,FRSTDATE,SP70
          CALL      RSALREF5                * positional read
ACRTH010  CALL      RKALREF5                * read a record forward
          BRANCH    OVRCD,ACRTH999
.
          CALL      INDHCP00
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      ACRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      ACRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      ACRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      ACRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      ACRTH015 IF EQUAL
            GOTO      ACRTH999
          ELSE
            MATCH     DOCTCODE,ALREHCP
            GOTO      ACRTH999 IF NOT EQUAL
          ENDIF
.
ACRTH015  MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALREDEPT
            GOTO      ACRTH999 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",ALRESTAT            * Don't disp if status is not "0"
          GOTO      ACRTH999 IF NOT EQUAL
.
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral
          GOTO      ACRTH999 IF LESS
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      ACRTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      ACRTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      ACRTH010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      ACRTH010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ACRTH010
          ENDIF
.
          CALL      CLSDIS00                * Display Row
          ADD       ONE,DISNUMB
ACRTH020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      ACRTH010 IF NOT EQUAL
          ELSE
            GOTO      ACRTH010
          ENDIF
.
ACRTH999  RETURN
.
.-------------------------------------------------------------------
.   Inactive Referral Tables %ALLWEB02.01.016
.-------------------------------------------------------------------
AIRT0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY22,DEPTCODE,THREE,SP70
          CALL      RSALREF4                * positional read
AIRT0010  CALL      RKALREF4                * read a record forward
          BRANCH    OVRCD,AIRT9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT
          GOTO      AIRT9999 IF NOT EQUAL
.
          MATCH     "3",ALRESTAT
          GOTO      AIRT9999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      AIRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      AIRT0010 IF NOT EQUAL
          ENDIF

          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      AIRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      AIRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      AIRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      AIRT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      AIRT0015 IF EQUAL
              GOTO      AIRT0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      AIRT0010 IF NOT EQUAL * HCP does not match don't disp
            ENDIF
          ENDIF
.
AIRT0015  MATCH     SP70,IAREASON
          IF        !@EQUAL
            MATCH     IAREASON,ALRERINA
            GOTO      AIRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      AIRT0010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      AIRT0010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      AIRT0010
          ENDIF
.
          CALL      INADIS00                * Display Row
.
          MATCH     "1",SORTFLAG
          IF        !@EQUAL
            ADD       ONE,DISNUMB
            COMPARE   NORECORD,DISNUMB
            GOTO      AIRT0010 IF NOT EQUAL
          ELSE
            GOTO      AIRT0010
          ENDIF
.
AIRT9999  RETURN
.
.-----------------------------------------------------------------------------.
.   Inactive Referrals by HPC
.-----------------------------------------------------------------------------.
AIRTH000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY27,DOCTCODE,THREE,SP70
          CALL      RSALREF5                * positional read
AIRTH010  CALL      RKALREF5                * read a record forward
          BRANCH    OVRCD,AIRTH999
.
          CALL      INDHCP00
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      AIRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      AIRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      AIRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      AIRTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      AIRTH015 IF EQUAL
            GOTO      AIRTH999
          ELSE
            MATCH     DOCTCODE,ALREHCP
            GOTO      AIRTH999 IF NOT EQUAL
          ENDIF
.
AIRTH015  MATCH     "3",ALRESTAT
          GOTO      AIRTH999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      AIRTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      AIRTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALREDEPT
            GOTO      AIRTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      AIRTH010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      AIRTH010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      AIRTH010
          ENDIF
.
          CALL      INADIS00                * Display Row
.
          MATCH     "1",SORTFLAG
          IF        !@EQUAL
            ADD       ONE,DISNUMB
            COMPARE   NORECORD,DISNUMB
            GOTO      AIRTH010 IF NOT EQUAL
          ELSE
            GOTO      AIRTH010
          ENDIF
.
AIRTH999  RETURN
.
.-----------------------------------------------------------------------------.
.   Cancelled Referral Tables %ALLWEB02.01.017
.                   CANCELLING REFERRAL DETAILS                               .
.-----------------------------------------------------------------------------.
ACAR0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY30,DEPTCODE,FOUR,FRSTDATE,SP70
          CALL      RSALREF6                * positional read
ACAR0010  CALL      RKALREF6                * read a record forward
          BRANCH    OVRCD,ACAR9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT
          GOTO      ACAR9999 IF NOT EQUAL
.
          MATCH     "4",ALRESTAT            * Don't disp if status is not "4"
          GOTO      ACAR9999 IF NOT EQUAL
.
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral
          GOTO      ACAR9999 IF LESS
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      ACAR0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      ACAR0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      ACAR0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      ACAR0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      ACAR0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      ACAR0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      ACAR0015 IF EQUAL
              GOTO      ACAR0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      ACAR0010 IF NOT EQUAL * HCP does not match don't disp
            ENDIF
          ENDIF
.
ACAR0015  MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      ACAR0010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      ACAR0010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ACAR0010
          ENDIF
.
          CALL      CANDIS00                * Display Row
          ADD       ONE,DISNUMB
ACAR0020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      ACAR0010 IF NOT EQUAL
          ELSE
            GOTO      ACAR0010
          ENDIF
.
ACAR9999  RETURN
.
.-------------------------------------------------------------------
.   Canelled Referral table By HCP
.-------------------------------------------------------------------
.
ACARH000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY27,DOCTCODE,FOUR,FRSTDATE,SP70
          CALL      RSALREF5                * positional read
ACARH010  CALL      RKALREF5               * read a record forward
          BRANCH    OVRCD,ACARH999
.
          CALL      INDHCP00
. 
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      ACARH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      ACARH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      ACARH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      ACARH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      ACARH015 IF EQUAL
            GOTO      ACARH999
          ELSE
            MATCH     DOCTCODE,ALREHCP
            GOTO      ACARH999 IF NOT EQUAL
          ENDIF
.
ACARH015  MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALREDEPT
            GOTO      ACARH999 IF NOT EQUAL
          ENDIF
.
          MATCH     "4",ALRESTAT            * Don't disp if status is not "4"
          GOTO      ACARH999 IF NOT EQUAL
.
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with referral
          GOTO      ACARH999 IF LESS
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      ACARH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      ACARH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      ACARH010 IF NOT EQUAL * clinic type does not match 
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      ACARH010 IF NOT EQUAL * clinic id does not match 
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ACARH010
          ENDIF
.
          CALL      CANDIS00                * Display Row
          ADD       ONE,DISNUMB
ACARH020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      ACARH010 IF NOT EQUAL
          ELSE
            GOTO      ACARH010
          ENDIF
 
.
ACARH999  RETURN
+
.
.-----------------------------------------------------------------------------.
.         Patient Referral List (sorted by SACS/Master - Linked/Internal)
.-----------------------------------------------------------------------------.
ALRL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,VINREFLS,DIM127
.
          MOVE      SP70,REF200IN
.
          MOVE      ZERO,COUNTER
          PACK      KEY16,URNUMBER,Z70
          CALL      RSALREF2
ALRL1000  CALL      RPALREF2
          BRANCH    OVRCD,ALRL9999
.
          CALL      INDHCP00
.
          MATCH     ALREURNO,URNUMBER
          GOTO      ALRL9999 IF NOT EQUAL        * finished for this UR
.
          MATCH     SP70,CONTDATE
          IF        !@EQUAL
            MATCH     ALRERDAT,CONTDATE          * Quick re link encounter
            GOTO      ALRL1000 IF LESS           * to referral date edit
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN          * Hospital Filter
            GOTO      ALRL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT          * Preferred Site Filter
            GOTO      ALRL1000 IF NOT EQUAL
          ENDIF
.
          CALL      VVEW0000                     * VINAH referral views only
          BRANCH    EXIT,ALRL1000
.
.         VINAH Views?
.
          IF        DEFTVIEW=1 | DEFTVIEW=2
            MATCH     "1",ALRENVIN               * Is it a Non-VINAH referral?
            GOTO      ALRL1000 IF EQUAL          * Yes; skip
          ENDIF
.
          MATCH     "1",VINREFLS
          IF        @EQUAL
            MATCH     "1",ALREUYN4
            GOTO      ALRL1000 IF NOT EQUAL
          ENDIF
.
          MOVE      ALREVISN,SAVEVISN
.
          MATCH     "1",ALREUYN4                 * is SACS/Master Referral?
          GOTO      ALRL1100 IF EQUAL            * yes; grab it
.
          PACK      KEY16,SAVEVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2                     * is a Linked Refferal?
          BRANCH    OVRCD,ALRL1100               * no; grab it
.
          MATCH     SAVEVISN,ALRLLNKV            * is a Linked Referral?
          GOTO      ALRL1000 IF EQUAL            * yes; skip
.
ALRL1100  MOVE      SAVEVISN,REFRVISN
          MOVE      ONE,REFRTYPE                 * SACS/Master Referral
          CALL      RLRW0000                     * output Referral List row
          MATCH     "1",REF200IN
          GOTO      ALRL9999 IF EQUAL
.
.         Linked/Internal Referrals...
.
          PACK      KEY16,SAVEVISN,SP70
          CALL      RSALRLN1
ALRL2000  CALL      RKALRLN1
          BRANCH    OVRCD,ALRL3000
.
          MATCH     ALRLVISN,SAVEVISN            * same SACS/Master Referral?
          GOTO      ALRL1000 IF NOT EQUAL        * no; finished for this Master
.
          MOVE      ALRLLNKV,REFRLNKN
          MOVE      TWO,REFRTYPE                 * Linked/Internal Referral
          CALL      RLRW0000                     * output Referral List row
          MATCH     "1",REF200IN
          GOTO      ALRL9999 IF EQUAL
          GOTO      ALRL2000
.
ALRL3000  GOTO      ALRL1000
.
ALRL9999  RETURN
.
.-----------------------------------------------------------------------------.
.                   Outputs Patient Referral list row                         .
.                                                                             .
.         Parameters:                                                         .
.                                                                             .
.            REFRTYPE = 1  SACS / Master                                      .
.                       2  Linked / Internal                                  .
.                                                                             .
.            REFRVISN = SACS/Master Referral Number                           .
.            REFRLNKN = Linked/Internal Referral Number                       .
.                                                                             .
.            COUNTER  = Number of rows already drawn                          .
.-----------------------------------------------------------------------------.
RLRW0000  PACK      HTMLLNK5,SP70,SP70
          PACK      HTMLLNK6,SP70,SP70
.
          COMPARE   ONE,REFRTYPE
          IF        @EQUAL
            PACK      KEY8,REFRVISN,SP70
          ELSE
            PACK      KEY8,REFRLNKN,SP70
          ENDIF
.
          CALL      RDALREF1
          BRANCH    OVRCD,RLRW9999
.
          PACK      KEY8,ALREVISN
          CALL      RDVISA1
          BRANCH    OVRCD,RLRW9999
.
          MATCH     SP70,FILTDEPT
          IF        !@EQUAL
            MATCH     FILTDEPT,ALREDEPT
            GOTO      RLRW9999 IF NOT EQUAL
          ENDIF
.
. Exclude primary referrals from the link referral to visit search if the
. department doesn't allow contacts on primary referrals
.
          IF        LINKSRCH=1
            MATCH     "1",ALREUYN4               * Primary Referral
            IF        @EQUAL
              PACK      KEY3,ALREDEPT,SP70
              CALL      RDALDEP1
              BRANCH    OVRCD,RLRW9999

              MATCH     "1",ALDEPENC * Don't Allow Encounters on Primary Ref
              GOTO      RLRW9999 IF EQUAL
            ENDIF
          ENDIF
.
          MATCH     "7",FILTSTAT                      * Waiting & Active
          IF        @EQUAL
            MATCH     "0",ALRESTAT
            GOTO      RLRW1100 IF EQUAL
            MATCH     "1",ALRESTAT
            GOTO      RLRW1100 IF EQUAL
            GOTO      RLRW9999
          ENDIF
.
          MATCH     "8",FILTSTAT                      * Closed & Rejected
          IF        @EQUAL
            MATCH     "2",ALRESTAT
            GOTO      RLRW1100 IF EQUAL
            MATCH     "5",ALRESTAT
            GOTO      RLRW1100 IF EQUAL
            GOTO      RLRW9999
          ENDIF
.
          MATCH     "9",FILTSTAT                      * Inactive & Cancelled
          IF        @EQUAL
            MATCH     "3",ALRESTAT
            GOTO      RLRW1100 IF EQUAL
            MATCH     "4",ALRESTAT
            GOTO      RLRW1100 IF EQUAL
            GOTO      RLRW9999
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALRESTAT
            GOTO      RLRW9999 IF NOT EQUAL
          ENDIF
.
          IF        ACTVONLY = 1
            MATCH    "1",ALRESTAT
            GOTO     RLRW9999 IF NOT EQUAL
          ENDIF
.
RLRW1100  PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,RLRW9999
.
          MATCH     "0",ALDESECU
          GOTO      RLRW1500 IF EQUAL
          MATCH     "1",ALDESECU
.... C-37051  allow users in the department to see referral details
....          For users not in the department, only able to access referral list
....          not referral details
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      RLRW1500 IF EQUAL
            GOTO      RLRW1600
          ENDIF
.... End C
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      RLRW1500 IF EQUAL
          ENDIF
          GOTO      RLRW9999
.
RLRW1500  CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "ReferralLink('",HTMLLINK
          APPEND    ALREVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREDEPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALRERDAT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREUYN4,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALDEPENC,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:",HTMLLNK2
          APPEND    "BookingLink('",HTMLLNK2
          APPEND    ALREVISN,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    ALREURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    ALREPSIT,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          GOTO      RLRW1700
.
RLRW1600  CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "alert('Security Inadequate')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:",HTMLLNK2
          APPEND    "alert('Security Inadequate')",HTMLLNK2
          RESET     HTMLLNK2
.
RLRW1700  MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,DEPDESC
.
          MOVE      SP70,FLDCLASS
          CLEAR     FLDCLASS
          APPEND    "'",FLDCLASS
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            APPEND    "RefStatusWaiting ",FLDCLASS
          ENDIF
.
          MATCH     "1",ALRESTAT
          IF        @EQUAL
            APPEND    "RefStatusActive ",FLDCLASS
          ENDIF
.
          CLEAR     HTMLLNK4
          APPEND    "javascript:",HTMLLNK4
          APPEND    "EncounterLink('",HTMLLNK4
          APPEND    ALREVISN,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ALREDEPT,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ENCOUTKY,HTMLLNK4
          APPEND    "')",HTMLLNK4
          RESET     HTMLLNK4
.
          MOVE      SP70,ALENSDAT
          PACK      KEY16,ALREVISN,Z70
          CALL      RSALENC1
          CALL      RPALENC1
          BRANCH    OVRCD,RLRW1710
          MATCH     ALREVISN,ALENVISN
          GOTO      RLRW1710 IF EQUAL
          MOVE      SP70,ALENSDAT
.
RLRW1710  MOVE      SP70,DOCFNAME                * Clear HCP Name
          MOVE      SP70,DISPPROV                * Clear provider number
.
          MOVE      SP70,DOCFNAM2                * Clear HCP Name
          PACK      KEY10,ALREHCP,SP70           * To get Resp HCP name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,DOCFNAM2
          ENDIF
.
          CALL      ADDHCP00
.
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                     * To get Problem Description
          IF        OVRCD=1
            CALL      CLALPR00
          ENDIF
.
          MOVE      SP70,ALDIDESC
          PACK      KEY13,ALREVISN,ZERO,ONE,SP70
          CALL      RSALRHL1
          CALL      RKALRHL1
          BRANCH    OVRCD,RLRW1720
.
          MATCH     ALREVISN,ALRHVISN
          GOTO      RLRW1720 IF NOT EQUAL
.
          MATCH     "01",ALRHTYPE                * First main health condition
          GOTO      RLRW1720 IF NOT EQUAL
.
          PACK      KEY12,ALREDEPT,ALRHCODE,SP70
          CALL      RDALDIA1
          IF        OVRCD=1
            MOVE      ALRHCODE,ALDIDESC
          ENDIF

.
RLRW1720  MOVE      SP70,DOCFNAME                * clear Referring HCP Name
          MATCH     SP70,ALRERHCP                * Use free format HCP
          IF        @EQUAL
            MATCH     SP70,ALREFHCP
            IF        !@EQUAL
              MOVE      ALREFHCP,DOCFNAME
            ENDIF
.
            MATCH     SP70,ALREHCPP
            IF        !@EQUAL
              PACK      DISPPROV,LBRACK,ALREHCPP,RBRACK
            ENDIF
            GOTO     RLRW1750
          ENDIF
.
          PACK      KEY10,ALRERHCP,SP70          * To get HCP name
          CALL      RDPMHCP1                     * !! datefile not exists
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000                   * formatted into DOCFNAME
.
            MATCH     SP70,PMHCPRV1
            IF        @EQUAL
              MOVE      SP70,DISPPROV
            ELSE
              PACK      DISPPROV,LBRACK,PMHCPRV1,RBRACK
            ENDIF
          ENDIF
.
          PACK      KEY20,ALRERHCP,ALRERHCR,SP70
          CALL      RDPMHCL1
          IF        OVRCD=0
            MATCH     SP70,PMHLPRV1
            IF        !@EQUAL
              PACK      DISPPROV,LBRACK,PMHLPRV1,RBRACK
            ENDIF
          ENDIF
.
RLRW1750  MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE                * To get Priority Description
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE                * To get Compensation Desc
          CALL      GETCOD00
          MOVE      TDESC,COMPDESC
.
          PACK      ALCADESC,ALREUHC4,SP70       * default Description
          MATCH     SP70,ALREUHC4
          IF        !@EQUAL
            PACK      KEY10,ALREUHC4,SP70
            CALL      RDALCAS1
          ENDIF
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      RLRW1800 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,RLRW1800
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      RLRW1800
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
RLRW1800  CALL      SETX0000                * Set Expiry Icon
.
          MOVE      DUBOOKED,BOOKSTAT
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
RLRW1850  CALL      RKALLNK1
          BRANCH    OVRCD,RLRW1900
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      RLRW1900 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      RLRW1850 IF EQUAL
.
          MOVE      DBOOKED,BOOKSTAT


RLRW1900  PACK      HTMLLNK3,SP70,SP70
          MOVE      ZERO,ICONLNK3
.
RLRW2000  MOVE      SP70,REFTDESC
          COMPARE   TWO,REFRTYPE
          GOTO      RLRW4000 IF EQUAL
.
.         SACS/Master Referral...
.
RLRW3000  MOVE      TWO,DIM1              * HTML Sort order
          REP       ": ",ALRECTIM
          SQUEEZE   ALRECTIM
          PACK      PRIMSORT,ONE,ALRERDAT,ALRECTIM,ALREDEPT,Z70
          APPEND    "Left ",FLDCLASS
.
          CLEAR     HTMLLNK3
          APPEND    "javascript:",HTMLLNK3
          APPEND    "LinkedReferral('",HTMLLNK3
          APPEND    ALREVISN,HTMLLNK3
          APPEND    "')",HTMLLNK3
          RESET     HTMLLNK3
.
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC
            MOVE      ONE,ICONLNK3
.
            PACK      KEY16,ALREVISN,SP70
            CALL      RSALRLN1
            CALL      RKALRLN1
            BRANCH    OVRCD,RLRW5000
.
            MATCH     REFRVISN,ALRLVISN          * has Linked referrals?
            GOTO      RLRW5000 IF NOT EQUAL      * no
.
            SQUEEZE   ALCNMDES
            CLEAR     REFTDESC
            APPEND    ALCNMDES,REFTDESC
            APPEND    "-Links",REFTDESC
            RESET     ALCNMDES
          ELSE
            CALL      PROG0000            * Show create program referral icon
          ENDIF
.
          GOTO      RLRW5000
.
.         Linked/Internal Referral...
.
RLRW4000  MOVE      ONE,DIM1              * HTML Sort order
          MOVE      "Linked",REFTDESC
.
          IF        LNKDRGHT=ONE
            APPEND    "Left  ",FLDCLASS
          ELSE
            APPEND    "Right ",FLDCLASS
          ENDIF
.
          CLEAR     PRIMSORT
          APPEND    ONE,PRIMSORT
.
          PACK      KEY8,REFRVISN,SP70           * SACS/Master
          CALL      RDALREF1
          BRANCH    OVRCD,RLRW9999
.
          APPEND    ALRERDAT,PRIMSORT
          REP       ": ",ALRECTIM
          SQUEEZE   ALRECTIM
          APPEND    ALRECTIM,PRIMSORT
          APPEND    ALREDEPT,PRIMSORT
.
          PACK      KEY8,REFRLNKN,SP70           * Linked/Internal
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLALLEID
          ENDIF
.
          APPEND    ALRERDAT,PRIMSORT
          REP       ": ",ALRECTIM
          SQUEEZE   ALRECTIM
          APPEND    ALRECTIM,PRIMSORT
          APPEND    ALREDEPT,PRIMSORT
.
          APPEND    Z70,PRIMSORT
          RESET     PRIMSORT
.
RLRW5000  ADD       ONE,COUNTER
          IF        COUNTER>400
             WRITE    HTMLFILE;"alert(#"Table exceeds 400 records. Records ":
                                     "beyond 400 will not be displayed#");";
             MOVE     ONE,REF200IN
             GOTO     RLRW9999
          ENDIF
.
          CALL      RESADM00
.
          MOVE      "ts",CATEGORY
          MOVE      ALRETRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          APPEND    "'",FLDCLASS
          RESET     FLDCLASS
.
          MOVE      SP70,KEY8
          CALL      CLPATWC1                          *Clear WC/ACC variables
          PACK      KEY8,ALREVISN
          CALL      RDWCOM1                           *Searches WC/ACC Claim
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",DEPDESC,"#",":                    * 1
                             "#"",ALRERDAT,"#",":                   * 2
                             "#"",ALSTDESC,"#",":                   * 3
                             "#"",DOCFNAME,"#",":                   * 4
                             "#"",ALPRDESC,"#",":                   * 5
                             "#"",ALREVISN,"#",":                   * 6
                             "#"",ALENSDAT,"#",":                   * 7
                             "#"",PRIODESC,"#",":                   * 8
                             "#"",COMPDESC,"#",":                   * 9
                             "#"",ALREPRCM,"#",":                   *10
                             "#"",OCADESC,"#",":                    *11
                             "#"",OCTDESC,"#",":                    *12
                             "#"",ALRERHCP,"#",":                   *13
                             "#"",ALREREXP,"#",":                   *14
                             "#"",EXPRICON,"#",":                   *15
                             "#"",ALRECLID,"#",":                   *16
                             "#"",ALRECTYP,"#",":                   *17
                             "#"",DOCFNAME,DISPPROV,"#",":          *18
                             "#"",BOOKSTAT,"#",":                   *19
                             "#"",HTMLLNK2,"#",":                   *20
                             "#"",REFTDESC,HTMLLNK5,HTMLLNK6,"#",": *21
                             "#"",ALRECOMP,"#",":                   *22
                             "#"",ALREUHC4,"#",":                   *23
                             "#"",ALCADESC,"#",":                   *24
                             "#"",ALREHCP,"#",";                    *25
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MOVE      DOCFNAME,SAVDIM50        * Save DOCFNAME
            MOVE      DOCFNAM2,DOCFNAME
            CALL      DISHCS00              
            MOVE      SAVDIM50,DOCFNAME        * restore DOCFNAME
          ELSE
            WRITE     HTMLFILE;"#"",DOCFNAM2,"#",";                 *26
          ENDIF
.
          WRITE     HTMLFILE;"#"",HTMLLNK3,"#",":                   *27
                             "#"",ICONLNK3,"#",":                   *28
                             "#"","AH","#",#"";                     *29
.
          CALL      VCDM0000                  * 30 Visit based CDM Icons
          REP       "#"'",ALREUFR1
.         * Dont display acc no for non accident referral
          PACK      KEY8,ALREVISN,SP70
          CALL      RDPMWX11
          IF        OVRCD=0
            MATCH     "3",PMWXCSTA   
            IF        @EQUAL     
              MOVE      SP70,WCCLMNO  
            ENDIF 
          ENDIF
          
.
          WRITE     HTMLFILE;"#",#"",PRIMSORT,"#",":                *31
                             "#"",FLDCLASS,"#",":                   *32
                             "#"",ALPRDESC,ALDIDESC,"#",":          *33
                             "#"",ALREPSIT,"#",":                   *34
                             "#"",ALREHOSN,"#",":                   *35
                             "#"",ALREUFR1,"#",":                   *36
                             "#"",ALRLVISN,DIM1,ALRERDAT,"#",":     *37
                             "#"#",":   
                             "#"",HTMLLNK4,"#",":                   *39
                             "#"",TRGSDESC,"#",":                   *40
                             "#"<span class='TextBlue'>",WCCLMNO,"</span>#" ":
.                                                                   *41
                             ");"
.
RLRW9999  RETURN
.
.--------------------------------------------------------------------------
. Output additional HCPs only when not blank
.--------------------------------------------------------------------------
DISHCP00  WRITE     HTMLFILE;"<td>&nbsp;";
          MATCH     SP70,DOCFNAME
          IF        !@EQUAL
            WRITE     HTMLFILE;DOCFNAME;
          ENDIF
          MATCH     SP70,DOCFNAM3
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM3,"</font>";
          ENDIF
          MATCH     SP70,DOCFNAM4
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM4,"</font>";
          ENDIF
          MATCH     SP70,DOCFNAM5
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM5,"</font>";
          ENDIF
          MATCH     SP70,DOCFNAM6
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM6,"</font>";
          ENDIF
          WRITE     HTMLFILE;"</td>";
DISHCP99  RETURN
.--------------------------------------------------------------------------
. Output additional HCPs only when not blank - tablesort
.--------------------------------------------------------------------------
DISHCS00  WRITE     HTMLFILE;"#"";
          MATCH     SP70,DOCFNAME
          IF        !@EQUAL
            WRITE     HTMLFILE;"&nbsp;",DOCFNAME;
          ENDIF
.
          MATCH     SP70,DOCFNAM3
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM3,"</font>";
          ENDIF
          MATCH     SP70,DOCFNAM4
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM4,"</font>";
          ENDIF
          MATCH     SP70,DOCFNAM5
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM5,"</font>";
          ENDIF
          MATCH     SP70,DOCFNAM6
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br><font color=blue>&nbsp;",DOCFNAM6,"</font>";
          ENDIF
          WRITE     HTMLFILE;"#",";
.
DISHCS99  RETURN
.--------------------------------------------------------------------------
. Patient Referral List for appointment requests relink
.--------------------------------------------------------------------------
ALRLAQ00  MOVE      SP70,REF200IN
.
          MOVE      ZERO,COUNTER
          PACK      KEY16,URNUMBER,Z70
          CALL      RSALREF2
ALRLAQ20  CALL      RPALREF2
          BRANCH    OVRCD,ALRLAQ99
.
          MATCH     ALREURNO,URNUMBER
          GOTO      ALRLAQ99 IF NOT EQUAL        * finished for this UR
.
          MATCH     ADMISSNO,ALREVISN
          GOTO      ALRLAQ20 IF EQUAL            * skip if same admiss no
.
          MOVE      ALREVISN,SAVEVISN
.
          MATCH     "1",ALREUYN4                 * is SACS/Master Referral?
          GOTO      ALRLAQ30 IF EQUAL            * yes; grab it
.
          PACK      KEY16,SAVEVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2                     * is a Linked Refferal?
          BRANCH    OVRCD,ALRLAQ30               * no; grab it
.
          MATCH     SAVEVISN,ALRLLNKV            * is a Linked Referral?
          GOTO      ALRLAQ20 IF EQUAL            * yes; skip
.
ALRLAQ30  MOVE      SAVEVISN,REFRVISN
          MOVE      ONE,REFRTYPE                 * SACS/Master Referral
          CALL      RLRWAQ00                     * output Referral List row
          MATCH     "1",REF200IN
          GOTO      ALRLAQ99 IF EQUAL
.
.         Linked/Internal Referrals...
.
          PACK      KEY16,SAVEVISN,SP70
          CALL      RSALRLN1
ALRLAQ40  CALL      RKALRLN1
          BRANCH    OVRCD,ALRLAQ20
.
          MATCH     ALRLVISN,SAVEVISN            * same SACS/Master Referral?
          GOTO      ALRLAQ20 IF NOT EQUAL        * no; finished for this Master
.
          MOVE      ALRLLNKV,REFRLNKN
          MOVE      TWO,REFRTYPE                 * Linked/Internal Referral
          CALL      RLRWAQ00                     * output Referral List row
          MATCH     "1",REF200IN
          GOTO      ALRLAQ99 IF EQUAL
          GOTO      ALRLAQ40
.
ALRLAQ99  RETURN
.
RLRWAQ00  PACK      HTMLLNK5,SP70,SP70
          PACK      HTMLLNK6,SP70,SP70
.
          COMPARE   ONE,REFRTYPE
          IF        @EQUAL
            PACK      KEY8,REFRVISN,SP70
          ELSE
            PACK      KEY8,REFRLNKN,SP70
          ENDIF
.
          CALL      RDALREF1
          BRANCH    OVRCD,RLRWAQ99
.
          PACK      KEY8,ALREVISN
          CALL      RDVISA1
          BRANCH    OVRCD,RLRWAQ99
.
          MATCH     "7",FILTSTAT                      * Waiting & Active
          IF        @EQUAL
            MATCH     "0",ALRESTAT
            GOTO      RLRWAQ20 IF EQUAL
            MATCH     "1",ALRESTAT
            GOTO      RLRWAQ20 IF EQUAL
            GOTO      RLRWAQ99
          ENDIF
.
          MATCH     "8",FILTSTAT                      * Closed & Rejected
          IF        @EQUAL
            MATCH     "2",ALRESTAT
            GOTO      RLRWAQ20 IF EQUAL
            MATCH     "5",ALRESTAT
            GOTO      RLRWAQ20 IF EQUAL
            GOTO      RLRWAQ99
          ENDIF
.
          MATCH     "9",FILTSTAT                      * Inactive & Cancelled
          IF        @EQUAL
            MATCH     "3",ALRESTAT
            GOTO      RLRWAQ20 IF EQUAL
            MATCH     "4",ALRESTAT
            GOTO      RLRWAQ20 IF EQUAL
            GOTO      RLRWAQ99
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALRESTAT
            GOTO      RLRWAQ99 IF NOT EQUAL
          ENDIF
.
          IF        ACTVONLY = 1
            MATCH    "1",ALRESTAT
            GOTO     RLRWAQ99 IF NOT EQUAL
          ENDIF
.
RLRWAQ20  PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,RLRWAQ99
.
          MATCH     "0",ALDESECU
          GOTO      RLRWAQ30 IF EQUAL
.
          MATCH     "1",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      RLRWAQ30 IF EQUAL
            GOTO      RLRWAQ99
          ENDIF
.
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      RLRWAQ30 IF EQUAL
          ENDIF
          GOTO      RLRWAQ99
.
RLRWAQ30  CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "RelinkApptRequest('",HTMLLINK
          APPEND    ALREVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OTARTKEY,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,DEPDESC
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,DOCFNAME                * Clear HCP Name
          MOVE      SP70,DOCFNAM2                * Clear HCP Name
.
          PACK      KEY10,ALREHCP,SP70           * To get Resp HCP name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,DOCFNAM2
          ENDIF
.
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                     * To get Problem Description
          IF        OVRCD=1
            CALL      CLALPR00
          ENDIF
.
          MOVE      SP70,ALDIDESC
          PACK      KEY13,ALREVISN,ZERO,ONE,SP70
          CALL      RSALRHL1
          CALL      RKALRHL1
          BRANCH    OVRCD,RLRWAQ40
.
          MATCH     ALREVISN,ALRHVISN
          GOTO      RLRWAQ40 IF NOT EQUAL
.
          MATCH     "01",ALRHTYPE                * First main health condition
          GOTO      RLRWAQ40 IF NOT EQUAL
.
          PACK      KEY12,ALREDEPT,ALRHCODE,SP70
          CALL      RDALDIA1
          IF        OVRCD=1
            MOVE      ALRHCODE,ALDIDESC
          ENDIF
.
RLRWAQ40  MOVE      SP70,DOCFNAME                * clear Referring HCP Name
          IF        @EQUAL
            MATCH     SP70,ALREFHCP
            IF        !@EQUAL
              MOVE      ALREFHCP,DOCFNAME
            ENDIF
            GOTO     RLRWAQ45
          ENDIF
.
          PACK      KEY10,ALRERHCP,SP70          * To get HCP name
          CALL      RDPMHCP1                     * !! datefile not exists
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000                   * formatted into DOCFNAME
          ENDIF
.
RLRWAQ45  MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      RLRWAQ50 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
RLRWAQ50  PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
RLRWAQ55  CALL      RKALLNK1
          BRANCH    OVRCD,RLRWAQ60
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      RLRWAQ60 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      RLRWAQ55 IF EQUAL
.
RLRWAQ60  MOVE      SP70,REFTDESC
          COMPARE   TWO,REFRTYPE
          GOTO      RLRWAQ75 IF EQUAL
.
.         SACS/Master Referral...
.
RLRWAQ70  MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC
.
            PACK      KEY16,ALREVISN,SP70
            CALL      RSALRLN1
            CALL      RKALRLN1
            BRANCH    OVRCD,RLRWAQ80
.
            MATCH     REFRVISN,ALRLVISN          * has Linked referrals?
            GOTO      RLRWAQ80 IF NOT EQUAL      * no
.
            SQUEEZE   ALCNMDES
            CLEAR     REFTDESC
            APPEND    ALCNMDES,REFTDESC
            APPEND    "-Links",REFTDESC
            RESET     ALCNMDES
          ELSE
            CALL      PROG0000                  * create HTMLLNK5
          ENDIF
.
          GOTO      RLRWAQ80
.
.         Linked/Internal Referral...
.
RLRWAQ75  MOVE      "Linked",REFTDESC
.
          PACK      KEY8,REFRVISN,SP70           * SACS/Master
          CALL      RDALREF1
          BRANCH    OVRCD,RLRWAQ99
.
          PACK      KEY8,REFRLNKN,SP70           * Linked/Internal
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLALLEID
          ENDIF
.
RLRWAQ80  ADD       ONE,COUNTER
          IF        COUNTER>400
             WRITE    HTMLFILE;"alert(#"Table exceeds 400 records. Records ":
                                     "beyond 400 will not be displayed#");";
             MOVE     ONE,REF200IN
             GOTO     RLRWAQ99
          ENDIF
.
          CALL      RESADM00                         * create HTMLLNK6  
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",DEPDESC,"#",":                    * 1
                             "#"",ALRERDAT,"#",":                   * 2
                             "#"",ALSTDESC,"#",":                   * 3
                             "#"",DOCFNAME,"#",":                   * 4
                             "#"",ALREVISN,"#",":                   * 5
                             "#"",REFTDESC,HTMLLNK5,HTMLLNK6,"#",": * 6
                             "#"",DOCFNAM2,"#",":                   * 7
                             "#"",ALPRDESC,ALDIDESC,"#");"          * 8
.
RLRWAQ99  RETURN
.
.-----------------------------------------------------------------------------.
. Show create program referrral icon
.-----------------------------------------------------------------------------.
PROG0000  PACK      HTMLLNK5,SP70,SP70
.
          MATCH     "0",ALRESTAT            * Waiting/Active/Rejected only
          IF        !@EQUAL
            MATCH     "1",ALRESTAT
            IF        !@EQUAL
              MATCH     "5",ALRESTAT
              GOTO      PROG9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     "1",ALREUYN4            * Episode referrals only
          GOTO      PROG9999 IF EQUAL
.
          MATCH     "1",ALRENVIN            * Non VINAH referal
          GOTO      PROG9999 IF EQUAL
.
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
.
          MATCH     SP70,TCINDC8            * Not a VINAH program
          GOTO      PROG9999 IF EQUAL
.
          MATCH     ANSE,TCINDC11           * VINAH Combined episode stream
          GOTO      PROG9999 IF NOT EQUAL
.
          MATCH     "1",ALCNDEVP            * Display Event Program
          GOTO      PROG2000 IF NOT EQUAL
.
          MATCH     SP70,ALREEVPR           * Blank Event Program
          GOTO      PROG2000 IF EQUAL
.
          PACK      KEY5,CATZG,ALREEVPR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PROG2000
.
          MATCH     ANSE,TCINDC2            * Exclude from VINAH
          GOTO      PROG9999 IF EQUAL
.
PROG2000  REP       " +",ALREURNO
          REP       " +",ALREVISN
          CLEAR     HTMLLNK5
          APPEND    "<input type=button class=button ",HTMLLNK5
          APPEND    "value='Create Program' ",HTMLLNK5
          APPEND    "onclick=CreateProgramRef('",HTMLLNK5
          APPEND    ALREURNO,HTMLLNK5
          APPEND    "','",HTMLLNK5
          APPEND    ALREVISN,HTMLLNK5
          APPEND    "')>",HTMLLNK5
          RESET     HTMLLNK5
          REP       "+ ",ALREURNO
          REP       "+ ",ALREVISN
.
PROG9999  RETURN
.
.-----------------------------------------------------------------------------.
. Show residential Admission icon
.-----------------------------------------------------------------------------.
RESADM00  CLEAR     HTMLLNK6
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRSA1
RESADM10  CALL      RKALRSA1
          BRANCH    OVRCD,RESADM99
.
          MATCH     ALREVISN,ALRAVISN
          GOTO      RESADM99 IF NOT EQUAL
.
          PACK      KEY8,ALRALADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,RESADM10
.
          MATCH     "5",DASTAT
          GOTO      RESADM10 IF EQUAL
.
          CLEAR     HTMLLNK6
          APPEND    "<a href=\#" javascript:ShowResidentialAdm('",HTMLLNK6
          APPEND    ALREVISN,HTMLLNK6
          APPEND    "')\#"> ",HTMLLNK6
          APPEND    "<img src=../images/AdmitIcon.gif class=icon",HTMLLNK6
          APPEND    "></a>",HTMLLNK6
          RESET     HTMLLNK6
.
RESADM99  RETURN
.
.-----------------------------------------------------------------------------.
. Only output referrals that are associated with VINAH
.-----------------------------------------------------------------------------.
VVEW0000  COMPARE   THREE,PTCNHDPS               * Victoria only
          GOTO      VVEW8000 IF NOT EQUAL
.
          COMPARE   ONE,DEFTVIEW                 * VINAH View 1
          GOTO      VVEW1000 IF EQUAL
.
          COMPARE   TWO,DEFTVIEW                 * VINAH View 2
          GOTO      VVEW1000 IF EQUAL
.
          GOTO      VVEW8000
.
VVEW1000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VVEW8000
.
          MATCH     SP70,TCINDC8                  * Check if VINAH
          GOTO      VVEW8000 IF NOT EQUAL
.
          MATCH     "1",ALCNDEVP                  * Check if using event
          GOTO      VVEW9000 IF NOT EQUAL         * program
.
          PACK      KEY5,CATZG,ALREEVPR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VVEW9000
.
          MATCH     SP70,TCINDC8                  * Check if VINAH
          GOTO      VVEW9000 IF EQUAL
.
VVEW8000  MOVE      ZERO,EXIT
          GOTO      VVEW9999
.
VVEW9000  MOVE      ONE,EXIT
          GOTO      VVEW9999
.
VVEW9999  RETURN
+
.
.-----------------------------------------------------------------------------.
.     Patient Referral List
.-----------------------------------------------------------------------------.
APRL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,COUNTER
          PACK      KEY16,URNUMBER,Z70
          CALL      RSALREF2
APRL1000  CALL      RPALREF2
          BRANCH    OVRCD,APRL9999
.
          MATCH     ALREURNO,URNUMBER
          GOTO      APRL9999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      APRL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      APRL1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ALREVISN
          CALL      RDVISA1
          BRANCH    OVRCD,APRL1000
.
          MATCH     SP70,FILTDEPT
          IF        !@EQUAL
            MATCH     FILTDEPT,ALREDEPT
            GOTO      APRL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     "7",FILTSTAT                      * Waiting & Active
          IF        @EQUAL
            MATCH     "0",ALRESTAT
            GOTO      APRL1100 IF EQUAL
            MATCH     "1",ALRESTAT
            GOTO      APRL1100 IF EQUAL
            GOTO      APRL1000
          ENDIF
.
          MATCH     "8",FILTSTAT                      * Closed & Rejected
          IF        @EQUAL
            MATCH     "2",ALRESTAT
            GOTO      APRL1100 IF EQUAL
            MATCH     "5",ALRESTAT
            GOTO      APRL1100 IF EQUAL
            GOTO      APRL1000
          ENDIF
.
          MATCH     "9",FILTSTAT                      * Inactive & Cancelled
          IF        @EQUAL
            MATCH     "3",ALRESTAT
            GOTO      APRL1100 IF EQUAL
            MATCH     "4",ALRESTAT
            GOTO      APRL1100 IF EQUAL
            GOTO      APRL1000
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALRESTAT
            GOTO      APRL1000 IF NOT EQUAL
          ENDIF
.
          IF        ACTVONLY = 1
            MATCH    "1",ALRESTAT
            GOTO     APRL1000 IF NOT EQUAL
          ENDIF
.
APRL1100  PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,APRL1000
.
          MATCH     "0",ALDESECU
          GOTO      APRL1500 IF EQUAL
          MATCH     "1",ALDESECU
.... C-37051  allow users in the department to see referral details
....          For users not in the department, only able to access referral list
....          not referral details
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      APRL1500 IF EQUAL
            GOTO      APRL1600
          ENDIF
.... End C
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      APRL1500 IF EQUAL
          ENDIF
          GOTO      APRL1000
.
APRL1500  CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "ReferralLink('",HTMLLINK
          APPEND    ALREVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREDEPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALRERDAT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:",HTMLLNK2
          APPEND    "BookingLink('",HTMLLNK2
          APPEND    ALREVISN,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    ALREURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    ALREPSIT,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          GOTO      APRL1700
.
APRL1600  CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "alert('Security Inadequate')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:",HTMLLNK2
          APPEND    "alert('Security Inadequate')",HTMLLNK2
          RESET     HTMLLNK2
.
APRL1700  MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,DEPDESC
.
          MOVE      SP70,FLDCLASS
          CLEAR     FLDCLASS
          APPEND    "'",FLDCLASS
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00  
          MOVE      ALSTATUS,ALSTDESC
.
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            APPEND    "RefStatusWaiting ",FLDCLASS
          ENDIF
.
          MATCH     "1",ALRESTAT
          IF        @EQUAL
            APPEND    "RefStatusActive ",FLDCLASS
          ENDIF
.
          CLEAR     HTMLLNK4
          APPEND    "javascript:",HTMLLNK4
          APPEND    "EncounterLink('",HTMLLNK4
          APPEND    ALREVISN,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ALREDEPT,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ENCOUTKY,HTMLLNK4
          APPEND    "')",HTMLLNK4
          RESET     HTMLLNK4
.
          MOVE      SP70,ALENSDAT
          PACK      KEY16,ALREVISN,Z70
          CALL      RSALENC1
          CALL      RPALENC1
          BRANCH    OVRCD,APRL1710
          MATCH     ALREVISN,ALENVISN
          GOTO      APRL1710 IF EQUAL
          MOVE      SP70,ALENSDAT
.
APRL1710  MOVE      SP70,DOCFNAME                * Clear HCP Name
          MOVE      SP70,DISPPROV                * Clear provider number
.
          MOVE      SP70,DOCFNAM2                * Clear HCP Name
          PACK      KEY10,ALREHCP,SP70           * To get Resp HCP name
          CALL      RDPMHCP1 
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,DOCFNAM2
          ENDIF
.
          CALL      ADDHCP00
.
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                     * To get Problem Description
          IF        OVRCD=1
            CALL      CLALPR00
          ENDIF
.
          MOVE      SP70,ALDIDESC
          PACK      KEY13,ALREVISN,ZERO,ONE,SP70
          CALL      RSALRHL1
          CALL      RKALRHL1
          BRANCH    OVRCD,APRL1720
.
          MATCH     ALREVISN,ALRHVISN
          GOTO      APRL1720 IF NOT EQUAL
.
          MATCH     "01",ALRHTYPE                * First main health condition
          GOTO      APRL1720 IF NOT EQUAL
.
          PACK      KEY12,ALREDEPT,ALRHCODE,SP70
          CALL      RDALDIA1
          IF        OVRCD=1
            MOVE      ALRHCODE,ALDIDESC
          ENDIF

.
APRL1720  MOVE      SP70,DOCFNAME                * clear Referring HCP Name
          MATCH     SP70,ALRERHCP                * Use free format HCP
          IF        @EQUAL
            MATCH     SP70,ALREFHCP
            IF        !@EQUAL
              MOVE      ALREFHCP,DOCFNAME
            ENDIF
.           
            MATCH     SP70,ALREHCPP
            IF        !@EQUAL
              PACK      DISPPROV,LBRACK,ALREHCPP,RBRACK
            ENDIF    
            GOTO     APRL1750
          ENDIF
.  
          PACK      KEY10,ALRERHCP,SP70          * To get HCP name
          CALL      RDPMHCP1                     * !! datefile not exists
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000                   * formatted into DOCFNAME
.
            MATCH     SP70,PMHCPRV1
            IF        @EQUAL
              MOVE      SP70,DISPPROV
            ELSE
              PACK      DISPPROV,LBRACK,PMHCPRV1,RBRACK
            ENDIF
          ENDIF
.
          PACK      KEY20,ALRERHCP,ALRERHCR,SP70
          CALL      RDPMHCL1
          IF        OVRCD=0
            MATCH     SP70,PMHLPRV1
            IF        !@EQUAL
              PACK      DISPPROV,LBRACK,PMHLPRV1,RBRACK
            ENDIF
          ENDIF
.
APRL1750  MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE                * To get Priority Description
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE                * To get Compensation Desc
          CALL      GETCOD00
          MOVE      TDESC,COMPDESC
.
          PACK      ALCADESC,ALREUHC4,SP70       * default Description
          MATCH     SP70,ALREUHC4
          IF        !@EQUAL
            PACK      KEY10,ALREUHC4,SP70
            CALL      RDALCAS1
          ENDIF
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      APRL1800 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,APRL1800
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      APRL1800
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
APRL1800  CALL      SETX0000                * Set Expiry Icon
.
          MOVE      DUBOOKED,BOOKSTAT
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
APRL1850  CALL      RKALLNK1
          BRANCH    OVRCD,APRL1900
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      APRL1900 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      APRL1850 IF EQUAL
.
          MOVE      DBOOKED,BOOKSTAT
.
APRL1900  PACK      HTMLLNK3,SP70,SP70
          PACK      HTMLLNK5,SP70,SP70
          MOVE      ZERO,ICONLNK3
.
          MATCH     "1",ALREUYN4            * Sacs referral
          GOTO      APRL3000 IF EQUAL
.
APRL2000  MOVE      SP70,REFTDESC
          PACK      PRIMSORT,ONE,ALRERDAT,ALREDEPT,SP70
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          IF        OVRCD=1
            APPEND    "Left ",FLDCLASS
            CALL      PROG0000            * Show create program referral icon
            GOTO      APRL5000
          ENDIF
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          IF        !@EQUAL
            APPEND    "Left ",FLDCLASS
            CALL      PROG0000            * Show create program referral icon
            GOTO      APRL5000 
          ENDIF
.
          MOVE      "Linked",REFTDESC
.
          IF        LNKDRGHT=ONE
            APPEND    "Left  ",FLDCLASS
          ELSE
            APPEND    "Right ",FLDCLASS
          ENDIF
.
          CLEAR     PRIMSORT
          APPEND    TWO,PRIMSORT
.
          PACK      SAVKEY16,ALREURNO,ALREVISN,SP70
          PACK      KEY8,ALRLVISN,SP70
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLALLEID
          ENDIF
          APPEND    ALRERDAT,PRIMSORT
          APPEND    ALREDEPT,PRIMSORT
.
          MOVE      SAVKEY16,KEY16
          CALL      RDALREF2
          BRANCH    OVRCD,APRL1000
.
          APPEND    ALRERDAT,PRIMSORT
          APPEND    ALREDEPT,PRIMSORT
          APPEND    SP70,PRIMSORT
          RESET     PRIMSORT
          GOTO      APRL5000
.
APRL3000  MOVE      ALCNMDES,REFTDESC
          PACK      PRIMSORT,TWO,ALRERDAT,ALREDEPT,Z70
          APPEND    "Left ",FLDCLASS
.
          CLEAR     HTMLLNK3
          APPEND    "javascript:",HTMLLNK3
          APPEND    "LinkedReferral('",HTMLLNK3
          APPEND    ALREVISN,HTMLLNK3
          APPEND    "')",HTMLLNK3
          RESET     HTMLLNK3
.
          MOVE      ONE,ICONLNK3
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN1
          CALL      RKALRLN1 
          BRANCH    OVRCD,APRL5000
.                            
          MATCH     ALREVISN,ALRLVISN       * Linked referrals      
          GOTO      APRL5000 IF NOT EQUAL
.                            
          SQUEEZE   ALCNMDES
          CLEAR     REFTDESC
          APPEND    ALCNMDES,REFTDESC
          APPEND    "-Links",REFTDESC
          RESET     ALCNMDES
.
APRL5000  ADD       ONE,COUNTER
          IF        COUNTER>400
             WRITE    HTMLFILE;"alert(#"Table exceeds 400 records. Records ":
                                     "beyond 400 will not be displayed#");";
             GOTO    APRL9999
          ENDIF
.
          CALL      RESADM00
.
          APPEND    "'",FLDCLASS
          RESET     FLDCLASS
.
          MOVE      "ts",CATEGORY
          MOVE      ALRETRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",DEPDESC,"#",":                    * 1
                             "#"",ALRERDAT,"#",":                   * 2
                             "#"",ALSTDESC,"#",":                   * 3
                             "#"",DOCFNAME,"#",":                   * 4
                             "#"",ALPRDESC,"#",":                   * 5
                             "#"",ALREVISN,"#",":                   * 6
                             "#"",ALENSDAT,"#",":                   * 7
                             "#"",PRIODESC,"#",":                   * 8
                             "#"",COMPDESC,"#",":                   * 9
                             "#"",ALREPRCM,"#",":                   *10
                             "#"",OCADESC,"#",":                    *11
                             "#"",OCTDESC,"#",":                    *12
                             "#"",ALRERHCP,"#",":                   *13
                             "#"",ALREREXP,"#",":                   *14
                             "#"",EXPRICON,"#",":                   *15
                             "#"",ALRECLID,"#",":                   *16
                             "#"",ALRECTYP,"#",":                   *17
                             "#"",DOCFNAME,DISPPROV,"#",":          *18
                             "#"",BOOKSTAT,"#",":                   *19
                             "#"",HTMLLNK2,"#",":                   *20
                             "#"",REFTDESC,HTMLLNK5,HTMLLNK6,"#",": *21
                             "#"",ALRECOMP,"#",":                   *22
                             "#"",ALREUHC4,"#",":                   *23
                             "#"",ALCADESC,"#",":                   *24
                             "#"",ALREHCP,"#",";                    *25
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            CALL      DISHCS00
.           WRITE     HTMLFILE;"#"",DOCFNAM2,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",DOCFNAM2,"#",";                 *26
          ENDIF
.
          WRITE     HTMLFILE;"#"",HTMLLNK3,"#",":                   *27
                             "#"",ICONLNK3,"#",":                   *28
                             "#"","RF","#",#"";                     *29
.
          CALL      VCDM0000                  * 30 Visit based CDM Icons
.
          WRITE     HTMLFILE;"#",#"",PRIMSORT,"#",":                *31
                             "#"",FLDCLASS,"#",":                   *32
                             "#"",ALPRDESC,ALDIDESC,"#",":          *33
                             "#"",ALREPSIT,"#",":                   *34
                             "#"",ALREHOSN,"#",":                   *35
                             "#"",ALREUFR1,"#",":                   *36
                             "#"",ALREDEPT,"#",":                   *37
                             "#"",ALREUFR1,"#",":                   *38 
                             "#"",HTMLLNK4,"#",":                   *39 
                             "#"",TRGSDESC,"#" ":                   *40
                             ");"
          GOTO      APRL1000
.
APRL9999  RETURN
.
.-----------------------------------------------------------------------------.
. Set expiry status icon
. EXPRICON - 0 = Red, 1 = Green , 2 = Orange
.-----------------------------------------------------------------------------.
SETX0000  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ONE,EXPRICON           
.
          MATCH     SP70,ALRERTYP           * If no referral type, col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,PMEDI              * If no medicare number, col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,PTMXMCCD           * If no medicare ref number, col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,PMPXMEDC           * If no medicare expiry date,col=red
          IF        @EQUAL
            MOVE      ZERO,EXPRICON
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,ALREREXP           * No referral expiry date
          GOTO      SETX9999 IF EQUAL
.  
          MATCH     ALREREXP,CURRDATE       * Expiry <= Current date
          IF        !@LESS
            MOVE      ZERO,EXPRICON           
            GOTO      SETX9999
          ENDIF
.
          MATCH     SP70,ALRERTYP           * No referral type
          GOTO      SETX9999 IF EQUAL  
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETX9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      SETX9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
          DAYSEP    CURRDATE,ALREREXP,F8
          IF        F8<=F4
            MOVE     TWO,EXPRICON           
          ENDIF
.
SETX9999  RETURN
.-----------------------------------------------------------------------------.
.         Liniked Clinical Documentats Table
.-----------------------------------------------------------------------------.
ALCD0000  PACK      KEY11,ADMISSNO,SP70     * Linked Clinical Documents
          CALL      RSALLIN1                * positional read
ALCD0010  CALL      RKALLIN1                * read a record
          BRANCH    OVRCD,ALCD9999
          MATCH     ADMISSNO,ALLIVISN
          GOTO      ALCD9999 IF NOT EQUAL
          PACK      KEY20,ALLIURNO,ALLIVISN,ALLICOID,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,ALCD9999
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          STRIP     OBPTURLP
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      HTMLLINK,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      HTMLLINK,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     HTMLLINK
          REP       " 0",HTMLLINK
          MOVELPTR  HTMLLINK,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      HTMLLINK,VAR
.
          MOVE      OBPCCTYP,CODE
          MOVE      "wi",CATEGORY
          CALL      GETCOD00
          PACK      KEY10,OBPCINUS,SP70
          CALL      RDWBSE1
          UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.         
          MOVE      ZERO,F1
          MOVE      OBPCMDEL,F1
          BRANCH    F1,ALCD0020,ALCD0020
.
          WRITE     HTMLFILE;"<tr><td>":
                      "<img src=../images/DocumentIcon.gif ":
                      "class=ListIcon onclick='OpenDocument(#"":
                      VAR,"#"); '>":
                      OBPCCOM1,"</td><td>":
                      TDESC,"</td><td>":
                      CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td><td>":
                      WBSENAM,"</td></tr>"
          GOTO      ALCD0010
.
ALCD0020  WRITE     HTMLFILE;"<tr><td><strike>":
                      "<img src=../images/DocumentIcon.gif ":
                      "class=ListIcon onclick='OpenDocument(#"":
                      VAR,"#"); '>":
                      OBPCCOM1,"</strike></td><td><strike>":
                      TDESC,"</strike></td><td><strike>":
                      CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</strike></td><td><strike>":
                      WBSENAM,"</strike></td></tr>"
          GOTO      ALCD0010
.
ALCD9999  MOVE      USERID,KEY10       * Reset Security Record to Current User
          CALL      RDWBSE1
          RETURN
.------------------------------------------------------------------------------
. Routine to display the Referral Audit Summary - 10 records Next & Prev
.------------------------------------------------------------------------------
ARAS0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY24,ADMISSNO,Z70      * Referral Audit Summary
          MOVE      ZERO,COUNT
          CALL      RSALAUD1                * positional read
ARAS0010  CALL      RPALAUD1                * read a record
          BRANCH    OVRCD,ARAS9999
.
          MATCH     ALAUVISN,ADMISSNO
          GOTO      ARAS9999 IF NOT EQUAL
.
          PACK      KEY10,ALAUAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      ALAUAUID,WBSENAM
          ENDIF
          CALL      ARASUP00
          CALL      ARASCD00                * Action Code Description
.
          MATCH     ALAUADAT,SP70        
          GOTO      ARAS9999 IF EQUAL
.
          UNPACK    ALAUADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      SP70,KEY11
          REP       " 0",CYEAR
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ARAS0010
          ENDIF
.  
          WRITE     HTMLFILE;"<tr>":
                      "<td>&nbsp;",WBSENAM,"</td> ":
                      "<td>&nbsp;",KEY11," at ",ALAUATIM,"</td>":
                      "<td>&nbsp;",TDESC,"</td>":
                      "<td>&nbsp;",ALUPDATE,"</td>":
                      "<td>&nbsp;",ALAUCOMM,"</td>":
                      "</tr>"
.
          ADD       ONE,DISNUMB
.
          COMPARE   NORECORD,DISNUMB
          GOTO      ARAS0010 IF NOT EQUAL
.
ARAS9999  RETURN
.
.------------------------------------------------------------------------------
. Display the Referral Audit data
.------------------------------------------------------------------------------
AURE0000  PACK      KEY27,ADMISSNO,SP70
          CALL      ASALRE2                 * positional read
AURE0010  CALL      AKALRE2                 * read a record
          BRANCH    OVRCD,AURE9999
.
          MATCH     ALREVISN,ADMISSNO
          GOTO      AURE9999 IF NOT EQUAL
.
          MOVE      ALREAUDO,PASCDEIN
          CALL      GUSRPA00
          MOVE      PASCDEOU,WBSENAM
.
          UNPACK    ALREAUDD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      SP70,KEY11
          REP       " 0",CYEAR
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      DATETIME,ALREAUDD,ALREAUDT
.
          CLEAR     HTMLLINK
          APPEND    "javascript:RefAuditLink('",HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREAUDD,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREAUDT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREAUDP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREAUDR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREAUDO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,RECTYPE 
          MATCH     "A",ALREAUDR
          IF        @EQUAL
            MOVE      "Added Record",RECTYPE
          ENDIF
          MATCH     "B",ALREAUDR
          IF        @EQUAL
            MOVE      "Before Change",RECTYPE
          ENDIF
          MATCH     "C",ALREAUDR
          IF        @EQUAL
            MOVE      "After Change",RECTYPE
          ENDIF
          MATCH     "D",ALREAUDR
          IF        @EQUAL
            MOVE      "Deleted Record",RECTYPE
          ENDIF
.
AURE5000  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              *0
                                       "#"",WBSENAM,"#",":              *1
                                       "#"",DATETIME,"#",":             *2
                                       "#"",RECTYPE,"#",":              *3
                                       "#"","","#");"                   *4
.
          GOTO      AURE0010
.
AURE9999  RETURN
.
.------------------------------------------------------------------------------
. Routine to retrieve and display the Referral Audit data
.------------------------------------------------------------------------------
AUREC000  MOVE      ZERO,CTR
          MOVE      ZERO,AURECNT   
          CALL      IAURE000
.
          PACK      KEY27,ADMISSNO,CHNGDATE,CHNGTIME,CHNGPORT,CHNGTYPE,SP70
          CALL      ARALRE2                 * read a record
          BRANCH    OVRCD,AUREC999
.
          MATCH     ADMISSNO,ALREVISN
          GOTO      AUREC999 IF NOT EQUAL
.
          MATCH     CHNGDATE,ALREAUDD
          GOTO      AUREC999 IF NOT EQUAL
.
          MATCH     CHNGTIME,ALREAUDT
          GOTO      AUREC999 IF NOT EQUAL
.
          MATCH     CHNGPORT,ALREAUDP
          GOTO      AUREC999 IF NOT EQUAL
.
          MATCH     CHNGTYPE,ALREAUDR
          GOTO      AUREC999 IF NOT EQUAL
.
          MATCH     CHNGOPER,ALREAUDO
          GOTO      AUREC999 IF NOT EQUAL
.
. A Record
.
          MATCH     ANSA,CHNGTYPE
          IF        @EQUAL
            MOVE      ONE,CTR
            CALL      AUREMF00
            CALL      AUREDS00
            GOTO      AUREC999
          ENDIF
.
. D Record
.
          MATCH     ANSD,CHNGTYPE
          IF        @EQUAL
            MOVE      ONE,CTR
            CALL      AUREMF00
            CALL      AUREDS00
            GOTO      AUREC999
          ENDIF
.
. B Record
.
          MATCH     ANSB,CHNGTYPE
          GOTO      AUREC050 IF NOT EQUAL
.
          MOVE      ONE,CTR
          CALL      AUREMF00
.
. B record found so try to find the C record
.
          MOVE      TWO,CTR        
          CALL      AUREFC00  
.    
          CALL      AUREDS00
          GOTO      AUREC999       
.
. C Record
.
AUREC050  MATCH     ANSC,CHNGTYPE
          GOTO      AUREC999 IF NOT EQUAL
.
          MOVE      TWO,CTR
          CALL      AUREMF00
.
. C record found so try to find the B record
.
          MOVE      ONE,CTR 
          CALL      AUREFB00        
.
          CALL      AUREDS00
          GOTO      AUREC999
.
AUREC999  RETURN
.
.------------------------------------------------------------------------------
. Find a matching "C" row within 5 seconds  
.------------------------------------------------------------------------------
AUREFC00  MOVE      ANSC,CHKTYPE
          CALL      AUREGT00
.
          MATCH     ANSY,RECFOUND
          IF        @EQUAL
            CALL      AUREMF00
            GOTO      AUREFC99
          ENDIF       
.    
          PACK      KEY27,ADMISSNO,CHNGDATE,CHNGTIME,CHNGPORT,CHNGTYPE,SP70
          CALL      ASALRE2                 * positional read
AUREFC20  CALL      AKALRE2                 * read a record
          BRANCH    OVRCD,AUREFC99
.
          MATCH     ADMISSNO,ALREVISN
          GOTO      AUREFC99 IF NOT EQUAL
.
          MOVE      CHNGDATE,DTFRSDTE
          MOVE      CHNGTIME,DTFRSTIM
          MOVE      ALREAUDD,DTLSTDTE
          MOVE      ALREAUDT,DTLSTTIM
          CALL      TIMEDIFS
.
          COMPARE   ZERO,DTODAYS	
          GOTO      AUREFC99 IF NOT EQUAL	
.	
          COMPARE   ZERO,DTOHOUR	
          GOTO      AUREFC99 IF NOT EQUAL	
.	
          COMPARE   ZERO,DTOMIN
          GOTO      AUREFC99 IF NOT EQUAL	
.	
          COMPARE   SIX,DTOSEC	
          GOTO      AUREFC99 IF NOT LESS	
.
          MATCH     CHNGPORT,ALREAUDP
          GOTO      AUREFC20 IF NOT EQUAL
.
          MATCH     CHNGOPER,ALREAUDO
          GOTO      AUREFC20 IF NOT EQUAL
.           
          MATCH     ANSC,ALREAUDR
          GOTO      AUREFC20 IF NOT EQUAL
.
          CALL      AUREMF00
.
AUREFC99  RETURN
.
.------------------------------------------------------------------------------
. Find a matching "B" row within 5 seconds
.------------------------------------------------------------------------------
AUREFB00  MOVE      ANSB,CHKTYPE
          CALL      AUREGT00
.
          MATCH     ANSY,RECFOUND
          IF        @EQUAL
            CALL      AUREMF00
            GOTO      AUREFB99
          ENDIF
.
          PACK      KEY27,ADMISSNO,CHNGDATE,CHNGTIME,CHNGPORT,CHNGTYPE,SP70
          CALL      ASALRE2                 * positional read
AUREFB20  CALL      APALRE2                 * read a record
          BRANCH    OVRCD,AUREFB99
.
          MATCH     ADMISSNO,ALREVISN
          GOTO      AUREFC99 IF NOT EQUAL
.
          MOVE      ALREAUDD,DTFRSDTE
          MOVE      ALREAUDT,DTFRSTIM
          MOVE      CHNGDATE,DTLSTDTE
          MOVE      CHNGTIME,DTLSTTIM
          CALL      TIMEDIFS
.
          COMPARE   ZERO,DTODAYS
          GOTO      AUREFB99 IF NOT EQUAL
.
          COMPARE   ZERO,DTOHOUR
          GOTO      AUREFB99 IF NOT EQUAL
.
          COMPARE   ZERO,DTOMIN
          GOTO      AUREFB99 IF NOT EQUAL
.
          COMPARE   SIX,DTOSEC
          GOTO      AUREFB99 IF NOT LESS
.
          MATCH     CHNGPORT,ALREAUDP
          GOTO      AUREFB20 IF NOT EQUAL
.
          MATCH     CHNGOPER,ALREAUDO
          GOTO      AUREFB20 IF NOT EQUAL
.
          MATCH     ANSB,ALREAUDR
          GOTO      AUREFB20 IF NOT EQUAL
.
          CALL      AUREMF00
.
AUREFB99  RETURN
.
.------------------------------------------------------------------------------
. Check the matching row for the before and after changes data
.------------------------------------------------------------------------------
AUREGT00  MOVE      ANSN,RECFOUND
          PACK      KEY27,ADMISSNO,CHNGDATE,CHNGTIME,CHNGPORT,CHKTYPE,SP70
          CALL      ARALRE2                 * read a record
          BRANCH    OVRCD,AUREGT99
.
          MATCH     ADMISSNO,ALREVISN
          GOTO      AUREGT99 IF NOT EQUAL
.
          MATCH     CHNGDATE,ALREAUDD
          GOTO      AUREGT99 IF NOT EQUAL
.
          MATCH     CHNGTIME,ALREAUDT
          GOTO      AUREGT99 IF NOT EQUAL
.
          MATCH     CHNGPORT,ALREAUDP
          GOTO      AUREGT99 IF NOT EQUAL
.
          MATCH     CHKTYPE,ALREAUDR
          GOTO      AUREGT99 IF NOT EQUAL
.
          MATCH     CHNGOPER,ALREAUDO
          GOTO      AUREGT99 IF NOT EQUAL
.
          MOVE      ANSY,RECFOUND
.
AUREGT99  RETURN
.
.------------------------------------------------------------------------------
. Display the Referral Audit data
.------------------------------------------------------------------------------
AUREDS00  IF        AUREARCT = 0
            GOTO      AUREDS99
          ENDIF
.
          MOVE      ZERO,F3
AUREDS20  ADD       ONE,F3
          IF        F3 > AUREARCT
            GOTO      AUREDS99
          ENDIF
.
          PACK      TEXT100B,SP70,SP70
          PACK      TEXT100A,SP70,SP70
.
          IF        AURECNT = 1
            MOVE      AUREBEAR[F3],TEXT100B
            MOVE      AUREAFAR[F3],TEXT100A
            GOTO      AUREDS50
          ENDIF
.
          MATCH     AUREBEAR[F3],AUREAFAR[F3]
          IF        !@EQUAL
            CLEAR     TEXT100B
            APPEND    "<font color=blue>",TEXT100B
            APPEND    AUREBEAR[F3],TEXT100B
            APPEND    "</font>",TEXT100B
            RESET     TEXT100B 
            CLEAR     TEXT100A
            APPEND    "<font color=Red>",TEXT100A
            APPEND    AUREAFAR[F3],TEXT100A
            APPEND    "</font>",TEXT100A
            RESET     TEXT100A
          ELSE
            MOVE      AUREBEAR[F3],TEXT100B
            MOVE      AUREAFAR[F3],TEXT100A
          ENDIF 
.
AUREDS50  WRITE     HTMLFILE;"t.addRow(#"",F3,"#",":                    *0
                                      "#"<b>",AURENAAR[F3],"</b>#",":   *1
                                      "#"",AUREDSAR[F3],"#",":          *1
                                      "#"",TEXT100B,"#",":              *2
                                      "#"",TEXT100A,"#");"              *3
          GOTO      AUREDS20
.
AUREDS99  RETURN
.
.------------------------------------------------------------------------------
. Move audit field/value data to arrays
.------------------------------------------------------------------------------
AUREMF00  ADD       ONE,AURECNT
          MOVE      ZERO,AUREARCT
.
          MOVE      "ALREAUDD",FLDNAME
          MOVE      "Date of Change",FLDDESC
          MOVE      ALREAUDD,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00                     * Add to arrays
.
          MOVE      "ALREAUDT",FLDNAME
          MOVE      "Time of Change",FLDDESC
          MOVE      ALREAUDT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREAUDR",FLDNAME
          MOVE      "Record Type",FLDDESC
          MOVE      ALREAUDR,FLDVALUE
.
          MATCH     "A",ALREAUDR
          IF        @EQUAL
            MOVE      "Added Record",FLDVALUE
            GOTO      AUREMF10
          ENDIF
          MATCH     "B",ALREAUDR
          IF        @EQUAL
            MOVE      "Before Change",FLDVALUE
            GOTO      AUREMF10
          ENDIF
          MATCH     "C",ALREAUDR
          IF        @EQUAL
            MOVE      "After Change",FLDVALUE
            GOTO      AUREMF10
          ENDIF
          MATCH     "D",ALREAUDR
          IF        @EQUAL
            MOVE      "Deleted Record",FLDVALUE
            GOTO      AUREMF10
          ENDIF
.
AUREMF10  CALL      AUREAD00                   
.
          MOVE      "ALREAUDS",FLDNAME
          MOVE      "Record Status",FLDDESC
          MOVE      ALREAUDS,FLDVALUE
.
          COMPARE   ONE,ALREAUDS
          IF        @EQUAL
            MOVE      "Not Printed",FLDVALUE
            GOTO      AUREMF11
          ENDIF
          COMPARE   TWO,ALREAUDS
          IF        @EQUAL
            MOVE      "Printed",FLDVALUE
            GOTO      AUREMF11
          ENDIF
.
AUREMF11  CALL      AUREAD00
.
          MOVE      "ALREAUDO",FLDNAME
          MOVE      "User",FLDDESC
          MOVE      ALREAUDO,PASCDEIN
          CALL      GUSRPA00
          MOVE      PASCDEOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREVISN",FLDNAME
          MOVE      "Referral/Visit Number",FLDDESC
          MOVE      ALREVISN,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREURNO",FLDNAME
          MOVE      "U/R Number",FLDDESC
          MOVE      ALREURNO,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRESTAT",FLDNAME
          MOVE      "Status",FLDDESC
          MOVE      ALRESTAT,FLDVALUE 
.
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            MOVE      "On Waiting List",FLDVALUE
            GOTO      AUREMF20
          ENDIF
          MATCH     "1",ALRESTAT
          IF        @EQUAL
            MOVE      "Active",FLDVALUE
            GOTO      AUREMF20
          ENDIF
          MATCH     "2",ALRESTAT
          IF        @EQUAL
            MOVE      "Closed",FLDVALUE
            GOTO      AUREMF20
          ENDIF
          MATCH     "3",ALRESTAT
          IF        @EQUAL
            MOVE      "Inactive",FLDVALUE
            GOTO      AUREMF20
          ENDIF
          MATCH     "4",ALRESTAT
          IF        @EQUAL
            MOVE      "Cancelled",FLDVALUE
            GOTO      AUREMF20
          ENDIF
          MATCH     "5",ALRESTAT
          IF        @EQUAL
            MOVE      "Rejected",FLDVALUE
            GOTO      AUREMF20
          ENDIF
.
AUREMF20  CALL      AUREAD00
.
          MOVE      "ALREDACT",FLDNAME
          MOVE      "Date Active (CCYYMMDD)",FLDDESC
          MOVE      ALREDACT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRELINK",FLDNAME
          MOVE      "Linked Visit Number",FLDDESC
          MOVE      ALRELINK,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Reason for Closure",GPATDDSC
          MOVE      "ALRERCLO",FLDNAME
          MOVE      "LL",GPATCAT
          MOVE      ALRERCLO,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREDCLO",FLDNAME
          MOVE      "Date Closed (CCYYMMDD)",FLDDESC
          MOVE      ALREDCLO,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRETCLO",FLDNAME
          MOVE      "Time Closed (HH:MM:SS)",FLDDESC
          MOVE      ALRETCLO,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUCLO",FLDNAME
          MOVE      "WEB User ID Closed (websecaf)",FLDDESC
          MOVE      ALREUCLO,USERIDIN
          CALL      GUSRDS00
          MOVE      USERIDOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Reason Cancelled",GPATDDSC
          MOVE      "ALRERCAN",FLDNAME
          MOVE      "LN",GPATCAT
          MOVE      ALRERCAN,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREDCAN",FLDNAME
          MOVE      "Date Cancelled (CCYYMMDD)",FLDDESC
          MOVE      ALREDCAN,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRETCAN",FLDNAME
          MOVE      "Time Cancelled (HH:MM:SS)",FLDDESC
          MOVE      ALRETCAN,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUCAN",FLDNAME
          MOVE      "WEB User ID Cancelled (websecaf)",FLDDESC
          MOVE      ALREUCAN,USERIDIN
          CALL      GUSRDS00
          MOVE      USERIDOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Reason Inactive",GPATDDSC
          MOVE      "ALRERINA",FLDNAME
          MOVE      "LI",GPATCAT
          MOVE      ALRERINA,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREDINA",FLDNAME
          MOVE      "Date Inactive (CCYYMMDD)",FLDDESC
          MOVE      ALREDINA,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRETINA",FLDNAME
          MOVE      "Time Inactive (HH:MM:SS)",FLDDESC
          MOVE      ALRETINA,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDINU",FLDNAME
          MOVE      "Date Inactive Until (CCYYMMDD)",FLDDESC
          MOVE      ALREDINU,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUINA",FLDNAME
          MOVE      "WEB User ID Inactive (websecaf)",FLDDESC
          MOVE      ALREUINA,USERIDIN
          CALL      GUSRDS00
          MOVE      USERIDOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRERDAT",FLDNAME
          MOVE      "Date of Referral (CCYYMMDD)",FLDDESC
          MOVE      ALRERDAT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRERDEP",FLDNAME
          MOVE      "Referred to Department (alldepaf)",FLDDESC
          MOVE      ALRERDEP,GDEPCODE
          CALL      GDEPDS00
          MOVE      GDEPDESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRERDOC",FLDNAME
          MOVE      "Referred by Doctor (DO NOT USE)",FLDDESC
          MOVE      ALRERDOC,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRERHCP",FLDNAME
          MOVE      "Referring HCP (pmshcpaf)",FLDDESC
          MOVE      ALRERHCP,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRERHCR",FLDNAME
          MOVE      "Referring Practice (pmshclaf)",FLDDESC
          MOVE      ALRERHCR,GPRCCODE
          MOVE      ALRERHCT,GPRCCOUN
          CALL      GPRCNM00
          MOVE      GPRCNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRERHCT",FLDNAME
          MOVE      "Referring Group Count (pmshcgaf)",FLDDESC
          MOVE      ALRERHCT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDEPT",FLDNAME
          MOVE      "Department Code (alldepaf)",FLDDESC
          MOVE      ALREDEPT,GDEPCODE
          CALL      GDEPDS00
          MOVE      GDEPDESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Unit/Specialty",GPATDDSC
          MOVE      "ALREUNIT",FLDNAME
          MOVE      "AC",GPATCAT
          MOVE      ALREUNIT,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "Priority",GPATDDSC
          MOVE      "ALREPRTY",FLDNAME
          MOVE      "PR",GPATCAT
          MOVE      ALREPRTY,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREPRO1",FLDNAME
          MOVE      "Problem Code 1 (allprraf)",FLDDESC
          MOVE      ALREDEPT,GPRBDEPT
          MOVE      ALREPRO1,GPRBCODE
          CALL      GPRBDS00
          MOVE      GPRBDESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRO2",FLDNAME
          MOVE      "Problem Code 2 (allprraf)",FLDDESC
          MOVE      ALREDEPT,GPRBDEPT
          MOVE      ALREPRO2,GPRBCODE
          CALL      GPRBDS00
          MOVE      GPRBDESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRO3",FLDNAME
          MOVE      "Problem Code 3 (allprraf)",FLDDESC
          MOVE      ALREDEPT,GPRBDEPT
          MOVE      ALREPRO3,GPRBCODE
          CALL      GPRBDS00
          MOVE      GPRBDESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDIA1",FLDNAME
          MOVE      "Diagnosis Code 1 (alldiaaf)",FLDDESC
          MOVE      ALREDEPT,GDIADEPT
          MOVE      ALREDIA1,GDIACODE
          CALL      GDIADS00
          MOVE      GDIADESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDIA2",FLDNAME
          MOVE      "Diagnosis Code 2 (alldiaaf)",FLDDESC
          MOVE      ALREDEPT,GDIADEPT
          MOVE      ALREDIA2,GDIACODE
          CALL      GDIADS00
          MOVE      GDIADESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDIA3",FLDNAME
          MOVE      "Diagnosis Code 3 (alldiaaf)",FLDDESC
          MOVE      ALREDEPT,GDIADEPT
          MOVE      ALREDIA3,GDIACODE
          CALL      GDIADS00
          MOVE      GDIADESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRESRCE",FLDNAME
          MOVE      "Source of Referral(ostcatg.outsitaf)",FLDDESC
          MOVE      ALRESRCE,FLDVALUE
.
          MATCH     SP70,ALRESRCE
          GOTO      AUREMF30 IF EQUAL
          MATCH     SP70,ALREPSIT
          GOTO      AUREMF30 IF EQUAL
.
          PACK      KEY6,ALREPSIT,SP70
          CALL      RDSITA1
          BRANCH    OVRCD,AUREMF30
.
          MATCH     SP70,OSTCATG
          GOTO      AUREMF30 IF EQUAL
.
          PACK      KEY5,OSTCATG,ALRESRCE
          CALL      RDCODE1
          BRANCH    OVRCD,AUREMF30
          MOVE      TDESC,FLDVALUE
.
AUREMF30  CALL      AUREAD00
.
          MOVE      "Compensation Code",GPATDDSC
          MOVE      "ALRECOMP",FLDNAME
          MOVE      "CL",GPATCAT
          MOVE      ALRECOMP,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREBULK",FLDNAME
          MOVE      "Bulk Bill (0=No,1=Yes)",FLDDESC
          MOVE      ALREBULK,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDREV",FLDNAME
          MOVE      "Date of Next Review (CCYYMMDD)",FLDDESC
          MOVE      ALREDREV,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCP",FLDNAME
          MOVE      "Responsible HCP (pmshcpaf)",FLDDESC
          MOVE      ALREHCP,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDREC",FLDNAME
          MOVE      "Date Referral Received (CCYYMMDD)",FLDDESC
          MOVE      ALREDREC,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "User Defined Code 1",GPATDDSC
          MOVE      "ALREUC01",FLDNAME
          MOVE      "la",GPATCAT
          MOVE      ALREUC01,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 2",GPATDDSC
          MOVE      "ALREUC02",FLDNAME
          MOVE      "lb",GPATCAT
          MOVE      ALREUC02,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 3",GPATDDSC
          MOVE      "ALREUC03",FLDNAME
          MOVE      "lc",GPATCAT
          MOVE      ALREUC03,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 4",GPATDDSC
          MOVE      "ALREUC04",FLDNAME
          MOVE      "ld",GPATCAT
          MOVE      ALREUC04,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 5",GPATDDSC
          MOVE      "ALREUC05",FLDNAME
          MOVE      "le",GPATCAT
          MOVE      ALREUC05,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 6",GPATDDSC
          MOVE      "ALREUC06",FLDNAME
          MOVE      "lf",GPATCAT
          MOVE      ALREUC06,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 7",GPATDDSC
          MOVE      "ALREUC07",FLDNAME
          MOVE      "lg",GPATCAT
          MOVE      ALREUC07,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 8",GPATDDSC
          MOVE      "ALREUC08",FLDNAME
          MOVE      "lh",GPATCAT
          MOVE      ALREUC08,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 9",GPATDDSC
          MOVE      "ALREUC09",FLDNAME
          MOVE      "li",GPATCAT
          MOVE      ALREUC09,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 10",GPATDDSC
          MOVE      "ALREUC10",FLDNAME
          MOVE      "lj",GPATCAT
          MOVE      ALREUC10,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 11",GPATDDSC
          MOVE      "ALREUC11",FLDNAME
          MOVE      "lk",GPATCAT
          MOVE      ALREUC11,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 12",GPATDDSC
          MOVE      "ALREUC12",FLDNAME
          MOVE      "ll",GPATCAT
          MOVE      ALREUC12,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 13",GPATDDSC
          MOVE      "ALREUC13",FLDNAME
          MOVE      "lm",GPATCAT
          MOVE      ALREUC13,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 14",GPATDDSC
          MOVE      "ALREUC14",FLDNAME
          MOVE      "ln",GPATCAT
          MOVE      ALREUC14,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 15",GPATDDSC
          MOVE      "ALREUC15",FLDNAME
          MOVE      "lo",GPATCAT
          MOVE      ALREUC15,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 16",GPATDDSC
          MOVE      "ALREUC16",FLDNAME
          MOVE      "lp",GPATCAT
          MOVE      ALREUC16,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 17",GPATDDSC
          MOVE      "ALREUC17",FLDNAME
          MOVE      "lq",GPATCAT
          MOVE      ALREUC17,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 18",GPATDDSC
          MOVE      "ALREUC18",FLDNAME
          MOVE      "lr",GPATCAT
          MOVE      ALREUC18,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 19",GPATDDSC
          MOVE      "ALREUC19",FLDNAME
          MOVE      "ls",GPATCAT
          MOVE      ALREUC19,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 20",GPATDDSC
          MOVE      "ALREUC20",FLDNAME
          MOVE      "lt",GPATCAT
          MOVE      ALREUC20,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 21",GPATDDSC
          MOVE      "ALREUC21",FLDNAME
          MOVE      "lu",GPATCAT
          MOVE      ALREUC21,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 22",GPATDDSC
          MOVE      "ALREUC22",FLDNAME
          MOVE      "lv",GPATCAT
          MOVE      ALREUC22,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 23",GPATDDSC
          MOVE      "ALREUC23",FLDNAME
          MOVE      "lw",GPATCAT
          MOVE      ALREUC23,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 24",GPATDDSC
          MOVE      "ALREUC24",FLDNAME
          MOVE      "lx",GPATCAT
          MOVE      ALREUC24,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 25",GPATDDSC
          MOVE      "ALREUC25",FLDNAME
          MOVE      "ly",GPATCAT
          MOVE      ALREUC25,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 26",GPATDDSC
          MOVE      "ALREUC26",FLDNAME
          MOVE      "lz",GPATCAT
          MOVE      ALREUC26,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 27",GPATDDSC
          MOVE      "ALREUC27",FLDNAME
          MOVE      "lA",GPATCAT
          MOVE      ALREUC27,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 28",GPATDDSC
          MOVE      "ALREUC28",FLDNAME
          MOVE      "lB",GPATCAT
          MOVE      ALREUC28,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 29",GPATDDSC
          MOVE      "ALREUC29",FLDNAME
          MOVE      "lC",GPATCAT
          MOVE      ALREUC29,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 30",GPATDDSC
          MOVE      "ALREUC30",FLDNAME
          MOVE      "lD",GPATCAT
          MOVE      ALREUC30,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 31",GPATDDSC
          MOVE      "ALREUC31",FLDNAME
          MOVE      "lE",GPATCAT
          MOVE      ALREUC31,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 32",GPATDDSC
          MOVE      "ALREUC32",FLDNAME
          MOVE      "lO",GPATCAT
          MOVE      ALREUC32,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 33",GPATDDSC
          MOVE      "ALREUC33",FLDNAME
          MOVE      "lG",GPATCAT
          MOVE      ALREUC33,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 34",GPATDDSC
          MOVE      "ALREUC34",FLDNAME
          MOVE      "lH",GPATCAT
          MOVE      ALREUC34,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 35",GPATDDSC
          MOVE      "ALREUC35",FLDNAME
          MOVE      "lI",GPATCAT
          MOVE      ALREUC35,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 36",GPATDDSC
          MOVE      "ALREUC36",FLDNAME
          MOVE      "lJ",GPATCAT
          MOVE      ALREUC36,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 37",GPATDDSC
          MOVE      "ALREUC37",FLDNAME
          MOVE      "lK",GPATCAT
          MOVE      ALREUC37,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 38",GPATDDSC
          MOVE      "ALREUC38",FLDNAME
          MOVE      "lL",GPATCAT
          MOVE      ALREUC38,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 39",GPATDDSC
          MOVE      "ALREUC39",FLDNAME
          MOVE      "lM",GPATCAT
          MOVE      ALREUC39,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "User Defined Code 40",GPATDDSC
          MOVE      "ALREUC40",FLDNAME
          MOVE      "lN",GPATCAT
          MOVE      ALREUC40,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREUYN1",FLDNAME
          MOVE      "User Defined Y/N 1 (0=No,1=Yes",FLDDESC
          MOVE      ALREUYN1,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN2",FLDNAME
          MOVE      "User Defined Y/N 2 (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN2,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN3",FLDNAME
          MOVE      "User Defined Y/N 3 (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN3,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN4",FLDNAME
          MOVE      "SACS/Primary Referral (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN4,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC1",FLDNAME
          MOVE      "User Defined HCP 1 (pmshcpaf)",FLDDESC
          MOVE      ALREUHC1,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC2",FLDNAME
          MOVE      "User Defined HCP 2 (pmshcpaf)",FLDDESC
          MOVE      ALREUHC2,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC3",FLDNAME
          MOVE      "User Defined HCP 3 (pmshcpaf)",FLDDESC
          MOVE      ALREUHC3,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC4",FLDNAME
          MOVE      "HCP Case Team Code (allcasaf)",FLDDESC
          MOVE      ALREUHC4,GTEACODE
          CALL      GTEADS00
          MOVE      GTEADESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUFR1",FLDNAME
          MOVE      "User Defined Free Format 1",FLDDESC
          MOVE      ALREUFR1,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUFR2",FLDNAME
          MOVE      "User Defined Free Format 2",FLDDESC
          MOVE      ALREUFR2,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT1",FLDNAME
          MOVE      "User Defined Date 1 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT1,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM1",FLDNAME
          MOVE      "User Defined Time 1 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM1,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT2",FLDNAME
          MOVE      "Episode Patient Ready for Care Date",FLDDESC
          MOVE      ALREUDT2,DATEIN
          CALL      CNVDTE00
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM2",FLDNAME
          MOVE      "User Defined Time 2 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM2,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT3",FLDNAME
          MOVE      "User Defined Date 3 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT3,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM3",FLDNAME
          MOVE      "User Defined Time 3 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM3,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT4",FLDNAME
          MOVE      "User Defined Date 4 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT4,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM4",FLDNAME
          MOVE      "User Defined Time 4 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM4,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUNO1",FLDNAME
          MOVE      "User Defined Numeric 1",FLDDESC
          MOVE      ALREUNO1,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUNO2",FLDNAME
          MOVE      "Job Number (Orthotics)",FLDDESC
          MOVE      ALREUNO2,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRECDAT",FLDNAME
          MOVE      "Date Record Created (CCYYMMDD)",FLDDESC
          MOVE      ALRECDAT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRECTIM",FLDNAME
          MOVE      "Time Record Created (HH:MM:SS)",FLDDESC
          MOVE      ALRECTIM,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRECUID",FLDNAME
          MOVE      "WEB User ID Created (websecaf)",FLDDESC
          MOVE      ALRECUID,USERIDIN
          CALL      GUSRDS00
          MOVE      USERIDOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDAT",FLDNAME
          MOVE      "Update Date (CCYYMMDD)",FLDDESC
          MOVE      ALREUDAT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTIM",FLDNAME
          MOVE      "Update Time (HH:MM:SS)",FLDDESC
          MOVE      ALREUTIM,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUUID",FLDNAME
          MOVE      "WEB User ID Updated (websecaf)",FLDDESC
          MOVE      ALREUUID,USERIDIN
          CALL      GUSRDS00
          MOVE      USERIDOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRECTYP",FLDNAME
          MOVE      "Clinic Type",FLDDESC
          MOVE      ALRECTYP,FLDVALUE
.
          MATCH     SP70,ALRECTYP
          IF        !@EQUAL
            CALL      COTFIL00
            PACK      KEY12,ALREPSIT,ALRECTYP,SP70
            CALL      RDCTYA1
            IF        OVRCD = 0
              MOVE      OCTDESC,FLDVALUE
             ENDIF
          ENDIF 
.
          CALL      AUREAD00
.
          MOVE      "ALREHOSN",FLDNAME
          MOVE      "Hospital/Unit Number",FLDDESC
          MOVE      ALREHOSN,GHSPCODE
          CALL      GHSPNM00
          MOVE      GHSPNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCP1",FLDNAME
          MOVE      "Referring HCP Addr 1 (Free Format)",FLDDESC
          MOVE      ALREHCP1,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCP2",FLDNAME
          MOVE      "Referring HCP Addr 2 (Free Format)",FLDDESC
          MOVE      ALREHCP2,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCP3",FLDNAME
          MOVE      "Referring HCP Addr 3 (Free Format)",FLDDESC
          MOVE      ALREHCP3,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCPC",FLDNAME
          MOVE      "Referring HCP State (Free Format)",FLDDESC
          MOVE      ALREHCPC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCPS",FLDNAME
          MOVE      "Referring HCP Post Code (Free Frm)",FLDDESC
          MOVE      ALREHCPS,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCPB",FLDNAME
          MOVE      "Referring HCP Bus. Phone (Free Frm)",FLDDESC
          MOVE      ALREHCPB,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCPF",FLDNAME
          MOVE      "Referring HCP Bus. Fax (Free Frm)",FLDDESC
          MOVE      ALREHCPF,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREHCPP",FLDNAME
          MOVE      "Referring HCP Prov.Numb. (Free Frm)",FLDDESC
          MOVE      ALREHCPP,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Slot Type",GPATDDSC
          MOVE      "ALRESTYP",FLDNAME
          MOVE      "CV",GPATCAT
          MOVE      ALRESTYP,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREPRCM",FLDNAME
          MOVE      "Presenting Complaint (Free Format)",FLDDESC
          MOVE      ALREPRCM,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPSIT",FLDNAME
          MOVE      "Preferred Site",FLDDESC
          MOVE      ALREPSIT,FLDVALUE
.
          MATCH     SP70,ALREPSIT
          GOTO      AUREMF50 IF EQUAL
.
          PACK      KEY6,ALREPSIT,SP70
          CALL      RDSITA1
          IF        OVRCD=0
            MOVE      OSTDESC,FLDVALUE
          ENDIF
.
AUREMF50  CALL      AUREAD00
.
          MOVE      "ALRECLID",FLDNAME
          MOVE      "Clinic ID",FLDDESC
          MOVE      ALRECLID,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Claim Status",GPATDDSC
          MOVE      "ALRECSTA",FLDNAME
          MOVE      "sc",GPATCAT
          MOVE      ALRECSTA,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "HIC Reason for Rejection",GPATDDSC
          MOVE      "ALRERREJ",FLDNAME
          MOVE      "hr",GPATCAT
          MOVE      ALRERREJ,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALRECCOM",FLDNAME
          MOVE      "Claim Comments (Free Format)",FLDDESC
          MOVE      ALRECCOM,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Type of Referral",GPATDDSC
          MOVE      "ALRERTYP",FLDNAME
          MOVE      "RI",GPATCAT
          MOVE      ALRERTYP,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREREXP",FLDNAME
          MOVE      "Referral Expiry Date (ccyymmdd)",FLDDESC
          MOVE      ALREREXP,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREMDAT",FLDNAME
          MOVE      "Must Be Seen By Date (ccyymmdd)",FLDDESC
          MOVE      ALREMDAT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRDT",FLDNAME
          MOVE      "Priority Date (CCYYMMDD)",FLDDESC
          MOVE      ALREPRDT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ACS Reason for Rejection",GPATDDSC
          MOVE      "ALRESREJ",FLDNAME
          MOVE      "rr",GPATCAT
          MOVE      ALRESREJ,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALRESRDT",FLDNAME
          MOVE      "SACS Date Rejected (CCYYMMDD)",FLDDESC
          MOVE      ALRESRDT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRESRTM",FLDNAME
          MOVE      "SACS Time Rejected (hh:mm:ss)",FLDDESC
          MOVE      ALRESRTM,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRESRUI",FLDNAME
          MOVE      "SACS WEB User Rejected (websecaf)",FLDDESC
          MOVE      ALRESRUI,USERIDIN
          CALL      GUSRDS00
          MOVE      USERIDOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT5",FLDNAME
          MOVE      "User Defined Date 5 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT5,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM5",FLDNAME
          MOVE      "User Defined Time 5 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM5,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN5",FLDNAME
          MOVE      "User Defined Y/N 5 (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN5,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDID",FLDNAME
          MOVE      "User Defined User ID 1 (websecaf)",FLDDESC
          MOVE      ALREUDID,USERIDIN
          CALL      GUSRDS00
          MOVE      USERIDOU,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT6",FLDNAME
          MOVE      "User Defined Date 6 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT6,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM6",FLDNAME
          MOVE      "User Defined Time 6 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM6,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN6",FLDNAME
          MOVE      "User Defined Y/N 6 (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN6,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREREVD",FLDNAME
          MOVE      "Case Review Date (CCYYMMDD)",FLDDESC
          MOVE      ALREREVD,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Purchaser",GPATDDSC
          MOVE      "ALREPURC",FLDNAME
          MOVE      "HP",GPATCAT
          MOVE      ALREPURC,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "Outcome of Priority",GPATDDSC
          MOVE      "ALREOUTP",FLDNAME
          MOVE      "AO",GPATCAT
          MOVE      ALREOUTP,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "Contract",GPATDDSC
          MOVE      "ALRECONT",FLDNAME
          MOVE      "gb",GPATCAT
          MOVE      ALRECONT,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALRESCOR",FLDNAME
          MOVE      "Score",FLDDESC
          MOVE      ALRESCOR,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREMOHR",FLDNAME
          MOVE      "MOH Indicator Record sent to MHINC",FLDDESC
          MOVE      ALREMOHR,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Event Program",GPATDDSC
          MOVE      "ALREEVPR",FLDNAME
          MOVE      "zG",GPATCAT
          MOVE      ALREEVPR,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          MOVE      "Event Program (Cat zG)",FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREDIAT",FLDNAME
          MOVE      "Diagnosis Code Free Text",FLDDESC
          MOVE      ALREDIAT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN7",FLDNAME
          MOVE      "User Defined Y/N 7 (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN7,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN8",FLDNAME
          MOVE      "User Defined Y/N 8 (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN8,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUYN9",FLDNAME
          MOVE      "User Defined Y/N 9 (0=No,1=Yes)",FLDDESC
          MOVE      ALREUYN9,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUCD1",FLDNAME
          MOVE      "User Defined Code 1 (0 to 9)",FLDDESC
          MOVE      ALREUCD1,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUCD2",FLDNAME
          MOVE      "User Defined Code 2 (0 to 9)",FLDDESC
          MOVE      ALREUCD2,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUCD3",FLDNAME
          MOVE      "User Defined Code 3 (0 to 9)",FLDDESC
          MOVE      ALREUCD3,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREORIG",FLDNAME
          MOVE      "Referral Originator",FLDDESC
          MOVE      ALREORIG,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREYN10",FLDNAME
          MOVE      "User Defined Y/N 10 (0=No,1=Yes)",FLDDESC
          MOVE      ALREYN10,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREYN11",FLDNAME
          MOVE      "User Defined Y/N 11 (0=No,1=Yes)",FLDDESC
          MOVE      ALREYN11,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREYN12",FLDNAME
          MOVE      "User Defined Y/N 12 (0=No,1=Yes)",FLDDESC
          MOVE      ALREYN12,FLAGIN
          CALL      CNVFLG00
          MOVE      FLAGOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT7",FLDNAME
          MOVE      "User Defined Date 7 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT7,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM7",FLDNAME
          MOVE      "User Defined Time 7 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM7,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT8",FLDNAME
          MOVE      "User Defined Date 8 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT8,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM8",FLDNAME
          MOVE      "User Defined Time 8 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM8,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUDT9",FLDNAME
          MOVE      "User Defined Date 9 (CCYYMMDD)",FLDDESC
          MOVE      ALREUDT9,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUTM9",FLDNAME
          MOVE      "User Defined Time 9 (HH:MM:SS)",FLDDESC
          MOVE      ALREUTM9,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREEIOD",FLDNAME
          MOVE      "Impairment Onset Date (CCYYMMDD)",FLDDESC
          MOVE      ALREEIOD,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREACDD",FLDNAME
          MOVE      "Adv. Care Plan Doc. Date (CCYYMMDD)",FLDDESC
          MOVE      ALREACDD,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUD10",FLDNAME
          MOVE      "User Defined Date 10 (CCYYMMDD)",FLDDESC
          MOVE      ALREUD10,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRENVIN",FLDNAME
          MOVE      "Is a Non-VINAH Referral?",FLDDESC
          MOVE      ALRENVIN,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC5",FLDNAME
          MOVE      "User Defined HCP 5 (pmshcpaf)",FLDDESC
          MOVE      ALREUHC5,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC6",FLDNAME
          MOVE      "User Defined HCP 6 (pmshcpaf)",FLDDESC
          MOVE      ALREUHC6,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC7",FLDNAME
          MOVE      "User Defined HCP 7 (pmshcpaf)",FLDDESC
          MOVE      ALREUHC7,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUHC8",FLDNAME
          MOVE      "User Defined HCP 8 (pmshcpaf)",FLDDESC
          MOVE      ALREUHC8,DOCTCODE
          CALL      GHCPNM00
          MOVE      DOCFNAME,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALRERRDT",FLDNAME
          MOVE      "Referral Renewal Date (CCYYMMDD)",FLDDESC
          MOVE      ALRERRDT,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDIA4",FLDNAME
          MOVE      "Diagnosis Code 4 (alldiaaf)",FLDDESC
          MOVE      ALREDEPT,GDIADEPT
          MOVE      ALREDIA4,GDIACODE
          CALL      GDIADS00
          MOVE      GDIADESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREDIA5",FLDNAME
          MOVE      "Diagnosis Code 5 (alldiaaf)",FLDDESC
          MOVE      ALREDEPT,GDIADEPT
          MOVE      ALREDIA5,GDIACODE
          CALL      GDIADS00
          MOVE      GDIADESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRC1",FLDNAME
          MOVE      "Procedure Code 1 (allproaf)",FLDDESC
          MOVE      ALREDEPT,GPRODEPT
          MOVE      ALREPRC1,GPROCODE
          CALL      GPRODS00
          MOVE      GPRODESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRC2",FLDNAME
          MOVE      "Procedure Code 2 (allproaf)",FLDDESC
          MOVE      ALREDEPT,GPRODEPT
          MOVE      ALREPRC2,GPROCODE
          CALL      GPRODS00
          MOVE      GPRODESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRC3",FLDNAME
          MOVE      "Procedure Code 3 (allproaf)",FLDDESC
          MOVE      ALREDEPT,GPRODEPT
          MOVE      ALREPRC3,GPROCODE
          CALL      GPRODS00
          MOVE      GPRODESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRC4",FLDNAME
          MOVE      "Procedure Code 4 (allproaf)",FLDDESC
          MOVE      ALREDEPT,GPRODEPT
          MOVE      ALREPRC4,GPROCODE
          CALL      GPRODS00
          MOVE      GPRODESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREPRC5",FLDNAME
          MOVE      "Procedure Code 5 (allproaf)",FLDDESC
          MOVE      ALREDEPT,GPRODEPT
          MOVE      ALREPRC5,GPROCODE
          CALL      GPRODS00
          MOVE      GPRODESC,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUD11",FLDNAME
          MOVE      "User Defined Date 11 (CCYYMMDD)",FLDDESC
          MOVE      ALREUD11,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUT11",FLDNAME
          MOVE      "User Defined Time 11 (HH:MM:SS)",FLDDESC
          MOVE      ALREUT11,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUD12",FLDNAME
          CALL      AUREAD00
          MOVE      ALREUD12,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          MOVE      "User Defined Date 12 (CCYYMMDD)",FLDDESC
.
          MOVE      "ALREUT12",FLDNAME
          MOVE      "User Defined Time 12 (HH:MM:SS)",FLDDESC
          MOVE      ALREUT12,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUD13",FLDNAME
          MOVE      "User Defined Date 13 (CCYYMMDD)",FLDDESC
          MOVE      ALREUD13,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUT13",FLDNAME
          MOVE      "User Defined Time 13 (HH:MM:SS)",FLDDESC
          MOVE      ALREUT13,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUD14",FLDNAME
          MOVE      "User Defined Date 14 (CCYYMMDD)",FLDDESC
          MOVE      ALREUD14,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUT14",FLDNAME
          MOVE      "User Defined Time 14 (HH:MM:SS)",FLDDESC
          MOVE      ALREUT14,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUD15",FLDNAME
          MOVE      "User Defined Date 15 (CCYYMMDD)",FLDDESC
          MOVE      ALREUD15,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREUT15",FLDNAME
          MOVE      "User Defined Time 15 (HH:MM:SS)",FLDDESC
          MOVE      ALREUT15,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Current Triage Status",GPATDDSC
          MOVE      "ALRETRGS",FLDNAME
          MOVE      "ts",GPATCAT
          MOVE      ALRETRGS,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALRETRGD",FLDNAME
          MOVE      "Current Triage Date (CCYYMMDD)",FLDDESC
          MOVE      ALRETRGD,DATEIN
          CALL      CNVDTE00 
          MOVE      DATEOUT,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "Referral Override",GPATDDSC
          MOVE      "ALREBKOV",FLDNAME
          MOVE      "ro",GPATCAT
          MOVE      ALREBKOV,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "Referral Period",GPATDDSC
          MOVE      "ALREBKPR",FLDNAME
          MOVE      "RF",GPATCAT
          MOVE      ALREBKPR,GPATCODE
          CALL      GPATCD00   
          MOVE      GPATDESC,FLDVALUE
          MOVE      GPATFDSC,FLDDESC
          CALL      AUREAD00
.
          MOVE      "ALREBKPM",FLDNAME
          MOVE      "Referral Period (Month Range 1-98)",FLDDESC
          MOVE      ALREBKPM,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREBKBA",FLDNAME
          MOVE      "Benefit Assignment Authorised",FLDDESC
          MOVE      ALREBKBA,FLDVALUE
          CALL      AUREAD00
.
          MOVE      "ALREFTSC",FLDNAME
          MOVE      "Referral in First Triage Score",FLDDESC
          MOVE      ALREFTSC,FLDVALUE
          CALL      AUREAD00
.
.
AUREMF99  RETURN
.
.------------------------------------------------------------------------------
. Initialize audit arrays
.------------------------------------------------------------------------------
IAURE000  MOVE      ZERO,F3
.
          REPEAT
            ADD       ONE,F3
            MOVE      SP70,AURENAAR[F3]
            MOVE      SP70,AUREDSAR[F3]
            MOVE      SP70,AUREBEAR[F3]
            MOVE      SP70,AUREAFAR[F3]
          UNTIL       F3 = 300
.
IAURE999  RETURN
.
.------------------------------------------------------------------------------
. Add field data to audit array
.------------------------------------------------------------------------------
AUREAD00  ADD       ONE,AUREARCT
          IF        AUREARCT > 300
            GOTO      AUREAD99
          ENDIF
.
          MOVE      FLDNAME,AURENAAR[AUREARCT]
          MOVE      FLDDESC,AUREDSAR[AUREARCT]
          IF        CTR = 1
            MOVE      FLDVALUE,AUREBEAR[AUREARCT]
          ELSE
            MOVE      FLDVALUE,AUREAFAR[AUREARCT]
          ENDIF
.
AUREAD99  RETURN
.
.------------------------------------------------------------------------------
. Convert date to display format
. Input:  DATEIN   (CCYYMMDD)
. OUTPUT: DATEOUT  (DD MTH CCYY)  
.------------------------------------------------------------------------------
CNVDTE00  MOVE      DATEIN,DATEOUT 
          MATCH     SP70,DATEIN
          GOTO      CNVDTE99 IF EQUAL
.
          UNPACK    DATEIN,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEOUT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      CNVDTE99
.
CNVDTE99  RETURN
.
.------------------------------------------------------------------------------
. Convert date to display format
. Input:  FLAGIN   (Blank/0/1)
. OUTPUT: FLAGOUT  (Yes/No)
.------------------------------------------------------------------------------
CNVFLG00  MOVE      FLAGIN,FLAGOUT
.
          MATCH     SP70,FLAGIN
          GOTO      CNVFLG20 IF EQUAL
.
          MATCH     "0",FLAGIN
          GOTO      CNVFLG20 IF EQUAL
.
          MATCH     "1",FLAGIN
          GOTO      CNVFLG30 IF EQUAL
.
          GOTO      CNVFLG99
.
CNVFLG20  MOVE      "No",FLAGOUT
          GOTO      CNVFLG99                    
.
CNVFLG30  MOVE      "Yes",FLAGOUT
          GOTO      CNVFLG99                    
.
CNVFLG99  RETURN
.
.------------------------------------------------------------------------------
. Get User name from websecaf
. Input:  USERIDIN
. OUTPUT: USERIDOU
.------------------------------------------------------------------------------
GUSRDS00  MOVE      USERIDIN,USERIDOU
          MATCH     SP70,USERIDIN
          GOTO      GUSRDS99 IF EQUAL
.
          PACK      KEY10,USERIDIN
          CALL      RDWBSE1       
          BRANCH    OVRCD,GUSRDS99
. 
          MOVE      WBSENAM,USERIDOU
.
GUSRDS99  RETURN
.
.------------------------------------------------------------------------------
. Get User name from websecaf using passcode
. Input:  PASCDEIN
. OUTPUT: PASCDEOU
.------------------------------------------------------------------------------
GUSRPA00  MOVE      PASCDEIN,PASCDEOU
          MATCH     SP70,PASCDEIN
          GOTO      GUSRPA99 IF EQUAL
.
          OPEN      WEBSECA3,"websecaf"
          PACK      KEY14,PASCDEIN,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,GUSRPA99
.
          MATCH     PASCDEIN,WBSEPCD
          GOTO      GUSRPA99 IF NOT EQUAL
.
          MOVE      WBSENAM,PASCDEOU
.
GUSRPA99  RETURN
.
.------------------------------------------------------------------------------
. Get Category code description from patcodes
. Input:  GPATCAT
.         GPATCODE
.         GPATDDSC
. OUTPUT: GPATDESC
.         GPATFDSC 
.------------------------------------------------------------------------------
GPATCD00  MOVE      GPATCODE,GPATDESC
          PACK      CATGNAME,SP1,LBRACK,CATEDESC,SP1,GPATCAT,RBRACK
          MOVE      SP70,GPATFDSC
          MATCH     SP70,GPATCODE
          GOTO      GPATCD50 IF EQUAL
.
GPATCD20  PACK      KEY5,GPATCAT,GPATCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GPATCD50
          MOVE      TDESC,GPATDESC
.
GPATCD50  PACK      KEY5,GPATCAT,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            PACK      GPATFDSC,TDESC,CATGNAME 
          ELSE
            PACK      GPATFDSC,GPATDDSC,CATGNAME
          ENDIF
.
GPATCD99  RETURN
.
.------------------------------------------------------------------------------
. Get HCP name from pmshcpaf
. Input:  DOCTCODE 
. OUTPUT: DOCFNAME
.------------------------------------------------------------------------------
GHCPNM00  MOVE      DOCTCODE,DOCFNAME
          MATCH     SP70,DOCTCODE
          GOTO      GHCPNM99 IF EQUAL
.
          PACK      KEY10,DOCTCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GHCPNM99
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
GHCPNM99  RETURN
.
.------------------------------------------------------------------------------
. Get Practice name from pmshcgaf
. Input:  GPRCCODE
.         GPRCCOUN
. OUTPUT: GPRCNAME
.------------------------------------------------------------------------------
GPRCNM00  MOVE      GPRCCODE,GPRCNAME
          MATCH     SP70,GPRCCODE
          GOTO      GPRCNM99 IF EQUAL
.
          PACK      KEY12,GPRCCODE,GPRCCOUN,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,GPRCNM99
.
          MOVE      PMHGPNAM,GPRCNAME
.
GPRCNM99  RETURN
.
.------------------------------------------------------------------------------
. Get Hospital Name from pathspaf
. Input:  GHSPCODE
. OUTPUT: GHSPNAME
.------------------------------------------------------------------------------
GHSPNM00  MOVE      GHSPCODE,GHSPNAME
          MATCH     SP70,GHSPCODE
          GOTO      GHSPNM99 IF EQUAL
.
          PACK      KEY3,GHSPCODE,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,GHSPNM99
.
          MOVE      PTHSNAME,GHSPNAME
.
GHSPNM99  RETURN
.
.------------------------------------------------------------------------------
. Get Case team description from allcasaf
. Input:  GTEACODE
. OUTPUT: GTEADESC
.------------------------------------------------------------------------------
GTEADS00  MOVE      GTEACODE,GTEADESC
          MATCH     SP70,GTEACODE
          GOTO      GTEADS99 IF EQUAL
.
          PACK      KEY10,GTEACODE,SP70
          CALL      RDALCAS1
          BRANCH    OVRCD,GTEADS99
.
          MOVE      ALCADESC,GTEADESC
.
GTEADS99  RETURN
.
.------------------------------------------------------------------------------
. Get Department description from alldepaf
. Input:  GDEPCODE
. OUTPUT: GDEPDESC
.------------------------------------------------------------------------------
GDEPDS00  MOVE      GDEPCODE,GDEPDESC
          MATCH     SP70,GDEPCODE
          GOTO      GDEPDS99 IF EQUAL
.
          PACK      KEY3,GDEPCODE,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,GDEPDS99
.
          MOVE      "CG",KEY2
          PACK      KEY5,KEY2,GDEPCODE
          CALL      RDCODE1
          BRANCH    OVRCD,GDEPDS99
.
          MOVE      TDESC,GDEPDESC
.
GDEPDS99  RETURN
.
.------------------------------------------------------------------------------
. Get Diagnosis code description from alldiaaf
. Input:  GDIADEPT
.         GDIACODE
. OUTPUT: GDEPDESC
.------------------------------------------------------------------------------
GDIADS00  MOVE      GDIACODE,GDIADESC
          MATCH     SP70,GDIACODE
          GOTO      GDIADS99 IF EQUAL
.
          PACK      KEY12,GDIADEPT,GDIACODE,SP70
          CALL      RDALDIA1
          BRANCH    OVRCD,GDIADS99
.
          MOVE      ALDIDESC,GDIADESC
.
GDIADS99  RETURN
.
.------------------------------------------------------------------------------
. Get Problem code description from allprraf
. Input:  GPRBDEPT
.         GPRBCODE
. OUTPUT: GPRBDESC
.------------------------------------------------------------------------------
GPRBDS00  MOVE      GPRBCODE,GPRBDESC
          MATCH     SP70,GPRBCODE
          GOTO      GPRBDS99 IF EQUAL
.
          PACK      KEY12,GPRBDEPT,GPRBCODE,SP70
          CALL      RDALPRR1 
          BRANCH    OVRCD,GPRBDS99
.
          MOVE      ALPRDESC,GPRBDESC
.
GPRBDS99  RETURN
.
.------------------------------------------------------------------------------
. Get Procedure code description from allproaf
. Input:  GPRODEPT
.         GPROCODE
. OUTPUT: GPRODESC
.------------------------------------------------------------------------------
GPRODS00  MOVE      GPROCODE,GPRODESC
          MATCH     SP70,GPROCODE
          GOTO      GPRODS99 IF EQUAL
.
          PACK      KEY12,GPRODEPT,GPROCODE,SP70
          CALL      RDALPRO1
          BRANCH    OVRCD,GPRODS99
.
          MOVE      ALPODESC,GPRODESC
.
GPRODS99  RETURN
.
.------------------------------------------------------------------------------
. Routine to display the Referral Action Audit Summary - 10 records Next & Prev
.------------------------------------------------------------------------------
ACTT0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP70,LINKPRG
          IF        !@EQUAL
            CALL      ACTAUD00     
            GOTO      ACTT9999
          ENDIF            
.
          PACK      KEY26,ADMISSNO,ANSM,SP1,Z70      * Referral Audit Summary
          MOVE      ZERO,COUNT
          CALL      RSALAUD2                * positional read
ACTT0010  CALL      RPALAUD2                * read a record
          BRANCH    OVRCD,ACTT9999
.
          MATCH     ALAUVISN,ADMISSNO
          GOTO      ACTT9999 IF NOT EQUAL
.
          MATCH     "M",ALAUUPDT           * Select actions only
          GOTO      ACTT9999 IF NOT EQUAL
.
          PACK      KEY10,ALAUAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      ALAUAUID,WBSENAM
          ENDIF
          CALL      ARASUP00
          CALL      ARASCD00                * Action Code Description
.
          MATCH     ALAUADAT,SP70
          GOTO      ACTT9999 IF EQUAL
.
          UNPACK    ALAUADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      SP70,KEY11
          REP       " 0",CYEAR
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ACTT0010
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                      "<td>&nbsp;",WBSENAM,"</td> ":
                      "<td>&nbsp;",KEY11," at ",ALAUATIM,"</td>":
                      "<td>&nbsp;",TDESC,"</td>":
                      "<td>&nbsp;",ALUPDATE,"</td>":
                      "<td>&nbsp;",ALAUCOMM,"</td>":
                      "</tr>"
.
          ADD       ONE,DISNUMB
.
          COMPARE   NORECORD,DISNUMB
          GOTO      ACTT0010 IF NOT EQUAL
.
ACTT9999  RETURN
.
.------------------------------------------------------------------------------
. Routine to display the Referral Action Audit Summary - 10 records Next & Prev
.------------------------------------------------------------------------------
ACTAUD00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Reading From Referral Table
          IF        OVRCD = 1
            GOTO      ACTAUD99
          ENDIF
.
ACTAUD10  PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          IF        OVRCD = 1
            GOTO      ACTAUD99
          ENDIF
.
          PACK      KEY26,ADMISSNO,ANSM,ANSD,Z70      * Referral Audit Summary
          MOVE      ZERO,COUNT
          CALL      RSALAUD2                * positional read
ACTAUD20  CALL      RPALAUD2                * read a record
          BRANCH    OVRCD,ACTAUD99
.
          MATCH     ALAUVISN,ADMISSNO
          GOTO      ACTAUD99 IF NOT EQUAL
.
          MATCH     "M ",ALAUUPDT           * Select mark action
          GOTO      ACTAUD40 IF EQUAL
.
          MATCH     "MD",ALAUUPDT           * Select action deleted
          GOTO      ACTAUD40 IF EQUAL
.
          GOTO      ACTAUD99 IF NOT EQUAL
.
ACTAUD40  CALL      ARASUP00
          CALL      ARASCD00                * Action Code Description
.
          MATCH     ALAUADAT,SP70
          GOTO      ACTAUD99 IF EQUAL
.
          UNPACK    ALAUADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      SP70,KEY11
          REP       " 0",CYEAR
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ACTAUD10
          ENDIF
.          
          MATCH     "MD",ALAUUPDT        
          IF        @EQUAL       
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          PACK      KEY10,ALAUAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      ALAUAUID,WBSENAM
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                    "<td>&nbsp;",STRIKETG,WBSENAM,STRENDTG,"</td>":
                    "<td nowrap>":
                    "<img src=../images/MaintenanceIcon.gif ":
                    "class=ListIcon ":
                    "onclick='referralActionAudit(#"":
                    LINKPRG,"#",#"":
                    LINKREP,"#",#"":
                    LINKTEM,"#",#"":
                    ALAUVISN,ALAUADAT,ALAUATIM,"#");'>":
                    STRIKETG,KEY11," at ",ALAUATIM,STRENDTG,"</td>":
                    "<td>&nbsp;",STRIKETG,TDESC,STRENDTG,"</td>":
                    "<td>&nbsp;",STRIKETG,ALUPDATE,STRENDTG,"</td>":
                    "<td>&nbsp;",STRIKETG,ALAUCOMM,STRENDTG,"</td>":
                    "</tr>"
.
          ADD       ONE,DISNUMB
.
          COMPARE   NORECORD,DISNUMB
          GOTO      ACTAUD20 IF NOT EQUAL
.
ACTAUD99  RETURN
.------------------------------------------------------------------------------
.
ARASUP00  MOVE      SP70,ALUPDATE
.
          MATCH     "A",ALAUUPDT
          IF        @EQUAL
            MOVE      "Add",ALUPDATE
          ENDIF
.
          MATCH     "U",ALAUUPDT
          IF        @EQUAL
            MOVE       "Update",ALUPDATE
          ENDIF
.
          MATCH     "C",ALAUUPDT
          IF        @EQUAL
            MOVE       "Close",ALUPDATE
          ENDIF
.
          MATCH     "P",ALAUUPDT
          IF        @EQUAL
            MOVE       "Transfer Department",ALUPDATE
          ENDIF
.
          MATCH     "H",ALAUUPDT
          IF        @EQUAL
            MOVE       "Transfer HCP",ALUPDATE
          ENDIF
.
          MATCH     "I",ALAUUPDT
          IF        @EQUAL
            MOVE       "Inactivate",ALUPDATE
          ENDIF
.
          MATCH     "M",ALAUUPDT
          IF        @EQUAL
            MOVE       "Action",ALUPDATE
          ENDIF
.
          MATCH     "MD",ALAUUPDT
          IF        @EQUAL
            MOVE       "Action Delete",ALUPDATE
          ENDIF
.
          MATCH     "N",ALAUUPDT
          IF        @EQUAL
            MOVE       "Cancel",ALUPDATE
          ENDIF
.
          MATCH     "S",ALAUUPDT
          IF        @EQUAL
            MOVE       "Transfer Case Team",ALUPDATE
          ENDIF
.
          MATCH     "T",ALAUUPDT
          IF        @EQUAL
            MOVE       "Activate",ALUPDATE
          ENDIF
.
          MATCH     "D",ALAUUPDT
          IF        @EQUAL
            MOVE       "Delete",ALUPDATE
          ENDIF
.
          MATCH     "V",ALAUUPDT
          IF        @EQUAL
           MOVE       "View",ALUPDATE
          ENDIF
.
          MATCH     "J",ALAUUPDT
          IF        @EQUAL
           MOVE       "Reject",ALUPDATE
          ENDIF
.
          MATCH     "E",ALAUUPDT
          IF        @EQUAL
           MOVE       "Reinstate",ALUPDATE
          ENDIF
.
          MATCH     "W",ALAUUPDT
          IF        @EQUAL
           MOVE       "Waiting",ALUPDATE
          ENDIF
.                                                                    
          MATCH     "R",ALAUUPDT                                     *T0318661
          IF        @EQUAL
           MOVE       "Priority",ALUPDATE
          ENDIF
.
ARASUP99  RETURN
.
ARASCD00  MOVE      ALAUACTI,CODE           * Action Code Description
          MOVE      "LF",CATEGORY
          CALL      GETCOD00
          GOTO      ARASCD99
.
ARASCD99  RETURN
.
ARAT0000  PACK      KEY24,SP70              * Referral Audit Table
          CALL      RSALAUD1
ARAT1000  CALL      RKALAUD1
          BRANCH    OVRCD,ARAT9999
          CALL      ARATUP00
          MOVE      ALAUACTI,CODE           * Action Code Description
          MOVE      "LF",CATEGORY
          CALL      GETCOD00
          WRITE     HTMLFILE;"<tr>":
                      "<td>",ALAUVISN,"</td> ":
                      "<td>",ALAUADAT,"&nbsp",ALAUATIM,"</td>":
                      "<td>",ALAUAUID,"</td>":
                      "<td>",TDESC,"</td>":
                      "<td>",ARUPDATE,"</td>":
                      "<td>",ALAUCOMM,"</td>":
                      "</tr>"
          GOTO      ARAT1000
.
ARAT9999  RETURN
.
ARATUP00  SQUEEZE   ALAUUPDT
          MATCH     "U",ALAUUPDT
          IF         @EQUAL
           MOVE       "Update",ARUPDATE
          ENDIF
          MATCH     "V",ALAUUPDT
          IF         @EQUAL
           MOVE       "View",ARUPDATE
          ENDIF
          MATCH     "W",ALAUUPDT
          IF         @EQUAL
           MOVE       "Waiting",ARUPDATE
          ENDIF
.
ARATUP99  RETURN
.
ASHT0000  PACK      KEY17,ADMISSNO,Z70      * Status History Table
          CALL      RSALSTS1
ASHTSQ00  CALL      RPALSTS1
          BRANCH    OVRCD,ASHT9999
          CALL      ASHTST00
          WRITE     HTMLFILE;"<tr>":
                      "<td>",ALAUVISN,"</td> ":
                      "<td>",ALSTSDAT,"</td>":
                      "</tr>"
          GOTO      ASHTSQ00
.
ASHT9999  RETURN
.
ASHTST00  SQUEEZE   ALSTSTAT
          MATCH     "0",ALSTSTAT
          IF         @EQUAL
           MOVE       "Waiting",ALSTATUS
          ENDIF
          MATCH     "1",ALSTSTAT
          IF         @EQUAL
           MOVE       "Active",ALSTATUS
          ENDIF
          MATCH     "2",ALSTSTAT
          IF         @EQUAL
           MOVE       "Closed",ALSTATUS
          ENDIF
          MATCH     "3",ALSTSTAT
          IF         @EQUAL
           MOVE       "Inactive",ALSTATUS
          ENDIF
          MATCH     "4",ALSTSTAT
          IF         @EQUAL
           MOVE       "Cancelled",ALSTATUS
          ENDIF
          MATCH     "5",ALSTSTAT
          IF         @EQUAL
           MOVE       "Rejected",ALSTATUS
          ENDIF
.
ASHTST99  RETURN
.-----------------------------------------------------------------------------.
.         Usual GP suburb
.-----------------------------------------------------------------------------.
ARGP0000  MATCH     SP70,PMPXRH1G
          GOTO      ARGP5000 IF EQUAL
.
          MATCH     SP70,PMPXR1GC
          IF        @EQUAL
            PACK      PMPXR1GC,SP1,ONE
          ENDIF
.
          PACK      KEY12,PMPXRH1G,PMPXR1GC,SP70
          CALL      RDPMHCG1                     * use practice if one exists
          BRANCH    OVRCD,ARGP5000
.
          WRITE     HTMLFILE;PMHGADD3;
          GOTO      ARGP9999
.
ARGP5000  MATCH     SP70,PMPXRHC1
          GOTO      ARGP9999 IF EQUAL
.
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1                * use hcp suburb if no practice
          BRANCH    OVRCD,ARGP9999
.
          WRITE     HTMLFILE;PMHCADR3;
.
ARGP9999  RETURN
.
.-----------------------------------------------------------------------------.
. Next Day, Week, Month                                                       .
.-----------------------------------------------------------------------------.
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",DEPTCODE           * HPS CODE Added (KSK)
          REP       " +",DOCTCODE           * HPS CODE Added (KSK)
          REP       " +",FILTCTYP
          REP       " +",FILTCLID
          REP       " +",PRIORITY
          REP       " +",STATCODE
          REP       " +",FILTSTAT
          REP       " +",OVRDDEPT
          REP       " +",FILTTEAM
          REP       " +",FILTHOSP
          REP       " +",FILTPSIT
          REP       " +",OVRDHOSP
          REP       " +",FILTTRGS
          REP       " +",DISPCTDL
          REP       " +",HCPCLASD           * HCP Category
          WRITE     HTMLFILE;"allweb02.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&deptcode=",DEPTCODE:  * HPS Code Starts Here KSK
                             "&doctcode=",DOCTCODE:
                             "&filtctyp=",FILTCTYP:
                             "&filtclid=",FILTCLID:
                             "&priority=",PRIORITY:
                             "&statcode=",STATCODE:
                             "&filtstat=",FILTSTAT:
                             "&ovrddept=",OVRDDEPT:
                             "&filtteam=",FILTTEAM:
                             "&filthosp=",FILTHOSP:
                             "&filtpsit=",FILTPSIT:
                             "&ovrdhosp=",OVRDHOSP:
                             "&filttrgs=",FILTTRGS:       
                             "&dispctdl=",DISPCTDL:       
                             "&hcpclasf=",HCPCLASF;   * HCP Category
          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTCODE           * HPS CODE Added ends here (KSK)
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTCLID
          REP       "+ ",PRIORITY
          REP       "+ ",STATCODE
          REP       "+ ",FILTSTAT
          REP       "+ ",OVRDDEPT
          REP       "+ ",FILTTEAM
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTPSIT
          REP       "+ ",OVRDHOSP
          REP       "+ ",FILTTRGS
          REP       "+ ",DISPCTDL
          REP       "+ ",HCPCLASD           * HCP Category
.
NEXT9999  RETURN
.
.-----------------------------------------------------------------------------.
. Previous Day, Week, Month                                                   .
.-----------------------------------------------------------------------------.
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",DEPTCODE           * HPS CODE Added (KSK)
          REP       " +",DOCTCODE           * HPS CODE Added (KSK)
          REP       " +",FILTCTYP
          REP       " +",FILTCLID
          REP       " +",PRIORITY
          REP       " +",STATCODE
          REP       " +",FILTSTAT
          REP       " +",OVRDDEPT
          REP       " +",FILTTEAM
          REP       " +",FILTHOSP
          REP       " +",FILTPSIT
          REP       " +",OVRDHOSP
          REP       " +",FILTTRGS
          REP       " +",DISPCTDL
          REP       " +",HCPCLASD          * HCP Category
          WRITE     HTMLFILE;"allweb02.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&deptcode=",DEPTCODE:  * HPS Code Starts Here KSK
                             "&doctcode=",DOCTCODE:
                             "&filtctyp=",FILTCTYP:
                             "&filtclid=",FILTCLID:
                             "&priority=",PRIORITY:
                             "&statcode=",STATCODE:
                             "&filtstat=",FILTSTAT:
                             "&ovrddept=",OVRDDEPT:
                             "&filtteam=",FILTTEAM:
                             "&filthosp=",FILTHOSP:
                             "&filtpsit=",FILTPSIT:
                             "&ovrdhosp=",OVRDHOSP:
                             "&filttrgs=",FILTTRGS:
                             "&dispctdl=",DISPCTDL:
                             "&hcpclasf=",HCPCLASF;  * HCP Category

          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTCODE           * HPS CODE Added ends here (KSK)
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTCLID
          REP       "+ ",PRIORITY
          REP       "+ ",STATCODE
          REP       "+ ",FILTSTAT
          REP       "+ ",OVRDDEPT
          REP       "+ ",FILTTEAM
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTPSIT
          REP       "+ ",OVRDHOSP
          REP       "+ ",FILTTRGS
          REP       "+ ",DISPCTDL
          REP       "+ ",HCPCLASD           * HCP Category
.
PREV9999  RETURN
.******************************************************************************
.              Link to Next Group of Patients                                 .
.******************************************************************************
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",DEPTCODE
          REP       " +",DOCTCODE
          REP       " +",PRIORITY
          REP       " +",FILTCLID
          REP       " +",FILTCTYP
          REP       " +",FILTTEAM
          REP       " +",FILTHOSP
          REP       " +",FILTPSIT
          REP       " +",FILTSTAT
          REP       " +",OVRDHOSP
          REP       " +",FILTTRGS
          REP       " +",DISPCTDL            * HCP Category
          REP       " +",HCPCLASD            * HCP Category
.
          WRITE     HTMLFILE;"allweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&deptcode=",DEPTCODE:
                                 "&doctcode=",DOCTCODE:
                                 "&priority=",PRIORITY:
                                 "&filtclid=",FILTCLID:
                                 "&filtctyp=",FILTCTYP:
                                 "&filtteam=",FILTTEAM:
                                 "&filthosp=",FILTHOSP:
                                 "&filtpsit=",FILTPSIT:
                                 "&filtstat=",FILTSTAT:
                                 "&ptcolumn=",PTCOLUMN:
                                 "&ovrdhosp=",OVRDHOSP:
                                 "&filttrgs=",FILTTRGS:
                                 "&dispctdl=",DISPCTDL:
                                 "&hcpclasf=",HCPCLASF;       * HCP Category
.
          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTCODE
          REP       "+ ",PRIORITY
          REP       "+ ",FILTCLID
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTTEAM
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTPSIT
          REP       "+ ",FILTSTAT
          REP       "+ ",OVRDHOSP
          REP       "+ ",FILTTRGS
          REP       "+ ",DISPCTDL      
          REP       "+ ",HCPCLASD      * HCP Category
.
NEXTGR99  RETURN
.******************************************************************************
.              Link to Next Group of Patients                                 .
.******************************************************************************
NXTGRP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",DEPTCODE
          REP       " +",DOCTCODE
          REP       " +",IAREASON
          REP       " +",PRIORITY
          REP       " +",LASTDATE
          REP       " +",VIEWTYPE
          REP       " +",FILTCTYP
          REP       " +",FILTCLID
          REP       " +",STATCODE
          REP       " +",FILTTEAM
          REP       " +",FILTHOSP
          REP       " +",FILTPSIT
          REP       " +",FILTSTAT
          REP       " +",OVRDHOSP
          REP       " +",FILTTRGS
          REP       " +",DISPCTDL      
          REP       " +",HCPCLASD      * HCP Category  
.
          WRITE     HTMLFILE;"allweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&deptcode=",DEPTCODE:
                                 "&doctcode=",DOCTCODE:
                                 "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&priority=",PRIORITY:
                                 "&iareason=",IAREASON:
                                 "&filtctyp=",FILTCTYP:
                                 "&filtclid=",FILTCLID:
                                 "&statcode=",STATCODE:
                                 "&filtteam=",FILTTEAM:
                                 "&filthosp=",FILTHOSP:
                                 "&filtpsit=",FILTPSIT:
                                 "&filtstat=",FILTSTAT:
                                 "&ovrdhosp=",OVRDHOSP:
                                 "&filttrgs=",FILTTRGS:
                                 "&dispctdl=",DISPCTDL:
                                 "&hcpclasf=",HCPCLASF;          * HCP Category
.
          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTCODE
          REP       "+ ",IAREASON
          REP       "+ ",PRIORITY
          REP       "+ ",LASTDATE
          REP       "+ ",VIEWTYPE
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTCLID
          REP       "+ ",STATCODE
          REP       "+ ",FILTTEAM
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTPSIT
          REP       "+ ",FILTSTAT
          REP       "+ ",OVRDHOSP
          REP       "+ ",FILTTRGS
          REP       "+ ",DISPCTDL
          REP       "+ ",HCPCLASD         * HCP Category
.
NXTGRP99  RETURN
.******************************************************************************
.               Link to Previous Group                                        .
.******************************************************************************
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",DEPTCODE
          REP       " +",DOCTCODE
          REP       " +",PRIORITY
          REP       " +",FILTCLID
          REP       " +",FILTCTYP
          REP       " +",FILTTEAM
          REP       " +",FILTHOSP
          REP       " +",FILTPSIT
          REP       " +",FILTSTAT
          REP       " +",OVRDHOSP
          REP       " +",FILTTRGS
          REP       " +",DISPCTDL
          REP       " +",HCPCLASD         * HCP Category
.
          WRITE     HTMLFILE;"allweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&deptcode=",DEPTCODE:
                                 "&doctcode=",DOCTCODE:
                                 "&priority=",PRIORITY:
                                 "&filtclid=",FILTCLID:
                                 "&filtctyp=",FILTCTYP:
                                 "&filtteam=",FILTTEAM:
                                 "&filthosp=",FILTHOSP:
                                 "&filtpsit=",FILTPSIT:
                                 "&filtstat=",FILTSTAT:
                                 "&ptcolumn=",PTCOLUMN:
                                 "&ovrdhosp=",OVRDHOSP:
                                 "&filttrgs=",FILTTRGS:
                                 "&dispctdl=",DISPCTDL:
                                 "&hcpclasf=",HCPCLASF;       * HCP Category
.
          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTCODE
          REP       "+ ",PRIORITY
          REP       "+ ",FILTCLID
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTTEAM
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTPSIT
          REP       "+ ",FILTSTAT
          REP       "+ ",OVRDHOSP
          REP       "+ ",FILTTRGS
          REP       "+ ",DISPCTDL
          REP       "+ ",HCPCLASD          * HCP Category
.
PREVGR99  RETURN
.******************************************************************************
.               Link to Previous Group                                        .
.******************************************************************************
PRVGRP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",DEPTCODE
          REP       " +",DOCTCODE
          REP       " +",LASTDATE
          REP       " +",IAREASON
          REP       " +",VIEWTYPE
          REP       " +",FILTCTYP
          REP       " +",FILTCLID
          REP       " +",PRIORITY
          REP       " +",STATCODE
          REP       " +",FILTTEAM
          REP       " +",FILTHOSP
          REP       " +",FILTPSIT
          REP       " +",FILTSTAT
          REP       " +",OVRDHOSP
          REP       " +",FILTTRGS
          REP       " +",DISPCTDL
          REP       " +",HCPCLASD           * HCP Category
.
          WRITE     HTMLFILE;"allweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&deptcode=",DEPTCODE:
                                 "&doctcode=",DOCTCODE:
                                 "&iareason=",IAREASON:
                                 "&viewtype=",VIEWTYPE:
                                 "&priority=",PRIORITY:
                                 "&lastdate=",LASTDATE:
                                 "&filtctyp=",FILTCTYP:
                                 "&filtclid=",FILTCLID:
                                 "&statcode=",STATCODE:
                                 "&filtteam=",FILTTEAM:
                                 "&filthosp=",FILTHOSP:
                                 "&filtpsit=",FILTPSIT:
                                 "&filtstat=",FILTSTAT:
                                 "&ovrdhosp=",OVRDHOSP:
                                 "&filttrgs=",FILTTRGS:
                                 "&dispctdl=",DISPCTDL:
                                 "&hcpclasf=",HCPCLASF;        * HCP Category
.
          REP       "+ ",DEPTCODE
          REP       "+ ",DOCTCODE
          REP       "+ ",IAREASON
          REP       "+ ",LASTDATE
          REP       "+ ",VIEWTYPE
          REP       "+ ",FILTCTYP
          REP       "+ ",FILTCLID
          REP       "+ ",PRIORITY
          REP       "+ ",STATCODE
          REP       "+ ",FILTTEAM
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTPSIT
          REP       "+ ",FILTSTAT
          REP       "+ ",OVRDHOSP
          REP       "+ ",FILTTRGS
          REP       "+ ",DISPCTDL
          REP       "+ ",HCPCLASD            * HCP Category
.
PRVGRP99  RETURN
.------------------------------------------------------------
. Output Code or Name of HCP for List Filter Display
.    Tag Parameter .0 = Code
.                  .1 = Formatted Name
.------------------------------------------------------------
HCPCOD00  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,HCPCOD10
          WRITE     HTMLFILE;DOCTCODE;
          GOTO      HCPCOD99
.
HCPCOD10  PACK      KEY10,DOCTCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,HCPCOD99
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
.
HCPCOD99  RETURN
.******************************************************************************
.               Insert Data Into HTML File   (WAITING)                        .
.******************************************************************************
WRTHTM00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Format the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2 
          ELSE
            CALL      ALLDAT00                * Format the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      ALREMDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT3
          ELSE
            CALL      ALLDAT00                * Format the Date
            MOVE      FBOKDATE,TEMPDAT3       * formatted Must Be Seen By Date
          ENDIF
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      "ts",CATEGORY
          MOVE      ALRETRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          MOVE      "gb",CATEGORY
          MOVE      ALRECONT,CODE             
          CALL      GETCOD00
          MOVE      TDESC,CONTDESC
.
          MOVE      "AO",CATEGORY
          MOVE      ALREOUTP,CODE
          CALL      GETCOD00
          PACK      DIM20,TDESC,SP70
          CLEAR     TDESC
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          MOVE      SP70,PRTYCLAS                * Priority class for colour
.
          MATCH     "R",TCINDC9
          IF        @EQUAL
            MOVE      "TextRed",PRTYCLAS         * Red
          ENDIF
.
          MATCH     "O",TCINDC9
          IF        @EQUAL
            MOVE      "TextOrange",PRTYCLAS      * Orange
          ENDIF
.
          MATCH     "G",TCINDC9
          IF        @EQUAL
            MOVE      "TextGreen",PRTYCLAS       * Green
          ENDIF
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          MOVE      ZERO,DAYSLIST
          MATCH     SP70,ALRERDAT
          IF        !@EQUAL
            DAYSEP    ALRERDAT,CRRDATE,DAYSLIST
          ENDIF
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70      * Health Care Professional
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            MOVE      PMHCOSLV,HCPCLASD     * HCP Classification 
         
            MATCH     SP70,DISPCTDL
            IF        !@EQUAL 
              MOVE      "DL",CATEGORY
              MOVE      HCPCLASD,CODE
              CALL      GETCOD00
              MOVE      TDESC,HCPDLDES
              CLEAR     TDESC
            ENDIF 
.                                                            
            CALL      DOCNM000
          ELSE
            MOVE      SP70,DOCFNAME
            MOVE      SP70,HCPCLASD         * HCP Classification 
          ENDIF
.
          MOVE      SP70,UC34DESC
          MATCH     SP70,ALREUC34
          IF        !@EQUAL
            PACK      KEY5,CATLH,ALREUC34,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,UC34DESC
            ENDIF
          ENDIF
.
          MOVE      NINE,PRTYSORT                    * Low sort priority
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MATCH    SP70,TCINDC1
            IF       @EQUAL
              MOVE     NINE,PRTYSORT
            ELSE
              MOVE     TCINDC1,PRTYSORT
            ENDIF
          ENDIF
.
          CALL      FINDAR00                * find any active referrals
.                                           * sets OTHAREFS = 0 or 1
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,REFTDESC
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC     * SACS referral
          ENDIF
.
          MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
          PACK      KEY20,SP70
          MATCH     SP70,ALREPRTY
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSR,ALREPRTY
            CALL      RDCODE1
            IF        OVRCD = 0
              PACK      KEY20,TDESC
            ENDIF
          ENDIF
.
.--------*T0881801 - Get linked visit/Reason for Adm and Location
.-------- for columns LNKVREAS, LNKVLOCN
          CALL      LLOCN000
.
.         C-0306959
.         If override hospital filter is set then display the hospital name
.         for the referral
.
          MOVE      SP70,HOSPNAME                   * Initialize hospital name
.
          MATCH     "1",OVRDHOSP                    * Is the override hosp used?
          GOTO      WRTHTM03 IF NOT EQUAL           * No
.
          MATCH     SP3,ALREHOSN                    * Is referred hosp available?
          GOTO      WRTHTM03 IF EQUAL               * No
.
          PACK      KEY3,ALREHOSN,SP70              * Yes, get hosp name
          CALL      RDPTHSP1                        * Read pathspaf
          BRANCH    OVRCD,WRTHTM03                  * Hosp not found
.
          MOVE      PTHSNAME,HOSPNAME               * Populate the Hospital Name
          GOTO      WRTHTM03
.
WRTHTM03  PACK      HTMLLNK5,SP70,SP70
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,WRTHTM05
.
          MATCH     ALRLLNKV,ALREVISN
          GOTO      WRTHTM06 IF EQUAL
.
WRTHTM05  CALL      PROG0000            * Show create program referral icon
.
WRTHTM06  MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,WRTHTM10,WRTHTM20
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>";
.
            MATCH     NZ,NZFLAG
            IF        !@EQUAL
              WRITE      HTMLFILE;"<td>&nbsp;",PSEX,"</td>":
                         "<td>&nbsp;",TEMPDAT1,"</td>":
                         "<td>&nbsp;",ALREURNO,"</td>";
            ENDIF
            WRITE     HTMLFILE;"<td>&nbsp;",TEMPDAT2,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
               CALL      DISHCP00
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            MATCH     "1",DISPCTDL                    * HCP Classif IND         
            IF        @EQUAL
              WRITE      HTMLFILE;"<td>&nbsp;",HCPDLDES,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     NZ,NZFLAG
            IF        @EQUAL
              WRITE      HTMLFILE;"<td>&nbsp;",ALREUFR1,"</td>";
            ENDIF
.
            MATCH     "1",PTCOLUMN
            IF        @EQUAL
              WRITE      HTMLFILE;"<td>&nbsp;",ALREPRCM,"</td>";
            ENDIF
.
            MATCH     "1",ALCNDTRG
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
            ENDIF                                                 * status
.
            MATCH     SP70,PRTYCLAS
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td class=#"",PRTYCLAS,"#">&nbsp;":
                                 KEY20,"</td>";                   * Priority
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",KEY20,"</td>";      * Priority
            ENDIF
.
            MATCH     NZ,NZFLAG
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",DIM20,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",DAYSLIST,"</td>";
.
            MATCH     NZ,NZFLAG
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",TEMPDAT3,"</td>";
            ENDIF
.
            IF        OTHAREFS = 1
              WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                                 " class=ListIcon ":
                                 " onclick='ListReferral(#"":
                                 ALREURNO,"#");'>",HTMLLNK5:
                                 "</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",HTMLLNK5,"&nbsp;</td>";
            ENDIF
.
            MATCH     "1",OVRDHOSP                                   *C-0306959
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td>";
              WRITE     HTMLFILE;"<td>&nbsp;",HOSPNAME,"</td></tr>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td></tr>";
            ENDIF
.
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            IF        OTHAREFS = 1
              CLEAR     HTMLLNK2
              APPEND    "javascript:",HTMLLNK2
              APPEND    "ListReferral('",HTMLLNK2
              APPEND    ALREURNO,HTMLLNK2
              APPEND    "')",HTMLLNK2
              RESET     HTMLLNK2
            ELSE
              PACK      HTMLLNK2,SP70,SP70
            ENDIF
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",ALREURNO,"#",":                  4
                             "#"",TEMPDAT2,"#",";                  5
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCS00
.              WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
            ELSE
              WRITE     HTMLFILE;"#"",DOCFNAME,"#",";              6
            ENDIF
.
            WRITE     HTMLFILE;"#"",PROBLEM,"#",":                 7
                             "#"",KEY20,"#",":                     8
                             "#"",DAYSLIST,"#",":                  9
                             "#"",PRTYSORT,"#",":                  10
                             "#"",OTHAREFS,"#",":                  11
                             "#"",HTMLLNK2,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",CONTDESC,"#",":                  18
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",TEMPDAT3,"#",":                 *20
                             "#"",ALREUFR1,"#",":                 *21
                             "#"",ALREPRCM,"#",":                 *22
                             "#"",DIM20,"#",":                    *23
                             "#"",HTMLLNK5,"#",":                 *24
                             "#"",PRTYCLAS,"#",":                 *25
                             "#"",HOSPNAME,"#",":                 *26 
                             "#"",TRGSDESC,"#",":                 *27
                             "#"",ALREDREV,"#",":                 *28 T0881801
                             "#"",LNKVREAS,"#",":                 *29 T0881801
                             "#"",LNKVLOCN,"#",":                 *30 T0881801
                             "#"",HCPDLDES,"#"":                  *31 A0912348
                             ");"
          ENDIF
.
          GOTO      WRTHTM99
.
WRTHTM10  PACK      KEY10,USERID,SP70       * If Department Security is 1
          CALL      RDWBSE1
          BRANCH    OVRCD,WRTHTM99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                        "<img src=../images/PatientFolder",FOLDERSF,".gif":
                        " class=ListIcon ":
                        " onclick='UpdateReferral(#"":
                        ALREURNO,"#",#"":
                        ALREVISN,"#",#"":
                        DEPTCODE,"#");'>":
                        FORMATNM,"</td>";
.
              MATCH     NZ,NZFLAG
              IF        !@EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",PSEX,"</td>":
                          "<td>&nbsp;",TEMPDAT1,"</td>":
                          "<td>&nbsp;",ALREURNO,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",TEMPDAT2,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              MATCH     "1",DISPCTDL                    * HCP Class IND
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",HCPDLDES,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",PROBLEM,"</td>";
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",ALREUFR1,"</td>";
              ENDIF
.
              MATCH     "1",PTCOLUMN
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",ALREPRCM,"</td>";
              ENDIF
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              MATCH     SP70,PRTYCLAS
              IF        !@EQUAL
                WRITE     HTMLFILE;"<td class=#"",PRTYCLAS,"#">&nbsp;":
                                   KEY20,"</td>";                   * Priority
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",KEY20,"</td>";      * Priority
              ENDIF
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",DIM20,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",DAYSLIST,"</td>";
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TEMPDAT3,"</td>";
              ENDIF
.
              IF        OTHAREFS = 1
                WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                                   " class=ListIcon ":
                                   " onclick='ListReferral(#"":
                                   ALREURNO,"#");'>",HTMLLNK5:
                                   "</td>";
              ELSE
                WRITE     HTMLFILE;"<td>",HTMLLNK5,"&nbsp;</td>";
              ENDIF
.
              MATCH     "1",OVRDHOSP 
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td>";
                WRITE     HTMLFILE;"<td>&nbsp;",HOSPNAME,"</td></tr>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td></tr>";
              ENDIF
.
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              IF        OTHAREFS = 1
                CLEAR     HTMLLNK2
                APPEND    "javascript:",HTMLLNK2
                APPEND    "ListReferral('",HTMLLNK2
                APPEND    ALREURNO,HTMLLNK2
                APPEND    "')",HTMLLNK2
                RESET     HTMLLNK2
              ELSE
                PACK      HTMLLNK2,SP70,SP70
              ENDIF
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",ALREURNO,"#",":                  4
                             "#"",TEMPDAT2,"#",";                  5
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                 CALL      DISHCS00
.                WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            6
              ENDIF
.
              WRITE     HTMLFILE;"#"",PROBLEM,"#",":               7
                             "#"",TDESC,"#",":                     8
                             "#"",DAYSLIST,"#",":                  9
                             "#"",PRTYSORT,"#",":                  10
                             "#"",OTHAREFS,"#",":                  11
                             "#"",HTMLLNK2,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",CONTDESC,"#",":                  18
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",TEMPDAT3,"#",":                 *20
                             "#"",ALREUFR1,"#",":                 *21 
                             "#"",ALREPRCM,"#",":                 *22
                             "#"",DIM20,"#",":                    *23
                             "#"",SP1,"#",":                      *24
                             "#"",PRTYCLAS,"#",":                 *25
                             "#"",HOSPNAME,"#",":                 *26
                             "#"",TRGSDESC,"#",":                 *27
                             "#"",ALREDREV,"#",":                 *28 T0881801
                             "#"",LNKVREAS,"#",":                 *29 T0881801
                             "#"",LNKVLOCN,"#",":                 *30 T0881801
                             "#"",HCPDLDES,"#"":                  *31 A0912348
                             "); "
            ENDIF
          ELSE
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                           "<img src=../images/PatientFolder",FOLDERSF,".gif":
                           " class=ListIcon >":
                           FORMATNM,"</td>";
.
              MATCH     NZ,NZFLAG
              IF         !@EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",PSEX,"</td>":
                           "<td>&nbsp;",TEMPDAT1,"</td>":
                           "<td>&nbsp;",ALREURNO,"</td>";
              ENDIF
.
              WRITE      HTMLFILE;"<td>&nbsp;",TEMPDAT2,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",HCPCLASD,"</td>";
              ENDIF
.
              WRITE      HTMLFILE;"<td>&nbsp;",PROBLEM,"</td>";
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",ALREUFR1,"</td>";
              ENDIF
.
              MATCH     "1",PTCOLUMN
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",ALREPRCM,"</td>";
              ENDIF
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              MATCH     SP70,PRTYCLAS
              IF        !@EQUAL
                WRITE     HTMLFILE;"<td class=#"",PRTYCLAS,"#">&nbsp;":
                                   KEY20,"</td>";                   * Priority
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",KEY20,"</td>";      * Priority
              ENDIF
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",DIM20,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",DAYSLIST,"</td>";
.
              MATCH     NZ,NZFLAG
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",TEMPDAT3,"</td>";
              ENDIF
.
              IF        OTHAREFS = 1
                WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                                   " class=ListIcon ":
                                   " onclick='ListReferral(#"":
                                   ALREURNO,"#");'>":
                                   "</td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;</td>";
              ENDIF
.
              MATCH     "1",OVRDHOSP 
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td>";
                WRITE     HTMLFILE;"<td>&nbsp;",HOSPNAME,"</td></tr>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td></tr>";
              ENDIF
.
            ELSE
              CLEAR     HTMLLINK
              APPEND    SP1,HTMLLINK
              RESET     HTMLLINK
.
              IF        OTHAREFS = 1
                CLEAR     HTMLLNK2
                APPEND    "javascript:",HTMLLNK2
                APPEND    "ListReferral('",HTMLLNK2
                APPEND    ALREURNO,HTMLLNK2
                APPEND    "')",HTMLLNK2
                RESET     HTMLLNK2
              ELSE
                PACK      HTMLLNK2,SP70,SP70
              ENDIF
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                               "#"",FORMATNM,"#",":                  1
                               "#"",PSEX,"#",":                      2
                               "#"",TEMPDAT1,"#",":                  3
                               "#"",ALREURNO,"#",":                  4
                               "#"",TEMPDAT2,"#",";                  5
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.                WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";              6
              ENDIF
.
              WRITE     HTMLFILE;"#"",PROBLEM,"#",":                 7
                               "#"",TDESC,"#",":                     8
                               "#"",DAYSLIST,"#",":                  9
                               "#"",PRTYSORT,"#",":                  10
                               "#"",OTHAREFS,"#",":                  11
                               "#"",HTMLLNK2,"#",":                  12
                               "#"",UC34DESC,"#",":                  13
                               "#"",ALSTDESC,"#",":                  14
                               "#"",REFTDESC,"#",":                  15
                               "#"",ALREPSIT,"#",":                  16
                               "#"",PREFSITE,"#",":                  17
                               "#"",CONTDESC,"#",":                  18
                               "#"",FOLDERSF,"#",":                 *19
                               "#"",TEMPDAT3,"#",":                 *20
                               "#"",ALREUFR1,"#",":                 *21 
                               "#"",ALREPRCM,"#",":                 *22
                               "#"",DIM20,"#",":                    *23
                               "#"",SP1,"#",":                      *24
                               "#"",PRTYCLAS,"#",":                 *25
                               "#"",HOSPNAME,"#",":                 *26
                               "#"",TRGSDESC,"#",":                 *27
                               "#"",ALREDREV,"#",":               *28 T0881801
                               "#"",LNKVREAS,"#",":               *29 T0881801
                               "#"",LNKVLOCN,"#",":               *30 T0881801
                               "#"",HCPDLDES,"#"":                *31 A0912348
                               ");"
            ENDIF
          ENDIF
.
          GOTO      WRTHTM99
.
WRTHTM20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,WRTHTM99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                        "<img src=../images/PatientFolder",FOLDERSF,".gif":
                        " class=ListIcon ":
                        " onclick='UpdateReferral(#"":
                        ALREURNO,"#",#"":
                        ALREVISN,"#",#"":
                        DEPTCODE,"#");'>":
                        FORMATNM,"</td>";
.
              MATCH     NZ,NZFLAG
              IF        !@EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",PSEX,"</td>":
                          "<td>&nbsp;",TEMPDAT1,"</td>":
                          "<td>&nbsp;",ALREURNO,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",TEMPDAT2,"</td>";
.

              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",HCPCLASD,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",PROBLEM,"</td>";
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",ALREUFR1,"</td>";
              ENDIF
.
              MATCH     "1",PTCOLUMN
              IF        @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",ALREPRCM,"</td>";
              ENDIF
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              MATCH     SP70,PRTYCLAS
              IF        !@EQUAL
                WRITE     HTMLFILE;"<td class=#"",PRTYCLAS,"#">&nbsp;":
                                   KEY20,"</td>";                   * Priority
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",KEY20,"</td>";      * Priority
              ENDIF
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",DIM20,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",DAYSLIST,"</td>";
.
              MATCH     NZ,NZFLAG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TEMPDAT3,"</td>";
              ENDIF
.
              IF        OTHAREFS = 1
                WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                          " class=ListIcon ":
                          " onclick='ListReferral(#"":
                          ALREURNO,"#");'>",HTMLLNK5:
                          "</td>";
              ELSE
                WRITE     HTMLFILE;"<td>",HTMLLNK5,"&nbsp;</td>";
              ENDIF
.
              MATCH     "1",OVRDHOSP
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td>";
                WRITE     HTMLFILE;"<td>&nbsp;",HOSPNAME,"</td></tr>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",UC34DESC,"</td></tr>";
              ENDIF
.
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              IF        OTHAREFS = 1
                CLEAR     HTMLLNK2
                APPEND    "javascript:",HTMLLNK2
                APPEND    "ListReferral('",HTMLLNK2
                APPEND    ALREURNO,HTMLLNK2
                APPEND    "')",HTMLLNK2
                RESET     HTMLLNK2
              ELSE
                PACK      HTMLLNK2,SP70,SP70
              ENDIF
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",ALREURNO,"#",":                  4
                             "#"",TEMPDAT2,"#",";                  5
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.                WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            6
              ENDIF
.
              WRITE     HTMLFILE;"#"",PROBLEM,"#",":               7
                             "#"",TDESC,"#",":                     8
                             "#"",DAYSLIST,"#",":                  9
                             "#"",PRTYSORT,"#",":                  10
                             "#"",OTHAREFS,"#",":                  11
                             "#"",HTMLLNK2,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",CONTDESC,"#",":                  18
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",TEMPDAT3,"#",":                 *20
                             "#"",ALREUFR1,"#",":                 *21 
                             "#"",ALREPRCM,"#",":                 *22
                             "#"",DIM20,"#",":                    *23
                             "#"",SP1,"#",":                      *24
                             "#"",PRTYCLAS,"#",":                 *25
                             "#"",HOSPNAME,"#",":                 *26 
                             "#"",TRGSDESC,"#",":                 *27
                             "#"",ALREDREV,"#",":                 *28 T0881801
                             "#"",LNKVREAS,"#",":                 *29 T0881801
                             "#"",LNKVLOCN,"#",":                 *30 T0881801
                             "#"",HCPDLDES,"#"":                  *31 A0912348
                             ");"
            ENDIF
          ENDIF
          GOTO      WRTHTM99
.
WRTHTM99  RETURN
.******************************************************************************
.           Find any Active Referral
.******************************************************************************
FINDAR00  MOVE      ZERO,EXIT
          MOVE      ZERO,OTHAREFS
.                                           * save key to reposition on -
          PACK      KEY22,DEPTCODE,ZERO,ALREHCP,ALREVISN         * Key 4
          PACK      KEY27,DOCTCODE,ZERO,ALRERDAT,ALREVISN        * Key 5
          MOVE      ALREURNO,KEY8
.
          PACK      KEY16,ALREURNO,SP70
          CALL      RSALREF2                * positional read
FINDAR10  CALL      RKALREF2                * read a record forward
          BRANCH    OVRCD,FINDAR90
.
          MATCH     ALREURNO,KEY8
          GOTO      FINDAR90 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT
          GOTO      FINDAR10 IF NOT EQUAL
.
          MOVE      ONE,OTHAREFS            * active referral found
.
.
FINDAR90  MATCH     SP70,DEPTCODE
          IF        !@EQUAL
.                                           * reposition on current key 4 recd
            CALL      RDALREF4              * using KEY22
          ELSE
.                                           * reposition on current key 5 recd
            CALL      RDALREF5              * using KEY27
          ENDIF
.
FINDAR99  RETURN
.******************************************************************************
.           Write Active Referral
.******************************************************************************
ACTDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1 
          ELSE 
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2 
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      SP70,UC34DESC
          MATCH     SP70,ALREUC34           
          IF        !@EQUAL                 
            PACK      KEY5,CATLH,ALREUC34,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,UC34DESC
            ENDIF   
          ENDIF
.
          MOVE      "gb",CATEGORY
          MOVE      ALRECONT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CONTDESC                     
. 
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE    SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00
.
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,REFTDESC
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC     * SACS referral
          ENDIF
.
          MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
.--------*T0881801 - Get linked visit/Reason for Adm and Location
.-------- for columns LNKVREAS, LNKVLOCN
          CALL      LLOCN000
.
          MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,ACTDIS10,ACTDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL 
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
             WRITE     HTMLFILE;"</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCS00
.             WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
            ELSE
              WRITE     HTMLFILE;"#"",DOCFNAME,"#",";              8
            ENDIF
.
            WRITE     HTMLFILE;"#"",ALREPRTY,"#",":                9
                             "#"",ALRECOMP,"#",":                  10
                             "#"",ALREUNIT,"#",":                  11
                             "#"",ALRERTYP,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",CONTDESC,"#",":                  18
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",ALREUFR1,"#",":                 *20 
                             "#"",ALREPRCM,"#",":                 *21
                             "#"",ALREDREV,"#",":                 *22 T0881801
                             "#"",LNKVREAS,"#",":                 *23 T0881801
                             "#"",LNKVLOCN,"#"":                  *24 T0881801
                             ");"
          ENDIF
          GOTO      ACTDIS99
.
.... C-37051
ACTDIS10  PACK      KEY10,USERID,SP70       * If Department Security is 1
          CALL      RDWBSE1
          BRANCH    OVRCD,ACTDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG           * sort ?                
            IF        !@EQUAL            
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
               MATCH     "1",DOCINDIC
               IF        @EQUAL
                 CALL      DISHCP00
.                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
               ELSE
                 WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
               ENDIF
.
               WRITE     HTMLFILE;"</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.               WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            8
              ENDIF
.
              WRITE     HTMLFILE;"#"",ALREPRTY,"#",":              9
                             "#"",ALRECOMP,"#",":                  10
                             "#"",ALREUNIT,"#",":                  11
                             "#"",ALRERTYP,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",CONTDESC,"#",":                  18
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",ALREUFR1,"#",":                 *20 
                             "#"",ALREPRCM,"#",":                 *21
                             "#"",ALREDREV,"#",":                 *22 T0881801
                             "#"",LNKVREAS,"#",":                 *23 T0881801
                             "#"",LNKVLOCN,"#"":                  *24 T0881801
                             ");"
            ENDIF
          ELSE
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon >":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
               MATCH     "1",DOCINDIC
               IF        @EQUAL
                 CALL      DISHCP00
.                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
               ELSE
                 WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
               ENDIF
.
               WRITE     HTMLFILE;"</tr>"
             ELSE
               CLEAR     HTMLLINK
               APPEND    SP1,HTMLLINK
               RESET     HTMLLINK
.
               WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                               "#"",FORMATNM,"#",":                  1
                               "#"",PSEX,"#",":                      2
                               "#"",ALREURNO,"#",":                  3
                               "#"",TEMPDAT1,"#",":                  4
                               "#"",TEMPDAT2,"#",":                  5
                               "#"",LSTENDAT,"#",":                  6
                               "#"",PROBLEM,"#",";                   7
.
               MATCH     "1",DOCINDIC
               IF        @EQUAL
                 CALL      DISHCS00
.                WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
               ELSE
                 WRITE     HTMLFILE;"#"",DOCFNAME,"#",";             8
               ENDIF
.
               WRITE     HTMLFILE;"#"",ALREPRTY,"#",":               9
                               "#"",ALRECOMP,"#",":                  10
                               "#"",ALREUNIT,"#",":                  11
                               "#"",ALRERTYP,"#",":                  12
                               "#"",UC34DESC,"#",":                  13
                               "#"",ALSTDESC,"#",":                  14
                               "#"",REFTDESC,"#",":                  15
                               "#"",ALREPSIT,"#",":                  16
                               "#"",PREFSITE,"#",":                  17
                               "#"",CONTDESC,"#",":                  18
                               "#"",FOLDERSF,"#",":                 *19
                               "#"",ALREUFR1,"#",":                 *20 
                               "#"",ALREPRCM,"#",":                 *21
                               "#"",ALREDREV,"#",":                *22 T0881801
                               "#"",LNKVREAS,"#",":                *23 T0881801
                               "#"",LNKVLOCN,"#"":                 *24 T0881801
                               ");"
             ENDIF
          ENDIF
          GOTO      ACTDIS99
.
ACTDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,ACTDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ? 
            IF        !@EQUAL            
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.               WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            8
              ENDIF
.
              WRITE     HTMLFILE;"#"",ALREPRTY,"#",":              9
                             "#"",ALRECOMP,"#",":                  10
                             "#"",ALREUNIT,"#",":                  11
                             "#"",ALRERTYP,"#",":                  12
                             "#"",UC34DESC,"#",":                  13
                             "#"",ALSTDESC,"#",":                  14
                             "#"",REFTDESC,"#",":                  15
                             "#"",ALREPSIT,"#",":                  16
                             "#"",PREFSITE,"#",":                  17
                             "#"",CONTDESC,"#",":                  18
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",ALREUFR1,"#",":                 *20 
                             "#"",ALREPRCM,"#",":                 *21
                             "#"",ALREDREV,"#",":                 *22 T0881801
                             "#"",LNKVREAS,"#",":                 *23 T0881801
                             "#"",LNKVLOCN,"#"":                  *24 T0881801
                             ");"
            ENDIF
          ENDIF
.
ACTDIS99  RETURN
.******************************************************************************
.      Write a closed referral
.******************************************************************************
CLSDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALREDCLO,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      "LL",CATEGORY
          MOVE      ALRERCLO,CODE             * get reason for closure
          CALL      GETCOD00
          MOVE      TDESC,REASCLOS
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      SP70,DOCFNAME
          ENDIF

          CALL      GTLENC00                * last encounter date
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
          MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,CLSDIS10,CLSDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?                
          IF        !@EQUAL            
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",REASCLOS,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",";                   6
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCS00
.             WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
            ELSE
              WRITE     HTMLFILE;"#"",DOCFNAME,"#",";              7
            ENDIF
.
            WRITE     HTMLFILE;"#"",REASCLOS,"#",":                8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",ALREUFR1,"#",":                 *20 
                             "#"",ALREPRCM,"#"":                  *21
                             ");"
          ENDIF
          GOTO      CLSDIS99
.
CLSDIS10  MATCH     "1",SORTFLAG                       * sort ?                
          IF        !@EQUAL            
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon >":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",REASCLOS,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    SP1,HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",";                   6
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCS00
.             WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
            ELSE
              WRITE     HTMLFILE;"#"",DOCFNAME,"#",";              7
            ENDIF
.
            WRITE     HTMLFILE;"#"",REASCLOS,"#",":                8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",ALREUFR1,"#",":                 *20
                             "#"",ALREPRCM,"#"":                  *21
                             ");"
          ENDIF
          GOTO      CLSDIS99
.
CLSDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,ACTREF99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL            
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.               WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",REASCLOS,"</td>":
                             "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",";                   6
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.               WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            7
              ENDIF
.
              WRITE     HTMLFILE;"#"",REASCLOS,"#",":              8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",ALREUFR1,"#",":                 *20 
                             "#"",ALREPRCM,"#"":                  *21
                             ");"
            ENDIF  
          ENDIF
.
CLSDIS99  RETURN
.******************************************************************************
.          Write Inactive referral
.******************************************************************************
INADIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALREDINA,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted date of inactivation
          ENDIF
.
          MOVE      ALREDINU,PRTPDATE
          CALL      ALLDAT00                * Fromat the Date
          MOVE      FBOKDATE,TEMPDATE       * formatted date of inactivation
.
          MOVE      "LI",CATEGORY           * get the reason for inactivation
          MOVE      ALRERINA,CODE
          CALL      GETCOD00
          MOVE      TDESC,REASINAC
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00                * last encounter date
.
          MOVE      SP70,CLASDINU
          MOVE      TEMPDATE,DATETILL
          REP       " 0",XCDATE
          MATCH     XCDATE,ALREDINU
          IF        @LESS
            MOVE      SP70,DATETILL
            APPEND    "<font color=red>",DATETILL
            APPEND    TEMPDATE,DATETILL
            APPEND    "</font>",DATETILL
            RESET     DATETILL
            MOVE      "RedText",CLASDINU
          ENDIF
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
          MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,INADIS10,INADIS20
.
          MATCH     "1",SORTFLAG                       * sort ?                
          IF        !@EQUAL            
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",DATETILL,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",REASINAC,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",LSTENDAT,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",DATETILL,"#",":                  6
                             "#"",PROBLEM,"#",":                   7
                             "#"",REASINAC,"#",":                  8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *11
                             "#"",ALREUFR1,"#",":                 *12 
                             "#"",ALREPRCM,"#",":                 *13
                             "#"",ALREDINU,"#",":                 *14
                             "#"",CLASDINU,"#"":                  *15
                             ");"
          ENDIF 
          GOTO      INADIS99
.
INADIS10  MATCH     "1",SORTFLAG                       * sort ?                
          IF        !@EQUAL            
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon >":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",DATETILL,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",REASINAC,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    SP1,HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",LSTENDAT,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",DATETILL,"#",":                  6
                             "#"",PROBLEM,"#",":                   7
                             "#"",REASINAC,"#",":                  8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *11
                             "#"",ALREUFR1,"#",":                 *12 
                             "#"",ALREPRCM,"#",":                 *13
                             "#"",ALREDINU,"#",":                 *14
                             "#"",CLASDINU,"#"":                  *15
                             ");"
          ENDIF
          GOTO      INADIS99
.
INADIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,INAREF99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL            
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",DATETILL,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",REASINAC,"</td>":
                             "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",LSTENDAT,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",DATETILL,"#",":                  6
                             "#"",PROBLEM,"#",":                   7
                             "#"",REASINAC,"#",":                  8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *11
                             "#"",ALREUFR1,"#",":                 *12 
                             "#"",ALREPRCM,"#",":                 *13
                             "#"",ALREDINU,"#",":                 *14
                             "#"",CLASDINU,"#"":                  *15
                             ");"
            ENDIF  
          ENDIF
          GOTO      INADIS99
.
INADIS99  RETURN
.-----------------------------------------------------------------------------.
.       Write cancelled referral
.******************************************************************************
CANDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALREDCAN,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted date cancelled
          ENDIF
.
          MOVE      "LN",CATEGORY
          MOVE      ALRERCAN,CODE 
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00                * last encounter date
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
          MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,CANDIS10,CANDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?                
          IF        !@EQUAL            
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",":                   6
                             "#"",TDESC,"#",":                     7
                             "#"",ALREPSIT,"#",":                  8
                             "#"",PREFSITE,"#",":                  9
                             "#"",FOLDERSF,"#",":                 *10
                             "#"",ALREUFR1,"#",":                 *11 
                             "#"",ALREPRCM,"#"":                  *12
                             ");"
          ENDIF
          GOTO      CANDIS99
.
CANDIS10  MATCH     "1",SORTFLAG                       * sort ?                
          IF        !@EQUAL            
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon > ":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    SP1,HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",":                   6
                             "#"",TDESC,"#",":                     7
                             "#"",ALREPSIT,"#",":                  8
                             "#"",PREFSITE,"#",":                  9
                             "#"",FOLDERSF,"#",":                 *10
                             "#"",ALREUFR1,"#",":                 *11 
                             "#"",ALREPRCM,"#"":                  *12
                             ");"
          ENDIF
.
          GOTO      CANDIS99
.
CANDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,CANREF99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL            
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",":                   6
                             "#"",TDESC,"#",":                     7
                             "#"",ALREPSIT,"#",":                  8
                             "#"",PREFSITE,"#",":                  9
                             "#"",FOLDERSF,"#",":                 *10
                             "#"",ALREUFR1,"#",":                 *11
                             "#"",ALREPRCM,"#"":                  *12
                             ");"
            ENDIF
.
          ENDIF
          GOTO      CANDIS99
.
CANDIS99  RETURN
.-----------------------------------------------------------------------------.
.          Format Date
.-----------------------------------------------------------------------------.
ALLDAT00  MOVE      SP70,FBOKDATE
.
          MATCH     PRTPDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp",FBOKDATE
            GOTO     ALLDAT99
          ENDIF
          UNPACK    PRTPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         CLEAR     CCENT
.         CLEAR     CYEAR
.         CLEAR     CMON
.        CLEAR     CDAY
.
.        UNPACK    PRTPDATE,CCENT,CYEAR,CMON,CDAY
.         MOVE      CMON,F2
.         LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.         UNPACK    ATIME,DIM2,DIM1,DIM2A
.         MOVE      DIM2,F2
.         IF        F2>=12
.           MOVE      "pm",DIM2B
.           IF         F2>=13
.             ASSIGN     F2-12,F2
.             MOVE       F2,DIM2
.           ENDIF
.         ELSE
.           MOVE      "am",DIM2B
.           MOVE      F2,DIM2
.         ENDIF
.
.         PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.         PACK      FBOKDTTM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
.                            AT,DIM2,DIM1,DIM2B
.
ALLDAT99  RETURN
.
CHNCLR00  MOVE      "1",COLRFLAG
CHNCLR99  RETURN
.
.******************************************************************************
.             Referral Table Patient Details                                  .
.******************************************************************************
HCPROF00  PACK      KEY10,ALREHCP,SP70             * Health Care Professional
          CALL      RDPMHCP1
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
HCPROF99  RETURN
.
PROBLM00  PACK      KEY12,ALREDEPT,ALREPRO1,SP70  * Problem
          CALL      RDALPRR1
          IF        OVRCD=1
            CALL      CLALPR00
          ENDIF
.
PROBLM99  RETURN
.
DIAGNS00  PACK      KEY12,ALREDEPT,ALREDIA1,SP70  * DIAGNOSIS
          CALL      RDALDIA1
          IF        OVRCD=1
            CALL      CLALDI00
          ENDIF
.
DIAGNS99  RETURN
.
PRIRTY00  MOVE      "PR",PRIOCATE                 * Priority
          PACK      KEY5,PRIOCATE,ALREPRTY,SP70
          CALL      RDCODE3
          IF        OVRCD = 1
            MOVE     SP70,TDESC
          ENDIF
.
PRIRTY99  RETURN
.
COMPON00  MOVE      "CL",COMPCATE                * Compensation
          PACK      KEY5,ALRECOMP,COMPCATE,SP70
          CALL      RDCODE3
.
COMPON99  RETURN
.
LIDAYS00  MOVE      ALRERDAT,CDYSFDTE             * List days between 2 dates
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,CDYSTDTE
          SUB       ONE,CDYSDAYS
.
LIDAYS99  RETURN
.
LEDATE00  ASSIGN    ZERO,ECOUNTN1
          PACK      KEY16,ALREVISN,SP70          * Last Encounter Date
          CALL      RSALENC1
LEDATE10  CALL      RKALENC1
          BRANCH    OVRCD,LEDATE20
          MATCH     ALREVISN,ALENVISN
          GOTO      LEDATE10 IF NOT EQUAL
          MOVE      ALENENCT,ECOUNTN2
          IF        ECOUNTN1<ECOUNTN2
            ASSIGN    ECOUNTN2,ECOUNTN1
            GOTO    LEDATE10
          ELSE
            GOTO    LEDATE10
          ENDIF
LEDATE20  MOVE      ECOUNTN1,ALENENCT
          PACK      KEY16,ALENVISN,ALENENCT,SP70
          CALL      RDALENC1
.
LEDATE99  RETURN
.
REAFCL00  MOVE      "LL",REAFORCL                * Reason For Closure
          PACK      KEY5,ALRERCLO,REAFORCL,SP70
          CALL      RDCODE3
.
REAFCL99  RETURN
.
OUTCOM00  MOVE      "LL",OUTCOMLL                * OutCome
          PACK      KEY5,ALRERCLO,OUTCOMLL,SP70
          CALL      RDCODE3
.
OUTCOM99  RETURN
.
REASON00  MOVE      "LI",INREASON                * Reason
          PACK      KEY5,ALRERINA,INREASON,SP70
          CALL      RDCODE3
.
REASON99  RETURN
.
HTMLNK00  APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    ALREURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREDEPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
HTMLNK99  RETURN
.******************************************************************************
.      write a record to the Referral Status History Table
.******************************************************************************
WRTRSH00  MOVE      ALREVISN,ALSTVISN       * Populate all the fields and write
          MOVE      ALRESTAT,ALSTSTAT
          PACK      ALSTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSTCDAT
          CLOCK     TIME,ALSTCTIM
          MOVE      WBSEUID,ALSTCUID
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT,SP70
          CALL      RAALSTS1
          IF        OVRCD=0
            CALL      UPALSTS1                * update to the file
          ELSE
            CALL      WRALSTS1                * write to the file
          ENDIF
.
WRTRSH99  RETURN
.
.******************************************************************************
. write a view audit record when viewing allweb0202002. Do not write a view
. record if the last audit is for the same user within the minute. This
. will stop extra view audits from redirects
.******************************************************************************
AUDV0000  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY24,ALREVISN,Z70
          CALL      RSALAUD1
          CALL      RPALAUD1
          BRANCH    OVRCD,AUDV5000
.
          MATCH     ALREVISN,ALAUVISN
          GOTO      AUDV5000 IF NOT EQUAL
.
          MATCH     USERID,ALAUAUID
          GOTO      AUDV5000 IF NOT EQUAL
.
          MOVE      ALAUADAT,FIRSTDAT
          MOVE      ALAUATIM,D5
          REP       ": ",D5
          SQUEEZE   D5
          PACK      FIRSTIME,D5,SP70
.
          MOVE      CURRDATE,LASTDATE
          MOVE      CTIMEIS,D5
          REP       ": ",D5
          SQUEEZE   D5
          PACK      LASTTIME,D5,SP70
.
          CALL      TIMEDIFF
.
          IF        CALCTIME = 0    
            GOTO      AUDV9999         * Write audit if more the 1 minute 
          ENDIF
.
AUDV5000  MOVE      "V ",UPDTTYPE      * View record for allweb0202002
          CALL      WRTRAU00
.
AUDV9999  RETURN
.******************************************************************************
.      write a record to the Referral Audit Table
. Requires: UPDTTYPE: update type for allaudaf
.******************************************************************************
WRTRAU00  CALL      CLALLAUD                     * clear allaudaf variables
.
          MOVE      ALREVISN,ALAUVISN
          PACK      ALAUADAT,CCC,CYY,CMM,CDD
          REP       " 0",ALAUADAT
          CLOCK     TIME,ALAUATIM
          MOVE      UPDTTYPE,ALAUUPDT
          MOVE      WBSEUID,ALAUAUID
.
          MATCH     SP70,ACTNCODE
          IF        !@EQUAL
            MOVE      ACTNCODE,ALAUACTI
          ENDIF
.
          MATCH     SP70,COMMENTY
          IF        !@EQUAL
            MOVE      COMMENTY,ALAUCOMM
          ENDIF
.
          PACK      AUDITKEY,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          PACK      KEY24,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          CALL      RDALAUD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRALAUD1                * write to the file
            TRAPCLR   IO
            BRANCH    OVRCD,WRTRAU99
          ENDIF
WRTRAU99  RETURN
.******************************************************************************
. Get last encounter date
.******************************************************************************
GTLENC00  MOVE      SP70,LSTENDAT
          MOVE      SP70,SAVELDAT
          PACK      KEY32,ALREVISN,Z70
          CALL      RSALENC6
GTLENC10  CALL      RPALENC6
          BRANCH    OVRCD,GTLENC15
.
          MATCH     ALREVISN,ALENVISN
          GOTO      GTLENC15 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA                      * Cancelled
          GOTO      GTLENC10 IF EQUAL
.
          MOVE      ALENSDAT,SAVELDAT
.
GTLENC15  PACK      KEY16,ALREVISN,SP70
          CALL      RSALGPA2
GTLENC20  CALL      RKALGPA2
          BRANCH    OVRCD,GTLENC30
.
          MATCH     ALREVISN,ALGAREFN
          GOTO      GTLENC30 IF NOT EQUAL
.
          MATCH     "1",ALGARCST
          GOTO      GTLENC20 IF EQUAL            * Deleted
.
          PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GTLENC20
.
          MATCH     "A",TCINDC3
          GOTO      GTLENC20 IF NOT EQUAL
.
          PACK      KEY8,ALGACONT,SP70
          CALL      RDALGRE1
          BRANCH    OVRCD,GTLENC20
.
          MATCH     ALGEGDTE,SAVELDAT
          IF        @LESS
            MOVE      ALGEGDTE,SAVELDAT
          ENDIF
.
          GOTO      GTLENC20
.
GTLENC30  PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
GTLENC35  CALL      RKALLNK1                * Linked OP visits
          BRANCH    OVRCD,GTLENC40
.
          MATCH     ALREVISN,ALLNVISN
          GOTO      GTLENC40 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelledx
          GOTO      GTLENC35 IF EQUAL
.
          PACK      KEY36,ALLNLNKV,Z70
          CALL      RDSBOKA6
          CALL      RDPBOKA6
          BRANCH    OVRCD,GTLENC35
.
          MATCH     ALLNLNKV,DOBAOUTN
          GOTO      GTLENC35 IF NOT EQUAL
.
          IF        OBASTAT<>4
            GOTO      GTLENC35
          ENDIF
.
          MATCH     OBADATE,SAVELDAT
          IF        @LESS
            MOVE      OBADATE,SAVELDAT
          ENDIF
.
          GOTO      GTLENC35
.
GTLENC40  MATCH     SAVELDAT,SP70
          IF        @EQUAL
            MOVE     SP70,LSTENDAT
            GOTO      GTLENC99
          ENDIF
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      SAVELDAT,LSTENDAT
          ELSE
            UNPACK    SAVELDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      LSTENDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
GTLENC99  RETURN
.******************************************************************************
. Clear for Diagnosis file 
.******************************************************************************
CLALDI00  MOVE      SP70,ALDIDEPT 
          MOVE      SP70,ALDIDIAG 
          MOVE      SP70,ALDIDESC 
          MOVE      SP70,ALDIICD  
          MOVE      SP70,ALDIACTV 
          MOVE      SP70,ALDICDAT 
          MOVE      SP70,ALDICTIM 
          MOVE      SP70,ALDICUID 
          MOVE      SP70,ALDIUDAT 
          MOVE      SP70,ALDIUTIM 
          MOVE      SP70,ALDIUUID 
          MOVE      SP70,ALDISPAR 
.
CLALDI99  RETURN
.
.******************************************************************************
. Clear for problem file   
.******************************************************************************
CLALPR00  MOVE      SP70,ALPRDEPT
          MOVE      SP70,ALPRPROB
          MOVE      SP70,ALPRDESC
          MOVE      SP70,ALPRICD 
          MOVE      SP70,ALPRACTV
          MOVE      SP70,ALPRCDAT
          MOVE      SP70,ALPRCTIM
          MOVE      SP70,ALPRCUID
          MOVE      SP70,ALPRUDAT
          MOVE      SP70,ALPRUTIM
          MOVE      SP70,ALPRUUID
.
CLALPR99  RETURN
.******************************************************************************
.* Generate next job number if this department is using job numbers           *
.******************************************************************************
ALJOBN00  READ      CONTROLF,HUND06;*6,ALCNDEPT
          MATCH     ALREDEPT,ALCNDEPT
          GOTO      ALJOBN99 IF NOT EQUAL
.
          READ      CONTROLF,HUND06;*9,ALCNJOBN
          ADD       ONE,ALCNJOBN
          WRITAB    CONTROLF,HUND06;*9,ALCNJOBN
          SUB       ONE,ALCNJOBN
          MOVE      ALCNJOBN,ALREUNO2
.
ALJOBN99  RETURN
.
.------------------------------------------------------------
. Output HTML Override Confirm Message
.------------------------------------------------------------
WEBOVR00  CALL      OPENHTML
          BRANCH    EXIT,WEBOVR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
           "  var PopUpScreen = parent.document.getElementById('PopUpScreen');":
                   "  if (alert(#"",WEBTITLE,"\n#")) {;":
                   "    parent.PageUpdateForm.override.value=#"1#"; ":
                   "    }":
                   "  else {":
                   "    if (PopUpScreen) {":
                   "      PopUpScreen.style.display='none';  }":
                   "    else {":
                   "      history.go(-1)  }}":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      WEBOVR99
.
WEBOVR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBOVR99  RETURN
.
.------------------------------------------------------------
. SPMAS000 - Set Parameters for Master Details
. Returns:    EXIT   0
.                    1
.------------------------------------------------------------
.
SPMAS000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMAS910,SPMAS910,SPMAS910,SPMAS910,SPMAS910:
                       SPMAS910,SPMAS910,SPMAS080,SPMAS090,SPMAS100:
                       SPMAS110,SPMAS120,SPMAS130,SPMAS910,SPMAS910:
                       SPMAS910,SPMAS910,SPMAS910,SPMAS910,SPMAS910:
                       SPMAS910,SPMAS910,SPMAS230,SPMAS910,SPMAS910:
                       SPMAS910,SPMAS910,SPMAS910,SPMAS910,SPMAS910:
                       SPMAS910,SPMAS910,SPMAS910,SPMAS910,SPMAS910:
                       SPMAS360,SPMAS370,SPMAS380
.
          GOTO      SPMAS910

SPMAS080  MOVE      QRYDATA,PTMAS008
          GOTO      SPMAS900
.
SPMAS090  MOVE      QRYDATA,PTMAS009
          GOTO      SPMAS900
.
SPMAS100  MOVE      QRYDATA,PTMAS010
          GOTO      SPMAS900
.
SPMAS110  MOVE      QRYDATA,PTMAS011
          GOTO      SPMAS900
.
SPMAS120  MOVE      QRYDATA,PTMAS012
          GOTO      SPMAS900
.
SPMAS130  MOVE      QRYDATA,PTMAS013
          GOTO      SPMAS900
.
SPMAS230  MOVE      QRYDATA,PTMAS023
          GOTO      SPMAS900
.
SPMAS360  MOVE      QRYDATA,PTMAS036
          GOTO      SPMAS900
.
SPMAS370  MOVE      QRYDATA,PTMAS037
          GOTO      SPMAS900
.
SPMAS380  MOVE      QRYDATA,PTMAS038
          GOTO      SPMAS900
.
SPMAS900  MOVE      ONE,MASUPDFL
          MOVE      ZERO,EXIT
          GOTO      SPMAS999
.
SPMAS910  MOVE      ONE,EXIT
SPMAS999  RETURN
.
.------------------------------------------------------------
. SPMSX000 - Set Parameters for Master Extension Details
. Returns:    EXIT   0
.                    1
.------------------------------------------------------------
.
SPMSX000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX910:
                       SPMSX910,SPMSX910,SPMSX910,SPMSX910,SPMSX450
.
          GOTO      SPMSX910
.
SPMSX450  MOVE      QRYDATA,PTMSX045
          GOTO      SPMSX900
.
SPMSX900  MOVE      ONE,MASUPDFL
          MOVE      ZERO,EXIT
          GOTO      SPMSX999
.
SPMSX910  MOVE      ONE,EXIT
SPMSX999  RETURN
+
.------------------------------------------------------------
. MVPMI000 - Move pmi cgi variables
.------------------------------------------------------------
MVPMI000  MATCH     PTMAS008,Z70
          IF        !@EQUAL
            MOVE      PTMAS008,PADD1
          ENDIF
.
          MATCH     PTMAS009,Z70
          IF        !@EQUAL
            MOVE      PTMAS009,PADD2
          ENDIF
.
          MATCH     PTMAS010,Z70
          IF        !@EQUAL
            MOVE      PTMAS010,PSUBRB
          ENDIF
.
          MATCH     PTMAS011,Z70
          IF        !@EQUAL
            MOVE      PTMAS011,PADD4
          ENDIF
.
          MATCH     PTMAS012,Z70
          IF        !@EQUAL
            MOVE      PTMAS012,PPOST
          ENDIF
.
          MATCH     PTMAS013,Z70
          IF        !@EQUAL
            MOVE      PTMAS013,PTELEP
          ENDIF
.
          MATCH     PTMAS023,Z70
          IF        !@EQUAL
            MOVE      PTMAS023,PMEDI
          ENDIF
.
          MATCH     PTMAS036,Z70
          IF        !@EQUAL
            MOVE      PTMAS036,PFUNDH
          ENDIF
.
          MATCH     PTMAS037,Z70
          IF        !@EQUAL
            MOVE      PTMAS037,PFNDTB
          ENDIF
.
          MATCH     PTMAS038,Z70
          IF        !@EQUAL
            MOVE      PTMAS038,PFNDMM
          ENDIF
.
          MATCH     Z70,PMPXI059
          IF        !@EQUAL
            PACK      KEY10,PMPXI059,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              IF        (PMHCHCST = 3)|(PMHCHCST = 4)
                MOVE      PMPXI059,PMPXRHC1
                MOVE      PMPXI060,PMPXRH1G
                MOVE      PMPXI061,PMPXR1GC
              ENDIF
              IF        (PMHCHCST = 5)|(PMHCHCST = 6)
                MOVE      PMPXI059,PMPXRHC1
                MOVE      PMPXI060,PMPXRH1G
                MOVE      PMPXI061,PMPXR1GC
              ENDIF
              IF        (PMHCHCST = 11)|(PMHCHCST = 12)|(PMHCHCST = 13)
                MOVE      PMPXI059,PMPXRHC1
                MOVE      PMPXI060,PMPXRH1G
                MOVE      PMPXI061,PMPXR1GC
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     Z70,PTMSX045
          IF        !@EQUAL
            MOVE      PTMSX045,PTMXMCCD
          ENDIF
.
.         cgi variables for pmspx2af file
.
          MATCH     PMPXI023,Z70
          IF        !@EQUAL
            MOVE      PMPXI023,PMPXMSNA
          ENDIF

          MATCH     PMPXI024,Z70
          IF        !@EQUAL
            MOVE      PMPXI024,PMPXMGNA
          ENDIF
.
          MATCH     PMPXI032,Z70
          IF        !@EQUAL
            MOVE      PMPXI032,PMPXMBNO
          ENDIF
.
          MATCH     PMPXI033,Z70
          IF        !@EQUAL
            MOVE      PMPXI033,PMPXMMNO
          ENDIF
.
          MATCH     PMPXI039,Z70
          IF        !@EQUAL
            MOVE      PMPXI039,PMPXFSNA
          ENDIF
.
          MATCH     PMPXI040,Z70
          IF        !@EQUAL
            MOVE      PMPXI040,PMPXFGNA
          ENDIF
.
          MATCH     PMPXI016,Z70
          IF        !@EQUAL
            MOVE      PMPXI016,PMPXMEDC
          ENDIF
.
          MATCH     PMPXI048,Z70
          IF        !@EQUAL
            MOVE      PMPXI048,PMPXFBNO
          ENDIF
.
          MATCH     PMPXI049,Z70
          IF        !@EQUAL
            MOVE      PMPXI049,PMPXFMNO
          ENDIF
.
          MATCH     PMPXI076,Z70
          IF        !@EQUAL
            MOVE      PMPXI076,PMPXCONP
          ENDIF
.
          MATCH     PMPXI104,Z70
          IF        !@EQUAL
            MOVE      PMPXI104,PMPXUPRF
          ENDIF
.
MVPMI999  RETURN
.
.-------------------------------------------------------------------
.   Overdue Referral Tables (Must be seen by date) %ALLWEB02.01.026
.
.   THIS IS NOT A GOOD KEY FOR THIS TABLE. WE MAY NEED A NEW ONE
.-------------------------------------------------------------------
OVRT0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
.
          MOVE      SP2,NZFLAG
          UNPACK    DIM127,D1,NZFLAG,DIM127     * NZ = NZ display format
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY30,DEPTCODE,ZERO,SP70
          CALL      RSALREF6                * positional read
OVRT0010  CALL      RKALREF6                * read a record forward
          BRANCH    OVRCD,OVRT9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT       * Check correct department
          GOTO      OVRT9999 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            
          GOTO      OVRT0011 IF EQUAL
.
          MATCH     "1",ALRESTAT
          GOTO      OVRT0011 IF EQUAL
.
          GOTO      OVRT9999                * ALRESTAT is 2 or more, exit.
.
OVRT0011  MATCH     "9",FILTSTAT
          GOTO      OVRT0020 IF EQUAL       * Filter is 9 (show all)->process
.
          MATCH     FILTSTAT,ALRESTAT       * Filter is same as record->process
          GOTO      OVRT0020 IF EQUAL
.
          GOTO      OVRT0010                * Filter is not same as record->next
.
OVRT0020  MATCH     ALREMDAT,LASTDATE       * Checks lastdate with must be 
          GOTO      OVRT0010 IF LESS        * seen by date
.
          MATCH     FRSTDATE,ALREMDAT       * Checks firstate with must be
          GOTO      OVRT0010 IF LESS        * seen by date
.
          MATCH     "1",ALCNDTRG
          IF        @EQUAL
            PACK      FILTTRGS,FILTTRGS,SP70
            MATCH     SP70,FILTTRGS           * Filter by triage status
            IF        !@EQUAL
              MATCH     FILTTRGS,ALRETRGS
              GOTO      OVRT0010 IF NOT EQUAL    * No, read next referral
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN        * Hospital Filter matched?
            GOTO      OVRT0010 IF NOT EQUAL    * No, read next referral
            GOTO      OVRT0030                 * Yes, check pref site *C-0306959
          ENDIF
.
.         ----------------------------------------------------------------------
.         C-0306959
.         If no hospital filter (All hospital) and override hospital filter used
.         then only list referrals from the hospitals that the user has access
.         to as setup in the mlsecaf table for the user security id
.
          COMPARE   ONE,IBCNMHOS               * Multi Hospital?
          GOTO      OVRT0030 IF NOT EQUAL      * No, check pref site filter
.
          MATCH     "1",OVRDHOSP               * Override hosp filter used?
          GOTO      OVRT0030 IF NOT EQUAL      * No, check pref site filter
.
          PACK      KEY13,USERID,SP70          * User has All hosp access?
          CALL      RDMLSEC1
          BRANCH    OVRCD,OVRT0025             * No, check referral hosp access
          GOTO      OVRT0030                   * Yes, check pref site filter
.
OVRT0025  PACK      KEY13,USERID,ALREHOSN,SP70 * User has access to ref hosp?
          CALL      RDMLSEC1
          BRANCH    OVRCD,OVRT0010             * No, read next referral
          GOTO      OVRT0030                   * Yes, check pref site filter
.
.         ----------------------------------------------------------------------
.
OVRT0030  MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      OVRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE           * Check correct HCP
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      OVRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      OVRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      OVRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      OVRT0035 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      OVRT0035 IF EQUAL
              GOTO      OVRT0010
            ELSE
.
.            MATCH     DOCTCODE,ALRERHCP
             MATCH     DOCTCODE,ALREHCP      *check for responsible HCP
             GOTO      OVRT0010 IF NOT EQUAL
            ENDIF
          ENDIF
.
OVRT0035  MATCH     SP70,FILTTEAM           * Check correct team
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      OVRT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PRIORITY
          IF        !@EQUAL
            MATCH     PRIORITY,ALREPRTY
            GOTO      OVRT0010 IF NOT EQUAL * priority does not match don't disp
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      OVRT0010 IF NOT EQUAL * clinic id filter
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      OVRT0010 IF NOT EQUAL * clinic type filter
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      OVRT0010
          ENDIF
.
          CALL      OVRDIS00                * Display Row
.
          ADD       ONE,DISNUMB
OVRT0060  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      OVRT0010 IF NOT EQUAL
          ELSE
            GOTO      OVRT0010
          ENDIF
.
OVRT9999  RETURN
.
.******************************************************************************
.           Write overdue referral (Must be seen by date)
.******************************************************************************
OVRDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      ALREMDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT3
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT3       * formatted Must Be Seen By Date
          ENDIF
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE             * To get Priority Description
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE    SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MOVE      "ts",CATEGORY
          MOVE      ALRETRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      OVRDIS05 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OVRDIS05
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      OVRDIS05
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
OVRDIS05  MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
.         C-0306959
.         If override hospital filter is set then display the hospital name
.         for the referral
.
          MOVE      SP70,HOSPNAME                   * Initialize hospital name
.
          MATCH     "1",OVRDHOSP                    * Is the override hosp used?
          GOTO      OVRDIS06 IF NOT EQUAL           * No
.
          MATCH     SP3,ALREHOSN                    * Is referred hosp available?
          GOTO      OVRDIS06 IF EQUAL               * No
.
          PACK      KEY3,ALREHOSN,SP70              * Yes, get hospital name
          CALL      RDPTHSP1                        * Read pathspaf
          BRANCH    OVRCD,OVRDIS06                  * Hosp not found
.
          MOVE      PTHSNAME,HOSPNAME               * Populate the Hospital Name
          GOTO      OVRDIS06
.
OVRDIS06  MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,OVRDIS10,OVRDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL
            CALL      WRODTL00
            CALL      WRODTB00 
          ELSE
            CALL      WRODRL00
            CALL      WRODRW00
          ENDIF
.
          GOTO      OVRDIS99
.
.... C-37051
OVRDIS10  PACK      KEY10,USERID,SP70       * If Department Security is 1
          CALL      RDWBSE1
          BRANCH    OVRCD,OVRDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              CALL      WRODTL00
              CALL      WRODTB00
            ELSE
              CALL      WRODRL00
              CALL      WRODRW00
            ENDIF
          ELSE
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                                 "<img src=../images/EditIcon.gif":
                                 " class=ListIcon>":
                                 ALSTDESC,"</td>";
              CALL      WRODTB00
            ELSE
              CLEAR     HTMLLINK
              CALL      WRODRW00
            ENDIF
          ENDIF
.
          GOTO      OVRDIS99
.
OVRDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,OVRDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              CALL      WRODTL00
              CALL      WRODTB00
            ELSE
              CALL      WRODRL00
              CALL      WRODRW00
            ENDIF
          ENDIF
.
OVRDIS99  RETURN
.
.-----------------------------------------------------------------------------.
. Common codes for overdue referral link (Must be seen by date) - No sorting
.-----------------------------------------------------------------------------.
WRODTL00  WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             ALSTDESC,"</td>";
.
WRODTL99  RETURN
.
.-----------------------------------------------------------------------------.
. Common codes for overdue referral (Must be seen by date) - No sorting 
.-----------------------------------------------------------------------------.
WRODTB00  WRITE     HTMLFILE;"<td>&nbsp;",FORMATNM,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>";
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            CALL      DISHCP00
.            WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",OCTDESC,"</td>":
                             "<td>&nbsp;",OCADESC,"</td>";
.
          MATCH     "1",ALCNDTRG
          IF        @EQUAL
            MATCH     NZ,NZFLAG
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",PRIODESC,"</td>";
.
          MATCH     NZ,NZFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",PROBLEM,"</td>":
                               "<td>&nbsp;",ALREUFR1,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",ALREPRCM,"</td>";
          ENDIF
.
          MATCH     "1",OVRDHOSP               
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",ALREVISN,"</td>":
                               "<td>&nbsp;",HOSPNAME,"</td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",ALREVISN,"</td></tr>";
          ENDIF
.
WRODTB99  RETURN
.
.-----------------------------------------------------------------------------.
. Common codes for overdue referral link (Must be seen by date) - Sorting
.-----------------------------------------------------------------------------.
WRODRL00  CLEAR     HTMLLINK
          APPEND    "javascript:UpdateReferral('",HTMLLINK
          APPEND    ALREURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALREVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DEPTCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
WRODRL99  RETURN
.
.-----------------------------------------------------------------------------.
. Common codes for overdue referral (Must be seen by date) - Sorting 
.-----------------------------------------------------------------------------.
WRODRW00  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                 *1
                             "#"",PSEX,"#",":                     *2
                             "#"",ALREURNO,"#",":                 *3
                             "#"",TEMPDAT1,"#",":                 *4
                             "#"",TEMPDAT3,"#",":                 *5
                             "#"",LSTENDAT,"#",":                 *6
                             "#"",PROBLEM,"#",";                  *7
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            CALL      DISHCS00
.            WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",DOCFNAME,"#",";               *8
          ENDIF
.
          WRITE     HTMLFILE;"#"",OCADESC,"#",":                  *9
                             "#"",OCTDESC,"#",":                  *10
                             "#"",PRIODESC,"#",":                 *11
                             "#"",ALSTDESC,"#",":                 *12
                             "#"",ALREMDAT,"#",":                 *13
                             "#"",ALREPRCM,"#",":                 *14
                             "#"",OCTDESC,"#",":                  *15
                             "#"",OCADESC,"#",":                  *16
                             "#"",ALREPSIT,"#",":                 *17
                             "#"",PREFSITE,"#",":                 *18
                             "#"",FOLDERSF,"#",":                 *19
                             "#"",ALREVISN,"#",":                 *20
                             "#"",ALREUFR1,"#",";                 *21
.
          MATCH     "1",ALCNDTRG
          IF        @EQUAL
            MATCH     NZ,NZFLAG
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"",HOSPNAME,"#",":             *22
                                 "#"",TRGSDESC,"#");"             *23
            ELSE
              WRITE     HTMLFILE;"#"",HOSPNAME,"#");"             *22
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",HOSPNAME,"#");"               *22
          ENDIF
.
WRODRW99  RETURN
.
.-----------------------------------------------------------------------------.
.  Link unlink outpatient visits to a referral
.-----------------------------------------------------------------------------.
ALLLNK00  RESET     UPDATETY
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MATCH     SP70,UPDATETY
          GOTO      ALLLNK80 IF EQUAL
.
          MATCH     "A",UPDATETY            * Link a referral to a visit
          GOTO      ALLLNK10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Link visits to a referral
          GOTO      ALLLNK20 IF EQUAL
.
          MATCH     "R",UPDATETY            * Quick re-link of visit and referral
          GOTO      ALLLNK30 IF EQUAL
.
          MATCH     "E",UPDATETY            * Quick re-link of visit and referral
          GOTO      ALLLNK40 IF EQUAL
.
          MATCH     "S",UPDATETY            * Re-link appointment request
          GOTO      ALLLNK50 IF EQUAL
.
          GOTO      ALLLNK90
.
ALLLNK10  CALL      UNKR0000                * Unlink referral from a visit
          BRANCH    EXIT,ALLLNK99
.
          CALL      LNKR0000                * Link referral to a visit
          BRANCH    EXIT,ALLLNK99
.
          MOVE      ZERO,EXIT
          GOTO      ALLLNK99
.
ALLLNK20  CALL      ULNK0000                * Unlink visits from a referral
          BRANCH    EXIT,ALLLNK99
.
          CALL      LINK0000                * Link visits to a referral
          BRANCH    EXIT,ALLLNK99
.
          CALL      URSK0000                * Update Referral Status
.
          MOVE      ZERO,EXIT
          GOTO      ALLLNK99
.
ALLLNK30  CALL      ULNK0000                * Unlink visits from a referral
          BRANCH    EXIT,ALLLNK99
.
          MOVE      ADMISSNO,SAVEADMI
          MOVE      REFERRAL,ADMISSNO
.
          CALL      LINK0000                * Link visits to a referral
          BRANCH    EXIT,ALLLNK99
.
          CALL      MOVENC00                * Move encounters to new referral
.
          CALL      URSK0000                * Update Referral Status
.
          MOVE      ZERO,EXIT
          GOTO      ALLLNK99
.
ALLLNK40  CALL      QIKMOV00
          MOVE      ZERO,EXIT
          GOTO      ALLLNK99
.
ALLLNK50  CALL      RLAPRQ00
          MOVE      ZERO,EXIT
          GOTO      ALLLNK99
.
ALLLNK80  CALL      CURPER00                * Display Routine
          CALL      CALCDT00              * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,ALLLNK91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLLNK91
.
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            CALL      CLALLREF
            CALL      CLALLEID
            GOTO      ALLLNK85
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,ALLLNK92
.
ALLLNK85  CLEAR     WEBTITLE
          MOVE      "Allied Health Referrals Linked Visits",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALLLNK99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALLLNK99
.
ALLLNK90  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLLNK99
.
ALLLNK91  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLLNK99
.
ALLLNK92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLLNK99
.
ALLLNK99  RETURN
.
.------------------------------------------------------------
. Quick relink of encounters to different referral
.------------------------------------------------------------
QIKMOV00  PACK      KEY8,ENCOUTKY,SP70      * First 8 chars is the
          CALL      RDALREF1                * copy from referral number
          BRANCH    OVRCD,QIKMOV92
.
          MOVE      ALREDEPT,SAVEDEPT       * Save original department
.
          PACK      KEY16,ENCOUTKY,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,QIKMOV90
.
          MOVE      ZERO,F8
          PACK      KEY16,REFERRAL,Z70
          CALL      RSALENC1
          CALL      RPALENC1
          BRANCH    OVRCD,QIKMOV10
.
          MATCH     REFERRAL,ALENVISN
          GOTO      QIKMOV10 IF NOT EQUAL
.
          MOVE      ALENENCT,F8
.
QIKMOV10  PACK      KEY8,REFERRAL,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,QIKMOV92
.
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            PACK      KEY3,ALREDEPT,SP70
            CALL      RDALDEP1                      * Read department table
            MATCH     "1",ALDEPENC
            GOTO      QIKMOV93 IF EQUAL
          ENDIF
.
          COMPARE   "99999999",F8
          GOTO      QIKMOV91 IF EQUAL
.
          CALL      CLALLENC
          ADD       ONE,F8
.
          COMPARE   "99999999",F8
          GOTO      QIKMOV91 IF EQUAL
.
          PACK      KEY16,ENCOUTKY,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,QIKMOV90
.
          MOVE      F8,ALENENCT
          MOVE      REFERRAL,ALENVISN
          PACK      KEY16,REFERRAL,ALENENCT,SP70
.
          CALL      AEMHI000                * set to 'Unsent' - MHINC extract
          CALL      WRALENC1                * write to the encounter table
.
          MOVE      ONE,AUDTTYPE            * write history record
          CALL      WAALEN00
.
          IF        PTCNCPAH=1
            CALL      WRCPAT00              * write to the current patient table
          ENDIF
.
          CALL      ALIT0000                * write items to item file
.
          CALL      CMED0000                * Copy medications
          CALL      CSUP0000                * Copy supplies
          CALL      CNOT0000                * Copy notes
          CALL      CINT0000              * Copy interventions
.
          MATCH     "5",NEXTPAGE
          IF        !@EQUAL
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY2,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICEA              * Pass New Encounter to DG *I-90202
          ENDIF                             * Only report HL7 message here if
.                                           * the EOC is not TAC/VET or WORK C
.                                           * Write Record To Erc Table
.
          PACK      KEY16,ENCOUTKY,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,QIKMOV90
.
          MOVE      ONE,ALENRSTA
          CALL      UPALENC1        * If encounter is found, set it to cancelled
          BRANCH    OVRCD,QIKMOV90
.
.               Get Referral & PMI details prior to sending broadcast message
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * allrefaf record on file ?
          BRANCH    OVRCD,QIKMOV99          * no - don't send
.
          MOVE      ALREURNO,KEY8
          CALL      RDMAST1                 * PMI master record on file ?
          BRANCH    OVRCD,QIKMOV99          * no - don't send
.
          MOVE      ALREURNO,KEY8
          CALL      RDPMPX21                * PMI extension on file ?
          BRANCH    OVRCD,QIKMOV99          * no - don't send
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALEN00
.
          MATCH     "1",ALENRSTA
          IF        @EQUAL
            MOVE      TWENTY3,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICED              * Pass Delete to Datagate  *I-90202
          ELSE
            MOVE      TWENTY4,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICEU              * broadcast HL7 A08 update message
          ENDIF
          GOTO      QIKMOV99
.
QIKMOV90  MOVE      "Invalid Contact",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      QIKMOV99
.
QIKMOV91  CLEAR     WEBTITLE
          APPEND    "Contact limit of 99999999 has been reached. ",WEBTITLE
          APPEND    "Please close this referral.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      QIKMOV99
.
QIKMOV92  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      QIKMOV99
.
QIKMOV93  MOVE      "Primary referral does not allow Contacts",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      QIKMOV99
.
QIKMOV99  RETURN
.
.------------------------------------------------------------------------------
. Relink appointment request
.------------------------------------------------------------------------------
RLAPRQ00  MATCH     SP8,REFERRAL             * Check If referral is Blank
          GOTO      RLAPRQ91 IF EQUAL
.
          MATCH     SP70,OTARTKEY             * Check appointment request key
          GOTO      RLAPRQ92 IF EQUAL
.
          UNPACK    KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM
          PACK      KEY32,OTARURNO,REFERRAL,OTARRQDT,OTARRQTM,SP70
          CALL      RDOTART1
          IF        OVRCD=0
            GOTO      RLAPRQ93
          ENDIF
.
          PACK      KEY32,OTARTKEY,SP70
          CALL      RDOTART1
          BRANCH    OVRCD,RLAPRQ92
.
          MOVE      REFERRAL,OTARREFN
          CALL      UPOTART1
          BRANCH    OVRCD,RLAPRQ93
.
          GOTO      RLAPRQ99
.
RLAPRQ91  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RLAPRQ99
.
RLAPRQ92  MOVE      "Invalid Appointment Request Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RLAPRQ99
.
RLAPRQ93  MOVE      "Re-link ppointment Request Already Existed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RLAPRQ99
.
RLAPRQ99  RETURN
.
.------------------------------------------------------------
. Copy medications to new encounter
.------------------------------------------------------------
CMED0000  PACK      KEY24,ENCOUTKY,SP70
          CALL      RSALEMD1
CMED1000  CALL      RKALEMD1                * Read original medications
          BRANCH    OVRCD,CMED9999
.
          PACK      DIM16,ALEMVISN,ALEMENCT
          MATCH     DIM16,ENCOUTKY
          GOTO      CMED9999 IF NOT EQUAL
.
          PACK      SAVKEY24,ALEMVISN,ALEMENCT,ALEMMCNT,SP70
.
          MOVE      ZERO,F8
          PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      RSALEMD1
          CALL      RPALEMD1               * Get new medication count
          BRANCH    OVRCD,CMED5000
.
          MATCH     ALENVISN,ALEMVISN
          GOTO      CMED5000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALEMENCT
          GOTO      CMED5000 IF NOT EQUAL
.
          MOVE      ALEMMCNT,F8
.
CMED5000  PACK      KEY24,SAVKEY24,SP70
          CALL      RDALEMD1                * Re read original medication
          BRANCH    OVRCD,CMED1000
.
          MOVE      ALENVISN,ALEMVISN       * Change to new encounter
          MOVE      ALENENCT,ALEMENCT
          ADD       ONE,F8
          MOVE      F8,ALEMMCNT
.
          PACK      KEY24,ALEMVISN,ALEMENCT,ALEMMCNT,SP70
          CALL      RAALEMD1
          IF        OVRCD=1
            CALL      WRALEMD1              * write medication to new encounter
          ENDIF
.
          PACK      KEY24,SAVKEY24,SP70
          CALL      RSALEMD1
          GOTO      CMED1000
.
CMED9999  RETURN
.
.------------------------------------------------------------
. Copy supplies to new encounter
.------------------------------------------------------------
CSUP0000  PACK      KEY24,ENCOUTKY,SP70
          CALL      RSALSUP1
CSUP1000  CALL      RKALSUP1                * Read original supply record
          BRANCH    OVRCD,CSUP9999
.
          PACK      DIM16,ALSPVISN,ALSPENCT
          MATCH     DIM16,ENCOUTKY
          GOTO      CSUP9999 IF NOT EQUAL
.
          PACK      SAVKEY24,ALSPVISN,ALSPENCT,ALSPSCNT,SP70
.
          MOVE      ZERO,F8
          PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      RSALSUP1
          CALL      RPALSUP1               * Get new supply count
          BRANCH    OVRCD,CSUP5000
.
          MATCH     ALENVISN,ALSPVISN
          GOTO      CSUP5000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALSPENCT
          GOTO      CSUP5000 IF NOT EQUAL
.
          MOVE      ALSPSCNT,F8
.
CSUP5000  PACK      KEY24,SAVKEY24,SP70
          CALL      RDALSUP1                * Re read original supply record
          BRANCH    OVRCD,CSUP1000
.
          MOVE      ALENVISN,ALSPVISN       * Change to new encounter
          MOVE      ALENENCT,ALSPENCT
          ADD       ONE,F8
          MOVE      F8,ALSPSCNT
.
          PACK      KEY24,ALSPVISN,ALSPENCT,ALSPSCNT,SP70
          CALL      RAALSUP1
          IF        OVRCD=1
            CALL      WRALSUP1              * write supply to new encounter
          ENDIF
.
          PACK      KEY24,SAVKEY24,SP70
          CALL      RSALSUP1
          GOTO      CSUP1000
.
CSUP9999  RETURN
.
.------------------------------------------------------------
. Copy notes to new encounter
.------------------------------------------------------------
CNOT0000  PACK      KEY25,ENCOUTKY,ZERO,ZERO,ONE,SP70
          CALL      RSALMDT1
CNOT1000  CALL      RKALMDT1                * Read orginal encounter notes
          BRANCH    OVRCD,CNOT9999
.
          PACK      DIM16,ALMDVISN,ALMDENCN
          MATCH     DIM16,ENCOUTKY
          GOTO      CNOT9999 IF NOT EQUAL
.
          MATCH     "001",ALMDTYPE          * Encounter notes
          GOTO      CNOT9999 IF NOT EQUAL
.
          MATCH     "1",ALMDDELT            * Don't copy deleted
          GOTO      CNOT1000 IF EQUAL
.
          PACK      SAVKEY25,ALMDVISN,ALMDENCN,ALMDTYPE,ALMDNOTE,SP70
.
          MOVE      ZERO,F6
          PACK      KEY25,ALENVISN,ALENENCT,Z70
          CALL      RSALMDT1
          CALL      RPALMDT1               * Get new note count
          BRANCH    OVRCD,CNOT5000
.
          MATCH     ALENVISN,ALMDVISN
          GOTO      CNOT5000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALMDENCN
          GOTO      CNOT5000 IF NOT EQUAL
.
          MATCH     "001",ALMDTYPE          * Encounter notes
          GOTO      CNOT5000 IF NOT EQUAL
.
          MOVE      ALMDNOTE,F6
.
CNOT5000  ADD       ONE,F6
.
          PACK      KEY25,SAVKEY25,SP70
          CALL      RDALMDT1              * Re read original note record
          BRANCH    OVRCD,CNOT1000
.
          MOVE      ALENVISN,ALMDVISN       * Change to new encounter
          MOVE      ALENENCT,ALMDENCN
          MOVE      F6,ALMDNOTE
.
          PACK      KEY25,ALMDVISN,ALMDENCN,ALMDTYPE,ALMDNOTE,SP70
          CALL      RAALMDT1
          IF        OVRCD=1
            CALL      WRALMDT1             * write note to new encounter
          ENDIF
.
          PACK      KEY28,SAVKEY25,SP70
          CALL      RSALMTX1
CNOT6000  CALL      RKALMTX1
          BRANCH    OVRCD,CNOT8000
.
          PACK      DIM25,ALMTVISN,ALMTENCN,ALMTTYPE,ALMTNOTE,SP70
          MATCH     DIM25,SAVKEY25
          GOTO      CNOT8000 IF NOT EQUAL
.
          PACK      SAVKEY28,ALMTVISN,ALMTENCN,ALMTTYPE,ALMTNOTE,ALMTUNIQ,SP70
.
          MOVE      ALENVISN,ALMTVISN       * Change to new encounter
          MOVE      ALENENCT,ALMTENCN
          MOVE      F6,ALMTNOTE
.
          PACK      KEY28,ALMTVISN,ALMTENCN,ALMTTYPE,ALMTNOTE,ALMTUNIQ,SP70
          CALL      RAALMTX1
          IF        OVRCD=1
            CALL      WRALMTX1
          ENDIF
.
          PACK      KEY28,SAVKEY28,SP70
          CALL      RSALMTX1
          GOTO      CNOT6000
.
CNOT8000  PACK      KEY25,SAVKEY25,SP70
          CALL      RSALMDT1
          GOTO      CNOT1000
.
CNOT9999  RETURN
.
.------------------------------------------------------------
. Copy interventions to new encounter
.------------------------------------------------------------
CINT0000  MATCH     SAVEDEPT,ALREDEPT     * If department has not changed
          GOTO      CINT9999 IF NOT EQUAL
.
          PACK      KEY24,ENCOUTKY,SP70
          CALL      RSALITV1
CINT1000  CALL      RKALITV1                * Read original intervention record
          BRANCH    OVRCD,CINT9999
.
          PACK      DIM16,ALIVVISN,ALIVENCT
          MATCH     DIM16,ENCOUTKY
          GOTO      CINT9999 IF NOT EQUAL
.
          PACK      SAVKEY24,ALIVVISN,ALIVENCT,ALIVICNT,SP70
.
          MOVE      ZERO,F8
          PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      RSALITV1
          CALL      RPALITV1               * Get new intervention count
          BRANCH    OVRCD,CINT5000
.
          MATCH     ALENVISN,ALIVVISN
          GOTO      CINT5000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALIVENCT
          GOTO      CINT5000 IF NOT EQUAL
.
          MOVE      ALIVICNT,F8
.
CINT5000  PACK      KEY24,SAVKEY24,SP70
          CALL      RDALITV1              * Re read original intervention record
          BRANCH    OVRCD,CINT1000
.
          MOVE      ALENVISN,ALIVVISN       * Change to new encounter
          MOVE      ALENENCT,ALIVENCT
          ADD       ONE,F8
          MOVE      F8,ALIVICNT
.
          PACK      KEY24,ALIVVISN,ALIVENCT,ALIVICNT,SP70
          CALL      RAALITV1
          IF        OVRCD=1
            CALL      WRALITV1             * write intervention to new encounter
          ENDIF
.
          PACK      KEY24,SAVKEY24,SP70
          CALL      RSALITV1
          GOTO      CINT1000
.
CINT9999  RETURN
.
.------------------------------------------------------------
. Move encounters to different referral
.------------------------------------------------------------
MOVENC00  MOVE      ONE,F3
          MOVE      ZERO,ENCCNT
.
          MOVE      SP70,SAVEDEPT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          IF        OVRCD<>1
            MOVE      ALREDEPT,SAVEDEPT       * Save new department
          ENDIF
.
          PACK      KEY16,SAVEADMI,SP70
          CALL      RSALENC1
MOVENC10  CALL      RKALENC1
          BRANCH    OVRCD,MOVENC20
.
          MATCH     SAVEADMI,ALENVISN
          GOTO      MOVENC20 IF NOT EQUAL
.
          ADD       ONE,ENCCNT
          PACK      KEY16,ALENVISN,ALENENCT,SP70
          PACK      ENCNTRS[ENCCNT],KEY16,SP70
.
          GOTO      MOVENC10
.
MOVENC20  IF        F3<=ENCCNT
.
            MATCH     ENCNTRS[F3],SP70
            IF        !@EQUAL
              MOVE      ZERO,F8
              PACK      KEY16,ADMISSNO,Z70
              CALL      RSALENC1
              CALL      RPALENC1
              BRANCH    OVRCD,MOVENC25
.
              MATCH     ADMISSNO,ALENVISN
              GOTO      MOVENC25 IF NOT EQUAL
.
              MOVE      ALENENCT,F8
              COMPARE   "99999999",F8
              GOTO      MOVENC90 IF EQUAL
.
MOVENC25      CALL      CLALLENC
              ADD       ONE,F8
.
              COMPARE   "99999999",F8
              GOTO      MOVENC90 IF EQUAL
.
              PACK      KEY16,ENCNTRS[F3],SP70
              CALL      RDALENC1
              BRANCH    OVRCD,MOVENC90
.
              MOVE      ONE,VISCNT
MOVENC30      IF        VISCNT<=UNLKEND
                MATCH     UNLKVIST[VISCNT],ALENLINK
                GOTO      MOVENC40 IF EQUAL
                ADD       ONE,VISCNT
                GOTO      MOVENC30
              ENDIF
              GOTO      MOVENC90
.
MOVENC40      MOVE      F8,ALENENCT
              MOVE      ADMISSNO,ALENVISN
              PACK      KEY16,ADMISSNO,ALENENCT,SP70
              PACK      SAVEKY16,ADMISSNO,ALENENCT,SP70
.
              CALL      AEMHI000                * set to 'Unsent' - MHINC extract
              CALL      WRALENC1                * write to the encounter table
.
              MOVE      ONE,AUDTTYPE            * write history record
              CALL      WAALEN00
.
              IF        PTCNCPAH=1
                CALL      WRCPAT00          * write to the current patient table
              ENDIF
.
              CALL      ALIT0000                * write items to item file
.
              MATCH     "5",NEXTPAGE
              IF        !@EQUAL
                CALL      PMIGTNID              * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      TEN,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICEA           * Pass New Encounter to DG *I-90202
              ENDIF                          * Only report HL7 message here if
.                                            * the EOC is not TAC/VET or WORK C
.                                            * Write Record To Erc Table
.
              PACK      KEY16,ENCNTRS[F3],SP70
              CALL      RDALENC1
              BRANCH    OVRCD,MOVENC90
.
              MOVE      ONE,ALENRSTA
              CALL      UPALENC1                 * If encounter is found
              BRANCH    OVRCD,MOVENC90           * set it to cancelled
.
.
.               Get Referral & PMI details prior to sending broadcast message
.
              PACK      KEY8,ALENVISN,SP70
              CALL      RDALREF1                * allrefaf record on file ?
              BRANCH    OVRCD,MOVENC90          * no - don't send
.
              MOVE      ALREURNO,KEY8
              CALL      RDMAST1                 * PMI master record on file ?
              BRANCH    OVRCD,MOVENC90          * no - don't send
.
              MOVE      ALREURNO,KEY8
              CALL      RDPMPX21                * PMI extension on file ?
              BRANCH    OVRCD,MOVENC90          * no - don't send
.
              CALL      PMIGTNID                * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
.
              MOVE      THREE,AUDTTYPE          * after history record
              CALL      WAALEN00
.
              PACK      ENCOUTKY,ENCNTRS[F3],SP70
              PACK      KEY16,SAVEKY16,SP70     * Re read New contact
              CALL      RDALENC1
              BRANCH    OVRCD,MOVENC90
.
              CALL      CMED0000                * Copy medications
              CALL      CSUP0000                * Copy supplies
              CALL      CNOT0000                * Copy notes
              CALL      CINT0000                * Copy interventions
.
              PACK      KEY16,ENCNTRS[F3],SP70  * Re read old contact
              CALL      RDALENC1
              BRANCH    OVRCD,MOVENC90
.
              MATCH     "1",ALENRSTA
              IF        @EQUAL
                MOVE      FOUR,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICED           * Pass Delete to Datagate  *I-90202
              ELSE
                MOVE      FIVE,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICEU           * broadcast HL7 A08 update message
              ENDIF
            ENDIF
.
MOVENC90    ADD       ONE,F3
            GOTO      MOVENC20
          ENDIF
.
MOVENC99  RETURN
.******************************************************************************
.         MHINC - Add Encounter for MH Department and Primary Ref.
.******************************************************************************
AEMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,AEMHI999
.
          MATCH     "M",TCINDC4
          GOTO      AEMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      AEMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MOVE      "0",ALENMOHR               * Unsent
AEMHI999  RETURN
+
.------------------------------------------------------------
.   Set Parameters for allied health item code file
.------------------------------------------------------------
ALIT0000  MOVE      ONE,F2
.
          MATCH     SP70,ITEMN001
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN001,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN001,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN002
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN002,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN002,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN003
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN003,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN003,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN004
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN004,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN004,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN005
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN005,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN005,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN006
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN006,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN006,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN007
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN007,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN007,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN008
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN008,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN008,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN009
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN009,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN009,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
          MATCH     SP70,ITEMN010
          IF        !@EQUAL
            MOVE      ALENVISN,ALITVISN
            MOVE      ALENENCT,ALITENCN
            MOVE      F2,ALITITMC
            PACK      KEY18,ALITVISN,ALITENCN,ALITITMC,SP70
            CALL      RDALITM1
            IF        OVRCD = 1
               CALL     MVIT0000
               MOVE     ITEMN010,ALITITMN
               CALL     WRALITM1
               ADD      ONE,F2
            ELSE
               MOVE     ITEMN010,ALITITMN
               CALL     UPALITM1
               ADD      ONE,F2
            ENDIF
          ENDIF
.
ALITM999  RETURN
.------------------------------------------------------------
.   Set Parameters for allied health item code file
.------------------------------------------------------------
MVIT0000  MOVE     ALENVISN,ALITVISN
          MOVE     ALENENCT,ALITENCN
          MOVE     F2,ALITITMC
          MOVE     SP70,ALITSPAR
.
MVIT9999  RETURN
.------------------------------------------------------------
. Write to the current patient list
.------------------------------------------------------------
WRCPAT00  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD * current date
          REP       " 0",CURRDATE
          REP       " 0",XCDATE                                        *I-60242
.
          MATCH     CURRDATE,ALENSDAT
          GOTO      WRCPAT99 IF NOT EQUAL
.
          MOVE      ALENVISN,PMCUVISN
          MOVE      ALENSDAT,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PGNAME,PMCUGNAM
          MOVE      PURNO,PMCUURNO
          MOVE      "",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      SP70,PMCUOSIT
          MOVE      ALREHOSN,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
.
WRCPAT99  RETURN
+
.------------------------------------------------------------
. Link visits to a referral
.------------------------------------------------------------
LINK0000  MOVE      ONE,F3
.
          MOVE      ZERO,STATCHEK
.
LINK1000  IF        F3<=LINKEND
            MATCH     LINKVIST[F3],SP70
            IF        !@EQUAL
.
.         * check once that referral is not cancelled or rejected before linking
               COMPARE   ZERO,STATCHEK
               IF        @EQUAL
                 MOVE      ONE,STATCHEK
                 PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
                 CALL      RDALREF1
                 BRANCH    OVRCD,LINK9000
.
                 MATCH     "4",ALRESTAT            * Referral is cancelled
                 GOTO      LINK9001 IF EQUAL
.
                 MATCH     "5",ALRESTAT            * Referral is rejected
                 GOTO      LINK9002 IF EQUAL
               ENDIF
.
               MOVE      ADMISSNO,ALLNVISN
               MOVE      LINKVIST[F3],ALLNLNKV
.
               MOVE      ONE,CANCFLAG              * Cancelled booking flag
.
               PACK      KEY36,ALLNLNKV,SP70
               CALL      RDSBOKA6
               CALL      RDKBOKA6
               BRANCH    OVRCD,LINK1500
.
               MATCH     DOBAOUTN,ALLNLNKV     
               GOTO      LINK1500 IF NOT EQUAL
.
               MATCH     OBAURNO,URNUMBER
               GOTO      LINK1500 IF NOT EQUAL
.
               MOVE      ZERO,CANCFLAG              * Not a cancelled booking
.
               MOVE      OBASITE,ALLNSITE
               MOVE      OBACLIN,ALLNCLIN
               MOVE      OBADATE,ALLNDATE
               MOVE      OBASTRT,ALLNSTRT
               MOVE      OBASLOT,ALLNSLOT 
               MOVE      ZERO,ALLNSTAT
               MOVE      SP70,ALLNSPAR
               PACK      KEY16,ALLNVISN,ALLNLNKV,SP70
               CALL      RDALLNK1
               IF        OVRCD=1
                 MOVE      "0",ALLNMOHR            * Set to Unsent
                 CALL      WRALLNK1
.
                 MOVE      ONE,AUDTTYPE            * write history record
                 CALL      WAALLN00
.
                 CALL      WEDT0000          * Write EDWARD OP visit alteration
               ENDIF
.
.
.              * CAR 256420 - Added clearing of outbokcf.otbcrdat
.
               MOVE      DOBAOUTN,KEY8
               CALL      RDOTBOC1
               IF        OVRCD=0
                 MOVE      ALRERDAT,OTBCRDAT
                 CALL      UPOTBOC1
               ELSE
                 MOVE      ALRERDAT,OTBCRDAT
                 MOVE      SP70,OTBCSPAR
                 CALL      WROTBOC1
               ENDIF
.
               PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
               CALL      RDSESA1
               BRANCH    OVRCD,LINK1500
.
               PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                               OSESSDAT,SP70
               CALL      RDOTHED1
               BRANCH    OVRCD,LINK1500
            ENDIF
.
LINK1500    IF        CANCFLAG=1
              PACK      KEY8,ALLNLNKV,SP70       * Write cancelled OP booking
              CALL      RDOTCAN1                 * link to the  referral
              IF        OVRCD<>1                    
                MOVE      OPCNSITE,ALLNSITE
                MOVE      OPCNCLIN,ALLNCLIN
                MOVE      OPCNDATE,ALLNDATE
                MOVE      OPCNSTRT,ALLNSTRT
                MOVE      OPCNSLOT,ALLNSLOT
                MOVE      ONE,ALLNSTAT
                MOVE      SP70,ALLNSPAR
                PACK      KEY16,ALLNVISN,ALLNLNKV,SP70
                CALL      RDALLNK1
                IF        OVRCD=1
                  MOVE      "0",ALLNMOHR            * Set to Unsent
                  CALL      WRALLNK1
.
                  MOVE      ONE,AUDTTYPE            * write history record
                  CALL      WAALLN00
                ENDIF
              ENDIF
            ENDIF
.
            ADD       ONE,F3
            GOTO      LINK1000
          ENDIF
. 
          MOVE      ZERO,EXIT
          GOTO      LINK9999
.
LINK9000  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9001  MOVE      "Cannot link Outpatient Visits to a Cancelled Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9002  MOVE      "Cannot link Outpatient Visits to a Rejected Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9999  RETURN
.
.------------------------------------------------------------
.Link/Unlink visits from a referral - Update referral status to waiting/active
.------------------------------------------------------------
URSK0000  MOVE      SP70,BOOKDATE
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,URSK9999
.
          MATCH     "0",ALRESTAT            * Waiting
          GOTO      URSK1000 IF EQUAL    
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      URSK1000 IF EQUAL    
.
          GOTO      URSK9999                * Not waiting/Active so exit
.
URSK1000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
URSK1010  CALL      RKALLNK1
          BRANCH    OVRCD,URSK2000
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          IF        @EQUAL
            PACK      SAVKEY16,ALLNVISN,ALLNLNKV,SP70
.
            CALL      DATK0000              * Get first booking date
.
            MOVE      SAVKEY16,KEY16
            CALL      RDALLNK1              * Re position on link records
            BRANCH    OVRCD,URSK2000
.
            GOTO      URSK9100
          ENDIF
.
URSK2000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1          
          CALL      RKALENC1
          BRANCH    OVRCD,URSK9000
.
          MATCH     ALREVISN,ALENVISN       * Encounters
          IF        @EQUAL
            CALL      DATE0000              * Get first encounter date
            GOTO      URSK9200
          ENDIF
.
URSK9000  MATCH     "0",ALRESTAT
          IF        !@EQUAL
            MOVE      ALRESTAT,F1                                     *I-205251
            IF        PTCNHDPS = 1 & F1 = 1
              GOTO      URSK9999
            ENDIF     
.
            MOVE      TWO,AUDTTYPE          * before history record
            CALL      WAALRE00
.
            MOVE      ZERO,ALRESTAT         * Update status to waiting
            MOVE      SP70,ALREDACT
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      URMHI000              * Set MHINC indicator
            CALL      UPALREF1
.
            PACK      KEY8,ALREVISN,SP70
            CALL      RDALEID1
            IF        OVRCD=0
              CALL      MVALEI00            * Extra Inbound Data
              CALL      UPALEID1            * Update alleidaf
            ELSE
              IF        EIDEXIST=1
                CALL      CLALLEID
                CALL      MVALEI00          * Extra Inbound Data
                MOVE      ALREVISN,ALEIVISN
                CALL      WRALEID1          * write new record
              ENDIF
            ENDIF
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN5,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
.
            CALL      OA08R000              * Trigger HL7 OUT A08 (0918185)
          ENDIF
          GOTO        URSK9999
.
URSK9100  MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            CALL      IBACLOCK
            PACK      ALREDACT,CCC,CYY,CMM,CDD
            REP       " 0",ALREDACT
          ENDIF
.
          MOVE      ONE,ALRESTAT          * Update status to active
          CALL      CALX0000              * Calculate referral expiry date
          CALL      URMHI000              * Set MHINC indicator
          CALL      FAPD0000              * Set first appointment booked
          CALL      UPALREF1
.
          MOVE      ALREPRTY,SAVVPRTY       * Save referral priority
          MOVE      ALRETRGS,SAVVTRGS       * Save referral triage status
          MOVE      ALREVISN,SAVVREFN  * Referral number
          PROC      VDEF0000           * VINAH Field defaults

.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALEID1
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN6,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          CALL      OA08R000                * Trigger HL7 OUT A08 (0918185)
          GOTO      URSK9999
.
URSK9200  MATCH     "1",ALRESTAT            * EOC only no linked referrals
          IF        !@EQUAL
            MOVE      TWO,AUDTTYPE          * before history record
            CALL      WAALRE00
.
            MOVE      ONE,ALRESTAT          * Update status to active
            MOVE      FENCDATE,ALREDACT
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      URMHI000              * Set MHINC indicator
            CALL      FAPD0000              * Set first appointment booked
            CALL      UPALREF1
.
            MOVE      ALREPRTY,SAVVPRTY  * Save referral priority
            MOVE      ALRETRGS,SAVVTRGS  * Save referral triage status
            MOVE      ALREVISN,SAVVREFN  * Referral number
            PROC      VDEF0000           * VINAH Field defaults
.
            PACK      KEY8,ALREVISN,SP70
            CALL      RDALEID1
            IF        OVRCD=0
              CALL      MVALEI00            * Extra Inbound Data
              CALL      UPALEID1            * Update alleidaf
            ELSE
              IF        EIDEXIST=1
                CALL      CLALLEID
                CALL      MVALEI00          * Extra Inbound Data
                MOVE      ALREVISN,ALEIVISN
                CALL      WRALEID1          * write new record
              ENDIF
            ENDIF
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN7,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
.
            MOVE      ALREVISN,CHECKREF
            CALL      AMAS0000              * Auto activate master referral
.
            CALL      OA08R000              * Trigger HL7 OUT A08 (0918185)
          ENDIF
          GOTO        URSK9999
.
URSK9999  RETURN
.
.------------------------------------------------------------
. Update referral status to waiting/active
.------------------------------------------------------------
URSR0000  MOVE      SP70,BOOKDATE
. 
          PACK      KEY8,ALLNVISN,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,URSR9999
.
          MATCH     "0",ALRESTAT            * Waiting
          GOTO      URSR1000 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      URSR1000 IF EQUAL
.
          GOTO      URSR9999                * Not waiting/Active so exit
.
URSR1000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
URSR1050  CALL      RKALLNK1
          BRANCH    OVRCD,URSR2000
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          IF        @EQUAL
            CALL      DATR0000              * Get first booking date
            GOTO      URSR9100
          ENDIF
.
URSR2000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1
          CALL      RKALENC1
          BRANCH    OVRCD,URSR9000
.
          MATCH     ALREVISN,ALENVISN       * Encounters
          IF        @EQUAL
            CALL      DATE0000              * Get first encounter date
            GOTO      URSR9200
          ENDIF
.
URSR9000  MATCH     "0",ALRESTAT
          IF        !@EQUAL
            MOVE      ALRESTAT,F1                                     *I-205251
            IF        PTCNHDPS = 1 & F1 = 1
              GOTO      URSR9999
            ENDIF     
.
            MOVE      TWO,AUDTTYPE          * before history record
            CALL      WAALRE00
.
            MOVE      ZERO,ALRESTAT         * Update status to waiting
            MOVE      SP70,ALREDACT
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      URMHI000              * Set MHINC indicator
            CALL      UPALREF1
.
            PACK      KEY8,ALREVISN,SP70
            CALL      RDALEID1
            IF        OVRCD=0
              CALL      MVALEI00            * Extra Inbound Data
              CALL      UPALEID1            * Update alleidaf
            ELSE
              IF        EIDEXIST=1
                CALL      CLALLEID
                CALL      MVALEI00          * Extra Inbound Data
                MOVE      ALREVISN,ALEIVISN
                CALL      WRALEID1          * write new record
              ENDIF
            ENDIF
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN8,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
.
            CALL      OA08V000              * Trigger HL7 OUT A08 (0918185)
          ENDIF
          GOTO        URSR9999
.
URSR9100  MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            CALL      IBACLOCK
            PACK      ALREDACT,CCC,CYY,CMM,CDD
            REP       " 0",ALREDACT
          ENDIF
.
          MOVE      ONE,ALRESTAT          * Update status to active
          CALL      CALX0000              * Calculate referral expiry date
          CALL      URMHI000              * Set MHINC indicator
          CALL      FAPD0000              * Set first appointment booked
          CALL      UPALREF1
.
          MOVE      ALREPRTY,SAVVPRTY       * Save referral priority
          MOVE      ALRETRGS,SAVVTRGS       * Save referral triage status
          MOVE      ALREVISN,SAVVREFN  * Referral number
          PROC      VDEF0000           * VINAH Field defaults
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDALEID1
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN9,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          CALL      OA08V000                * Trigger HL7 OUT A08 (0918185)
          GOTO      URSR9999
.
URSR9200  MATCH     "1",ALRESTAT            * EOC only no linked referrals
          IF        !@EQUAL
            MOVE      TWO,AUDTTYPE          * before history record
            CALL      WAALRE00
.
            MOVE      ONE,ALRESTAT          * Update status to active
            MOVE      FENCDATE,ALREDACT
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      URMHI000              * Set MHINC indicator
            CALL      FAPD0000              * Set first appointment booked
            CALL      UPALREF1
.
            MOVE      ALREPRTY,SAVVPRTY       * Save referral priority
            MOVE      ALRETRGS,SAVVTRGS       * Save referral triage status
            MOVE      ALREVISN,SAVVREFN  * Referral number
            PROC      VDEF0000           * VINAH Field defaults
.
            PACK      KEY8,ALREVISN,SP70
            CALL      RDALEID1
            IF        OVRCD=0
              CALL      MVALEI00            * Extra Inbound Data
              CALL      UPALEID1            * Update alleidaf
            ELSE
              IF        EIDEXIST=1
                CALL      CLALLEID
                CALL      MVALEI00          * Extra Inbound Data
                MOVE      ALREVISN,ALEIVISN
                CALL      WRALEID1          * write new record
              ENDIF
            ENDIF
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
.
            MOVE      ALREVISN,CHECKREF
            CALL      AMAS0000              * Auto activate master referral
.
            CALL      OA08V000              * Trigger HL7 OUT A08 (0918185)
          ENDIF
          GOTO        URSR9999
.
URSR9999  RETURN
.
.------------------------------------------------------------
. Work out the first booking date for this referral
.------------------------------------------------------------
DATR0000  MOVE      SP70,BOOKDATE
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
DATR1000  CALL      RKALLNK1
          BRANCH    OVRCD,DATR9999
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      DATR9999 IF NOT EQUAL
.
          MATCH     SP70,BOOKDATE
          IF        @EQUAL
            MOVE      ALLNDATE,BOOKDATE         * Calc ref expiry
          ENDIF
.
          MATCH     BOOKDATE,ALLNDATE
          IF        @LESS
            MOVE      ALLNDATE,BOOKDATE
          ENDIF
          GOTO      DATR1000
.
DATR9999  RETURN
.
.------------------------------------------------------------
. Work out the first booking date for this referral
.------------------------------------------------------------
DATK0000  MOVE      SP70,BOOKDATE
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
DATK1000  CALL      RKALLNK1
          BRANCH    OVRCD,DATK9999
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      DATK9999 IF NOT EQUAL
.
          MATCH     SP70,BOOKDATE
          IF        @EQUAL
            MOVE      ALLNDATE,BOOKDATE         * Calc ref expiry
          ENDIF
.
          MATCH     BOOKDATE,ALLNDATE
          IF        @LESS
            MOVE      ALLNDATE,BOOKDATE
          ENDIF
          GOTO      DATK1000
.
DATK9999  RETURN
.
.------------------------------------------------------------
. Work out the first encounter date for this referral
.------------------------------------------------------------
DATE0000  MOVE      SP70,FENCDATE
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1
DATE1000  CALL      RKALENC1
          BRANCH    OVRCD,DATE9999
.
          MATCH     ALREVISN,ALENVISN
          GOTO      DATE9999 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA
          GOTO      DATE1000 IF EQUAL
.
          MATCH     SP70,FENCDATE
          IF        @EQUAL
            MOVE      ALENSDAT,FENCDATE
          ENDIF
.
          MATCH     FENCDATE,ALENSDAT
          IF        @LESS
            MOVE      ALENSDAT,FENCDATE
          ENDIF
          GOTO      DATE1000
.
DATE9999  RETURN
.
.------------------------------------------------------------
. Unlink visits from a referral
.------------------------------------------------------------
ULNK0000  MOVE      ONE,F3
ULNK1000  IF        F3<=UNLKEND
            MATCH     UNLKVIST[F3],SP70
            IF        !@EQUAL
               PACK      KEY16,ADMISSNO,UNLKVIST[F3],SP70
               CALL      RDALLNK1
               IF        OVRCD=0
                 CALL      DEALLNK1
                 MATCH     "1",ALLNMOHR
                 IF        @EQUAL
                   MOVE      "2",ALLNMOHR           * set to 'Send Delete'
                 ENDIF
                 MOVE      FOUR,AUDTTYPE            * delete history record
                 CALL      WAALLN00
                 CALL      WEDT0000          * Write EDWARD OP visit alteration
               ENDIF
.
.              * CAR 256420 - Added clearing of outbokcf.otbcrdat
.
               MOVE      UNLKVIST[F3],KEY8
               CALL      RDOTBOC1
               IF        OVRCD=0
                 PACK      OTBCRDAT,SP70
                 CALL      UPOTBOC1
               ENDIF
.
            ENDIF
            ADD       ONE,F3
            GOTO      ULNK1000
          ENDIF
.
          MOVE      ZERO,EXIT
.
ULNK9999  RETURN
.------------------------------------------------------------
. Output table of linked visits for a referral
.------------------------------------------------------------
LINKT000  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,LINKT990
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
LINKT100  CALL      RKALLNK1
          BRANCH    OVRCD,LINKT990
.
          MATCH     ALREVISN,ALLNVISN            * Same referral
          GOTO      LINKT990 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT                 * Cancelled OP visit
          GOTO      LINKT100 IF EQUAL
.
          CALL      ROTFIL00                     * Check outpatient file prefix
.
          PACK      KEY28,ALLNSITE,ALLNCLIN,ALLNDATE,ALLNSTRT,ALLNSLOT,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,LINKT100
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,OBASITE,OBACLIN,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,LINKT400
.
          MATCH     OBASITE,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      LINKT400
          ENDIF
.
          MATCH     OBACLIN,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
          MOVE      SP70,BOOKSTAT
          LOAD      BOOKSTAT,OBASTAT,DBOOKED,SP1,SP1,DATTEND,DNOATTN
.
          IF        BOOKONLY=1
            COMPARE   ONE,OBASTAT               * Only display bookings
            GOTO      LINKT100 IF NOT EQUAL
          ENDIF
.
LINKT400  MOVE      SP70,DISPDAT1                * Visit Date
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",OBAOUTNO,"&nbsp;</td>":
                             "<td>",PMVXUDF1,"&nbsp;</td>":
                             "<td>",OCTDESC,"&nbsp;</td>":
                             "<td>",OCADESC,"&nbsp;</td>":
                             "<td>",BOOKSTAT,"&nbsp;</td>";
.
          IF        BOOKONLY=1
              WRITE     HTMLFILE;"<td><img src=../images/MaintenanceIcon.gif":
                                 " class=ListIcon ":
                                 " onclick='CancBooking(#"":
                                 OBAURNO,"#",#"":
                                 OBAOUTNO,"#");'>":
                                 "</td>";
          ELSE
            WRITE     HTMLFILE;"<td><input type=checkbox name=unlkvist ":
                               "value=#"",OBAOUTNO,"#">&nbsp;";
.
            IF        DDQCKRLK = 0
              PACK      KEY5,CATCG,ALREDEPT,SP70
              CALL      RDCODE1
.
              IF        OVRCD=0
                MATCH     SP70,TCINDC8
                IF       @EQUAL
.
                  UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                       OCT,NOV,DEC
                  PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
                  WRITE     HTMLFILE;"<img src=../images/ViewIcon.gif ":
                                     "alt='Quick re-link' ":
                                     "onclick='Relink(#"":
                                     OBAURNO,"#",#"":
                                     ADMISSNO,"#",#"":
                                     OBAOUTNO,"#",#"":
                                     DISPDAT2,"#");'>";
                ENDIF
.
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"</td>";
.
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      LINKT100
.
LINKT990  MOVE      ZERO,EXIT
          GOTO      LINKT999
.
LINKT999  RETURN
.
.------------------------------------------------------------
. Output table of requested appointments for a referral
.------------------------------------------------------------
RQAPT000  PACK      KEY32,URNUMBER,ADMISSNO,SP70 * Requested Appointments
          CALL      RSOTART1
RQAPT020  CALL      RKOTART1
          BRANCH    OVRCD,RQAPT990
.
          MATCH     URNUMBER,OTARURNO
          GOTO      RQAPT990 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTARREFN
          GOTO      RQAPT990 IF NOT EQUAL
.
          MATCH     "0",OTARSTAT                 * Requested or Pending Resch
          IF        !@EQUAL
            MATCH     "1",OTARSTAT
            GOTO      RQAPT020 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,REQBDEPT                     * Requested By Department
          MATCH     SP70,OTARRDEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARRDEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRDEP,TDESC
            ENDIF
            MOVE      TDESC,REQBDEPT
          ENDIF
.
          MOVE      SP70,REASNREQ                      * Requested By Department
          MATCH     SP70,OTARRREQ
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSU,OTARRREQ,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARRREQ,TDESC
            ENDIF
            MOVE      TDESC,REASNREQ
          ENDIF
.
          MOVE      SP70,REQUESTB                     * Requested By
          MATCH     SP70,OTARCUID
          IF        !@EQUAL
            PACK      KEY10,OTARCUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      OTARCUID,WBSENAM
            ENDIF
            MOVE      WBSENAM,REQUESTB
          ENDIF
.
          MOVE      SP70,DISPPRDT
          MATCH     SP70,OTARPRDT
          IF        !@EQUAL
            UNPACK    OTARPRDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPPRDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,ADEPDESC                    * Appoint With Department
          MATCH     SP70,OTARADEP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,OTARADEP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTARADEP,TDESC
            ENDIF
            MOVE      TDESC,ADEPDESC
          ENDIF
.
          MOVE      SP70,CTYPDESC
          MATCH     SP70,OTARCLTY
          IF        !@EQUAL
            PACK      KEY12,OTARPRSI,OTARCLTY,SP70
            CALL      RDCTYA1
            IF        OVRCD=1
              MOVE      OTARCLTY,OCTDESC
            ENDIF
            MOVE      OCTDESC,CTYPDESC
          ENDIF
.
RQAPT050  MOVE      SP70,STATDESC
          MATCH     "0",OTARSTAT
          IF        @EQUAL
            MOVE      "Requested",STATDESC
          ENDIF
.
          MATCH     "1",OTARSTAT
          IF        @EQUAL
            MOVE      "Pending Reschedule",STATDESC
          ENDIF
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,OTARRQDT
          IF        !@EQUAL
            UNPACK    OTARRQDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;",OTARRQDT,OTARRQTM,"</td>":
                             "<td>&nbsp;",REQBDEPT,"</td>":
                             "<td>&nbsp;",REASNREQ,"</td>":
                             "<td>&nbsp;",DISPPRDT,"</td>":
                             "<td>&nbsp;",ADEPDESC,"</td>":
                             "<td>&nbsp;",CTYPDESC,"</td>":
                             "<td>&nbsp;",STATDESC,"</td>":
                             "<td><img src=../images/MaintenanceIcon.gif":
                                 " class=ListIcon ":
                                 " onclick='UpdateRequest(#"":
                                 URNUMBER,"#",#"":
                                 ADMISSNO,"#",#"":
                                 DISPDAT1,"#",#"":
                                 OTARRQTM,"#");'>":
                                 "</td>";
.
          GOTO      RQAPT020
.
RQAPT990  MOVE      ZERO,EXIT
          GOTO      RQAPT999
.
RQAPT999   RETURN
.
.------------------------------------------------------------
. Output table of linked cancelled OP visits for a referral
.------------------------------------------------------------
LINKC000  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,LINKC990
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
LINKC100  CALL      RKALLNK1
          BRANCH    OVRCD,LINKC990
.
          MATCH     ALREVISN,ALLNVISN            * Same referral
          GOTO      LINKC990 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT                 * Cancelled OP visit
          GOTO      LINKC100 IF NOT EQUAL
.
          CALL      ROTFIL00                     * Check outpatient file prefix
.
          PACK      KEY8,ALLNLNKV,SP70
          CALL      RDOTCAN1
          BRANCH    OVRCD,LINKC100
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          PACK      KEY12,OPCNSITE,OPCNCTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,LINKC400
.
          MATCH     OPCNSITE,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      LINKC400
          ENDIF
.
          MATCH     OPCNCLIN,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
          MOVE      "Cancelled",BOOKSTAT
.
LINKC400  MOVE      SP70,DISPDAT1                * Visit Date
          UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",OPCNOUTN,"&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>",OCTDESC,"&nbsp;</td>":
                             "<td>",OCADESC,"&nbsp;</td>":
                             "<td>",BOOKSTAT,"&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td><input type=checkbox name=unlkvist ":
                             "value=#"",OPCNOUTN,"#"></td></tr>";
.
          GOTO      LINKC100
.
LINKC990  MOVE      ZERO,EXIT
          GOTO      LINKC999
.
LINKC999  RETURN
.
.------------------------------------------------------------
. Output table of unlinked outpatient visits for a referral
.------------------------------------------------------------
ULNKT000  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,ULNKT990
.
          MOVE      ONE,ALLOWLNK
          MATCH     "1",ALREUYN4               * Primary Referral
          IF        @EQUAL
            PACK      KEY3,ALREDEPT,SP70
            CALL      RDALDEP1
            IF        OVRCD<>1
              MATCH     "1",ALDEPENC * Don't Allow Encounters on Primary Ref
              IF        @EQUAL
                MOVE      ZERO,ALLOWLNK        * Link not allowed
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY36,ALREURNO,Z70
.
          CALL      RDSBOKA3
ULNKT100  CALL      RDPBOKA3
          BRANCH    OVRCD,ULNKT990
.
          MOVE      ALREURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      ULNKT990 IF NOT EQUAL
.
          MATCH     ALRERDAT,OBADATE     * Check referral and booking date
          GOTO      ULNKT990 IF LESS
.
          IF        IBCNMHOS=ONE
           PACK       KEY8,OBAOUTNO,SP70
           CALL       RDPMVX11
           BRANCH     OVRCD,ULNKT100
.
           MATCH     "1",ALCNCLNK               * Allow cross campus linking
           IF        !@EQUAL
             MATCH      WBSEHOSP,PMVXMHOS
             GOTO       ULNKT100 IF NOT EQUAL
           ENDIF
          ENDIF
.
ULNKT200  BRANCH    OBASTAT,ULNKT300,ULNKT100,ULNKT100,ULNKT300,ULNKT300
          GOTO      ULNKT100
.
ULNKT300  PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,ULNKT350
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      ULNKT100 IF EQUAL
.
ULNKT350  MATCH     "2",ALRESTAT           * Referral Closed
          IF        @EQUAL
            MATCH     OBADATE,ALREDCLO     * Check referral closed date
            GOTO      ULNKT100 IF LESS     * is after the booking date
.
            MATCH     OBADATE,ALREDCLO
            IF        @EQUAL
              MOVE      ALRETCLO,DIM5      * Booking is on the closed date so
              MATCH     OBATIME,DIM5       * check referral closed time
              GOTO      ULNKT100 IF LESS   * is after the booking time
            ENDIF
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,OBASITE,OBACLIN,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,ULNKT400
.
          MATCH     OBASITE,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      ULNKT400
          ENDIF
.
          MATCH     OBACLIN,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
          MOVE      SP70,BOOKSTAT
          LOAD      BOOKSTAT,OBASTAT,DBOOKED,SP1,SP1,DATTEND,DNOATTN
.         
ULNKT400  MOVE      SP70,DISPDAT1                * Visit Date
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,TRIAGDES
          MATCH     SP70,ALREPRTY                * Check for waiting on triage
          GOTO      ULNKT500 IF EQUAL            * priority
.
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ULNKT500
.
          MATCH     ANST,TCINDC2                 * Waiting on triage
          GOTO      ULNKT500 IF NOT EQUAL
.
          MOVE      TDESC,TRIAGDES

ULNKT500  WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",OBAOUTNO,"&nbsp;</td>":
                             "<td>",PMVXUDF1,"&nbsp;</td>":
                             "<td>",OCTDESC,"&nbsp;</td>":
                             "<td>",OCADESC,"&nbsp;</td>":
                             "<td>",BOOKSTAT,"&nbsp;</td>";
.
          MATCH     SP70,TRIAGDES
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td><input type=checkbox name=linkvist ":
                              "onclick=#"WaitingTriage(this,'",TRIAGDES,"');#"":
                              " value=#"",OBAOUTNO,"#">&nbsp;</td>"
          ELSE
            IF        ALLOWLNK=0
              WRITE     HTMLFILE;"<td><input type=checkbox name=d_linkvist ":
                                "onclick=#"NoBookingLink(this);#"":
                                " value=#"",OBAOUTNO,"#">&nbsp;</td>"
            ELSE
              WRITE     HTMLFILE;"<td><input type=checkbox name=linkvist ":
                                 "value=#"",OBAOUTNO,"#">&nbsp;</td>"
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      ULNKT100
.
ULNKT990  MOVE      ZERO,EXIT
          GOTO      ULNKT999
.
ULNKT999  RETURN
.
.--------------------------------------------------------------------
. Output table of unlinked cancelled outpatient visits for a referral
.--------------------------------------------------------------------
ULNKC000  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,ULNKC990
.
          PACK      KEY24,ALREURNO,Z70
          CALL      RSOTCAN2
ULNKC100  CALL      RPOTCAN2
          BRANCH    OVRCD,ULNKC990
.
          MATCH     OPCNURNO,ALREURNO         * Check if same U/R
          GOTO      ULNKC990 IF NOT EQUAL
.
          MATCH     ALRERDAT,OPCNDATE    * Check referral and booking date
          GOTO      ULNKC990 IF LESS
.
          IF        IBCNMHOS=ONE
            UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
            CALL      DAYOFWEK
.
            PACK      KEY18,OPCNSITE,OPCNCLIN,WEEKDAY,OPCNSTRT,SP70
            CALL      RDMASA1
            BRANCH    OVRCD,ULNKC100
.
            MATCH     "1",ALCNCLNK               * Allow cross campus linking
            IF        !@EQUAL
              MATCH      WBSEHOSP,OTMAHOSP
              GOTO       ULNKC100 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY16,DOPCNOUT,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,ULNKC350
.
          MATCH     DOPCNOUT,ALLNLNKV
          GOTO      ULNKC100 IF EQUAL
.
ULNKC350  MATCH     "2",ALRESTAT           * Referral Closed
          IF        @EQUAL
            MATCH     OPCNDATE,ALREDCLO     * Check referral closed date
            GOTO      ULNKC100 IF LESS     * is after the booking date
.
            MATCH     OPCNDATE,ALREDCLO
            IF        @EQUAL
              MOVE      ALRETCLO,DIM5      * Booking is on the closed date so
              MATCH     OPCNTIME,DIM5       * check referral closed time
              GOTO      ULNKC100 IF LESS   * is after the booking time
            ENDIF
          ENDIF
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          PACK      KEY12,OPCNSITE,OPCNCTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,ULNKC400
.
          MATCH     OPCNSITE,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      ULNKC400
          ENDIF
.
          MATCH     OPCNCLIN,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
          MOVE      "Cancelled",BOOKSTAT
.
ULNKC400  MOVE      SP70,DISPDAT1                * Visit Date
          UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
ULNKC500  WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",OPCNOUTN,"&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>",OCTDESC,"&nbsp;</td>":
                             "<td>",OCADESC,"&nbsp;</td>":
                             "<td>",BOOKSTAT,"&nbsp;</td>";
.
          IF        ALLOWLNK=0
            WRITE     HTMLFILE;"<td><input type=checkbox name=d_linkvist ":
                               "onclick=#"NoBookingLink(this);#"":
                               "value=#"",OPCNOUTN,"#">&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<td><input type=checkbox name=linkvist ":
                               "value=#"",OPCNOUTN,"#">&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      ULNKC100
.
ULNKC990  MOVE      ZERO,EXIT
          GOTO      ULNKC999
.
ULNKC999  RETURN
.
.------------------------------------------------------------
. Output referral linked to this visit
.------------------------------------------------------------
LREFT000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
LREFT100  CALL      RKALLNK2
          BRANCH    OVRCD,LREFT990
.
          MATCH     ADMISSNO,ALLNLNKV            * Same referral as outpat visit
          GOTO      LREFT990 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN
          CALL      RDALREF1
          BRANCH    OVRCD,LREFT990
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MATCH     SP70,ALREPSIT
          GOTO      LREFT400 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,LREFT400
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      LREFT400
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
LREFT400  MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,DISPDAT1                * Visit Date
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DEPTDESC
          MATCH     SP70,ALREDEPT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALREDEPT,TDESC
            ENDIF
            MOVE    TDESC,DEPTDESC
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"</td>":
                             "<td>",ALREVISN,"</td>":
                             "<td>",DEPTDESC,"</td>":
                             "<td>",ALREPRCM,"</td>":
                             "<td>",OCTDESC,"</td>":
                             "<td>",OCADESC,"</td>":
                             "<td>",ALSTDESC,"</td>":
                             "<td><input type=checkbox name=unlkvist ":
                             "value=#"",ALREVISN,"#"></td></tr>"
.
          GOTO      LREFT100
.
LREFT990  MOVE      ZERO,EXIT
          GOTO      LREFT999
.
LREFT999  RETURN
.
.------------------------------------------------------------
. Output referrals not linked to this visit
.------------------------------------------------------------
UREFT000  PACK      KEY16,URNUMBER,Z70
          CALL      RSALREF2
UREFT100  CALL      RPALREF2
          BRANCH    OVRCD,UREFT990
.
          MATCH     ALREURNO,URNUMBER
          GOTO      UREFT990 IF NOT EQUAL
.
          MATCH     "3",ALRESTAT                 * Skip Inactive
          GOTO      UREFT100 IF EQUAL
.
          MATCH     "4",ALRESTAT                 * Skip Cancelled
          GOTO      UREFT100 IF EQUAL
.
          MATCH     "5",ALRESTAT                 * Skip Rejected
          GOTO      UREFT100 IF EQUAL
.
          IF        IBCNMHOS=ONE
            MATCH     "1",ALCNCLNK               * Allow cross campus linking
            IF        !@EQUAL
              MATCH     WBSEHOSP,ALREHOSN
              GOTO      UREFT100 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,UREFT100
.
          MATCH     "0",ALDESECU          * Viewable by All Department
          GOTO      UREFT200 IF EQUAL
.
          MATCH     "1",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT   * Display on Summary Only
            GOTO      UREFT200 IF EQUAL  
          ENDIF
.
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT   * Display only if the Users Department
            GOTO      UREFT200 IF EQUAL   * is equal to the Referral Department
          ENDIF
.
          GOTO      UREFT100
.
UREFT200  MATCH     "1",ALDEPENC          * Allow contacts on primary referrals
          GOTO      UREFT220 IF NOT EQUAL
.
          MATCH     "1",ALREUYN4          * Primary Referral
          GOTO      UREFT100 IF EQUAL
.
UREFT220  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,UREFT250

          MATCH     ADMISSNO,ALLNLNKV
          GOTO      UREFT250 IF NOT EQUAL
.
          MATCH     ALREVISN,ALLNVISN
          GOTO      UREFT100 IF EQUAL
.
UREFT250  PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,UREFT100
.
          MATCH     DOBAOUTN,ADMISSNO
          GOTO      UREFT100 IF NOT EQUAL
.
          MATCH     ALRERDAT,OBADATE     * Referral date
          GOTO      UREFT100 IF LESS
.
.         MATCH     SP70,ALREREXP
.         IF        !@EQUAL
.           MATCH     OBADATE,ALREREXP     * Expiry date
.           GOTO      UREFT100 IF LESS
.         ENDIF
.
          MATCH     "2",ALRESTAT           * Referral Closed
          IF        @EQUAL
            MATCH     OBADATE,ALREDCLO     * Check referral closed date
            GOTO      UREFT100 IF LESS     * is after the booking date
.
            MATCH     OBADATE,ALREDCLO
            IF        @EQUAL
              MOVE      ALRETCLO,DIM5      * Booking is on the closed date so
              MATCH     OBATIME,DIM5       * check referral closed time
              GOTO      UREFT100 IF LESS   * is after the booking time
            ENDIF
          ENDIF
.
UREFT300  MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
          MATCH     SP70,ALREPSIT
          GOTO      UREFT400 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,UREFT400
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      UREFT400
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
UREFT400  MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,DISPDAT1                * Visit Date
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,TRIAGDES
          MATCH     SP70,ALREPRTY                * Check for waiting on triage
          GOTO      UREFT500 IF EQUAL            * priority
.
          PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UREFT500
.
          MATCH     ANST,TCINDC2                 * Waiting on triage
          GOTO      UREFT500 IF NOT EQUAL
.
          MOVE      TDESC,TRIAGDES
.
UREFT500  MOVE      SP70,DEPTDESC
          MATCH     SP70,ALREDEPT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALREDEPT,TDESC
            ENDIF
            MOVE    TDESC,DEPTDESC
          ENDIF
.
          MOVE      SP70,TRGSDESC                * Clear triage status desc
          MATCH     "1",ALDEUTRS                 * Using triage status
          GOTO      UREFT600 IF NOT EQUAL
.
          MATCH     SP70,ALRETRGS                * Blank triage status
          GOTO      UREFT600 IF EQUAL
.
          PACK      KEY5,CATTS,ALRETRGS,SP70
          CALL      RDCODE1                      * Read triage status
          BRANCH    OVRCD,UREFT600
.
          MATCH     "99",THCSCOD                 * Insufficient Info
          IF        !@EQUAL
            MATCH     "98",THCSCOD               * Waiting on triage
            GOTO      UREFT600 IF NOT EQUAL
          ENDIF
.
          MOVE      TDESC,TRGSDESC               * Set triage status desc
.
UREFT600  WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"</td>":
                             "<td>",ALREVISN,"</td>":
                             "<td>",DEPTDESC,"</td>":
                             "<td>",ALREPRCM,"</td>":
                             "<td>",OCTDESC,"</td>":
                             "<td>",OCADESC,"</td>":
                             "<td>",ALSTDESC,"</td>":
                             "<td><input type=checkbox name=linkvist ":
	    "onclick=#"CheckLink(this,'",TRIAGDES,"'",",'",TRGSDESC,"')#" ":
                             "value=#"",ALREVISN,"#"></td></tr>"
.
          GOTO      UREFT100
.
UREFT990  MOVE      ZERO,EXIT
          GOTO      UREFT999
.
UREFT999  RETURN
.
.------------------------------------------------------------
. Link a referral to a visit
.------------------------------------------------------------
LNKR0000  MOVE      ONE,F3
.
          MOVE      ZERO,STATCHEK
.
LNKR1000  IF        F3<=LINKEND
            MATCH     LINKVIST[F3],SP70
            IF        !@EQUAL
.
.              * check once that referral is not cancelled or rejected before linking
               COMPARE   ZERO,STATCHEK
               IF        @EQUAL
                 MOVE      ONE,STATCHEK
                 PACK      KEY8,LINKVIST[F3],SP70      * Patient Referral Details
                 CALL      RDALREF1
                 BRANCH    OVRCD,LNKR9200
.
                 MATCH     "4",ALRESTAT            * Referral is cancelled
                 GOTO      LNKR9300 IF EQUAL
.
                 MATCH     "5",ALRESTAT            * Referral is rejected
                 GOTO      LNKR9400 IF EQUAL
               ENDIF
.
               PACK      KEY16,ADMISSNO,SP70
               CALL      RSALLNK2
               CALL      RKALLNK2
               BRANCH    OVRCD,LNKR1200
.         
               MATCH     ADMISSNO,ALLNLNKV
               GOTO      LNKR9100 IF EQUAL
.
LNKR1200       MOVE      LINKVIST[F3],ALLNVISN
               MOVE      ADMISSNO,ALLNLNKV
.
               PACK      KEY36,ALLNLNKV,SP70
               CALL      RDSBOKA6
               CALL      RDKBOKA6
               BRANCH    OVRCD,LNKR1500
.
               MATCH     DOBAOUTN,ALLNLNKV
               GOTO      LNKR1500 IF NOT EQUAL
.
               MATCH     OBAURNO,URNUMBER
               GOTO      LNKR1500 IF NOT EQUAL
.
               MOVE      OBASITE,ALLNSITE
               MOVE      OBACLIN,ALLNCLIN
               MOVE      OBADATE,ALLNDATE
               MOVE      OBASTRT,ALLNSTRT
               MOVE      OBASLOT,ALLNSLOT
               MOVE      ZERO,ALLNSTAT
               MOVE      SP70,ALLNSPAR
               PACK      KEY16,ALLNVISN,ALLNLNKV,SP70
               CALL      RDALLNK1
               IF        OVRCD=1
                 MOVE      "0",ALLNMOHR            * Set to Unsent
                 CALL      WRALLNK1
.
                 MOVE      ONE,AUDTTYPE          * write history record
                 CALL      WAALLN00
                 CALL      WEDT0000          * Write EDWARD OP visit alteration
.
                 CALL      URSR0000                * Update Referral Status
               ENDIF
.
.              * CAR 249793 - Added updating of outbokcf.otbcrdat
.
               MOVE      ADMISSNO,KEY8
               CALL      RDOTBOC1
               IF        OVRCD=0
                 MOVE      ALRERDAT,OTBCRDAT
                 CALL      UPOTBOC1
               ELSE
                 MOVE      ALRERDAT,OTBCRDAT
                 MOVE      SP70,OTBCSPAR
                 CALL      WROTBOC1
               ENDIF
.
LNKR1400       PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
               CALL      RDSESA1
               BRANCH    OVRCD,LNKR1500
.
               PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
               CALL      RDOTHED1
               BRANCH    OVRCD,LNKR1500
            ENDIF
.
LNKR1500    ADD       ONE,F3
            GOTO      LNKR1000
          ENDIF
.
          GOTO      LNKR9000
.
LNKR9000  MOVE      ZERO,EXIT
          GOTO      LNKR9999
.
LNKR9100  MOVE      "Only one referral can be linked to this visit.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKR9999
.
LNKR9200  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKR9999
.
LNKR9300  MOVE      "Cannot link Outpatient Visits to a Cancelled Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKR9999
.
LNKR9400  MOVE      "Cannot link Outpatient Visits to a Rejected Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKR9999
.
LNKR9999  RETURN
.
.------------------------------------------------------------
. Unlink a referral from a visit
.------------------------------------------------------------
UNKR0000  MOVE      ONE,F3
UNKR1000  IF        F3<=UNLKEND
            MATCH     UNLKVIST[F3],SP70
            IF        !@EQUAL
               PACK      KEY16,UNLKVIST[F3],ADMISSNO,SP70
               CALL      RDALLNK1
               IF        OVRCD=0
                 CALL      DEALLNK1
                 MATCH     "1",ALLNMOHR
                 IF        @EQUAL
                   MOVE      "2",ALLNMOHR           * set to 'Send Delete'
                 ENDIF
                 MOVE      FOUR,AUDTTYPE         * delete history record
                 CALL      WAALLN00
                 CALL      WEDT0000          * Write EDWARD OP visit alteration
.
                 CALL      URSR0000                * Update Referral Status
.
.              * CAR 249793 - Added clearing of outbokcf.otbcrdat
.
                 MOVE      ADMISSNO,KEY8
                 CALL      RDOTBOC1
                 IF        OVRCD=0
                   PACK      OTBCRDAT,SP70
                   CALL      UPOTBOC1
                 ENDIF
.
               ENDIF
            ENDIF
.
            ADD       ONE,F3
            GOTO      UNKR1000
          ENDIF
.
          MOVE      ZERO,EXIT
.
UNKR9999  RETURN
+
.------------------------------------------------------------
. Get first default MBS item from outpatient default charges table.
. Get additional default items from referral table (allritaf).
. Inputs: VISITTYP,NSLOTKEY,REFRLVIS
. Auto apply clinic cmbs items template if applicable
.------------------------------------------------------------
DEFMBS00  CALL      XMLHED00
          BRANCH    EXIT,DEFMBS99
.
          MOVE      ZERO,ITMCOUNT                * init item counter
.
          MOVE      ZERO,AUTOCMBS                * Don't apply cmbs template
          UNPACK    NSLOTKEY,OMASITE,OMACLIN,DIM8,OMASTART
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          MOVE      WEEKDAY,DIM1
          PACK      KEY18,OMASITE,OMACLIN,DIM1,OMASTART,SP70
          CALL      RDMASA1                      * need to get 'omareg'
          BRANCH    OVRCD,DEFMBS05
.
          MATCH     "1",OTMAMBSA 
          IF        @EQUAL
            MATCH     SP70,OTMAMBST
            IF        !@EQUAL
              MOVE      ONE,AUTOCMBS             * Apply cmbs template
            ENDIF
          ENDIF
.
          MOVE      OMAREG,DIM1
          REP       "Y1N0",DIM1
          PACK      KEY4,VISITTYP,DIM1,SP70
          CALL      RDOTDCH1                     * get first default item
          IF        OVRCD=1
            REP       "1001",DIM1
            PACK      KEY4,VISITTYP,DIM1,SP70
            CALL      RDOTDCH1
            BRANCH    OVRCD,DEFMBS05
          ENDIF
.
          MOVE      OTDCIFLG,ITEMIFLG
          MOVE      OTDCITMN,ITEMITMN
          MOVE      OTDCSUBN,ITEMSUBN
          MOVE      SP70,PROVUSGE
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY10,REFRLVIS,SP70
          CALL      RSALRIT1
          GOTO      DEFMBS15
.
DEFMBS05  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY10,REFRLVIS,SP70
          CALL      RSALRIT1
DEFMBS10  MATCH     REFRLVIS,SP70
          GOTO      DEFMBS80 IF EQUAL
.
          CALL      RKALRIT1                     * loop thru referral items
          BRANCH    OVRCD,DEFMBS80
.
          MATCH     REFRLVIS,ALRTVISN
          GOTO      DEFMBS80 IF NOT EQUAL        * check if same referral
.
          MOVE      ALRTIFLG,ITEMIFLG
          MOVE      ALRTITMN,ITEMITMN
          MOVE      ALRTSUBN,ITEMSUBN
          MOVE      ALRTPUSE,PROVUSGE
.
DEFMBS15  PACK      KEY22,ITEMIFLG,ITEMITMN,ITEMSUBN,Z70
          CALL      RSPRIT1
DEFMBS20  CALL      RPPRIT1                      * validate each item/get desc
          BRANCH    OVRCD,DEFMBS80
.
          MATCH     ITEMIFLG,DPRITFLG
          GOTO      DEFMBS80 IF NOT EQUAL
.
          MATCH     ITEMITMN,PRITITMN
          GOTO      DEFMBS80 IF NOT EQUAL
.
          MATCH     SP70,ITEMSUBN
          IF        !@EQUAL
            MATCH     ITEMSUBN,PRITSUBN
            GOTO      DEFMBS80 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DIM8
          IF        !@EQUAL
            MATCH     PRITDAT1,DIM8
            GOTO      DEFMBS20 IF LESS
          ENDIF
.
          MATCH     " 0",DPRITFLG
          IF        @EQUAL
            MOVE      "MBS",DIM3
          ELSE
            MOVE      "AMA",DIM3
          ENDIF
          MOVE      PRITSFEE,DIM15
          GOTO      DEFMBS85
.
DEFMBS80  MOVE      "MBS",DIM3                    * clear output vars
          MOVE      SP70,PRITITMN
          MOVE      SP70,PRITSUBN
          MOVE      SP70,PRITDESC
          MOVE      SP70,DIM15
          MOVE      SP70,PROVUSGE
.
DEFMBS85  WRITE     HTMLFILE;DIM3,"|",PRITITMN,"|",PRITSUBN,"|",PRITDESC,"|":
                             DIM15,"|",PROVUSGE,"|";
          ADD       ONE,ITMCOUNT
          IF        ITMCOUNT < 5
            GOTO      DEFMBS10                   * only want max of 5 items
          ENDIF
.
DEFMBS90  WRITE     HTMLFILE;AUTOCMBS,"|",OTMAMBST,"|";
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      DEFMBS98
.
DEFMBS98  CALL      XMLEND00
DEFMBS99  RETURN
+
.
.******************************************************************************
.                    DISPLAY LIST OF REFERRAL LETTERS
.******************************************************************************
LETTY000  MOVE      ZERO,F3 
          PACK      KEY6,F3,SP10
          CALL      RSALLET2
.
LETTY100  CALL      RKALLET2
          BRANCH    OVRCD,LETTY999
.
          COMPARE   ZERO,ALLTLINO
          GOTO      LETTY999 IF NOT EQUAL
.
          MATCH     "1",ALLTACTV            * Skip inactive
          GOTO      LETTY100 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DALLTLTN,"#">",ALLTTEXT:
                             "</option>"
          GOTO      LETTY100
.
LETTY999  RETURN
+
.
.******************************************************************************
.                    DISPLAY LIST OF REFERRAL LETTERS
.******************************************************************************
LTTYNZ00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDLL1
          IF        OVRCD=1
            PACK      ALDLRACG,SP70 
            PACK      ALDLURAG,SP70 
            PACK      ALDLRRJG,SP70 
          ENDIF
.
          MOVE      ZERO,F3
          PACK      KEY6,F3,SP10
          CALL      RSALLET2
.
LTTYNZ10  CALL      RKALLET2
          BRANCH    OVRCD,LTTYNZ99
.
          COMPARE   ZERO,ALLTLINO
          GOTO      LTTYNZ99 IF NOT EQUAL
.
          IF        F1=1
            MATCH     ALDLRACG,DALLTLTN
            IF        @EQUAL
              WRITE     HTMLFILE;"<option selected value=#"",DALLTLTN,"#">":
                                 ALLTTEXT,"</option>"
              GOTO      LTTYNZ10
            ENDIF
          ENDIF
.
          IF        F1=2
            MATCH     ALDLURAG,DALLTLTN
            IF        @EQUAL
              WRITE     HTMLFILE;"<option selected value=#"",DALLTLTN,"#">":
                                 ALLTTEXT,"</option>"
              GOTO      LTTYNZ10
            ENDIF
          ENDIF
.
          IF        F1=3
            MATCH     ALDLRRJG,DALLTLTN
            IF        @EQUAL
              WRITE     HTMLFILE;"<option selected value=#"",DALLTLTN,"#">":
                                 ALLTTEXT,"</option>"
              GOTO      LTTYNZ10
            ENDIF
          ENDIF
.
          MATCH     "1",ALLTACTV            * Skip inactive
          GOTO      LTTYNZ10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DALLTLTN,"#">",ALLTTEXT:
                             "</option>"
          GOTO      LTTYNZ10
.
LTTYNZ99  RETURN
+
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
REMOTE05  MOVE      ZERO,F1
          MOVE      UPDATETY,F1
          BRANCH    F1,REMOTE10,REMOTE20,REMOTE30,REMOTE40,REMOTE50:
                       REMOTE60,REMOTE70,REMOTE80,REMOTE90
.
          MATCH     "P",UPDATETY
          GOTO      REMOTE91 IF EQUAL
.
          MATCH     "G",UPDATETY
          GOTO      REMOTE92 IF EQUAL
.
          MATCH     "C",UPDATETY
          GOTO      REMOTE94 IF EQUAL
.
REMOTE06  MATCH     "R",UPDATETY
          GOTO      REMOTE93 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE95
.
REMOTE10  CALL      CHKBOK00      * Check for unlinked appointments that are
          GOTO      REMOTE95      * valid for a referral
.
REMOTE20  CALL      CHKREF00      * Check for active/inactive referrals
          GOTO      REMOTE95
.
REMOTE30  CALL      CHKAPP00      * Check if there are linked
          GOTO      REMOTE95      * appointments with a status of booked
.
REMOTE40  CALL      OUTAPP00      * Validate and return outpatient
          GOTO      REMOTE95      * appointment and referral details
.
REMOTE50  CALL      OUTCTY00      * Return selection list for a departments
          GOTO      REMOTE95      * clinic types for the preferred site
.
REMOTE60  CALL      CHKOUT00      * Check if there are linked OP appointments
          GOTO      REMOTE95      * after the referrals proposed close date
.
REMOTE70  CALL      CHKDHB00      * Check if patient's DHB = hospital DHB (nz)
          GOTO      REMOTE95      * when adding/updating referrals
.
REMOTE80  CALL      VALREF00      * Validate referral and return details
          GOTO      REMOTE95
.
REMOTE90  CALL      PRODEP00      * Determine the program referral department
          GOTO      REMOTE95      * for a given episode referral
.
REMOTE91  CALL      CHKPRI00
          GOTO      REMOTE95
.
REMOTE92  CALL      GETLGP00      * Get local GP/Practice for a U/R
          GOTO      REMOTE95
.
REMOTE93  CALL      CHKRQA00      * Check if there are appointments with a
          GOTO      REMOTE95      * status of Requested or Pending Reschedule
.
REMOTE94  CALL      INPF0000      * check if patient U/R has an Inpatient visit
          GOTO      REMOTE95      * for Date & Time of Contact being entered
.
REMOTE95  CALL      XMLEND00
.
REMOTE99  RETURN
.
.******************************************************************************
.                    REMOTE SCRIPTS
.******************************************************************************
RMOT0000  BRANCH    REMOTSNO,RMOT0100,RMOT0200,RMOT0300
.
          GOTO      RMOT9999
.
RMOT0100  CALL      ATCAS000      * Check if the case team can be updated for  
          GOTO      RMOT9999      * an MH visit
.
RMOT0200  CALL      IPDET000      * Get current IP details
          GOTO      RMOT9999
.
RMOT0300  CALL      RFNACT00      * Check if the referral has no activity
          GOTO      RMOT9999      
.
RMOT9999  RETURN
.
.******************************************************************************
. Remote script to check if the case team to be updated on a MH referral 
. currently have any activity attached.
.
. Activity is defined as an Encounter record, a linked attended/DNA outpatient 
. appointment, or a link group attendance/DNA.
.
. Input : ADMISSNO, VALDTEAM (case team)
. Output: 0 - Activity not found
.         1 - Activity found 
.         2 - Error referral not found
.         3 - Error department code not found in Category CG 
.******************************************************************************
ATCAS000  CALL      XMLHED00                * OPENHTML
          BRANCH    EXIT,ATCAS999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ATCAS920          * Exit if referral not found

          MATCH     VALDTEAM,ALREUHC4       * Exit if case team not changed
          GOTO      ATCAS900 IF EQUAL
.
          PACK      KEY5,CATCG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ATCAS930          * Exit if dept code not found
.
          MATCH     ANSM,TCINDC4                                    
          GOTO      ATCAS900 IF NOT EQUAL   * Exit if not MH visit   
.
.-------- Check encounters on allencaf table
          PACK      KEY32,ALREVISN,ALRERDAT,SP70
          CALL      RSALENC6
ATCAS100  CALL      RKALENC6                * allencaf
          BRANCH    OVRCD,ATCAS300          * EOF,then check allgrpaf
.
          MATCH     ADMISSNO,ALENVISN       * Same referral
          GOTO      ATCAS300 IF NOT EQUAL   * No, check group contacts
.
          MATCH     "1",ALENRSTA            * Igore cancelled encounter
          GOTO      ATCAS100 IF EQUAL       * read next encounter
.
          GOTO      ATCAS910                * Activity found,exit
.
.-------- Check group contacts on allgrpaf table
ATCAS300  PACK      KEY16,ALREVISN,SP70     * see if any Group Contacts ("AT"s)
          CALL      RSALGPA2
ATCAS320  CALL      RKALGPA2                * allgrpaf
          BRANCH    OVRCD,ATCAS400          * EOF, then check alllnkaf
.
          MATCH     ALREVISN,ALGAREFN
          GOTO      ATCAS400 IF NOT EQUAL
.
          MATCH     "1",ALGACURP            * Current patient?
          GOTO      ATCAS320 IF EQUAL       * Yes
.
          PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ATCAS320
.
          MATCH     SP4,THCSCOD             * Cancelled? (otherwise T06,T35 etc)
          GOTO      ATCAS320 IF EQUAL
.
          GOTO      ATCAS910                * Activity found, exit
.
.-------- Check linked OP Appointments on alllnkaf table
ATCAS400  PACK      KEY16,ALREVISN,SP70     * any Linked OP Appointments ?
          CALL      RSALLNK1                * Referral Link file
ATCAS420  CALL      RKALLNK1                * ("alllnkaf")
          BRANCH    OVRCD,ATCAS900
.
          MATCH     ALREVISN,ALLNVISN       * Same visit number?
          GOTO      ATCAS900 IF NOT EQUAL   * No,activity not found
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      ATCAS420 IF EQUAL       * Ignore cancelled record
.
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
ATCAS440  CALL      RDKBOKA6                
          BRANCH    OVRCD,ATCAS900          * Activity not found
.
          MATCH     ALLNLNKV,DOBAOUTN       * (OBAOUTNO)
          GOTO      ATCAS900 IF NOT EQUAL   * Different visit number
.
.                                           * only Attended & not-Attended
          IF        OBASTAT = 4 | OBASTAT = 5
            GOTO      ATCAS910              * Activity found
          ELSE
            GOTO      ATCAS440              * Read next booking record   
          ENDIF
.
.-------- Return value=0 - can update
ATCAS900  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                   * Can update case team     
                    "</RETURN_VALUE>"
          GOTO      ATCAS999
.
.-------- Return value=1 - activity found warning message
ATCAS910  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                    * Warning message
                    "</RETURN_VALUE>"
          GOTO      ATCAS999
.
.-------- Error - referral not found 
ATCAS920  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    ADMISSNO," - not found on allrefaf table ":
                    "</RETURN_VALUE>"
          GOTO      ATCAS999
.
.-------- Error - department code not found in Category CG
ATCAS930  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    ALREDEPT," - departmnet code not found in Category CG ":
                    "</RETURN_VALUE>"
          GOTO      ATCAS999
.
ATCAS999  CALL      XMLEND00                * CLOSHTML
          RETURN
.
.-----------------------------------------------------------------------------
. Remote script to check if a referral has no activity and show warning
.
. Input : ADMISSNO 
. Output: 0 - Activity found and iNo warning oi shown
.         1 - Activity not found and show warning
.         2 - Fatal Error found
.-----------------------------------------------------------------------------
RFNACT00  CALL      XMLHED00                * OPENHTML
          BRANCH    EXIT,RFNACT99
.
RFNACT10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,RFNACT92          * Exit if referral not found
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,RFNACT93
.
          PACK      KEY5,CATCG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFNACT94
.
          MATCH     ANSI,PTCOACTV
          GOTO      RFNACT90 IF EQUAL
.
          MATCH     ANSY,TCINDC32
          GOTO      RFNACT90 IF NOT EQUAL 
.
          MATCH     "1",ALREUYN4
          GOTO      RFNACT20 IF NOT EQUAL
.
          MATCH     "1",ALDEPENC
          GOTO      RFNACT90 IF EQUAL
.
. Check encounters on allencaf table
.
RFNACT20  PACK      KEY32,ALREVISN,ALRERDAT,SP70
          CALL      RSALENC6
RFNACT22  CALL      RKALENC6                * allencaf
          BRANCH    OVRCD,RFNACT30          * EOF,then check allgpaaf
.
          MATCH     ADMISSNO,ALENVISN       * Same referral
          GOTO      RFNACT30 IF NOT EQUAL   * No, check group contacts
.
          MATCH     "1",ALENRSTA            * Ignore cancelled encounter
          GOTO      RFNACT22 IF EQUAL       * read next encounter
.
          GOTO      RFNACT90                * Activity found
.
. Check group contacts on allgrpaf table
.
RFNACT30  PACK      KEY16,ALREVISN,SP70     * see if any Group Contacts ("AT"s)
          CALL      RSALGPA2
RFNACT32  CALL      RKALGPA2                * allgpaaf
          BRANCH    OVRCD,RFNACT40          * EOF
.
          MATCH     ALREVISN,ALGAREFN
          GOTO      RFNACT40 IF NOT EQUAL
.
.         MATCH     "1",ALGACURP            * Current patient?
.         GOTO      RFNACT32 IF EQUAL       * Yes, Ignore current patient
.
          PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFNACT32
.
          MATCH     ANSI,PTCOACTV
          GOTO      RFNACT32 IF EQUAL 
.
          MATCH     SP70,THCSCOD            * Cancelled? (otherwise T06,T35 etc)
          GOTO      RFNACT32 IF EQUAL
.
          GOTO      RFNACT90                * Activity found
.
. Check linked OP Appointments on alllnkaf table
.
RFNACT40  PACK      KEY16,ALREVISN,SP70     * any Linked OP Appointments ?
          CALL      RSALLNK1                * Referral Link file
RFNACT42  CALL      RKALLNK1                
          BRANCH    OVRCD,RFNACT91          * No activity found
.
          MATCH     ALREVISN,ALLNVISN       * Same visit number?
          GOTO      RFNACT91 IF NOT EQUAL   * No activity found
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      RFNACT42 IF EQUAL       * Ignore cancelled record
.
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
RFNACT44  CALL      RDKBOKA6
          BRANCH    OVRCD,RFNACT42          * Next Referral Link 
.
          MATCH     ALLNLNKV,DOBAOUTN       
          GOTO      RFNACT42 IF NOT EQUAL   * Different visit number
.
.                                           * only Attended & not-Attended
          IF        OBASTAT = 4 | OBASTAT = 5
            GOTO      RFNACT90              * Activity found
          ENDIF
.
          GOTO      RFNACT44                * Read next booking record
.
. Return value=0 - activity found or show no warning message
RFNACT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                   * No Warning message 
                    "</RETURN_VALUE>"
          GOTO      RFNACT99
.
. Return value=1 - activity not found & show warning message
RFNACT91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                    * Warning message
                    "</RETURN_VALUE>"
          GOTO      RFNACT99
.
. Error - referral not found 
RFNACT92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    ADMISSNO," - not found on allrefaf table ":
                    "</RETURN_VALUE>"
          GOTO      RFNACT99
.
. Error - referral department not found
RFNACT93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    ALREDEPT," - not found on alldepaf table ":
                    "</RETURN_VALUE>"
          GOTO      RFNACT99
.
. Error - department code not found in Category CG
RFNACT94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    ALREDEPT," - departmnet code not found in Category CG ":
                    "</RETURN_VALUE>"
          GOTO      RFNACT99
.
RFNACT99  CALL      XMLEND00                * CLOSHTML
          RETURN
.
.******************************************************************************
. Remote script to get the current inpatient visit details
.
. Input : URNUMBER
. Output: patmi1af.daadmno|adocta|aclaim
.
.******************************************************************************
IPDET000  CALL      XMLHED00                * OPENHTML
          BRANCH    EXIT,IPDET910
.
          PACK      KEY17,URNUMBER,TWO,SP70      * Get current IP visit
          CALL      RSPTMI18                     * patmi1af
          CALL      RKPTMI18
          BRANCH    OVRCD,IPDET910
.
          MATCH     URNUMBER,AURNO               * Same UR
          GOTO      IPDET910 IF NOT EQUAL        * No, exit
.
          MATCH     "2",DASTAT                   * Current Status
          GOTO      IPDET910 IF NOT EQUAL        * No, exit
.
IPDET900  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DAADMNO,"|",ADOCTA,"|",ACLAIM,"|":
                             "</RETURN_VALUE>"
          GOTO      IPDET999
.
IPDET910  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "</RETURN_VALUE>"
          GOTO      IPDET999
.
IPDET999  CALL      XMLEND00                * CLOSHTML
          RETURN
.
.******************************************************************************
. Check if there are any unlinked valid bookings for this referral
.******************************************************************************
CHKBOK00  READ      CONTROLF,ZERO;*132,IBCNUMCI
          MATCH     "1",IBCNUMCI
          GOTO      CHKBOK90 IF NOT EQUAL   * not using medclaims
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,CHKBOK90
.
          MATCH     SP70,ALREREXP
          IF        @EQUAL
            PACK      KEY36,ALREURNO,Z70
          ELSE
            PACK      KEY36,ALREURNO,ALREREXP,Z70
          ENDIF
.
          CALL      RDSBOKA3
CHKBOK10  CALL      RDPBOKA3
          BRANCH    OVRCD,CHKBOK90
.
          MOVE      ALREURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      CHKBOK90 IF NOT EQUAL
.
          MATCH     ALRERDAT,OBADATE     * Check referral and booking date
          GOTO      CHKBOK90 IF LESS
.
          MATCH     ALRECLID,OBACLIN     * Same clinic
          GOTO      CHKBOK20 IF EQUAL
.
          MATCH     ALRECTYP,OBACTYP     * Same clinic id
          GOTO      CHKBOK20 IF EQUAL
.
          GOTO      CHKBOK10
.
CHKBOK20  BRANCH    OBASTAT,CHKBOK30,CHKBOK10,CHKBOK10,CHKBOK30
          GOTO      CHKBOK10
.
CHKBOK30  PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,CHKBOK35
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      CHKBOK10 IF EQUAL
.
CHKBOK35  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                     * Unlinked valid booking available
                    "</RETURN_VALUE>"
          GOTO      CHKBOK99
.
CHKBOK90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                    * No valid bookings
                    "</RETURN_VALUE>"
          GOTO      CHKBOK99
.
CHKBOK99  RETURN
.
.******************************************************************************
.  Check for Active/Inactive Referral in This Department for this U/R
.******************************************************************************
CHKREF00  PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
CHKREF10  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,CHKREF90
.
          MATCH     URNUMBER,ALREURNO
          GOTO      CHKREF90 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Match to department
          GOTO      CHKREF10 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      CHKREF80 IF EQUAL
.
          MATCH     "3",ALRESTAT            * Inactive
          GOTO      CHKREF80 IF EQUAL
.
          GOTO      CHKREF10
.
CHKREF80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                     * Active/Inactive referrals exist
                    "</RETURN_VALUE>"
          GOTO      CHKREF99
.
CHKREF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                    * No Active/Inactive referrals
                    "</RETURN_VALUE>"
          GOTO      CHKREF99
.
CHKREF99  RETURN
+
.******************************************************************************
.  Check for Active/Waiting Referral in This Department for this U/R
.******************************************************************************
CHKPRI00  PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,CHKPRI90
.
          MATCH     "1",ALDEAONE        * If NZ check deprtment file
          GOTO      CHKPRI90 IF NOT EQUAL
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2                * Positional Read
CHKPRI10  CALL      RKALREF2                * Read a Record
          BRANCH    OVRCD,CHKPRI90
.
          MATCH     URNUMBER,ALREURNO
          GOTO      CHKPRI90 IF NOT EQUAL
.
          MATCH     DEPTCODE,ALREDEPT       * Match department
          GOTO      CHKPRI10 IF NOT EQUAL
.
          MATCH     "1",ALREUYN4            * Primary
          GOTO      CHKPRI10 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      CHKPRI80 IF EQUAL
.
          MATCH     "0",ALRESTAT            * Waiting
          GOTO      CHKPRI80 IF EQUAL
.
          GOTO      CHKPRI10
.
CHKPRI80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                     * Active/Waiting referrals exist
                    "</RETURN_VALUE>"
          GOTO      CHKPRI99
.
CHKPRI90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                    * No Active/Waiting referrals or ALDEAONE not set
                    "</RETURN_VALUE>"
          GOTO      CHKPRI99
.
CHKPRI99  RETURN
.
.******************************************************************************
. Check if there are any linked bookings in the future for this referral
.******************************************************************************
CHKAPP00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,CHKAPP90
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
CHKAPP20  CALL      RKALLNK1
          BRANCH    OVRCD,CHKAPP90
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      CHKAPP90 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      CHKAPP20 IF EQUAL
.
          MATCH     SP70,CURRVIST
          IF        !@EQUAL
            MATCH     CURRVIST,ALLNLNKV     * Ignore the current OP visit
            GOTO      CHKAPP20 IF EQUAL
          ENDIF
.
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,CHKAPP20
.
          MATCH     ALLNLNKV,DOBAOUTN
          GOTO      CHKAPP20 IF NOT EQUAL
.
CHKAPP30  BRANCH    OBASTAT,CHKAPP35        * Appointment status of booked
          GOTO      CHKAPP20
.
CHKAPP35  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                     * Linked bookings exits
                    "</RETURN_VALUE>"
          GOTO      CHKAPP99
.
CHKAPP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                    * No linked bookings
                    "</RETURN_VALUE>"
          GOTO      CHKAPP99
.
CHKAPP99  RETURN
.
.******************************************************************************
. Check if there are any appointment with a status of Requested or 
. Pending Reschedule 
.******************************************************************************
CHKRQA00  PACK      KEY32,URNUMBER,ADMISSNO,SP70 * Requested Appointments
          CALL      RSOTART1
CHKRQA20  CALL      RKOTART1
          BRANCH    OVRCD,CHKRQA90
.
          MATCH     URNUMBER,OTARURNO
          GOTO      CHKRQA90 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTARREFN
          GOTO      CHKRQA90 IF NOT EQUAL
.
          MATCH     "0",OTARSTAT             * Requested or Pending Resch
          IF        !@EQUAL
            MATCH     "1",OTARSTAT
            GOTO      CHKRQA20 IF NOT EQUAL
          ENDIF
.
CHKRQA80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                     * Requested or Pending Resch
                    "</RETURN_VALUE>"        * exists
          GOTO      CHKRQA99
.
CHKRQA90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                    * No equested or Pending Resch
                    "</RETURN_VALUE>"
          GOTO      CHKRQA99
.
CHKRQA99  RETURN
.
.******************************************************************************
. See if the patient was an inpatient at the time of the contact
. Requires : URNUMBER,VALDDATE,VALDTIME
.******************************************************************************
INPF0000  PACK      KEY17,URNUMBER,SP20
          CALL      RSPTMI18                     * position on U/R
INPF0500  CALL      RKPTMI18                     * read next record
          BRANCH    OVRCD,INPF9500               * eof - finished
.
          MATCH     URNUMBER,AURNO               * same U/R still ?
          GOTO      INPF9500 IF NOT EQUAL        * no - finished
.
          MATCH     SP70,ACLSS
          IF        !@EQUAL
            PACK      KEY5,ANSP,SP1,ACLSS,SP70
            CALL      RDCODE1
            IF        OVRCD <> 1
              MATCH     "3",TCINDC1              * BHS ignore boarder
              GOTO      INPF0500 IF EQUAL        * admissions
            ENDIF
          ENDIF
.
.         Check if the contact was prior to the admission (CAR 301450
.         added time check as well for same day)
.
          MATCH     ADATE,VALDDATE               * contact start date<adm date ?
          GOTO      INPF0500 IF LESS             * yes - get next record
          IF        @EQUAL
            MATCH     ATIME,VALDTIME            * contact start time<adm time ?
            GOTO      INPF0500 IF LESS          * yes - get next record
          ENDIF
.
.         The contact is on or after the admission, so check if the
.         patient was admitted when the contact took place.
.
          BRANCH    ASTAT,INPF0500:              * pre-admission
                          INPF9000:              * current admission
                          INPF1000:              * discharged
                          INPF9000:              * on-leave
                          INPF0500               * cancelled
.
          GOTO      INPF0500                     * shouldn't happen
.
INPF1000  MOVE      AADMNO,KEY8
          CALL      RDDSCH1                      * discharge record found ?
          BRANCH    OVRCD,INPF0500               * no - get next record
.
          MATCH     VALDDATE,DDATE               * discharge before contact ?
          GOTO      INPF0500 IF LESS             * yes - get next record
          GOTO      INPF9000 IF NOT EQUAL        * discharge date greater
.
.         Same day, so check times
.
          MATCH     VALDTIME,DTIME               * discharge before contact ?
          GOTO      INPF0500 IF LESS             * yes - get next record
.
.         Patient was admitted when contact took place
.
INPF9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:                         * Diaplay Yes in inpatient flag
                    "</RETURN_VALUE>"            * exists
          GOTO      INPF9999
.
INPF9500  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:                       * Display No in inpatient flag
                    "</RETURN_VALUE>"           * exists
.
INPF9999  RETURN
.******************************************************************************
. Validate the outpatient appointment and A/H referral. Return details
. so they can be used as defaults when adding encounters in outpatients
.******************************************************************************
OUTAPP00  PACK      KEY8,REFRLVIS,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,OUTAPP90
.
          PACK      KEY8,REFRLVIS,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,OUTAPP90
.
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,OUTAPP90
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      OUTAPP90 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTAPP90
.
          MOVE      SP70,DISPDAT1                * Display Date
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ZERO,TCFORM6
          ENDIF
.
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,OUTAPP34
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,OUTAPP30
.
          ASSIGN    (OTHEDURN * TCFORM6),FORM8
.
          MOVE      SP3,DIM3
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OUTAPP30
.
          MATCH     "L",TCINDC3
          IF        @EQUAL
            PACK      DIM3,ACODE
          ENDIF
.
OUTAPP30  PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      OUTAPP80
          ENDIF
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,OUTAPP34
.
          MATCH     OCASITE,OSESITE
          GOTO      OUTAPP34 IF NOT EQUAL
.
          MATCH     OCACLIN,OSECLIN
          GOTO      OUTAPP34 IF NOT EQUAL
.
          GOTO      OUTAPP80
.
OUTAPP34  MOVE      SP70,OCADOCT
.
OUTAPP80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DISPDAT1,"|",OBATIME,"|",FORM8,"|",ALRECOMP:
                              "|",PMVXUDF1,"|",OCADOCT,"|",DIM3,"|",ALREPURC:
                              "|",OTBBCITM:
                    "</RETURN_VALUE>"
          GOTO      OUTAPP99
.
OUTAPP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid Appointment/Referral ":
                    "</RETURN_VALUE>"
          GOTO      OUTAPP99
.
OUTAPP99  RETURN
.
.-----------------------------------------------------------------------------.
.  Link unlink referrals to SACS referral
.-----------------------------------------------------------------------------.
LNKREF00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      LNKREF80 IF EQUAL
.
          MATCH     "A",UPDATETY            * Link/Unlink ref to SACS ref
          GOTO      LNKREF10 IF EQUAL
.
          GOTO      LNKREF90
.
LNKREF10  CALL      USAC0000                * Unlink visits from a referral
          BRANCH    EXIT,ALLLNK99
.
          CALL      LSAC0000                * Link visits to a referral
          BRANCH    EXIT,ALLLNK99
.
          MOVE      ZERO,EXIT
          GOTO      LNKREF99
.
LNKREF80  CALL      CURPER00                * Display Routine
          CALL      CALCDT00              * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,LNKREF91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,LNKREF91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,LNKREF92
.
LNKREF85  CLEAR     WEBTITLE
          MOVE      "Allied Health Linked Referrals",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,LNKREF99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      LNKREF99
.
LNKREF90  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKREF99
.
LNKREF91  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKREF99
.
LNKREF92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LNKREF99
.
LNKREF99  RETURN
.
.-----------------------------------------------------------------------------.
.     Table of unlinked patient referrals
.-----------------------------------------------------------------------------.
ULNKR000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      SP70,CLOSEDAT           * Master close date
          MOVE      SP70,REFRLDAT           * Master referral date
          MOVE      SP70,CANCLDAT           * Master cancel date
          MOVE      SP70,REJECDAT           * Master rejected date
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Read SACS master
          BRANCH    OVRCD,ULNKR9999
.
          MATCH     "1",ALREUYN4            * SACS master
          GOTO      ULNKR999 IF NOT EQUAL
.
          MOVE      ALRERDAT,REFRLDAT       * Save master referral date
.
          MATCH     "4",ALRESTAT            * Cancelled
          IF        @EQUAL
            MOVE      ALREDCAN,CANCLDAT     * Save master cancel date
            GOTO      ULNKR090
          ENDIF
.
          MATCH     "5",ALRESTAT            * Rejected
          IF        @EQUAL
            MOVE      ALRESRDT,REJECDAT     * Save master rejected date
            GOTO      ULNKR090
          ENDIF
.
          MATCH     "2",ALRESTAT            * Closed
          GOTO      ULNKR090 IF NOT EQUAL
.
          MOVE      ALREDCLO,CLOSEDAT       * Save closed date
.
          MATCH     SP70,ALREUDT6           * SACS case end date
          GOTO      ULNKR090 IF EQUAL
.
          MATCH     ALREDCLO,ALREUDT6       * Case end < closed date
          GOTO      ULNKR090 IF NOT LESS
.
          MOVE      ALREUDT6,CLOSEDAT       * Use case end date
.
ULNKR090  MOVE      ZERO,COUNTER
          PACK      KEY16,URNUMBER,Z70
          CALL      RSALREF2
ULNKR100  CALL      RPALREF2
          BRANCH    OVRCD,ULNKR999
.
          MATCH     ALREURNO,URNUMBER
          GOTO      ULNKR999 IF NOT EQUAL
.
          IF        PTCNHDPS=1
            MATCH     ADMISSNO,ALREVISN
            GOTO      ULNKR100 IF EQUAL
          ELSE                                                        *C-205366
.                                           * NZ wants to see Primary Referrals
            MATCH     "1",ALREUYN4          * Skip SACS master referrals
            GOTO      ULNKR100 IF EQUAL
          ENDIF
.
          PACK      KEY16,ADMISSNO,ALREVISN,SP70
          CALL      RDALRLN1                * Skip linked referrals
          COMPARE   ZERO,OVRCD
          GOTO      ULNKR100 IF EQUAL
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ULNKR100
.
          MATCH     "0",ALDESECU
          GOTO      ULNKR170 IF EQUAL
.
          MATCH     "1",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      ULNKR170 IF EQUAL
          ENDIF
.
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      ULNKR170 IF EQUAL
          ENDIF
          GOTO      ULNKR100
.
ULNKR170  MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,DEPDESC
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,ALENSDAT
          PACK      KEY16,ALREVISN,Z70
          CALL      RSALENC1
          CALL      RPALENC1
          BRANCH    OVRCD,ULNKR171
          MATCH     ALREVISN,ALENVISN
          GOTO      ULNKR171 IF EQUAL
          MOVE      SP70,ALENSDAT
.
ULNKR171  MOVE      SP70,DISPPROV                * Clear provider number
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                     * To get Problem Description
          IF        OVRCD=1
            CALL      CLALPR00
          ENDIF
.
          UNPACK    SP70,DOCFNAME                * clear HCP Names    *I-226078
          UNPACK    SP70,DOCFNAM2
          PACK      KEY10,ALREHCP,SP70           * get Responsible HCP name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,DOCFNAM2
          ENDIF                                                 * end *I-226078
.
          MOVE      SP70,DOCFNAME                * Clear HCP Name
          PACK      KEY10,ALRERHCP,SP70          * To get HCP name
          CALL      RDPMHCP1                     * !! datefile not exists
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
.
            MATCH     SP70,PMHCPRV1
            IF        @EQUAL
              MOVE      SP70,DISPPROV
            ELSE
              PACK      DISPPROV,LBRACK,PMHCPRV1,RBRACK
            ENDIF
          ENDIF
.
          PACK      KEY20,ALRERHCP,ALRERHCR,SP70
          CALL      RDPMHCL1
          IF        OVRCD=0
            MATCH     SP70,PMHLPRV1
            IF        !@EQUAL
              PACK      DISPPROV,LBRACK,PMHLPRV1,RBRACK
            ENDIF
          ENDIF
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE                * To get Priority Description
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE                * To get Compensation Desc
          CALL      GETCOD00
          MOVE      TDESC,COMPDESC
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      ULNKR180 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,ULNKR180
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      ULNKR180
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
ULNKR180  CALL      SETX0000                * Set Expiry Icon
.
          MOVE      DUBOOKED,BOOKSTAT
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
ULNKR185  CALL      RKALLNK1
          BRANCH    OVRCD,ULNKR190
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      ULNKR190 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      ULNKR185 IF EQUAL
.
          MOVE      DBOOKED,BOOKSTAT
.
ULNKR190  ADD       ONE,COUNTER
          IF        COUNTER>400
             WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=6 align=center>":
                                 "<b>Table exceeds 400 records. Records":
                                 "beyond 400 will not be displayed</td>"
             GOTO    ULNKR999
          ENDIF
.
          MOVE      ZERO,LINKFLAG                * Allow link
.
          MATCH     REFRLDAT,ALRERDAT
          IF        @LESS
            MOVE      ONE,LINKFLAG            * Don't allow link if the
            GOTO      ULNKR500                * internal referral date is
          ENDIF                               * before the master referral date
.
ULNKR200  MATCH     SP70,CANCLDAT                * If SACS master cancelled
          GOTO      ULNKR300 IF EQUAL
.
          MOVE      ONE,LINKFLAG                 * Don't allow link
.
          MATCH     "4",ALRESTAT                 * Only allow linking of
          GOTO      ULNKR300 IF NOT EQUAL        * cancelled internal referrals
.
          MATCH     ALREDCAN,CANCLDAT            * Internal cancelled after SACS
          GOTO      ULNKR300 IF LESS             * master
.
          MOVE      ZERO,LINKFLAG                * Allow link
.
ULNKR300  MATCH     SP70,REJECDAT                * If SACS master rejected
          GOTO      ULNKR400 IF EQUAL
.
          MOVE      ONE,LINKFLAG                 * Don't allow link
.
          MATCH     "5",ALRESTAT                 * Only allow linking of
          GOTO      ULNKR400 IF NOT EQUAL        * rejected internal referrals
.
          MATCH     ALRESRDT,REJECDAT            * Internal rejected after SACS
          GOTO      ULNKR400 IF LESS             * master
.
          MOVE      ZERO,LINKFLAG                * Allow link
.
ULNKR400  MATCH     SP70,CLOSEDAT                * If SACS master closed
          GOTO      ULNKR500 IF EQUAL
.
          MOVE      ONE,LINKFLAG                 * Don't allow link
.
          MATCH     "2",ALRESTAT                 * Only allow linking of closed
          GOTO      ULNKR500 IF NOT EQUAL        * internal referrals
.
          MATCH     ALREDCLO,CLOSEDAT            * Internal closed after SACS
          GOTO      ULNKR500 IF LESS             * master
.
          MOVE      ZERO,LINKFLAG                * Allow link
.
ULNKR500  MOVE      SP70,DISPDAT1                * Referral Date
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",DEPDESC,"&nbsp;</td>":
                             "<td>",ALPRDESC,"&nbsp;</td>":
                             "<td>",DOCFNAME,"&nbsp;</td>":
                             "<td>",DOCFNAM2,"&nbsp;</td>":           *I-226078
                             "<td>",ALSTDESC,"&nbsp;</td>";
.                                                                     *I-205366
ULNKR600  IF        PTCNHDPS=1
            MATCH     "1",ALREUYN4            * check if this is a primary
            IF      @EQUAL
              MOVE    ONE,LINKFLAG
            ENDIF
          ENDIF                                                 * end *I-205366
.
.                                             * check if already linked
ULNKR700  PACK      KEY16,ALREVISN,SP20                       * start *I-226078
          CALL      RSALRLN2
          CALL      RKALRLN2
          IF        OVRCD<>1
            MATCH     ALREVISN,ALRLLNKV       * is this already linked?
            IF        @EQUAL
              MOVE      ONE,LINKFLAG          * if so, do not allow a new Link
            ENDIF                                               * end *I-226078
          ENDIF
.
          IF        LINKFLAG=0
            WRITE     HTMLFILE;"<td><input type=checkbox name=linkvist ":
                               "value=#"",ALREVISN,"#">&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      ULNKR100
.
ULNKR999  RETURN
.
.-----------------------------------------------------------------------------.
.     Table of linked patient referrals
.-----------------------------------------------------------------------------.
LINKR000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,COUNTER
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
LINKR100  CALL      RKALRLN1
          BRANCH    OVRCD,LINKR999
.
          MATCH     ALRLVISN,ADMISSNO
          GOTO      LINKR999 IF NOT EQUAL
.
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LINKR100
.
          MATCH     ALREURNO,URNUMBER
          GOTO      LINKR999 IF NOT EQUAL
.
          MATCH     "1",ALREUYN4            * Skip SACS master referrals
          GOTO      LINKR100 IF EQUAL
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,LINKR100
.
          MATCH     "0",ALDESECU
          GOTO      LINKR170 IF EQUAL
.
          MATCH     "1",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      LINKR170 IF EQUAL
          ENDIF
.
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALREDEPT
            GOTO      LINKR170 IF EQUAL
          ENDIF
          GOTO      LINKR100
.
LINKR170  MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,DEPDESC
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,ALENSDAT
          PACK      KEY16,ALREVISN,Z70
          CALL      RSALENC1
          CALL      RPALENC1
          BRANCH    OVRCD,LINKR171
          MATCH     ALREVISN,ALENVISN
          GOTO      LINKR171 IF EQUAL
          MOVE      SP70,ALENSDAT
.
LINKR171  MOVE      SP70,DISPPROV                * Clear provider number
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                     * To get Problem Description
          IF        OVRCD=1
            CALL      CLALPR00
          ENDIF
.
          UNPACK    SP70,DOCFNAME                * clear HCP Names    *I-226078
          UNPACK    SP70,DOCFNAM2
          PACK      KEY10,ALREHCP,SP70           * get Responsible HCP name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,DOCFNAM2
          ENDIF                                                 * end *I-226078
.
          MOVE      SP70,DOCFNAME                * Clear HCP Name
          PACK      KEY10,ALRERHCP,SP70          * To get Referring HCP name
          CALL      RDPMHCP1                     * !! datefile not exists
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
.
            MATCH     SP70,PMHCPRV1
            IF        @EQUAL
              MOVE      SP70,DISPPROV
            ELSE
              PACK      DISPPROV,LBRACK,PMHCPRV1,RBRACK
            ENDIF
          ENDIF
.
          PACK      KEY20,ALRERHCP,ALRERHCR,SP70
          CALL      RDPMHCL1
          IF        OVRCD=0
            MATCH     SP70,PMHLPRV1
            IF        !@EQUAL
              PACK      DISPPROV,LBRACK,PMHLPRV1,RBRACK
            ENDIF
          ENDIF
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE                * To get Priority Description
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE                * To get Compensation Desc
          CALL      GETCOD00
          MOVE      TDESC,COMPDESC
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      LINKR180 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,LINKR180
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      LINKR180
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
LINKR180  CALL      SETX0000                * Set Expiry Icon
.
          MOVE      DUBOOKED,BOOKSTAT
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
LINKR185  CALL      RKALLNK1
          BRANCH    OVRCD,LINKR190
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      LINKR190 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      LINKR185 IF EQUAL
.
          MOVE      DBOOKED,BOOKSTAT
.
LINKR190  ADD       ONE,COUNTER
          IF        COUNTER>400
             WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=6 align=center>":
                                 "<b>Table exceeds 400 records. Records":
                                 "beyond 400 will not be displayed</td>"
             GOTO    LINKR999
          ENDIF
.
          MOVE      SP70,DISPDAT1                * Referral Date
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",DEPDESC,"&nbsp;</td>":
                             "<td>",ALPRDESC,"&nbsp;</td>":
                             "<td>",DOCFNAME,"&nbsp;</td>":
                             "<td>",DOCFNAM2,"&nbsp;</td>":           *I-226078
                             "<td>",ALSTDESC,"&nbsp;</td>":
                             "<td><input type=checkbox name=unlkvist ":
                             "value=#"",ALREVISN,"#">&nbsp;</td></tr>"
.
          GOTO      LINKR100
.
LINKR999  RETURN
.
.------------------------------------------------------------
. Unlink referral from a SACS referral
.------------------------------------------------------------
USAC0000  MOVE      ONE,F3
USAC1000  IF        F3<=UNLKEND
            MATCH     UNLKVIST[F3],SP70
            IF        !@EQUAL
              PACK      KEY16,ADMISSNO,UNLKVIST[F3],SP70
              CALL      RDALRLN1
              IF        OVRCD=0
                CALL      DEALRLN1
              ENDIF
.
              IF        PTCNHDPS=3
                PACK      KEY8,UNLKVIST[F3],SP70 * If VIC write delete
                CALL      RDALREF1               * allaudre record for VINAH
                IF        OVRCD<>1
                  MOVE      FOUR,AUDTTYPE        * delete history record
                  CALL      WAALRE00
                ENDIF
              ENDIF
.
            ENDIF
            ADD       ONE,F3
            GOTO      USAC1000
          ENDIF
.
          MOVE      ZERO,EXIT
.
USAC9999  RETURN
.
.------------------------------------------------------------
. Link referral to a SACS referral
.------------------------------------------------------------
LSAC0000  MOVE      ONE,F3
LSAC1000  IF        F3<=LINKEND
            MATCH     LINKVIST[F3],SP70
            IF        !@EQUAL
.
              MOVE      ADMISSNO,ALRLVISN
              MOVE      LINKVIST[F3],ALRLLNKV
              PACK      ALRLCDAT,CCC,CYY,CMM,CDD
              REP       " 0",ALRLCDAT
              CLOCK     TIME,ALRLCTIM
              MOVE      USERID,ALRLCUID
              MOVE      SP70,ALRLSPAR
.
              PACK      KEY16,ALRLVISN,ALRLLNKV,SP70
              CALL      RDALRLN1
              IF        OVRCD=1
                CALL      WRALRLN1
.
                MOVE      ALRLLNKV,CHECKREF
                CALL      AMAS0000              * Auto activate master referral
              ENDIF
            ENDIF
            ADD       ONE,F3
            GOTO      LSAC1000
          ENDIF
.
          MOVE      ZERO,EXIT
.
LSAC9999  RETURN
.
.-----------------------------------------------------------------------------.
.   Rejected Referral Tables %ALLWEB02.01.029
.                   REJECTED REFERRAL DETAILS                               .
.-----------------------------------------------------------------------------.
REJT0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY30,DEPTCODE,FIVE,FRSTDATE,SP70
          CALL      RSALREF6                * positional read
REJT0010  CALL      RKALREF6                * read a record forward
          BRANCH    OVRCD,REJT9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT
          GOTO      REJT9999 IF NOT EQUAL
.
          MATCH     "5",ALRESTAT            * Don't disp if status is not "5"
          GOTO      REJT9999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      REJT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      REJT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              MATCH     DOCTCODE,ALREHCP
              GOTO      REJT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC2
              GOTO      REJT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      REJT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      REJT0015 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      REJT0015 IF EQUAL
              GOTO      REJT0010
            ELSE
              MATCH     DOCTCODE,ALREHCP
              GOTO      REJT0010 IF NOT EQUAL * HCP does not match don't disp
            ENDIF
          ENDIF
.
REJT0015  MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      REJT0010 IF NOT EQUAL * clinic type does not match
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      REJT0010 IF NOT EQUAL * clinic id does not match
            ENDIF
          ENDIF
.
          MATCH     FRSTDATE,ALRERDAT       * Checks firstdate with ref date
          GOTO      REJT0010 IF LESS
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with ref date
          GOTO      REJT0010 IF LESS
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      REJT0010
          ENDIF
.
          CALL      REJDIS00                * Display Row
          ADD       ONE,DISNUMB
REJT0020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      REJT0010 IF NOT EQUAL
          ELSE
            GOTO      REJT0010
          ENDIF
.
REJT9999  RETURN
.
.-------------------------------------------------------------------
.   Rejected Referral table By HCP
.-------------------------------------------------------------------
REJTH000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY27,DOCTCODE,FIVE,FRSTDATE,SP70
          CALL      RSALREF5                * positional read
REJTH010  CALL      RKALREF5               * read a record forward
          BRANCH    OVRCD,REJTH999
.
          CALL      INDHCP00
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            MATCH     DOCTCODE,ALREHCP
            GOTO      REJTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC2
            GOTO      REJTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC3
            GOTO      REJTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC5
            GOTO      REJTH015 IF EQUAL
            MATCH     DOCTCODE,ALREUHC6
            GOTO      REJTH015 IF EQUAL
            GOTO      REJTH999
          ELSE
            MATCH     DOCTCODE,ALREHCP
            GOTO      REJTH999 IF NOT EQUAL
          ENDIF
.
REJTH015  MATCH     DEPTCODE,ALREDEPT
          GOTO      REJTH999 IF NOT EQUAL
.
          MATCH     "5",ALRESTAT            * Don't disp if status is not "5"
          GOTO      REJTH999 IF NOT EQUAL
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN               * Hospital Filter
            GOTO      REJTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT               * Preferred Site Filter
            GOTO      REJTH010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      REJTH010 IF NOT EQUAL * clinic type does not match
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      REJTH010 IF NOT EQUAL * clinic id does not match
            ENDIF
          ENDIF
.
          MATCH     FRSTDATE,ALRERDAT       * Checks firstdate with ref date
          GOTO      REJTH010 IF LESS
          MATCH     ALRERDAT,LASTDATE       * Checks lastdate with ref date
          GOTO      REJTH010 IF LESS
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      REJTH010
          ENDIF
.
          CALL      REJDIS00                * Display Row
          ADD       ONE,DISNUMB
REJTH020  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      REJTH010 IF NOT EQUAL
          ELSE
            GOTO      REJTH010
          ENDIF

.
REJTH999  RETURN
.
.-----------------------------------------------------------------------------.
.       Write cancelled referral
.******************************************************************************
REJDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALRESRDT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted date cancelled
          ENDIF
.
          MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT3
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT3       * formatted date cancelled
          ENDIF
.
          MOVE      "rr",CATEGORY
          MOVE      ALRESREJ,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00                * last encounter date
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      SP70,PREFSITE
          MATCH     SP70,ALREPSIT           * Preferred site
          IF        !@EQUAL
            PACK      KEY6,ALREPSIT,SP70
            CALL      RDSITA1
            IF        OVRCD=0
              MOVE      OSTDESC,PREFSITE
            ENDIF
          ENDIF
.
          MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,REJDIS10,REJDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",":                   6
                             "#"",TDESC,"#",":                     7
                             "#"",TEMPDAT3,"#",":                  8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *11
                             "#"",ALREUFR1,"#",":                 *12    C289338
                             "#"",ALREPRCM,"#"":                  *13
                             ");"
          ENDIF
          GOTO      REJDIS99
.
REJDIS10  MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon > ":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    SP1,HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",":                   6
                             "#"",TDESC,"#",":                     7
                             "#"",TEMPDAT3,"#",":                  8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *11
                             "#"",ALREUFR1,"#",":                 *12    C289338
                             "#"",ALREPRCM,"#"":                  *13
                             ");"
          ENDIF
.
          GOTO      REJDIS99
.
REJDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,CANREF99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",ALREURNO,"#",":                  2
                             "#"",TEMPDAT1,"#",":                  3
                             "#"",TEMPDAT2,"#",":                  4
                             "#"",LSTENDAT,"#",":                  5
                             "#"",PROBLEM,"#",":                   6
                             "#"",TDESC,"#",":                     7
                             "#"",TEMPDAT3,"#",":                  8
                             "#"",ALREPSIT,"#",":                  9
                             "#"",PREFSITE,"#",":                  10
                             "#"",FOLDERSF,"#",":                 *11
                             "#"",ALREUFR1,"#",":                 *12    C289338
                             "#"",ALREPRCM,"#"":                  *13
                             ");"
            ENDIF
.
          ENDIF
          GOTO      REJDIS99
.
REJDIS99  RETURN
.
.******************************************************************************
.         Display SACS referral row
.******************************************************************************
SACDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      ALREDREC,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT3
          ELSE
            CALL      ALLDAT00                * Fromat the Date
          MOVE      FBOKDATE,TEMPDAT3         * formatted Referral Date Received
          ENDIF
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE    SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00
.
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,SACDIS10,SACDIS20
.
          PACK      KEY17,STATCODE,ALRERDAT,ALREVISN        * save key
          CALL      GETACR00                * get any active referrals
          CALL      RDALREF3                * re-read record with index 3
.
          WRITE     HTMLFILE;"<tr><td nowrap>":
                           "<img src=../images/PatientFolder",FOLDERSF,".gif":
                           " class=ListIcon ":
                           " onclick='UpdateReferral(#"":
                           ALREURNO,"#",#"":
                           ALREVISN,"#",#"":
                           DEPTCODE,"#");'>":
                           FORMATNM,"</td>":
                           "<td>&nbsp;",PSEX,"</td>":
                           "<td>&nbsp;",ALREURNO,"</td>":
                           "<td>&nbsp;",TEMPDAT1,"</td>":
                           "<td>&nbsp;",TEMPDAT2,"</td>":
                           "<td>&nbsp;",TEMPDAT3,"</td>":
                           "<td>&nbsp;",LSTENDAT,"</td>":
                           "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            IF        OTHAREFS = 1
              WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                                 " class=ListIcon ":
                                 " onclick='ListReferral(#"":
                                 ALREURNO,"#");'>":
                                 "</td></tr>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "</tr>"
            ENDIF
          GOTO      SACDIS99
.
SACDIS10  PACK      KEY10,USERID,SP70       * If Department Security is 1
          CALL      RDWBSE1
          BRANCH    OVRCD,SACDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                           "<img src=../images/PatientFolder",FOLDERSF,".gif":
                           " class=ListIcon ":
                           " onclick='UpdateReferral(#"":
                           ALREURNO,"#",#"":
                           ALREVISN,"#",#"":
                           DEPTCODE,"#");'>":
                           FORMATNM,"</td>":
                           "<td>&nbsp;",PSEX,"</td>":
                           "<td>&nbsp;",ALREURNO,"</td>":
                           "<td>&nbsp;",TEMPDAT1,"</td>":
                           "<td>&nbsp;",TEMPDAT2,"</td>":
                           "<td>&nbsp;",TEMPDAT3,"</td>":
                           "<td>&nbsp;",LSTENDAT,"</td>":
                           "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            IF        OTHAREFS = 1
              WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                                 " class=ListIcon ":
                                 " onclick='ListReferral(#"":
                                 ALREURNO,"#");'>":
                                 "</td></tr>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "</tr>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon >":
                             FORMATNM,"</td>":
                             "<td>&nbsp;",PSEX,"</td>":
                             "<td>&nbsp;",ALREURNO,"</td>":
                             "<td>&nbsp;",TEMPDAT1,"</td>":
                             "<td>&nbsp;",TEMPDAT2,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>":
                             "<td>&nbsp;",LSTENDAT,"</td>":
                             "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            IF        OTHAREFS = 1
              WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                                 " class=ListIcon ":
                                 " onclick='ListReferral(#"":
                                 ALREURNO,"#");'>":
                                 "</td></tr>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "</tr>"
            ENDIF
          ENDIF
          GOTO      SACDIS99
.
SACDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,SACDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                           "<img src=../images/PatientFolder",FOLDERSF,".gif":
                           " class=ListIcon ":
                           " onclick='UpdateReferral(#"":
                           ALREURNO,"#",#"":
                           ALREVISN,"#",#"":
                           DEPTCODE,"#");'>":
                           FORMATNM,"</td>":
                           "<td>&nbsp;",PSEX,"</td>":
                           "<td>&nbsp;",ALREURNO,"</td>":
                           "<td>&nbsp;",TEMPDAT1,"</td>":
                           "<td>&nbsp;",TEMPDAT2,"</td>":
                           "<td>&nbsp;",TEMPDAT3,"</td>":
                           "<td>&nbsp;",LSTENDAT,"</td>":
                           "<td>&nbsp;",PROBLEM,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            IF        OTHAREFS = 1
              WRITE     HTMLFILE;"<td><img src=../images/ViewIcon1.gif":
                                 " class=ListIcon ":
                                 " onclick='ListReferral(#"":
                                 ALREURNO,"#");'>":
                                 "</td></tr>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "</tr>"
            ENDIF
          ENDIF
.
SACDIS99  RETURN
+
.******************************************************************************
.           Get Any Active Referral for a U/R
.******************************************************************************
GETACR00  MOVE      ZERO,OTHAREFS
          MOVE      ALREURNO,KEY8
.         
          PACK      KEY16,ALREURNO,SP70
          CALL      RSALREF2                * positional read
GETACR10  CALL      RKALREF2                * read a record forward
          BRANCH    OVRCD,GETACR99
.
          MATCH     ALREURNO,KEY8
          GOTO      GETACR99 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT
          GOTO      GETACR10 IF NOT EQUAL
.
          MOVE      ONE,OTHAREFS            * active referral found
.
GETACR99  RETURN
.
.-------------------------------------------------------------------
.   Case review date referral list - %ALLWEB02.01.032
.
.   THIS IS NOT A GOOD KEY FOR THIS TABLE. WE MAY NEED A NEW ONE
.-------------------------------------------------------------------
REVT0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          MATCH     SP70,STATCODE
          IF        @EQUAL
            MOVE      ONE,STATCODE          * Default active
          ENDIF
          MATCH     SP70,STATCODE           * Exit if status filter blank
          GOTO      REVT9999 IF EQUAL
.
          MATCH     "7",STATCODE
          IF        @EQUAL
            MOVE      "0",FILTSTAT
            GOTO    REVT0009
          ENDIF
.
          MATCH     "8",STATCODE
          IF        @EQUAL
            MOVE      "2",FILTSTAT
            GOTO    REVT0009
          ENDIF
.
          MATCH     "9",STATCODE
          IF        @EQUAL
            MOVE      "3",FILTSTAT
            GOTO    REVT0009
          ENDIF
.
          MOVE      STATCODE,FILTSTAT
.
REVT0009  PACK      KEY30,DEPTCODE,FILTSTAT,SP70
          CALL      RSALREF6                * positional read
REVT0010  CALL      RKALREF6                * read a record forward
          BRANCH    OVRCD,REVT9999
.
          MATCH     DEPTCODE,ALREDEPT       * Check correct department
          GOTO      REVT9999 IF NOT EQUAL
.
          MATCH     "7",STATCODE                      * Waiting & Active
          IF        @EQUAL
            MATCH     "0",ALRESTAT
            GOTO      REVT0020 IF EQUAL
            MATCH     "1",ALRESTAT
            GOTO      REVT0020 IF EQUAL
            GOTO      REVT9999
          ENDIF
.
          MATCH     "8",STATCODE                      * Closed & Rejected
          IF        @EQUAL
            MATCH     "2",ALRESTAT
            GOTO      REVT0020 IF EQUAL
            MATCH     "5",ALRESTAT
            IF        @LESS
              MOVE      "5",FILTSTAT
              GOTO      REVT0009
            ENDIF
            MATCH     "5",ALRESTAT
            GOTO      REVT0020 IF EQUAL
            GOTO      REVT9999
          ENDIF
.
          MATCH     "9",STATCODE                      * Inactive & Cancelled
          IF        @EQUAL
            MATCH     "3",ALRESTAT
            GOTO      REVT0020 IF EQUAL
            MATCH     "4",ALRESTAT
            GOTO      REVT0020 IF EQUAL
            GOTO      REVT9999
          ENDIF
.
          MATCH     STATCODE,ALRESTAT       * Check correct status
          GOTO      REVT9999 IF NOT EQUAL
.
REVT0020  MATCH     SP70,ALREREVD           * Skip if case review date blank
          GOTO      REVT0010 IF EQUAL
.
          MATCH     ALREREVD,LASTDATE       * Checks lastdate with case review
          GOTO      REVT0010 IF LESS        * date
.
          MATCH     FRSTDATE,ALREREVD       * Checks firstate with case review
          GOTO      REVT0010 IF LESS        * date
.
          MATCH     SP70,DOCTCODE           * Check correct HCP
          IF        !@EQUAL
            MATCH     DOCTCODE,ALRERHCP
            GOTO      REVT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTEAM           * Check correct team
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      REVT0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTRGS
          IF        !@EQUAL
            MATCH     FILTTRGS,ALRETRGS
            GOTO      REVT0010 IF NOT EQUAL * Triage status filter
          ENDIF
.
          MATCH     SP70,PRIORITY
          IF        !@EQUAL
            MATCH     PRIORITY,ALREPRTY
            GOTO      REVT0010 IF NOT EQUAL * priority does not match don't disp
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      REVT0010 IF NOT EQUAL * clinic id filter
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      REVT0010 IF NOT EQUAL * clinic type filter
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      REVT0010
          ENDIF
.
          CALL      REVDIS00                * Display Row
.
          ADD       ONE,DISNUMB
REVT0060  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      REVT0010 IF NOT EQUAL
          ELSE
            GOTO      REVT0010
          ENDIF
.
REVT9999  RETURN
.
.******************************************************************************
.           Write case review referral
.******************************************************************************
REVDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          MOVE      ZERO,DISPOVRD
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     CURRDATE,ALREREVD
          IF        @LESS
            DAYSEP    ALREREVD,CURRDATE,F8
            IF        F8>SEVEN
              MOVE      SP70,DISPOVRD
              APPEND    "<font color=red>",DISPOVRD
              APPEND    F8,DISPOVRD
              APPEND    "</font>",DISPOVRD
              RESET     DISPOVRD
            ELSE 
              MOVE      F8,DISPOVRD
            ENDIF
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      ALREREVD,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT3
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT3       * formatted Must Be Seen By Date
          ENDIF
.
          MOVE      "ts",CATEGORY
          MOVE      ALRETRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          PACK      KEY10,ALRERHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE    SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      REVDIS05 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,REVDIS05
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      REVDIS05
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
REVDIS05  MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,REVDIS10,REVDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             ALSTDESC,"</td>":
                             "<td>&nbsp;",FORMATNM,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>":
                             "<td>&nbsp;",DOCFNAME,"</td>";
.
            MATCH     "1",ALCNDTRG
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
            ENDIF                                                 * status
.
            WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                             "<td>&nbsp;",DISPOVRD,"</td>":
                             "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",":                   7
                             "#"",DOCFNAME,"#",":                  8
                             "#"",OCADESC,"#",":                   9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",TRGSDESC,"#");"                 *18
          ENDIF
          GOTO      REVDIS99
.
.... C-37051
REVDIS10  PACK      KEY10,USERID,SP70       * If Department Security is 1
          CALL      RDWBSE1
          BRANCH    OVRCD,REVDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             ALSTDESC,"</td>":
                             "<td>&nbsp;",FORMATNM,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>":
                             "<td>&nbsp;",DOCFNAME,"</td>";
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                             "<td>&nbsp;",DISPOVRD,"</td>":
                             "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT3,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",":                   7
                             "#"",DOCFNAME,"#",":                  8
                             "#"",OCADESC,"#",":                   9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",TRGSDESC,"#");"                 *18
            ENDIF
          ELSE
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/EditIcon.gif":
                               " class=ListIcon >":
                               ALSTDESC,"</td>":
                               "<td>&nbsp;",FORMATNM,"</td>":
                               "<td>&nbsp;",TEMPDAT3,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>";
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                               "<td>&nbsp;",DISPOVRD,"</td>":
                               "</tr>"
            ELSE
              MOVE      SP70,HTMLLINK
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT3,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",":                   7
                             "#"",DOCFNAME,"#",":                  8
                             "#"",OCADESC,"#",":                   9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",TRGSDESC,"#");"                 *18
            ENDIF
          ENDIF
          GOTO      REVDIS99
.
REVDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,REVDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             ALSTDESC,"</td>":
                             "<td>&nbsp;",FORMATNM,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>":
                             "<td>&nbsp;",DOCFNAME,"</td>";
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                             "<td>&nbsp;",DISPOVRD,"</td>":
                             "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",":                   7
                             "#"",DOCFNAME,"#",":                  8
                             "#"",OCADESC,"#",":                   9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",TRGSDESC,"#");"                 *18
            ENDIF
          ENDIF
.
REVDIS99  RETURN
.
.-------------------------------------------------------------------
.   Next review date referral list - %ALLWEB02.01.033
.
.-------------------------------------------------------------------
NREV0000  UNPACK    DIM127,D1,SORTFLAG,DIM127   * Flag to sort
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          MATCH     SP70,STATCODE
          IF        @EQUAL
            MOVE      ONE,STATCODE          * Default active
          ENDIF
.
          MATCH     SP70,STATCODE           * Exit if status filter blank
          GOTO      NREV9999 IF EQUAL
.
          MATCH     "7",STATCODE
          IF        @EQUAL
            MOVE      "0",FILTSTAT
            GOTO    NREV0009
          ENDIF 
.
          MATCH     "8",STATCODE
          IF        @EQUAL
            MOVE      "2",FILTSTAT
            GOTO    NREV0009
          ENDIF
.
          MATCH     "9",STATCODE
          IF        @EQUAL
            MOVE      "3",FILTSTAT
            GOTO    NREV0009
          ENDIF
.
          MOVE      STATCODE,FILTSTAT
.
NREV0009  PACK      KEY30,DEPTCODE,FILTSTAT,SP70
          CALL      RSALREF6                * positional read
NREV0010  CALL      RKALREF6                * read a record forward
          BRANCH    OVRCD,NREV9999
.
          CALL      INDHCP00
.
          MATCH     DEPTCODE,ALREDEPT       * Check correct department
          GOTO      NREV9999 IF NOT EQUAL
.
          MATCH     "7",STATCODE                      * Waiting & Active
          IF        @EQUAL
            MATCH     "0",ALRESTAT
            GOTO      NREV0020 IF EQUAL
            MATCH     "1",ALRESTAT
            GOTO      NREV0020 IF EQUAL
            GOTO      NREV9999
          ENDIF
.
          MATCH     "8",STATCODE                      * Closed & Rejected
          IF        @EQUAL
            MATCH     "2",ALRESTAT
            GOTO      NREV0020 IF EQUAL
            MATCH     "5",ALRESTAT
            IF        @LESS
              MOVE      "5",FILTSTAT
              GOTO      NREV0009
            ENDIF
            MATCH     "5",ALRESTAT
            GOTO      NREV0020 IF EQUAL
            GOTO      NREV9999
          ENDIF
.
          MATCH     "9",STATCODE                      * Inactive & Cancelled
          IF        @EQUAL
            MATCH     "3",ALRESTAT
            GOTO      NREV0020 IF EQUAL
            MATCH     "4",ALRESTAT
            GOTO      NREV0020 IF EQUAL
            GOTO      NREV9999
          ENDIF
.
          MATCH     STATCODE,ALRESTAT       * Check correct status
          GOTO      NREV9999 IF NOT EQUAL
.
NREV0020  MATCH     SP70,ALREDREV           * Skip if next review date blank
          GOTO      NREV0010 IF EQUAL
.
          MATCH     ALREDREV,LASTDATE       * Checks lastdate with next review
          GOTO      NREV0010 IF LESS        * date
.
          MATCH     FRSTDATE,ALREDREV       * Checks firstate with next review
          GOTO      NREV0010 IF LESS        * date
.
          MATCH     SP70,DOCTCODE           * Check correct HCP
          IF        !@EQUAL
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              IF        PTCNHDPS = 1
                MATCH     DOCTCODE,ALREHCP
                GOTO      NREV0025 IF EQUAL
              ELSE
                MATCH     DOCTCODE,ALRERHCP
                GOTO      NREV0025 IF EQUAL
              ENDIF
              MATCH     DOCTCODE,ALREUHC2
              GOTO      NREV0025 IF EQUAL
              MATCH     DOCTCODE,ALREUHC3
              GOTO      NREV0025 IF EQUAL
              MATCH     DOCTCODE,ALREUHC5
              GOTO      NREV0025 IF EQUAL
              MATCH     DOCTCODE,ALREUHC6
              GOTO      NREV0025 IF EQUAL
              GOTO      NREV0010
            ELSE
              IF        PTCNHDPS = 1
                MATCH     DOCTCODE,ALREHCP    * Responsible HCP (NZ)
                GOTO      NREV0010 IF NOT EQUAL
              ELSE
                MATCH     DOCTCODE,ALRERHCP     * Referring HCP
                GOTO      NREV0010 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
NREV0025  MATCH     SP70,FILTTEAM           * Check correct team
          IF        !@EQUAL
            MATCH     FILTTEAM,ALREUHC4
            GOTO      NREV0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTTRGS
          IF        !@EQUAL
            MATCH     FILTTRGS,ALRETRGS
            GOTO      NREV0010 IF NOT EQUAL * Triage status filter
          ENDIF
.
          MATCH     SP70,PRIORITY
          IF        !@EQUAL
            MATCH     PRIORITY,ALREPRTY
            GOTO      NREV0010 IF NOT EQUAL * priority does not match don't disp
          ENDIF
.
          MATCH     SP70,FILTCLID
          IF        !@EQUAL
            MATCH     "zzzzzz",FILTCLID
            IF        !@EQUAL
              MATCH     FILTCLID,ALRECLID
              GOTO      NREV0010 IF NOT EQUAL * clinic id filter
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,ALRECTYP
            GOTO      NREV0010 IF NOT EQUAL * clinic type filter
          ENDIF
.
.------------------------------------------------------------- *T0872044-start
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,ALREHOSN        * Hospital Filter matched?
            GOTO      NREV0010 IF NOT EQUAL    * No, read next referral
          ENDIF
.
          MATCH     SP70,FILTPSIT
          IF        !@EQUAL
            MATCH     FILTPSIT,ALREPSIT        * Preferred Site Filter
            GOTO      NREV0010 IF NOT EQUAL
          ENDIF
.------------------------------------------------------------- *T0872044-end
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      NREV0010
          ENDIF
.
          CALL      NRVDIS00                * Display Row
.
          ADD       ONE,DISNUMB
NREV0060  MATCH     "1",SORTFLAG
          IF        !@EQUAL
            COMPARE   NORECORD,DISNUMB
            GOTO      NREV0010 IF NOT EQUAL
          ELSE
            GOTO      NREV0010
          ENDIF
.
NREV9999  RETURN
.
.******************************************************************************
.           Write next review referral
.******************************************************************************
NRVDIS00  PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1                 * Read the master file for details
          IF        OVRCD=1
            CALL      CLPATMAS
            CLEAR     PSNAME
            APPEND    "Invalid U/R -",PSNAME
            APPEND    KEY8,PSNAME
            RESET     PSNAME
            PACK      PTMASNAM,PSNAME,SP70
          ENDIF
.
          MOVE      ZERO,DISPOVRD
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     CURRDATE,ALREDREV
          IF        @LESS
            DAYSEP    ALREDREV,CURRDATE,F8                            *C-223963
            IF        F8 > SEVEN
              MOVE      SP70,DISPOVRD
              APPEND    "<font color=red>",DISPOVRD
              APPEND    F8,DISPOVRD
              APPEND    "</font>",DISPOVRD
              RESET     DISPOVRD
            ELSE
              MOVE      F8,DISPOVRD
            ENDIF
          ENDIF
.
          PACK      KEY8,ALREURNO,SP70      * GET URNO
          CALL      RDPMPX21                * Get Master file 2nd extension
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FOLDERSF           * Save returned value
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
.
          MOVE      PBDATE,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT1
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT1       * formatted DOB
          ENDIF
.
          MOVE      ALRERDAT,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT2
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT2       * formatted Referral Date
          ENDIF
.
          MOVE      ALREDREV,PRTPDATE
          MATCH     "1",SORTFLAG                       * sort ?
          IF        @EQUAL
            MOVE      PRTPDATE,TEMPDAT3
          ELSE
            CALL      ALLDAT00                * Fromat the Date
            MOVE      FBOKDATE,TEMPDAT3       * formatted Must Be Seen By Date
          ENDIF
.
          MOVE      "ts",CATEGORY
          MOVE      ALRETRGS,CODE
          CALL      GETCOD00
          MOVE      TDESC,TRGSDESC
.
          MOVE      "PR",CATEGORY
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
.
          PACK      CRRDATE,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CRRDATE
          DAYSEP    CRRDATE,ALRECDAT,F2
.
          CALL      ADDHCP00
.
          IF        PTCNHDPS=1
            PACK      KEY10,ALREHCP,SP70
          ELSE
            PACK      KEY10,ALRERHCP,SP70
          ENDIF
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE    SP70,DOCFNAME
          ENDIF
.
          CALL      GTLENC00
.
          MOVE      SP70,PROBLEM
          PACK      KEY12,ALREDEPT,ALREPRO1,SP70
          CALL      RDALPRR1                * Read the allprraf table
          IF        OVRCD=0
            MOVE      ALPRDESC,PROBLEM
          ENDIF
.
          PACK      ALCADESC,ALREUHC4,SP70       * default Description
          MATCH     SP70,ALREUHC4
          IF        !@EQUAL
            PACK      KEY10,ALREUHC4,SP70
            CALL      RDALCAS1
          ENDIF
.
          MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MOVE      SP70,OCADESC
          MOVE      SP70,OCTDESC
.
          MATCH     SP70,ALREPSIT                * Not preferred site
          GOTO      NRVDIS05 IF EQUAL
.
          CALL      COTFIL00                     * Check outpatient file prefix
.
          PACK      KEY12,ALREPSIT,ALRECTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,ALREPSIT,ALRECLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,NRVDIS05
.
          MATCH     ALREPSIT,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      NRVDIS05
          ENDIF
.
          MATCH     ALRECLID,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
          ENDIF
.
NRVDIS05  MOVE      ZERO,F1
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          MOVE      ALDESECU,F1
          BRANCH    F1,NRVDIS10,NRVDIS20
.
          MATCH     "1",SORTFLAG                       * sort ?
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             ALSTDESC,"</td>":
                             "<td>&nbsp;",FORMATNM,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCP00
.             WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            IF        PTCNHDPS=1
              WRITE     HTMLFILE;"<td>&nbsp;",ALCADESC,"</td>";
            ENDIF
.
            MATCH     "1",ALCNDTRG
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
            ENDIF                                                 * status
.
            WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                               "<td>&nbsp;",DISPOVRD,"</td>":
                               "</tr>"
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:UpdateReferral('",HTMLLINK
            APPEND    ALREURNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ALREVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    DEPTCODE,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              CALL      DISHCS00
.              WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
            ELSE
              WRITE     HTMLFILE;"#"",DOCFNAME,"#",";              8
            ENDIF
.
            WRITE     HTMLFILE;"#"",OCADESC,"#",":                 9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",ALREDREV,"#",":                 *18
                             "#"",ALCADESC,"#",":                 *19
                             "#"",TRGSDESC,"#");"                 *20
          ENDIF
          GOTO      NRVDIS99
.
.... C-37051
NRVDIS10  PACK      KEY10,USERID,SP70       * If Department Security is 1
          CALL      RDWBSE1
          BRANCH    OVRCD,NRVDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             ALSTDESC,"</td>":
                             "<td>&nbsp;",FORMATNM,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.               WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              IF        PTCNHDPS=1
                WRITE     HTMLFILE;"<td>&nbsp;",ALCADESC,"</td>";
              ENDIF
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                                 "<td>&nbsp;",DISPOVRD,"</td>":
                                 "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT3,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.               WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            8
              ENDIF
.
              WRITE     HTMLFILE;"#"",OCADESC,"#",":               9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",ALREDREV,"#",":                 *18
                             "#"",ALREUHC4,"#",":                 *19
                             "#"",TRGSDESC,"#");"                 *20
            ENDIF
          ELSE
            MATCH     "1",SORTFLAG           * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                               "<img src=../images/EditIcon.gif":
                               " class=ListIcon >":
                               ALSTDESC,"</td>":
                               "<td>&nbsp;",FORMATNM,"</td>":
                               "<td>&nbsp;",TEMPDAT3,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.               WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              IF        PTCNHDPS=1
                WRITE     HTMLFILE;"<td>&nbsp;",ALCADESC,"</td>";
              ENDIF
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                                 "<td>&nbsp;",DISPOVRD,"</td>":
                                 "</tr>"
            ELSE
              MOVE      SP70,HTMLLINK
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT3,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCS00
.               WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            8
              ENDIF
.
              WRITE     HTMLFILE;"#"",OCADESC,"#",":               9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",ALREDREV,"#",":                 *18
                             "#"",ALREUHC4,"#",":                 *19
                             "#"",TRGSDESC,"#");"                 *20
            ENDIF
          ENDIF
          GOTO      NRVDIS99
.
NRVDIS20  PACK      KEY10,USERID,SP70       * If Department Security is 2
          CALL      RDWBSE1
          BRANCH    OVRCD,NRVDIS99
          MATCH     WBSEDALL,ALREDEPT
          IF        @EQUAL
            MATCH     "1",SORTFLAG                       * sort ?
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='UpdateReferral(#"":
                             ALREURNO,"#",#"":
                             ALREVISN,"#",#"":
                             DEPTCODE,"#");'>":
                             ALSTDESC,"</td>":
                             "<td>&nbsp;",FORMATNM,"</td>":
                             "<td>&nbsp;",TEMPDAT3,"</td>";
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                CALL      DISHCP00
.               WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
              ENDIF
.
              IF        PTCNHDPS=1
                WRITE     HTMLFILE;"<td>&nbsp;",ALCADESC,"</td>";
              ENDIF
.
              MATCH     "1",ALCNDTRG
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;",TRGSDESC,"</td>";   * Triage
              ENDIF                                                 * status
.
              WRITE     HTMLFILE;"<td>&nbsp;",ALREPRTY,"</td>":
                                 "<td>&nbsp;",DISPOVRD,"</td>":
                                 "</tr>"
            ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:UpdateReferral('",HTMLLINK
              APPEND    ALREURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    ALREVISN,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    DEPTCODE,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":                  1
                             "#"",PSEX,"#",":                      2
                             "#"",ALREURNO,"#",":                  3
                             "#"",TEMPDAT1,"#",":                  4
                             "#"",TEMPDAT2,"#",":                  5
                             "#"",LSTENDAT,"#",":                  6
                             "#"",PROBLEM,"#",";                   7
.
              MATCH     "1",DOCINDIC
              IF        @EQUAL
                 CALL      DISHCS00
.                WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
              ELSE
                WRITE     HTMLFILE;"#"",DOCFNAME,"#",";            8
              ENDIF
.
              WRITE     HTMLFILE;"#"",OCADESC,"#",":               9
                             "#"",OCTDESC,"#",":                   10
                             "#"",ALREPRTY,"#",":                  11
                             "#"",ALSTDESC,"#",":                  12
                             "#"",ALREREVD,"#",":                  13
                             "#"",ALREPRCM,"#",":                  14
                             "#"",OCTDESC,"#",":                   15
                             "#"",OCADESC,"#",":                   16
                             "#"",DISPOVRD,"#",":                 *17
                             "#"",ALREDREV,"#",":                 *18
                             "#"",ALCADESC,"#",":                 *19
                             "#"",TRGSDESC,"#");"                 *20
            ENDIF
          ENDIF
.
NRVDIS99  RETURN
.
.******************************************************************************
.               Link to Previous Audit Page                                   .
.******************************************************************************
PREVAU00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"allweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
.

          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
PREVAU99  RETURN
.
.******************************************************************************
.              Link to Next Audit Page                                        .
.******************************************************************************
NEXTAU00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"allweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
NEXTAU99  RETURN
.
.-------------------------------------------------------------------
.     writing here for allied health department drop down filter
.-------------------------------------------------------------------
DEPF0000  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
DEPF0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPF9999
.
          MATCH     "CG",TCODE
          GOTO      DEPF9999 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      DEPF0100 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPF0100
.
          MATCH     "1",ALDEACTV
          GOTO      DEPF0100 IF EQUAL       * Skip Inactive
.
          MATCH     FILTDEPT,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option selected value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     SP70,ALDEHOSP
              IF        !@EQUAL
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  IF        OVRCD=1
                    MATCH     WBSEHOSP,ALDEHOSP
                    GOTO      DEPF0100 IF NOT EQUAL
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
          ENDIF
.
          GOTO      DEPF0100
.
DEPF9999  RETURN
.
+
.-------------------------------------------------------------------
.     Write mental health visit record for meh referrals
.-------------------------------------------------------------------
WRMEH000  CALL      CLMEHVIS
          CALL      CLMEHDIA
          MOVE      ADMISSNO,MHVIADMN
          PACK      MHVIURNO,URNUMBER,SP70
          MOVE      SEVEN,MHVISTAT        * set to community health visit
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAMHVIS1
          IF        OVRCD=1
            CALL      WRMHVIS1            * Write to MEH visit file
          ENDIF
.
          MOVE      ADMISSNO,MHDIADMN
          MOVE      ALRERDAT,MHDIDATE
          MOVE      "0",MHDIMOHR          * Unsent
          PACK      KEY16,MHDIADMN,MHDIDATE,SP70
          CALL      RAMHDIA1
          IF        OVRCD = 0
            PACK      MHDIUDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDIUDAT
            CLOCK     TIME,MHDIUTIM
            MOVE      USERID,MHDIUUID
            CALL      UPMHDIA1
          ELSE
            PACK      MHDICDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDICDAT
            CLOCK     TIME,MHDICTIM
            MOVE      USERID,MHDICUID
            CALL      WRMHDIA1
          ENDIF  
WRMEH999  RETURN
.
+
.-------------------------------------------------------------------
.     Write any missing mental health visit records when
.     updating meh referrals
.-------------------------------------------------------------------
UPMEH000  CALL      CLMEHVIS
          CALL      CLMEHDIA
          MOVE      ADMISSNO,MHVIADMN
          PACK      MHVIURNO,URNUMBER,SP70
          MOVE      SEVEN,MHVISTAT        * set to community health visit
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAMHVIS1
          IF        OVRCD=1
            CALL      WRMHVIS1            * Write to MEH visit file
          ENDIF
.
          MOVE      ADMISSNO,MHDIADMN
          MOVE      ALRERDAT,MHDIDATE
          MOVE      "0",MHDIMOHR          * Unsent
          PACK      KEY16,MHDIADMN,MHDIDATE,SP70
          CALL      RAMHDIA1
          IF        OVRCD = 1
            PACK      MHDICDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDICDAT
            CLOCK     TIME,MHDICTIM
            MOVE      USERID,MHDICUID
            CALL      WRMHDIA1
          ENDIF
.
UPMEH999  RETURN
.
.-----------------------------------------------------------------------------.
.  External Referrals
.-----------------------------------------------------------------------------.
EXTREF00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      EXTREF80 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add
          GOTO      EXTREF10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update
          GOTO      EXTREF20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete
          GOTO      EXTREF30 IF EQUAL
.
          GOTO      EXTREF90
.
EXTREF10  MOVE      ZERO,F8
          PACK      KEY16,ALEXT001,Z70
          CALL      RSALEXT1
          CALL      RPALEXT1
          BRANCH    OVRCD,EXTREF11
.
          MATCH     ALEXT001,ALEXVISN
          GOTO      EXTREF11 IF NOT EQUAL
.
          MOVE      ALEXEXTR,F8
.
EXTREF11  CALL      CLALEX00
.
          ADD       ONE,F8
.
          MOVE      F8,ALEXEXTR
          CALL      MVALEX00                * move in the cgi-para
.
          PACK      ALEXCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALEXCDAT
          CLOCK     TIME,ALEXCTIM
          MOVE      USERID,ALEXCUID
.
          PACK      KEY16,ALEXVISN,ALEXEXTR,SP70
          CALL      RAALEXT1
          COMPARE   ONE,OVRCD
          GOTO      EXTREF11 IF NOT EQUAL
.
          CALL      UXMHI000                * Set MHINC Extract indicator
          CALL      WRALEXT1                * write external referral
.
          MOVE      ZERO,EXIT
          GOTO      EXTREF99
.
EXTREF20  PACK      KEY16,ALEXT001,ALEXT002,SP70
          CALL      RDALEXT1
          BRANCH    OVRCD,EXTREF93
.
          CALL      MVALEX00
.
          CALL      UXMHI000                * Set MHINC Extract indicator
          CALL      UPALEXT1
.
          MOVE      ZERO,EXIT
          GOTO      EXTREF99
.
EXTREF30  PACK      KEY16,ALEXT001,ALEXT002,SP70
          CALL      RDALEXT1
          BRANCH    OVRCD,EXTREF93
.
          MATCH     SP70,ALEXMOHR
          GOTO      EXTREF40 IF EQUAL       * No MHINC
.
          MATCH     "0",ALEXMOHR
          GOTO      EXTREF40 IF EQUAL       * Unsent
.
          MOVE      "1",ALEXRCST            * Deleted indicator
          CALL      UXMHI000                * Set MHINC Extract indicator
          CALL      UPALEXT1
          GOTO      EXTREF50
.
EXTREF40  CALL      DEALEXT1              * Delete external referral
.
EXTREF50  MOVE      ZERO,EXIT
          GOTO      EXTREF99
.
EXTREF80  CALL      CURPER00              * Display Routine
          CALL      CALCDT00              * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,EXTREF91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,EXTREF91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,EXTREF92
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY16,ADMISSNO,ALEXT002,SP70
          CALL      RDALEXT1
          IF        OVRCD=1
            CALL      CLALEX00
          ENDIF
.
          PACK      KEY3,ALREDEPT,SP70        
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,EXTREF94
.
EXTREF85  CLEAR     WEBTITLE
          MOVE      "Allied Health External Referrals",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXTREF99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EXTREF99
.
EXTREF90  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTREF99
.
EXTREF91  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTREF99
.
EXTREF92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTREF99
.
EXTREF93  MOVE      "Invalid External Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTREF99
.
EXTREF94  MOVE      "Invalid Department.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXTREF99
.
EXTREF99  RETURN
.
.-----------------------------------------------------------------------------.
. List external referrals
.-----------------------------------------------------------------------------.
ERTB0000  PACK      KEY16,ADMISSNO,Z70
          CALL      RSALEXT1
ERTB1000  CALL      RPALEXT1
          BRANCH    OVRCD,ERTB9999
.
          MATCH     ADMISSNO,ALEXVISN
          GOTO      ERTB9999 IF NOT EQUAL
.
          PACK      KEY8,ALEXVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ERTB1000
.
          MATCH     "1",ALEXRCST             * Record deleted?
          GOTO      ERTB1000 IF EQUAL        * Ignore
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "ExtRefLink('",HTMLLINK
          APPEND    ALEXVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALEXEXTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CALL      GREF0000                * Get referred to name
.
          MOVE      SP70,REFEREAS
          MATCH     SP70,ALEXRREF
          IF        !@EQUAL
            PACK      KEY5,CATRF,ALEXRREF,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,REFEREAS
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",ALEXRDAT,"#",":                   * 1
                             "#"",REFEREDT,"#",":                   * 2
                             "#"",REFEREAS,"#",":                   * 3
                             "#"",REFDDESC,"#"":                    * 4
                             ");"
          GOTO      ERTB1000
.
ERTB9999  RETURN
.
.******************************************************************************
.* Get referred to name                                                       *
.******************************************************************************
GREF0000  MOVE      SP70,REFEREDT
          MOVE      SP70,REFDDESC
.
          MATCH     SP70,ALEXREFT
          GOTO      GREF9999 IF EQUAL
.
          PACK      KEY5,ANSS,SP1,ALEXREFT,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ALEXREFT,REFEREDT
            GOTO      GREF9999
          ENDIF
          MOVE      TDESC,REFEREDT
.
          MATCH     ANSA,TCINDC7            * External Agency
          GOTO      GREF1000 IF EQUAL
.
          MATCH     ANSC,TCINDC7            * School
          GOTO      GREF1000 IF EQUAL
.
          MATCH     ANSD,TCINDC7            * Residence
          GOTO      GREF1000 IF EQUAL
.
          MATCH     ANSI,TCINDC7            * Indigenous org
          GOTO      GREF1000 IF EQUAL

          MATCH     ANSL,TCINDC7            * Lawyer
          GOTO      GREF1000 IF EQUAL
.
          MATCH     ANSG,TCINDC7            * GP
          GOTO      GREF2000 IF EQUAL
.
          MATCH     ANSP,TCINDC7            * Private Hospital
          IF        @EQUAL
            MATCH     "1",TCINDC2
            GOTO      GREF3000 IF EQUAL
            GOTO      GREF1000
          ENDIF
.
          MATCH     ANSB,TCINDC7            * Public Hospital
          IF        @EQUAL
            MATCH     "1",TCINDC2
            GOTO      GREF3000 IF EQUAL
            GOTO      GREF1000
          ENDIF
.
          GOTO      GREF9999
.
GREF1000  PACK      KEY7,TCINDC7,ALEXORCD,SP70
          CALL      RDPTEOR1
          IF        OVRCD=1
            MOVE      ALEXORCD,REFDDESC
            GOTO      GREF9999
          ENDIF
          MOVE      PTERNAME,REFDDESC
          GOTO      GREF9999
.
GREF2000  PACK      KEY10,ALEXHCPC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      ALEXHCPC,REFDDESC
            GOTO      GREF9999
          ENDIF
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,REFDDESC
          GOTO      GREF9999
.
GREF3000  PACK      KEY5,ALEXORCD,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            MOVE      ALEXORCD,REFDDESC
            GOTO      GREF9999
          ENDIF 
          MOVE      PTVADESC,REFDDESC
          GOTO      GREF9999
.
GREF9999  RETURN
.
.******************************************************************************
.* List encounters for this referral                                          *
.******************************************************************************
WRSE0000  MOVE      ONE,SHOWFLAG
          MOVE      ZERO,DISNUMB
.
          CLEAR     HTMLLINK
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY32,ADMISSNO,Z70
          CALL      RSALENC6                * positional read
WRSE0010  CALL      RPALENC6                * read a record
          BRANCH    OVRCD,WRSE9995
.
          MATCH     ALENVISN,ADMISSNO       * if the referral/visit matches
          GOTO      WRSE9995 IF NOT EQUAL 
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1                * Reading From Referral Table
          IF        OVRCD=1
            GOTO      WRSE0010
          ENDIF
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Reading For Web Security Id
.
          PACK      ENCOUTKY,ALENVISN,ALENENCT,SP70
          MATCH     "0",ALDESECU
          IF        @EQUAL
            GOTO      WRSE0016
          ENDIF
          MATCH     "1",ALDESECU
.
          IF        @EQUAL
             MATCH     WBSEDALL,ALREDEPT
             GOTO      WRSE0016 IF EQUAL
             GOTO      WRSE0015
          ELSE
             MATCH     WBSEDALL,ALREDEPT
             GOTO      WRSE0016 IF EQUAL
             GOTO      WRSE0010
          ENDIF
.
WRSE0015  IF        XFORMAT=0
            WRITE     HTMLFILE;"<tr>":
                      "<td nowrap>":
                      "<a HREF ='javascript:alert":
                      "(#"Invalid Security#");'>";
          ENDIF
          GOTO      WRSE0017
.
WRSE0016  IF        XFORMAT=0
            WRITE     HTMLFILE;"<tr>":
                      "<td nowrap>":
                      "<a HREF ='javascript:EnctrLink":
                      "(#"",LINKPRG:
                      ".pbl?reportno=",LINKREP:
                      "&template=",LINKTEM:
                      "&deptcode=",ALREDEPT:
                      "&encoutky=",ENCOUTKY,"#");'>";
          ENDIF
.
WRSE0017  MOVE      SP70,DOCFNAME
          PACK      KEY10,ALENHCP,SP70      * To get HCP name
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCTITL,    FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME     * To get the Service Provider
            CALL      DOCNM000
          ENDIF
.
          CLEAR     ALENCOMT
          APPEND    ALENCMT1,ALENCOMT       * To Concatenate Comments
          APPEND    ALENCMT2,ALENCOMT
          RESET     ALENCOMT
.
          MOVE      SP70,ALSRDESC
          MATCH     SP70,ALENSDEP
          IF        !@EQUAL
            PACK      KEY9,ALENSDEP,ALENSERV,SP70
          ELSE
            PACK      KEY9,ALREDEPT,ALENSERV,SP70
          ENDIF
          CALL      RDALSER1                * To get the Service Type
.
          PACK      KEY12,WBSESIT,ALENCLIN,SP70
          CALL      RDCTYA1                 * Reading For Clinic Description
.
          MOVE      "LD",CATEGORY
          MOVE      ALENLOCA,CODE           * Reading For Location Of Service
          CALL      GETCOD00
          MOVE      TDESC,LOSERDES
.
          PACK      DIM20,SP70
          IF        PTCNHDPS=1
            MOVE      CATCL,CATEGORY
            MOVE      ALENCOMP,CODE           * Get Claim Code
            CALL      GETCOD00
            MOVE      TDESC,DIM20
          ENDIF
.
.                                           * set Notes Icon if linked Notes
WRSE0020  MOVE      "0",KEY1
          MOVE      "001",KEY3
          PACK      KEY25,ALENVISN,ALENENCT,KEY3,SP70
          CALL      ENCNOT00                * see if Notes exist
.
          PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      ENCINT00                * see if Interventions exist
.
...       PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      ENCMED00                * see if Medications exist
.
...       PACK      KEY24,ALENVISN,ALENENCT,Z70
          CALL      ENCSUP00                * see if Supplies exist
.
WRSE0030  IF        XFORMAT=0
            CALL      EVTR0000
          ELSE
            UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MATCH     "1",ALENRSTA            * Record status (0=Active 1=Cancel)
            IF        @EQUAL
              WRITE      HTMLFILE;"<strike>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,ALENSTIM,SP1:
                                  DOCFNAME,"<br/>",ALSRDESC,"<br/><br/></strike>";
            ELSE
              WRITE      HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,ALENSTIM,SP1:
                                  DOCFNAME,"<br/>Service:",ALSRDESC,"<br/><br/>";
            ENDIF
          ENDIF
.
          ADD       ONE,DISNUMB
.
          IF        XFORMAT=0
            COMPARE   FIVE,DISNUMB
            GOTO      WRSE0010 IF NOT EQUAL
          ELSE
            COMPARE   TEN,DISNUMB
            GOTO      WRSE0010 IF NOT EQUAL
          ENDIF
          MOVE      ZERO,SHOWFLAG
.
WRSE9995  IF        XFORMAT=0
            CALL      NOMORE00
          ENDIF
.
WRSE9999  RETURN

.******************************************************************************
.*                      Display Of Event Row                                  *
.******************************************************************************
EVTR0000  MATCH     "1",ALENRSTA            * Record status (0=Active 1=Cancel)
          IF        @EQUAL
            GOTO    EVTR0020
          ELSE
            GOTO    EVTR0010
          ENDIF
.
EVTR0010  UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          REP       " +",VISITNO
          WRITE     HTMLFILE;"<img src=../images/MaintenanceIcon.gif":
                    " class=ListIcon ></a>":
                    CDAY,"&nbsp;",MTHNAM3,"&nbsp;",CCENT:
                    CYEAR,"&nbsp;",ALENSTIM,"</td>":
                    "<td>","&nbsp;",DOCFNAME,"</td>":
                    "<td>","&nbsp;",ALSRDESC,"</td>";
.
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;"<td>&nbsp;",DIM20,"</td>";
          ENDIF
.
         REP        "+ ",VISITNO
.
         GOTO       EVTR0030
.
EVTR0020  MOVE      ALENVISN,VISITNO
          UNPACK    ALENSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          REP       " +",VISITNO
          WRITE     HTMLFILE;"<img src=../images/MaintenanceIcon.gif ":
                    "class=ListIcon></a>":
                    "&nbsp;","<strike>",CDAY,"&nbsp;",MTHNAM3,"&nbsp;":
                    CCENT,CYEAR,"&nbsp;",ALENSTIM,"</strike>","</td>":
                    "<td>","<strike>","&nbsp;",DOCFNAME,"</strike>","</td>":
                    "<td>","<strike>","&nbsp;",ALSRDESC,"</strike>","</td>";
.
          IF        PTCNHDPS=1
            MATCH     DIM20,SP70
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp</td>";
            ELSE
              WRITE     HTMLFILE;"<td><strike>&nbsp;",DIM20,"</strike></td>";
            ENDIF
          ENDIF
.
          REP        "+ ",VISITNO
.
EVTR0030  MOVE      "1",KEY1                * are Information Icons required?
          WRITE     HTMLFILE;"<td nowrap>";
          IF        ENCNOTES = 1
            WRITE     HTMLFILE;"<img src=../images/CommentIcon.gif":
                      "  alt=#"Notes#">";
          ENDIF
          IF        ENCMEDIC = 1
            WRITE     HTMLFILE;"<img src=../images/medication.gif":
                      " alt=#"Medications#">";
          ENDIF
          IF        ENCINTEV = 1
            WRITE     HTMLFILE;"<img src=../images/int.gif":
                      " alt=#"Interventions#">";
          ENDIF
          IF        ENCSUPLY = 1
            WRITE     HTMLFILE;"<img src=../images/supplies.gif":
                      " alt=#"Supplies#">";
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td></tr>"
.
          GOTO       EVTR9999
.
EVTR9999  RETURN
.
.------------------------------------------------------------
. NOMORE00 - Display "No more visits" at end of visit list by type
.------------------------------------------------------------
NOMORE00  COMPARE   ONE,SHOWFLAG
          GOTO      NOMORE99 IF NOT EQUAL
.
          IF        PTCNHDPS=1
             WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=10 align=center>":
                                 "No more Encounters</td>"
          ELSE
             WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=10 align=center>":
                                 "No more Episodes of Care</td>"
          ENDIF
.
NOMORE99  RETURN
+
.----------------------------------------------------------------------
. Show Patient Referral
.----------------------------------------------------------------------
PATREF00  MOVE      SP70,FLDCLASS
          CLEAR     FLDCLASS
          APPEND    "'",FLDCLASS
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSOTRFL2
PATREF10  CALL      RKOTRFL2
          BRANCH    OVRCD,PATREF99
          MATCH     OTRLURNO,URNUMBER
          GOTO      PATREF99 IF NOT EQUAL
          COMPARE   ZERO,OTRLTREF
          GOTO      PATREF10 IF NOT EQUAL
.
PATREF12  MOVE      "PR",CATEGORY
          MOVE      OTRLPRIO,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MATCH     SP70,OTRLSITE
          GOTO      PATREF15 IF EQUAL
.
          PACK      KEY6,OTRLSITE,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,PATREF15
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
PATREF15  PACK      KEY20,OTRLSITE,OTRLCONS,OTRLDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OTRLSITE,OTRLCONS,OTRLDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,PATREF16
.
            MATCH     OTRLSITE,OCASITE
            GOTO      PATREF16 IF NOT EQUAL
.
            MATCH     OTRLCONS,OCACLIN
            GOTO      PATREF16 IF NOT EQUAL
          ENDIF
.
          GOTO      PATREF17
.
PATREF16  MOVE      SP70,OCADESC
.
PATREF17  MOVE      SP70,OCTDESC
          PACK      KEY12,OTRLSITE,OTRLCTYP,SP70
          CALL      RDCTYA1                  * Read Clinic Type File
.
          MATCH     SP70,OTRLSITE            * If site files changed
          GOTO      PATREF20 IF EQUAL        * restore the correct user files
.
          PACK      KEY6,WBSESIT,SP70
          CALL      RDSITA1                  * Read Site Code File
          BRANCH    OVRCD,PATREF20
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CLOSE     OUTCLIA1
            PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
            OPEN      OUTCLIA1,CFNAME
.
            CLOSE     OUTCTYA1
            PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
            OPEN      OUTCTYA1,CFNAME
          ENDIF
.
PATREF20  MOVE      SP70,KEY11
          MATCH     SP70,OTRLDREC
          GOTO      PATREF30 IF EQUAL
.
          UNPACK    OTRLDREC,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
PATREF30  CALL      ADDHCP00
.
          MOVE      SP70,KEY60
          PACK      KEY10,OTRLRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY60
            STRIP     KEY60
          ENDIF
.
          MOVE      SP70,KEY80
          PACK      KEY12,OTRLGPPC,OTRLGPPT,SP70
          CALL      RDPMHCG1
          IF        OVRCD=0
            MOVE      PMHGPNAM,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY80
          ENDIF
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,OTRLRDOC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,JAVSNAME
            CALL      JAVDES00
            MOVE      JAVSNAME,KEY50
            STRIP     KEY50
          ENDIF
.
          MOVE      OTRLDIAG,JAVSNAME
          CALL      JAVDES00
.
          MOVE      ZERO,BSTATUS
          MATCH     SP70,OTRLBSIT
          IF        !@EQUAL
            MOVE      ONE,BSTATUS
          ENDIF
.
          CLEAR     REFLINK
          APPEND    "javascript:OPReferralLink('",REFLINK
          APPEND    OTRLOUTN,REFLINK
          APPEND    "','",REFLINK
          APPEND    BSTATUS,REFLINK
          APPEND    "');",REFLINK
          RESET     REFLINK
.
          MOVE      SP70,DEPDESC
          PACK      ALRERDAT,OTRLDATE,SP70
          PACK      PRIMSORT,ZERO,OTRLDATE,SP70
          PACK      ALSTDESC,SP70
          PACK      ALPRDESC,SP70
          PACK      ALREVISN,OTRLOUTN,SP70
          PACK      ALENSDAT,SP70
          PACK      COMPDESC,SP70
          PACK      ALREPRCM,OTRLDIAG,SP70
          PACK      ALRERHCP,OTRLRDOC,SP70
          PACK      ALREREXP,SP70
          PACK      EXPRICON,SP70
          PACK      ALRECLID,OTRLCONS,SP70
          PACK      ALRECTYP,OTRLCTYP,SP70
          MOVE      DUBOOKED,BOOKSTAT
          MATCH     SP70,OTRLBDTE
          IF        !@EQUAL
            MOVE      DBOOKED,BOOKSTAT
          ENDIF
.
          PACK      BOOKSTAT,SP70
          PACK      HTMLLNK2,SP70
          PACK      REFTDESC,SP70
          PACK      ALRECOMP,OTRLCLAM,SP70
          PACK      ALREUHC4,SP70
          PACK      ALCADESC,SP70
          PACK      ALREHCP,OTRLRHCP,SP70
          PACK      DOCFNAM2,SP70
          PACK      HTMLLNK3,SP70
          PACK      HTMLLNK4,SP70
          PACK      ICONLNK3,SP70
.
          MATCH     SP70,OTRLCDTE
          IF        !@EQUAL
            MOVE      "4",ALRESTAT
            GOTO      PATREF40
          ENDIF
.
          MATCH     SP70,OTRLBDTE
          IF        @EQUAL
            MOVE      "0",ALRESTAT
            GOTO      PATREF40
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,OTRLBDTE
          IF        !@LESS
            MOVE      "1",ALRESTAT
          ELSE
            MOVE      "2",ALRESTAT
          ENDIF
.
PATREF40  MOVE      ALRESTAT,ALSTSTAT
          CALL      ASHTST00
          MOVE      ALSTATUS,ALSTDESC
.
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            APPEND    "RefStatusWaiting ",FLDCLASS
          ENDIF
.
          MATCH     "1",ALRESTAT
          IF        @EQUAL
            APPEND    "RefStatusActive ",FLDCLASS
          ENDIF
.
          MATCH     "7",FILTSTAT                      * Waiting & Active
          IF        @EQUAL
            MATCH     "0",ALRESTAT
            GOTO      PATREF50 IF EQUAL
            MATCH     "1",ALRESTAT
            GOTO      PATREF50 IF EQUAL
            GOTO      PATREF10 
          ENDIF
.
          MATCH     "8",FILTSTAT                      * Closed & Rejected
          IF        @EQUAL
            MATCH     "2",ALRESTAT
            GOTO      PATREF50 IF EQUAL
            MATCH     "5",ALRESTAT
            GOTO      PATREF50 IF EQUAL
            GOTO      PATREF10
          ENDIF
.
          MATCH     "9",FILTSTAT                      * Inactive & Cancelled
          IF        @EQUAL
            MATCH     "3",ALRESTAT
            GOTO      PATREF50 IF EQUAL
            MATCH     "4",ALRESTAT
            GOTO      PATREF50 IF EQUAL
            GOTO      PATREF10
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALRESTAT
            GOTO      PATREF10 IF NOT EQUAL
          ENDIF
.
PATREF50  APPEND    "Left'",FLDCLASS
          RESET     FLDCLASS
.
          WRITE     HTMLFILE;"t.addRow(#"",REFLINK,"#",":           * 0
                             "#"",OCTDESC,"#",":                    * 1
                             "#"",ALRERDAT,"#",":                   * 2
                             "#"",ALSTDESC,"#",";                   * 3
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            CALL      DISHCS00
            WRITE     HTMLFILE;"#"",DOCFNAME,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",DOCFNAME,"#",";                 * 4
          ENDIF
.
          WRITE     HTMLFILE;"#"",OTRLDIAG,"#",":                   * 5
                             "#"",ALREVISN,"#",":                   * 6
                             "#"",ALENSDAT,"#",":                   * 7
                             "#"",PRIODESC,"#",":                   * 8
                             "#"",COMPDESC,"#",":                   * 9
                             "#"",ALREPRCM,"#",":                   *10
                             "#"",OCADESC,"#",":                    *11
                             "#"",OCTDESC,"#",":                    *12
                             "#"",ALRERHCP,"#",":                   *13
                             "#"",ALREREXP,"#",":                   *14
                             "#"",EXPRICON,"#",":                   *15
                             "#"",ALRECLID,"#",":                   *16
                             "#"",ALRECTYP,"#",";                   *17
.
          MATCH     "1",DOCINDIC
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DOCFNAME,DISPPROV,"<br><font color=blue>",DOCFNAM3,"<br>",DOCFNAM4,"<br>",DOCFNAM5,"<br>",DOCFNAM6,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",DOCFNAME,DISPPROV,"#",";        *18
          ENDIF
.
          WRITE     HTMLFILE;"#"",BOOKSTAT,"#",":                   *19
                             "#"",HTMLLNK2,"#",":                   *20
                             "#"",REFTDESC,"#",":                   *21
                             "#"",ALRECOMP,"#",":                   *22
                             "#"",ALREUHC4,"#",":                   *23
                             "#"",ALCADESC,"#",":                   *24
                             "#"",ALREHCP,"#",":                    *25
                             "#"",DOCFNAM2,"#",":                   *26
                             "#"",HTMLLNK3,"#",":                   *27
                             "#"","0","#",":                        *28
                             "#"","OP","#",":                       *29
                             "#"",SP1,"#",":                        *30
                             "#"",PRIMSORT,"#",":                   *31
                             "#"",FLDCLASS,"#"":                    *32
                             ");"
          GOTO      PATREF10
.
PATREF99  RETURN
.
.------------------------------------------------------------
. Format Description/Name (for Javascript)
.*** format the surname and given name by changing any ' to %60
.---------------------------------------------------------------
JAVDES00  SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVDES99 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted string
.
JAVDES99  RETURN
.
.------------------------------------------------------------
. List group contact session patients - allgrpaf
.------------------------------------------------------------
PTAB0000  PACK      KEY24,URNUMBER,SP70
          CALL      RSALGRP3
PTAB1000  CALL      RKALGRP3
          BRANCH    OVRCD,PTAB9999
.
          MATCH     URNUMBER,ALGPURNO
          GOTO      PTAB9999 IF NOT EQUAL
.
          PACK      KEY8,ALGPSESN,SP70
          CALL      RDALGRO1
          BRANCH    OVRCD,PTAB1000
.
          MATCH     SP70,FILTDEPT
          IF        !@EQUAL
            MATCH     FILTDEPT,ALGRDEPT
            GOTO      PTAB1000 IF NOT EQUAL     
          ENDIF
.
          MOVE      SP70,DESCDEPT
          MATCH     SP70,ALGRDEPT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALGRDEPT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALGRDEPT,TDESC
            ENDIF
            MOVE    TDESC,DESCDEPT
          ENDIF
.
          MOVE      "Inactive",DESCACTV
          MOVE      "LineThrough",KEY15
          MATCH     "0",ALGPACTV
          IF        @EQUAL
            MOVE      "Active",DESCACTV
            MOVE      SP70,KEY15
          ENDIF
.
          PACK      KEY3,ALGRDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,PTAB1000
.
          PACK      HTMLLINK,SP70,SP70
          MATCH     "1",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALGRDEPT
            GOTO      PTAB5000 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",ALDESECU
          IF        @EQUAL
            MATCH     WBSEDALL,ALGRDEPT
            GOTO      PTAB1000 IF NOT EQUAL
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ReferralLink('",HTMLLINK
          APPEND    ALGPURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALGPREFN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
PTAB5000  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              *0
                                      "#"",ALGRNAME,"#",":              *1
                                      "#"",ALGPSESN,"#",":              *2
                                      "#"",ALGPREFN,"#",":              *3
                                      "#"",DESCDEPT,"#",":              *4
                                      "#"",DESCACTV,"#",":              *5
                                      "#"",KEY15,"#");"                 *6
.
          GOTO      PTAB1000
.
PTAB9999  RETURN
+
.******************************************************************************
.         MHINC - Check for MH Department and Primary Ref.
.******************************************************************************
UXMHI000  PACK      KEY8,ALEXVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,UXMHI999
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UXMHI999
.
          MATCH     "M",TCINDC4
          GOTO      UXMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      UXMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MATCH     "1",ALEXRCST             * deleting record?
          GOTO      UXMHI600 IF EQUAL
.
          MATCH     "3",ALEXMOHR             * send update?
          GOTO      UXMHI999 IF EQUAL
          MATCH     "1",ALEXMOHR             * already sent?
          GOTO      UXMHI400 IF EQUAL
.
          MOVE      "0",ALEXMOHR             * Unsent
          GOTO      UXMHI999
.
UXMHI400  MOVE      "3",ALEXMOHR             * Send Update
          GOTO      UXMHI999
.
UXMHI600  MOVE      "2",ALEXMOHR             * set to 'Send Delete'
          GOTO      UXMHI999
.
UXMHI999  RETURN
+
.******************************************************************************
.         Update visit extension file
.******************************************************************************
UPVX0000  MOVE      ALREVISN,PMVXVISN
          MATCH     ALREF019,Z70
          IF        @EQUAL
            PACK      PMVXVSDT,CCC,CYY,CMM,CDD
            REP       " 0",PMVXVSDT
          ELSE
            MOVE      ALREF019,PMVXVSDT
          ENDIF
          MOVE      ALREHCP,PMVXDOCA
          MOVE      "0",PMVXCSNR
          MOVE      PPOST,PMVXPOST
          MOVE      "0",PMVXCFSG
          MOVE      "0",PMVXINGP
          MOVE      "0",PMVXHCP1
          MOVE      "0",PMVXHCP2
          MOVE      "0",PMVXHCP3
          MOVE      "0",PMVXHCP4
          MOVE      ALRERHCP,PMVXRHC1
          MOVE      ALRERHCR,PMVXRH1G
          MOVE      "1",PMVXRH1C
          MOVE      "0",PMVXPSTY
          MOVE      "0",PMVXVALW
          MOVE      "0",PMVXPALW
          MOVE      "0",PMVXINDC
          MOVE      "0",PMVXHOME
          CALL      IBACLOCK
          PACK      PMVXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMVXLUPD
          MOVE      CTIMEIS,PMVXLUPT
          MOVE      WBSEUID,PMVXWEBU
          CALL      GTASGC00                * get SLA/ASGC code
.
          MATCH     Z70,ALREF107
          IF        !@EQUAL
            MOVE      ALREF107,PMVXMHOS
          ELSE
            MOVE      ALDEHOSP,PMVXMHOS
          ENDIF
.
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXPILC
.
          MATCH     Z70,PMSVX010
          IF        !@EQUAL
            PACK      PMVXINGP,PMSVX010,SP70
          ENDIF
.
          MATCH     PMSVX093,Z70
          IF        !@EQUAL
            MOVE      PMSVX093,PMVXINTR
          ENDIF
.
          MATCH     PMSVX141,Z70
          IF        !@EQUAL
            MOVE      PMSVX141,PMVXFSRC
          ENDIF
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RAPMVX11                * write to the Visit Extenson file
          IF        OVRCD=0
            CALL      UPPMVX11                * write to the Visit Extenson file
          ENDIF
.                                    
UPVX9999  RETURN
+
.------------------------------------------------------------------------
.  Check for GP Access on websecaf
.------------------------------------------------------------------------
CHGP0000 MOVE       ZERO,EXIT
         MOVE       SP70,GPCODE
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "1",WBSEGPAC           * using registered gp
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "2",WBSEGPAC           * using verified gp
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
CHGP9000 MOVE       ONE,EXIT
.
CHGP9999 RETURN
+
.******************************************************************************
.
.         ALBT0000 - all health labels, we check the patients visit number
.                    to find their department for that visit. Then we use
.                    that department and find out the default label to print.
.******************************************************************************
.
ALBT0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ALBT9999
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDLL1
          BRANCH    OVRCD,ALBT9999
.
          PACK      LABELTYP,LABELALL,ALDLPLAB
.
ALBT9999  RETURN
.
.
.-----------------------------------------------------------------------------.
. Referral Assessment Scores
.-----------------------------------------------------------------------------.
ASCORE00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ASCOR800 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Barthel
          GOTO      ASCORE10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Barthel
          GOTO      ASCORE15 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Barthel
          GOTO      ASCORE20 IF EQUAL
.
          MATCH     "E",UPDATETY            * Add FIM
          GOTO      ASCORE25 IF EQUAL
.
          MATCH     "F",UPDATETY            * Update FIM
          GOTO      ASCORE30 IF EQUAL
.
          MATCH     "G",UPDATETY            * Delete FIM
          GOTO      ASCORE35 IF EQUAL
.
          MATCH     "H",UPDATETY            * Add PCPSS
          GOTO      ASCORE40 IF EQUAL
.
          MATCH     "I",UPDATETY            * Update PCPSS
          GOTO      ASCORE45 IF EQUAL
.
          MATCH     "J",UPDATETY            * Delete PCPSS
          GOTO      ASCORE50 IF EQUAL
.
          MATCH     "K",UPDATETY            * Add GEM/Rehabilitation
          GOTO      ASCORE55 IF EQUAL
.
          MATCH     "L",UPDATETY            * Update GEM/Rehabilitation
          GOTO      ASCORE60 IF EQUAL
.
          MATCH     "M",UPDATETY            * Delete GEM/Rehabilitation
          GOTO      ASCORE65 IF EQUAL
.
          MATCH     "N",UPDATETY            * Add SMMMSE
          GOTO      ASCORE70 IF EQUAL
.
          MATCH     "O",UPDATETY            * Update SMMMSE
          GOTO      ASCORE75 IF EQUAL
.
          MATCH     "P",UPDATETY            * Delete SMMMSE
          GOTO      ASCORE80 IF EQUAL
.
          MATCH     "Q",UPDATETY            * Add RUG-ADL Palliative
          GOTO      ASCORE85 IF EQUAL
.
          MATCH     "R",UPDATETY            * Update RUG-ADL Palliative
          GOTO      ASCORE90 IF EQUAL
.
          MATCH     "S",UPDATETY            * Delete RUG-ADL Palliative
          GOTO      ASCORE95 IF EQUAL
.
          MATCH     "T",UPDATETY            * Add RUG-ADL Maintenance
          GOTO      ASCORE85 IF EQUAL
.
          MATCH     "V",UPDATETY            * Update RUG-ADL Maintenance
          GOTO      ASCORE90 IF EQUAL
.
          MATCH     "W",UPDATETY            * Delete RUG-ADL Maintenance
          GOTO      ASCORE95 IF EQUAL
.
          MATCH     "X",UPDATETY            * Add HONOS 65+ Maintenance
          GOTO      ASCOR100 IF EQUAL
.
          MATCH     "Y",UPDATETY            * Update HONOS 65+ Maintenance
          GOTO      ASCOR105 IF EQUAL
.
          MATCH     "Z",UPDATETY            * Delete HONOS 65+ Maintenance
          GOTO      ASCOR110 IF EQUAL
.
          GOTO      ASCOR990
.
. Add Barthel
.
ASCORE10  PACK      KEY24,ALBIA001,ALBIA002,ALBIA003,SP70
          CALL      RDALBIA1
          COMPARE   ZERO,OVRCD
          GOTO      ASCOR994 IF EQUAL
.
          CALL      CLALLBIA
          CALL      MVALBI00
.
          PACK      ALBACDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALBACDAT
          CLOCK     TIME,ALBACTIM
          MOVE      USERID,ALBACUID
.
          CALL      WRALBIA1
.           
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Update Barthel
.
ASCORE15  PACK      KEY24,ALBIA001,ALBIA002,ALBIA003,SP70
          CALL      RDALBIA1
          BRANCH    OVRCD,ASCOR995
.         
          CALL      MVALBI00
.
          PACK      ALBAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALBAUDAT
          CLOCK     TIME,ALBAUTIM
          MOVE      USERID,ALBAUUID
.
          CALL      UPALBIA1
.
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Barthel Flag record as deleted
.
ASCORE20  PACK      KEY24,ALBIA001,ALBIA002,ALBIA003,SP70
          CALL      RDALBIA1
          BRANCH    OVRCD,ASCOR995 
.
          MOVE      ONE,ALBADELF            * Set deleted flag to yes
.
          PACK      ALBADDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALBADDAT
          CLOCK     TIME,ALBADTIM
          MOVE      USERID,ALBADUID
.         
          CALL      UPALBIA1
.
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Add FIM
.         
ASCORE25  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          COMPARE   ZERO,OVRCD
          GOTO      ASCOR994 IF EQUAL
.
          MATCH     ANSA,PTFIM004
          IF        @EQUAL
            CALL      CAFIM000
            BRANCH    EXIT,ASCOR996
          ENDIF
.
          MATCH     ANSD,PTFIM004
          IF        @EQUAL
            CALL      CAFIM000
            BRANCH    EXIT,ASCOR997
          ENDIF
.
          CALL      CLPATFIM
          CALL      MVPTFI00
.
          PACK      PTFICDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFICDAT
          CLOCK     TIME,PTFICTIM
          MOVE      USERID,PTFICUID
.
          CALL      WRPTFIM1
.
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Update FIM    
.         
ASCORE30  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          BRANCH    OVRCD,ASCOR995
.         
          CALL      MVPTFI00
.         
          PACK      PTFIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFIUDAT
          CLOCK     TIME,PTFIUTIM
          MOVE      USERID,PTFIUUID
.         
          CALL      UPPTFIM1
.
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. FIM Flag record as deleted
.         
ASCORE35  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          BRANCH    OVRCD,ASCOR995
.         
          MOVE      ONE,PTFIDELT            * Set deleted flag to yes
.         
          PACK      PTFIDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFIDDAT
          CLOCK     TIME,PTFIDTIM
          MOVE      USERID,PTFIDUID
.         
          CALL      UPPTFIM1
.         
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Add PC
.
ASCORE40  PACK      KEY24,ALSAS001,ALSAS002,ALSAS003,SP70
          CALL      RDALSAS1
          COMPARE   ZERO,OVRCD
          GOTO      ASCOR994 IF EQUAL
.
          CALL      CLALLSAS
          CALL      MVALSA00
.
          PACK      ALSACDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSACDAT
          CLOCK     TIME,ALSACTIM
          MOVE      USERID,ALSACUID
.
          CALL      WRALSAS1
.
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Update PC
.
ASCORE45  PACK      KEY24,ALSAS001,ALSAS002,ALSAS003,SP70
          CALL      RDALSAS1
          BRANCH    OVRCD,ASCOR995
.
          CALL      MVALSA00
.
          PACK      ALSAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSAUDAT
          CLOCK     TIME,ALSAUTIM
          MOVE      USERID,ALSAUUID
.
          CALL      UPALSAS1
.
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. PC Flag record as deleted
.
ASCORE50  PACK      KEY24,ALSAS001,ALSAS002,ALSAS003,SP70
          CALL      RDALSAS1
          BRANCH    OVRCD,ASCOR995
.
          MOVE      ONE,ALSADELF            * Set deleted flag to yes
.
          PACK      ALSADDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSADDAT
          CLOCK     TIME,ALSADTIM
          MOVE      USERID,ALSADUID
.
          CALL      UPALSAS1
.
          MOVE      "13",HDPEQUIV           * Visit details changed
          CALL      ADDPEI00                * Add new PRS2 inc/exc file record
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Add GEM/Rehabilitation Score
.
ASCORE55  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          COMPARE   ZERO,OVRCD
          GOTO      ASCOR994 IF EQUAL
.
          CALL      CLPATFIM
          CALL      MVPTFI00
.
          PACK      PTFICDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFICDAT
          CLOCK     TIME,PTFICTIM
          MOVE      USERID,PTFICUID
.
          CALL      WRPTFIM1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Update GEM/Rehabilitation Score
.
ASCORE60  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          BRANCH    OVRCD,ASCOR995
.
          CALL      MVPTFI00
.
          PACK      PTFIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFIUDAT
          CLOCK     TIME,PTFIUTIM
          MOVE      USERID,PTFIUUID
          MOVE      SAVKEY02,PTFIDATE
          MOVE      SAVKEY03,PTFITIME
          TRAP      OVERCOND IF IO
            CALL      UPPTFIM1
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      "Cannot update record. Duplicate date/time.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT 
            GOTO      ASCOR999
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Delete GEM/Rehabilitation Score
.
ASCORE65  PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          BRANCH    OVRCD,ASCOR995
.
          MOVE      ONE,PTFIDELT            * Set deleted flag to yes
          MOVE      PTFIM090,PTFIDRES
.
          PACK      PTFIDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFIDDAT
          CLOCK     TIME,PTFIDTIM
          MOVE      USERID,PTFIDUID
.
          CALL      UPPTFIM1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Add SMMSE Score
.
ASCORE70  PACK      KEY24,PMMMS001,PMMMS002,PMMMS003,SP70
          CALL      RDPMMMS1
          COMPARE   ZERO,OVRCD
          GOTO      ASCOR994 IF EQUAL
.
          CALL      CLPMMS00
          CALL      MVPMMS00
.
          PACK      PMMMCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMMMCDAT
          CLOCK     TIME,PMMMCTIM
          MOVE      USERID,PMMMCUID
.
          CALL      WRPMMMS1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Update SMMSE Score
.
ASCORE75  PACK      DIM16,OLDPMM02,OLDPMM03,SP70
          PACK      DIM16A,PMMMS002,PMMMS003,SP70
          MATCH     DIM16,DIM16A
          GOTO      ASCORE77 IF NOT EQUAL
.
          PACK      KEY24,PMMMS001,PMMMS002,PMMMS003,SP70
          CALL      RDPMMMS1
          BRANCH    OVRCD,ASCOR995
.
          CALL      MVPMMS00
.
          PACK      PMMMUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMMMUDAT
          CLOCK     TIME,PMMMUTIM
          MOVE      USERID,PMMMUUID
.
          CALL      UPPMMMS1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
ASCORE77  PACK      KEY24,PMMMS001,PMMMS002,PMMMS003,SP70
          CALL      RAPMMMS1
          COMPARE   ZERO,OVRCD
          GOTO      ASCOR994 IF EQUAL 
.
          PACK      KEY24,PMMMS001,OLDPMM02,OLDPMM03,SP70
          CALL      RDPMMMS1
          BRANCH    OVRCD,ASCOR995
.
          CALL      MVPMMS00
.
          PACK      PMMMUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMMMUDAT
          CLOCK     TIME,PMMMUTIM
          MOVE      USERID,PMMMUUID
.
          CALL      UPPMMMS1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Delete SMMSE Score
.
ASCORE80  PACK      KEY24,PMMMS001,PMMMS002,PMMMS003,SP70
          CALL      RDPMMMS1
          BRANCH    OVRCD,ASCOR995
.
          MOVE      ONE,PMMMDELF            * Set deleted flag to yes
          MOVE      PMMMS027,PMMMDRES
.
          PACK      PMMMDDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMMMDDTE
          CLOCK     TIME,PMMMDTME
          MOVE      USERID,PMMMDUID
.
          CALL      UPPMMMS1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Add RUG-ADL Score
.
ASCORE85  PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          CALL      RDPMRUG1
          IF        OVRCD=0
            MATCH     "1",PMRUDELF
            IF        @EQUAL
              MOVE      "A Deleted assessment exists for this date/time.",WEBTITLE
            ELSE
              MOVE      "Assessment exists for this date/time.",WEBTITLE
            ENDIF
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      ASCOR999
          ENDIF
.
          PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          CALL      RDALSAS1
          IF        OVRCD=0
            MATCH     "1",ALSADELF
            IF        @EQUAL
              MOVE      "Deleted scores exist for this date/time.",WEBTITLE
            ELSE
              MOVE      "Scores exist for this date/time.",WEBTITLE
            ENDIF
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      ASCOR999
          ENDIF
.
          CALL      CLPRUG00
          CALL      MVPRUG00
.
          PACK      PMRUCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRUCDAT
          CLOCK     TIME,PMRUCTIM
          MOVE      USERID,PMRUCUID
.
          CALL      WRPMRUG1
          MOVE      ZERO,F1
          CALL      UPPH0000
.
          MATCH     "T",UPDATETY            * Add RUG-ADL Maintenance Ass Only
          GOTO      ASCOR999 IF EQUAL
.
          MOVE      PMRUG001,ALSAS001
          MOVE      PMRUG002,ALSAS002
          MOVE      PMRUG003,ALSAS003
.
          PACK      KEY24,ALSAS001,ALSAS002,ALSAS003,SP70
          CALL      RDALSAS1
          IF        OVRCD=0
            MATCH     "1",ALSADELF
            GOTO      ASCOR994 IF NOT EQUAL
          ENDIF
.
          CALL      CLALLSAS
          CALL      MVALSA00
.
          PACK      ALSACDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSACDAT
          CLOCK     TIME,ALSACTIM
          MOVE      USERID,ALSACUID
.
          CALL      WRALSAS1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Update RUG-ADL Score
.
ASCORE90  PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          CALL      RDPMRUG1
          BRANCH    OVRCD,ASCOR995
.
          MATCH     "V",UPDATETY
          IF        !@EQUAL
             PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
             CALL      RDALSAS1
             BRANCH    OVRCD,ASCOR995
          ENDIF
.
          CALL      MVPRUG00
.
          PACK      PMRUUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMRUUDTE
          CLOCK     TIME,PMRUUTIM
          MOVE      USERID,PMRUUUID
          MOVE      SAVKEY02,PMRUADAT
          MOVE      SAVKEY03,PMRUATIM
          TRAP      OVERCOND IF IO
            CALL      UPPMRUG1
            MOVE      PMRUADAT,PMRUG002
            MOVE      PMRUATIM,PMRUG003
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      "Cannot update record. Duplicate date/time.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      ASCOR999
          ENDIF
.
          MATCH     "V",UPDATETY
          IF        !@EQUAL
            PACK      ALSAUDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALSAUDAT
            CLOCK     TIME,ALSAUTIM
            MOVE      USERID,ALSAUUID
            MOVE      SAVKEY02,ALSADATE
            MOVE      SAVKEY03,ALSATIME
            TRAP      OVERCOND IF IO
              CALL      UPALSAS1
              MOVE      ALSADATE,ALSAS002
              MOVE      ALSATIME,ALSAS003
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      "Cannot update record. Duplicate date/time.",WEBTITLE
              CALL      WEBERR00
              MOVE      ONE,EXIT
              GOTO      ASCOR999
            ENDIF
          ENDIF
.
          MOVE      ONE,F1
          CALL      UPPH0000
.
          MATCH     "V",UPDATETY            * Upd RUG-ADL Maintenance Ass Only
          GOTO      ASCOR999 IF EQUAL
.
ASCORE94  MOVE      PMRUG001,ALSAS001
          MOVE      PMRUG002,ALSAS002
          MOVE      PMRUG003,ALSAS003
.
          PACK      KEY24,ALSAS001,ALSAS002,ALSAS003,SP70
          CALL      RDALSAS1
          BRANCH    OVRCD,ASCOR995
.
          CALL      MVALSA00
.
          PACK      ALSAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSAUDAT
          CLOCK     TIME,ALSAUTIM
          MOVE      USERID,ALSAUUID
          MOVE      SAVKEY02,ALSADATE
          MOVE      SAVKEY03,ALSATIME
          TRAP      OVERCOND IF IO
            CALL      UPALSAS1
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      "Cannot update record. Duplicate date/time.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      ASCOR999
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Delete RUG-ADL Score
.
ASCORE95  PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          CALL      RDPMRUG1
          BRANCH    OVRCD,ASCOR995
.
          MOVE      ONE,PMRUDELF            * Set deleted flag to yes
          MOVE      PMRUG024,PMRUDRES
.
          PACK      PMRUDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRUDDAT
          CLOCK     TIME,PMRUDTIM
          MOVE      USERID,PMRUDUID
.
          CALL      UPPMRUG1
.
          MATCH     "W",UPDATETY            * Del RUG-ADL Maintenance Ass Only
          GOTO      ASCOR999 IF EQUAL
.
          MOVE      PMRUG001,ALSAS001
          MOVE      PMRUG002,ALSAS002
          MOVE      PMRUG003,ALSAS003
.
          PACK      KEY24,ALSAS001,ALSAS002,ALSAS003,SP70
          CALL      RDALSAS1
          BRANCH    OVRCD,ASCOR995
.
          MOVE      ONE,ALSADELF            * Set deleted flag to yes
.
          PACK      ALSADDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSADDAT
          CLOCK     TIME,ALSADTIM
          MOVE      USERID,ALSADUID
.
          CALL      UPALSAS1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Add HONOS 65+ Score
.
ASCOR100  PACK      KEY16,MHHON001,Z70
          CALL      RSMHHON1
          CALL      RPMHHON1
          BRANCH    OVRCD,ASCOR101
.
          MATCH     MHHON001,MHHNVISN         * same Visit Number?
          GOTO      ASCOR101 IF NOT EQUAL
          MOVE      MHHNUNIQ,FORM8
.
          ADD       ONE,FORM8                 * get Next Count value
          GOTO      ASCOR102
.
ASCOR101  MOVE      ONE,FORM8
.
ASCOR102  CALL      CLRHON00
          CALL      MVHON000
.
          MOVE      FORM8,MHHNUNIQ
          PACK      MHHNCDTE,CCC,CYY,CMM,CDD
          REP       " 0",MHHNCDTE
          PACK      MHHNCTIM,CTIMEIS
          PACK      MHHNWEBC,USERID
.
          CALL      WRMHHON1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Update HONOS 65+ Score
.
ASCOR105  PACK      KEY16,MHHON001,MHHON002,SP70
          CALL      RDMHHON1
          BRANCH    OVRCD,ASCOR995
.
          CALL      MVHON000
.
          PACK      MHHNDATU,CCC,CYY,CMM,CDD
          REP       " 0",MHHNDATU
          PACK      MHHNTIMU,CTIMEIS
          PACK      MHHNWEBU,USERID
.
          CALL      UPMHHON1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
. Delete HONOS 65+ Score
.
ASCOR110  PACK      KEY16,MHHON001,MHHON002,SP70
          CALL      RDMHHON1
          BRANCH    OVRCD,ASCOR995
.
          MOVE      ONE,MHHNDELF            * Set deleted flag to yes
          MOVE      MHHON096,MHHNDRES
.
          PACK      MHHNDDTE,CCC,CYY,CMM,CDD
          REP       " 0",MHHNDDTE
          CLOCK     TIME,MHHNDTME
          MOVE      USERID,MHHNDUID
.
          CALL      UPMHHON1
.
          MOVE      ZERO,EXIT
          GOTO      ASCOR999
.
ASCOR800  CALL      CURPER00              * Display Routine
          CALL      CALCDT00              * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,ASCOR991
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ASCOR991
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          COMPARE   "3",PVITYPE
          GOTO      ASCOR820 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,ASCOR992
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,ASCOR993
.
          CALL      CLPATMIS                * Clear admission file
          CALL      CLPATDSC                * Clear discharge file
.
          GOTO      ASCOR850
.
ASCOR820  PACK      KEY8,ADMISSNO,SP70      * Patient Admission Details
          CALL      RDMISS1
          BRANCH    OVRCD,ASCOR992
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Admission Details
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
ASCOR850  PACK      KEY24,ALBIA001,ALBIA002,ALBIA003,SP70
          CALL      RDALBIA1
          IF        OVRCD=1
            CALL      CLALLBIA 
          ENDIF
.
          PACK      KEY24,PTFIM001,PTFIM002,PTFIM003,SP70
          CALL      RDPTFIM1
          IF        OVRCD=1
            CALL      CLPATFIM
          ENDIF
.
          PACK      KEY24,PMMMS001,PMMMS002,PMMMS003,SP70
          CALL      RDPMMMS1
          IF        OVRCD=1
            CALL      CLPRUG00
          ENDIF
.
          PACK      KEY24,PMRUG001,PMRUG002,PMRUG003,SP70
          CALL      RDPMRUG1
          IF        OVRCD=1
            CALL      CLPRUG00
          ENDIF
.
          PACK      KEY24,ALSAS001,ALSAS002,ALSAS003,SP70
          CALL      RDALSAS1
          IF        OVRCD=1
            CALL      CLALLSAS
          ENDIF
.
          PACK      KEY16,MHHON001,MHHON002,SP70
          CALL      RDMHHON1
          IF        OVRCD = 1
            CALL      CLRHON00
          ENDIF

          CLEAR     WEBTITLE
          MOVE      "Assessment Scores",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ASCOR999
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR990  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR991  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR992  MOVE      "Assessment List option is not available as no visit has been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR993  MOVE      "Invalid Department.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR994  MATCH     "1",ALBADELF
          IF        @EQUAL
            MOVE      "A Deleted assessment exists for this date/time.",WEBTITLE
          ELSE
            MOVE      "Assessment exists for this date/time.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR995  MOVE      "Invalid assessment record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR996  MOVE      "Admission assessment record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR997  MOVE      "Discharge assessment record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ASCOR999
.
ASCOR999  RETURN
+
.-------------------------------------------------------------------------------
. Update both previous and next phases - wahealth assessment functionality.
. Used in allweb0210017/allweb0210018 (wahealth only)
. No need to check boundaries as this is already done in the front end.
.-------------------------------------------------------------------------------
.
.         Update previous phase end date
.
.-------------------------------------------------------------------------------
UPPH0000  PACK      KEY24,PRVKEY40,SP70
          CALL      RDPMRUG1
          IF        OVRCD=0
.
.           Adding a new Assessment ............................................
.
            IF        F1=ZERO
              MATCH     PMRUG006,SP8                  * If new Start Date exists
              IF        !@EQUAL
                MATCH     PMRUPEDT,SP8                * and prev end date blank
                IF        @EQUAL
                  PACK      PMRUPEDT,PMRUG006,SP70    * move new start > prev end
                  CALL      UPPMRUG1                  * write record
                ENDIF
              ENDIF
              GOTO        UPPH1000                    * Add complete, now check
            ENDIF                                     * next record
.
.           If Updating an existing Assessment .................................
.
            IF        F1=ONE
              MATCH     PMRUG006,SP70                 * if new Start date exists
              IF        !@EQUAL
                MATCH     PMRUPEDT,PMRUG006
                IF        @LESS
                  PACK      PMRUPEDT,PMRUG006,SP70    * overwrite or fill in prev end date
                  CALL      UPPMRUG1                  * write record
                ENDIF
                MATCH     PMRUPEDT,SP8
                IF        @EQUAL
                  PACK      PMRUPEDT,PMRUG006,SP70    * move new end to next start
                  CALL      UPPMRUG1                  * write record
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
.-------------------------------------------------------------------------------
.
.         Update next phase start date
.
.-------------------------------------------------------------------------------
UPPH1000  PACK      KEY24,NXTKEY40,SP70
          CALL      RDPMRUG1
          IF        OVRCD=0
.
.           Adding a new Assessment ............................................
.
            IF        F1=ZERO
              MATCH     PMRUG007,SP8                  * If new end date exists
              IF        !@EQUAL
                MATCH     PMRUPSDT,SP8                * and next start is blank
                IF        @EQUAL
                  PACK      PMRUPSDT,PMRUG007,SP70    * move new end to next start
                  CALL      UPPMRUG1                  * write record
                ENDIF
              ENDIF
              GOTO        UPPH9999
            ENDIF
.
.           If Updating an existing Assessment .................................
.
            IF        F1=ONE
              MATCH     PMRUG007,SP70
              IF        !@EQUAL
                MATCH     PMRUG007,PMRUPSDT
                IF        @LESS
                  PACK      PMRUPSDT,PMRUG007,SP70    * move new end to next start
                  CALL      UPPMRUG1                  * write record
                ENDIF
                MATCH     PMRUPSDT,SP8
                IF        @EQUAL
                  PACK      PMRUPSDT,PMRUG007,SP70    * move new end to next start
                  CALL      UPPMRUG1                  * write record
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
UPPH9999  RETURN
.
.-----------------------------------------------------------------------------
.         ADDPEI00 - Write a new PRS2 inc/exc file record; type 'Include'
.
.         Parameters:
.           ADMISSNO - Admission No
.           HDPEQUIV - HDP Equiv for reason (Cat RN)
.-----------------------------------------------------------------------------
ADDPEI00  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,ADDPEI99
.
          COMPARE   THREE,PVITYPE
          GOTO      ADDPEI99 IF NOT EQUAL   * Not Inpatient visit; don't write
.
          COMPARE   THREE,ASTAT
          GOTO      ADDPEI99 IF NOT EQUAL   * Not discharged; don't write
.
          CALL      RDDSCH1
          BRANCH    OVRCD,ADDPEI99
.
          MATCH     CHCSDTE,DDATE
          GOTO      ADDPEI99 IF LESS        * Discharge date < start HDP date
.
          MATCH     CHCSST,ADATE
          GOTO      ADDPEI99 IF NOT LESS    * Adm date >= PRS2 extract start dte
.
          PACK      KEY16,SP8,ADMISSNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      ADDPEI90 IF NOT EQUAL   * Record exists, don't write
.
          PACK      KEY16,CHCSST,ADMISSNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      ADDPEI90 IF NOT EQUAL   * Record exists, don't write
.
          MOVE      SP8,PTPESTDT
          MOVE      ADMISSNO,PTPEADMN
          MOVE      TWO,PTPESTAT            * 'Include' status
          CALL      IBACLOCK                * Get the current date
          PACK      PTPEDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTPEDATE
          MOVE      USERID,PTPEOPER
.
          MOVE      SP3,PTPERESN
          PACK      KEY5,ANSR,ANSN,SP3
          CALL      RDSCODE1                * Position on & read a codes file
ADDPEI10  CALL      RDKCODE1                  record
          BRANCH    OVRCD,ADDPEI20
.
          MATCH     "RN",TCODE
          GOTO      ADDPEI20 IF NOT EQUAL   * Different category
.
          MATCH     HDPEQUIV,THCSCOD
          GOTO      ADDPEI10 IF NOT EQUAL   * Different HDP equivalent
.
          MOVE      ACODE,PTPERESN
.
ADDPEI20  PACK      KEY16,PTPESTDT,PTPEADMN,SP70
          CALL      WRPTPEI1                * Write a PRS2 inc/exc file record
.
ADDPEI90  MOVE      ZERO,EXIT
.
ADDPEI99  RETURN
+
.-----------------------------------------------------------------------------
. BOKINS00 - Referral Booking Instructions                              
.-----------------------------------------------------------------------------
BOKINS00  MOVE      ZERO,EXIT
          RESET     UPDATETY
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,UPDATETY
          GOTO      BOKINS40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Notes Formaction
          GOTO      BOKINS10 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Notes Formaction
          GOTO      BOKINS30 IF EQUAL
.
          GOTO      BOKINS93
.
.         ************ ADD FORMACTION ***********
.
BOKINS10

          MOVE      ONE,EXIT
          GOTO      BOKINS99
.
.         ************ DELETE FORMACTION **********
.
BOKINS30  

          MOVE      ONE,EXIT
          GOTO      BOKINS99
.
.         ************ DISPLAY FORMACTION **********
.
BOKINS40  MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDVISA1
            IF        OVRCD=1
              CALL      CLPATVIS
            ENDIF

            CALL      RDPMVX11
            IF        OVRCD=1
              CALL      CLPMSVX1
            ENDIF
.
            PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
            CALL      RDALREF1
            IF        OVRCD=0
              CALL      RDALEID1
              IF        OVRCD=1
                CALL      CLALLEID
              ENDIF
            ELSE
              CALL      CLALLREF
              CALL      CLALLEID
.
              MOVE      DOCTCODE,ALREHCP
              MOVE      ALLRF001,ALREDEPT
              MOVE      ALLRF001,DEPTCODE
.
              UNPACK    ALLRF019,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00                      *Set CMON from MTHNAM3
              PACK      ALRERDAT,CCENT,CYEAR,CMON,CDAY
.
              UNPACK    ALLRF039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00                      *Set CMON from MTHNAM3
              PACK      ALREDREC,CCENT,CYEAR,CMON,CDAY
.
              MOVE      ALLRF022,ALRERHCP
              MOVE      ALLRF023,ALRERHCR
              MOVE      ALLRF024,ALRERHCT
              MOVE      ALLRF034,ALRESRCE
              MOVE      ALLRF035,ALRECOMP
              MOVE      ALLRF140,ALREPURC
              MOVE      ALLRF153,ALREORIG
              MOVE      PMSVX010,PMVXINGP
              MOVE      ALDAD001,ALDAFHOS
            ENDIF
.
            PACK      KEY8,ALREVISN
            CALL      RDALAEF1
            IF        OVRCD=1
              CALL      CLALLAEF
            ENDIF
          ELSE
            CALL      CLALLREF
            CALL      CLALLEID
.
            MOVE      DOCTCODE,ALREHCP
            MOVE      ALLRF001,ALREDEPT
            MOVE      ALLRF001,DEPTCODE
.
            UNPACK    ALLRF019,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                      *Set CMON from MTHNAM3
            PACK      ALRERDAT,CCENT,CYEAR,CMON,CDAY
.
            UNPACK    ALLRF039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                      *Set CMON from MTHNAM3
            PACK      ALREDREC,CCENT,CYEAR,CMON,CDAY
.
            MOVE      ALLRF022,ALRERHCP
            MOVE      ALLRF023,ALRERHCR
            MOVE      ALLRF024,ALRERHCT
            MOVE      ALLRF034,ALRESRCE
            MOVE      ALLRF035,ALRECOMP
            MOVE      ALLRF140,ALREPURC
            MOVE      ALLRF153,ALREORIG
            MOVE      PMSVX010,PMVXINGP
            MOVE      ALDAD001,ALDAFHOS
          ENDIF
.
          MOVE      "     1",DIM6
          PACK      KEY17,ADMISSNO,ZERO,ZERO,FIVE,DIM6,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      CLVNOT00     * Clear all the file variables
          ENDIF
.
          MOVE      "Referral Booking Instructions",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,BOKINS99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      BOKINS99
.
BOKINS93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKINS99
.
BOKINS99  RETURN
+
.-----------------------------------------------------------------------------.
. CAFIM000 - Check if admission or discharge assessment already exists
.-----------------------------------------------------------------------------.
CAFIM000  MOVE      ZERO,EXIT
          PACK      KEY24,PTFIM001,SP70
          CALL      RSPTFIM1
CAFIM100  CALL      RKPTFIM1
          BRANCH    OVRCD,CAFIM999
.
          MATCH     "1",PTFIDELT
          GOTO      CAFIM100 IF EQUAL
.
          MATCH     PTFIM001,PTFIVISN
          GOTO      CAFIM999 IF NOT EQUAL
.
          MATCH     PTFIM004,PTFITYPE
          GOTO      CAFIM100 IF NOT EQUAL
.
          MOVE      ONE,EXIT
.
CAFIM999  RETURN
+
.-----------------------------------------------------------------------------.
. Barthel Referral Assessment List
.-----------------------------------------------------------------------------.
BTAB0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALBIA1
BTAB1000  CALL      RKALBIA1
          BRANCH    OVRCD,BTAB9999
.
          MATCH     ADMISSNO,ALBAVISN
          GOTO      BTAB9999 IF NOT EQUAL
.
          MATCH     "1",ALBADELF                 * Deleted
          GOTO      BTAB1000 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    ALBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "Barthel",DISPTYPE
.
          PACK      KEY10,ALBACUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      ALBACUID,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLink('",HTMLLINK
          APPEND    ALBAVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALBATIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSB,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",ALBAVISN,"#",":                   * 1
                             "#"",ALBADATE,"#",":                   * 2
                             "#"",ALBATIME,"#",":                   * 3
                             "#"",ALBADATE,ALBATIME,"#",":          * 4
                             "#"",DISPTYPE,"#",":                   * 5
                             "#"",ALBACDAT,ALBACTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      BTAB1000
.
BTAB9999  RETURN
.
.-----------------------------------------------------------------------------.
. FIM Referral Assessment List
.-----------------------------------------------------------------------------.
FTAB0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
FTAB1000  CALL      RKPTFIM1
          BRANCH    OVRCD,FTAB9999
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      FTAB9999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT                 * Deleted
          GOTO      FTAB1000 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    PTFIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          CLEAR     DISPTYPE
          APPEND    "FIM",DISPTYPE
.
          MATCH     "A",PTFITYPE
          IF        @EQUAL
            APPEND    " - Admission",DISPTYPE
          ENDIF
.
          MATCH     "D",PTFITYPE
          IF        @EQUAL
            APPEND    " - Discharge",DISPTYPE
          ENDIF
.
          MATCH     "P",PTFITYPE
          IF        @EQUAL
            APPEND    " - Progress",DISPTYPE
          ENDIF
.
          MATCH     "V",PTFITYPE
          IF        @EQUAL
            APPEND    " - VINAH",DISPTYPE
          ENDIF
.
          RESET     DISPTYPE
.
          PACK      KEY10,PTFICUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTFICUID,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLink('",HTMLLINK
          APPEND    PTFIVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTFITIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSF,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",PTFIVISN,"#",":                   * 1
                             "#"",PTFIDATE,"#",":                   * 2
                             "#"",PTFITIME,"#",":                   * 3
                             "#"",PTFIDATE,PTFITIME,"#",":          * 4
                             "#"",DISPTYPE,"#",":                   * 5
                             "#"",PTFICDAT,PTFICTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      FTAB1000
.
FTAB9999  RETURN
.
.-----------------------------------------------------------------------------.
. PC Referral Assessment List
.-----------------------------------------------------------------------------.
CTAB0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALSAS1
CTAB1000  CALL      RKALSAS1
          BRANCH    OVRCD,CTAB9999
.
          MATCH     ADMISSNO,ALSAVISN
          GOTO      CTAB9999 IF NOT EQUAL
.
          MATCH     "1",ALSADELF                 * Deleted
          GOTO      CTAB1000 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    ALSADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "PCPSS",DISPTYPE
.
          PACK      KEY10,ALSACUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      ALSACUID,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLink('",HTMLLINK
          APPEND    ALSAVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALSATIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSP,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",ALSAVISN,"#",":                   * 1
                             "#"",ALSADATE,"#",":                   * 2
                             "#"",ALSATIME,"#",":                   * 3
                             "#"",ALSADATE,ALSATIME,"#",":          * 4
                             "#"",DISPTYPE,"#",":                   * 5
                             "#"",ALSACDAT,ALSACTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      CTAB1000
.
CTAB9999  RETURN
.
.-----------------------------------------------------------------------------.
. AIMS Pain Assessment List
.-----------------------------------------------------------------------------.
ATAB0000  MOVE      "014",KEY3
          PACK      KEY35,URNUMBER,ADMISSNO,KEY3,SP70
          CALL      RSPTATR3
ATAB1000  CALL      RKPTATR3
          BRANCH    OVRCD,ATAB9999
.
          MATCH     URNUMBER,PTARURNO
          GOTO      ATAB9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      ATAB9999 IF NOT EQUAL
.
          MATCH     "014",PTARTYPE
          GOTO      ATAB9999 IF NOT EQUAL
.
          MATCH     "1",PTARDELR                 * Deleted
          GOTO      ATAB1000 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "AIMS CLiP",DISPTYPE
.
          PACK      KEY10,PTARCUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTARCUSR,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLink('",HTMLLINK
          APPEND    PTARVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTARTIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSA,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",PTARVISN,"#",":                   * 1
                             "#"",PTARDATE,"#",":                   * 2
                             "#"",PTARTIME,"#",":                   * 3
                             "#"",PTARDATE,PTARTIME,"#",":          * 4
                             "#"",DISPTYPE,"#",":                   * 5
                             "#"",PTARCDTE,PTARCTME,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      ATAB1000
.
ATAB9999  RETURN

.-----------------------------------------------------------------------------.
. AIMS Breathlessness Assessment List
.-----------------------------------------------------------------------------.
BCTBL000  MOVE      "017",KEY3
          PACK      KEY35,URNUMBER,ADMISSNO,KEY3,SP70
          CALL      RSPTATR3
BCTBL100  CALL      RKPTATR3
          BRANCH    OVRCD,BCTBL999
.
          MATCH     URNUMBER,PTARURNO
          GOTO      BCTBL999 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      BCTBL999 IF NOT EQUAL
.
          MATCH     "017",PTARTYPE
          GOTO      BCTBL999 IF NOT EQUAL
.
          MATCH     "1",PTARDELR                 * Deleted
          GOTO      BCTBL100 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "AIMS CLiB",DISPTYPE
.
          PACK      KEY10,PTARCUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTARCUSR,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLink('",HTMLLINK
          APPEND    PTARVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTARTIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSC,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",PTARVISN,"#",":                   * 1
                             "#"",PTARDATE,"#",":                   * 2
                             "#"",PTARTIME,"#",":                   * 3
                             "#"",PTARDATE,PTARTIME,"#",":          * 4
                             "#"",DISPTYPE,"#",":                   * 5
                             "#"",PTARCDTE,PTARCTME,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      BCTBL100
.
BCTBL999  RETURN

.-----------------------------------------------------------------------------.
. HONOS Assessment List
.-----------------------------------------------------------------------------.
HTAB0000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSMHHON1
HTAB1000  CALL      RKMHHON1
          BRANCH    OVRCD,HTAB9999
.
          MATCH     ADMISSNO,MHHNVISN
          GOTO      HTAB9999 IF NOT EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    MHHNHDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "HONOS",DISPTYPE
.
          PACK      KEY10,MHHNWEBC,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      MHHNWEBC,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLink('",HTMLLINK
          APPEND    MHHNVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHHNUNIQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHHNCTIM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSH,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",MHHNVISN,"#",":                   * 1
                             "#"",MHHNHDAT,"#",":                   * 2
                             "#"",MHHNCTIM,"#",":                   * 3
                             "#"",MHHNHDAT,MHHNCTIM,"#",":          * 4
                             "#"",DISPTYPE,"#",":                   * 5
                             "#"",MHHNCDTE,MHHNCTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      HTAB1000
.
HTAB9999  RETURN
.
.******************************************************************************
. WA Health Assessment List
.******************************************************************************
WAHAS000  PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WAHAS999
.
          COMPARE   FOUR,TCFORM6
          IF        @EQUAL
            CALL      GTABW000
            GOTO      WAHAS999
          ENDIF
.
          COMPARE   SEVEN,TCFORM6
          IF        @EQUAL
.           CALL      CTABW000
            CALL      RTABW000
            GOTO      WAHAS999
          ENDIF
.
          COMPARE   EIGHT,TCFORM6
          IF        @EQUAL
            CALL      GTABW000
            CALL      MTABW000
            GOTO      WAHAS999
          ENDIF
.
          COMPARE   NINE,TCFORM6
          IF        @EQUAL
            CALL      HTABW000
            GOTO      WAHAS999
          ENDIF
.
          COMPARE   TEN,TCFORM6
          IF        @EQUAL
            CALL      RTABW000
            GOTO      WAHAS999
          ENDIF
.
WAHAS999  RETURN  
.
.******************************************************************************
. QLD Health Assessment List
.******************************************************************************
QLHAS000  PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,QLHAS999
.
          IF        (PTCNHDPS=4 & PTCNQLDB=6)
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,QLHAS999
          ENDIF
.
          MATCH     "09",THCSCOD
          IF        @EQUAL
            CALL      GTABW000
            GOTO      QLHAS999
          ENDIF
.
          MATCH     "10",THCSCOD
          IF        @EQUAL
            CALL      HTABW000
            GOTO      QLHAS999
          ENDIF
.
          MATCH     "20",THCSCOD
          IF        @EQUAL
            CALL      GTABW000
            GOTO      QLHAS999
          ENDIF
.
QLHAS999  RETURN
+
.-----------------------------------------------------------------------------.
. GEM/FIM Referral Assessment List
.-----------------------------------------------------------------------------.
GTABW000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
GTABW100  CALL      RKPTFIM1
          BRANCH    OVRCD,GTABW999
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      GTABW999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT                 * Deleted
          GOTO      GTABW100 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    PTFIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GTABW999
.
          MOVE      ONE,D1
          CLEAR     DISPTYP2
.
          IF        PTCNHDPS=4
            IF        PTCNQLDB=6
              PACK      KEY5,ANSA,SP1,ATYPE,SP70
              CALL      RDCODE1
            ENDIF
            MATCH     "09",THCSCOD
            IF        @EQUAL
              MATCH     "G",PTFITYPE
              IF        @EQUAL
                APPEND    "GEM",DISPTYP2
                GOTO      GTABW200
              ENDIF
            ENDIF
.
            MATCH     "20",THCSCOD
            IF        @EQUAL
              APPEND    "REH",DISPTYP2
              GOTO      GTABW110
            ENDIF
          ENDIF
.
          COMPARE   EIGHT,TCFORM6
          IF        @EQUAL
            MATCH     "G",PTFITYPE
            IF        @EQUAL
              APPEND    "GEM",DISPTYP2
            ENDIF
          ELSE
            MATCH     "R",PTFITYPE
            IF        @EQUAL
              APPEND    "Rehabilitation",DISPTYP2
              MOVE      "7",D1
            ENDIF
          ENDIF
          GOTO      GTABW200
.
GTABW110  MATCH     "A",PTFITYPE
          IF        @EQUAL
            APPEND    " - Admission",DISPTYP2
          ENDIF
.
          MATCH     "D",PTFITYPE
          IF        @EQUAL
            APPEND    " - Discharge",DISPTYP2
          ENDIF
.
          MATCH     "P",PTFITYPE
          IF        @EQUAL
            APPEND    " - Progress",DISPTYP2
          ENDIF
.
          MATCH     "V",PTFITYPE
          IF        @EQUAL
            APPEND    " - VINAH",DISPTYP2
          ENDIF
          RESET DISPTYP2
.
GTABW200  PACK      KEY10,PTFICUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTFICUID,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLinkWAH('",HTMLLINK
          APPEND    PTFIVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTFITIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    D1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SUPERLEV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",PTFIVISN,"#",":                   * 1
                             "#"",PTFIDATE,"#",":                   * 2
                             "#"",PTFITIME,"#",":                   * 3
                             "#"",PTFIDATE,PTFITIME,"#",":          * 4
                             "#"",DISPTYP2,"#",":                   * 5
                             "#"",PTFICDAT,PTFICTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      GTABW100
.
GTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. MMS Referral Assessment List
.-----------------------------------------------------------------------------.
MTABW000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMMMS1
MTABW100  CALL      RKPMMMS1
          BRANCH    OVRCD,MTABW999
.
          MATCH     ADMISSNO,PMMMVISN
          GOTO      MTABW999 IF NOT EQUAL
.
          MATCH     "1",PMMMDELF                 * Deleted
          GOTO      MTABW100 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    PMMMADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "SMMSE",DISPTYP2
.
          PACK      KEY10,PMMMCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMMMCUID,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLinkWAH('",HTMLLINK
          APPEND    PMMMVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMMMATIM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TWO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SUPERLEV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",PMMMVISN,"#",":                   * 1
                             "#"",PMMMADAT,"#",":                   * 2
                             "#"",PMMMATIM,"#",":                   * 3
                             "#"",PMMMADAT,PMMMATIM,"#",":          * 4
                             "#"",DISPTYP2,"#",":                   * 5
                             "#"",PMMMCDAT,PMMMCTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      MTABW100
.
MTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. RUG-ADL Referral Assessment List (Maintenance/Palliative)
.-----------------------------------------------------------------------------.
RTABW000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMRUG1
RTABW100  CALL      RKPMRUG1
          BRANCH    OVRCD,RTABW999
.
          MATCH     ADMISSNO,PMRUVISN
          GOTO      RTABW999 IF NOT EQUAL
.
          MATCH     "1",PMRUDELF                 * Deleted
          GOTO      RTABW100 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    PMRUADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          PACK      KEY10,PMRUCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMRUCUID,WBSENAM
          ENDIF
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RTABW999
.
          COMPARE   SEVEN,TCFORM6 
          IF        @EQUAL
            MATCH     "0",PMRUATYP
            IF        @EQUAL
              MOVE      "Palliative",DISPTYP2
              MOVE      THREE,D1
              GOTO      RTABW500
            ENDIF
          ENDIF
.
          COMPARE   TEN,TCFORM6 
          IF        @EQUAL
            MATCH     "1",PMRUATYP
            IF        @EQUAL
              MOVE      "Maintenance",DISPTYP2
              MOVE      FIVE,D1
              GOTO      RTABW500
            ENDIF
          ENDIF
.
          GOTO      RTABW100
.
RTABW500  CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLinkWAH('",HTMLLINK
          APPEND    PMRUVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMRUATIM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    D1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SUPERLEV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",PMRUVISN,"#",":                   * 1
                             "#"",PMRUADAT,"#",":                   * 2
                             "#"",PMRUATIM,"#",":                   * 3
                             "#"",PMRUADAT,PMRUATIM,"#",":          * 4
                             "#"",DISPTYP2,"#",":                   * 5
                             "#"",PMRUCDAT,PMRUCTIM,"#",":          * 6
                             "#"",WBSENAM,"#",";                    * 7
.
          MATCH     "1",PMRUASSO
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",YES,"#",";
          ELSE
            MATCH     "2",PMRUASSO
            IF        @EQUAL
              WRITE     HTMLFILE;"#"",NO,"#",";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#"",PMRUPSDT,"#",";
.
          WRITE     HTMLFILE;"#"",PMRUPEDT,"#",";
.
          PACK      KEY5,CATpu,PMRUPTYP
          CALL      RDCODE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"#"",TDESC,"#");"
          ELSE
            WRITE     HTMLFILE;"#"",PMRUPTYP,"#");"
          ENDIF
.
          GOTO      RTABW100
.
RTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. PC Referral Assessment List
.-----------------------------------------------------------------------------.
CTABW000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALSAS1
CTABW100  CALL      RKALSAS1
          BRANCH    OVRCD,CTABW999
.
          MATCH     ADMISSNO,ALSAVISN
          GOTO      CTABW999 IF NOT EQUAL
.
          MATCH     "1",ALSADELF                 * Deleted
          GOTO      CTABW100 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    ALSADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "PCPSS",DISPTYP2
.
          PACK      KEY10,ALSACUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      ALSACUID,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLinkWAH('",HTMLLINK
          APPEND    ALSAVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALSATIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    FOUR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SUPERLEV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",ALSAVISN,"#",":                   * 1
                             "#"",ALSADATE,"#",":                   * 2
                             "#"",ALSATIME,"#",":                   * 3
                             "#"",ALSADATE,ALSATIME,"#",":          * 4
                             "#"",DISPTYP2,"#",":                   * 5
                             "#"",ALSACDAT,ALSACTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      CTABW100
.
CTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. HONOS Assessment List
.-----------------------------------------------------------------------------.
HTABW000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSMHHON1
HTABW100  CALL      RKMHHON1
          BRANCH    OVRCD,HTABW999
.
          MATCH     ADMISSNO,MHHNVISN
          GOTO      HTABW999 IF NOT EQUAL
.
          MATCH     "1",MHHNDELF                 * Deleted
          GOTO      HTABW100 IF EQUAL
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    MHHNHDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      "Psychogeriatric",DISPTYP2
.
          PACK      KEY10,MHHNWEBC,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      MHHNWEBC,WBSENAM
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "AssessLinkWAH('",HTMLLINK
          APPEND    MHHNVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHHNUNIQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHHNHDAT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SIX,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SUPERLEV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",MHHNVISN,"#",":                   * 1
                             "#"",MHHNHDAT,"#",":                   * 2
                             "#"",MHHNCTIM,"#",":                   * 3
                             "#"",MHHNHDAT,"#",":                   * 4
                             "#"",DISPTYP2,"#",":                   * 5
                             "#"",MHHNCDTE,MHHNCTIM,"#",":          * 6
                             "#"",WBSENAM,"#"":                     * 7
                             ");"
          GOTO      HTABW100
.
HTABW999  RETURN
.
.-----------------------------------------------------------------------------.
. Check if a referral has any assessments
.-----------------------------------------------------------------------------.
CASS0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALBIA1
CASS1000  CALL      RKALBIA1               * Bartel
          BRANCH    OVRCD,CASS3000
.
          MATCH     ADMISSNO,ALBAVISN
          GOTO      CASS3000 IF NOT EQUAL
.
          MATCH     "1",ALBADELF           * Deleted
          GOTO      CASS1000 IF EQUAL
.
          GOTO      CASS8000
.
CASS3000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
CASS4000  CALL      RKPTFIM1               * Bartel
          BRANCH    OVRCD,CASS5000
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      CASS5000 IF NOT EQUAL
.                            
          MATCH     "1",PTFIDELT           * Deleted                
          GOTO      CASS4000 IF EQUAL
.                            
          GOTO      CASS8000
.
CASS5000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALSAS1
CASS6000  CALL      RKALSAS1               * Bartel
          BRANCH    OVRCD,CASS9000
.
          MATCH     ADMISSNO,ALSAVISN
          GOTO      CASS9000 IF NOT EQUAL
.
          MATCH     "1",ALSADELF           * Deleted
          GOTO      CASS6000 IF EQUAL
.                                          
CASS8000  WRITE     HTMLFILE;ONE;           * Yes
          GOTO      CASS9999
.
CASS9000  WRITE     HTMLFILE;ZERO;          * No
          GOTO      CASS9999
.
CASS9999  RETURN
.
.-----------------------------------------------------------------------------.
. Count assessments for a referral
.-----------------------------------------------------------------------------.
CNTA0000  MOVE      ZERO,F3
.
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSALBIA1
CNTA1000  CALL      RKALBIA1               * Bartel
          BRANCH    OVRCD,CNTA3000
.
          MATCH     ADMISSNO,ALBAVISN
          GOTO      CNTA3000 IF NOT EQUAL
.
          MATCH     "1",ALBADELF           * Deleted
          GOTO      CNTA1000 IF EQUAL
.
          ADD       ONE,F3
          GOTO      CNTA1000
.
CNTA3000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
CNTA4000  CALL      RKPTFIM1               * Bartel
          BRANCH    OVRCD,CNTA5000
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      CNTA5000 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT           * Deleted
          GOTO      CNTA4000 IF EQUAL
.
          ADD       ONE,F3
          GOTO      CNTA4000
.
CNTA5000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALSAS1
CNTA6000  CALL      RKALSAS1               * Bartel
          BRANCH    OVRCD,CNTA9000
.
          MATCH     ADMISSNO,ALSAVISN
          GOTO      CNTA9000 IF NOT EQUAL
.
          MATCH     "1",ALSADELF           * Deleted
          GOTO      CNTA6000 IF EQUAL
.
          ADD       ONE,F3
          GOTO      CNTA6000
.
CNTA9000  WRITE     HTMLFILE;F3;           * Count
          GOTO      CNTA9999
.
CNTA9999  RETURN
.
.******************************************************************************
. Transfer a Referral                                                         *
.******************************************************************************
TRNREF00  MATCH     SP70,DEPTCODE
          GOTO      TRNREF91 IF EQUAL       * Department code is blank
.
          MATCH     SP70,URNUMBER
          GOTO      TRNREF92 IF EQUAL       * U/R Number is blank
.
          MATCH     SP70,ADMISSNO
          GOTO      TRNREF93 IF EQUAL       * Visit/Reff is blank
.
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,TRNREF91
.                                                            * start  *I-232086
          MOVE      SP10,ALDEHOSP
          IF        IBCNMHOS=1
            PACK      KEY3,DEPTCODE,SP10
            CALL      RDALDEP1
          ENDIF                                              * end    *I-232086
.
          PACK      KEY8,ADMISSNO,SP70
TRNREF10  CALL      RLALREF1                * read lock
          BRANCH    OVRCD,TRNREF93,TRNREF90
.
          MOVE      ALREDEPT,SAVEDEPT
          MOVE      ALREHCP,SAVEHCP  
          MOVE      ALREUHC4,SAVEUHC4
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          CALL      ARMHI000                * Set to 'Unsent' - MHINC extract
.
          MATCH     DEPTCODE,SAVEDEPT
          IF        !@EQUAL
            MOVE      DEPTCODE,ALREDEPT     * Deptcode
            MATCH     SP3,ALDEHOSP
            IF        !@EQUAL
              MOVE      ALDEHOSP,ALREHOSN   * Hospital code
            ENDIF                                             * end   *I-232086
          ENDIF
.
          MATCH     ALREF038,Z70
          IF        !@EQUAL
            MOVE      ALREF038,ALREHCP      * Responsible HCP
          ENDIF
.
          MATCH     ALREF087,Z70
          IF        !@EQUAL
            MOVE      ALREF087,ALREUHC4     * Case Team
          ENDIF
.
          MATCH     ALREF106,Z70
          IF        !@EQUAL
            MOVE      ALREF106,ALRECTYP     * Clinic Type 
          ENDIF
.
          MATCH     ALREF107,Z70
          IF        !@EQUAL
            MOVE      ALREF107,ALREHOSN     * Preferred Hospital
          ENDIF
.
          MATCH     ALREF117,Z70
          IF        !@EQUAL
            MOVE      ALREF117,ALRESTYP     * Slot Type
          ENDIF
.
          MATCH     ALREF119,Z70
          IF        !@EQUAL
            MOVE      ALREF119,ALREPSIT     * Preferred Site
          ENDIF
.
          MATCH     ALREF120,Z70
          IF        !@EQUAL
            MOVE      ALREF120,ALRECLID     * Clinic Id
          ENDIF
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD * Populate date record updated
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      UPALREF1                * Update the record
          CALL      UUALREF1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11                 * Read visit extension
          IF        OVRCD=0
            MOVE      ALREHOSN,PMVXMHOS      * Update preferred hospital
            CALL      UPPMVX11
          ENDIF
.
          MATCH     "1",ALCNUPAR
          IF        @EQUAL
            CALL      UPOART00            * update appointment request
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RLALEID1                * Read the Extra Inbound Data table
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
            CALL      UUALEID1              * Unlock Record
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          MATCH     SAVEDEPT,ALREDEPT
          IF        !@EQUAL
            MOVE      "P ",UPDTTYPE                  * Department transfer audit
            PACK      COMMENTY,SAVEDEPT,SPACETOS,ALREDEPT
            CALL      WRTRAT00
          ENDIF
.
          MATCH     SAVEHCP,ALREHCP
          IF        !@EQUAL
            MOVE      "H ",UPDTTYPE                  * Responsible HCP audit
            PACK      COMMENTY,SAVEHCP,SPACETOS,ALREHCP
            CALL      WRTRAT00
          ENDIF
.
          MATCH     SAVEUHC4,ALREUHC4
          IF        !@EQUAL
            MOVE      "S ",UPDTTYPE                  * Case team audit
            PACK      COMMENTY,SAVEUHC4,SPACETOS,ALREUHC4
            CALL      WRTRAT00
          ENDIF
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
TRNREF89  MOVE      ZERO,EXIT
          GOTO      TRNREF99
.
TRNREF90  ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            DISPLAY   *W
            GOTO      TRNREF10
          ENDIF
.
          MOVE      "Referral Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNREF99
.
TRNREF91  MOVE      "Department does not exist/blank/Invalid ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNREF99
.
TRNREF92  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNREF99
.
TRNREF93  MOVE      "Invalid Referral / Visit",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNREF99
.
TRNREF99  RETURN
.
.-------------------------------------------------------------------------------
. to update department required (otaradep) with department to when it matches
. the department from field
.-------------------------------------------------------------------------------
UPOART00  PACK      KEY32,ALREURNO,ALREVISN,Z70
          CALL      RSOTART1                * positional read
UPOART10  CALL      RPOTART1                * read a record
          BRANCH    OVRCD,UPOART99
.
          MATCH     ALREURNO,OTARURNO       * same ur number
          GOTO      UPOART99 IF NOT EQUAL
.
          MATCH     ALREVISN,OTARREFN       * same referral/visit
          GOTO      UPOART99 IF NOT EQUAL
.
          MATCH     "0",OTARSTAT
          GOTO      UPOART10 IF NOT EQUAL
.
          MATCH     SAVEDEPT,OTARADEP
          GOTO      UPOART10 IF NOT EQUAL
.
          MOVE      ALREDEPT,OTARADEP
          CALL      UPOTART1
.
          GOTO      UPOART10
.
UPOART99  RETURN
.
.******************************************************************************
. Write a record to the Referral Audit Table. The audit time will be 
. increased by 1 second if a record exists for the currect date and time
. Requires: UPDTTYPE: update type for allaudaf
.******************************************************************************
WRTRAT00  CALL      CLALLAUD                     * clear allaudaf variables
.
          MOVE      ALREVISN,ALAUVISN
          PACK      ALAUADAT,CCC,CYY,CMM,CDD
          REP       " 0",ALAUADAT
          CLOCK     TIME,ALAUATIM
          MOVE      UPDTTYPE,ALAUUPDT
          MOVE      WBSEUID,ALAUAUID
.
          MOVE      ZERO,TIMELOOP
.         
          MATCH     SP70,ACTNCODE
          IF        !@EQUAL
            MOVE      ACTNCODE,ALAUACTI
          ENDIF
.
          MATCH     SP70,COMMENTY
          IF        !@EQUAL
            MOVE      COMMENTY,ALAUCOMM
          ENDIF
.
          PACK      AUDITKEY,ALAUVISN,ALAUADAT,ALAUATIM,SP70
WRTRAT50  PACK      KEY24,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          CALL      RAALAUD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRALAUD1                * write to the file
            TRAPCLR   IO
            BRANCH    OVRCD,WRTRAT99
          ELSE
            IF        TIMELOOP<=5
              ADD       ONE,TIMELOOP
            ELSE
              GOTO       WRTRAT99
            ENDIF
.
            UNPACK    ALAUATIM,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,ALAUADAT,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,ALAUADAT,HOUR,MIN,SEC
            PACK      ALAUATIM,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRTRAT50
          ENDIF
WRTRAT99  RETURN
.
.*****************************************************************************
.*                            ASEC0000                                       *
.*               Add one second to date/time                                 *
.* Requires: XDATTIME - Date/time value (ccyymmddhhmmss)                     *
.* Returns : XDATTIME - Date/time value (ccyymmddhhmmss) incremented by 1 sec*
.*****************************************************************************
ASEC0000  UNPACK    XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
          MATCH     "59",SECTIME
          IF        !@EQUAL
            MOVE      SECTIME,FORM2              * just increment seconds
            ADD       ONE,FORM2
            MOVE      FORM2,SECTIME
            REP       " 0",SECTIME
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The seconds were "59", so reset these to "00" and increment the
.         minutes
.
          MOVE      "00",SECTIME
          MATCH     "59",MINTIME
          IF        !@EQUAL
            MOVE      MINTIME,FORM2              * just increment minutes
            ADD       ONE,FORM2
            MOVE      FORM2,MINTIME
            REP       " 0",MINTIME
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The minutes were "59", so reset these to "00" and increment the
.         hours
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MATCH     "23",HOURTM
          IF        !@EQUAL
            MOVE      HOURTM,FORM2              * just increment hours
            ADD       ONE,FORM2
            MOVE      FORM2,HOURTM
            REP       " 0",HOURTM
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The hours were "59", so reset these to "00" and increment the
.         date
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MOVE      "00",HOURTM
.
.         We need to increment the date by 1 day
.
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON                       * get julian day
          ADD       ONE,JULDAY                   * increment julian day
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON                       * get new date
          PACK      XDATTIME,CC,YY,MM,DD,ZERO6
          REP       " 0",XDATTIME
.
ASEC9999  RETURN
+
+
.******************************************************************************
.         ATCD0000 - Add transition care date
.******************************************************************************
.
ATCD0000  PACK      KEY13,ADMISSNO,ZERO,FIVE,Z70
          CALL      RSALRHL1
          CALL      RPALRHL1
          BRANCH    OVRCD,ATCD2000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      ATCD2000 IF NOT EQUAL
.
          MATCH     "05",ALRHTYPE
          GOTO      ATCD2000 IF NOT EQUAL
.
          GOTO      ATCD3000
.
ATCD2000  MOVE      ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
          GOTO      ATCD4000
.
ATCD3000  MOVE      ALRHUNIQ,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
.
ATCD4000  MOVE      DIAGCODE,ALRHCODE
          MOVE      DIAGDATE,ALRHDATE
          MOVE      ADMISSNO,ALRHVISN
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
          MOVE      SP70,ALRHCOD2
.
          MOVE      "05",ALRHTYPE
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      RAALRHL1
          IF        OVRCD=1
            CALL      WRALRHL1
          ENDIF
.
ATCD9999  RETURN
+
.******************************************************************************
.         RTCD0000 - Transition care date removal
.******************************************************************************
RTCD0000  PACK      KEY13,ADMISSNO,ZERO,FIVE,UNIQCODE,SP70
          CALL      RDALRHL1
          BRANCH    OVRCD,RTCD9000
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      DEALRHL1
.
          GOTO      RTCD9999
.
RTCD9000  MOVE     "Invalid Transition Care Date Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RTCD9999
.
RTCD9999  RETURN
+
.******************************************************************************
.         UTCD0000 - Update transition care date
.******************************************************************************
UTCD0000  PACK      KEY13,ADMISSNO,ZERO,FIVE,UNIQCODE,SP70
          CALL      RDALRHL1
          BRANCH    OVRCD,UTCD9999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,UTCD9999
.
          CLOCK     TIME,CTIMEIS
          PACK      CDATE,CCC,CYY,CMM,CDD
          REP       " 0",CDATE
          MOVE      ZERO,EXIT
.
          MATCH     "4",ALRESTAT            * Cancelled(4) referral
          GOTO      UTCD8000 IF EQUAL
.
          MATCH     ALRERDAT,DIAGDATE
          GOTO      UTCD8100 IF LESS
.
          MOVE      ALRESTAT,F1
          ADD       ONE,F1
          BRANCH    F1,UTCD1000,UTCD2000,UTCD3000,UTCD4000,UTCD9999,UTCD5000
          GOTO      UTCD9999
.
UTCD1000
UTCD2000  MATCH     DIAGDATE,CDATE          * Same for Active(1)
          GOTO      UTCD82000 IF LESS
.
          GOTO      UTCD6000
.                                           * Referral Closed (2)
UTCD3000  MATCH     DIAGDATE,ALREDCLO       * Check closed date
          GOTO      UTCD8300 IF LESS
.
          GOTO      UTCD6000
.                                           * Referral Inactive(3)
UTCD4000  MATCH     DIAGDATE,ALREDINA       * Check inactive code
          GOTO      UTCD8400 IF LESS
.
          GOTO      UTCD6000
.
UTCD5000  MATCH     DIAGDATE,ALRESRDT       * Referral Rejected(5)
          GOTO      UTCD8500 IF LESS
.
          GOTO      UTCD6000
.
UTCD6000  MOVE      DIAGDATE,ALRHDATE
          CALL      UPALRHL1
          GOTO      UTCD9999
.
UTCD8000  MOVE     "Cannot be added to a cancelled referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UTCD9999
.
UTCD8100  MOVE      "Date must be greater than referral date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UTCD9999
.
UTCD8200  MOVE      "Date should not be in future.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UTCD9999
.
UTCD8300  MOVE      "Date must be less than closed referral date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UTCD9999
.
UTCD8400  MOVE      "Date must less than inactive date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UTCD9999
.
UTCD8500  CLEAR     WEBTITLE
          APPEND    "Date must less than ",WEBTITLE
          APPEND    "rejected date. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UTCD9999
.
UTCD9999  RETURN
+
.-----------------------------------------------------------------------------
.         If patient changed to non-comp. claim, delete any claim details
.-----------------------------------------------------------------------------
.
.         Set the claim type indicator if this is a claim
.
DOCLMN00  MATCH     "1",PTCNXCOM
          IF        @EQUAL
            CALL      CPRA0000                * check if we need to update PRFA
            GOTO      DOCLMN99
          ENDIF
.
          PACK      KEY5,CATCL,ALRECOMP
          CALL      RDCODE1
          BRANCH    OVRCD,DOCLMN99
.
.         Check the indicators for a C, M, V or W (these are the claims)
.
          MOVE      ZERO,FORM2
DOCLMN10  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      DOCLMN90 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "M",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "V",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "C",ANS
          GOTO      DOCLMN99 IF EQUAL
          GOTO      DOCLMN10
.
DOCLMN90  OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PMSCTCA1,"pmsctcaf"
.
          CALL      DEWCOM00         * Delete Workers Comp.
          CALL      DEWMAB00         * Delete TAC
          CALL      DEWVET00         * Delete Veteran affairs
          CALL      DEWCTC00         * Delete Civil Tort
.
DOCLMN99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Workers comp. details
.-----------------------------------------------------------------------------
.
DEWCOM00  COMPARE   ONE,PTCNHDPS           * Is it for NZ?
          GOTO      DEWCOM10 IF NOT EQUAL  * Not NZ; proceed to delete WC record
.
          MOVE      ALREURNO,CHWCURNO
          MOVE      ALREVISN,CHWCADMN
          PROC      CHKWCCLM           * check for multiple WC claims records
          BRANCH    EXIT,DEWCOM10
.
.         Only one record with the ACC number, so we just update the
.         Claim Status to "Cancelled" instead of deleting the patwc1af record.
.
          COMPARE   ONE,FORM1            * one record found in CHKWCCLM
          IF        @EQUAL
            MOVE      ALREVISN,KEY8
            CALL      RDPMWX11
            BRANCH    OVRCD,DEWCOM99
.
            MOVE      THREE,PMWXCSTA     * set Claim Status to "Cancelled"
            CALL      UPPMWX11
          ENDIF
.
          CALL      MVACCREM           * Add record ACC Audit file
          GOTO      DEWCOM99
.
DEWCOM10  MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            IF        PTCNHDPS=1            
              CALL      MVACCREM           * Add record ACC Audit file
            ENDIF
            CALL      DEWCOM1
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWX11
          COMPARE   ZERO,OVRCD
          CALL      DEPMWX11 IF EQUAL
.
DEWCOM99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete TAC details
.-----------------------------------------------------------------------------
.
DEWMAB00  MOVE      ADMISSNO,KEY8
          CALL      RDWMAB1
          COMPARE   ZERO,OVRCD
          CALL      DEWMAB1 IF EQUAL
.
DEWMAB99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Veteran Affairs details
.-----------------------------------------------------------------------------
.
DEWVET00  MOVE      ADMISSNO,KEY8
          CALL      RDWVET1
          COMPARE   ZERO,OVRCD
          CALL      DEWVET1 IF EQUAL
.
DEWVET99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Civil Tort details
.-----------------------------------------------------------------------------
.
DEWCTC00  MOVE      ADMISSNO,KEY8
          CALL      RDPMCTC1
          COMPARE   ZERO,OVRCD
          CALL      DEPMCTC1 IF EQUAL
.
DEWCTC99  RETURN
.
.-----------------------------------------------------------------------------
. Add record to ACC Audit file when patient changed to non-comp. claim
.-----------------------------------------------------------------------------
MVACCREM  PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,MVACCR99
.
          CALL      CLACCAUD
          MATCH     WCCLMNO,Z70
          IF        !@EQUAL
            MOVE      WCCLMNO,ACAUCLMN              * Claim Number
          ENDIF
.
          CALL      IBACLOCK
          PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",ACAUDATE
          MOVE      CTIMEIS,ACAUTIME
          MOVE      USERID,ACAUWUID                 * Web UserId
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN             * Admission No
          ENDIF
.
          MOVE      "D",ACAUAUTY                    * Audit Type
          MOVE      "A",ACAUTREC                    * ACC Type of Record
.
MVACCR10  PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
          CALL      RAACAUD1
          IF        OVRCD=1
            CALL      WRACAUD1
            GOTO      MVACCR99
          ELSE
            CALL      IBACLOCK                    * Set new date and time and
            PACK      ACAUDATE,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",ACAUDATE
            CLOCK     TIME,CTIMEIS
            PACK      ACAUTIME,CTIMEIS
            REP       " 0",ACAUTIME
            GOTO      MVACCR10
          ENDIF
.
MVACCR99  RETURN
.------------------------------------------------------------
.         Check if we need to update PRFA
.------------------------------------------------------------
CPRA0000  PACK      KEY5,ANSC,ANSL,ALRECOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CPRA9999
.
          MOVE      SP70,DIM1
          MOVE      TCINDC1,DIM1
          REP       "P~J~ ~",DIM1
          MATCH     "~",DIM1
          GOTO      CPRA1000 IF EQUAL        * Public
.
          MATCH     "E",DIM1
          GOTO      CPRA9999 IF NOT EQUAL
.
          MOVE      "7",KEY1           * Local Address
          CALL      DADR0000
          BRANCH    EXIT,CPRA8000      * default to patient details
          GOTO      CPRA9999
.
CPRA1000  MOVE      "2",KEY1                 * Postal Address
          CALL      DADR0000
          BRANCH    EXIT,CPRA8000
          GOTO      CPRA9999
.
CPRA8000  CALL      PRAD0000           * write to person responsible file
CPRA9999  RETURN
+
.------------------------------------------------------------
.        Default Address from Extra Contract file
.------------------------------------------------------------
DADR0000  OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PATRE1A1,"patre1af"
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
DADR1000  CALL      RKPMCEX1
          BRANCH    OVRCD,DADR9000
          MATCH     URNUMBER,PMCEURNO         * Same U/R?
          GOTO      DADR9000 IF NOT EQUAL
.
          MATCH     SP70,PMCETYPE
          GOTO      DADR1000 IF EQUAL
          MOVE      "tc",KEY2
          PACK      KEY5,KEY2,PMCETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,DADR1000
          MATCH     KEY1,TCINDC1
          GOTO      DADR1000 IF NOT EQUAL
.
          MOVE      SP1,ANS
          MOVE      PGNAME,PTREGNAM
          MOVE      PTMASNAM,PTRESNAM
          MOVE      PGNAME,ANS
          PACK      PKNAME,PTITL,SP1,ANS,DOT,PTMASNAM,SP70,SP10
          MOVE      PMCEADD1,PKADD1
          MOVE      PMCEADD2,PKADD2
          MOVE      PMCEADD3,PKSUBR
          MOVE      PMCEADD4,PKADD4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCERELP,PKRELP
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELM,PTREMOBL
          MOVE      ADMISSNO,PKADMN
          CALL      PARN0000                  * Check for 'Parent of'
.
          PACK      KEY8,ADMISSNO,SP10
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      DADR99999
.
DADR9000  MOVE      ONE,EXIT
DADR9999  RETURN
+
.*******************************************************************************
.  PRAD0000  :  Write the Person Responsible for Account Details for RCH
.*******************************************************************************
PRAD0000  MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL      UPRF0000              * Get Contact for Usual PRFA
            MOVE      ADMISSNO,PKADMN
            COMPARE   ZERO,EXIT
            GOTO      PRAD7000 IF EQUAL
            GOTO      PRAD9500              * No change to PRFA
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      PMPXCONP,F1
          BRANCH    F1,PRAD1000,PRAD2000,PRAD3000,PRAD4000,PRAD5000
.
. patient is responsible for account
.
          MOVE    PTMASNAM,PACSNAMX
          MOVE    PGNAME,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PTITL,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    ADMISSNO,PKADMN
          MOVE    PACFNAMX,PKNAME
          MOVE    PADD1,PKADD1
          MOVE    PADD2,PKADD2
          MOVE    PSUBRB,PKSUBR
          MOVE    PADD4,PKADD4
          MOVE    PPOST,PKPOST
          MOVE    PTELEP,PKTELEP
          MOVE    PTELEB,PKTELEB
          MOVE    "SELF      ",PKRELP
.
          CALL    PARN0000                  * Check for 'Parent of'
.
          GOTO    PRAD7000
.
. contact 1 is responsible for account
.
PRAD1000  MOVE    ADMISSNO,PKADMN
          MOVE    PMPXMSNA,PACSNAMX
          MOVE    PMPXMGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXMTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXMAD1,PKADD1
          MOVE    PMPXMAD2,PKADD2
          MOVE    PMPXMAD3,PKSUBR
          MOVE    PMPXMAD4,PKADD4
          MOVE    PMPXMPOS,PKPOST
          MOVE    PMPXMPNO,PKTELEP
          MOVE    PMPXMBNO,PKTELEB
          MOVE    PMPXMREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 2 is responsible for account
.
PRAD2000  MOVE    ADMISSNO,PKADMN
          MOVE    PMPXFSNA,PACSNAMX
          MOVE    PMPXFGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXFTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXFAD1,PKADD1
          MOVE    PMPXFAD2,PKADD2
          MOVE    PMPXFAD3,PKSUBR
          MOVE    PMPXFAD4,PKADD4
          MOVE    PMPXFPOS,PKPOST
          MOVE    PMPXFPNO,PKTELEP
          MOVE    PMPXFBNO,PKTELEB
          MOVE    PMPXFREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 3 is responsible for account
.
PRAD3000  MOVE    ADMISSNO,PKADMN
          PACK    PKNAME,PNKNAME,SP70,SP10
          MOVE    PNKADD1,PKADD1
          MOVE    PNKADD2,PKADD2
          MOVE    PNKSUBR,PKSUBR
          MOVE    PNKADD4,PKADD4
          MOVE    PNKPOST,PKPOST
          MOVE    PNKTELP,PKTELEP
          MOVE    PNKTELB,PKTELEB
          MOVE    PNKRELP,PKRELP
.
          GOTO    PRAD7000
.
. contact 4 is responsible for account
.
PRAD4000  MOVE    ADMISSNO,PKADMN
          PACK    PKNAME,PTMXECNM,SP70,SP10
          MOVE    PTMXECA1,PKADD1
          MOVE    PTMXECA2,PKADD2
          MOVE    PTMXECA3,PKSUBR
          MOVE    PTMXECA4,PKADD4
          MOVE    PTMXECPC,PKPOST
          MOVE    PTMXECPP,PKTELEP
          MOVE    PTMXECBP,PKTELEB
          MOVE    PTMXECRE,PKRELP
.
          GOTO    PRAD7000
.
. contact 5 is responsible for account
.
PRAD5000  MOVE    ADMISSNO,PKADMN
          PACK    PKNAME,PTMXNRNM,SP70,SP10
          MOVE    PTMXNRA1,PKADD1
          MOVE    PTMXNRA2,PKADD2
          MOVE    PTMXNRA3,PKSUBR
          MOVE    PTMXNRA4,PKADD4
          MOVE    PTMXNRPC,PKPOST
          MOVE    PTMXNRPP,PKTELEP
          MOVE    PTMXNRBP,PKTELEB
          MOVE    PTMXNRRE,PKRELP
.
          GOTO    PRAD7000
.
PRAD7000  PACK    KEY8,ADMISSNO,SP10
          CALL    RDARESP1
          IF      OVRCD=1
            CALL    WRRESP1
          ELSE
            CALL    UPRESP1
          ENDIF
.
PRAD9500  MOVE      ZERO,EXIT
.
PRAD9999  RETURN
+
.-----------------------------------------------------------------------------
.         Get Usual PRFA details
.-----------------------------------------------------------------------------
UPRF0000  MATCH     PMPXI104,Z70
          GOTO      UPRF9000 IF EQUAL
.
          PACK      PMPXUPRF,PMPXI104,SP70
          MATCH     SP70,PMPXUPRF
          GOTO      UPRF9000 IF EQUAL
.
          PACK      KEY14,URNUMBER,PMPXUPRF,Z70
          CALL      RSPMCEX1
UPRF1000  CALL      RPPMCEX1
          BRANCH    OVRCD,UPRF9000
.
          MATCH     URNUMBER,PMCEURNO            * Same U/R
          GOTO      UPRF9000 IF NOT EQUAL
.
          MATCH     PMPXUPRF,PMCETYPE            * Same Contact Type
          GOTO      UPRF9000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV                 * Skip if Inactive
          GOTO      UPRF1000 IF EQUAL
.
          MOVE      PMCESNAM,PACSNAMX
          MOVE      PMCEGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMCETITL,PACTITLE
          MOVE      THREE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAMX,PKNAME
.
          MOVE      PMCEADD1,PKADD1         * Address line 1
          MOVE      PMCEADD2,PKADD2         * Address line 2
          MOVE      PMCEADD3,PKSUBR         * Address line 3
          MOVE      PMCEADD4,PKADD4         * Address line 4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCERELP,PKRELP
          MOVE      PMCETELM,PTREMOBL
          MOVE      PMCESNAM,PTRESNAM
          MOVE      PMCEGNAM,PTREGNAM
.
          MOVE      ZERO,EXIT
          GOTO      UPRF9999
.
UPRF9000  MOVE      ONE,EXIT
UPRF9999  RETURN
+
.***********************************************************************
.        Check for Using 'Parent of' option
.***********************************************************************
PARN0000 COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
         GOTO      PARN9999 IF NOT EQUAL     * no
.
         PACK      AGEDATE,CCC,CYY,CMM,CDD
         CALL      CALCAGE                   * CALCAGE uses PBDATE
         COMPARE   PSAGEYRS,PTCNAGEC         * Child?
         GOTO      PARN9999 IF LESS          * No
.
         UNPACK    PGNAME,ANS
         PACK      PKNAME,SP70,SP10
         CLEAR     PKNAME
         APPEND    "Parent of ",PKNAME
         APPEND    ANS,PKNAME
         APPEND    DOT,PKNAME
         APPEND    SP1,PKNAME
         APPEND    PTMASNAM,PKNAME
         APPEND    SP70,PKNAME
         APPEND    SP10,PKNAME
         RESET     PKNAME
         MOVE      "Parent    ",PKRELP
.
PARN9999 RETURN
+
.------------------------------------------------------------
. Referral Hospital Selection List
.------------------------------------------------------------
FHSL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
FHSL1000  CALL      RKPTHSP1
          BRANCH    OVRCD,FHSL9999
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY13,USERID,SP70                * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,FHSL1000
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      FHSL1000
.
FHSL9999  RETURN
+
.-------------------------------------------------------------------------------
.  DISWAR00 - Disaster Validations and Warnings
.-------------------------------------------------------------------------------
DISWAR00  MOVE      ZERO,EXIT
          MATCH     SP70,DISPT001
          GOTO      DISWAR99 IF EQUAL
          GOTO      DISWAR99 IF EOS
.
          PACK      KEY9,DISPT001,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DISWAR90
.
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL & !@EOS
            MATCH     DSMASDAT,ALRERDAT
            IF        @LESS
              GOTO      DISWAR92
            ENDIF
          ENDIF
.
          MATCH     SP70,DSMAEDAT
          IF        !@EQUAL & !@EOS
            MATCH     ALRERDAT,DSMAEDAT
            IF        @LESS
              GOTO      DISWAR92
            ENDIF
          ENDIF
.
          MOVE      PURNO,DSPTURNO
          MOVE      DISPT002,DSPTDIID
          MOVE      DISPT001,DSPTCODE
          MOVE      DSMASDAT,DSPTSDAT
          MOVE      DSMAEDAT,DSPTEDAT
          MOVE      SP70,DSPTOTCM
          MOVE      "92",DSPTFICA
          MOVE      SP70,DSPTSPAR
.
          PACK      KEY17,PURNO,DISPT001,SP70
          CALL      RADSPAT1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPTCUSR
            CALL      IBACLOCK
            PACK      DSPTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTCTIM
            MOVE      SP70,DSPTUUSR
            MOVE      SP70,DSPTUDAT
            MOVE      SP70,DSPTUTIM
            CALL      WRDSPAT1
          ELSE
            MOVE      WBSEUID,DSPTUUSR
            CALL      IBACLOCK
            PACK      DSPTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPAT1
          ENDIF
.
          MOVE      PURNO,DSPLURNO
          MOVE      DISPT001,DSPLCODE
          MOVE      ALREVISN,DSPLVISN
          MOVE      SP70,DSPLSPAR
          PACK      KEY25,PURNO,DISPT001,ALREVISN,SP70
          CALL      RADSPTL1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPLCUSR
            CALL      IBACLOCK
            PACK      DSPLCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPLCTIM
            MOVE      SP70,DSPLUUSR
            MOVE      SP70,DSPLUDAT
            MOVE      SP70,DSPLUTIM
            CALL      WRDSPTL1
          ELSE
            MOVE      WBSEUID,DSPLUUSR
            CALL      IBACLOCK
            PACK      DSPLUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPTL1
          ENDIF
.
          CALL     NWDALT00
          GOTO     DISWAR99
.
DISWAR90  MOVE      "Disaster Master Record not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISWAR99
.
DISWAR92  MOVE      "Date on list is not within the Disaster Start/End Date.",WEBTITLE
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISWAR99
.
DISWAR99  RETURN
.
.---------------------------------------------------------------------
. NWDALT00 - Write a new alternate ID record for disaster patients
.---------------------------------------------------------------------
NWDALT00  PACK      PMAIURNO,PURNO,SP70
.
          MATCH     SP70,DSMAAICD
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      PMAITYPE,DSMAAICD,SP70
.
          MATCH     SP70,DSPTDIID
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      KEY5,ANSA,ANSI,DSMAAICD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,TCINDC1
            IF        !@EQUAL & !@EOS
              PACK      PMAIALID,TCINDC1,DSPTDIID,SP70
            ELSE
              PACK      PMAIALID,DSPTDIID,SP70
            ENDIF
          ELSE
            PACK      PMAIALID,DSPTDIID,SP70
          ENDIF
.
          RJUSTIFY  PMAIALID
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          UNPACK    SP70,PMAISPAR
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      NWDALT99
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update
.
NWDALT99  RETURN
.
.------------------------------------------------------------
. DISSEL00 - Display Selection List for Disasters
.------------------------------------------------------------
.
DISSEL00  PACK      KEY9,SP70
          CALL      RSDSMAS1
DISSEL10  CALL      RKDSMAS1
          BRANCH    OVRCD,DISSEL99
.
          MATCH     "3",DSMAACTV
          GOTO      DISSEL10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DSMACODE,"#">":
                             DSMADESC,"</option>"
          GOTO      DISSEL10
.
DISSEL99  RETURN
+
.------------------------------------------------------------
. DISCOD00 - Get Disaster Code for UR/Visit No
.------------------------------------------------------------
DISCOD00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISCOD10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISCOD99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISCOD99 IF NOT EQUAL
.
          PACK      DIM8,ALREVISN,SP70
          MATCH     DIM8,DSPLVISN
          GOTO      DISCOD10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;DSPLCODE;
          ENDIF
.
DISCOD99  RETURN
.
.------------------------------------------------------------
. DISDSC00 - Get Disaster Desc for UR/Visit No
.------------------------------------------------------------
DISDSC00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISDSC10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISDSC99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISDSC99 IF NOT EQUAL
.
          PACK      DIM8,ALREVISN,SP70
          MATCH     DIM8,DSPLVISN
          GOTO      DISDSC10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            PACK      KEY9,DSPLCODE,SP70
            CALL      RDDSMAS1
            BRANCH    OVRCD,DISDSC99
.
            WRITE     HTMLFILE;DSMADESC;
.
          ENDIF
.
DISDSC99  RETURN
.
.*******************************************************************************
. Get OPD Comment
.*******************************************************************************
GETOPD00  PREP      COMFILOF,COMFILNO
.
          MOVE      ZERO,OPDFLAG
          MOVE      ONE,F3
          WRITE     COMFILOF,SEQ;QRYDATA
.
GETOPD10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETOPD90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETOPD80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILOF,SEQ;QRYDATA
          GOTO      GETOPD10
.
GETOPD80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETOPD90  MOVE      F3,OPDWEND
          OPEN      COMFILOF,COMFILNO
GETOPD99  RETURN
.
.------------------------------------------------------------------------------
. Write Close Referral OPD action and comments
.------------------------------------------------------------------------------
COPD0000  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,COPD9999
.
          MATCH     SP70,WBSEOPDU                * Exit if not an OPD user
          GOTO      COPD9999 IF EQUAL
.
          PACK      KEY5,CATTZ,WBSEOPDU,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,COPD9999
.
          MATCH     ANSO,TCINDC1                 * OPD user
          GOTO      COPD9999 IF NOT EQUAL
.
          CALL      CLOUTDAN
          MOVE      ALREURNO,OTDNURNO
          MOVE      ALREDCLO,OTDNADAT
          MOVE      ALRETCLO,OTDNATIM
          MOVE      " 5",OTDNATYP                * Close Referral
          MOVE      ALREVISN,OTDNVISN
          MOVE      ALREVISN,OTDNREFN
          MOVE      ALRERDAT,OTDNVDAT
.
          PACK      OTDNCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTDNCDAT           *
          CLOCK     TIME,OTDNCTIM
          MOVE      USERID,OTDNCUID
.
          PACK      KEY34,OTDNURNO,OTDNADAT,OTDNATIM,OTDNATYP,OTDNVISN,SP70
          CALL      RAOTDAN1
          IF        OVRCD=1
            CALL      WROTDAN1                    * Write actions record
          ENDIF
.
          MOVE      OTDNURNO,COMMURNO
          MOVE      OTDNADAT,COMMADAT
          MOVE      OTDNATIM,COMMATIM
          MOVE      " 5",COMMTYPE            * Close Referral
          CALL      UPOPD000                 * OPD Message
.
COPD9999  RETURN
.
.
.*******************************************************************************
. OPD referral comments
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPOPD000  BRANCH    OPDFLAG,UPOPD999
.
          PACK      KEY29,COMMURNO,COMMADAT,COMMATIM,COMMTYPE,SP70
          CALL      RSOTDCO1
UPOPD400  CALL      RKOTDCO1
          BRANCH    OVRCD,UPOPD500          * end of file
.
          MATCH     COMMURNO,OTDOURNO
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMADAT,OTDOADAT
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMATIM,OTDOATIM
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMTYPE,OTDOATYP
          GOTO      UPOPD500 IF NOT EQUAL
.
          PACK      KEY29,OTDOURNO,OTDOADAT,OTDOATIM,OTDOATYP,OTDOCLNO,SP70
          CALL      DEOTDCO1
          GOTO      UPOPD400
.
.         now write the new comments back
.
UPOPD500  MOVE      COMMURNO,OTDOURNO
          MOVE      COMMADAT,OTDOADAT
          MOVE      COMMATIM,OTDOATIM
          MOVE      COMMTYPE,OTDOATYP
          MOVE      ZERO,F3
.
UPOPD510  ADD       ONE,F3
          READ      COMFILOF,SEQ;OTDOCOMM
.
          MATCH     SP70,OTDOCOMM
          IF        @EQUAL
            IF        F3>=OPDWEND
              GOTO      UPOPD999
            ELSE
              GOTO      UPOPD510
            ENDIF
          ENDIF
.
          MOVE      F3,OTDOCLNO
          PACK      KEY29,OTDOURNO,OTDOADAT,OTDOATIM,OTDOATYP,OTDOCLNO,SP70
          CALL      WROTDCO1
          IF        F3>=OPDWEND
            GOTO      UPOPD999
          ENDIF
          GOTO      UPOPD510
.
UPOPD999  MOVE      ONE,OPDFLAG
.
          RETURN
.
.*******************************************************************************
. Display comments
.*******************************************************************************
DISCOM00  PACK      KEY29,COMMURNO,COMMADAT,COMMATIM,COMMTYPE,SP70
          CALL      RAOTDCO1
DISCOM10  CALL      RKOTDCO1
          BRANCH    OVRCD,DISCOM99
.
          MATCH     COMMURNO,OTDOURNO
          GOTO      DISCOM99 IF NOT EQUAL
.
          MATCH     COMMADAT,OTDOADAT
          GOTO      DISCOM99 IF NOT EQUAL
.
          MATCH     COMMATIM,OTDOATIM
          GOTO      DISCOM99 IF NOT EQUAL
.
          MATCH     COMMTYPE,COMMTYPE
          GOTO      DISCOM99 IF NOT EQUAL
.
          STRIP     OTDOCOMM
          MOVELPTR  OTDOCOMM,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      OTDOCOMM,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      DISCOM10
.
DISCOM99  RETURN
.
.******************************************************************************
. Return selection list options for clinic types that match the AH referrals  
. department and preferred site
.******************************************************************************
OUTCTY00  MATCH     SP70,VALDPSIT            * Blank preferred site
          GOTO      OUTCTY90 IF EQUAL
.
          PACK      KEY6,VALDPSIT,SP70
          CALL      RDSITA1
          BRANCH    OVRCD,OUTCTY90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MATCH     "1",DEPTINDC
          IF        @EQUAL
            MOVE      SP70,DEPTCODE
          ENDIF
.
          PACK      KEY15,VALDPSIT,DEPTCODE,SP70
          CALL      RDSCTYA3
OUTCTY10  CALL      RDKCTYA3
          BRANCH    OVRCD,OUTCTY80
.
          MATCH     OCTSITE,VALDPSIT
          GOTO      OUTCTY80 IF NOT EQUAL
.
          MATCH     "1",DEPTINDC
          IF        !@EQUAL
            MATCH     OCTGRP,DEPTCODE
            GOTO      OUTCTY80 IF NOT EQUAL
          ENDIF
.
.         Checks if only active clinics will be displayed and then
.         only lists the active clinics in the result
          MATCH     "1",SHOWACTV
          IF        @EQUAL
            MATCH     "1",OCTACT 
            GOTO      OUTCTY10 IF EQUAL
          ENDIF
.
          WRITE     HTMLFILE;OCTCTYP,",",OCTDESC,"|";  
.
          GOTO      OUTCTY10
.
OUTCTY80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      OUTCTY99
.
OUTCTY90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid Preferred Site : ",VALDPSIT:
                    "</RETURN_VALUE>"
          GOTO      OUTCTY99
.
OUTCTY99  RETURN
.
.------------------------------------------------------------
. Get other hospital visit details
.------------------------------------------------------------
OHVIS000  PACK      KEY8,INVADMNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,OHVIS999
          CALL      RDPMVX11
          BRANCH    OVRCD,OHVIS999
.
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      VISDHOSP,PTHSNAME,SP70
          ENDIF
.
          IF        USEINVAD=1
            PACK      ADMISSNO,INVADMNO,SP70
          ENDIF
          GOTO      OHVIS999
.
OHVIS999  RETURN
.
.
.*******************************************************************************
. Activate a waiting master referral if the linked internal referral is active
. Requires CHECKREF - Internal Referral Number
.*******************************************************************************
AMAS0000  MATCH     "1",ALCNDAMR
          GOTO      AMAS9999 IF EQUAL
.
          PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Read the referral to see if it's
          BRANCH    OVRCD,AMAS9999          * an internal referral
.
          MATCH     "1",ALREUYN4            * Exit if not an internal referral
          GOTO      AMAS9999 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Exit if not active
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALREDACT,SAVIADAT       * Save internal referral date active
          MOVE      SP70,MASTREFN           * Clear master referral number
.
          PACK      KEY16,CHECKREF,SP70
          CALL      RSALRLN2                * Determine master referral number
          CALL      RKALRLN2
          BRANCH    OVRCD,AMAS9999
.
          MATCH     CHECKREF,ALRLLNKV       * Linked referrals
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALRLVISN,MASTREFN       * Save master referral number

          PACK      KEY8,MASTREFN,SP70
          CALL      RDALREF1                * Read the master referral
          BRANCH    OVRCD,AMAS9000
.
          MATCH     "1",ALREUYN4            * Exit if not an master referral
          GOTO      AMAS9000 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * Exit if not waiting
          GOTO      AMAS9000 IF NOT EQUAL
.
          IF        VINAHFLG = 0 | VINAHFLG = 1 & RIAUDFLG = 0
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00
.
.           Set flag to indicate that a before audit record has been written
.
            IF        VINAHFLG = 1
              MOVE      ONE,RIAUDFLG
            ENDIF
          ENDIF
.
          MOVE      ZERO,RACTVFLG
          MOVE      "1",ALRESTAT            * Set status to active
          MOVE      SAVIADAT,ALREDACT
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      URMHI000                * Set MHINC indicator
          CALL      UPALREF1                * Update referral Table (allrefaf)
.
          PACK      KEY8,ALREVISN,SP70     
          CALL      RDALEID1
          IF        OVRCD=0
            CALL      MVALEI00              * Extra Inbound Data
            CALL      UPALEID1              * Update alleidaf
          ELSE
            IF        EIDEXIST=1
              CALL      CLALLEID
              CALL      MVALEI00            * Extra Inbound Data
              MOVE      ALREVISN,ALEIVISN
              CALL      WRALEID1            * write new record
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY1,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
.         Check if we need to write an after audit record
.
          IF        VINAHFLG = 0
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
          ELSE
            IF        VINAHFLG = 1 & RIAUDFLG = 1
              MOVE      ALREVISN,VINAHREF   * save the master referral no.
            ENDIF
          ENDIF
.
          MOVE      ALREDACT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "T ",UPDTTYPE           * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
AMAS9000  PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Re read original referral
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLALLEID
          ENDIF
.
AMAS9999  RETURN
.
.*******************************************************************************
. Populate the first appointment booked field for SOP internal referrals
.*******************************************************************************
FAPD0000  MATCH     "1",ALREUYN4                 * Exit if master referral
          GOTO      FAPD9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1                      * Read department
          BRANCH    OVRCD,FAPD9999
.
.         MATCH     ANSO,TCINDC8                 * SOP referrals only
.         GOTO      FAPD9999 IF NOT EQUAL
.
          MATCH     SP70,ALREUDT8                * Exit if first appointment
          GOTO      FAPD9999 IF NOT EQUAL        * booked alredy populated
.
.         MOVE      ALREDACT,ALREUDT8            * Set to active date
          MOVE      BOOKDATE,ALREUDT8            * Set to first booked date
.
FAPD9999  RETURN
.
.*******************************************************************************
. Has the first encounter been added to any referral under this master referral
.*******************************************************************************
FENC0000  MATCH     "1",ALREUYN4                 * Master referral
          GOTO      FENC9999 IF NOT EQUAL
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALENC1
FENC1000  CALL      RKALENC1                     * Check master for encounters
          BRANCH    OVRCD,FENC5000
.
          MATCH     ADMISSNO,ALENVISN
          GOTO      FENC5000 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA                 * Cancelled  
          GOTO      FENC1000 IF EQUAL
.
          GOTO      FENC8000
.
FENC5000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
FENC6000  CALL      RKALRLN1
          BRANCH    OVRCD,FENC9999
.
          MATCH     ADMISSNO,ALRLVISN            * Internal referrals to this
          GOTO      FENC9999 IF NOT EQUAL        * master
.
          PACK      KEY16,ALRLLNKV,SP70
          CALL      RSALENC1
FENC7000  CALL      RKALENC1                     * Check internal referral
          BRANCH    OVRCD,FENC6000               * for encounters
.
          MATCH     ALRLLNKV,ALENVISN
          GOTO      FENC6000 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA                 * Cancelled
          GOTO      FENC7000 IF EQUAL
.
FENC8000  WRITE     HTMLFILE;ONE;      * The first encounter has been added
          GOTO      FENC9999
.
FENC9999  RETURN
.
.-------------------------------------------------------------------
.     writing here for allied health department drop down
.-------------------------------------------------------------------
DEPC0000  MOVE      ZERO,SHOWTITL
.
          PACK      KEY10,USERID,SP70       * Read security id to get hospital
          CALL      RDWBSE1
          BRANCH    OVRCD,DEPC9999
.
          PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
DEPC0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPC9000
.
          MATCH     "CG",TCODE
          GOTO      DEPC9000 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      DEPC0100 IF EQUAL
.
          MATCH     ANSP,TCINDC11                 * Combined referral department
          GOTO      DEPC0100 IF NOT EQUAL
.
          MATCH     SP70,TCINDC8                  * Must have VINAH type
          GOTO      DEPC0100 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPC0100
.
          MATCH     "1",ALDEACTV
          GOTO      DEPC0100 IF EQUAL       * Skip Inactive
.
          IF        IBCNMHOS=1
            MATCH     SP70,ALDEHOSP
            IF        !@EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  MATCH     WBSEHOSP,ALDEHOSP
                  GOTO      DEPC0100 IF NOT EQUAL
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          IF        SHOWTITL=0
            WRITE     HTMLFILE;"<td align=right class=HeadingCell>":
                               "Add Combined Referral ":
                               "<select class=PMenuSelectList name=combdept":
                               " onmouseover='MenuOver(this)'":
                               " onchange='AddCombinedReferral();'>":
                               " <option></option>"
          ENDIF
          WRITE     HTMLFILE;"<option value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
.
          MOVE      ONE,SHOWTITL
          GOTO      DEPC0100
.
DEPC9000  IF        SHOWTITL=1
            WRITE     HTMLFILE;"</select></td>";
          ENDIF
.
DEPC9999  RETURN
.
.
.------------------------------------------------------------
. Display Warnings
.------------------------------------------------------------
AJAXRD00  CALL      OPENHTML
          BRANCH    EXIT,AJAXRD95
.
          WRITE     HTMLFILE;"PROCESSING_OK:",ADMISSNO;
.
          COMPARE   ZERO,WARCOUNT
          GOTO      AJAXRD90 IF EQUAL
.
          MOVE      ONE,COUNTER
AJAXRD10  WRITE     HTMLFILE;"|",WEBWARNG[COUNTER];
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      AJAXRD90 IF LESS
          GOTO      AJAXRD10
.
AJAXRD90  CALL      CLOSHTML
          MOVE      TWO,EXIT
          GOTO      AJAXRD99
.
AJAXRD95  DISPLAY   "*** Fifo Not Found ***"
.
AJAXRD99  RETURN
.
.-------------------------------------------------------------------
. Add combined internal department list
.-------------------------------------------------------------------
DEPI0000  PACK      KEY10,USERID,SP70       * Read security id to get hospital
          CALL      RDWBSE1
          BRANCH    OVRCD,DEPI9999
.
          MATCH     SP70,ALLRF001
          GOTO      DEPI9999 IF EQUAL
.
          MOVE      SP70,KEY1
          PACK      KEY5,ANSC,ANSG,ALLRF001,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DEPI9999
.
          MOVE      TCINDC8,KEY1                  * Save VINAH type
.
          PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
DEPI0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPI9999
.
          MATCH     "CG",TCODE
          GOTO      DEPI9999 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      DEPI0100 IF EQUAL
.
          MATCH     ANSE,TCINDC11                 * Combined referral department
          GOTO      DEPI0100 IF NOT EQUAL
.
          MATCH     KEY1,TCINDC8                  * Ind 8 or 21
          IF        !@EQUAL
            MATCH     KEY1,TCINDC21               * Must have VINAH type the
            GOTO      DEPI0100 IF NOT EQUAL       * same as master referral dept
          ENDIF
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPI0100
.
          MATCH     "1",ALDEACTV
          GOTO      DEPI0100 IF EQUAL       * Skip Inactive
.
          IF        IBCNMHOS=1
            MATCH     SP70,ALDEHOSP
            IF        !@EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  MATCH     WBSEHOSP,ALDEHOSP
                  GOTO      DEPI0100 IF NOT EQUAL
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<option value=#"",ALDEDEPT,"#">":
                               TDESC,"</option>"
.
          GOTO      DEPI0100
.
DEPI9999  RETURN
.-----------------------------------------------------------
.         Clears the visit notes file variables
.-----------------------------------------------------------
CLVNOT00  MOVE      SP70,VSMDVISN      * Visit Number
          MOVE      SP70,VSMDTYPE      * Comment Type
          MOVE      SP70,VSMDNOTE      * Note Number
          MOVE      SP70,VSMDDATE      * Input Date (CCYYMMDD)
          MOVE      SP70,VSMDTIME      * Input Time (HH:MM:SS)
          MOVE      SP70,VSMDUSER      * Input by WEB User ID (websecaf)
          MOVE      SP70,VSMDOCCG      * Occupational Group WEB User ID
          MOVE      SP70,VSMDDELT      * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,VSMDDELT      * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,VSMDDDAT      * Delete Date (CCYYMMDD)
          MOVE      SP70,VSMDDTIM      * Delete Time (HH:MM:SS)
          MOVE      SP70,VSMDDUSE      * Delete by WEB User ID (websecaf)
          MOVE      SP70,VSMDDOCC      * Occupational Group WEB User ID Dele
          MOVE      SP70,VSMDSPAR      * Spare Variable
.
          MOVE      SP70,VSMTVISN      * Visit Number
          MOVE      SP70,VSMTTYPE      * Comment Type
          MOVE      SP70,VSMTNOTE      * Note Number
          MOVE      SP70,VSMTUNIQ      * Line Number
          MOVE      SP70,VSMTCMNT      * Comment
          MOVE      SP70,VSMTSPAR      * Spare Variable
.
CLVNOT99  RETURN
.------------------------------------------------------------
.         Visit Notes Display in the text area
.         NOTEORDR = 0 = Display new notes first
.                    1 = Display old notes first
.------------------------------------------------------------
DISNOT00  MOVE      ADMISSNO,VSMDVISN
.
          IF        NOTEORDR=0
            PACK      KEY17,VSMDVISN,NOTEFILT,Z70
          ELSE
            PACK      KEY17,VSMDVISN,NOTEFILT,SP70
          ENDIF
.
          CALL      RSVSMDT1
DISNOT10  IF        NOTEORDR=0
            CALL      RPVSMDT1
          ELSE
            CALL      RKVSMDT1
          ENDIF
          BRANCH    OVRCD,DISNOT99
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      DISNOT99 IF NOT EQUAL
.
          MATCH     NOTEFILT,VSMDTYPE
          GOTO      DISNOT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      DISNOT10 IF EQUAL
.
          MOVE      SP70,TEMPDATE
          MATCH     SP70,VSMDDATE
          IF        !@EQUAL
            UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      TEMPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     VISNOTES
          APPEND    TEMPDATE,VISNOTES
          APPEND    "  ",VISNOTES
          APPEND    VSMDTIME,VISNOTES
          APPEND    "  ",VISNOTES
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD<>1
            APPEND    WBSENAM,VISNOTES
          ELSE
            APPEND    VSMDUSER,VISNOTES
          ENDIF
          APPEND    "  ",VISNOTES
          MOVE      "w0",KEY2
          PACK      KEY5,KEY2,VSMDOCCG,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            APPEND    TDESC,VISNOTES
          ELSE
            APPEND    VSMDOCCG,VISNOTES
          ENDIF
          RESET     VISNOTES
.
          STRIP     VISNOTES
          MOVELPTR  VISNOTES,LENGTH
.
          SFORMAT   VAR,LENGTH
          MOVE      VISNOTES,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
DISNOT20  CALL      RKVSMTX1
          BRANCH    OVRCD,DISNOT10
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      DISNOT10 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      DISNOT10 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      DISNOT10 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      DISNOT20
.
DISNOT99 RETURN
.
.------------------------------------------------------------
. When closing an internal referral display a warning message
. to close the master referral if all its internal referrals
. are closed
.------------------------------------------------------------
CMAS0000  MOVE      ZERO,CLOSMAST           * No close master warning
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Re read referral
          BRANCH    OVRCD,CMAS9999
.
          MATCH     "1",ALREUYN4            * Exit if a master referral
          GOTO      CMAS9999 IF EQUAL
.
          MOVE      SP70,MASTREFN           * Clear master referral number
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN2                * Determine master referral number
          CALL      RKALRLN2
          BRANCH    OVRCD,CMAS9999
.
          MATCH     ADMISSNO,ALRLLNKV       * Linked referral
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALRLVISN,MASTREFN       * Save master referral number
          PACK      KEY8,MASTREFN
          CALL      RDALREF1
          BRANCH    OVRCD,CMAS9000
.
          MATCH     "0",ALRESTAT           * Master referral waiting
          GOTO      CMAS2000 IF EQUAL
.
          MATCH     "1",ALRESTAT           * Master referral active
          GOTO      CMAS2000 IF EQUAL
          GOTO      CMAS9000
.
CMAS2000  MOVE      ONE,CLOSMAST            * Yes close master warning
          PACK      KEY16,MASTREFN,SP70
          CALL      RSALRLN1
CMAS3000  CALL      RKALRLN1
          BRANCH    OVRCD,CMAS9000
.
          MATCH     MASTREFN,ALRLVISN       * Linked referrals
          GOTO      CMAS9000 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALRLLNKV       * Skip referral that is being
          GOTO      CMAS3000 IF EQUAL       * closed
.
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,CMAS3000
.
          MATCH     "0",ALRESTAT            * Waiting
          IF        @EQUAL
            MOVE      ZERO,CLOSMAST         * No close master warning  
            GOTO      CMAS9000
          ENDIF
.
          MATCH     "1",ALRESTAT            * Active
          IF        @EQUAL
            MOVE      ZERO,CLOSMAST         * No close master warning  
            GOTO      CMAS9000
          ENDIF
.
          GOTO      CMAS3000
.
CMAS9000  WRITE     HTMLFILE;CLOSMAST;      * Warn to close master as all
.                                           * linked referrals are closed
          PACK      KEY8,ADMISSNO,SP70      * Re read referral
          CALL      RDALREF1               
.
CMAS9999  RETURN
.
.
.------------------------------------------------------------
. Victorian and NZ edit to check the referral date is not greater
. than the referral in received date - Add Referral
.------------------------------------------------------------
RECV0000  IF        PTCNHDPS <> ONE & PTCNHDPS <> THREE
            GOTO      RECV8000
          ENDIF
.         COMPARE   THREE,PTCNHDPS         * Exit if not victoria
.         GOTO      RECV8000 IF NOT EQUAL
.
          MATCH     Z70,ALREF019           * Exit if no referral date
          GOTO      RECV8000 IF EQUAL
.
          MATCH     SP70,ALREF019          * Exit if no referral date
          GOTO      RECV8000 IF EQUAL
.
          MATCH     Z70,ALREF039           * Exit if no referral in
          GOTO      RECV8000 IF EQUAL      * received date
.
          MATCH     SP70,ALREF039          * Exit if no referral in
          GOTO      RECV8000 IF EQUAL      * received date
.
          MATCH     ALREF019,ALREF039      * Error
          GOTO      RECV9000 IF LESS
.
RECV8000  MOVE      ZERO,EXIT
          GOTO      RECV9999
.
RECV9000  CLEAR     WEBTITLE
          APPEND    "Referral date can't be greater than ",WEBTITLE
          APPEND    "the referral in received date.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
RECV9999  RETURN
.
.------------------------------------------------------------
. Victorian and NZ  edit to check the referral date is not greater
. than the referral in received date
. Update referral and supervisor update referral
.------------------------------------------------------------
RECU0000  IF        PTCNHDPS <> 1 & PTCNHDPS <> 3
            GOTO      RECU8000
          ENDIF         
.         COMPARE   THREE,PTCNHDPS         * Exit if not victoria
.         GOTO      RECU8000 IF NOT EQUAL
.
          MOVE      ALRERDAT,TEMPRDAT      * Save referral date
          MOVE      ALREDREC,TEMPDREC      * Save date received
.
          MATCH     Z70,ALREF019           * Referral date
          IF        !@EQUAL
            MOVE      ALREF019,TEMPRDAT    * New referral date
          ENDIF
.
          MATCH     Z70,ALREF039           * Referral in received date
          IF        !@EQUAL
            MOVE      ALREF039,TEMPDREC    * New referral in received date
          ENDIF
.
          MATCH     SP70,TEMPRDAT          * Exit if no referral date
          GOTO      RECU8000 IF EQUAL
.
          MATCH     SP70,TEMPDREC          * Exit if no referral in
          GOTO      RECU8000 IF EQUAL      * received date
.
          MATCH     TEMPRDAT,TEMPDREC      * Error
          GOTO      RECU9000 IF LESS
.
RECU8000  MOVE      ZERO,EXIT
          GOTO      RECU9999
.
RECU9000  CLEAR     WEBTITLE
          APPEND    "Referral date can't be greater than ",WEBTITLE
          APPEND    "the referral in received date.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          CALL      UUALREF1
          MOVE      ONE,EXIT
.
RECU9999  RETURN
.
.------------------------------------------------------------
. Update referral date in outbocaf
.------------------------------------------------------------
BOCF0000  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
BOCF1000  CALL      RKALLNK1
          BRANCH    OVRCD,BOCF9999
.
          MATCH     ADMISSNO,ALLNVISN            * Check for linked OP bookings
          GOTO      BOCF9999 IF NOT EQUAL
.
          CALL      ROTFIL00                     * Check outpatient file prefix
.
          PACK      KEY8,ALLNLNKV,SP70
          CALL      RDOTBOC1
          BRANCH    OVRCD,BOCF1000
. 
          MATCH     ALRERDAT,OTBCRDAT           * Update referral date if
          GOTO      BOCF1000 IF EQUAL           * required
.
          MOVE      ALRERDAT,OTBCRDAT
.
          CALL      UPOTBOC1
          GOTO      BOCF1000
.
BOCF9999  RETURN
.
.******************************************************************************
. Check if there are any linked OP appointments after the referrals proposed
. close date
.******************************************************************************
CHKOUT00  MATCH     Z70,ALREF007            * Exit if no close date
          GOTO      CHKOUT90 IF EQUAL
.
          MATCH     SP70,ALREF007           * Exit if no close date
          GOTO      CHKOUT90 IF EQUAL
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
CHKOUT20  CALL      RKALLNK1
          BRANCH    OVRCD,CHKOUT90
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      CHKOUT90 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT                 * Cancelled
          GOTO      CHKOUT20 IF EQUAL
.
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,CHKOUT20
.
          MATCH     ALLNLNKV,DOBAOUTN
          GOTO      CHKOUT20 IF NOT EQUAL
.
          IF        OBASTAT <> 1 & OBASTAT <> 4 
            GOTO      CHKOUT20                   * Not booked or attended
          ENDIF
.
          MATCH     ALREF007,OBADATE
          GOTO      CHKOUT20 IF LESS   * Booking date before proposed close date
.
          IF        @EQUAL
            MATCH     ALREF008,OBATIME      * Compare Booking time w/ Close time
            GOTO      CHKOUT20 IF LESS
            GOTO      CHKOUT20 IF EQUAL
          ENDIF
.
CHKOUT35  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:       * Booking exists after the proposed close date
                    "</RETURN_VALUE>"
          GOTO      CHKOUT99
.
CHKOUT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:      * No bookings after proposed close date
                    "</RETURN_VALUE>"
          GOTO      CHKOUT99
.
CHKOUT99  RETURN
+
.******************************************************************************
. Check if patient's DHB = hospital DHB (nz)
.******************************************************************************
CHKDHB00  MATCH     Z70,ALREF107            * Exit if no hospital
          GOTO      CHKDHB90 IF EQUAL
.
          MATCH     SP70,ALREF107           * Exit if no hospital
          GOTO      CHKDHB90 IF EQUAL
.
          PACK      KEY3,ALREF107,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,CHKDHB90

          MATCH     ALREF107,PTHSHOSP
          GOTO      CHKDHB90 IF NOT EQUAL
.
          MATCH     VALDPDHB,PTHSHDHB
          GOTO      CHKDHB90 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:       * Patient's DHB not equal to hospital DHB
                    "</RETURN_VALUE>"
          GOTO      CHKDHB99
.
CHKDHB90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:      * Patient's DHB is equal to hospital DHB
                    "</RETURN_VALUE>"
          GOTO      CHKDHB99
.
CHKDHB99  RETURN
+
.-----------------------------------------------------------------------------.
. Renewed referrals audit
.-----------------------------------------------------------------------------.
RENEWR00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      RENEWR80 IF EQUAL
.
          MATCH     "U",UPDATETY            * Reinstate a referrral renewal
          GOTO      RENEWR20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete a referral renewal
          GOTO      RENEWR30 IF EQUAL
.
          GOTO      RENEWR90
.
RENEWR20  PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,RENEWR91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,RENEWR91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,RENEWR92
.
          PACK      KEY24,ALRNW001,ALRNW002,ALRNW003,SP70
          CALL      RDALRNW1
          BRANCH    OVRCD,RENEWR93
.
          CALL      MVALN000                   * Move cgi to file vars  
.
          CALL      IBACLOCK
          PACK      ALRNRRDT,CCC,CYY,CMM,CDD   * Set reinstated by fields
          REP       " 0",ALRNRRDT
          CLOCK     TIME,ALRNRRTM
          MOVE      USERID,ALRNRRID
.
          CALL      IBACLOCK
          PACK      ALRNUDAT,CCC,CYY,CMM,CDD   * Set updated by fields
          REP       " 0",ALRNUDAT
          CLOCK     TIME,ALRNUTIM
          MOVE      USERID,ALRNUUID
.
          CALL      UPALRNW1                * Update record
.
.
. Check if this is the most recent referral renewal. If so we need to
. update the referral type, expiry date and renewal date
.
          CALL      LRNW0000
          BRANCH    EXIT,RENEWR29
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
. restore the original rererral type, expiry date and renewal date
.
          MOVE      ALRNNRTY,ALRERTYP       * New Type of Ref. (Cat RI)
          MOVE      ALRNNXDT,ALREREXP       * New Expiry Date (CCYYMMDD)
          MOVE      ALRNNRDT,ALRERRDT       * New Ref Renewal Date(CCYYMMDD
.
          CALL      UPALREF1                * Update the referral
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY2,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
RENEWR29  MOVE      ZERO,EXIT
          GOTO      RENEWR99
.
. Delete a referral renewal
.
RENEWR30  PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,RENEWR91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,RENEWR91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,RENEWR92
.
          PACK      KEY24,ALRNW001,ALRNW002,ALRNW003,SP70
          CALL      RDALRNW1
          BRANCH    OVRCD,RENEWR93
.
          CALL      MVALN000                   * Move cgi to file vars  
.
          CALL      IBACLOCK
          PACK      ALRNDDAT,CCC,CYY,CMM,CDD   * Set updated by fields
          REP       " 0",ALRNDDAT
          CLOCK     TIME,ALRNDTIM
          MOVE      USERID,ALRNDUID
.
          PACK      ALRNUDAT,CCC,CYY,CMM,CDD   * Set updated by fields
          REP       " 0",ALRNUDAT
          CLOCK     TIME,ALRNUTIM
          MOVE      USERID,ALRNUUID
.
          CALL      UPALRNW1                * Update record
. 
. Check if this is the most recent referral renewal. If so we need to
. update the referral type, expiry date and renewal date
.
          CALL      LRNW0000
          BRANCH    EXIT,RENEWR39
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
. restore the original rererral type, expiry date and renewal date
.
          MOVE      ALRNORTY,ALRERTYP  * Original Type of Ref. (Cat RI)
          MOVE      ALRNOXDT,ALREREXP  * Original Expiry Date (CCYYMMDD)
          MOVE      ALRNORDT,ALRERRDT  * Original Ref Renewal Date(CCYYMMDD
.
          CALL      UPALREF1                * Update the referral
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY3,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
RENEWR39  MOVE      ZERO,EXIT
          GOTO      RENEWR99
.
RENEWR80  CALL      CURPER00              * Display Routine
          CALL      CALCDT00              * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,RENEWR91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,RENEWR91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,RENEWR92
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY24,ALRNW001,ALRNW002,ALRNW003,SP70
          CALL      RDALRNW1
          IF        OVRCD=1
            CALL      CLALLRNW                    * Read nenewal audit file
          ENDIF
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,RENEWR94
.
RENEWR85  CLEAR     WEBTITLE
          MOVE      "Allied Health Renewed Referrals audit",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,RENEWR99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      RENEWR99
.
RENEWR90  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RENEWR99
.
RENEWR91  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RENEWR99
.
RENEWR92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RENEWR99
.
RENEWR93  MOVE      "Invalid Referral Renewal Audit.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RENEWR99
.
RENEWR94  MOVE      "Invalid Department.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RENEWR99
.
RENEWR99  RETURN
.
.-----------------------------------------------------------------------------.
. Check if the referral renewal record is the most recent on one file
.-----------------------------------------------------------------------------.
LRNW0000  PACK      KEY24,ALRNW001,Z70
          CALL      RSALRNW1
          CALL      RPALRNW1
          BRANCH    OVRCD,LRNW9000
.
          PACK      DIM24,ALRNVISN,ALRNRDAT,ALRNRTIM,SP70
          PACK      KEY24,ALRNW001,ALRNW002,ALRNW003,SP70
.
          MATCH     DIM24,KEY24
          GOTO      LRNW9000 IF NOT EQUAL
.
LRNW8000  MOVE      ZERO,EXIT          * Yes last record on file  
          GOTO      LRNW9999
.
LRNW9000  MOVE      ONE,EXIT           * No not the last record on file
          GOTO      LRNW9999
.
LRNW9999  RETURN
.-----------------------------------------------------------------------------.
. Referral Renewal Audit List
.-----------------------------------------------------------------------------.
RNTB0000  PACK      KEY24,ADMISSNO,Z70
          CALL      RSALRNW1
RNTB1000  CALL      RPALRNW1
          BRANCH    OVRCD,RNTB9999
.
          MATCH     ADMISSNO,ALRNVISN
          GOTO      RNTB9999 IF NOT EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRNORTY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ALRNORTY,TDESC
          ENDIF
          MOVE      TDESC,DISPORTY
.
          PACK      KEY5,ANSR,ANSI,ALRNNRTY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ALRNNRTY,TDESC
          ENDIF
          MOVE      TDESC,DISPNRTY
.
          PACK      KEY10,ALRNRUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      ALRNRUID,WBSENAM
          ENDIF
          MOVE      WBSENAM,DISPRUID
.
          PACK      KEY10,ALRNRRID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      ALRNRRID,WBSENAM
          ENDIF
          MOVE      WBSENAM,DISPRRID
.
          PACK      KEY10,ALRNCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      ALRNCUID,WBSENAM
          ENDIF
          MOVE      WBSENAM,DISPCUID
.
          PACK      KEY10,ALRNUUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      ALRNUUID,WBSENAM
          ENDIF
          MOVE      WBSENAM,DISPUUID
.
          MATCH     "1",ALRNSTAT
          IF        @EQUAL
            MOVE      "LineThrough",DISPSTAT
          ELSE
            MOVE      SP70,DISPSTAT
          ENDIF
.
          MOVE      SP70,DISPDAT1                * Clear assessment date
          UNPACK    ALRNRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "RenewRefLink('",HTMLLINK
          APPEND    ALRNVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDAT1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ALRNRTIM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",ALRNVISN,"#",":                   * 1
                             "#"",ALRNRDAT,"#",":                   * 2
                             "#"",ALRNRTIM,"#",":                   * 3
                             "#"",DISPRUID,"#",":                   * 4
                             "#"",DISPORTY,"#",":                   * 5
                             "#"",ALRNOXDT,"#",":                   * 6
                             "#"",ALRNORDT,"#",":                    * 7
                             "#"",DISPNRTY,"#",":                    * 8
                             "#"",ALRNNXDT,"#",":                    * 9
                             "#"",ALRNNRDT,"#",":                    * 10
                             "#"",DISPSTAT,"#",":                    * 11
                             "#"",ALRNRRDT,"#",":                    * 12
                             "#"",ALRNRRTM,"#",":                    * 13
                             "#"",DISPRRID,"#",":                    * 14
                             "#"",ALRNCDAT,"#",":                    * 15
                             "#"",ALRNCTIM,"#",":                    * 16
                             "#"",DISPCUID,"#",":                    * 17
                             "#"",ALRNUDAT,"#",":                    * 18
                             "#"",ALRNUTIM,"#",":                    * 19
                             "#"",DISPUUID,"#",":                    * 20
                             "#"",ALRNRDAT,ALRNRTIM,"#",":           * 21
                             "#"",ALRNCDAT,ALRNCTIM,"#",";           * 22
.
          MOVE      SP70,DOCFNAME
          CALL      CLPMSHCP
.
          PACK      KEY10,ALRNNRHC,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      KEY20,ALRNNRHC,ALRNNRHP,SP70
          CALL      RDPMHCL1
          IF        OVRCD<>1
            MOVE      PMHLPRV1,PMHCPRV1
          ENDIF
.
          WRITE     HTMLFILE;"#"",DOCFNAME,"<br>",PMHCPRV1,"#",";     * 23
. 
          MOVE      SP70,DOCFNAME
          CALL      CLPMSHCP
.
          PACK      KEY10,ALRNNRES,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;"#"",DOCFNAME,"<br>",PMHCPRV1,"#"":     * 24
                             ");"
          GOTO      RNTB1000
.
RNTB9999  RETURN
.
.-----------------------------------------------------------------------------.
. Write referral renewal audit record if renewing a
. specialist outpatient episode referral
.-----------------------------------------------------------------------------.
RNWA0000  COMPARE   ONE,RENEWREF                 * Are we renewing a SOP
          GOTO      RNWA9999 IF NOT EQUAL        * episode referral
.
          MATCH     "1",ALREUYN4                 * Espisode referrals only 
          GOTO      RNWA9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1                      * Read department
          BRANCH    OVRCD,RNWA9999
.
          MATCH     ANSO,TCINDC8                 * SOP referrals on
          IF        !@EQUAL
            MATCH     ANSS,TCINDC8               * SAC referrals only
            GOTO      RNWA9999 IF NOT EQUAL
          ENDIF
.
          CALL      IBACLOCK
          CALL      CLALLRNW                     * Clear file fields
.
          MOVE      ALREVISN,ALRNVISN  * Referral/Visit Number
          PACK      ALRNRDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRNRDAT           * Date Renewed (CCYYMMDD)
          CLOCK     TIME,ALRNRTIM           * Renewed Time (HH:MM:SS)
          MOVE      USERID,ALRNRUID         * Renewed By (websecaf)
.
          MOVE      SAVEORTY,ALRNORTY  * Original Type of Ref. (Cat RI)
          MOVE      SAVEOXDT,ALRNOXDT  * Original Expiry Date (CCYYMMDD)
          MOVE      SAVEORDT,ALRNORDT  * Original Ref Renewal Date(CCYYMMDD)
.
          MOVE      ALRERTYP,ALRNNRTY  * New Type of Ref. (Cat RI)
          MOVE      ALREREXP,ALRNNXDT  * New Expiry Date (CCYYMMDD)
          MOVE      ALRERRDT,ALRNNRDT  * New Ref Renewal Date(CCYYMMDD)
          MOVE      ZERO,ALRNSTAT      * Status
          MOVE      ALRNRDAT,ALRNCDAT  * Date Record Created (CCYYMMDD)
          MOVE      ALRNRTIM,ALRNCTIM  * Time Record Created (HH:MM:SS)
          MOVE      ALRNRUID,ALRNCUID  * WEB User ID Created (websecaf)
.
          MOVE      SAVEORES,ALRNORES  * Original Responsible HCP (pmshcpaf)
          MOVE      ALREHCP,ALRNNRES   * New Responsible HCP (pmshcpaf)
.
          MOVE      SAVEORHC,ALRNORHC  * Original Referring HCP (pmshcpaf)
          MOVE      SAVEORHP,ALRNORHP  * Original Referring HCP Practice
          MOVE      ALRERHCP,ALRNNRHC  * New Referring HCP (pmshcpaf)
          MOVE      ALRERHCR,ALRNNRHP  * New Referring HCP Practice
.
          PACK      KEY24,ALRNVISN,ALRNRDAT,ALRNRTIM,SP70
          CALL      RAALRNW1
          IF        OVRCD=1
            CALL      WRALRNW1
          ENDIF
.
RNWA9999  RETURN
+
.*****************************************************************************
.                 NHIDHBDS
.        Procedure to display NHI Domicile DHB Code (nz)
.***************************************************************************
          DEFPROC   NHIDHBDS
.
          INC       NHIDMCFD/INC
.
          OPEN      NHIDMCA1,"nhidmcaf"
.
NHIDHB00  PACK      NHDMDHB,SP70            * KEY4 already populated
          CALL      RDNHDM1
          BRANCH    OVRCD,NHIDOM99
.
          WRITE     HTMLFILE;NHDMDHB;
          GOTO      NHIDOM99
.
          INC       NHIDMCIO/INC
          INC       IBAOVRIO/INC
.
NHIDOM99  ENDPROC
+
.******************************************************************************
. ASTYP100   Output Assessment Type selection list based on care type         .
.******************************************************************************
ASTYP100  WRITE     HTMLFILE;"<option></option>"
.
          MOVE      ZERO,TCFORM6
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ASTYP199
.
          COMPARE   EIGHT,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"1#">GEM</option>"
          ENDIF
.
          COMPARE   TEN,TCFORM6
          IF        @EQUAL
... Screen yet to be designed
.....       WRITE     HTMLFILE;"<option value=#"2#">Maintenance</option>"
          ENDIF
.
          COMPARE   SEVEN,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"3#">":
                      "Palliative Care Assessment</option>"
          ENDIF
.
          COMPARE   SEVEN,TCFORM6
          IF        @EQUAL
... Screen yet to be designed
...         WRITE     HTMLFILE;"<option value=#"4#">":
...                   "Palliative RUG-ADL</option>"
          ENDIF
.
          COMPARE   NINE,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"5#">":
                      "HONOS</option>"
          ENDIF
.
          COMPARE   FOUR,TCFORM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"6#">":
                      "FIM Assessment</option>"
          ENDIF
.
ASTYP199  RETURN
+
.
.******************************************************************************
. REIS0000  - If we are reinstating an internal referral. Check the master
.             referrral is not rejected or cancelled
.******************************************************************************
REIS0000  MATCH     "1",ALREF083            * Master Referral
          GOTO      REIS9000 IF EQUAL
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN2
REIS1000  CALL      RKALRLN2
          BRANCH    OVRCD,REIS9000
.
          MATCH     ALRLLNKV,ADMISSNO
          GOTO      REIS9000 IF NOT EQUAL
.
          PACK      KEY8,ALRLVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,REIS9000
.
          MATCH     "4",ALRESTAT            * Primary referral cancelled
          GOTO      REIS8000 IF EQUAL
.
          MATCH     "5",ALRESTAT            * Primary referral rejected
          GOTO      REIS8100 IF EQUAL
.
          GOTO      REIS9000
.
REIS8000  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error : Can't reinstate referral ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referral is Cancelled.",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REIS9999
.
REIS8100  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error : Can't reinstate referral ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " Referral is Rejected.",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REIS9999
.
REIS9000  MOVE      ZERO,EXIT
          GOTO      REIS9999
.
REIS9999  RETURN
.
.------------------------------------------------------------
. Referral Booking Instruction Comments 
.------------------------------------------------------------
BOKCOM00  MOVE      ZERO,EXIT
          MATCH     SP70,ADMISSNO
          GOTO      BOKCOM05 IF NOT EQUAL
.
          CALL      REFXID00 
          BRANCH    EXIT,BOKCOM99
.         
BOKCOM05  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      BOKCOM40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Notes Formaction
          GOTO      BOKCOM10 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Notes Formaction
          GOTO      BOKCOM30 IF EQUAL
.
          GOTO      BOKCOM93
.
.         ************ ADD FORMACTION ***********
.
BOKCOM10  CALL      CHKVIS00           * Checks mandatory fields and for blanks
          BRANCH    EXIT,BOKCOM99
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,BOKCOM90
.
          CALL      ADDBIN00                * Add Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      BOKCOM99
.
.         ************ DELETE FORMACTION **********
.
BOKCOM30  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,BOKCOM90
.
          CALL      DELNOT00                * Delete Note SubRoutine
          BRANCH    EXIT,BOKCOM99
.
          MOVE      ZERO,EXIT
          GOTO      BOKCOM99
.
.         ************ DISPLAY FORMACTION **********
.
BOKCOM40  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,BOKCOM90
.
          MOVE      ALREURNO,URNUMBER
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,BOKCOM94
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      CLVNOT00     * Clear all the file variables
          ENDIF
.
          MOVE      "Booking Instruction Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,BOKCOM99
.
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      BOKCOM99
.
BOKCOM90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKCOM99
.
BOKCOM92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKCOM99
.
BOKCOM93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKCOM99
.
BOKCOM94  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKCOM99
.
BOKCOM99  CLOSE     COMFILVF,DELETE
          RETURN
.------------------------------------------------------------
. Validate Originating Referral ID and set ADMISSNO
.------------------------------------------------------------
REFXID00  MOVE      NOTENUMB,F6
          MOVE      F6,NOTENUMB
          MOVE      ZERO,EXIT
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,REFXID92
          IF        PSTAT=1 | PSTAT=2
            MOVE      PPSNAME,URNUMBER
            GOTO      REFXID00
          ENDIF
          PACK      KEY28,REFERXID,SP70
          CALL      RSIBALV2
REFXID10  CALL      RKIBALV2
          BRANCH    OVRCD,REFXID90
          MATCH     IBAVAVIS,REFERXID
          GOTO      REFXID90 IF NOT EQUAL
          MATCH     " 1",IBAVTYPE
          GOTO      REFXID10 IF NOT EQUAL
          MOVE      ONE,EXIT  * Set Flag Indicate XID Found, Error will be mismatch UR 
          PACK      KEY8,IBAVVISN,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,REFXID10
          MATCH     URNUMBER,PVIURNO
          GOTO      REFXID10 IF NOT EQUAL
          PACK      ADMISSNO,IBAVVISN,SP70
          MOVE      ZERO,EXIT
          GOTO      REFXID99
          
REFXID90  BRANCH    EXIT,REFXID91
          CLEAR     WEBTITLE
          APPEND    "Invalid Originating Referral Id - ",WEBTITLE
          APPEND    REFERXID,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          STRIP     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFXID99
.
REFXID91  CLEAR     WEBTITLE
          APPEND    "Invalid Originating Referral Id for Patient ID - ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          STRIP     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFXID99
.
REFXID92  CLEAR     WEBTITLE
          APPEND    "Invalid Patient ID - ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          STRIP     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFXID99
.
REFXID99  RETURN
.-----------------------------------------------------------
. * Checks mandatory fields, Checks admissno :cannot be blank
.------------------------------------------------------------
CHKVIS00  RESET     ADMISSNO
          MATCH     SP70,ADMISSNO
          GOTO      CHKVIS90 IF EQUAL
          GOTO      CHKVIS98
.
CHKVIS90  MOVE      "Admission number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKVIS99
.
CHKVIS98  MOVE      ZERO,EXIT
.
CHKVIS99  RETURN
.
.-----------------------------------------------------------
. Delete a Visit Note for a Patient
.-----------------------------------------------------------
DELNOT00  MATCH     SP70,ADMISSNO
          GOTO      DELNOT90 IF EQUAL
.
          MOVE      ADMISSNO,VSMDVISN   *  Visit Number
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          BRANCH    OVRCD,DELNOT92
.
          MATCH     "1",SUPRFLAG
          IF          !@EQUAL
            MATCH     SP70,VSMDUSER
            IF        !@EQUAL
              MATCH     USERID,VSMDUSER
              GOTO      DELNOT91 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      VSMDDDAT,CCC,CYY,CMM,CDD
          REP       " 0",VSMDDDAT
          CLOCK     TIME,VSMDDTIM
          MOVE      USERID,VSMDDUSE
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DELNOT99
.
          MOVE      WBSEOCG,VSMDDOCC
.
          MOVE      "1",VSMDDELT           * Delete Indicator
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      UPVSMDT1               * Write Record
          GOTO      DELNOT98
.
DELNOT90  MOVE      "Admission Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELNOT99
.
DELNOT91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELNOT99
.
DELNOT92  MOVE      "Invalid Note Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELNOT99
.
DELNOT98  MOVE      ZERO,EXIT
.
DELNOT99  RETURN
+
.--------------------------------------------------------------------------
. Booking Instruction Comments Maintenance
.--------------------------------------------------------------------------
VSMD0000  BRANCH    FLDITMNO,VSMD0100,VSMD0200,VSMD0300,VSMD0400,VSMD0500:
                             VSMD0600,VSMD0700,VSMD0800,VSMD0900,VSMD1000:
                             VSMD1100,VSMD1200
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      VSMD9999
.
VSMD0100  MATCH     SP70,VSMDTYPE
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDTYPE;
          GOTO      VSMD9999
.
VSMD0200  MATCH     SP70,VSMDNOTE
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDNOTE;
          GOTO      VSMD9999
.
VSMD0300  MATCH     SP70,VSMDDATE
          GOTO      VSMD9999 IF EQUAL
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      VSMD9999
.
VSMD0400  MATCH     SP70,VSMDTIME
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDTIME;
          GOTO      VSMD9999
.
VSMD0500  MATCH     SP70,VSMDUSER
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDUSER;
          GOTO      VSMD9999
.
VSMD0600  MATCH     SP70,VSMDOCCG
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDOCCG;
          GOTO      VSMD9999
.
VSMD0700  MATCH     SP70,VSMDDELT
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDDELT;
          GOTO      VSMD9999
.
VSMD0800  MATCH     SP70,VSMTCMNT
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMTCMNT;
          GOTO      VSMD9999
.
VSMD0900  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSMD0910  CALL      RKVSMTX1
          BRANCH    OVRCD,VSMD9999
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSMD9999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSMD0910 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSMD0910 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      VSMD0910
.
VSMD1000  MOVE      ZERO,NOTEORDR
          CALL      NOTTAB00
          GOTO      VSMD9999
.
VSMD1100  MOVE      ONE,NOTEORDR
          CALL      NOTTAB00
          GOTO      VSMD9999
.
VSMD1200  CALL      FHRNTB00         * FHIR Output of Notes
          GOTO      VSMD9999
.
VSMD9999  RETURN
.------------------------------------------------------------
. JSON/FHIR Output of Visit Note
.---------------------------------------------------------------------
FHRNTB00  MOVE      "005",NOTEFILT
          MOVE      ZERO,RECNUMB
          PACK      KEY17,ADMISSNO,NOTEFILT,Z70
          CALL      RSVSMDT1
FHRNTB10  CALL      RPVSMDT1
          BRANCH    OVRCD,FHRNTB99
          MATCH     ADMISSNO,VSMDVISN
          GOTO      FHRNTB99 IF NOT EQUAL
          MATCH     NOTEFILT,VSMDTYPE
          GOTO      FHRNTB99 IF NOT EQUAL
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      VSMDUSER,WBSENAM
          ENDIF
          MATCH     "1",VSMDDELT
          MOVE      "active",KEY7
          IF        @EQUAL
            MOVE      "deleted",KEY7
          ENDIF
          MOVE      "w0",KEY2
          MATCH     SP70,VSMDOCCG
          IF        @EQUAL
            MOVE      SP70,TDESC
          ELSE
            PACK      KEY5,KEY2,VSMDOCCG
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      VSMDOCCG,TDESC
            ENDIF
          ENDIF
          STRIP     TDESC
          STRIP     WBSENAM
          IF        RECNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          ADD       ONE,RECNUMB
          MOVE      VSMDNOTE,KEY6
          REP       " 0",KEY6   * Leading Spaces Not liked/legal in FHIR???
          WRITE     HTMLFILE;*+,"{ #"noteNumber#"  : #"",KEY6,"#",":
                    " #"inputDateTime#"   : #"",CCENT,CYEAR,"-",CMON,"-",CDAY:
                    "T",VSMDTIME,"Z#",":
                    " #"inputBy#"     : #"",WBSENAM,"#",":
                    " #"inputByRole#" : #"",TDESC,"#",": 
                    " #"noteStatus#"  : #"",KEY7,"#",":
                    " #"noteText#"    : #"";
          CALL      FHRMDT00
          WRITE     HTMLFILE;"#"}"
          GOTO      FHRNTB10
FHRNTB99  RETURN
.
FHRMDT00  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
FHRMDT10  CALL      RKVSMTX1
          BRANCH    OVRCD,FHRMDT99
          MATCH     VSMDVISN,VSMTVISN
          GOTO      FHRMDT99 IF NOT EQUAL
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      FHRMDT99 IF NOT EQUAL
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      FHRMDT99 IF NOT EQUAL
          STRIP     VSMTCMNT
          REP       "#"'",VSMTCMNT
          WRITE     HTMLFILE;*+,VSMTCMNT;
          GOTO      FHRMDT10
.
FHRMDT99  RETURN
.------------------------------------------------------------
. Display Table of Visit Note
.---------------------------------------------------------------------
NOTTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          CALL      NOTHD000      * Output Table Heading
.
          MOVE      ADMISSNO,VSMDVISN
.
          IF        NOTEORDR=0
            PACK      KEY17,ADMISSNO,NOTEFILT,Z70
          ELSE
            PACK      KEY17,ADMISSNO,NOTEFILT,SP70
          ENDIF
.
          CALL      RSVSMDT1
NOTTAB10  IF        NOTEORDR=0
            CALL      RPVSMDT1
          ELSE
            CALL      RKVSMDT1
          ENDIF
          BRANCH    OVRCD,NOTTAB99
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      NOTTAB99 IF NOT EQUAL
.
          MATCH     NOTEFILT,VSMDTYPE
          GOTO      NOTTAB99 IF NOT EQUAL
.
          MATCH     VSMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp",FBOKDATE
            GOTO     NOTTAB40
          ENDIF
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
NOTTAB40  MATCH     "1",VSMDDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",VSMDTYPE
          REP       " +",VSMDNOTE
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail13":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&admissno=",ADMISSNO:
                             "&notetype=",VSMDTYPE:
                             "&notenumb=",VSMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,VSMDTIME,"</td>";
.
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",VSMDOCCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,VSMDUSER," - ",VSMDOCCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",VSMDTYPE
          REP       "+ ",VSMDNOTE
.
          MOVE      ZERO,CTR
          CALL      VSNOTE00
.
          PACK      KEY10,VSMDDUSE,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",WBSENAM," - ",VSMDDOCC,"&nbsp":
                               "</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",VSMDDUSE," - ",VSMDDOCC,"&nbsp":
                               "</td>":
                               "</tr>"
          ENDIF
.
          GOTO      NOTTAB10
NOTTAB99  RETURN
.
.--------------------------------------------------------------------
. Visit note display
.--------------------------------------------------------------------
VSNOTE00  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSNOTE10  CALL      RKVSMTX1
          BRANCH    OVRCD,VSNOTE99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSNOTE99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSNOTE99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSNOTE99 IF NOT EQUAL
.
          COMPARE   TWO,CTR
          GOTO      VSNOTE99 IF EQUAL
          ADD       ONE,CTR
          WRITE     HTMLFILE;VSMTCMNT,"<br>";
          GOTO      VSNOTE10
.
VSNOTE99  RETURN
.
.------------------------------------------------------------
. Visit Not Heading (TABLE HEADING)
.------------------------------------------------------------
NOTHD000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=40%>";
.
          MATCH     "003",NOTEFILT
          IF        @EQUAL
            WRITE     HTMLFILE;"Comments</td>";
          ELSE
            WRITE     HTMLFILE;"Notes</td>";
          ENDIF
.
          WRITE      HTMLFILE;"<td class=HeadingCell width=20%>Delete By</td>":
                             "</tr>"
.
NOTHD999  RETURN
.
.------------------------------------------------------------
. Get Booking Instruction Comments
.------------------------------------------------------------
GETBIN00  PREP      COMFILVF,COMFILNV
          MOVE      ONE,F3
          WRITE     COMFILVF,SEQ;QRYDATA
.
GETBIN10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETBIN90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETBIN80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILVF,SEQ;QRYDATA
          GOTO      GETBIN10
.
GETBIN80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETBIN90  MOVE      F3,LASTITEM
          OPEN      COMFILVF,COMFILNV
GETBIN99  RETURN
.
.
.------------------------------------------------------------
.  Writing the visit Notes
.------------------------------------------------------------
ADDBIN00  MOVE      ZERO,F6
.
          PACK      KEY17,ADMISSNO,NOTETYPE,Z70
          CALL      RSVSMDT1
          CALL      RPVSMDT1                * read back to get last record
          IF        OVRCD=1
            MOVE      ONE,F6
            MOVE      F6,VSMDNOTE           * Note Number
          ELSE
            MATCH     ADMISSNO,VSMDVISN     * Same visit
            IF        @EQUAL
              MATCH     NOTETYPE,VSMDTYPE   * Same note type
              IF        @EQUAL
                MOVE      VSMDNOTE,F6
                ADD       ONE,F6
                MOVE      F6,VSMDNOTE
              ELSE
                MOVE      ONE,F6
                MOVE      F6,VSMDNOTE       * Note Number
              ENDIF
            ELSE
              MOVE      ONE,F6
              MOVE      F6,VSMDNOTE         * Note Number
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,VSMDVISN       * Visit number
          MOVE      NOTETYPE,VSMDTYPE       * Notes Type
.
          MOVE      SP70,VSMDDATE
          MOVE      SP70,VSMDTIME
          MOVE      SP70,VSMDUSER
          MOVE      SP70,VSMDOCCG
.
          PACK      VSMDDATE,CCC,CYY,CMM,CDD
          REP       " 0",VSMDDATE          * Date
          CLOCK     TIME,VSMDTIME
          MOVE      USERID,VSMDUSER        * User
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ADDBIN99
          MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
.
          MOVE      "0",VSMDDELT            * Delete Indicator
          MOVE      SP70,VSMDDDAT           * Delete Date
          MOVE      SP70,VSMDDTIM           * Delete Time
          MOVE      SP70,VSMDDUSE           * Delete User
          MOVE      SP70,VSMDDOCC           * Delete User Occupation group
          PACK      VSMDSPAR,SP70,SP70      * Spare
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      WRVSMDT1              * Write Record
          ELSE
            GOTO      ADDBIN99
          ENDIF
.
.         now write the visit notes
.
          IF        FHIRTYPE=1
            CALL      FHRMTX00    * Add comments from FHIR Post 
          ELSE 
            CALL      ADDMTX00    * Add comment details
          ENDIF
.
ADDBIN99  RETURN
.
. Add comment details
.
ADDMTX00  MOVE      VSMDVISN,VSMTVISN
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
.
ADDMTX10  ADD       ONE,F3
          MOVE      F3,VSMTUNIQ
.
          READ      COMFILVF,SEQ;VSMTCMNT
          GOTO      ADDMTX99 IF OVER
.
          MATCH     SP70,VSMTCMNT
          IF        @EQUAL
            BRANCH    BLNKFLAG,ADDMTX10
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDMTX20                   * don't write second blank line
          ENDIF
          IF        @EOS
            BRANCH    BLNKFLAG,ADDMTX10          * don't write second blank line
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDMTX20
          ENDIF
.
          MOVE      ZERO,BLNKFLAG
.
ADDMTX20  PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
          IF        F3>=LASTITEM
            GOTO     ADDMTX99
          ENDIF
          GOTO      ADDMTX10
.
ADDMTX99  RETURN
.
. Add comment details from FHIR Post with lines more that 240 characters long
.
FHRMTX00  MOVE      VSMDVISN,VSMTVISN
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
          MOVE      ZERO,RECCNT
.
FHRMTX10  ADD       ONE,RECCNT
          IF        RECCNT>LASTITEM
            GOTO     FHRMTX99
          ENDIF
          READ      COMFILVF,SEQ;QRYDATA
          GOTO      FHRMTX99 IF OVER
          UNPACK    QRYDATA,DIM100A,DIM100B,DIM40
.
          ADD       ONE,F3
          MOVE      F3,VSMTUNIQ
          MOVE      DIM100A,VSMTCMNT
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          MATCH     SP70,DIM100B
          IF        !@EQUAL
            ADD       ONE,F3
            MOVE      F3,VSMTUNIQ
            MOVE      DIM100B,VSMTCMNT
            PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
            CALL      WRVSMTX1
          ENDIF
.
          MATCH     SP70,DIM40
          IF        !@EQUAL
            ADD       ONE,F3
            MOVE      F3,VSMTUNIQ
            PACK      VSMTCMNT,DIM40,SP70
            PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
            CALL      WRVSMTX1
          ENDIF
.
          GOTO      FHRMTX10
.
FHRMTX99  RETURN
.******************************************************************************
.  Validate a referral number and return details
.******************************************************************************
VALREF00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                * Read a Record
          BRANCH    OVRCD,VALREF90
.
          MOVE      ONE,FORM3
          PACK      KEY13,ADMISSNO,ZERO4,FORM3,SP70  * Referral in service type
          CALL      RDALRHL1
          IF        OVRCD=1
            CALL     CLALLRHL
          ENDIF
.
VALREF80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              ALRESTAT,"|",ALRERDAT,"|",ALREPRTY,"|":
                              ALREDREC,"|",ALRHCODE,"|",ALRETRGS,"|": 
                              ALRETRGD,"|":
                    "</RETURN_VALUE>"
          GOTO      VALREF99
.
VALREF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid Referral Number : ",ADMISSNO:
                    "</RETURN_VALUE>"
          GOTO      VALREF99
.
VALREF99  RETURN
.
.
.******************************************************************************
.  Get local gp/practice for U/R and return details
.******************************************************************************
GETLGP00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1                 * Read PMI
          BRANCH    OVRCD,GETLGP90
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21                * Read PMI Extn 2
          BRANCH    OVRCD,GETLGP90
.
          PACK      DOCFNAME,SP70,SP70
.
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1                * Read HCP
          BRANCH    OVRCD,GETLGP50
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
GETLGP50  PACK      JAVPNAME,SP70,SP70
.
          PACK      KEY12,PMPXRH1G,PMPXR1GC,SP70
          CALL      RDPMHCG1                 * Read ractice if one exists
          BRANCH    OVRCD,GETLGP80
.
          MOVE      PMHGPNAM,JAVPNAME
          SCAN      "'",JAVPNAME             * Find any apostrophies
          GOTO      GETLGP80 IF NOT EQUAL
.
          MOVE      JAVPNAME,HCGENAME
          REP       "' ",HCGENAME            * Remove the apostrophy
.
          LENSET    JAVPNAME
          RESET     JAVPNAME                 * Get all characters before '
          MOVE      JAVPNAME,HCGSNAME
.
          REP       "'%",HCGSNAME
          STRIP     HCGSNAME
          PACK      JAVPNAME,HCGSNAME,SIXTY,HCGENAME,SP70 * formatted name
.
GETLGP80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              PMPXRHC1,"|",DOCFNAME,"|",PMPXRH1G,"|":
                              PMPXR1GC,"|",JAVPNAME,"|":
                    "</RETURN_VALUE>"
          GOTO      GETLGP99
.
GETLGP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid U/R Number : ",URNUMBER:
                    "</RETURN_VALUE>"
          GOTO      GETLGP99
.
GETLGP99  RETURN
.
.******************************************************************************
.  Validate an episode referral and return the appropriate program referral
.  department
.******************************************************************************
PRODEP00  MOVE      SP70,PROGDEPT                 * Program referral department
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1                      * Read the referral
          BRANCH    OVRCD,PRODEP90
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PRODEP80
.
          MATCH     SP70,TCINDC8                  * Exit if no VINAH program
          GOTO      PRODEP80 IF EQUAL
.
          MATCH     ANSE,TCINDC11                 * Combined referral episode
          GOTO      PRODEP80 IF NOT EQUAL         * department
.
          MOVE      TCINDC8,PROGCODE              * Save episode program type
.
          PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
PRODEP10  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,PRODEP80
.
          MATCH     "CG",TCODE
          GOTO      PRODEP80 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      PRODEP10 IF EQUAL
.
          MATCH     ANSP,TCINDC11                 * Combined referral program
          GOTO      PRODEP10 IF NOT EQUAL         * department
.
          MATCH     PROGCODE,TCINDC8              * Same VINAH program type
          GOTO      PRODEP10 IF NOT EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,PRODEP10
.
          MATCH     "1",ALDEACTV
          GOTO      PRODEP10 IF EQUAL             * Skip Inactive
.
          IF        IBCNMHOS=1
            MATCH     SP70,ALDEHOSP
            IF        !@EQUAL
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  MATCH     WBSEHOSP,ALDEHOSP
                  GOTO      PRODEP10 IF NOT EQUAL
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ALDEDEPT,PROGDEPT                
.
PRODEP80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              PROGDEPT,"|":
                    "</RETURN_VALUE>"
          GOTO      PRODEP99
.
PRODEP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid Referral Number : ",ADMISSNO:
                    "</RETURN_VALUE>"
          GOTO      PRODEP99
.
PRODEP99  RETURN

+
.******************************************************************************
.Validations for closing episode referrals                                    *
.******************************************************************************
SACER000  MATCH     "1",ALREUYN4            * SACS Referral
          GOTO      SACER950 IF EQUAL
.
          MOVE      ZERO,CONTFLAG           * Linked contact exists flag
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALENC1
SACER510  CALL      RKALENC1
          BRANCH    OVRCD,SACER900
.
          MATCH     ADMISSNO,ALENVISN
          GOTO      SACER900 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA            * Cancelled encounter
          GOTO      SACER510 IF EQUAL
.
          MOVE      ONE,CONTFLAG            * Linked contact exists

SACER900  PACK      KEY5,ANSC,ANSG,DEPTCODD,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SACER950          * A closed VINAH episode referral
.                                           * must have a linked contact
          MATCH     ANSE,TCINDC8            * HEN
          GOTO      SACER950 IF EQUAL
.
          MATCH     ANSL,TCINDC8            * TPN
          GOTO      SACER950 IF EQUAL
.
          MATCH     ANSD,TCINDC8            * HBD
          GOTO      SACER950 IF EQUAL
.
          MATCH     ANSM,TCINDC8            * Medi-Hotel
          GOTO      SACER950 IF EQUAL
.
          MATCH     SP70,TCINDC8
          IF        !@EQUAL
            COMPARE   ZERO,CONTFLAG
            GOTO      SACER930 IF EQUAL
          ENDIF
.
SACER950  MOVE      ZERO,EXIT
          GOTO      SACER999
.
SACER930  SQUEEZE   ALCNMDES
          CLEAR     WEBTITLE
          APPEND    "Error closing ",WEBTITLE
          APPEND    ALCNMDES,WEBTITLE
          APPEND    " referral - Please Reject/Cancel as no linked ",WEBTITLE
          APPEND    "contacts exist",WEBTITLE
          RESET     WEBTITLE
          RESET     ALCNMDES
          CALL      WEBERR00
          CALL      UUALREF1                * locked in calling function
          MOVE      ONE,EXIT
          GOTO      SACER999
.
SACER999  RETURN
.
.-----------------------------------------------------------------------------.
.  Link unlink waiting list record to a referral
.-----------------------------------------------------------------------------.
WATLNK00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      WATLNK80 IF EQUAL
.
          MATCH     "U",UPDATETY           * Unlink W/L from a referral
          GOTO      WATLNK10 IF EQUAL
.
          MATCH     "R",UPDATETY           * Quick Re-Link W/L to a referral
          GOTO      WATLNK20 IF EQUAL
.
          GOTO      WATLNK90
.
WATLNK10  CALL      ULNW0000                * Unlink WL from a referral
          BRANCH    EXIT,ALLLNK99
.
          CALL      LNKW0000                * Link WL to a referral
          BRANCH    EXIT,ALLLNK99
.
          MOVE      ZERO,EXIT
          GOTO      WATLNK99
.
WATLNK20  PACK      KEY8,REFERRAL,SP70
          CALL      RDALREF1                               * Read new link to
          BRANCH    OVRCD,WATLNK92                         * referral
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1                                * Check department
          BRANCH    OVRCD,WATLNK93                         * using WL links
.
          MATCH     ANSW,PTCDASC4
          GOTO      WATLNK93 IF NOT EQUAL
.
          PACK      KEY19,WAITLIST,SP70
          CALL      RDALWLN1
          BRANCH    OVRCD,WATLNK93
.
          MOVE      REFERRAL,ALWLVISN      * Assign new referral number
.
          CALL      UPALWLN1
.         
          MOVE      ZERO,EXIT
          GOTO      WATLNK99
.
WATLNK80  CALL      CURPER00               * Display Routine
          CALL      CALCDT00              * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70     * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,WATLNK91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,WATLNK91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,WATLNK92
.
WATLNK85  CLEAR     WEBTITLE
          MOVE      "Allied Health Referrals Linked Waiting List",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,WATLNK99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      WATLNK99
.
WATLNK90  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATLNK99
.
WATLNK91  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATLNK99
.
WATLNK92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATLNK99
.
WATLNK93  MOVE      "Invalid Referral/Waiting List Link.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATLNK99
.
WATLNK94  MOVE      "Referral Department No Using Waiting List Links.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATLNK99
.
WATLNK99  RETURN
.
.------------------------------------------------------------
. Output table of linked WL procedures for a referral
.------------------------------------------------------------
LINKW000  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,LINKW999
.
          PACK      KEY27,ALREVISN,SP70
          CALL      RSALWLN2
LINKW100  CALL      RKALWLN2                               * Loop linked WL
          BRANCH    OVRCD,LINKW999
.
          MATCH     ALREVISN,ALWLVISN                      * Same referral
          GOTO      LINKW999 IF NOT EQUAL
.
          PACK      KEY19,ALWLURNO,ALWLPCOD,ALWLPCNT,SP70
          CALL      RDTREA1                                * Read WL record
          BRANCH    OVRCD,LINKW100
.
          MOVE      SP70,DISPDAT1                          * Date in list
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      SP70,DOCFNAME
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE         
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
.
          LOAD      STATDESC,WMSTAT,WAITST01,WAITST02,WAITST03,WAITST04:
                             WAITST05,WAITST06,WAITST07,WAITST08,WAITST09
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",UNITDESC,"&nbsp;</td>":
                             "<td>",DOCFNAME,"&nbsp;</td>":
                             "<td>",WMDESC,"&nbsp;</td>":
                             "<td>",STATDESC,"&nbsp;</td>":
                             "<td><input type=checkbox name=unlkwait ":
                             "value=#"",WMURNO,WMCODE,WMCNT,"#">&nbsp;":
                             "<img src=../images/ViewIcon.gif ":
                             "alt='Quick re-link' ":
                             "onclick='WLRelink(#"":
                              ALWLURNO,"#",#"":
                              ALWLVISN,"#",#"":
                              ALWLURNO,ALWLPCOD,ALWLPCNT,"#");'>":
                             "</td></tr>";
.
          GOTO      LINKW100
.
LINKW999  RETURN
.
.------------------------------------------------------------
. Output table of un linked WL procedures for a referral
.------------------------------------------------------------
ULNKW000  PACK      KEY8,ADMISSNO
          CALL      RDALREF1
          BRANCH    OVRCD,ULNKW999
.
          PACK      KEY19,ALREURNO,SP70
          CALL      RDSTREA1
ULNKW100  CALL      RDKTREA1                               * Loop WL
          BRANCH    OVRCD,ULNKW999
.
          MATCH     ALREURNO,WMURNO                        * Same U/R
          GOTO      ULNKW999 IF NOT EQUAL
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDALWLN1
          IF        OVRCD<>1
            GOTO      ULNKW100                             * Skip if linked
          ENDIF
.
          MOVE      SP70,DISPDAT1                          * Date in list
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      SP70,DOCFNAME
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
.
          LOAD      STATDESC,WMSTAT,WAITST01,WAITST02,WAITST03,WAITST04:
                             WAITST05,WAITST06,WAITST07,WAITST08,WAITST09
.
          WRITE     HTMLFILE;"<tr><td>",DISPDAT1,"&nbsp;</td>":
                             "<td>",UNITDESC,"&nbsp;</td>":
                             "<td>",DOCFNAME,"&nbsp;</td>":
                             "<td>",WMDESC,"&nbsp;</td>":
                             "<td>",STATDESC,"&nbsp;</td>":
                             "<td><input type=checkbox name=linkwait ":
                             "value=#"",WMURNO,WMCODE,WMCNT,"#">&nbsp;":
                             "</td></tr>";
.
          GOTO      ULNKW100
.
ULNKW999  RETURN
.
.------------------------------------------------------------
. Unlink WL from a referral
.------------------------------------------------------------
ULNW0000  MOVE      ONE,F3
ULNW1000  IF        F3<=UNLKWEND
            MATCH     UNLKWAIT[F3],SP70
            IF        !@EQUAL
               PACK      KEY19,UNLKWAIT[F3],SP70
               CALL      RDALWLN1
               IF        OVRCD=0
                 CALL      DEALWLN1
               ENDIF
            ENDIF
            ADD       ONE,F3
            GOTO      ULNW1000
          ENDIF
.
          MOVE      ZERO,EXIT
.
ULNW9999  RETURN
.
.------------------------------------------------------------
. Link WL to a referral
.------------------------------------------------------------
LNKW0000  MOVE      ONE,F3
LNKW1000  IF        F3<=LINKWEND
            MATCH     LINKWAIT[F3],SP70
            IF        !@EQUAL
               UNPACK    LINKWAIT[F3],ALWLURNO,ALWLPCOD,ALWLPCNT
               MOVE      ADMISSNO,ALWLVISN
               MOVE      SP70,ALWLSPAR

               PACK      KEY19,ALWLURNO,ALWLPCOD,ALWLPCNT,SP70
               CALL      RDALWLN1
               IF        OVRCD=1
                 CALL      WRALWLN1
               ENDIF
            ENDIF
            ADD       ONE,F3
            GOTO      LNKW1000
          ENDIF
.
          MOVE      ZERO,EXIT
.
LNKW9999  RETURN
.
.-----------------------------------------------------------------------------
. Referral audit maintenance
.-----------------------------------------------------------------------------
ALLAUD00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ALLAUD80 IF EQUAL
.
          MATCH     "U",UPDATETY           * Update referral audit
          GOTO      ALLAUD10 IF EQUAL
.
          MATCH     "D",UPDATETY           * Delete referral audit
          GOTO      ALLAUD20 IF EQUAL
.
          GOTO      ALLAUD90
.
ALLAUD10  PACK      KEY24,ALLAUDKY,SP70
          CALL      RDALAUD1
          BRANCH    OVRCD,ALLAUD93
.
          MOVE      ACTNCODE,ALAUACTI
          MOVE      COMMENTY,ALAUCOMM
          CALL      SETDAT00
.
          CALL      UPALAUD1
          BRANCH    OVRCD,ALLAUD93
.  
          MOVE      ZERO,EXIT
          GOTO      ALLAUD99
.
ALLAUD20  PACK      KEY24,ALLAUDKY,SP70
          CALL      RDALAUD1
          BRANCH    OVRCD,ALLAUD93
.
          MOVE      "MD",ALAUUPDT
          CALL      SETDAT00
.
          CALL      UPALAUD1
          BRANCH    OVRCD,ALLAUD93
.  
          MOVE      ZERO,EXIT
          GOTO      ALLAUD99
.
ALLAUD80  UNPACK    ALLAUDKY,ADMISSNO,DIM8,DIM8
          PACK      KEY8,ADMISSNO 
          CALL      RDALREF1
          BRANCH    OVRCD,ALLAUD92
.
          PACK      KEY24,ALLAUDKY,SP70
          CALL      RDALAUD1
          BRANCH    OVRCD,ALLAUD93
.
          MOVE      "Referral Audit Maintenance",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALLAUD99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ALLAUD99 
.
ALLAUD90  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLAUD99
.
ALLAUD92  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLAUD99
.
ALLAUD93  MOVE      "Invalid Referral Audit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLAUD99
.
ALLAUD99  RETURN
.
.-----------------------------------------------------------------------------
. Set common update details
.-----------------------------------------------------------------------------
SETDAT00  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,ALAUUDAT
          MOVE      CTIMEIS,ALAUUTIM
          MOVE      USERID,ALAUUUID
.
SETDAT99  RETURN
.
.*******************************************************************************
. When using the create program button to create a program referral. Auto
. reject the new program referral if the linked episode referral is rejected
. Requires CHECKREF - Internal Referral Number
.*******************************************************************************
RMAS0000  PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Read the referral to see if it's
          BRANCH    OVRCD,RMAS9999          * an internal referral
.
          MATCH     "1",ALREUYN4            * Exit if not an internal referral
          GOTO      RMAS9999 IF EQUAL
.
          MATCH     "5",ALRESTAT            * Exit if not rejected
          GOTO      RMAS9999 IF NOT EQUAL
.
          MOVE      ALRESREJ,SAVISREJ       * Save reason for rejection
          MOVE      ALRESRDT,SAVISRDT       * Save rejection date
          MOVE      ALRESRTM,SAVISRTM       * Save rejection time
.
          MOVE      SP70,MASTREFN           * Clear master referral number
.
          PACK      KEY16,CHECKREF,SP70
          CALL      RSALRLN2                * Determine master referral number
          CALL      RKALRLN2
          BRANCH    OVRCD,RMAS9999
.
          MATCH     CHECKREF,ALRLLNKV       * Linked referrals
          GOTO      RMAS9999 IF NOT EQUAL
.
          MOVE      ALRLVISN,MASTREFN       * Save master referral number

          PACK      KEY8,MASTREFN,SP70
          CALL      RDALREF1                * Read the master referral
          BRANCH    OVRCD,RMAS9999
.
          MATCH     "1",ALREUYN4            * Exit if not an master referral
          GOTO      RMAS9999 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * Exit if not waiting
          GOTO      RMAS9999 IF NOT EQUAL
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MOVE      "5",ALRESTAT            * Set status to rejected
          MOVE      SAVISREJ,ALRESREJ       * Set reason for rejection
          MOVE      SAVISRDT,ALRESRDT       * Set rejection date
          MOVE      SAVISRTM,ALRESRTM       * Set rejection time
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      UPALREF1                * Update referral Table (allrefaf)
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY5,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      ALRESRDT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
.
          MOVE      "J ",UPDTTYPE           * Update type
          CALL      WRTRAU00                * write to the referral audit table
.
          PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Re read original referral
          IF        OVRCD=1
            CALL      CLALLREF
            CALL      CLALLEID
          ENDIF
.
RMAS9999  RETURN
+
.******************************************************************************
.         MHCA0000 - Add main health condition 1 and 2 (SOP)
.******************************************************************************
MHCA0000  MOVE      ZERO,FORM3            
.
          MATCH     Z70,MHCON001            * Main health condition 1
          GOTO      MHCA5000 IF EQUAL 
.
          MATCH     SP70,MHCON001            * Main health condition 1
          GOTO      MHCA5000 IF EQUAL
          GOTO      MHCA5000 IF EOS
.
          CALL      CLALLRHL
          MOVE      ADMISSNO,ALRHVISN
          MOVE      ZERO1,ALRHTYPE
          ADD       ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
          MOVE      MHCON001,ALRHCODE
.
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
.
          PACK      KEY13,ADMISSNO,ZERO1,FORM3,SP70
          CALL      RAALRHL1
          IF        OVRCD=1
            CALL      WRALRHL1
          ENDIF
.
MHCA5000  MATCH     Z70,MHCON002            * Main health condition 2
          GOTO      MHCA9999 IF EQUAL
.
          MATCH     SP70,MHCON002           * Main health condition 2
          GOTO      MHCA9999 IF EQUAL
          GOTO      MHCA9999 IF EOS
.
MHCA2000  CALL      CLALLRHL
          MOVE      ADMISSNO,ALRHVISN
          MOVE      ZERO1,ALRHTYPE
          ADD       ONE,FORM3
          MOVE      FORM3,ALRHUNIQ
          MOVE      MHCON002,ALRHCODE
.
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
.
          PACK      KEY13,ADMISSNO,ZERO1,FORM3,SP70
          CALL      RAALRHL1
          IF        OVRCD=1
            CALL      WRALRHL1
          ENDIF
.
          GOTO      MHCA9999
.
MHCA9999  RETURN
+
.******************************************************************************
.         MHCQ0000 - Add/Upd/Del main health condition 1 and 2 (SOP)
.******************************************************************************
MHCQ0000  MATCH     Z70,MHUNQ001            * Main health condition 1 unqique no
          GOTO      MHCQ9999 IF EQUAL
.
          MATCH     Z70,MHCON001            * Main health condition 1
          GOTO      MHCQ9999 IF EQUAL
.
          PACK      KEY13,ADMISSNO,ZERO1,Z70
          CALL      RSALRHL1
          CALL      RPALRHL1                * Get next unique number
          BRANCH    OVRCD,MHCQ2000
.
          MATCH     ADMISSNO,ALRHVISN
          GOTO      MHCQ2000 IF NOT EQUAL
.
          MATCH     ZERO1,ALRHTYPE
          GOTO      MHCQ2000 IF NOT EQUAL
.
          GOTO      MHCQ3000
.
MHCQ2000  MOVE      ZERO,FORM3
          GOTO      MHCQ4000
.
MHCQ3000  MOVE      ZERO,FORM3
          MOVE      ALRHUNIQ,FORM3
.
MHCQ4000  CALL      CLALLRHL                * Clear allrhlaf file vars
.
          MOVE      ADMISSNO,ALRHVISN
          MOVE      ZERO1,ALRHTYPE
          MATCH     SP70,MHUNQ001           * Set unique number to 1 if blank
          IF        @EQUAL
            MATCH     SP70,MHCON001
            GOTO      MHCQ5000 IF EQUAL     * Nothing to add
.
            ADD       ONE,FORM3
            MOVE      FORM3,MHUNQ001
          ENDIF
.
          MOVE      MHUNQ001,ALRHUNIQ
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      RDALRHL1
          IF        OVRCD=1
            MOVE      MHCON001,ALRHCODE
            PACK      ALRHCUID,USERID
            PACK      ALRHCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALRHCDAT
            CLOCK     TIME,ALRHCTIM
.
            CALL      WRALRHL1              * Write main health condition
          ELSE
            MATCH     SP70,MHCON001
            IF        @EQUAL
              CALL      DEALRHL1              * Delete main health condition
              GOTO      MHCQ5000
            ENDIF
.
            MATCH     MHCON001,ALRHCODE     * No change
            GOTO      MHCQ5000 IF EQUAL
.
            MOVE      MHCON001,ALRHCODE
            PACK      ALRHCUID,USERID
            PACK      ALRHCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALRHCDAT
            CLOCK     TIME,ALRHCTIM
.
            CALL      UPALRHL1              * Update main health condition
          ENDIF
.
MHCQ5000  MATCH     Z70,MHUNQ002            * Main health condition 2 unqique no
          GOTO      MHCQ9999 IF EQUAL
. 
          MATCH     Z70,MHCON002            * Main health condition 2
          GOTO      MHCQ9999 IF EQUAL
.
          CALL      CLALLRHL                * Clear allrhlaf file vars
.
          MOVE      ADMISSNO,ALRHVISN
          MOVE      ZERO1,ALRHTYPE
          MATCH     SP70,MHUNQ002           * Set unique number to 1 if blank
          IF        @EQUAL
            MATCH     SP70,MHCON002
            GOTO      MHCQ9999 IF EQUAL     * Nothing to add
.
            ADD       ONE,FORM3
            MOVE      FORM3,MHUNQ002
          ENDIF
.
          MOVE      MHUNQ002,ALRHUNIQ
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      RDALRHL1
          IF        OVRCD=1
            MOVE      MHCON002,ALRHCODE
            PACK      ALRHCUID,USERID
            PACK      ALRHCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALRHCDAT
            CLOCK     TIME,ALRHCTIM
.
            CALL      WRALRHL1              * Write main health condition
          ELSE
            MATCH     SP70,MHCON002
            IF        @EQUAL
              CALL      DEALRHL1              * Delete main health condition
              GOTO      MHCQ9999
            ENDIF
.
            MATCH     MHCON002,ALRHCODE     * No change
            GOTO      MHCQ9999 IF EQUAL
.
            MOVE      MHCON002,ALRHCODE
            PACK      ALRHCUID,USERID
            PACK      ALRHCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALRHCDAT
            CLOCK     TIME,ALRHCTIM
.
            CALL      UPALRHL1              * Update main health condition
          ENDIF
.
MHCQ9999  RETURN
.
.------------------------------------------------------------
. Referral Audit table file
.------------------------------------------------------------
ALAU0000  BRANCH    FLDITMNO,ALAU0010,ALAU0020,ALAU0030,ALAU0040,ALAU0050:
                             ALAU0060,ALAU0070,ALAU0080,ALAU0090
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      ALRE9999
.
ALAU0010  MOVE      ALAUADAT,INPDATE
          CALL      DSPDAT00
          WRITE     HTMLFILE;OUTDATE;
          GOTO      ALRE9999
.
ALAU0020  WRITE     HTMLFILE;ALAUATIM;
          GOTO      ALRE9999
.
ALAU0030  WRITE     HTMLFILE;ALAUCOMM;
          GOTO      ALRE9999
.
ALAU0040  PACK      KEY10,ALAUAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      KEY10,WBSENAM 
          ENDIF
.
          MOVE      ALAUADAT,INPDATE
          CALL      DSPDAT00
.
          MOVE      SP70,KEY60
          APPEND    WBSENAM,KEY60
          APPEND    " on ", KEY60
          APPEND    OUTDATE,KEY60
          APPEND    " at ",KEY60
          APPEND    ALAUATIM,KEY60
          WRITE     HTMLFILE;KEY60
          GOTO      ALRE9999
.
ALAU0050  PACK      KEY10,ALAUUUID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      KEY10,WBSENAM
          ENDIF
.
          MATCH     SP70,ALAUUDAT
          GOTO      ALRE9999 IF EQUAL
. 
          MOVE      ALAUUDAT,INPDATE
          CALL      DSPDAT00
.
          MOVE      SP70,KEY60
          APPEND    WBSENAM,KEY60
          APPEND    " on ", KEY60
          APPEND    OUTDATE,KEY60
          APPEND    " at ",KEY60
          APPEND    ALAUUTIM,KEY60
          WRITE     HTMLFILE;KEY60
          GOTO      ALRE9999
.
ALAU0060  MOVE      "LF",CATEGORY
          MOVE      ALAUACTI,CODE
          CALL      CODITM00
          GOTO      ALRE9999
.
ALAU0070  WRITE     HTMLFILE;ALAUUPDT;
          GOTO      ALRE9999
.
ALAU0080  WRITE     HTMLFILE;ALAUVISN;
          GOTO      ALRE9999
.
ALAU0090  MOVE      SP70,ALLAUDKY
          PACK      KEY24,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          WRITE     HTMLFILE;KEY24;
          GOTO      ALRE9999
.
ALAU9999  RETURN
.
.------------------------------------------------------------
. Convert the internal date to display date format
. Input:  INPDATE  - CCYYMMDD (19800310) 
.         FHIRTYPE - 0 or 1    
. Return: OUTDATE
.         If FHIRTYPE = 0 Returns (10 MAR 1980)
.         If FHIRTYPE = 1 Returns (1980-MAR-10)
.------------------------------------------------------------
DSPDAT00  MOVE      SP70,OUTDATE
          MATCH     SP70,INPDATE;
          GOTO      DSPDAT99 IF EQUAL
          GOTO      DSPDAT99 IF EOS
          UNPACK    INPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      DSPDAT99 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          IF        FHIRTYPE=0
            PACK    OUTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            PACK    OUTDATE,CCENT,CYEAR,DASH,CMON,DASH,CDAY
          ENDIF
.
DSPDAT99  RETURN
.
.-----------------------------------------------------------
. Write EDWARD referral alteration record
.------------------------------------------------------------
WEDR0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDR9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDR9999 IF EQUAL
.
          MOVE      ALREVISN,PMAWVISN
          MOVE      SIX,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
WEDR5000  CALL      RKALLNK1
          BRANCH    OVRCD,WEDR9999
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      WEDR9999 IF NOT EQUAL
.
          MOVE      ALLNLNKV,PMAWVISN
          MOVE      FIVE,PMAWTYPE                * OP Visit Update
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
          GOTO      WEDR5000
.
WEDR9999  RETURN
.
.------------------------------------------------------------
. Write EDWARD OP visit update trigger after encounter add
.------------------------------------------------------------
WEDT0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDT9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDT9999 IF EQUAL
.
          MATCH     SP70,ALLNLNKV           * Linked visit
          GOTO      WEDT9999 IF EQUAL
.
          MOVE      ALLNLNKV,PMAWVISN
          MOVE      FIVE,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1              * Write OP visit update
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEDT9999  RETURN
.
..------------------------------------------------------------
.. Additional HCPs Indicator for DEPTCODE
..------------------------------------------------------------
.IN1HCP00  MOVE      SP70,DOCINDIC
..
.          MATCH     SP70,DEPTCODE
.          GOTO      IN1HCP99 IF EQUAL
.          GOTO      IN1HCP99 IF EOS
..
.          MOVE      DEPTCODE,CODE
.          MOVE      "CG",CATEGORY
.          CALL      GETCOD00
..
.          MATCH     "A",TCINDC22
.          GOTO      IN1HCP99 IF NOT EQUAL
..
.          MOVE      "1",DOCINDIC
..
.IN1HCP99  RETURN
..
..------------------------------------------------------------
.. Additional HCPs Indicator for FILTDEPT
..------------------------------------------------------------
.IN2HCP00  MOVE      SP70,DOCINDIC
..
.          MATCH     SP70,FILTDEPT
.          GOTO      IN2HCP99 IF EQUAL
.          GOTO      IN2HCP99 IF EOS
..
.          MOVE      FILTDEPT,CODE
.          MOVE      "CG",CATEGORY
.          CALL      GETCOD00
..
.          MATCH     "A",TCINDC22
.          GOTO      IN2HCP99 IF NOT EQUAL
..
.          MOVE      "1",DOCINDIC
..
.IN2HCP99  RETURN
..
.------------------------------------------------------------
. Additional HCPs Indicator for ALREDEPT
.------------------------------------------------------------
INDHCP00  MOVE      SP70,DOCINDIC
.
          MATCH     SP70,ALREDEPT
          GOTO      INDHCP99 IF EQUAL
          GOTO      INDHCP99 IF EOS
.
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
.
          MATCH     "A",TCINDC22
          GOTO      INDHCP99 IF NOT EQUAL
.
          MOVE      "1",DOCINDIC
.
INDHCP99  RETURN
.
.
.------------------------------------------------------------
. Additional HCPs
.------------------------------------------------------------
ADDHCP00  MOVE      SP70,DOCFNAM3
          MOVE      SP70,DOCFNAM4
          MOVE      SP70,DOCFNAM5
          MOVE      SP70,DOCFNAM6
.         MOVE      SP70,DOCINDIC
.
.         MOVE      ALREDEPT,CODE
.         MOVE      "CG",CATEGORY
.         CALL      GETCOD00          
.
.         MATCH     "A",TCINDC22
.         GOTO      ADDHCP99 IF NOT EQUAL
.
.         MOVE      "1",DOCINDIC
.
          MATCH     "1",DOCINDIC
          GOTO      ADDHCP99 IF NOT EQUAL
.
          MATCH     SP70,ALREUHC2
          IF        !@EQUAL
            PACK      KEY10,ALREUHC2,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM3
            ENDIF
          ENDIF 
.
          MATCH     SP70,ALREUHC3
          IF        !@EQUAL
            PACK      KEY10,ALREUHC3,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM4
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC5
          IF        !@EQUAL
            PACK      KEY10,ALREUHC5,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM5
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC6
          IF        !@EQUAL
            PACK      KEY10,ALREUHC6,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM6
            ENDIF
          ENDIF
.
ADDHCP99  RETURN
+
.******************************************************************************
.*T0881801 Get Linked visit, reason for Adm and location
.******************************************************************************
LLOCN000  MOVE      SP70,LNKVREAS            * Linked Visit & Reason for Adm
          MOVE      SP70,LNKVLOCN            * Linked Visit Location
.
          MATCH     "1",ALCNLKVM             * Linked Visit parm on?
          GOTO      LLOCN999 IF NOT EQUAL    * No, exit
.
          MATCH     SP70,ALRELINK
          GOTO      LLOCN999 IF EQUAL | EOS
.
.-------- Get Linked Visit - Visit Type (patvisfd.pvitype)
          PACK      KEY8,ALRELINK,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,LLOCN999
.
          COMPARE   ONE,PVITYPE                  * Emergency Visit
          GOTO      LLOCN100 IF EQUAL
.
          COMPARE   TWO,PVITYPE                  * Outpatient Visit
          GOTO      LLOCN200 IF EQUAL
.
          COMPARE   THREE,PVITYPE                * Inpatient Visit
          GOTO      LLOCN300 IF EQUAL
.
          IF        PVITYPE = 9
            CLEAR     LNKVREAS
            APPEND    "RF  ",LNKVREAS            * Referral Visit
            APPEND    ALRELINK,LNKVREAS
            RESET     LNKVREAS
            GOTO      LLOCN999
          ENDIF
.
          GOTO      LLOCN999                     * All other visits
.
.======== Emergency Visit - Linked Visit/Reason for Adm and Location
LLOCN100  PACK      KEY8,ALRELINK,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,LLOCN999
.
          MOVE      SP70,TDESC
          PACK      KEY5,CATel,EMVIUC20,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LLOCN999
.
          CLEAR     LNKVREAS
          APPEND    "ED  ",LNKVREAS
          APPEND    ALRELINK,LNKVREAS
          APPEND    "<br>",LNKVREAS
          APPEND    TDESC,LNKVREAS
          RESET     LNKVREAS
          GOTO      LLOCN110
.
.-------- Emergency Visit Location
LLOCN110  COMPARE   ONE,EMVISTAT                 * Current EMR visit
          GOTO      LLOCN120 IF NOT EQUAL
.
.-------- e.g. Observation Room 2  (in bold)
          PACK      KEY3,EMVILOCN,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,LLOCN999
.
          CLEAR     LNKVLOCN
          APPEND    "<b>",LNKVLOCN
          APPEND    EMLODESC,LNKVLOCN
          APPEND    "</b>",LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999
.
LLOCN120  IF        EMVISTAT = 2 | EMVISTAT = 3
            CLEAR     LNKVLOCN
            APPEND    "Discharged ",LNKVLOCN     * Discharged EMR Visit
            RESET     LNKVLOCN
            GOTO      LLOCN999
          ELSE
            GOTO      LLOCN140
          ENDIF
.
LLOCN140  COMPARE   FOUR,EMVISTAT                * Cancelled EMR visit
          GOTO      LLOCN999 IF NOT EQUAL
.
          CLEAR     LNKVLOCN
          APPEND    "Cancelled ",LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999
.
.======== Outpatient Visit - Linked Visit and Location
LLOCN200  CLEAR     LNKVREAS                     * Outpatient Visit
          APPEND    "OP  ",LNKVREAS
          APPEND    ALRELINK,LNKVREAS
          RESET     LNKVREAS
.
.-------- Clinic Description Location
.-------- eg.Orthopaedic Registrar
          PACK      KEY36,ALRELINK,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,LLOCN999
.
          MATCH     ALRELINK,DOBAOUTN
          GOTO      LLOCN999 IF NOT EQUAL

          PACK      KEY20,OBASITE,OBACLIN,SP70
          CALL      RDSCLIA1
          CALL      RDKCLIA1
          BRANCH    OVRCD,LLOCN999
.
          MATCH     OBASITE,OCASITE
          GOTO      LLOCN999 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      LLOCN999 IF NOT EQUAL
.
          CLEAR     LNKVLOCN
          APPEND    OCADESC,LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999
.
.======== Inpatient Visit - Linked Visit/Reason for Adm and Location
LLOCN300  PACK      KEY8,ALRELINK,SP70
          CALL      RDPTMIS1
          BRANCH    OVRCD,LLOCN999
.
          CLEAR     LNKVREAAS
.
          IF        ASTAT = 2
            APPEND    "<b>IP</b>  ",LNKVREAS     * Bold for current IP
          ELSE
            APPEND    "IP  ",LNKVREAS
          ENDIF
.
          APPEND    ALRELINK,LNKVREAS
          APPEND    "<br>",LNKVREAS
          APPEND    ADIAG1,LNKVREAS
          RESET     LNKVREAS
.
          GOTO      LLOCN310
.
.-------- Inpatient Visit Location
LLOCN310  COMPARE   ONE,ASTAT                    * Preadmitted Adm
          GOTO      LLOCN320 IF NOT EQUAL
.
.-------- e.g. Hosp: WEL Preadmitted
          CLEAR     LNKVLOCN
.
          IF        IBCNMHOS = 1
            APPEND    "Hosp: ",LNKVLOCN
            APPEND    PMVXMHOS,LNKVLOCN
            APPEND    SP1,LNKVLOCN
          ENDIF
.
          APPEND    "Preadmitted ",LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999
.
LLOCN320  COMPARE   TWO,ASTAT                    * Current Inpatient Adm
          GOTO      LLOCN330 IF NOT EQUAL
.
.-------- e.g. Hosp: WEL 4B  / 021  (on bold)
          CLEAR     LNKVLOCN
          APPEND    "<b>",LNKVLOCN
.
          IF        IBCNMHOS = 1
            APPEND    "Hosp: ",LNKVLOCN
            APPEND    PMVXMHOS,LNKVLOCN
            APPEND    SP1,LNKVLOCN
          ENDIF
.
          APPEND    AWARD,LNKVLOCN
          APPEND    " / ",LNKVLOCN
          APPEND    ABED,LNKVLOCN
          APPEND    "</b>",LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999
.
LLOCN330  COMPARE   THREE,ASTAT                  * Discharged Adm
          GOTO      LLOCN340 IF NOT EQUAL
.
.-------- e.g. Hosp: WEL Discharged
          CLEAR     LNKVLOCN
.
          IF        IBCNMHOS = 1
            APPEND    "Hosp: ",LNKVLOCN
            APPEND    PMVXMHOS,LNKVLOCN
            APPEND    SP1,LNKVLOCN
          ENDIF
.
          APPEND    "Discharged ",LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999
.
LLOCN340  COMPARE   FOUR,ASTAT                   * Adm On Leave
          GOTO      LLOCN350 IF NOT EQUAL
.
.-------- e.g. Hosp: WEL On Leave  (in bold)
          CLEAR     LNKVLOCN
          APPEND    "<b>",LNKVLOCN
.
          IF        IBCNMHOS = 1
            APPEND    "Hosp: ",LNKVLOCN
            APPEND    PMVXMHOS,LNKVLOCN
            APPEND    SP1,LNKVLOCN
          ENDIF
.
          APPEND    "On Leave </b>",LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999

LLOCN350  COMPARE   FIVE,ASTAT                   * Cancelled Pre-adm
          GOTO      LLOCN999 IF NOT EQUAL
.
.-------- e.g. Hosp: WEL Cancelled
          CLEAR     LNKVLOCN
.
          IF        IBCNMHOS = 1
            APPEND    "Hosp: ",LNKVLOCN
            APPEND    PMVXMHOS,LNKVLOCN
            APPEND    SP1,LNKVLOCN
          ENDIF
.
          APPEND    "Cancelled ",LNKVLOCN
          RESET     LNKVLOCN
          GOTO      LLOCN999
.
LLOCN999  RETURN
+
.*****************************************************************************
.*                                OA08R000                                   *
.*      Trigger an A08 HL7 update on link/unlink visits to a referral        *
.*****************************************************************************
OA08R000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1                    * PMI record found ?
          BRANCH    OVRCD,OA08R999             * no - don't send message
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21                   * PMI extension record found ?
          BRANCH    OVRCD,OA08R999             * no - don't send message
.
.         Linked visits
.
          MOVE      ONE,F3
OA08R100  COMPARE   F3,LINKEND
          GOTO      OA08R500 IF LESS           * end of linked visits ?
.
          MATCH     LINKVIST[F3],SP70
          GOTO      OA08R100 IF EQUAL          * blank visit ?
.
          MOVE      LINKVIST[F3],D8            * visit number
.
          MOVE      TWENTY6,HL7TRGID
          CALL      OA08M000                   * Outpatient A08 HL7 update
.
          ADD       ONE,F3
          GOTO      OA08R100                   * get next visit
.
.         Uninked visits
.
OA08R500  MOVE      ONE,F3
OA08R600  COMPARE   F3,UNLKEND
          GOTO      OA08R999 IF LESS           * end of unlinked visits  ?
.
          MATCH     UNLKVIST[F3],SP70
          GOTO      OA08R600 IF EQUAL          * blank visit ?
.
          MOVE      UNLKVIST[F3],D8            * visit number
.
          MOVE      TWENTY7,HL7TRGID
          CALL      OA08M000                   * Outpatient A08 HL7 update
.
          ADD       ONE,F3
          GOTO      OA08R600                   * get next visit
.
OA08R999  RETURN
+
.*****************************************************************************
.*                                OA08V000                                   *
.*      Trigger an A08 HL7 update after link/unlink of referrals to a visit  *
.*****************************************************************************
OA08V000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1                    * PMI record found ?
          BRANCH    OVRCD,OA08V999             * no - don't send message
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21                   * PMI extension record found ?
          BRANCH    OVRCD,OA08V999             * no - don't send message
.
          MATCH     ADMISSNO,SP70
          GOTO      OA08V999 IF EQUAL          * blank visit ?
.
          MOVE      ADMISSNO,D8                * visit number
.
          MOVE      TWENTY8,HL7TRGID
          CALL      OA08M000                   * Outpatient A08 HL7 update
.
OA08V999  RETURN
+
.*****************************************************************************
.*                                OA08M000                                   *
.*      Trigger an Outpatient A08 HL7 update message (D8=outpatient number)  *
.*****************************************************************************
.
.         Get the outbokaf record
.
OA08M000  PACK      KEY36,D8,SP20,SP20
          CALL      RDSBOKA6                   * position on visit number
          CALL      RDKBOKA6                   * read next record
          BRANCH    OVRCD,OA08M999             * eof - finished
.
          MATCH     DOBAOUTN,D8                * same visit number ?
          GOTO      OA08M999 IF NOT EQUAL      * no - finished
.
.         Get the outbb1af record
.
          MOVE      D8,KEY8
          CALL      RDBOKB1                    * outbb1af record found ?
          BRANCH    OVRCD,OA08M999             * no
.
          CALL      CLOUTRSH                   * clear unused variables
          CALL      CLOUTCAN
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB                   * send update visit details
.
OA08M999  RETURN
+
.*****************************************************************************
.*                                DSCH0000                                   *
.*      JSON Allied Health Referrals                                         *
.*****************************************************************************
.
DSCH0000  IF        FHIRTYPE=0
            WRITE     HTMLFILE;"function AddReferralRows() {"
          ENDIF
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2
DSCH0100  CALL      RKALREF2
          BRANCH    OVRCD,DSCH9000
.
          MATCH     ALREURNO,URNUMBER                      *Same UR Number
          GOTO      DSCH9000 IF NOT EQUAL
.
          MATCH     "1",ALRESTAT
          GOTO      DSCH0100 IF NOT EQUAL
.
DSCH0200  MOVE      ALREDEPT,CODE                       * Get Dept Description
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,DEPDESC
.
          MOVE      "PR",CATEGORY                       * Get Priorty Descript
          MOVE      ALREPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MOVE      "CL",CATEGORY                       * Compensation Descript
          MOVE      ALRECOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,COMPDESC
.
          MOVE      SP70,DOCFNAM2                     * Get referring Dr
          PACK      KEY10,ALREHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,DOCFNAM2
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(",QUOTE,DEPDESC,QUOTE,COMMA,QUOTE;
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEEK
          MOVE      CMON,F2
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR,QUOTE:
                    COMMA,QUOTE,DOCFNAM2,QUOTE:               *Dr Name
                    COMMA,QUOTE;
          MATCH     ALREPRO1,SP70
          IF        !@EQUAL
            PACK      KEY12,ALREDEPT,ALREPRO1,SP70
            CALL      RDALPRR1
            WRITE     HTMLFILE;ALPRDESC;
          ENDIF
          WRITE     HTMLFILE;QUOTE:                           *Problem Desc
                    COMMA,QUOTE,PRIODESC,QUOTE:               *Priority
                    COMMA,QUOTE,COMPDESC,QUOTE,");"           *Compensation
.
          GOTO      DSCH0100
.
DSCH9000  IF        FHIRTYPE=0
            WRITE     HTMLFILE;"}"
          ENDIF
          GOTO      DSCH9999
.
DSCH9999  RETURN
+
.******************************************************************************
          INC       ACCAUDIO/INC
          INC       ACCDIAIO/INC
          INC       ALLAEFIO/INC
          INC       ALLHDTIO/INC
          INC       ALLLNKIO/INC
          INC       ALLBIAIO/INC
          INC       ALLCASIO/INC
          INC       ALLCCTIO/INC
          INC       ALLDADIO/INC
          INC       ALLEIDIO/INC
          INC       ALLREFIO/INC
          INC       ALLRSAIO/INC
          INC       ALLAUDIO/INC
          INC       ALLDEPIO/INC
          INC       ALLDLLIO/INC
          INC       ALLDIAIO/INC
          INC       ALLEXTIO/INC
          INC       ALLGROIO/INC
          INC       ALLGRPIO/INC
          INC       ALLGPAIO/INC
          INC       ALLGREIO/INC
          INC       ALLISSIO/INC
          INC       ALLLINIO/INC
          INC       ALLLETIO/INC
          INC       ALLLPCIO/INC
          INC       ALLRLNIO/INC
          INC       ALLPROIO/INC
          INC       ALLPRRIO/INC
          INC       ALLQUEIO/INC
          INC       ALLRITIO/INC
          INC       ALLRNWIO/INC
          INC       ALLSASIO/INC
          INC       ALLSERIO/INC
          INC       ALLSTSIO/INC
          INC       ALLTMPIO/INC
          INC       ALLWLNIO/INC
          INC       ALLADSIO/INC
          INC       ALLRIOIO/INC
          INC       APSMASIO/INC            * <SB-CHANGES17.07.2001>
          INC       CLACCAUD                    * Clear ACC Audit file variable
          INC       DISMASIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
          INC       EMRICDIO/INC            * EA Diagnosis Codes
          INC       EMRLOCIO/INC            * Emergency location      *T0881801
          INC       EMRVISIO/INC            * Emergency visit         *T0881801
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       IBAALVIO/INC
          INC       IBAPOLIO/INC
          INC       IBAPOSIO/INC
          INC       IBALPCIO/INC
          INC       OUTARTIO/INC
          INC       OUTCTYIO/INC
          INC       OUTCLIIO/INC
          INC       PATDO1IO/INC
          INC       PATEORIO/INC
          INC       PATIN1IO/INC            * <SB-CHANGES17.07.2001>
          INC       PATMA1IO/INC
          INC       PMSCEXIO/INC
          INC       PMSPX2IO/INC
          INC       PMSQPTIO/INC
          INC       PATVISIO/INC
.          INC       PATGPCTM
.          INC       PATGPCIO/INC
.          INC       PATGPPIO/INC
          INC       PMSVX1IO/INC
          INC       IBALPCCD
          INC       IBAWEBCD
          INC       ALLAEFTM
          INC       ALLBIATM
          INC       ALLEXTTM
          INC       ALLEIDTM
          INC       ALLREFTM
          INC       ALLSASTM
          INC       ALLENCTM
          INC       ALLISSTM
          INC       BRHLCOMN
          INC       CLALLAUD
          INC       CLALLBIA
          INC       CLALLRHL
          INC       CLALLSAS
          INC       CLALLRNW
          INC       NAMSTRCD
          INC       PATDOCTM
          INC       PATMASTM
          INC       PATFIMTM
          INC       CLPATFIM
          INC       PMSMMSTM
          INC       CLPMSPX2
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPATVIS
          INC       CLPMSHCP
          INC       CLPMSVX1
          INC       CLMEHDIA
          INC       CLMEHVIS
          INC       CLOUTCAN
          INC       CLOUTRSH
          INC       CLPMSQPX
          INC       GENANVIS
.
          INC       PMSPX2TM
          INC       PMSHCGTM                * <SB-CHANGES17.07.2001>
          INC       PMSHCLTM                * <SB-CHANGES17.07.2001>
          INC       PMSHCPTM                * <SB-CHANGES17.07.2001>
          INC       PMSCDNDS
          INC       PATMSXTM
          INC       CALCAGE
          INC       PATNAMCD
          INC       PATVISTM
          INC       DAYOFWEK
          INC       CLALLAEF
          INC       CLALLENC
          INC       CLALLEXT
          INC       CLALLREF
          INC       CLPMSWX1
          INC       WEBDATCD
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       DGCLICEA                * DG API Create Encounter  I-090202
          INC       DGCLICED                * DG API Delete Encounter  I-090202
          INC       DGCLICEU                * DG API Update Encounter
          INC       DGCLICOB
          INC       DGCLICUP
          INC       DGCLII12
          INC       DGCLII13
          INC       DGCLII14
          INC       OUTDANTM
          INC       PMIGTNID
          INC       TFILENAM
          INC       OUTCANIO/INC
          INC       OUTDCHIO/INC
          INC       OUTDCOIO/INC       * OP direct comments
          INC       OUTDANIO/INC       * OP direct actions
          INC       OUTMA1IO/INC
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBOCIO/INC
          INC       OPRNURIO/INC
          INC       OUTSESIO/INC
          INC       OUTHEDIO/INC
          INC       MEHCJAIO/INC
          INC       MEHLEGIO/INC
          INC       MEHDIAIO/INC
          INC       MEHHONIO/INC
          INC       MEHHLSIO/INC
          INC       MEHDLSIO/INC
          INC       MEHVI1IO/INC
          INC       PATALRIO/INC
          INC       PATHSPIO/INC
          INC       PATMI1IO/INC
          INC       PATPR1IO/INC
          INC       PATFIMIO/INC
          INC       PMSMMSIO/INC
          INC       PATFN1IO/INC
          INC       PATVADIO/INC
          INC       PATWR1IO/INC
          INC       PMSAIDIO/INC
          INC       PMSADWIO/INC
          INC       PMSCDNIO/INC
          INC       MLTSECIO/INC
          INC       MLTSITIO/INC
          INC       MRTMASIO/INC
          INC       OBSPCOIO/INC
          INC       OBSPCTIO/INC
          INC       OUTRF1IO/INC
          INC       ALLENCIO/INC
          INC       ALLEMDIO/INC            * medications details file
          INC       ALLITVIO/INC            * intervention details file
          INC       ALLSUPIO/INC            * supplies details file
          INC       ALLMDTIO/INC            * (needed for ALLENCTM)
          INC       ALLMTXIO/INC
          INC       ALLITMIO/INC            * Allied Health Item File
.
.         INC       PATGPCTM
.         INC       PATGPCIO/INC
.         INC       PATGPPIO/INC
          INC       PATNIDIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PRIITMIO/INC
          INC       VISMTXIO/INC
          INC       VISMDTIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       ALLRHLIO/INC
          INC       ALLLHIIO/INC
          INC       ALLRNWTM
          INC       ALLRHLTM
          INC       PATCLMTM
          INC       PATMISTM
          INC       PATDSCTM
          INC       MEHHONTM
          INC       CLPATDSC
          INC       PATASFIO/INC
          INC       PATATRIO/INC            * Patient Attributes
          INC       PATCMCIO/INC
          INC       PATDADIO/INC
          INC       PATDSCIO/INC
          INC       PATITMIO/INC
          INC       PATDGWIO/INC
          INC       PATRE1IO/INC
.
          INC       PATWC1IO/INC
          INC       PMSWX1IO/INC
          INC       PATWMAIO/INC
          INC       PATWVEIO/INC
          INC       PMSCTCIO/INC
          INC       PATPEIIO/INC
.          INC       PMSIPLIO/INC
          INC       PMSCCDIO/INC            * Concession Card Details
.
.          INC       PMSIPLCD
          INC       VINAHDEF
          INC       PMSCURIO/INC
          INC       PMSRUGIO/INC
          INC       PMSRUGTM
          INC       PMSIMPIO/INC
          INC       PMSIMPTM
          INC       WATTR1IO/INC
          INC       UPEREFVS
          INC       TIMEDIFS
.
          INC       CHKWCCLM           * Check multiple Workers Comp claims
          INC       CLPATWC1           * Clear WC/ACC Claim variables
.
          INC       OUTBB1IO/INC
