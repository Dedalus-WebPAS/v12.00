*
.* EDWEMERG - This is a routine used by IBAPMS40 to extract NSW EDWARD        *
.*            Emergency Department Data                                       *
.*                                                                            *
.* PARAMETERS  :                                                              *
.* RETURNS     :                                                              *
.* Mods        :                                                              *
.* V12.00.02 08/07/2025 Nikitha B      Task 0961300                           *
.*            Added ICD10 ED 13 code for object 56 and object 61.             *
.* V12.00.01 03/06/2025 Ebon Clements  Task 0959669                           *
.*           Changed initial assessor EVENT_SUB_EVENT_RECORD_ID to include    *
.*           seconds (removed year)                                           *
.*           Obj 141 sub event 04 - EDMM1200 & EDTT0000                       *
.* V11.04.04 29/10/2024 Ebon Clements  Task 0952514                           *
.*           Reorder diagnosis sequence number Obj 61 - EDII0000              *
.* V11.04.03 22/10/2024 Ebon Clements  Task 0952857                           *
.*           Changed initial assessor PROVIDER_RECORD_ID to include seen      *
.*           by seconds (remove month)- Obj 63 EDJJ9000                       *
.* V11.04.02 10/10/2024 Nikitha B      Task 0952518                           *
.*           Added ICD10 ED 12 code with 47146 value at EDII1000 & EDII5000   *
.*           for Object 61                                                    * 
.*           Added ICD10 ED 12 code with 47639 value at EDGG3000 for object 56* 
.* V11.04.01 21/12/2023 Ebon Clements  Task 0888745                           *
.*           Fixed NEWMV source created/modified date obj 142 - EDEE0000      *
.* V11.03.08 30/10/2023 Ebon Clements  Task 0888745                           *
.*           Added delete ED location object 142 functionality - EDUU0000     *
.* V11.03.07 24/05/2022 Nikitha B      Task 0932585                           *
.*           Read EMCNHSID parameter if HEALTH_SERVICE_LOCATION_ID  for       *
.*           Edward Extract at ELOC2000                                       *
.* V11.03.06 05/05/2023 DA Sarkies   TSK 0924970                              *
.*           Made Changes to SUB_EVENT_TYPE_CODE 11 in OBJECT 141             * 
.*           SUB_EVENT_ISP_ID_TYPE_CODE                                       * 
.*           SUB_EVENT_ISP_SOURCE_ID                                          * 
.*           SUB_EVENT_ISP_ID                                                 * 
.* V11.03.05 05/05/2023 Sunny        TSK 0924872                              *
.*           Changed SUB_EVENT_STATUS value to 3 from 4 in Object 141 for     * 
.*           SERVICE_EVENT_SUB_EVENT_TYPE_CODE = 12                           * 
.* V11.03.04 17/03/2023 Bella Turco    Task 0924037                           *
.*           Fixed EFFECTIVE_END_DATE for Triage Nurse being reported as      *
.*           start date of second not first doctor in EDJJ9500                *
.* V11.03.03 14/03/2023 Bella Turco    Task 0924037                           *
.*           Fixed RESPONSIBLE_PROVIDER_FLAG being reported as blank          *
.*           for Triage Nurse in EDJJ9700                                     *
.* V11.03.02 03/03/2023 Bella Turco    Task 0924037                           *
.*           Fixed EFFECTIVE_END_DATE when sending Triage Nurse EMVITRNS for  *
.*           Obj 63 in EDJJ9500                                               *
.* V11.03.01 14/11/2022 Bella Turco    Task 0923504                           *
.*           Read EMVIEXRS or EMVIDISD accoding to EMCNSEDR parameter in      *
.*           EDDD0000                                                         *
.* V11.02.03 13/10/2022 Ebon Clements  Task 0923658                           *
.*           Don't send obj 60 SERVICE_EVENT_ATTRIBUTE_TYPE_CODE 02 records   *
.*           EDHH0000                                                         *
.* V11.02.02 16/06/2022 Ebon Clements  Task 0915275                           *
.*           Only send ready to depart object 141-10 if data exists - EDMM2400*
.*           Only delete last sent record for object 141-04 if data exists    *
.*           otherwise delete all records. If data has not changed it will    *
.*           overwrite the delete - EDTT0000 EDMM1200                         *
.*           Changed EMDIMDCD to be reported in DIM10C - EDJJ9000             *
.* V11.02.01 01/03/2022 Ebon Clements  Task 0915275                           *
.*           Added inital assessor time seen to object key for obj 141-04     *
.*           to allow delete records to be sent - EDTT0000 ADMM1200           *
.*           Always delete ready to depart object 141-10 prior to reporting   *
.*           the existing values as no trigger exists. The current value      *
.*           will over write the delete if nothing has changed EDMM2400       *
.* V11.01.02 18/08/2021 Ebon Clements  Task 0904255                           *
.*           Added triage nurse to obj 64, 141(01) and 141(02)                *
.*           EDJJ0000 and EDMM0000                                            *
.* V11.01.01 18/05/2021 Ebon Clements  Task 0886023                           *
.*           Added PTCNEXED - Collect extra container information test        *
.*           to report new object 64 - EDBB0000                               *
.* V11.00.15 09/12/2020 Ebon Clements  Task 0900804                           *
.*           Report the ED ready to depart date/time for ED obj 141 sub event *
.*           10 - SUB_EVENT_EFFECTIVE_DATETIME - EDMM2400                     *
.* V11.00.14 17/09/2020 Ebon Clements  Task 0897131                           *
.*           Use the trigger date/time for the source created/modified        *
.*           date/time for service event delay records triggered from an ED   *
.*           visit update - OBJ 137 - EDDD0000                                *
.* V11.00.13 10/09/2020 Ebon Clements  Task 0897082                           *
.*           Set RESPONSIBLE_PROVIDER_FLAG to Y for initial assessor          *
.*           if not seen by another ED doctor Obj 63 - EDJJ9000               *
.*           Skip blank doctor history records Obj 63 - EDJJ5000              *
.* V11.00.12 10/09/2020 Ebon Clements  Task 0897079                           *
.*           Added ICD10 ED 11 test to ACTIVITY_REF_DOMAIN_ID OBJ 56 EDGG0000 *
.* V11.00.11 10/09/2020 Ebon Clements  Task 0897090                           *
.*           Report arrival date in AMBULANCE_INCIDENT_CREATE_DATETIME        *
.*           if ambulance date is blank - EDKK0000                            *
.*           10/09/2020 Ebon Clements  Task 0897140                           *
.*           Don't send object 141 sub events 14 and 15. Comment out code     *
.*           14 Emergency Department - Hospital bed ready  EDMM3200           *
.*           15 Emergency Department - Hospital ward ready EDMM3300           *
.* V11.00.10 03/09/2020 Ebon Clements  Task 0896781                           *
.*           Replace tilde with dash in presenting complaint obj 145 EDKK0000 *
.*           Removed 04 from SERVICE_EVENT_SUB_EVENT_RECORD_ID obj 141        *
.*           sub event 04 initial assessor - EDTT0000 EMMM1200                *
.* V11.00.09 23/06/2020 Ebon Clements  Task 0893464                           *
.*           Removed sequence number from the DIAGNOSIS_CODE obj 61           *
.*           EDII0000                                                         *
.*           Send blank in presenting issue source, domian and code obj 59    *
.*           Send presenting complaint description in comments obj 59         *
.*           EDPR0000 EDFF0000                                                *
.* V11.00.08 17/06/2020 Ebon Clements  Task 0893191                           *
.*           Report employment status user defined field 3 in Obj 145         *
.*           SERVICE_EVENT_START_EMPLOY_STATUS_CODE  - EDKK0000               *
.* V11.00.07 17/06/2020 Ebon Clements  Task 0893191                           *
.*           Report 23856 for ICD10 Ed11 DIAGNOSIS_REF_DOMAIN_ID obj 61       *
.*           EDII0000                                                         *
.* V11.00.06 03/06/2020 Ebon Clements  Task 0892602                           *
.*           Fixed value of VISITNUM in Obj 141 - 04 EDTT0000                 *
.* V11.00.05 01/06/2020 Ebon Clements  Task 0892602                           *
.*           Report the initial assessor in Obj 63 and Obj 141 - 04 (EMVIMDCD)*
.*           Seen by nurse details will not be reported at all                *
.* V11.00.04 29/05/2020 Ebon Clements  Task 0892523                           *
.*           Fixed source created date/time when  SDATFLAG=1 EDDD0000 EDHH0000*
.* V11.00.03 18/05/2020 Ebon Clements  Task 0891871                           *
.*           Report the initial assessor in Obj 63 - EMVIMDCD - EDJJ0000      *
.*           Report the initial assessor in Obj 141 - 05 and nurses in        *
.*           Obj 141 - 04 - EDMM0000                                          *
.* V11.00.02 12/05/2020 Ebon Clements  Task 0891731                           *
.*           Report employment status code of 6 as 9 is expired - EDKK0000    *
.* V11.00.01 05/05/2020 Ebon Clements  Task 0891432                           *
.*           Fixed Report OBJ 63 on the ED visit creation date if no supervior*
.*           updates have been made - CHJJ0000                                *
.* V10.15.06 08/01/2020 Ebon Clements  Task 0886928                           *
.*           Report effective date/time from seen date/time not the           *
.*           transaction date/time - Obj 63 EDJJ0000                          *
.* V10.15.05 12/12/2019 Ebon Clements  Task 0886202                           *
.*           Fixed nurse record OBJECTKY for obj 63 - EDJJ8900                *
.* V10.15.04 20/11/2019 Ebon Clements  Task 0885033                           *
.*           Don't report diagnosis code DNW - Did not wait. Obj 61 EDII0000  *
.* V10.15.03 11/11/2019 Ebon Clements  Task 0883803                           *
.*           Set visit alteration OBJ 137 service event delay delete          *
.*           source modified time to 23:59:00 - EDDD0000                      *
.* V10.15.02 25/10/2019 Ebon Clements  Task 0883471                           *
.*           Report OBJ 63 on the ED visit creation date if no supervior      *
.*           updates have been made - CHJJ0000                                *
.* V10.15.01 01/10/2019 Ebon Clements  Task 0882467                           *
.*           Removed leading space from new U/R after merge  - EMRG0000       *
.* V10.14.22 18/09/2019 Ebon Clements  Task 0881751                           *
.*           Send SERVICE_EVENT_SUB_EVENT_TYPE_LOCAL_CODE for obj 141         *
.*           sub events 10 to 15 - EDMM0000                                   *
.* V10.14.21 03/09/2019 Ebon Clements  Task 0878980                           *
.*           Report site-location for SERVICE_EVENT_LOCATION_RECORD_ID        *
.*           and HEALTH_SERVICE_LOCATION_LOCAL_ID obj 142 - EDEE0000          *
.* V10.14.20 22/08/2019 Ebon Clements  Task 0880317                           *
.*           Added date/time to SERVICE_EVENT_LOCATION_RECORD_ID Obj 142      *
.*           EDEE0000                                                         *
.* V10.14.19 22/08/2019 Ebon Clements  Task 0880317                           *
.*           Fixed ISP_DISC_SPEC_CODE - EDJJ0000                              *
.* V10.14.18 16/08/2019 Ebon Clements  Task 0879942                           *
.*           Send blank OSP_LOCAL_ID for OBJ 63 "I" records - EDJJ0000        *
.* V10.14.17 31/07/2019 Ebon Clements  Task 0878559                           *
.*           Set presenting_issue_record_id to 1 for Obj 59 EDFF0000 EDPR0000 *
.* V10.14.16 05/07/2019 Ebon Clements  Task 0877753                           *
.*           Send a blank obj 59 presenting issue start date EDFF0000 EDPR0000*
.* V10.14.15 01/07/2019 Ebon Clements  Task 0876030                           *
.*           Only report Obj 141 sub event 08/09 if populated                 *
.*           EDMM2200 EDMM2300                                                *
.* V10.14.14 24/06/2019 Ebon Clements  Task 0876029                           *
.*           Fixed delete visit source modified seconds - EDEL0000 - EMDATIME *
.* V10.14.13 12/06/2019 Ebon Clements  Task 0876029                           *
.*           Added delete of previous object 60 records - EDHH0000            *
.* V10.14.12 07/06/2019 Ebon Clements  Task 0876030                           *
.*           Set source modified date prior to delete record calls - EDDK0000 *
.* V10.14.11 10/05/2019 Ebon Clements  Task 0874272                           *
.*           Fixed Obj 63 I record - SERVICE_EVENT_PROVIDER_RECORD_ID         *
.*           EDJJ0000                                                         *
.* V10.14.10 10/05/2019 Ebon Clements  Task 0874272                           *
.*           Fixed Obj 63 - Effective end date  - EDJJ0000                    *
.* V10.14.09 08/05/2019 Ebon Clements  Task 0874051                           *
.*           Added building location id to obj 143                            *
.* V10.14.08 05/04/2019 Ebon Clements  Task 0872815                           *
.*           Changed obj 56 SERVICE_ACTIVITY to report the procedure date     *
.* V10.14.07 29/03/2019 Ebon Clements  Task 0872483                           *
.*           Added date/time to EVENT_SUB_EVENT_RECORD_ID for Obj 141         *
.*           sub event 05, 06 and 08                                          *
.* V10.14.06 20/03/2019 Ebon Clements  Task 0871889                           *
.*           Removed spaces from obj 145 fields - EDKK0000                    *
.* V10.14.05 19/03/2019 Ebon Clements  Task 0871777                           *
.*           Extract all ED visits                                            *
.* V10.14.04 07/03/2019 Ebon Clements  Task 0871473                           *
.*           Fixed call of presenting complaint change trigger - EDPR0000     *
.* V10.14.03 06/03/2019 Ebon Clements  Task 0871327                           *
.*           Added effective start/end date to Obj 63 O records - EDJJ0000    *
.* V10.14.02 04/03/2019 Ebon Clements  Task 0871097                           *
.*           Added presenting complaint change trigger - EDPR0000             *
.* V10.14.01 11/02/2019 Ebon Clements  Task 0869604                           *
.*           Added date/time to EVENT_SUB_EVENT_RECORD_ID for OBJ 141         *
.*           type 06 Dr Seen                                                  *
.* V10.13.14 22/01/2019 Ebon Clements  Task 0869604                           *
.*           Added source modifed date/time to all objects - WRCOND00         *
.* V10.13.13 12/12/2018 Ebon Clements  Task 0867299                           *
.*           Fixed SOURCE_CREATE_DATETIME for obj 141 sub event 09 - WRCOND00 *
.* V10.13.12 07/12/2018 Ebon Clements  Task 0867299                           *
.*           Added SOURCE_CREATE_DATETIME to all objects at WRCOND00          *
.* V10.13.11 26/11/2018 Ebon Clements  Task R0864975                          *
.*           Added merge functionality for OBJ 57 to resend new U/R - EMRG0000*
.* V10.13.10 21/11/2018 Ebon Clements  Task 0864976                           *
.*           Moved EDDK0000 - Send delete records for object and key          *
.*           to IBAPMS40
.* V10.13.09 04/10/2018 Ebon Clements  Task 0861770                           *
.*           Fixed change nurse seen OBJ 141 records - EDRR0000               *
.* V10.13.08 03/10/2018 Ebon Clements  Task 0861770                           *
.*           Fixed delete previous sent doctor OBJ 141 records - EDOO0000     *
.* V10.13.07 26/09/2018 Ebon Clements  Task 0861770                           *
.*           Changed Obj 61 DIAGNOSIS_TYPE_CODE - EDII5000                    *
.* V10.13.06 19/09/2018 Ebon Clements  Task 0863501                           *
.*           Changed Obj 56 and 61 to use ENVCUNIQ instead of EMVCUNIQ        *
.* V10.13.05 12/09/2018 Ebon Clements  Task 0861770                           *
.*           Fixed object 56 service activity comments - EDGG0000             *
.* V10.13.04 03/09/2018 Jill Parkinson Task 0862271                           *
.*           Removed visitnum from column 10 for objects 59,60,63,137,141,142 *
.* V10.13.03 24/08/2018 Jill Parkinson Task 0861770                           *
.*           Added use of EMVIMPDT/EMVIMPTM in EDMM0000                       *
.* V10.13.02 23/08/2018 Ebon Clements  Task 0861770                           *
.*           Fixed SERVICE_EVENT_PROVIDER_RECORD_ID in OBJ 63 - EDJJ0000      *
.* V10.13.01 23/08/2018 Ebon Clements  Task 0861770                           *
.*           Fixed SERVICE_PROVIDER_ID in OBJ 63 - EDJJ0000                   *
.* V10.12.39 10/08/2018 Ebon Clements  Task 0861770                           *
.*           Report EMVCSEQU as two characters not 3 - EDGG0000               *
.*           Fixed ISP reporting for object 141                               *
.* V10.12.38 28/06/2018 Ebon Clements  Task 0858054                           *
.*           Don't report object 64 - ONWARD_REFERRAL - EDBB0000              *
.*           Don't report object 141 sub events if blank                       *
.* V10.12.37 22/06/2018 Ebon Clements  Task 0858054                           *
.*           Don't report blank presenting complaint - EDFF0000               *
.*           Only extract public patients - EDVS0000                          *
.* V10.12.36 01/05/2018 Ebon Clements  Task 0855317                           *
.*           Fixed emergency extract delete object key test - EDDL0000        *
.* V10.12.10 09/04/2018 Ebon Clements  Task 0855308                           *
.*           Fixed service event location reporting  - EDEE0000               *
.* V10.12.09 09/04/2018 Ebon Clements  Task 0855308                           *
.*           Fixed service event location reporting                           *
.* V10.12.08 09/04/2018 Ebon Clements  Task 0855317                           *
.*           Send delete procedure/diagnosis objects                          *
.* V10.12.07 06/04/2018 Ebon Clements  Task 0848319                           *
.*           Fixed ED_DEPARTURE_DESTINATION_CODE Cat ED user defined 3        *
.* V10.12.06 04/04/2018 Ebon Clements  Task 0848319                           *
.*           Fixed service provider ID in EDJJ0000                            *
.* V10.12.05 23/03/2018 Ebon Clements  Task 0848319                           *
.*           Fixed HERO location ID                                           *
.* V10.12.04 20/03/2018 Ebon Clements  Task 0848319                           *
.*           Added ED visit alterations - EALT0000                            *
.* V10.12.03 15/03/2018 Ebon Clements  Task 0848319                           *
.*           Removed last tilde from all objects                              *
.* V10.12.02 06/03/2018 Ebon Clements  Task 0848319                           *
.*           Added emergency ambulance incident created date/time             *
.* V10.12.01 21/02/2018 Ebon Clements  Task 0848319                           *
.*           Extract ED data                                                  *
.* V10.12.00 23/01/2018 Jill Parkinson Task 0846167                           *
.*           Created include                                                  *
.******************************************************************************
EDED0000  CALL      ELOC0000      * extract 143 - Health Service Location
          CALL      EVIS0000      * Get ED visits by creation date
          CALL      ECHA0000      * Get ED change audit records
          CALL      EALT0000      * Get ED visit alterations
          CALL      EDEL0000      * Get ED delete audit records
          CALL      EMRG0000      * Process emergency merges
.
EDED9999  RETURN
+
.******************************************************************************
.* EDEL0000 - Loop emrdelaf and extract delete audit records
.******************************************************************************
EDEL0000  PACK      KEY21,STRTDATE,SP70
          CALL      RSEMDA2
EDEL1000  CALL      RKEMDA2
          BRANCH    OVRCD,EDEL9999
.
          MATCH     EMDADATE,ENDDATE        * After extract end date
          GOTO      EDEL9999 IF LESS
.
          PACK      KEY8,EMDAADMN,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EDEL1000
.
          COMPARE   ONE,PVITYPE             * EMR visits only
          GOTO      EDEL1000 IF NOT EQUAL
.
          CALL      EDVS0000                * Get ED visit details
          BRANCH    EXIT,EDEL1000
.
          MOVE      THREE,SDATFLAG          * EMR delete audit trigger
          CALL      EDAL0000                * Delete all ED objects
          GOTO      EDEL1000
.
EDEL9999  RETURN
.
.******************************************************************************
.* EDAL0000 - Delete all objects for the ED visit in context 
.******************************************************************************
EDAL0000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
.
          MOVE      "56 ",DELETOBJ          * SERVICE_ACTIVITY
          CALL      EDDL0000
.
          MOVE      "57 ",DELETOBJ          * CLIENT_SERVICE_EVENT
          CALL      EDDL0000
.
          MOVE      "59 ",DELETOBJ          * PRESENTING_ISSUE
          CALL      EDDL0000
.
          MOVE      "60 ",DELETOBJ          * SERVICE_EVENT_ATTRIBUTE
          CALL      EDDL0000
.
          MOVE      "61 ",DELETOBJ          * DIAGNOSIS
          CALL      EDDL0000
.
          MOVE      "63 ",DELETOBJ          * SERVICE_EVENT_PROVIDER
          CALL      EDDL0000
.
          MOVE      "64 ",DELETOBJ          * ONWARD_REFERRAL
          CALL      EDDL0000
.
          MOVE      "115",DELETOBJ          * SERVICE_EVENT_GENERAL_PRACT
          CALL      EDDL0000
.
          MOVE      "130",DELETOBJ          * SERVICE_EVENT_TRANSFER
          CALL      EDDL0000
.
          MOVE      "137",DELETOBJ          * SERVICE_EVENT_DELAY
          CALL      EDDL0000
.
          MOVE      "141",DELETOBJ          * SERVICE_EVENT_SUB_EVENT
          CALL      EDDL0000
.
          MOVE      "142",DELETOBJ          * SERVICE_EVENT_LOCATION
          CALL      EDDL0000
.
          MOVE      "145",DELETOBJ          * SERVICE_EVENT_AND_EMMERGENCY_DEP
          CALL      EDDL0000
.
EDAL9999  RETURN
.
.******************************************************************************
.* EDDL0000 - Send delete records for all objects for this ED visit
.******************************************************************************
EDDL0000  PACK      KEY112,DELETSTM,DELETOBJ,DEMVIADM,SP70
          CALL      RSCMEWD2
EDDL1000  CALL      RKCMEWD2
          BRANCH    OVRCD,EDDL9999
.
          MATCH     DELETSTM,CMEWDSTR            * 18=Emergency Department
          GOTO      EDDL9999 IF NOT EQUAL
.
          MATCH     DELETOBJ,CMEWOBJT            * Correct Object
          GOTO      EDDL9999 IF NOT EQUAL
.
          MATCH     DEMVIADM,CMEWOKEY            * First 8 chars is ED visit 
          GOTO      EDDL9999 IF NOT EQUAL        * number
.
          MATCH     "D",CMEWRTYP                 * Skip deletes
          GOTO      EDDL1000 IF EQUAL
.
          MOVE      CMEWOBJT,OBJECTTY            * Object
          PACK      OBJECTKY,CMEWOKEY,SP70       * Key
          PACK      OBJECTTX,CMEWTEXT,SP900      * Text
.
          PACK      SRCRDATE,CMEWSCDT,SP70
          PACK      SRCRTIME,CMEWSCTM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          IF        SDATFLAG=3
            PACK      SRMDDATE,EMDADATE,SP70 * EMR delete audit trigger
            PACK      SRMDTIME,EMDATIME,COLON,ZERO,ZERO,SP70
          ENDIF
.
          MOVE      ANSD,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      EDDL1000
.
EDDL9999  RETURN
+
.******************************************************************************
.* ELOC0000 - Loop emrlocaf and extract 143 health service location records
.******************************************************************************
ELOC0000  PACK      KEY3,SP70
          CALL      RSEMLOC1
ELOC1000  CALL      RKEMLOC1                    * Loop ED locations
          BRANCH    OVRCD,ELOC9999
.
          MATCH     STRTDATE,EMLOCDAT           * Date Created
          IF        !@LESS
            MOVE      ZERO,SDATFLAG             * Add trigger 
            MATCH     EMLOCDAT,ENDDATE
            GOTO      ELOC2000 IF NOT LESS
          ENDIF
.
          MATCH     STRTDATE,EMLOUDAT           * Update Date
          IF        !@LESS
            MOVE      ONE,SDATFLAG              * Update trigger 
            MATCH     EMLOUDAT,ENDDATE
            GOTO      ELOC2000 IF NOT LESS
          ENDIF
.
          MATCH     STRTDATE,EMLOIDAT           * Inactive Date
          IF        !@LESS
            MOVE      ONE,SDATFLAG              * Update trigger 
            MATCH     EMLOIDAT,ENDDATE
            GOTO      ELOC2000 IF NOT LESS
          ENDIF
.
          GOTO      ELOC1000                     * Skip record 
.      
ELOC2000  PACK      KEY7,TWO,EMLOLOCA,EMLOSCOD,SP70
          CALL      RDPMUHL1                     * Read HERO location ID
          BRANCH    OVRCD,ELOC1000
.
          MATCH     SP70,PMULUHID                * Skip if HERO ID blank
          GOTO      ELOC1000 IF EQUAL
.
          MOVE      "143",OBJECTTY             * LOCATION_LOCAL_ID 
          PACK      OBJECTKY,EMLOSCOD,EMLOLOCA,SP70,SP70
.
          MOVE      "9475-001",DIM8            * LOCATION_SOURCE_ID
          MOVE      "3024580",DIM20             * BUILDING_LOCATION_ID
.
          MATCH     "00000000000000000000",EMCNHSID * Checking for zero's
          GOTO      ELOC3000 IF EQUAL
.
          MATCH     SP70,EMCNHSID              *check for spaces in parameter
          GOTO      ELOC3000 IF EQUAL
          GOTO      ELOC3000 IF EOS
.
          MOVE      EMCNHSID,DIM20             * move if BUILDING_LOCATION_ID is
                                               * provided as the parameter
.
ELOC3000  SQUEEZE   DIM20 
          STRIP     EMLODESC
          SQUEEZE   PMULUHID
          SQUEEZE   EMLOCDAT
          SQUEEZE   CHCSDTE
          SQUEEZE   EMLOIDAT
          SQUEEZE   EMLOSCOD
          SQUEEZE   EMLOLOCA
.
          PACK      OBJECTTX,PTCNNSSI,TILDA:   * LOCATION_SOURCE_ID 
                             PTCNNECI,TILDA:   * CAMPUS_LOCAL_ID 
                             EMLOSCOD,DASH:
                             EMLOLOCA,TILDA:   * LOCATION_LOCAL_ID
                             ANSN,ANSA,TILDA:  * BUILDING_LOCATION_LOCAL_ID
                             DIM8,TILDA:       * LOCATION_SOURCE_ID 
                             PTCNNECI,TILDA:   * CAMPUS_LOCATION_ID 
                             PTCNNEBI,TILDA:   * BUILDING_LOCATION_ID 
                             DIM20,TILDA:       * LOCATION_ID 
                             PMULUHID,TILDA:   * LOCATION_TYPE_CODE 
                             EMLODESC,TILDA:   * LOCATION_DESC 
                             CHCSDTE,TILDA:    * LOCATION_FIRST_OPEN_DATE
                             EMLOIDAT:         * LOCATION_PERMANENT_CLOSURE_DATE
                             SP900
.
          RESET     EMLOCDAT
          PACK      SRCRDATE,EMLOCDAT,SP70
          PACK      SRCRTIME,EMLOCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,EMLOUDAT,SP70   * Update trigger
            PACK      SRMDTIME,EMLOUTIM,SP70
          ELSE
            PACK      SRMDDATE,EMLOCDAT,SP70   * Add trigger
            PACK      SRMDTIME,EMLOCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      ELOC1000
.
ELOC9999  RETURN
+
.******************************************************************************
.* ECHA0000 - Loop emrchaaf by change date and find emergency change audit
.*            records to report
.******************************************************************************
ECHA0000  PACK      KEY24,STRTDATE,SP70
          CALL      RSEMCHA2
ECHA1000  CALL      RKEMCHA2                * Read change audit
          BRANCH    OVRCD,ECHA9999
.
          MATCH     EMCHDATE,ENDDATE        * After extract end date
          GOTO      ECHA9999 IF LESS
.
          PACK      KEY8,EMCHVISN,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,ECHA1000
.
          COMPARE   ONE,PVITYPE             * EMR visits only
          GOTO      ECHA1000 IF NOT EQUAL
.
          PACK      KEY8,EMCHVISN,SP70
          CALL      RDPMVX11               * Read visit
          BRANCH    OVRCD,ECHA1000
.
          CALL      EDVS0000                * Get ED visit details
          BRANCH    EXIT,ECHA1000
.
          COMPARE   FOUR,EMVISTAT           * Skip cancelled ED visits
          GOTO      ECHA1000 IF EQUAL
.
          MOVE      TWO,SDATFLAG            * Change audit trigger
.
          MATCH     "01",EMCHUPTY           * Arrival Date/Time
          IF        @EQUAL
            CALL      EDKK0000      * 145 SERVICE_EVENT_AND_EMERGENCY_DEPARTMENT
            GOTO      ECHA1000
          ENDIF
.
          MATCH     "02",EMCHUPTY           * Triage Date/Time
          IF        @EQUAL
            CALL      EDNN0000      * 141 SERVICE_EVENT_SUB_EVENT - 01
            GOTO      ECHA1000
          ENDIF
.
          MATCH     "03",EMCHUPTY           * Triage Category
          IF        @EQUAL
            CALL      EDNN0000      * 141 SERVICE_EVENT_SUB_EVENT - 01
            GOTO      ECHA1000
          ENDIF
.
....      MATCH     "04",EMCHUPTY           * First Seen By Nurse
....      IF        @EQUAL
....        PACK      SRMDDATE,EMCHDATE,SP70  * Set the source modified date
....        PACK      SRMDTIME,EMCHTIME,SP70  * to the trigger date
....        CALL      EDRR0000      * 141 SERVICE_EVENT_SUB_EVENT - 04
....        GOTO      ECHA1000
....      ENDIF
.
          MATCH     "05",EMCHUPTY           * First Seen By Doctor Date/Time
          IF        @EQUAL
            PACK      SRMDDATE,EMCHDATE,SP70  * Set the source modified date
            PACK      SRMDTIME,EMCHTIME,SP70  * to the trigger date
            CALL      EDOO0000      * 141 SERVICE_EVENT_SUB_EVENT - 06
            CALL      EDJJ0000      * 63  SERVICE_EVENT_PROVIDER
            GOTO      ECHA1000
          ENDIF
.
          MATCH     "06",EMCHUPTY           * First Seen By NH Prac Date/Time
          IF        @EQUAL
            CALL      EDPP0000      * 141  SERVICE_EVENT_SUB_EVENT - 08 
            GOTO      ECHA1000
          ENDIF
.
          MATCH     "07",EMCHUPTY           * Departure Date/Time
          IF        @EQUAL
            CALL      EDKK0000      * 145 SERVICE_EVENT_AND_EMERGENCY_DEPARTMENT
            GOTO      ECHA1000
          ENDIF
.
....      MATCH     "08",EMCHUPTY           * Triage Nurse
....      IF        @EQUAL
....        CALL      EDQQ0000      * 141  SERVICE_EVENT_SUB_EVENT - 04
....        GOTO      ECHA1000
....      ENDIF
.
....      MATCH     "09",EMCHUPTY           * Removal of Nurse Seen
....      IF        @EQUAL
....        PACK      SRMDDATE,EMCHDATE,SP70  * Set the source modified date
....        PACK      SRMDTIME,EMCHTIME,SP70  * to the trigger date
....        CALL      EDRR0000      * 141 SERVICE_EVENT_SUB_EVENT - 04
....        GOTO      ECHA1000
....      ENDIF
.
          MATCH     "10",EMCHUPTY           * Departure Status
          IF        @EQUAL
            CALL      EDKK0000      * 145 SERVICE_EVENT_AND_EMERGENCY_DEPARTMENT
            GOTO      ECHA1000
          ENDIF
.
          MATCH     "12",EMCHUPTY           * Removal of First Doctor Seen
          IF        @EQUAL
            PACK      SRMDDATE,EMCHDATE,SP70  * Set the source modified date
            PACK      SRMDTIME,EMCHTIME,SP70  * to the trigger date
            CALL      EDOO0000      * 141 SERVICE_EVENT_SUB_EVENT - 06
            CALL      EDJJ0000      * 63  SERVICE_EVENT_PROVIDER
            GOTO      ECHA1000
          ENDIF
.
          MATCH     "13",EMCHUPTY           * Removal of Last Doctor Allocated
          IF        @EQUAL
            PACK      SRMDDATE,EMCHDATE,SP70  * Set the source modified date
            PACK      SRMDTIME,EMCHTIME,SP70  * to the trigger date
            CALL      EDOO0000      * 141 SERVICE_EVENT_SUB_EVENT - 06
            CALL      EDJJ0000      * 63  SERVICE_EVENT_PROVIDER
            GOTO      ECHA1000
          ENDIF
.
          MATCH     "14",EMCHUPTY           * Initital Assessor Update
          IF        @EQUAL
            PACK      SRMDDATE,EMCHDATE,SP70  * Set the source modified date
            PACK      SRMDTIME,EMCHTIME,SP70  * to the trigger date
            CALL      EDTT0000      * 141 SERVICE_EVENT_SUB_EVENT - 04
            CALL      EDJJ0000      * 63  SERVICE_EVENT_PROVIDER
          ENDIF
.
          MATCH     "16",EMCHUPTY           * Triage End Date
          IF        @EQUAL
            CALL      EDNN0000      * 141 SERVICE_EVENT_SUB_EVENT - 01
            GOTO      ECHA1000
          ENDIF
.
          GOTO      ECHA1000
.
ECHA9999  RETURN
+
.******************************************************************************
.* EDNN0000 - 141 SERVICE_EVENT_SUB_EVENT
.* 01 Emergency Department triage
.******************************************************************************
EDNN0000  MATCH     SP70,EMVITRIG
          GOTO      EDNN9999 IF EQUAL
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,ONE,EMVITRIG,SP70,SP70  * Sub event - 01
.
          MOVE      EMVITRDT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      EMVITRNS,DIM10B          * Triage nurse
.
          MOVE      EMVITRIG,DIM3
          SQUEEZE   DIM3
          SQUEEZE   DIM10A
          SQUEEZE   DIM10B
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE 
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID 
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID 
                        ONE,TILDA:               * EVENT_RECORD_ID 
                        ZERO,ONE,DIM3:
                        TILDA:                   * EVENT_SUB_EVENT_RECORD_ID 
                        ZERO,ONE,TILDA:          * SUB_EVENT_TYPE_CODE
                        DIM3,TILDA:          * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        DIM10B,TILDA:            * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVITRTM:     * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDNN9999  RETURN
+
.******************************************************************************
.* EDOO0000 - 141 SERVICE_EVENT_SUB_EVENT
.* 06 Emergency Department doctor seen 
.******************************************************************************
EDOO0000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
          PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,SIX,SP70,SP70            * Delete Key
.
          CALL      EDDK0000
.
          MOVE      SP70,DIM10
          PACK      KEY22,DEMVIADM,SP70
          CALL      RSEMHIS1
EDOO2000  CALL      RKEMHIS1                     * Read EMR history to get
          BRANCH    OVRCD,EDOO9999               * locations
.
          MATCH     DEMVIADM,EMHIVIS             * same visit
          GOTO      EDOO9999 IF NOT EQUAL
.
          MATCH     DIM10,EMHIDOC                * Change in DR code
          GOTO      EDOO2000 IF EQUAL
.
          MOVE      EMHIDOC,DIM10
          UNPACK    EMHIDST,DIM2,DIM2A,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          MATCH     SP70,EMHIDOC
          GOTO      EDOO2000 IF EQUAL
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,SIX,EMHIDOC,EMHIDSD,DIM8:
                             SP70,SP70  * Sub event - 06
.
          MOVE      EMHIDSD,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          UNPACK    EMHIDSD,D2,DATEDIM6      * YYMMDD
          MOVE      EMHIDST,TIMEDIM4         * HHMM
          SQUEEZE   DATEDIM6
          SQUEEZE   TIMEDIM4
.
          SQUEEZE   EMHIDSD
          SQUEEZE   EMHIDST
          SQUEEZE   EMHIDOC
          SQUEEZE   DIM10A
          SQUEEZE   DIM8
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ZERO,SIX,EMHIDOC:
                        DATEDIM6,TIMEDIM4,TILDA: * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,SIX,TILDA:          * SUB_EVENT_TYPE_CODE
                        EMHIDOC,TILDA:           * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        EMHIDOC,TILDA:           * SUB_EVENT_ISP_ID
                        DIM10A,SP1,DIM8:         * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,EMHIDAT,SP70
          UNPACK    EMHITIM,DHOUR,MIN,SEC
          PACK      SRCRTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.
          IF        SDATFLAG=2
            PACK      SRCRDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRCRTIME,EMCHTIME,SP70
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDOO2000
.
EDOO9999  RETURN
+
.******************************************************************************
.* EDRR0000 - 141 SERVICE_EVENT_SUB_EVENT
.* 04 Emergency Department nurse practitioner seen
.******************************************************************************
....EDRR0000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
....          MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
....          PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
....                             ZERO,FOUR,SP70,SP70            * Delete Key
....          CALL      EDDK0000   
.....
....          MATCH     SP70,EMVIATNS
....          GOTO      EDRR9999 IF EQUAL
.....
....          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
....          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
....                             ZERO,FOUR,EMVIATNS:
....                             EMVINSDT,EMVINSTM,SP70,SP70  * Sub event - 04
.....
....          MOVE      EMVINSDT,DATFIELD        * CCYYMMDD
....          CALL      FMTD0000                 * Format date
....          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.....
....          PACK      KEY16,EMVINSDT,EMVINSTM,SP70
....          REP       ": ",KEY16
....          SQUEEZE   KEY16
.....
....          UNPACK    KEY16,D2,DATEDIM6,TIMEDIM4      * YYMMDDHHMM
....          SQUEEZE   DATEDIM6
....          SQUEEZE   TIMEDIM4
.....
....          SQUEEZE   EMVINSDT
....          SQUEEZE   EMVIATNS
....          SQUEEZE   DIM10A
....          SQUEEZE   EMVINSTM
....          MOVE      DEMVIADM,VISITNUM
....          SQUEEZE   VISITNUM
.....
....          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
....                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
....                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
....                        ONE,TILDA:               * EVENT_RECORD_ID
....                        ZERO,FOUR,EMVIATNS:
....                        DATEDIM6,TIMEDIM4,TILDA: * EVENT_SUB_EVENT_RECORD_ID
....                        ZERO,FOUR,TILDA:         * SUB_EVENT_TYPE_CODE
....                        EMVIATNS,TILDA:          * SUB_EVENT_TYPE_LOCAL_CODE
....                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
....                        ZERO,THREE,FIVE,TILDA:  * SUB_EVENT_ISP_ID_TYPE_CODE
....                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
....                        EMVIATNS,TILDA:          * SUB_EVENT_ISP_ID
....                        DIM10A,SP1,EMVINSTM:  * SUB_EVENT_EFFECTIVE_DATETIME
....                        SP900
.....
....          PACK      SRCRDATE,EMVINSDT,SP70
....          PACK      SRCRTIME,EMVINSTM,SP70
.....
....          IF        SDATFLAG=2
....            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
....            PACK      SRMDTIME,EMCHTIME,SP70
....          ENDIF
.....
....          CALL      WRCOND00     * write record to container detail table
.....
....EDRR9999  RETURN
+
.******************************************************************************
.* EDTT0000 - 141 SERVICE_EVENT_SUB_EVENT
.* 04 Emergency Department meet and greet dr seen 
.******************************************************************************
EDTT0000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
          PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,FOUR,SP70,SP70            * Delete Key
.
          MATCH     SP70,EMVIMDCD
          IF        @EQUAL
            CALL      EDDK0000              * Delete all records
            GOTO      EDTT9999
          ELSE
            CALL      DLOF0000              * Delete last sent record
          ENDIF
.
          UNPACK    EMVIMDTM,DIM2,D1,DIM2A,D1,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,FOUR,EMVIMDCD,DIM8,SP70,SP70  * Sub event - 04
.
          MOVE      EMVIMDDT,DATFIELD            * CCYYMMDD
          CALL      FMTD0000                     * Format date
          MOVE      FORMATDT,DIM10A              * CCYY-MM-DD
          MOVE      EMVIMDTM,DIM8A
.
          UNPACK    EMVIMDDT,D4,DATEDIM4              * MMDD
          UNPACK    EMVIMDTM,DIM2,D1,DIM2A,D1,DIM2B
          PACK      TIMEDIM6,DIM2,DIM2A,DIM2B,SP70    * HHMMSS
          SQUEEZE   DATEDIM4
          SQUEEZE   TIMEDIM6
.
          PACK      DIM19A,DIM10A,SP1,DIM8A
          STRIP     DIM19A
.
          MOVE      EMVIMDCD,DIM10
          SQUEEZE   DIM10
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        DIM10:
                        DATEDIM4,TIMEDIM6,TILDA: * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,FOUR,TILDA:         * SUB_EVENT_TYPE_CODE
                        DIM10,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
                        THREE,TILDA:             * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        DIM10,TILDA:             * SUB_EVENT_ISP_ID
                        DIM19A,SP900             * SUB_EVENT_EFFECTIVE_DATETIME
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDTT9999  RETURN
+
.******************************************************************************
.* EDPP0000 - 141 SERVICE_EVENT_SUB_EVENT
.* 08 Mental Health Psychiatric Emergency Care Centre consult 
.******************************************************************************
EDPP0000  MATCH     SP70,EMVIMPRA
          GOTO      EDPP9999 IF EQUAL
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,EIGHT,EMVIMPRA:
                             EMVIMPDT,EMVIMPTM,SP70,SP70  * Sub event - 08
.
          MOVE      EMVIMPDT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          PACK      KEY16,EMVIMPDT,EMVIMPTM,SP70
          REP       ": ",KEY16
          SQUEEZE   KEY16
.
          UNPACK    KEY16,D2,DATEDIM6,TIMEDIM4      * YYMMDDHHMM
          SQUEEZE   DATEDIM6
          SQUEEZE   TIMEDIM4
.
          SQUEEZE   DIM10A
          SQUEEZE   EMVIMPRA
          SQUEEZE   EMVIMPDT
          SQUEEZE   EMVIMPTM
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ZERO,EIGHT,EMVIMPRA:
                        DATEDIM6,TIMEDIM4,TILDA: * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,EIGHT,TILDA:        * SUB_EVENT_TYPE_CODE
                        EMVIMPRA,TILDA:          * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        EMVIMPRA,TILDA:          * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVIMPTM:     * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,EMVIMPDT,SP70
          PACK      SRCRTIME,EMVIMPTM,SP70
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDPP9999  RETURN
+
.******************************************************************************
.* EDQQ0000 - 141 SERVICE_EVENT_SUB_EVENT
.* 04 Emergency Department nurse practitioner seen 
.******************************************************************************
....EDQQ0000  MATCH     SP70,EMVIATNS
....          GOTO      EDQQ9999 IF EQUAL
.....
....          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
....          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
....                             ZERO,FOUR,EMVIATNS:
....                             EMVINSDT,EMVINSTM,SP70,SP70  * Sub event - 04
.....
....          PACK      KEY16,EMVINSDT,EMVINSTM,SP70
....          REP       ": ",KEY16
....          SQUEEZE   KEY16
.....
....          UNPACK    KEY16,D2,DATEDIM6,TIMEDIM4      * YYMMDDHHMM
....          SQUEEZE   DATEDIM6
....          SQUEEZE   TIMEDIM4
.....
....          MOVE      EMVINSDT,DATFIELD        * CCYYMMDD
....          CALL      FMTD0000                 * Format date
....          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.....
....          SQUEEZE   EMVINSDT
....          SQUEEZE   EMVIATNS
....          SQUEEZE   DIM10A
....          SQUEEZE   EMVINSTM
....          MOVE      DEMVIADM,VISITNUM
....          SQUEEZE   VISITNUM
.....
....          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
....                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
....                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
....                        ONE,TILDA:               * EVENT_RECORD_ID
....                        ZERO,FOUR,EMVIATNS:
....                        DATEDIM6,TIMEDIM4,TILDA: * EVENT_SUB_EVENT_RECORD_ID
....                        ZERO,FOUR,TILDA:         * SUB_EVENT_TYPE_CODE
....                        EMVIATNS,TILDA:          * SUB_EVENT_TYPE_LOCAL_CODE
....                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
....                        ZERO,THREE,FIVE,TILDA:  * SUB_EVENT_ISP_ID_TYPE_CODE
....                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
....                        EMVIATNS,TILDA:          * SUB_EVENT_ISP_ID
....                        DIM10A,SP1,EMVINSTM:  * SUB_EVENT_EFFECTIVE_DATETIME
....                        SP900
.....
....          PACK      SRCRDATE,EMVINSDT,SP70
....          PACK      SRCRTIME,EMVINSTM,SP70
.....
....          IF        SDATFLAG=2
....            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
....            PACK      SRMDTIME,EMCHTIME,SP70
....          ENDIF
.....
....          CALL      WRCOND00     * write record to container detail table
.....
....EDQQ9999  RETURN
+
.******************************************************************************
.* EVIS0000 - Loop pmsvx1af by creation date and find emergency visits
.*            to report
.******************************************************************************
EVIS0000  PACK      KEY24,STRTDATE,SP70
          CALL      RSPMVX14
EVIS1000  CALL      RKPMVX14                * Loop visit extn file
          BRANCH    OVRCD,EVIS9999
.
          MATCH     PMVXCDTE,ENDDATE        * Date created
          GOTO      EVIS9999 IF LESS
.
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EVIS1000
.
          COMPARE   ONE,PVITYPE             * EMR visits only
          GOTO      EVIS1000 IF NOT EQUAL
.
          CALL      EDVS0000                * Get ED visit details
          BRANCH    EXIT,EVIS1000
.
          COMPARE   FOUR,EMVISTAT           * Skip cancelled ED visits
          GOTO      EVIS1000 IF EQUAL
.
          MOVE      ZERO,SDATFLAG           * Add trigger
.
          CALL      EDAA0000      * 57  CLIENT_SERVICE_EVENT
          CALL      EDBB0000      * 64  ONWARD_REFERRAL
          CALL      EDCC0000      * 115 SERVICE_EVENT_GENERAL_PRACTITIONER
          CALL      EDDD0000      * 137 SERVICE_EVENT_DELAY
          CALL      EDEE0000      * 142 SERVICE_EVENT_LOCATION
          CALL      EDFF0000      * 59  PRESENTING_ISSUE
          CALL      EDGG0000      * 56  SERVICE_ACTIVITY
          CALL      EDHH0000      * 60  SERVICE_EVENT_ATTRIBUTE
          CALL      EDII0000      * 61  DIAGNOSIS
.
          CALL      CHJJ0000      * 63 - Check if we need to send obj 63 now
.
          CALL      EDKK0000      * 145 SERVICE_EVENT_AND_EMERGENCY_DEPARTMENT
          CALL      EDLL0000      * 130 SERVICE_EVENT_TRANSFER
          CALL      EDMM0000      * 141 SERVICE_EVENT_SUB_EVENT
.
          GOTO      EVIS1000
.
EVIS9999  RETURN
+
.******************************************************************************
.* CHJJ0000 - If the ED visit was created on the extract start date.
.*            If there have not been any supervisor doctor updates send
.*            object 63 now as it will not be triggered later in ECHA0000
.*            or EALT0000
.******************************************************************************
CHJJ0000  MATCH     PMVXCDTE,STRTDATE       * Skip if ED visit was not created
          GOTO      CHJJ9999 IF NOT EQUAL   * on the extract start date
.
          PACK      KEY24,DEMVIADM,STRTDATE,SP70
          CALL      RSEMCHA1
CHJJ1000  CALL      RKEMCHA1                * Read change audit
          BRANCH    OVRCD,CHJJ5000
.
          MATCH     DEMVIADM,EMCHVISN       * Correct ED visit
          GOTO      CHJJ5000 IF NOT EQUAL
.
          MATCH     EMCHDATE,ENDDATE        * End date
          GOTO      CHJJ5000 IF LESS
.
          MATCH     "05",EMCHUPTY           * First Seen By Doctor Date/Time
          GOTO      CHJJ9999 IF EQUAL
.
          MATCH     "12",EMCHUPTY           * Removal of First Doctor Seen
          GOTO      CHJJ9999 IF EQUAL
.
          MATCH     "13",EMCHUPTY           * Removal of Last Doctor Allocated
          GOTO      CHJJ9999 IF EQUAL
.
          GOTO      CHJJ1000

CHJJ5000  CALL      EDJJ0000                * 63  SERVICE_EVENT_PROVIDER
.
CHJJ9999  RETURN
+
.******************************************************************************
.* EDVS0000 - Get ED visit details                  
.******************************************************************************
EDVS0000  PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1                * Read ED visit
          BRANCH    OVRCD,EDVS9000
.
          PACK      KEY5,ANSC,ANSL,EMVICOMP,SP70      * Read claim code
          CALL      RDCODE1
          BRANCH    OVRCD,EDVS9000
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1                * Read ED Site
          BRANCH    OVRCD,EDVS9000
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1                 * Read PMI
          BRANCH    OVRCD,EDVS9000
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDPMPX21                * Read PMI
          BRANCH    OVRCD,EDVS9000
.
          MOVE      ZERO,EXIT
          GOTO      EDVS9999
.
EDVS9000  MOVE      ONE,EXIT
          GOTO      EDVS9999
.
EDVS9999  RETURN
+
.******************************************************************************
.* EDAA0000 - 57 CLIENT_SERVICE_EVENT               
.******************************************************************************
EDAA0000  MOVE      "57",OBJECTTY                * CLIENT_SERVICE_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,SP70,SP70
.
          MOVE      EMVIURNO,URNUMBER
          SQUEEZE   URNUMBER
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:          * EVENT_RECORD_ID 
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_TYPE_CODE 
                             PTCNNIAI,TILDA:     * CLIENT_ID_ISSUING_AUTHORITY 
                             URNUMBER:           * CLIENT_ID 
                             SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDAA9999  RETURN
+
.******************************************************************************
.* EDBB0000 - 64 ONWARD_REFERRAL       
.******************************************************************************
EDBB0000  MATCH     "1",PTCNEXED                 * Collect Extra Container Info
          GOTO      EDBB9999 IF NOT EQUAL
.
          IF        EMVISTAT <> 2 & EMVISTAT <> 3
            GOTO      EDBB9999                   * Only report if discharged
          ENDIF
.
          MOVE      "64",OBJECTTY                * ONWARD_REFERRAL
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,SP70,SP70
.
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID 
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:          * EVENT_RECORD_ID 
                             ONE,TILDA:          * REFERRAL_RECORD_ID 
                             NINE,NINE,TILDA:    * TARGET_TYPE_CODE 
                             TILDA:              * TARGET_OSP_ID_TYPE_CODE 
                             TILDA:              * TARGET_OSP_SOURCE_ID 
                             TILDA:              * TARGET_OSP_ID 
                             TILDA:              * TARGET_ISP_ID_TYPE_CODE 
                             TILDA:              * TARGET_ISP_SOURCE_ID 
                             TILDA:              * TARGET_ISP_ID 
                             SP900               * ISSUED_DATETIME 
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDBB9999  RETURN
+
.******************************************************************************
.* EDCC0000 - 115 SERVICE_EVENT_GENERAL_PRACTITIONER
.******************************************************************************
EDCC0000  MATCH     SP70,PMPXRHC1
          IF        @EQUAL
            MATCH     SP70,PMPXRH1G
            GOTO      EDCC9999 IF EQUAL
          ENDIF
.
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP
          ENDIF
.
          PACK      KEY12,PMPXRH1G,PMPXR1GC,SP70
          CALL      RDPMHCG1
          IF        OVRCD=1
            CALL      CLPMSHCG
            MOVE      PMHCADR1,PMHGADD1
            MOVE      PMHCADR2,PMHGADD2
            MOVE      PMHCADR3,PMHGADD3
            MOVE      PMHCADR4,PMHGADD4
            MOVE      PMHCPOST,PMHGPOST
            MOVE      PMHCFAXN,PMHGPFAX
            MOVE      PMHCSTEL,PMHGPTEL
          ENDIF
.
          PACK      KEY20,PMPXRHC1,PMPXRH1G,SP70
          CALL      RDPMHCL1
          IF        OVRCD=1
            CALL      CLPMSHCL
            MOVE      PMHCPRV5,PMHLPRV5
          ENDIF
.
          MATCH     SP70,PMHCHCPC
          IF        @EQUAL
            MATCH     SP70,PMHGPRAC
            GOTO      EDCC9999 IF EQUAL
          ENDIF
.
          MATCH     SP70,PMHCHCPC           * Invalid or no HCP code
          IF        @EQUAL
            MOVE      PMHGPRAC,PMPXRHC1     * Send practice when no HCP
            MOVE      PMHGPNAM,PACFNAME     * recorded
          ELSE
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
          ENDIF
.
          MOVE      "115",OBJECTTY     * SERVICE_EVENT_GENERAL_PRACTITIONER
          PACK      OBJECTKY,DEMVIADM,ONE,PMPXRHC1,SP70,SP70
.
          SQUEEZE   PMPXRHC1
          STRIP     PACFNAME
.
          STRIP     PMHGADD1
          STRIP     PMHGADD2
          STRIP     PMHGADD3
          STRIP     PMHGADD4
          STRIP     PMHGPOST
.
          STRIP     PMHGPFAX
          STRIP     PMHGPTEL
.
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   PMHLPRV5
.
          PACK      OBJECTTX,ONE,TILDA:             * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA:        * EVENT_SOURCE_ID 
                             VISITNUM,TILDA:        * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:             * EVENT_RECORD_ID 
                             PMPXRHC1,TILDA:        * EVENT_GP_RECORD_ID 
                             ZERO,THREE,FIVE,TILDA: * GP_ISP_ID_TYPE_CODE 
                             PTCNNSSI,TILDA:        * GP_ISP_SOURCE_ID 
                             PMPXRHC1,TILDA:        * GP_ISP_ID 
                             PACFNAME,TILDA:        * GP_FULL_NAME 
                             TILDA:              * GP_PRACTICE_OSP_ID_TYPE_CODE
                             TILDA:              * GP_PRACTICE_OSP_SOURCE_ID 
                             TILDA:              * GP_PRACTICE_OSP_ID 
                             PMHGADD1,SP1,PMHGADD2:
                             TILDA:               * GP_PRACTICE_ADDRESS
                             PMHGADD3,TILDA:      * GP_PRACTICE_SUBURB_LOCALITY 
                             PMHGPOST,TILDA:      * GP_PRACTICE_POSTCODE
                             PMHGADD4,TILDA:      * GP_PRACTICE_STATE_TERRITORY 
                             ONE,ONE,ZERO,ONE:
                             TILDA:        * GP_PRACTICE_COUNTRY_OF_ADDRESS_CODE
                             PMHGPFAX,TILDA:      * GP_PRACTICE_FAX_NUMBER 
                             PMHGPTEL:            * GP_PRACTICE_PHONE_NUMBER 
                             SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDCC9999  RETURN
+
.******************************************************************************
.* EDDD0000 - 137 SERVICE_EVENT_DELAY
.******************************************************************************
EDDD0000  MOVE      "137",OBJECTTY               * SERVICE_EVENT_DELAY
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,ONE,SP70,SP70
.
          IF        SDATFLAG=1
            MOVE      "23:59:00",PMAWCTIM        * Set time to end of day      
          ENDIF
.
          COMPARE   ONE,EMVISTAT                 * Don't report if 
          GOTO      EDDD8000 IF EQUAL            * a current ED visit
.
          MATCH     "1",EMCNSEDR
          IF        @EQUAL
            MATCH     SP70,EMVIDISD                * Any delay reason
            GOTO      EDDD8000 IF EQUAL
          ELSE
            MATCH     SP70,EMVIEXRS                * Any delay reason
            GOTO      EDDD8000 IF EQUAL
          ENDIF
.
          IF        SDATFLAG=1
            MOVE      "18 ",DELETSTM             * 18=Emergency Department
            MOVE      "137",DELETOBJ             * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM,ONE:
                             SP70,SP70      * Delete Key
.
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
.
            CALL      DLOF0000                   * Delete last sent object
.
            MOVE      "137",OBJECTTY               * SERVICE_EVENT_DELAY
            PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,ONE:
                               PMAWCDAT,SP70,SP70
          ENDIF
.
          MOVE      SP70,DIM10
          MATCH     "1",EMCNSEDR
          IF        @EQUAL
            PACK      KEY5,CATDD,EMVIDISD,SP70      * Read delay reason
          ELSE
            PACK      KEY5,ANSR,ANSX,EMVIEXRS,SP70 * Read delay reason
          ENDIF
          CALL      RDCODE1
          BRANCH    OVRCD,EDDD9999
.
          UNPACK    PTCDUDF3,DIM10             * User defined field 3
.
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM10
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRCRDATE,PMAWCDAT,SP70
            PACK      SRCRTIME,PMAWCTIM,SP70
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          PACK      OBJECTTX,ONE,TILDA:      * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA: * EVENT_SOURCE_ID 
                             VISITNUM,TILDA: * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:      * EVENT_RECORD_ID 
                             SRCRDATE,DIM10:
                             TILDA:          * EVENT_DELAY_RECORD_ID 
                             ZERO,TWO,TILDA: * EVENT_DELAY_TYPE_CODE 
                             DIM10,TILDA:    * SERVICE_EVENT_DELAY_REASON_CODE 
                             SP900           * SERVICE_EVENT_DELAY_COMMENTS 
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDDD9999
.
EDDD8000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "137",DELETOBJ             * SERVICE_EVENT_DELAY
          PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM,ONE:
                             SP70,SP70      * Delete Key
.        
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
          CALL      DLOF0000                   * Delete last sent object
.
EDDD9999  RETURN
+
.******************************************************************************
.* EDEE0000 - 142 SERVICE_EVENT_LOCATION
.******************************************************************************
EDEE0000  MOVE      SP70,DIM3                    * Clear save location
.
          PACK      KEY22,DEMVIADM,SP70
          CALL      RSEMHIS1
EDEE1000  CALL      RKEMHIS1                     * Read EMR history to get
          BRANCH    OVRCD,EDEE9999               * locations
.
          MATCH     DEMVIADM,EMHIVIS             * same visit
          GOTO      EDEE9999 IF NOT EQUAL
.
          MATCH     DIM3,EMHILOC                 * Skip if location blank
          GOTO      EDEE1000 IF EQUAL
.
          MOVE      EMHILOC,DIM3                 * Save location
.
          MOVE      EMHIDAT,DATFIELD             * CCYYMMDD
          CALL      FMTD0000                     * Format date
          MOVE      FORMATDT,DIM10A              * CCYY-MM-DD
          MOVE      EMHIDAT,DIM8AA
.
          UNPACK    EMHITIM,DHOUR,MIN,SEC
          PACK      DIM8A,DHOUR,COLON,MIN,COLON,SEC,SP70
.  
          MOVE      SP70,DIM10B                  * Find date left location
          MOVE      SP70,DIM8B
          MOVE      SP70,DIM8BB
          PACK      SAVKEY22,EMHIVIS,EMHIDAT,EMHITIM,SP70  * Save key
EDEE1500  CALL      RKEMHIS1
          BRANCH    OVRCD,EDEE2000
.
          MATCH     DEMVIADM,EMHIVIS             * same visit
          GOTO      EDEE2000 IF NOT EQUAL
.
          MATCH     DIM3,EMHILOC                 * change in location
          GOTO      EDEE1500 IF EQUAL
.
          MOVE      EMHIDAT,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
          MOVE      EMHIDAT,DIM8BB
.
          UNPACK    EMHITIM,DHOUR,MIN,SEC
          PACK      DIM8B,DHOUR,COLON,MIN,COLON,SEC,SP70
          GOTO      EDEE3000
.
EDEE2000  IF        EMVISTAT<>1
            MOVE      EMVIDDAT,DATFIELD         * CCYYMMDD
            CALL      FMTD0000                 * Format date
            MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
            MOVE      EMVIDDAT,DIM8BB
.
            MOVE      EMVIDTIM,DIM8B
          ENDIF
.
EDEE3000  PACK      KEY22,SAVKEY22,SP70          * Re position
          CALL      RDEMHIS1
          BRANCH    OVRCD,EDEE1000
.  
          PACK      KEY3,EMHILOC,SP70
          CALL      RDEMLOC1                     * Read ED location
          BRANCH    OVRCD,EDEE1000
.
          MOVE      "142",OBJECTTY               * SERVICE_EVENT_LOCATION
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,EMHILOC:
                             EMHIDAT,EMHITIM,SP70,SP70
.
          PACK      DIM19A,DIM10A,SP1,DIM8A
          PACK      DIM19B,DIM10B,SP1,DIM8B
.
          UNPACK    EMHIDAT,D2,D8
          PACK      DIM10,D8,EMHITIM,SP70    * YYMMDDHHMM
.
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          STRIP     DIM19A
          STRIP     DIM19B
          SQUEEZE   DIM10
          SQUEEZE   EMLOSCOD
          SQUEEZE   EMLOLOCA
.
          PACK      OBJECTTX,ONE,TILDA:      * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA: * EVENT_SOURCE_ID 
                             VISITNUM,TILDA: * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:      * EVENT_RECORD_ID 
                             EMLOSCOD,DASH:
                             EMLOLOCA,DIM10:
                             TILDA:          * EVENT_LOCATION_RECORD_ID 
                             PTCNNSSI,TILDA: * HEALTH_SERVICE_LOCATION_SOURCE_ID
                             PTCNNECI,TILDA: * HEALTH_SERVICE_CAMPUS_LOCAL_ID 
                             EMLOSCOD,DASH:
                             EMLOLOCA,TILDA: * HEALTH_SERVICE_LOCATION_LOCAL_ID 
                             DIM19A,TILDA:   * EVENT_LOCATION_START_DATETIME 
                             DIM19B:         * EVENT_LOCATION_END_DATETIME
                             SP900
.
          MATCH     "1",EMCNHISA                 * Using ED location management
          IF        @EQUAL
            MATCH     "NEWMV",EMHIUPT
            IF        @EQUAL
              PACK      SRCRDATE,EMHICDAT,SP70
              PACK      SRCRTIME,EMHICTIM,SP70
.
              PACK      SRMDDATE,SRCRDATE,SP70 
              PACK      SRMDTIME,SRCRTIME,SP70
              GOTO      EDEE4000
            ENDIF
          ENDIF
.
          PACK      SRCRDATE,DIM8AA,SP70
          PACK      SRCRTIME,DIM8A,SP70
.
          PACK      SRMDDATE,DIM8AA,SP70 * Add trigger
          PACK      SRMDTIME,DIM8A,SP70
.
EDEE4000  IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDEE1000
.
EDEE9999  RETURN
+
.******************************************************************************
.* EDUU0000 - 142 SERVICE_EVENT_LOCATION - triggerd from locations management
.******************************************************************************
EDUU0000  MATCH     "1",EMCNHISA                 * Not using ED location 
          GOTO      EDUU9999 IF NOT EQUAL        * management
.
          PACK      KEY27,DEMVIADM,STRTDATE,SP70
          CALL      ASEMHIS2
EDUU1000  CALL      AKEMHIS2                     * Read EMR history to get
          BRANCH    OVRCD,EDUU9999               * locations
.
          MATCH     DEMVIADM,EMHIVIS             * same visit
          GOTO      EDUU9999 IF NOT EQUAL
.
          MATCH     EMHIAUDD,ENDDATE             * Skeip if after extract 
          GOTO      EDUU1000 IF LESS             * end date
.
          MATCH     "DELTL",EMHIUPT              * Delete location
          GOTO      EDUU1000 IF NOT EQUAL
.
          MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "142",DELETOBJ          * SERVICE_EVENT_LOCATION
.
. Find previously send add location record and send a delete
.
          PACK      KEY112,DELETSTM,DELETOBJ,DEMVIADM,ONE,ONE,DEMVIADM:
                           EMHILOC,SP70
          CALL      RSCMEWD2
EDUU2000  CALL      RKCMEWD2
          BRANCH    OVRCD,EDUU1000
.
          MATCH     DELETSTM,CMEWDSTR            * 18=Emergency Department
          GOTO      EDUU1000 IF NOT EQUAL
.
          MATCH     DELETOBJ,CMEWOBJT            * Correct Object
          GOTO      EDUU1000 IF NOT EQUAL
.
          MATCH     "D",CMEWRTYP                 * Skip deletes
          GOTO      EDUU2000 IF EQUAL
.
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,EMHILOC:
                             EMHIDAT,EMHITIM,SP70,SP70
.
          MATCH     OBJECTKY,CMEWOKEY            * Prev location sent
          GOTO      EDUU1000 IF NOT EQUAL 
.
          MOVE      CMEWOBJT,OBJECTTY            * Object
          PACK      OBJECTKY,CMEWOKEY,SP70       * Key
          PACK      OBJECTTX,CMEWTEXT,SP900      * Text
.
          PACK      SRCRDATE,CMEWSCDT,SP70       * Original created date
          PACK      SRCRTIME,CMEWSCTM,SP70
.
          PACK      SRMDDATE,EMHIAUDD,SP70       * Delete audit date created
          PACK      SRMDTIME,EMHIAUDT,SP70      
.
          MOVE      ANSD,OBJECTRT
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      EDUU1000
.
EDUU9999  RETURN
+
.******************************************************************************
.* EDFF0000 - 59 PRESENTING_ISSUE     
.******************************************************************************
EDFF0000  MATCH     SP70,EMVIUC20           * Don't report blank 
          GOTO      EDFF9999 IF EQUAL       * presenting complaint
.
          PACK      KEY5,CATEL,EMVIUC20,SP70
          CALL      RDCODE1                 * Read Presenting Complaint
          IF        OVRCD=1
            MOVE      EMVIUC20,TDESC
          ENDIF
.
          MOVE      TDESC,DIM20
.
          MOVE      "59",OBJECTTY               * PRESENTING_ISSUE
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,EMVIUC20,SP70,SP70
.
          SQUEEZE   EMVIDATE
          SQUEEZE   EMVIUC20
          STRIP     DIM20
          STRIP     EMVICOM1
          STRIP     EMVICOM2
          STRIP     EMVICOM3
          STRIP     EMVICOM4
          STRIP     EMVICOM5
          STRIP     EMVICOM6  
.
          MATCH     SP70,DIM20
          IF        !@EQUAL & !@EOS
            PACK      DIM20,DIM20,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM1
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM1,EMVICOM1,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM2
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM2,EMVICOM2,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM3
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM3,EMVICOM3,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM4
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM4,EMVICOM4,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM5
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM5,EMVICOM5,SP1
          ENDIF
.
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:      * SERVICE_EVENT_TYPE_CODE 
                           PTCNNSSI,TILDA:   * SERVICE_EVENT_SOURCE_ID 
                           VISITNUM,TILDA:   * SERVICE_ENCOUNTER_RECORD_ID 
                           ONE,TILDA:        * SERVICE_EVENT_RECORD_ID 
                           ONE,TILDA:   * PRESENTING_ISSUE_RECORD_ID 
                           ZERO,THREE,TILDA: * PRESENTING_ISSUE_SOURCE_CODE 
                           ZERO,ONE,TILDA:   * PRESENTING_ISSUE_SEQUENCE_NUMBER 
                           TILDA:            * PRESENTING_ISSUE_START_DATE 
                           TILDA:            * PRESENTING_ISSUE_REF_SOURCE_ID 
                           TILDA:            * PRESENTING_ISSUE_REF_DOMAIN_ID 
                           TILDA:            * PRESENTING_ISSUE_CODE 
                           DIM20:
                           EMVICOM1,EMVICOM2:
                           EMVICOM3,EMVICOM4:
                           EMVICOM5:
                           EMVICOM6:           * PRESENTING_ISSUE_COMMENTS 
                           SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          CALL      WRCOND00     * write record to container detail table
.
EDFF9999  RETURN
+
.******************************************************************************
.* EDPR0000 - 59 PRESENTING_ISSUE
.******************************************************************************
EDPR0000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "59 ",DELETOBJ          * SERVICE_EVENT_DELAY
          PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             SP70,SP70                * Delete Key
          CALL      EDDK0000
.
          MATCH     SP70,EMVIUC20           * Don't report blank
          GOTO      EDPR9999 IF EQUAL       * presenting complaint
.
          PACK      KEY5,CATEL,EMVIUC20,SP70
          CALL      RDCODE1                 * Read Presenting Complaint
          IF        OVRCD=1
            MOVE      EMVIUC20,TDESC
          ENDIF
.
          MOVE      TDESC,DIM20
.
          MOVE      "59",OBJECTTY               * PRESENTING_ISSUE
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,EMVIUC20:
                             SP70,SP70
.
          SQUEEZE   EMVIDATE
          SQUEEZE   EMVIUC20
          STRIP     DIM20
          STRIP     EMVICOM1
          STRIP     EMVICOM2
          STRIP     EMVICOM3
          STRIP     EMVICOM4
          STRIP     EMVICOM5
          STRIP     EMVICOM6
.
          MATCH     SP70,DIM20
          IF        !@EQUAL & !@EOS
            PACK      DIM20,DIM20,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM1
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM1,EMVICOM1,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM2
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM2,EMVICOM2,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM3
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM3,EMVICOM3,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM4
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM4,EMVICOM4,SP1
          ENDIF
.
          MATCH     SP70,EMVICOM5
          IF        !@EQUAL & !@EOS
            PACK      EMVICOM5,EMVICOM5,SP1
          ENDIF
.
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:      * SERVICE_EVENT_TYPE_CODE
                           PTCNNSSI,TILDA:   * SERVICE_EVENT_SOURCE_ID
                           VISITNUM,TILDA:   * SERVICE_ENCOUNTER_RECORD_ID
                           ONE,TILDA:        * SERVICE_EVENT_RECORD_ID
                           ONE,TILDA:   * PRESENTING_ISSUE_RECORD_ID
                           ZERO,THREE,TILDA: * PRESENTING_ISSUE_SOURCE_CODE
                           ZERO,ONE,TILDA:   * PRESENTING_ISSUE_SEQUENCE_NUMBER
                           TILDA:            * PRESENTING_ISSUE_START_DATE
                           TILDA:            * PRESENTING_ISSUE_REF_SOURCE_ID
                           TILDA:            * PRESENTING_ISSUE_REF_DOMAIN_ID
                           TILDA:            * PRESENTING_ISSUE_CODE
                           DIM20:
                           EMVICOM1,EMVICOM2:
                           EMVICOM3,EMVICOM4:
                           EMVICOM5:
                           EMVICOM6:           * PRESENTING_ISSUE_COMMENTS
                           SP900
.
          PACK      SRCRDATE,PMAWCDAT,SP70
          PACK      SRCRTIME,PMAWCTIM,SP70
          PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
          PACK      SRMDTIME,PMAWCTIM,SP70
.
          CALL      WRCOND00     * write record to container detail table
.
EDPR9999  RETURN
+
.******************************************************************************
.* EDGG0000 - 56 SERVICE_ACTIVITY
.******************************************************************************
EDGG0000  MOVE      "18 ",DELETSTM               * 18=Emergency Department
          MOVE      "56 ",DELETOBJ               * SERVICE_ACTIVITY
          CALL      EDDL0000                     * Delete previously sent
.
          PACK      KEY14,DEMVIADM,ZERO,ZERO,FOUR,SP70
          CALL      RSEMVCD1
EDGG1000  CALL      RKEMVCD1                     * Read visit procedures
          BRANCH    OVRCD,EDGG9999
.
          MATCH     DEMVIADM,EMVCVIST            * Correct visit
          GOTO      EDGG9999 IF NOT EQUAL
.
          MATCH     "004",EMVCTYPE               * Procedure
          GOTO      EDGG9999 IF NOT EQUAL
.
EDGG3000  MOVE      "7452-001",DIM8              
.
          MOVE      "56",OBJECTTY                * SERVICE_ACTIVITY
          PACK      OBJECTKY,DEMVIADM,EMVCTYPE,EMVCUNIQ:
                             EMVCCSYS,EMVCMNCD,EMVCSEQU,ONE,SP70,SP70
.
          MOVE      EMVCDATE,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
          PACK      DIM250,SP70,SP70,SP70,SP70,SP70
.
          IF        EMVCCSYS=2
            PACK      KEY9,EMVCMNCD,SP70
            MOVE      EMVCDATE,ICDRDDTE
            CALL      RDPTICO1
            IF        OVRCD=1
              MOVE      SP70,ODESC
            ENDIF
            PACK    DIM250,ODESC,SP70,SP70,SP70
          ENDIF
.
          IF        EMVCCSYS=6
            CALL      GPIT0000              * Get private practice item
          ENDIF
.
.         ACTIVITY_REF_DOMAIN_ID
.
          MOVE      "22983",DIM20              * Pre-july 2019  icd 10 ed 10
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX1,EMVIDDAT        * disc.date > icd 10 ed 11
            IF        !@LESS
              MOVE      "33995",DIM20
            ENDIF
          ELSE
            MATCH     PTCNGDX1,EMVIDATE        * arrival.date > icd 10 ed 11
            IF        !@LESS
              MOVE      "33995",DIM20
            ENDIF
          ENDIF
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX2,EMVIDDAT        * disc.date > icd 10 ed 12
            IF        !@LESS
              MOVE      "47639",DIM20
            ENDIF
          ELSE
            MATCH     PTCNGDX2,EMVIDATE        * arrival.date > icd 10 ed 12
            IF        !@LESS
              MOVE      "47639",DIM20
            ENDIF
          ENDIF
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX3,EMVIDDAT        * disc.date > icd 10 ed 13
            IF        !@LESS
              MOVE      "49763",DIM20
            ENDIF
          ELSE
            MATCH     PTCNGDX3,EMVIDATE        * arrival.date > icd 10 ed 13
            IF        !@LESS
              MOVE      "49763",DIM20
            ENDIF
          ENDIF
.
          PACK      DIM100,DEMVIADM,EMVCTYPE,EMVCUNIQ:  * ACTIVITY_RECORD_ID
                           EMVCCSYS,EMVCMNCD,EMVCSEQU,SP70,SP70
. 
          SQUEEZE   DIM10A
          SQUEEZE   EMVITIME
          SQUEEZE   EMVCTIME
          SQUEEZE   DIM10B
          SQUEEZE   EMVIDTIM
          UNPACK    EMVCUNIQ,D1,DIM2
          SQUEEZE   EMVCUNIQ
          SQUEEZE   EMVCVIST
          SQUEEZE   EMVCMNCD
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          STRIP     DIM250
          SQUEEZE   DIM20
          SQUEEZE   DIM100
          REP       " -",DIM100
.
          IF        EMVISTAT=1
            MOVE      SP70,DIM19B
          ELSE
            PACK      DIM19B,DIM10B,SP1,EMVIDTIM
          ENDIF
          STRIP     DIM19B
.
          PACK      OBJECTTX,PTCNNSSI,TILDA:     * ACTIVITY_SOURCE_ID 
                             DIM100,TILDA:       * ACTIVITY_RECORD_ID 
                             ONE,TILDA:          * EVENT_TYPE_CODE  
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:          * EVENT_RECORD_ID
                             DIM2,TILDA:         * ACTIVITY_SEQUENCE_NUMBER 
                             DIM8,TILDA:         * ACTIVITY_REF_SOURCE_ID
                             DIM20,TILDA:        * ACTIVITY_REF_DOMAIN_ID 
                             EMVCVIST,EMVCTYPE:
                             EMVCUNIQ,EMVCCSYS:
                             EMVCMNCD,EMVCUNIQ:  
                             TILDA:              * ACTIVITY_CODE
                             ZERO,THREE,TILDA:   * ACTIVITY_SOURCE_CODE 
                             ONE,TILDA:          * ACTIVITY_TYPE_CODE 
                             DIM250,TILDA:          * ACTIVITY_COMMENTS 
                           DIM10A,SP1,EMVCTIME,TILDA: * ACTIVITY_START_DATETIME
                           DIM19B:               * ACTIVITY_END_DATETIME
                             SP900
.
          PACK      SRCRDATE,EMVCCDAT,SP70
          PACK      SRCRTIME,EMVCCTIM,SP70
.
          PACK      SRMDDATE,EMVCCDAT,SP70 * Add trigger
          PACK      SRMDTIME,EMVCCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDGG1000
.
EDGG9999  RETURN
+
.******************************************************************************
.* Get private practice item                  
.******************************************************************************
GPIT0000  MOVE      EMVCMNCD,DIM9
          PACK      KEY22,SP1,ZERO,DIM9,EMVCSUBN,Z70
          CALL      RSPRIT1
          CALL      RPPRIT1
          BRANCH    OVRCD,GPIT9999
.
          COMPARE   ZERO,PRITFLAG
          GOTO      GPIT9999 IF NOT EQUAL
.
          MATCH     DIM9,PRITITMN
          GOTO      GPIT9999 IF NOT EQUAL
.
          MATCH     EMVCSUBN,PRITSUBN
          GOTO      GPIT9999 IF NOT EQUAL
.
          MATCH     PRITDAT1,EMVCDATE
          GOTO      GPIT9999 IF LESS
.
          PACK      DIM250,PRITDESC,SP70,SP70,SP70,SP70
.
GPIT9999  RETURN
+
.******************************************************************************
.* EDHH0000 - 60 SERVICE_EVENT_ATTRIBUTE
.******************************************************************************
EDHH0000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "60 ",DELETOBJ          * SERVICE_EVENT_DELAY
          PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                            SP70,SP70      * Delete Key
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
          CALL      EDDK0000
.
          MOVE      SP70,DIM10C
          PACK      KEY5,ANSC,ANSL,EMVICOMP,SP70      * Read claim code
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDASC3,DIM10C            * Associated field 3
          ENDIF
.
          MOVE      "60",OBJECTTY               * SERVICE_EVENT_ATTRIBUTE
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,EMVICOMP,ZERO,ONE:
                             SP70,SP70
.
          MOVE      EMVIDATE,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
          SQUEEZE   EMVICOMP
          SQUEEZE   DIM10A
          SQUEEZE   EMVITIME
          SQUEEZE   DIM10B
          SQUEEZE   DIM10C
          SQUEEZE   EMVIDTIM
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          IF        EMVISTAT=1
            MOVE      SP70,DIM19B
          ELSE
            PACK      DIM19B,DIM10B,SP1,EMVIDTIM
          ENDIF
          STRIP     DIM19B
.
          PACK      OBJECTTX,ONE,TILDA:         * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:    * EVENT_SOURCE_ID
                             VISITNUM,TILDA:    * ENCOUNTER_RECORD_ID
                             ONE,TILDA:         * EVENT_RECORD_ID
                             EMVICOMP,DASH:
                             ZERO,ONE,TILDA:    * EVENT_ATTRIBUTE_RECORD_ID
                             ZERO,ONE,TILDA:    * EVENT_ATTRIBUTE_TYPE_CODE
                             TILDA:             * EVENT_ATTRIBUTE_LOCAL_CODE
                             DIM10C,TILDA:        * EVENT_ATTRIBUTE_CODE
                             DIM10A,SP1,EMVITIME,TILDA: * START_DATETIME
                             DIM19B:            * END_DATETIME
                             SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
. Not reported after July 2021 
.
....      MOVE      SP70,DIM10C
....      PACK      KEY5,ANSC,ANSL,EMVICOMP,SP70      * Read claim code
....      CALL      RDCODE1
....      IF        OVRCD<>1
....        MOVE      PTCDASC4,DIM10C            * Associated field 4 
....      ENDIF
....
....      MOVE      "60",OBJECTTY               * SERVICE_EVENT_ATTRIBUTE
....      PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM,EMVICOMP,ZERO,TWO:
....                         SP70,SP70
....
....      MOVE      EMVIDATE,DATFIELD        * CCYYMMDD
....      CALL      FMTD0000                 * Format date
....      MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
....
....      MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD
....      CALL      FMTD0000                 * Format date
....      MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
....
....      SQUEEZE   EMVICOMP
....      SQUEEZE   DIM10A
....      SQUEEZE   EMVITIME
....      SQUEEZE   DIM10B
....      SQUEEZE   DIM10C
....      SQUEEZE   EMVIDTIM
....      MOVE      DEMVIADM,VISITNUM
....      SQUEEZE   VISITNUM
....
....      IF        EMVISTAT=1
....        MOVE      SP70,DIM19B
....      ELSE
....        PACK      DIM19B,DIM10B,SP1,EMVIDTIM
....      ENDIF
....      STRIP     DIM19B
....
....      PACK      OBJECTTX,ONE,TILDA:         * EVENT_TYPE_CODE
....                         PTCNNSSI,TILDA:    * EVENT_SOURCE_ID 
....                         VISITNUM,TILDA:    * ENCOUNTER_RECORD_ID 
....                         ONE,TILDA:         * EVENT_RECORD_ID 
....                         EMVICOMP,DASH:
....                         ZERO,TWO,TILDA:    * EVENT_ATTRIBUTE_RECORD_ID 
....                         ZERO,TWO,TILDA:    * EVENT_ATTRIBUTE_TYPE_CODE 
....                         TILDA:             * EVENT_ATTRIBUTE_LOCAL_CODE  
....                         DIM10C,TILDA:        * EVENT_ATTRIBUTE_CODE 
....                         DIM10A,SP1,EMVITIME,TILDA: * START_DATETIME 
....                         DIM19B:            * END_DATETIME 
....                         SP900
....
....      PACK      SRCRDATE,PMVXCDTE,SP70
....      PACK      SRCRTIME,PMVXCTIM,SP70
....
....      PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
....      PACK      SRMDTIME,PMVXCTIM,SP70
....
....      IF        SDATFLAG=1
....        PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
....        PACK      SRMDTIME,PMAWCTIM,SP70
....      ENDIF
....
....      CALL      WRCOND00     * write record to container detail table
....
EDHH9999  RETURN
+
.******************************************************************************
.* EDII0000 - 61 DIAGNOSIS                      
.* Sequence number - 01 - Principal, 02 = Additional 2, 03 - Addition 3, etc
.******************************************************************************
EDII0000  MOVE      "18 ",DELETSTM               * 18=Emergency Department
          MOVE      "61 ",DELETOBJ               * DIAGNOSIS
          CALL      EDDL0000                     * Delete previously sent
.
          MOVE      ONE,DIAGUNIQ                 * Diagnosis unique counter
          MOVE      SP70,DIAGSEQN                * Diagnosis sequence number
.
          PACK      KEY14,DEMVIADM,ZERO,ZERO,FIVE,SP70
          CALL      RSEMVCD1
EDII1000  CALL      RKEMVCD1                     * Read visit diagnosis
          BRANCH    OVRCD,EDII5000
.
          MATCH     DEMVIADM,EMVCVIST            * Correct visit
          GOTO      EDII5000 IF NOT EQUAL
.
          MATCH     "005",EMVCTYPE               * Diagnosis
          GOTO      EDII5000 IF NOT EQUAL
.
          MATCH     "DNW",EMVCMNCD               * Don't report the did not
          GOTO      EDII1000 IF EQUAL            * wait diagnosis code
.
          MATCH     "000",EMVCSEQU               * Principal/Primary
          IF        @EQUAL
            MOVE      "001",DIAGSEQN             * Diagnosis sequence number
          ELSE                            
            ADD       ONE,DIAGUNIQ               * Additional diagnosis
            MOVE      DIAGUNIQ,DIAGSEQN          * Unique counter
            REP       " 0",DIAGSEQN              * Diagnosis sequence number
          ENDIF
.
          MOVE      "7452-001",DIM8
.
          MOVE      "22502",DIM5               * Pre-july 2019  icd 10 ed 10
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX1,EMVIDDAT        * disc.date > icd 10 ed 11
            IF        !@LESS
              MOVE      "23856",DIM5
            ENDIF
          ELSE
            MATCH     PTCNGDX1,EMVIDATE        * arrival.date > icd 10 ed 11
            IF        !@LESS
              MOVE      "23856",DIM5
            ENDIF
          ENDIF
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX2,EMVIDDAT        * disc.date > icd 10 ed 12
            IF        !@LESS
              MOVE      "47146",DIM5
            ENDIF
          ELSE
            MATCH     PTCNGDX2,EMVIDATE        * arrival.date > icd 10 ed 12
            IF        !@LESS
              MOVE      "47146",DIM5
            ENDIF
          ENDIF
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX3,EMVIDDAT        * disc.date > icd 10 ed 13
            IF        !@LESS
              MOVE      "49412",DIM5
            ENDIF
          ELSE
            MATCH     PTCNGDX3,EMVIDATE        * arrival.date > icd 10 ed 13
            IF        !@LESS
              MOVE      "49412",DIM5
            ENDIF
          ENDIF
.
          MOVE      "DD",DIM2              * Diagnosis
.
          PACK      KEY9,EMVCMNCD,SP70 
          CALL      RDEMICD1
          IF        OVRCD=1
            MOVE     SP70,EMIC10CD         * ICD10 - Code
          ENDIF
.
          MATCH     SP70,EMIC10CD
          IF        @EQUAL
            MOVE     EMVCMNCD,EMIC10CD     * ICD10 - Code
          ENDIF
.
          MOVE      "61",OBJECTTY                * DIAGNOSIS
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,EMVCVIST:
                             EMVCTYPE,DIAGSEQN,SP70,SP70
.
          SQUEEZE   EMVCVIST
          SQUEEZE   EMIC10CD
          UNPACK    DIAGSEQN,D1,DIM2A
          SQUEEZE   DIAGSEQN
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID 
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:          * EVENT_RECORD_ID 
                             EMVCVIST,EMVCTYPE:
                             DIAGSEQN,TILDA:     * DIAGNOSIS_RECORD_ID 
                             ZERO,THREE,TILDA:   * SOURCE_CODE
                             DIM8,TILDA:         * REF_SOURCE_ID 
                             DIM5,TILDA:         * REF_DOMAIN_ID 
                             EMIC10CD,TILDA:     * DIAGNOSIS_CODE 
                             DIM2A,TILDA:        * SEQUENCE_NUMBER 
                             NINE,TILDA:         * CONFIRMATION_STATUS_CODE 
                             DIM2,TILDA:         * TYPE_CODE 
                             EMVIDATE,TILDA:     * DATE
                             SP900               * COMMENTS
.
          PACK      SRCRDATE,EMVCCDAT,SP70
          PACK      SRCRTIME,EMVCCTIM,SP70
.
          PACK      SRMDDATE,EMVCCDAT,SP70 * Add trigger
          PACK      SRMDTIME,EMVCCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDII1000
.
EDII5000  MATCH     SP70,EMVIHUMI          
          GOTO      EDII9999 IF EQUAL
.
          PACK      KEY5,CATEZ,EMVIHUMI,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EDII9999
.
          UNPACK    THCSCOD,DIM2A       * 1st 2 characters of HDP
          MATCH     SP70,DIM2A
          GOTO      EDII9999 IF EQUAL
.
          MOVE      "7452-001",DIM8
.
          MOVE      "22502",DIM5               * Pre-july 2019  icd 10 ed 10
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX1,EMVIDDAT        * disc.date > icd 10 ed 11
            IF        !@LESS
              MOVE      "23856",DIM5
            ENDIF
          ELSE
            MATCH     PTCNGDX1,EMVIDATE        * arrival.date > icd 10 ed 11
            IF        !@LESS
              MOVE      "23856",DIM5
            ENDIF
          ENDIF
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MATCH     PTCNGDX2,EMVIDDAT        * disc.date > icd 10 ed 12
            IF        !@LESS
              MOVE      "47146",DIM5
            ENDIF
          ELSE
            MATCH     PTCNGDX2,EMVIDATE        * arrival.date > icd 10 ed 12
            IF        !@LESS
              MOVE      "47146",DIM5
            ENDIF
          ENDIF
.
          MOVE      "I",DIM2B            * Injury Intent
.
          MOVE      "61",OBJECTTY                * DIAGNOSIS
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             DIM2,EMVIHUMI,SP70,SP70
.
          SQUEEZE   EMVIHUMI
          SQUEEZE   EMVCVIST
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          MOVE      ONE,DIM2
          SQUEEZE   DIM2
          SQUEEZE   DIM2A
          SQUEEZE   DIM2B
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:     * EVENT_SOURCE_ID
                             VISITNUM,TILDA:     * ENCOUNTER_RECORD_ID
                             ONE,TILDA:          * EVENT_RECORD_ID
                             VISITNUM,EMVCTYPE:
                             EMVIHUMI,TILDA:     * DIAGNOSIS_RECORD_ID
                             ZERO,THREE,TILDA:   * SOURCE_CODE
                             DIM8,TILDA:         * REF_SOURCE_ID
                             DIM5,TILDA:         * REF_DOMAIN_ID
                             DIM2A,TILDA:        * DIAGNOSIS_CODE
                             DIM2,TILDA:         * SEQUENCE_NUMBER
                             NINE,TILDA:         * CONFIRMATION_STATUS_CODE
                             DIM2B,TILDA:        * TYPE_CODE
                             EMVIDATE,TILDA:     * DATE
                             SP900               * COMMENTS
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDII9999  RETURN
+
.******************************************************************************
.* EDJJ0000 - 63 SERVICE_EVENT_PROVIDER  (Organisation and individual)
.******************************************************************************
EDJJ0000  MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "63 ",DELETOBJ          * SERVICE_EVENT_DELAY
          PACK      DELETKEY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
                             DEMVIADM,SP70,SP70            * Delete Key
          CALL      EDDK0000
.
          MOVE      "63",OBJECTTY               * SERVICE_EVENT_PROVIDER
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
                             DEMVIADM,EMSTSPNO,SP70,SP70
.
          MOVE      "9475-001",DIM8
.
          MOVE      EMVIDATE,DATFIELD         * CCYYMMDD    Start Date
          CALL      FMTD0000                  * Format date
          MOVE      FORMATDT,DIM10A           * CCYY-MM-DD
.
          PACK      DIM8A,EMVITIME,SP70       * Start time
.
          MOVE      SP70,DIM10B
          MOVE      SP70,DIM8B
.
          IF        EMVISTAT<>1 
            MOVE      EMVIDDAT,DATFIELD       * CCYYMMDD    End Date
            CALL      FMTD0000                * Format date
            MOVE      FORMATDT,DIM10B         * CCYY-MM-DD
.
            PACK      DIM8B,EMVIDTIM,SP70     * End time
          ENDIF
.
          SQUEEZE   EMSTSPNO
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM10A
          SQUEEZE   DIM8A
          SQUEEZE   DIM10B
          SQUEEZE   DIM8B
.
          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID 
                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:           * EVENT_RECORD_ID 
                             EMSTSPNO,TILDA:      * EVENT_PROVIDER_RECORD_ID 
                             ANSO,TILDA:          * PROVIDER_TYPE_CODE 
                             ONE,ZERO,ZERO,TILDA: * PROVIDER_ID_TYPE_CODE 
                             DIM8,TILDA:          * PROVIDER_SOURCE_ID 
                             EMSTSPNO,TILDA:      * SERVICE_PROVIDER_ID 
                             TILDA:               * ISP_DISC_SPEC_CODE 
                             TILDA:             * ISP_DISC_SPEC_LOCAL_CODE 
                             PTCNNIAI,TILDA:    * OSP_LOCAL_ID 
                             ANSY,TILDA:        * RESPONSIBLE_PROVIDER_FLAG 
                             ANSN,TILDA:        * OSP_CREATED_SERVICE_EVENT_FLAG
                        DIM10A,SP1,DIM8A,TILDA: * EFFECTIVE_START_DATE
                        DIM10B,SP1,DIM8B,SP900  * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRCRDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRCRTIME,EMCHTIME,SP70
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      "63",OBJECTTY               * SERVICE_EVENT_PROVIDER
.
          MOVE      PTCNNIAI,DIM20
.
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
                             DEMVIADM,DIM20,SP70,SP70
.
          MOVE      "9475-001",DIM8
.
          SQUEEZE   EMSTSPNO
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM20            
.
          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID
                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID
                             ONE,TILDA:           * EVENT_RECORD_ID
                             DIM20,TILDA:         * EVENT_PROVIDER_RECORD_ID
                             ANSO,TILDA:          * PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA: * PROVIDER_ID_TYPE_CODE
                             DIM8,TILDA:          * PROVIDER_SOURCE_ID
                             DIM20,TILDA:         * SERVICE_PROVIDER_ID
                             TILDA:               * ISP_DISC_SPEC_CODE
                             TILDA:             * ISP_DISC_SPEC_LOCAL_CODE
                             PTCNNIAI,TILDA:    * OSP_LOCAL_ID
                             ANSN,TILDA:        * RESPONSIBLE_PROVIDER_FLAG
                             ANSY,TILDA:        * OSP_CREATED_SERVICE_EVENT_FLAG
                        DIM10A,SP1,DIM8A,TILDA: * EFFECTIVE_START_DATE
                        DIM10B,SP1,DIM8B,SP900  * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      SP70,DIM24                   * Saved Dr, date and time
          PACK      KEY22,DEMVIADM,SP70
          CALL      RSEMHIS1
EDJJ5000  CALL      RKEMHIS1                     * Read EMR history to get
          BRANCH    OVRCD,EDJJ9000               * doctors   
.
          MATCH     DEMVIADM,EMHIVIS             * same visit
          GOTO      EDJJ9000 IF NOT EQUAL
.
          PACK      DIM24A,EMHIDOC,EMHIDSD,EMHIDST,SP70

          MATCH     DIM24,DIM24A                * Change in Dr, date and time
          GOTO      EDJJ5000 IF EQUAL
.
          MOVE      DIM24A,DIM24                * Save current Dr, date and time
.
          MOVE      SP70,DIM10B
          MOVE      SP70,DIM8B
          PACK      SAVKEY22,EMHIVIS,EMHIDAT,EMHITIM,SP70  * Save key
EDJJ5500  CALL      RKEMHIS1                     * to find prev dr end date
          BRANCH    OVRCD,EDJJ6000
.
          MATCH     DEMVIADM,EMHIVIS             * same visit
          GOTO      EDJJ6000 IF NOT EQUAL
.
          PACK      DIM24A,EMHIDOC,EMHIDSD,EMHIDST,SP70
.
          MATCH     DIM24,DIM24A             * Change in Dr, date and time
          GOTO      EDJJ5500 IF EQUAL
.
          MATCH     SP70,EMHIDOC             * Corript history doctor missing
          GOTO      EDJJ5500 IF EQUAL
.
          MOVE      EMHIDSD,DATFIELD         * CCYYMMDD    End Time
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
          UNPACK    EMHIDST,DHOUR,MIN,SEC             
          PACK      DIM8B,DHOUR,COLON,MIN,COLON,SEC,SP70    * End date
          GOTO      EDJJ6500
.
EDJJ6000  IF        EMVISTAT<>1
            MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD
            CALL      FMTD0000                 * Format date
            MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
            MOVE      EMVIDDAT,DIM8BB
.
            MOVE      EMVIDTIM,DIM8B
          ENDIF
.
EDJJ6500  PACK      KEY22,SAVKEY22,SP70
          CALL      RDEMHIS1
          BRANCH    OVRCD,EDJJ5000
.
          PACK      KEY10,EMHIDOC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EDJJ5000
.
          MOVE      SP70,DIM10
          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF3,DIM10            * User defined field 2
          ENDIF
.
          UNPACK    EMHIDST,DIM2,DIM2A,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          MOVE      "63",OBJECTTY               * SERVICE_EVENT_PROVIDER
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
                             DEMVIADM,EMHIDOC,EMHIDSD,DIM8,SP70,SP70
.
          MOVE      EMHIDSD,DATFIELD         * CCYYMMDD    Start Date
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          UNPACK    EMHIDST,DHOUR,MIN,SEC
          PACK      DIM8A,DHOUR,COLON,MIN,COLON,SEC,SP70    * Start time
.
          UNPACK    EMHIDSD,D4,DIM4
          PACK      DIM9,DASH,DIM4,DHOUR,MIN,SP70
.
          SQUEEZE   EMHIDOC
          SQUEEZE   PMHCSPC1
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM10
          SQUEEZE   DIM10A
          SQUEEZE   DIM8A
          SQUEEZE   DIM10B
          SQUEEZE   DIM8B
          SQUEEZE   DIM9
.
          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID
                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID
                             ONE,TILDA:           * EVENT_RECORD_ID
                             EMHIDOC,DIM9,TILDA:  * EVENT_PROVIDER_RECORD_ID
                             ANSI,TILDA:             * PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA:  * PROVIDER_ID_TYPE_CODE
                             PTCNNSSI,TILDA:          * PROVIDER_SOURCE_ID
                             EMHIDOC,TILDA:      * PROVIDER_ID
                             DIM10,TILDA:      * ISP_DISC_SPEC_CODE
                             TILDA:             * ISP_DISC_SPEC_LOCAL_CODE
                             TILDA:             * OSP_LOCAL_ID
                             ANSY,TILDA:        * RESPONSIBLE_PROVIDER_FLAG
                             ANSN,TILDA:        * OSP_CREATED_SERVICE_EVENT_FLAG
                        DIM10A,SP1,DIM8A,TILDA: * EFFECTIVE_START_DATE
                        DIM10B,SP1,DIM8B,SP900  * EFFECTIVE_END_DATE

.
          PACK      SRCRDATE,EMHIDAT,SP70
          UNPACK    EMHITIM,DHOUR,MIN,SEC
          PACK      SRCRTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.
          PACK      SRMDDATE,EMHIDAT,SP70 * Add trigger
          UNPACK    EMHITIM,DHOUR,MIN,SEC
          PACK      SRMDTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDJJ5000
.
....EDJJ7000  MOVE      SP70,DIM10C
....          PACK      KEY22,DEMVIADM,SP70
....          CALL      RSEMHIS1
....EDJJ7500  CALL      RKEMHIS1                     * Read EMR history to get
....          BRANCH    OVRCD,EDJJ9000               * nurse
.....
....          MATCH     DEMVIADM,EMHIVIS             * same visit
....          GOTO      EDJJ9000 IF NOT EQUAL
.....
....          MATCH     DIM10C,EMHINUR                * Change in Nurse code
....          GOTO      EDJJ7500 IF EQUAL
.....
....          MOVE      EMHINUR,DIM10C                * Save current Nurse
.....
....          MOVE      SP70,DIM10B
....          MOVE      SP70,DIM8B
....          PACK      SAVKEY22,EMHIVIS,EMHIDAT,EMHITIM,SP70  * Save key
....EDJJ8500  CALL      RKEMHIS1                     * to find prev dr end date
....          BRANCH    OVRCD,EDJJ8700
.....
....          MATCH     DEMVIADM,EMHIVIS             * same visit
....          GOTO      EDJJ8700 IF NOT EQUAL
.....
....          MATCH     DIM10C,EMHINUR                * Change in Nurse code
....          GOTO      EDJJ8500 IF EQUAL
.....
....          MOVE      EMHINSD,DATFIELD         * CCYYMMDD    End Time
....          CALL      FMTD0000                 * Format date
....          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.....
....          UNPACK    EMHINST,DHOUR,MIN,SEC
....          PACK      DIM8B,DHOUR,COLON,MIN,COLON,SEC,SP70    * End date
....          GOTO      EDJJ8900
.....
....EDJJ8700  IF        EMVISTAT<>1
....            MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD
....            CALL      FMTD0000                 * Format date
....            MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
....            MOVE      EMVIDDAT,DIM8BB
.....
....            MOVE      EMVIDTIM,DIM8B
....          ENDIF
.....
....EDJJ8900  PACK      KEY22,SAVKEY22,SP70
....          CALL      RDEMHIS1
....          BRANCH    OVRCD,EDJJ7500
.....
....          PACK      KEY10,EMHINUR,SP70
....          CALL      RDPMHCP1
....          BRANCH    OVRCD,EDJJ7500
.....
....          MOVE      SP70,DIM10
....          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
....          CALL      RDCODE1
....          IF        OVRCD<>1
....            MOVE      PTCDUDF3,DIM10            * User defined field 2
....          ENDIF
.....
....          UNPACK    EMHINST,DIM2,DIM2A,DIM2B
....          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.....
....          MOVE      "63",OBJECTTY               * SERVICE_EVENT_PROVIDER
....          PACK      OBJECTKY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
....                             DEMVIADM,EMHINUR,DIM8,SP70,SP70
.....
....          MOVE      EMHINSD,DATFIELD         * CCYYMMDD    Start Date
....          CALL      FMTD0000                 * Format date
....          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.....
....          UNPACK    EMHINST,DHOUR,MIN,SEC
....          PACK      DIM8A,DHOUR,COLON,MIN,COLON,SEC,SP70    * Start time
.....
....          UNPACK    EMHINSD,D4,DIM4
....          PACK      DIM9,DASH,DIM4,DHOUR,MIN,SP70
.....
....          MATCH     SP70,EMVIDOCT
....          IF        @EQUAL
....            MOVE      ANSY,DIM1A            * Responsible provider flag
....          ELSE
....            MOVE      ANSN,DIM1A
....          ENDIF
.....
....          SQUEEZE   EMHINUR
....          SQUEEZE   PMHCSPC1
....          MOVE      DEMVIADM,VISITNUM
....          SQUEEZE   VISITNUM
....          SQUEEZE   DIM10
....          SQUEEZE   DIM10A
....          SQUEEZE   DIM8A
....          SQUEEZE   DIM10B
....          SQUEEZE   DIM8B
....          SQUEEZE   DIM9
.....
....          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE
....                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID
....                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID
....                             ONE,TILDA:           * EVENT_RECORD_ID
....                             EMHINUR,DIM9,TILDA:  * EVENT_PROVIDER_RECORD_ID
....                             ANSI,TILDA:             * PROVIDER_TYPE_CODE
....                             ZERO,THREE,FIVE,TILDA:  * PROVIDER_ID_TYPE_CODE
....                             PTCNNSSI,TILDA:          * PROVIDER_SOURCE_ID
....                             EMHINUR,TILDA:      * PROVIDER_ID
....                             DIM10,TILDA:      * ISP_DISC_SPEC_CODE
....                             TILDA:             * ISP_DISC_SPEC_LOCAL_CODE
....                             TILDA:             * OSP_LOCAL_ID
....                             DIM1A,TILDA:        * RESPONSIBLE_PROVIDER_FLAG
....                             ANSN,TILDA:    * OSP_CREATED_SERVICE_EVENT_FLAG
....                        DIM10A,SP1,DIM8A,TILDA: * EFFECTIVE_START_DATE
....                        DIM10B,SP1,DIM8B,SP900  * EFFECTIVE_END_DATE
....
.....
....          PACK      SRCRDATE,EMHIDAT,SP70
....          UNPACK    EMHITIM,DHOUR,MIN,SEC
....          PACK      SRCRTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.....
....          PACK      SRMDDATE,EMHIDAT,SP70 * Add trigger
....          UNPACK    EMHITIM,DHOUR,MIN,SEC
....          PACK      SRMDTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.....
....          IF        SDATFLAG=1
....            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alt. trigger
....            PACK      SRMDTIME,PMAWCTIM,SP70
....          ENDIF
.....
....          IF        SDATFLAG=2
....            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
....            PACK      SRMDTIME,EMCHTIME,SP70
....          ENDIF
.....
....          CALL      WRCOND00     * write record to container detail table
....          GOTO      EDJJ7500
.
EDJJ9000  MATCH     SP70,EMVIMDCD           * Blank initial assessor 
          GOTO      EDJJ9500 IF EQUAL
.
          PACK      KEY10,EMVIMDCD,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EDJJ9500
.
          MOVE      SP70,DIM10
          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF3,DIM10            * User defined field 2
          ENDIF
.
          UNPACK    EMVIMDTM,DIM2,D1,DIM2A,D1,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          MOVE      "63",OBJECTTY               * SERVICE_EVENT_PROVIDER
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
                             DEMVIADM,EMVIMDCD,DIM8,SP70,SP70
.
          MOVE      EMVIMDDT,DATFIELD         * CCYYMMDD    Start Date
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          UNPACK    EMVIMDTM,DHOUR,D1,MIN,D1,SEC
          PACK      DIM8A,DHOUR,COLON,MIN,COLON,SEC,SP70    * Start time
.
          MATCH     SP70,EMVIDRDT                * First seen by a doctor 
          IF        !@EQUAL
            MOVE      EMVIDRDT,DATFIELD        * CCYYMMDD
            CALL      FMTD0000                 * Format date
            MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
            MOVE      EMVIDRTM,DIM8B
          ELSE
            IF        EMVISTAT<>1
              MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD  - Discharge date
              CALL      FMTD0000                 * Format date
              MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
              MOVE      EMVIDTIM,DIM8B           * Discharge time
            ENDIF
          ENDIF
.
          UNPACK    EMVIMDDT,D6,D2
          PACK      DIM9,DASH,D2,DHOUR,MIN,SEC,SP70
.
          MATCH     SP70,EMVIDOCT           * Yes Responsible provider flag
          IF        @EQUAL
            MOVE      ANSY,DIM1A            * Yes
          ELSE
            MOVE      ANSN,DIM1A            * No
          ENDIF
.
          MOVE      EMVIMDCD,DIM10C
          SQUEEZE   DIM10C
          SQUEEZE   PMHCSPC1
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM10
          SQUEEZE   DIM10A
          SQUEEZE   DIM8A
          SQUEEZE   DIM10B
          SQUEEZE   DIM8B
          SQUEEZE   DIM9
.
          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID
                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID
                             ONE,TILDA:           * EVENT_RECORD_ID
                             DIM10C,DIM9,TILDA:  * EVENT_PROVIDER_RECORD_ID
                             ANSI,TILDA:             * PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA:  * PROVIDER_ID_TYPE_CODE
                             PTCNNSSI,TILDA:          * PROVIDER_SOURCE_ID
                             DIM10C,TILDA:      * PROVIDER_ID
                             DIM10,TILDA:      * ISP_DISC_SPEC_CODE
                             TILDA:             * ISP_DISC_SPEC_LOCAL_CODE
                             TILDA:             * OSP_LOCAL_ID
                             DIM1A,TILDA:        * RESPONSIBLE_PROVIDER_FLAG
                             ANSN,TILDA:        * OSP_CREATED_SERVICE_EVENT_FLAG
                        DIM10A,SP1,DIM8A,TILDA: * EFFECTIVE_START_DATE
                        DIM10B,SP1,DIM8B,SP900  * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDJJ9500  MATCH     SP70,EMVITRNS              * Trige Nurse
          GOTO      EDJJ9999 IF EQUAL
.
          PACK      KEY10,EMVITRNS,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EDJJ9999
.
          MOVE      SP70,DIM10
          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      PTCDUDF3,DIM10            * User defined field 2
          ENDIF
.
          UNPACK    EMVITRTM,DIM2,D1,DIM2A,D1,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          MOVE      "63",OBJECTTY               * SERVICE_EVENT_PROVIDER
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
                             DEMVIADM,EMVITRNS,DIM8,SP70,SP70
.
          MOVE      EMVITRDT,DATFIELD         * CCYYMMDD    Start Date
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          UNPACK    EMVITRTM,DHOUR,D1,MIN,D1,SEC
          PACK      DIM8A,DHOUR,COLON,MIN,COLON,SEC,SP70    * Start time
.
          IF        EMVISTAT<>1
            MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD  - Discharge date
            CALL      FMTD0000                 * Format date
            MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
            MOVE      EMVIDTIM,DIM8B           * Discharge time
          ENDIF
.
          MATCH     SP70,EMVIDOCT
          IF        @EQUAL
            IF        EMVISTAT=1
              MOVE      SP70,DIM10B            * blank end date
              MOVE      SP70,DIM8B             * blank end time
            ELSE
              MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD  - Discharge date
              CALL      FMTD0000                 * Format date
              MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
              MOVE      EMVIDTIM,DIM8B           * Discharge time
            ENDIF
            MOVE     SP70,EMHIDST
            MOVE     SP70,EMHIDSD
          ELSE
            PACK     KEY22,DEMVIADM,SP70
            CALL     RSEMHIS1
EDJJ9600    CALL     RKEMHIS1                     * Find first doctor 
            BRANCH   OVRCD,EDJJ9700               * allocated
.
            MATCH    DEMVIADM,EMHIVIS             * same visit
            GOTO     EDJJ9700 IF NOT EQUAL
.
            MATCH    SP70,EMHIDOC                 * Find first Dr code
            GOTO     EDJJ9600 IF EQUAL
.
            MOVE     EMHIDSD,DATFIELD
            CALL     FMTD0000
            MOVE     FORMATDT,DIM10B
            UNPACK   EMHIDST,DHOUR,MIN,SEC
            PACK     DIM8B,DHOUR,COLON,MIN,COLON,SEC,SP70
          ENDIF
EDJJ9700  UNPACK    EMVITRDT,D4,DIM4
          PACK      DIM9,DASH,DIM4,DHOUR,MIN,SP70
.
          MATCH     EMVITRDT,EMHIDSD
          IF        @EQUAL
            MATCH     EMVITRTM,DIM8B
            IF        @EQUAL
              MOVE      ANSN,DIM1A
            ELSE   
              MOVE      ANSY,DIM1A
            ENDIF
          ELSE
            MOVE      ANSY,DIM1A                 * Responsible provider Yes
          ENDIF
          MOVE      EMVITRNS,DIM10C            * Triage Nurse
.
          SQUEEZE   PMHCSPC1
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM10
          SQUEEZE   DIM10A
          SQUEEZE   DIM8A
          SQUEEZE   DIM10B
          SQUEEZE   DIM10C
          SQUEEZE   DIM8B
          SQUEEZE   DIM9
.
          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID
                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID
                             ONE,TILDA:           * EVENT_RECORD_ID
                             DIM10C,DIM9,TILDA:   * EVENT_PROVIDER_RECORD_ID
                             ANSI,TILDA:             * PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA:  * PROVIDER_ID_TYPE_CODE
                             PTCNNSSI,TILDA:          * PROVIDER_SOURCE_ID
                             DIM10C,TILDA:      * PROVIDER_ID
                             DIM10,TILDA:       * ISP_DISC_SPEC_CODE
                             TILDA:             * ISP_DISC_SPEC_LOCAL_CODE
                             TILDA:             * OSP_LOCAL_ID
                             DIM1A,TILDA:       * RESPONSIBLE_PROVIDER_FLAG
                             ANSN,TILDA:        * OSP_CREATED_SERVICE_EVENT_FLAG
                        DIM10A,SP1,DIM8A,TILDA: * EFFECTIVE_START_DATE
                        DIM10B,SP1,DIM8B,SP900  * EFFECTIVE_END_DATE
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDJJ9999  RETURN
+
.******************************************************************************
.* EDKK0000 - 145 SERVICE_EVENT_AND_EMERGENCY_DEPARTMENT
.******************************************************************************
EDKK0000  MOVE      SP70,DIM2
          MOVE      SP70,DIM15
          PACK      KEY5,ANSE,ANSA,EMVIMODE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM2     * HDP pos 1 and 2
            MATCH     ANSA,TCINDC1
            IF        @EQUAL
              MOVE      EMVIAMBL,DIM15
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM2A
          PACK      KEY5,CATEE,EMVIUC13,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    THCSCOD,DIM2A    * HDP pos 1 and 2
          ENDIF
.
          MOVE      SP70,DIM5
          PACK      KEY5,ANSE,ANSD,EMVIDSTA,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    PTCDASC1,DIM5     * Ass field 1
            UNPACK    PTCDUDF3,DIM8A    * User defined 3
          ENDIF
.
          MOVE      SP70,DIM5A
          PACK      KEY5,CATEY,EMVIINJC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    PTCDASC1,DIM5A    * Ass field 1
          ENDIF
.
          MOVE      SP70,DIM5B
          PACK      KEY5,CATEM,EMVIUC21,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK    PTCDASC1,DIM5B    * Ass field 1
          ENDIF
.
          MOVE      "145",OBJECTTY     * SERVICE_EVENT_AND_EMERGENCY_DEPARTMENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,SP70,SP70
.
          MOVE      EMVIDATE,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      EMVIDDAT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
.
.  Arrived by ambulance
.
          MATCH     "01",DIM2                * Ambulance
          IF        !@EQUAL
            MATCH     "05",DIM2              * Ambulance
            GOTO      EDKK2000 IF NOT EQUAL
          ENDIF
.
. Use arrival date if arrived by ambulanace and no ambulabnce date available
.
          MATCH     SP70,EMVIUD09
          IF        @EQUAL
            MOVE      EMVIDATE,DATFIELD        * CCYYMMDD
            CALL      FMTD0000                 * Format date
            MOVE      FORMATDT,DIM10C          * CCYY-MM-DD
.
            MOVE      EMVITIME,DIM8C
            GOTO      EDKK2500
          ENDIF
.
EDKK2000  MOVE      EMVIUD09,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10C          * CCYY-MM-DD
.
          MOVE      EMVIUT09,DIM8C
.
EDKK2500  MOVE      SP70,EMPLOYMS
          MATCH     SP70,PMVXEMPL
          IF        !@EQUAL
            PACK      KEY5,ANSK,ANSD,PMVXEMPL,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      PTCDUDF3,EMPLOYMS
            ENDIF
          ENDIF
.
          MOVE      EMVITRIG,DIM3
          SQUEEZE   DIM3
          SQUEEZE   DIM10A
          SQUEEZE   DIM10B
          SQUEEZE   DIM10C
          SQUEEZE   DIM8C
          SQUEEZE   EMVITIME
          SQUEEZE   EMVIDTIM
          SQUEEZE   EMVIUC08
          SQUEEZE   DIM2
          SQUEEZE   DIM2A
          SQUEEZE   DIM5
          SQUEEZE   DIM5A
          SQUEEZE   DIM5B
          SQUEEZE   DIM8A
          SQUEEZE   DIM15
          SQUEEZE   EMPLOYMS
.
          REP       "~-",EMVICOM1
          REP       "~-",EMVICOM2
          REP       "~-",EMVICOM3
          REP       "~-",EMVICOM4
          REP       "~-",EMVICOM5
          REP       "~-",EMVICOM6
.
          STRIP     EMVICOM1
          STRIP     EMVICOM2
          STRIP     EMVICOM3
          STRIP     EMVICOM4
          STRIP     EMVICOM5
          STRIP     EMVICOM6
.
          PACK      DIM300,EMVICOM1,SP1,EMVICOM2,SP1,EMVICOM3,SP1,EMVICOM4:
                           SP1,EMVICOM5,SP1,EMVICOM6
          STRIP     DIM300
.
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          IF        EMVISTAT=1
            MOVE      SP70,DIM19B
          ELSE
            PACK      DIM19B,DIM10B,SP1,EMVIDTIM
          ENDIF
          STRIP     DIM19B
.         
          PACK      DIM19C,DIM10C,SP1,DIM8C
          STRIP     DIM19C
.
          PACK      OBJECTTX,ONE,TILDA:                * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA:           * EVENT_SOURCE_ID 
                             VISITNUM,TILDA:           * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:                * EVENT_RECORD_ID 
                             TILDA:                    * ALT_ENCOUNTER_ID 
                             DIM10A,SP1,EMVITIME,TILDA:  * START_DATETIME 
                             DIM19B,TILDA:             * END_DATETIME 
                             ZERO,ONE,TILDA:           * MODEL_OF_CARE_CODE 
                             DIM2,TILDA:               * MODE_OF_ARRIVAL_CODE 
                             DIM10A,SP1,EMVITIME,TILDA:  * ARRIVAL_DATETIME 
                             DIM19B,TILDA:             * DEPARTURE_DATETIM 
                             DIM15,TILDA:              * AMBULANCE_INCIDENT_ID 
                             DIM19C:
                             TILDA:     * AMBULANCE_INCIDENT_CREATE_DATETIME
                             EMPLOYMS,TILDA:     * START_EMPLOY_STATUS_CODE
                             TILDA:   * REQUEST_FOR_SERVICE_SOURCE_ID 
                             TILDA:   * REQUEST_FOR_SERVICE_RECORD_ID 
                             DIM3,TILDA:   * ED_TRIAGE_CODE 
                             DIM2A,TILDA:      * ED_VISIT_TYPE_CODE
                             DIM300,TILDA:   * ED_TRIAGE_COMMENTS 
                             DIM5,TILDA:       * ED_SEPARATION_MODE_CODE 
                             DIM8A,TILDA:      * ED_DEPARTURE_DESTINATION_CODE 
                             DIM5A,TILDA:      * CAUSE_INTENT_CODE
                             TILDA:      * ALCOHOL_ILLICIT_DRUG_RELATED_CODE 
                             TILDA:      * MENTAL_HEALTH_RELATED_CODE
                             DIM5B:            * EVENT_REQUEST_SOURCE_TYPE_CODE 
                             SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          IF        SDATFLAG=2
            PACK      SRMDDATE,EMCHDATE,SP70 * Change audit trigger
            PACK      SRMDTIME,EMCHTIME,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDKK9999  RETURN
+
.******************************************************************************
.* EDLL0000 - 130 SERVICE_EVENT_TRANSFER
.******************************************************************************
EDLL0000  PACK      KEY5,CATEM,EMVIUC21,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EDLL0500
.
          MATCH     "1",TCINDC3               * NOT From another hospital
          IF        !@EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "130",DELETOBJ          * SERVICE_EVENT_TRANSFER
            CALL      EDDL0000                * Delete
          ENDIF
.
EDLL0500  PACK      KEY5,ANSE,ANSD,EMVIDSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EDLL1000
.
          MOVE      ZERO,F2
          UNPACK    THCSCOD,KEY2       * First 2 characters of HDP
          SQUEEZE   KEY2
          MOVE      KEY2,F2
.
          IF        F2 <> 4 & F2 <> 17 & F2 <> 19 & F2<>20 & F2 <> 21
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "130",DELETOBJ          * SERVICE_EVENT_TRANSFER
            CALL      EDDL0000                * Delete
          ENDIF
.
EDLL1000  PACK      KEY5,CATEM,EMVIUC21,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EDLL5000
.
          MATCH     "1",TCINDC3                  * From another hospital
          GOTO      EDLL5000 IF NOT EQUAL
.
          UNPACK    PTCDUDF3,DIM5                * User defined 3
.
          MOVE      "9475-001",DIM8
.
          PACK      KEY5,EMVITSRC,SP70
          CALL      RDPTVAD1 
          IF        OVRCD=1
            MOVE      SP70,PTVAESTB
          ENDIF
.
          MATCH     SP70,PTVAESTB                * Don't report if blank
          GOTO      EDLL5000 IF EQUAL
.
          MOVE      "130",OBJECTTY               * SERVICE_EVENT_TRANSFER
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,ONE,SP70,SP70
.
          SQUEEZE   PTVAESTB
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM5
.
          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE 
                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID 
                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID 
                             ONE,TILDA:           * EVENT_RECORD_ID 
                             ONE,TILDA:           * EVENT_TRANSFER_TYPE_CODE 
                             DIM5,TILDA:          * TRANSFER_REASON_CODE
                             ONE,ZERO,ZERO,TILDA: * TRANSFER_OSP_ID_TYPE_CODE 
                             DIM8,TILDA:          * TRANSFER_OSP_SOURCE_ID 
                             PTVAESTB:            * TRANSFER_OSP_ID 
                             SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDLL5000  PACK      KEY5,ANSE,ANSD,EMVIDSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EDLL9999
.
          MOVE      ZERO,F2 
          UNPACK    THCSCOD,KEY2       * First 2 characters of HDP
          SQUEEZE   KEY2
          MOVE      KEY2,F2
.
          IF        F2 <> 4 & F2 <> 17 & F2 <> 19 & F2<>20 & F2 <> 21
            GOTO      EDLL9999
          ENDIF
.
          MOVE      SP70,DIM5
          PACK      KEY5,CATED,EMVIUC12,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK   PTCDASC1,DIM5
          ENDIF
.
          MOVE      "9475-001",DIM8
.
          PACK      KEY5,EMVIDEST,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            MOVE      SP70,PTVAESTB
          ENDIF
.
          MATCH     SP70,PTVAESTB                * Don't report if blank
          GOTO      EDLL9999 IF EQUAL
.
          MOVE      "130",OBJECTTY               * SERVICE_EVENT_TRANSFER
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,TWO,SP70,SP70
.
          SQUEEZE   DIM5
          STRIP     PTVAESTB
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:           * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA:      * EVENT_SOURCE_ID
                             VISITNUM,TILDA:      * ENCOUNTER_RECORD_ID
                             ONE,TILDA:           * EVENT_RECORD_ID
                             TWO,TILDA:           * EVENT_TRANSFER_TYPE_CODE
                             DIM5,TILDA:          * TRANSFER_REASON_CODE
                             ONE,ZERO,ZERO,TILDA: * TRANSFER_OSP_ID_TYPE_CODE
                             DIM8,TILDA:          * TRANSFER_OSP_SOURCE_ID
                             PTVAESTB:            * TRANSFER_OSP_ID
                             SP900
.
          PACK      SRCRDATE,EMVIDDAT,SP70
          PACK      SRCRTIME,EMVIDTIM,SP70
.
          PACK      SRMDDATE,EMVIDDAT,SP70 * Add trigger
          PACK      SRMDTIME,EMVIDTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDLL9999  RETURN
+
.******************************************************************************
.* EDMM0000 - 141 SERVICE_EVENT_SUB_EVENT
.* 01 Emergency Department triage
.* 02 Emergency Department re-triage 
.* 03 Emergency Department transfer of care / off stretcher time 
.* 04 Emergency Department nurse protocol 
.* 05 Emergency Department nurse practitioner seen 
.* 06 Emergency Department doctor seen 
.* 07 Emergency Department physician seen 
.* 08 Mental Health Psychiatric Emergency Care Centre consult 
.* 09 Emergency Department mental health nurse seen 
.* 10 Emergency Department departure ready 
.* 11 Emergency Department decision to formally admitted patient 
.* 12 Hospital ward bed requested 
.* 13 Hospital ward bed allocated Not available in Cerner FirstNet. 
.* 14 Emergency Department - Hospital bed ready 
.* 15 Emergency Department - Hospital ward ready 
.* 16 Hospital bed and ward readiness advised to Emergency Department
.* 17 Emergency Department - Referral to specialist made 
.* 18 Emergency Department - Diagnostic tests requested
.* 19 Emergency Department - Diagnostic results available 
.* 20 Emergency Department - Specialist review completed 
.* 98 Other sub event, not elsewhere classified
.******************************************************************************
EDMM0000  MATCH     SP70,EMVITRIG
          IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,ONE,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      EDDK0000
            GOTO      EDMM0500
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:  
                             ZERO,ONE,EMVITRIG,SP70,SP70  * Sub event - 01
.
          MOVE      EMVITRDT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          MOVE      EMVITRNS,DIM10B          * Triage nurse
.
          MOVE      EMVITRIG,DIM3
          SQUEEZE   DIM3
          SQUEEZE   DIM10A
          SQUEEZE   DIM10B
          SQUEEZE   EMVITRTM
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ZERO,ONE,DIM3:
                        TILDA:                   * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,ONE,TILDA:          * SUB_EVENT_TYPE_CODE
                        DIM3,TILDA:          * SUB_EVENT_TYPE_LOCAL_CODE  
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE 
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE 
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID    
                        DIM10B,TILDA:            * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVITRTM:     * SUB_EVENT_EFFECTIVE_DATETIME 
                        SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM0500  PACK      KEY24,DEMVIADM,STRTDATE,SP70
          CALL      RSEMCHA1
EDMM1000  CALL      RKEMCHA1                * Read change audit
          BRANCH    OVRCD,EDMM1100
.
          MATCH     DEMVIADM,EMCHVISN       * Correct ED visit
          GOTO      EDMM1100 IF NOT EQUAL
.
          MATCH     EMCHDATE,ENDDATE        * End date
          GOTO      EDMM1100 IF LESS
.
          MATCH     "03",EMCHUPTY           * Traige category change
          GOTO      EDMM1000 IF NOT EQUAL
.
          MATCH     SP70,EMCHOVAL
          IF        @EQUAL
            MATCH     SP70,EMCHCVAL
            GOTO      EDMM1000 IF EQUAL
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                         ZERO,TWO,EMCHOVAL,EMCHCVAL,SP70,SP70  * Sub event - 02
.
          MOVE      EMCHDATE,DATFIELD            * CCYYMMDD
          CALL      FMTD0000                     * Format date
          MOVE      FORMATDT,DIM10A              * CCYY-MM-DD
          MOVE      EMCHTIME,DIM8A

          PACK      DIM19A,DIM10A,SP1,DIM8A
          STRIP     DIM19A
.
          MOVE      EMVITRNS,DIM10B          * Triage nurse
.
          SQUEEZE   EMCHOVAL
          SQUEEZE   EMCHCVAL
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM10B
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ZERO,TWO,EMCHOVAL:
                        EMCHCVAL,TILDA:          * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,TWO,TILDA:          * SUB_EVENT_TYPE_CODE
                        TILDA:                   * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        DIM10B,TILDA:            * SUB_EVENT_ISP_ID
                        DIM19A,SP900             * SUB_EVENT_EFFECTIVE_DATETIME
.
          PACK      SRCRDATE,EMCHDATE,SP70
          PACK      SRCRTIME,EMCHTIME,SP70
.
          PACK      SRMDDATE,EMCHDATE,SP70 * Add trigger
          PACK      SRMDTIME,EMCHTIME,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDMM1000
.
EDMM1100  MATCH     SP70,EMVIAHDT
          IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,THREE,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      EDDK0000
            GOTO      EDMM1200
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                         ZERO,THREE,SP70,SP70             * Sub event - 03
.
          MOVE      EMVIAHDT,DATFIELD            * CCYYMMDD
          CALL      FMTD0000                     * Format date
          MOVE      FORMATDT,DIM10B              * CCYY-MM-DD
          MOVE      EMVIAHTM,DIM8B

          PACK      DIM19B,DIM10B,SP1,DIM8B
          STRIP     DIM19B
.
          MOVE      EMVIAHDT,DIM8
          MOVE      EMVIAHTM,DIM8A
          SQUEEZE   DIM8
          SQUEEZE   DIM8A
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        VISITNUM:
                        ZERO,THREE:
                        TILDA:                   * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,THREE,TILDA:        * SUB_EVENT_TYPE_CODE
                        DIM8,DIM8A,TILDA:        * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        TILDA:                   * SUB_EVENT_ISP_ID_TYPE_CODE
                        TILDA:                   * SUB_EVENT_ISP_SOURCE_ID
                        TILDA:                   * SUB_EVENT_ISP_ID
                        DIM19B,SP900             * SUB_EVENT_EFFECTIVE_DATETIME
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM1200  MOVE      "18 ",DELETSTM          * 18=Emergency Department
          MOVE      "141",DELETOBJ          * SERVICE_EVENT_SUB_EVENT
          PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                           ZERO,FOUR,SP70,SP70          * Delete Key
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          MATCH     SP70,EMVIMDCD           * Initial Assessor
          IF        @EQUAL
            CALL      EDDK0000              * Delete all records
            GOTO      EDMM1900
          ELSE
            CALL      DLOF0000              * Delete last sent record
          ENDIF
.
          UNPACK    EMVIMDTM,DIM2,D1,DIM2A,D1,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,FOUR,EMVIMDCD,DIM8,SP70,SP70  * Sub event - 04
.
          MOVE      EMVIMDDT,DATFIELD            * CCYYMMDD
          CALL      FMTD0000                     * Format date
          MOVE      FORMATDT,DIM10A              * CCYY-MM-DD
          MOVE      EMVIMDTM,DIM8A
.
          UNPACK    EMVIMDDT,D4,DATEDIM4              * MMDD
          UNPACK    EMVIMDTM,DIM2,D1,DIM2A,D1,DIM2B
          PACK      TIMEDIM6,DIM2,DIM2A,DIM2B,SP70    * HHMMSS
          SQUEEZE   DATEDIM4
          SQUEEZE   TIMEDIM6
.
          PACK      DIM19A,DIM10A,SP1,DIM8A
          STRIP     DIM19A
.
          MOVE      EMVIMDCD,DIM10
          SQUEEZE   DIM10
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        DIM10:
                        DATEDIM4,TIMEDIM6,TILDA: * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,FOUR,TILDA:         * SUB_EVENT_TYPE_CODE
                        DIM10,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
                        THREE,TILDA:             * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        DIM10,TILDA:             * SUB_EVENT_ISP_ID
                        DIM19A,SP900             * SUB_EVENT_EFFECTIVE_DATETIME
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
....EDMM1300  MOVE      SP70,DIM10
....          PACK      KEY22,DEMVIADM,SP70
....          CALL      RSEMHIS1
....EDMM1400  CALL      RKEMHIS1                     * Read EMR history to get
....          BRANCH    OVRCD,EDMM1900               * locations
.....
....          MATCH     DEMVIADM,EMHIVIS             * same visit
....          GOTO      EDMM1900 IF NOT EQUAL
.....
....          MATCH     DIM10,EMHINUR                * Change in Nurse code
....          GOTO      EDMM1400 IF EQUAL
.....
....          MOVE      EMHINUR,DIM10
....          UNPACK    EMHINST,DIM2,DIM2A,DIM2B
....          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.....
....          UNPACK    EMHINSD,D2,DATEDIM6      * YYMMDD
....          MOVE      EMHINST,TIMEDIM4         * HHMM
....          SQUEEZE   DATEDIM6
....          SQUEEZE   TIMEDIM4
.....
....          MATCH     SP70,EMHINUR
....          GOTO      EDMM1400 IF EQUAL
.....
....          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
....          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
....                             ZERO,FOUR,EMHINUR:
....                             EMHINSD,DIM8,SP70,SP70  * Sub event - 04
.....
....          MOVE      EMHINSD,DATFIELD        * CCYYMMDD
....          CALL      FMTD0000                 * Format date
....          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.....
....          SQUEEZE   EMHINSD 
....          SQUEEZE   EMHINST
....          SQUEEZE   EMHINUR 
....          SQUEEZE   DIM10A
....          SQUEEZE   DIM8
....          MOVE      DEMVIADM,VISITNUM
....          SQUEEZE   VISITNUM
.....
....          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
....                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
....                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
....                        ONE,TILDA:               * EVENT_RECORD_ID
....                        ZERO,FOUR,EMHINUR:
....                        DATEDIM6,TIMEDIM4,TILDA: * EVENT_SUB_EVENT_RECORD_ID
....                        ZERO,FOUR,TILDA:         * SUB_EVENT_TYPE_CODE
....                        EMHINUR,TILDA:           * SUB_EVENT_TYPE_LOCAL_CODE
....                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
....                        ZERO,THREE,FIVE,TILDA:  * SUB_EVENT_ISP_ID_TYPE_CODE
....                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
....                        EMHINUR,TILDA:           * SUB_EVENT_ISP_ID
....                        DIM10A,SP1,DIM8:     * SUB_EVENT_EFFECTIVE_DATETIME
....                        SP900
.....
....          PACK      SRCRDATE,EMHIDAT,SP70
....          UNPACK    EMHITIM,DHOUR,MIN,SEC
....          PACK      SRCRTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.....
....          PACK      SRMDDATE,EMHIDAT,SP70 * Add trigger
....          UNPACK    EMHITIM,DHOUR,MIN,SEC
....          PACK      SRMDTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.....
....          IF        SDATFLAG=1
....            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alt. trigger
....            PACK      SRMDTIME,PMAWCTIM,SP70
....          ENDIF
.....
....          CALL      WRCOND00     * write record to container detail table
....          GOTO      EDMM1400
.
EDMM1900  MOVE      SP70,DIM10
          PACK      KEY22,DEMVIADM,SP70
          CALL      RSEMHIS1
EDMM2000  CALL      RKEMHIS1                     * Read EMR history to get
          BRANCH    OVRCD,EDMM2200               * locations
.
          MATCH     DEMVIADM,EMHIVIS             * same visit
          GOTO      EDMM2200 IF NOT EQUAL
.
          MATCH     DIM10,EMHIDOC                * Change in DR code
          GOTO      EDMM2000 IF EQUAL
.
          MOVE      EMHIDOC,DIM10
          UNPACK    EMHIDST,DIM2,DIM2A,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          UNPACK    EMHIDSD,D2,DATEDIM6      * YYMMDD
          MOVE      EMHIDST,TIMEDIM4         * HHMM
          SQUEEZE   DATEDIM6
          SQUEEZE   TIMEDIM4
.
          MATCH     SP70,EMHIDOC
          GOTO      EDMM2000 IF EQUAL
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,SIX,EMHIDOC,EMHIDSD,DIM8:
                             SP70,SP70  * Sub event - 06
.
          MOVE      EMHIDSD,DATFIELD         * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          SQUEEZE   EMHIDSD
          SQUEEZE   EMHIDST
          SQUEEZE   EMHIDOC
          SQUEEZE   DIM10A
          SQUEEZE   DIM8
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ZERO,SIX,EMHIDOC:
                        DATEDIM6,TIMEDIM4,TILDA: * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,SIX,TILDA:          * SUB_EVENT_TYPE_CODE
                        EMHIDOC,TILDA:           * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        EMHIDOC,TILDA:           * SUB_EVENT_ISP_ID
                        DIM10A,SP1,DIM8:         * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,EMHIDAT,SP70
          UNPACK    EMHITIM,DHOUR,MIN,SEC
          PACK      SRCRTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.
          PACK      SRMDDATE,EMHIDAT,SP70 * Add trigger
          UNPACK    EMHITIM,DHOUR,MIN,SEC
          PACK      SRMDTIME,DHOUR,COLON,MIN,COLON,SEC,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      EDMM2000
.
EDMM2200  MATCH     SP70,EMVIMPRA
          IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,EIGHT,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      EDDK0000
            GOTO      EDMM2300
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,EIGHT,EMVIMPRA:
                             EMVIMPDT,EMVIMPTM,SP70,SP70  * Sub event - 08
.
          SQUEEZE   EMVIMPRA
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          MOVE      EMVIMPDT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          PACK      KEY16,EMVIMPDT,EMVIMPTM,SP70
          REP       ": ",KEY16
          SQUEEZE   KEY16
.
          UNPACK    KEY16,D2,DATEDIM6,TIMEDIM4      * YYMMDDHHMM
          SQUEEZE   DATEDIM6
          SQUEEZE   TIMEDIM4
.
          SQUEEZE   DIM10A
          SQUEEZE   EMVIMPRA
          SQUEEZE   EMVIMPDT
          SQUEEZE   EMVIMPTM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ZERO,EIGHT,EMVIMPRA:
                        DATEDIM6,TIMEDIM4,TILDA: * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,EIGHT,TILDA:        * SUB_EVENT_TYPE_CODE
                        EMVIMPRA,TILDA:          * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        EMVIMPRA,TILDA:          * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVIMPTM:     * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,EMVIMPDT,SP70
          PACK      SRCRTIME,EMVIMPTM,SP70
.
          PACK      SRMDDATE,EMVIMPDT,SP70 * Add trigger
          PACK      SRMDTIME,EMVIMPTM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM2300  MATCH     SP70,EMVIMPRA
          IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,NINE,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      EDDK0000
            GOTO      EDMM2400
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ZERO,NINE,EMVIMPRA,SP70,SP70  * Sub event - 09
.
          SQUEEZE   EMVIMPRA
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
.
          MOVE      EMVIMPDT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          SQUEEZE   DIM10A
          SQUEEZE   EMVIMPRA
          SQUEEZE   EMVIMPTM
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ZERO,NINE,EMVIMPRA:
                        TILDA:                   * EVENT_SUB_EVENT_RECORD_ID
                        ZERO,NINE,TILDA:         * SUB_EVENT_TYPE_CODE
                        EMVIMPRA,TILDA:          * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        EMVIMPRA,TILDA:          * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVIMPTM:     * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,EMVIMPDT,SP70
          PACK      SRCRTIME,EMVIMPTM,SP70
.
          PACK      SRMDDATE,EMVIMPDT,SP70 * Add trigger
          PACK      SRMDTIME,EMVIMPTM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM2400  
.....     MATCH     SP70,EMVIUD01
.....     IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             TEN,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      EDDK0000
....        GOTO      EDMM2500
....      ENDIF
.
          MATCH     SP70,EMVIUD01            * No ready to depart date to report
          GOTO      EDMM2500 IF EQUAL
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                         TEN,EMVIUD01,EMVIUT01,SP70,SP70  * Sub event - 10
.
          MOVE      EMVIUD01,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          PACK      DIM16,EMVIUD01,EMVIUT01,SP70
.
          MOVE      EMVIUD01,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10B          * CCYY-MM-DD
          MOVE      EMVIUT01,DIM8B
.
          SQUEEZE   DIM10A
          SQUEEZE   EMVIUT01
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM16
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        TEN,DIM10A,TILDA:        * EVENT_SUB_EVENT_RECORD_ID
                        TEN,TILDA:               * SUB_EVENT_TYPE_CODE
                        DIM16,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        TILDA:                   * SUB_EVENT_ISP_ID_TYPE_CODE
                        TILDA:                   * SUB_EVENT_ISP_SOURCE_ID
                        TILDA:                   * SUB_EVENT_ISP_ID
                        DIM10B,SP1,DIM8B:        * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM2500  MATCH     SP70,EMVIDADT
          IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ONE,ONE,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      DLOF0000                   * Delete last sent object
            GOTO      EDMM2600
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                         ONE,ONE,EMVIDADT,EMVIDATM,SP70,SP70  * Sub event - 11
.
          MOVE      EMVIDADT,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          PACK      DIM16,EMVIDADT,EMVIDATM,SP70
.
          SQUEEZE   DIM10A
          SQUEEZE   EMVIDATM
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   EMVIDATM
          SQUEEZE   DIM16
.
          MOVE      SP70,DIM10F
          MATCH     SP70,EMVIUR01
          IF        @EQUAL
            MOVE      EMVIDOCT,DIM10F
          ELSE
            MOVE      EMVIUR01,DIM10F
          ENDIF
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ONE,ONE,DIM10A,TILDA:    * EVENT_SUB_EVENT_RECORD_ID
                        ONE,ONE,TILDA:           * SUB_EVENT_TYPE_CODE
                        DIM16,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        ZERO,THREE,FIVE,TILDA:   * SUB_EVENT_ISP_ID_TYPE_CODE
                        PTCNNSSI,TILDA:          * SUB_EVENT_ISP_SOURCE_ID
                        DIM10F,TILDA:            * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVIDATM:     * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM2600  PACK      KEY24,DEMVIADM,Z70
          CALL      RSPMBRQ1
EDMM2900  CALL      RPPMBRQ1                     * Get last bed request
          BRANCH    OVRCD,EDMM3000
.
          MATCH     DEMVIADM,PMBRVISN            * Correct visit
          GOTO      EDMM3000 IF NOT EQUAL
.
          MATCH     "4",PMBRRSTA                 * Skip cancelled
          GOTO      EDMM2900 IF EQUAL
.
          MOVE      PMBRREQD,EMVIUD03            * Ward request date
          MOVE      PMBRREQT,EMVIUT03            * Ward request time
.
          MOVE      PMBRADAT,EMVIUD04            * Ward allocated date
          MOVE      PMBRATIM,EMVIUT04            * Ward allocated time
.
          MOVE      PMBRRDAT,EMVIUD05            * Ward ready date
          MOVE      PMBRRTIM,EMVIUT05            * Ward ready time
.
EDMM3000  MATCH     SP70,EMVIUD03
          IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ONE,TWO,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      EDDK0000
            GOTO      EDMM3100
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                         ONE,TWO,EMVIUD03,EMVIUT03,SP70,SP70  * Sub event - 12
.
          MOVE      EMVIUD03,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          PACK      DIM16,EMVIUD03,EMVIUT03,SP70
.
          SQUEEZE   EMVIUD03
          SQUEEZE   EMVIUT03
          SQUEEZE   DIM10A
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM16
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ONE,TWO,EMVIUD03,TILDA:  * EVENT_SUB_EVENT_RECORD_ID
                        ONE,TWO,TILDA:           * SUB_EVENT_TYPE_CODE
                        DIM16,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
                        THREE,TILDA:              * SUB_EVENT_STATUS_CODE
                        TILDA:                   * SUB_EVENT_ISP_ID_TYPE_CODE
                        TILDA:                   * SUB_EVENT_ISP_SOURCE_ID
                        TILDA:                   * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVIUT03:     * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM3100  MATCH     SP70,EMVIUD04
          IF        @EQUAL
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
            PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
                             ONE,THREE,SP70,SP70          * Delete Key
            PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
            PACK      SRMDTIME,PMVXCTIM,SP70
.
            IF        SDATFLAG=1
              PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
              PACK      SRMDTIME,PMAWCTIM,SP70
            ENDIF
            CALL      EDDK0000
            GOTO      EDMM3200
          ENDIF
.
          MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
          PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
                         ONE,THREE,EMVIUD04,EMVIUT04,SP70,SP70 * Sub event - 13
.
          MOVE      EMVIUD04,DATFIELD        * CCYYMMDD
          CALL      FMTD0000                 * Format date
          MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
.
          PACK      DIM16,EMVIUD04,EMVIUT04,SP70
.
          SQUEEZE   EMVIUD04
          SQUEEZE   EMVIUT04
          SQUEEZE   DIM10A
          MOVE      DEMVIADM,VISITNUM
          SQUEEZE   VISITNUM
          SQUEEZE   DIM16
.
          PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
                        PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
                        VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
                        ONE,TILDA:               * EVENT_RECORD_ID
                        ONE,THREE,EMVIUD04,TILDA: * EVENT_SUB_EVENT_RECORD_ID
                        ONE,THREE,TILDA:    * SUB_EVENT_TYPE_CODE
                        DIM16,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
                        ONE,TILDA:               * SUB_EVENT_STATUS_CODE
                        TILDA:                   * SUB_EVENT_ISP_ID_TYPE_CODE
                        TILDA:                   * SUB_EVENT_ISP_SOURCE_ID
                        TILDA:                   * SUB_EVENT_ISP_ID
                        DIM10A,SP1,EMVIUT04:     * SUB_EVENT_EFFECTIVE_DATETIME
                        SP900 
.
          PACK      SRCRDATE,PMVXCDTE,SP70
          PACK      SRCRTIME,PMVXCTIM,SP70
.
          PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
          PACK      SRMDTIME,PMVXCTIM,SP70
.
          IF        SDATFLAG=1
            PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
            PACK      SRMDTIME,PMAWCTIM,SP70
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
.
EDMM3200  
....      MATCH     SP70,EMVIUD05
....      IF        @EQUAL
....        MOVE      "18 ",DELETSTM          * 18=Emergency Department
....        MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
....        PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
....                         ONE,FOUR,SP70,SP70          * Delete Key
....        PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
....        PACK      SRMDTIME,PMVXCTIM,SP70
....
....        IF        SDATFLAG=1
....          PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
....          PACK      SRMDTIME,PMAWCTIM,SP70
....        ENDIF
....        CALL      EDDK0000
....        GOTO      EDMM3300
....      ENDIF
....
....      MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
....      PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
....                     ONE,FOUR,EMVIUD05,EMVIUT05,SP70,SP70 * Sub event - 14
....
....      MOVE      EMVIUD05,DATFIELD        * CCYYMMDD
....      CALL      FMTD0000                 * Format date
....      MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
....
....      PACK      DIM16,EMVIUD05,EMVIUT05,SP70
....
....      SQUEEZE   EMVIUD05
....      SQUEEZE   EMVIUT05
....      SQUEEZE   DIM10A
....      MOVE      DEMVIADM,VISITNUM
....      SQUEEZE   VISITNUM
....      SQUEEZE   DIM16
....
....      PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
....                    PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
....                    VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
....                    ONE,TILDA:               * EVENT_RECORD_ID
....                    ONE,FOUR,EMVIUD05,TILDA: * EVENT_SUB_EVENT_RECORD_ID
....                    ONE,FOUR,TILDA:          * SUB_EVENT_TYPE_CODE
....                    DIM16,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
....                    ONE,TILDA:               * SUB_EVENT_STATUS_CODE
....                    TILDA:                   * SUB_EVENT_ISP_ID_TYPE_CODE
....                    TILDA:                   * SUB_EVENT_ISP_SOURCE_ID
....                    TILDA:                   * SUB_EVENT_ISP_ID
....                    DIM10A,SP1,EMVIUT05:     * SUB_EVENT_EFFECTIVE_DATETIME
....                    SP900
....
....      PACK      SRCRDATE,PMVXCDTE,SP70
....      PACK      SRCRTIME,PMVXCTIM,SP70
....
....      PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
....      PACK      SRMDTIME,PMVXCTIM,SP70
....
....      IF        SDATFLAG=1
....        PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
....        PACK      SRMDTIME,PMAWCTIM,SP70
....      ENDIF
....
....      CALL      WRCOND00     * write record to container detail table
....
....EDMM3300  MATCH     SP70,EMVIUD05
....      IF        @EQUAL
....        MOVE      "18 ",DELETSTM          * 18=Emergency Department
....        MOVE      "141",DELETOBJ          * SERVICE_EVENT_DELAY
....        PACK      DELETKEY,DEMVIADM,ONE,ONE,DEMVIADM:
....                         ONE,FIVE,SP70,SP70          * Delete Key
....        PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
....        PACK      SRMDTIME,PMVXCTIM,SP70
....
....        IF        SDATFLAG=1
....          PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
....          PACK      SRMDTIME,PMAWCTIM,SP70
....        ENDIF
....        CALL      EDDK0000
....        GOTO      EDMM9999
....      ENDIF
....
....      MOVE      "141",OBJECTTY               * SERVICE_EVENT_SUB_EVENT
....      PACK      OBJECTKY,DEMVIADM,ONE,ONE,DEMVIADM:
....                     ONE,FIVE,EMVIUD05,EMVIUT05,SP70,SP70 * Sub event - 15
....
....      PACK      EMVIUD05,EMVIUD05,SP70
....      PACK      EMVIUT05,EMVIUT05,SP70
....
....      MOVE      EMVIUD05,DATFIELD        * CCYYMMDD
....      CALL      FMTD0000                 * Format date
....      MOVE      FORMATDT,DIM10A          * CCYY-MM-DD
....
....      PACK      DIM16,EMVIUD05,EMVIUT05,SP70
....
....      SQUEEZE   EMVIUD05
....      SQUEEZE   EMVIUT05
....      SQUEEZE   DIM10A
....      MOVE      DEMVIADM,VISITNUM
....      SQUEEZE   VISITNUM
....      SQUEEZE   DIM16
....
....      PACK      OBJECTTX,ONE,TILDA:          * EVENT_TYPE_CODE
....                    PTCNNSSI,TILDA:          * EVENT_SOURCE_ID
....                    VISITNUM,TILDA:          * ENCOUNTER_RECORD_ID
....                    ONE,TILDA:               * EVENT_RECORD_ID
....                    ONE,FIVE,EMVIUD05,TILDA: * EVENT_SUB_EVENT_RECORD_ID
....                    ONE,FIVE,TILDA:          * SUB_EVENT_TYPE_CODE
....                    DIM16,TILDA:             * SUB_EVENT_TYPE_LOCAL_CODE
....                    ONE,TILDA:               * SUB_EVENT_STATUS_CODE
....                    TILDA:                   * SUB_EVENT_ISP_ID_TYPE_CODE
....                    TILDA:                   * SUB_EVENT_ISP_SOURCE_ID
....                    TILDA:                   * SUB_EVENT_ISP_ID
....                    DIM10A,SP1,EMVIUT05:     * SUB_EVENT_EFFECTIVE_DATETIME
....                    SP900
....
....      PACK      SRCRDATE,PMVXCDTE,SP70
....      PACK      SRCRTIME,PMVXCTIM,SP70
....
....      PACK      SRMDDATE,PMVXCDTE,SP70 * Add trigger
....      PACK      SRMDTIME,PMVXCTIM,SP70
....
....      IF        SDATFLAG=1
....        PACK      SRMDDATE,PMAWCDAT,SP70 * Edward visit alteration trigger
....        PACK      SRMDTIME,PMAWCTIM,SP70
....      ENDIF
....
....      CALL      WRCOND00     * write record to container detail table
....
EDMM9999  RETURN
+
.******************************************************************************
.* EALT0000 - Loop pmsadwaf by creation date and find emergency visits
.*            that have been updated after the created date to report
.******************************************************************************
EALT0000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
EALT1000  CALL      RKPMADW1                * Loop visit alterations file
          BRANCH    OVRCD,EALT9999
.
          MATCH     PMAWCDAT,ENDDATE        * Date created
          GOTO      EALT9999 IF LESS
.
          MATCH     "4 ",PMAWTYPE            * ED Visit Update
          GOTO      EALT2000 IF EQUAL
.
          MATCH     "13",PMAWTYPE            * ED Doctor Delete
          GOTO      EALT2000 IF EQUAL
.
          MATCH     "20",PMAWTYPE            * ED Presenting complaint update
          GOTO      EALT2000 IF EQUAL
.
          GOTO      EALT1000
.
EALT2000  PACK      KEY8,PMAWVISN,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EALT1000
.
          COMPARE   ONE,PVITYPE             * EMR visits only
          GOTO      EALT1000 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11                * Read visit extn
          BRANCH    OVRCD,EALT1000
.
          MATCH     PMVXCDTE,PMAWCDAT       * Skip if altered on the date
          GOTO      EALT1000 IF EQUAL       * ED visit created
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1                * Read ED visit
          BRANCH    OVRCD,EALT1000
.
          PACK      KEY5,ANSC,ANSL,EMVICOMP,SP70      * Read claim code
          CALL      RDCODE1
          BRANCH    OVRCD,EALT1000
.
          CALL      EDVS0000                * Get ED visit details
          BRANCH    EXIT,EALT1000
.
          MOVE      ONE,SDATFLAG           * Edward visit alteration trigger
.
          COMPARE   FOUR,EMVISTAT           * Skip cancelled ED visits
          IF        @EQUAL
            CALL      EDAL0000                * Delete all ED objects
            GOTO      EALT1000
          ENDIF
.
          MATCH     "13",PMAWTYPE          * ED Doctor Delete
          IF        @EQUAL  
            MOVE      "18 ",DELETSTM          * 18=Emergency Department
            MOVE      "63 ",DELETOBJ          * SERVICE_EVENT_DELAY
            UNPACK    PMAWOLDV,DIM10,PMAWOLDV
            PACK      DELETKEY,DEMVIADM,ONE,ONE,EMVIADMN,ONE:
                             DEMVIADM,DIM10,SP70,SP70
            PACK      SRMDDATE,PMAWCDAT,SP70  * Set the source modified date
            PACK      SRMDTIME,PMAWCTIM,SP70  * to the trigger date
            CALL      EDDK0000
            GOTO      EALT1000
          ENDIF
.
          MATCH     "20",PMAWTYPE          * ED Presenting Complaint Update
          IF        @EQUAL  
            PACK      SRMDDATE,PMAWCDAT,SP70  * Set the source modified date
            PACK      SRMDTIME,PMAWCTIM,SP70  * to the trigger date
            CALL      EDPR0000
            GOTO      EALT1000
          ENDIF
.
          CALL      EDAA0000      * 57  CLIENT_SERVICE_EVENT
          CALL      EDBB0000      * 64  ONWARD_REFERRAL
          CALL      EDCC0000      * 115 SERVICE_EVENT_GENERAL_PRACTITIONER
          CALL      EDDD0000      * 137 SERVICE_EVENT_DELAY
          CALL      EDEE0000      * 142 SERVICE_EVENT_LOCATION
          CALL      EDUU0000      * 142 SERVICE_EVENT_LOCATION
....      CALL      EDFF0000      * 59  PRESENTING_ISSUE
          CALL      EDGG0000      * 56  SERVICE_ACTIVITY
          CALL      EDHH0000      * 60  SERVICE_EVENT_ATTRIBUTE
          CALL      EDII0000      * 61  DIAGNOSIS
          CALL      EDJJ0000      * 63  SERVICE_EVENT_PROVIDER
          CALL      EDKK0000      * 145 SERVICE_EVENT_AND_EMERGENCY_DEPARTMENT
          CALL      EDLL0000      * 130 SERVICE_EVENT_TRANSFER
          CALL      EDMM0000      * 141 SERVICE_EVENT_SUB_EVENT
.
          GOTO      EALT1000
.
EALT9999  RETURN
+
.******************************************************************************
.* EMRG0000 - Loop patmrgaf and pmsadwaf and process any ED visit PMI merges
.******************************************************************************
EMRG0000  PACK      KEY25,STRTDATE,SP70
          CALL      RSPTMRG3
EMRG1000  CALL      RKPTMRG3                * Loop merge file
          BRANCH    OVRCD,EMRG5000
.
          MATCH     PTMRRDTE,ENDDATE        * Date created
          GOTO      EMRG5000 IF LESS
.
          PACK      KEY26,PTMRNWUR,SP1,ONE,SP70
          CALL      RSPTVIS4                * Read visit file by U/R
EMRG2000  CALL      RDKVISA4
          BRANCH    OVRCD,EMRG1000
.
          MATCH     PTMRNWUR,PVIURNO        * Correct U/R
          GOTO      EMRG1000 IF NOT EQUAL
.
          MATCH     " 1",PTVITYPE           * EMR visits only
          GOTO      EMRG1000 IF NOT EQUAL
.
          MOVE      "18 ",CHANGSTM                     * 18=Emergency Department
          MOVE      "57 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "12",CHANGCOL                      * Change column
          MOVE      PTMROLUR,CHANGOVL                  * Change old U/R value
          MOVE      PTMRNWUR,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,PVIBILL,ONE,ONE,SP70,SP70  * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          GOTO      EMRG2000
.
EMRG5000  PACK      KEY27,STRTDATE,SP70
          CALL      RSPMADW1
EMRG6000  CALL      RKPMADW1                * Loop visit alterations file
          BRANCH    OVRCD,EMRG9999
.
          MATCH     PMAWCDAT,ENDDATE        * Date created
          GOTO      EMRG9999 IF LESS
.
          MATCH     "9 ",PMAWTYPE            * ED Visit Changed U/R
          GOTO      EMRG6000 IF NOT EQUAL
.
          MOVE      "18 ",CHANGSTM                     * 18=Emergency Department
          MOVE      "57 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "12",CHANGCOL                      * Change column number
          MOVE      PMAWOLDV,CHANGOVL                  * Change old U/R value
          MOVE      PMAWNEWV,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,PMAWVISN,ONE,ONE,SP70,SP70  * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          GOTO      EMRG6000
.
EMRG9999  RETURN
