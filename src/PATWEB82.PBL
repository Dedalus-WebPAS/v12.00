.----------------------------------------------------------------------
. Program       : PATWEB82
.
. Function      : Patient Death Processing
.
. Modifications : 
.
.----------------------------------------------------------------------
. V12.00.03 09/09/2025  Ebon Clements   TSK 0961969
.           Recompiled for PATDEATH - VINAH activate waiting referral
. V12.00.02 08/08/2025  Ebon Clements   TSK 0964891
.           Recompiled for PATDEATH - W/L ASA score - WESE0000
. V12.00.01 23/05/2025  Ebon Clements   TSK 0955096
.           Alphanueric visit number changes
. V11.05.01 18.03.2025  DA Sarkies      TSK 0955909 
.           Recompiled OPWEBCAN
. V11.04.02 03/10/2024  Nikitha B       TSK 0948566 
.           Recompiled for PATDEATH - Close referral for IT program
. V11.04.01 23/05/2024  Ebon Clements    TSK 0937739
.           Recompiled for PATDEATH - Close referral
.           Call IBACLOCK before processing each record - MAIN0200
. V11.03.03 24/10/2023  Nikitha B        TSK 0938566
.           Recompiled for PATDEATH  
. V11.03.02 10/08/2023  Nikitha B        TSK 0935669
.           Recompiled for PATDEATH  
. V11.03.01 28/07/2023  Ebon Clements    TSK 0935527
.           Recompiled for OPRQUEFD - Theatre booking hospital
. V11.02.01 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD changes
. V11.01.02 06/10/2021  Ebon Clements    TSK 0897124
.           Added nutrition update for current emergency visits - EMRNUT00
. V11.01.01 15/09/2021  Ebon Clements    TSK 0910709
.           Recompiled for PATDEATH - VINAH referral rejection reason
. V11.00.02 22/04/2020  Ebon Clements    TSK 0850105
.           Clear PMCUTSTA and PMCUTLOC before write to pmscuraf
. V11.00.01 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V10.15.01 26/11/2019  Ebon Clements    TSK 0882358
.           Changed nutrition record created/updated by user id to dxc.webPAS
. V10.14.01 30/08/2019  Davin            TSK 0880684
.           Recompiled for PATDEATH - broadcast HL7 remove from W/L (I14)
. V10.13.04 07/01/2019  Ebon Clements    TSK 0863959
.           Delete current patient file cancelled ED visits by arrival date
.           CHKEMR00
.           Fixed key pack for add all current ED visits to current patient file
.           ADDEMC00
. V10.13.03 24/08/2018  Steve Armstrong  TSK 0845563
.           Recompiled for changes to PATDEATH
. V10.13.02 31/07/2018  Thanh T          TSK 0845563
.           Recompiled for ALLAUDFD
. V10.13.01 31/07/2018  J.Tan            TSK 0857465
.           Fixed checking Private practice outstanding debt
.----------------------------------------------------------------------
. V10.12.02 02/07/2018  J.Tan            TSK 0857465
.           Fixed Private practice to check Payment plan debt
. V10.12.01 05/02/2018  Ebon Clements    TSK 0846913
.           Recompiled for PATDEATH - Date of original booking
.----------------------------------------------------------------------
. V10.11.01 27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
.----------------------------------------------------------------------
. V10.10.01 03/04/2017  Jill Parkinson TSK 0836338
.           Corrected loop to end of file in CHKDD600
.----------------------------------------------------------------------
. V10.08.02 12/09/2016  Steve Armstrong  TSK 0825587
.           Recompiled for changes to PATDEATH
. V10.08.01 18/07/2016  Jill Parkinson TSK 0822130
.           Recompiled for PATDEATH - preadmitted theatre cancellations
.----------------------------------------------------------------------
. V10.07.02 10/03/2016  Davin          CAR 0815319
.           Update patmi1af.ADIET with PMNUDIET for current patients (ADDNUT00)
. V10.07.01 16/12/2015  Davin            CAR 310749
.           Added extra diet details to nutrition update (upcat000/catcomaf)
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.----------------------------------------------------------------------
. V10.05.03 12/09/2014  Patrick Adair     CAR 241461
.           Recompiled for PATDEATH
. V10.05.02 03/09/2014  J.Tan             CAR 298984
.           Recompiled for PATDETFD
. V10.05.01 17/07/2014  Ebon Clements     CAR 251384
.           Recompiled for PATDEATH - Clear sub system key for ibapolaf write
. V10.04.02 10/04/2014  J.Tan             CAR 295681
.           Fixed Set Debt Collection Agency for PP
. V10.04.01 06/03/2014  J.Tan             CAR 295681
.           Added System to patdetaf file
. V10.03.13 28/10/2013  Patrick Adair    CAR 201234
.           Recompiled for PATDEATH (for changes to WLHISSUB)
. V10.03.12 15/10/2013  Davin            CAR 288638
.           Recompiled for PATDEATH
. V10.03.11 14/10/2013  Ania P           CAR 278232
.           Recompiled for PATDEATH
. V10.03.10 10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIFD.
. V10.03.09 18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
. V10.03.08 30/06/2013  Davin             CAR 279183
.           Recompiled for changes to hl7 messaging (allquefd)
. V10.03.07 15/04/2013  Steve Armstrong  CAR 267329
.           Recompiled for changes to PATDEATH
. V10.03.06 20/12/2012  Steve Armstrong  CAR 275865
.           Recompiled for changes to PATDEATH
. V10.03.05 05/10/2012  Davin          CAR 265550
.           Send A08 for each write to pmsnutaf (parameter based)
. V10.03.04 04/05/2012  J.Tan            CAR 262427
.           Fixed Patient only Debt
. V10.03.03 01/05/2012  J.Tan            CAR 264258
.           Fixed Patient only Debt
. V10.03.02 09/12/2011  Ebon Clements   CAR 246872
.           Recompiled for PATDEATH - Populate new fields in OUTCANFD
. V10.03.01 23/11/2011  J.Tan            CAR 255105
.           Fixed Private Practice outstanding debts
. V10.02.06 04/11/2011  Steve Armstrong  CAR 254751
.           Recompiled for changes to OPRQUEFD
. V10.02.05 15/09/2011  Ebon Clements     CAR 250141
.           Recompiled for PATDEATH - Cancel suspended OP Appointments
. V10.02.04 08/09/2011  Ebon Clements     CAR 242014
.           Recompiled for PATDEATH - Added clinic type to cancelled OP appt
. V10.02.03 03/08/2011  Steve Armstrong   CAR 247803
.           Fixed I*C on outartaf index 2
. V10.02.02 22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PMSCURFD:
.                - PMCUSURN & PMCUGNAM extended to 40 chars.
.                - PMCUGNM2 added.
. V10.02.01 05/05/2011  Mike Laming   CAR 240720
.           Added "Appointment Request Purge" (ARTPRG00) into CURPAT00 routine.
.           also recompiled for PATDEATH - see PATDEATH.OUTPT700
.----------------------------------------------------------------------
. V10.01.01 22/11/2010  Mike Laming   CAR 233229
.           Added 3 Debt Indicators and "patdetaf" to CHKDD200 &UPOSD000 
.           19/11/2010  Steve Armstrong   CAR 234061
.           Recompiled for changes to PMSNUTFD.
.           Changed CALL's to PMSNUTIO.
.----------------------------------------------------------------------
. V10.00.03 22/09/2010  Jill Parkinson CAR 222489
.           Added bookings to current patient file
. V10.00.02 24/05/2010  J.Tan         CAR 219470
.           Fixed calculating outstanding amount to include GST Journals
. V10.00.01  03/03/2010  Steve Armstrong  CAR 135505
.           Recompiled for PATDEATH - DGCLII13 added
.----------------------------------------------------------------------
. V9.12.05  09/02/2010  Ebon Clements CAR 215875
.           Recompiled for PATDEATH - program completion reason on all referrals
. V9.12.04  08/12/2009  Mike Laming   CAR 210835
.           Add PRIINVaf & logic to Outstanding Debt routine at CHKDD500
. V9.12.03  22/10/2009  Ebon Clements CAR 176783
.           Recompiled for PATDEATH - Referral link file delete
. V9.12.02  20/08/2009  Saroeun Soeur CAR 202831
.           added ADDEMC00 - add all emr patient
. V9.12.01  26/05/2009  Ebon Clements CAR 196248
.           Recompiled for PATDEATH - program completion reason SACS referral
.----------------------------------------------------------------------
. V9.11.01  08/01/2008  Ebon Clements CAR 174080
.           Recompiled for PATDEATH - Bed board updates
. V9.10.01  03/09/2008  Davin         CAR 147323
.           Recompiled for DGCLIS14 and DGCLIS15 (does not send messages though)
.----------------------------------------------------------------------
. V9.08.03  21/03/2007  J.Tan         CAR 120014
.           Mods to initialise FORM1 before loading O/S Debt ind.
. V9.08.02  21/02/2007  Mike Laming   CAR 119436
.           Add polling routine to update Outstanding Debt Ind.(see UPOSD000)
. V9.08.01  31/01/2007  Peter Vela    CAR 127930
.           Recompiled for EMRSITFD
.----------------------------------------------------------------------
. V9.06.02  18/05/2006  Ebon Clements CAR 105326
.           Fixed ADDINP40 discharged current patient hospital id
. V9.06.01  17/05/2006  Ebon Clements CAR 105326
.           Fixed visit extn file key in ADDINP00 should be KEY8 not KEY7
.----------------------------------------------------------------------
. V9.05.02  03/04/2006  Ebon Clements CAR 78527
.           Added hospital to current patients
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 20/02/2006  Ebon Clements CAR 76341  
.           Added encouter and referral file audits
. V9.05.B01 20/12/2005  Ebon Clements CAR 76341  
.           Key length changes for encounter number                
.----------------------------------------------------------------------
. V9.04.06  22/11/2005 Peter Vela    CAR 81907
.           Recompiled for PATDEATH - Update Patient Age at Death
. V9.04.05  26/09/2005 Ebon Clements CAR 56868    
.           Recompiled for PATDEATH - Web user id on death polling table
. V9.04.04  20/07/2005 Jill Habasque              
.           Recompiled for PATDEATH - Writes to wateseaf
. V9.04.03  13/01/2005 Ebon Clements   CAR 53290
.           Recompiled for PATDEATH - Referral letters
. V9.04.02  25/10/2004 Ebon Clements   CAR 54126
.           Recompiled for PATDEATH - Outpatient slot counts
. V9.04.01  08/10/2004 Ebon Clements   CAR 54126
.           Recompiled for PATDEATH - Outpatient slot counts
.----------------------------------------------------------------------
. V9.03.09  25/06/2004 Peter Vela      CAR 50402
.           Recompiled for PATDEATH
. V9.03.08  23/04/2004 Henry Son       CAR 44794
.           Only delete Emergencies that
.           have been discharged and older than 2 days.
. V9.03.07  18/03/2004 Guomin Fu    CAR 48171
.           Recompiled for PATDEATH
. V9.03.06  15/12/2003 Ebon Clements   CAR 45481  
.           Mods for PMSCURFD file change - added outpatient site
. V9.03.05  03/09/2003 Jill Habasque   43010      
.           Recompiled for PATDEATH (outpreaf & outphoaf)
. V9.03.04  20/08/2003 Ebon Clements CAR 41801
.           Recompiled for PATDEATH - cancel outpatient bookings
. V9.03.03  16/07/2003 Guomin Fu     CAR 41291
.           Recompiled for PATDEATH
. V9.03.02  20/05/2003 Ebon Clements CAR 39108
.           Recompiled for PATDEATH
. V9.03.01  15/05/2003 Ebon Clements CAR 39108
.           Recompiled for PATDEATH
.----------------------------------------------------------------------
. V9.02.17  05.02.2003 Lina Vo                  
.           Recompiled for PATDEATH                                   
. V9.02.16  03.12.2002 Lina Vo                  
.           Mods to open outpatient files with site prefix.           
. V9.02.15  03.09.2002 Jill Habasque SRF 20904
.           Mods to only add outpatient events for the current date   
. V9.02.14  20.08.2002 Ebon Clements SRF 20123
.           Recompiled for PATDEATH - cancel theatre bookings CNOPR000
. V9.02.13  13.08.2002 Jill Habasque SRF 20904
.           Fixed removal of outpatient events from current patients
. V9.02.12  02.07.2002 Jill Habasque SRF 18879 and 19273
.           Added check for PTCNCPAH - AH on current patient search
.           Changed key for pmscuraf
. V9.02.11  17.05.2002 Jill Habasque SRF 17711
.           Fixed write of current events to pmsnutaf
. V9.02.10  16.05.2002 Jill Habasque 3651
.           Added write of current events to pmsnutaf
. V9.02.09  02.05.2002 Jill Habasque 3651
.           Added on leave admissions to pmscuraf
. V9.02.08  29.04.2002 Jill Habasque 
.           Added update of pmsnutaf                             
. V9.02.07  21.02.2002 Jill Habasque 
.           Changed EMR & OP to only be for today in pmscuraf
. V9.02.06  14.02.2002 Jill Habasque 
.           Fixed current patient update
. V9.02.05  14.12.2001 Jill Habasque 
.           Added current patient update
. V9.02.04  09.11.2001 Ebon Clements 
.           Added cancel for Allied Health Transactions - PATDEATH
. V9.02.03  10.10.2001 B.G.Ackland
.           COMMIT Transaction Control
. V9.02.02  03.10.2001 B.G.Ackland
.           COMMIT Transaction Control for WEBINT00
. V9.02.01  29/08/2001  Mike Laming    RCH/SVHM
.           Add Datagate API Cancel Booking (DGCLICCB) for OPRDEA01
.           Add OPCNDGCB for Datagate Flag ex OPRCONFD
.----------------------------------------------------------------------
. V9.00.B02 28.06.2001  Ebon Clements
.           Re Fixed Main Routine - open patient master file
. V9.00.B01 16.05.2001  B.G.Ackland
.           Fix Main Routine
.----------------------------------------------------------------------
.         V5.10.B01 10/04/2001  Glenn Saunders                               
.                   Remove all references to PATSUR file (old surname file).
.         V5.08.00  05.09.2000  K.C.Nelson  
.                   Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF
.
          INC       ALLAUDFD/INC
          INC       ALLCONFD/INC
          INC       ALLENCFD/INC 
          INC       ALLREFFD/INC 
          INC       CATCOMFD/INC
          INC       BOKRC1FD/INC 
          INC       PATWR1FD/INC 
          INC       EMRSITFD/INC 
          INC       EMRVISFD/INC 
          INC       NHIMASFD/INC
          INC       OPRDEAFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       OUTPREFD/INC
          INC       OUTARTFD/INC                                      *I-240720
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTHFD/INC
          INC       PATGSRFD/INC
          INC       PATITMFD/INC
          INC       PATMA1FD/INC
          INC       PATONLFD/INC
          INC       PMSPX2FD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATRE1FD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC
          INC       PMSBRQFD/INC
          INC       PMSVX1FD/INC
          INC       PMSCURFD/INC
          INC       PMSNUTFD/INC
          INC       PMSEVTFD/INC
          INC       PMSOSDFD/INC
          INC       PATRASFD/INC
.
CANDELT   DIM       1                       * Can we delete indicator  *I-44794
CHKGRPIN  FORM      1
CURRDATE  DIM       8
DONE      FORM      1
DTBEFORE  DIM       8                       * 2 days before curr date  *I-44794
DIM1A     DIM       1
OPRMSTAT  FORM      1
OPCNDGCB  FORM      1                       * DG Flag used by OPRDEA01 *I-90201
OPCNS14A  DIM       1
OPCNS15A  DIM       1
NUTFLAG   FORM      1
DATEWORK  DATE      8
DEBTOS    FORM      1                       * Outstanding Debt
DEBTBAD   FORM      1                       * Bad Debt
DEBTPAT   FORM      1                       * Patient Only Debt
DEBTCOL   FORM      1                       * Debt Collector
DEBTPLN   FORM      1                       * Payment Plan
FORM8     FORM      8
MHLRCODE  DIM       3
NMPNUMB   DIM       20
OTCNNODY  DIM       3
PROCFLAG  FORM      1
PURGDATE  DIM       8
SAVKEY17  DIM       17
SAVKEY28  DIM       28
SAVOUTNO  DIM       8
STRTDATE  DIM       8
CFILEPRE  DIM       3                       * outpatient site prefix
.
Z20       INIT      "zzzzzzzzzzzzzzzzzzzz"
.
PRGID     INIT      "PATWEB82"
VERSION   INIT      "V12.00.03"
PRGNAM    INIT      "Patient Death Processing"
.
          CALL      WEBINT00       * Initialise Fifo Etc.
.
.
          CALL      INIT0000       * Open Files
.
MAIN0100  COMMIT
.
          BEGIN
          DISPLAY   *W10
.
          CALL      CURPAT00     * check if current patient update should be run
.
          CALL      NUTUP000     * check if nutrition update should be run
.
          CALL      UPOSD000     * check if Outstanding Debt Ind. need updating
.
MAIN0150  MOVE      SP70,KEY8
          CALL      RSPTDH1
MAIN0200  CALL      RKPTDH1
          BRANCH    OVRCD,MAIN0100
          MOVE      PTDHURNO,KEY8
          CALL      RLPTDH1
          BRANCH    OVRCD,MAIN0200,MAIN0200
          MOVE      PTDHURNO,URNUMBER
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MAIN1000
.
          PACK      KEY10,PTDHWEBU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,PASSCODE
          ELSE
            MOVE      WBSEPCD,PASSCODE     * Set Passcode for Audits & Security 
          ENDIF
.
          CALL      IBACLOCK
.
          PROC      PATDEATH
.
MAIN1000  MOVE      PTDHURNO,KEY8
          CALL      DEPTDH1
          MOVE      SP70,KEY8
          CALL      RDPTDH1
.
          COMMIT
.
          BEGIN
.
          GOTO      MAIN0200
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  READ      CONTROLF,SEVENTY9;*120,PTCNUEOC,*138,PTCNURHA
          READ      CONTROLF,EIGHTY8;*245,PTCNH7ED
          READ      CONTROLF,HUND05;*168,PTCNTIMC,*180,PTCNTIMN,*202,PTCNCPAH
          READ      CONTROLF,HUND23;*209,PTCNUTOM
          READ      CONTROLF,ZERO;*43,IBCNMHOS,*85,IBCNUGST
          OPEN      ALLENCA4,"allencaf"  
          OPEN      ALLREFA1,"allrefaf"  
          OPEN      BOKRC1A4,"bokrc1af"  
          OPEN      PATWR1A1,"patwr1af"  
          OPEN      EMRVISA1,"emrvisaf"                                *I-44794
          OPEN      EMRVISA2,"emrvisaf"
          OPEN      EMRVISA4,"emrvisaf"  
          OPEN      EMRSITA1,"emrsitaf"  
          OPEN      OUTARTA2,"outartaf"  
          OPEN      PATDTHA1,"patdthaf"  
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMI1A3,"patmi1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PMSCURA1,"pmscuraf"
          OPEN      PMSCURA4,"pmscuraf"
          OPEN      PMSNUTA1,"pmsnutaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PMSEVTA4,"pmsevtaf"
          OPEN      PMSOSDA1,"pmsosdaf"
          OPEN      PATRASA1,"patrasaf"
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CATCOMA1,"catcomaf"
          TRAPCLR   IO
.
          RETURN
.------------------------------------------------------------
. Open Outpatient files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA6
          OPEN      OUTBOKA6,CFNAME    
.
          PACK      CFNAME,CFILEPRE,FILBB1A2
          OPEN      OUTBB1A2,CFNAME    
.
          PACK      CFNAME,CFILEPRE,FILSESA1
          OPEN      OUTSESA1,CFNAME    
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          OPEN      OUTHEDA1,CFNAME    
.
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  RETURN
.------------------------------------------------------------
.------------------------------------------------------------
. Check if current patient update should be run
.------------------------------------------------------------
CURPAT00  READ      CONTROLF,HUND05;*168,PTCNTIMC
          CLOCK     TIME,CTIMEIS
          MATCH     PTCNTIMC,CTIMEIS
          IF        !@EQUAL
            MOVE      ZERO,PROCFLAG
            GOTO      CURPAT99
          ENDIF
.
          IF        PROCFLAG<>1
            CALL      REMCUR00              * remove patients from pmscuraf
            CALL      REMEOP00              * remove patients from pmscuraf
            CALL      REMBOK00              * remove bookings from pmscuraf
            CALL      ADDCUR00              * add new patient to pmscuraf
            CALL      ARTPRG00              * Purge old Appointment Requests
            MOVE      ONE,PROCFLAG
          ENDIF
.
CURPAT99  RETURN
+
.------------------------------------------------------------
. Check if nutrition update should be run        
.------------------------------------------------------------
NUTUP000  READ      CONTROLF,HUND05;*180,PTCNTIMN
          CLOCK     TIME,CTIMEIS
          MATCH     PTCNTIMN,CTIMEIS
          IF        !@EQUAL
            MOVE      ZERO,NUTFLAG
            GOTO      NUTUP999
          ENDIF
.
          IF        NUTFLAG<>1
            CALL      ADDNUT00              * add new records to pmsnutaf
            CALL      EVTNUT00              * add new records for current events
            CALL      EMRNUT00              * add new records for emr visits
            MOVE      ONE,NUTFLAG
          ENDIF
.
NUTUP999  RETURN
+
.------------------------------------------------------------
. Add new records to pmsnutaf                 
.------------------------------------------------------------
ADDNUT00  CALL      IBACLOCK 
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
ADDNUT10  CALL      RDKMISS2
          BRANCH    OVRCD,ADDNUT99
.
          COMPARE   TWO,ASTAT
          GOTO      ADDNUT99 IF NOT EQUAL
.
          PACK      KEY16,AADMNO,CURRDATE,Z70
          CALL      RSPMNUT1
          CALL      RPPMNUT1
          BRANCH    OVRCD,ADDNUT10
.
          MOVE      AADMNO,KEY8
          MATCH     KEY8,PMNUADMN
          GOTO      ADDNUT10 IF NOT EQUAL
.
          MOVE      CURRDATE,PMNUDATE
          MOVE      "dxc.webPAS",PMNUUPDU
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
          MOVE      "dxc.webPAS",PMNUCRTU
          PACK      PMNUCRTD,CURRDATE,CTIMEIS
.
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1
          IF        OVRCD=1
            CALL      WRPMNUT1
.
            MOVE      PMNUADMN,KEY8
            CALL      RDMISS1
            IF        OVRCD<>1
              MOVE      PMNUDIET,ADIET
              CALL      UPMISS1               * CAR 0815319
            ENDIF
.
            CALL      UPCAT000                * update catcomaf (extra diet)
.>>>>
            MATCH     "1",PTCNH7ED
            GOTO      ADDNUT10 IF NOT EQUAL        * sending A08 ?
.
            MOVE      AURNO,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,ADDNUT10
.
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            MOVE      AURNO,KEY8
            CALL      RDDSCH1
            IF        OVRCD=1
              CALL      CLPATDSC
            ENDIF
.
            PACK      KEY8,AADMNO,SP70
            CALL      RDPTRES1
            IF        OVRCD=1
              CALL      CPTRE100
            ENDIF
.
            PACK      KEY30,AADMNO,Z70
            CALL      RDSTRAN2                  * position on admission
            CALL      RDPTRAN2                  * read previous record
            BRANCH    OVRCD,ADDNUT10            * eof - shouldn't happen
.
            MATCH     AADMNO,TADMN              * same admission still ?
            GOTO      ADDNUT10 IF NOT EQUAL     * no - shouldn't happen
.
            CALL      PMIGTNID                  * get national id
            MOVE      NMPNUMB,PTNINMPI
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC                  * broadcast admission update
.>>>>
          ENDIF
          GOTO      ADDNUT10
.
ADDNUT99  RETURN
+
.------------------------------------------------------------
. Update Extra Diet Details (catcomaf)
.------------------------------------------------------------
UPCAT000  MATCH     "1",PTCNUTOM
          GOTO      UPCAT999 IF NOT EQUAL
.
          PACK      KEY17,PMNUADMN,PMNUDATE,Z70
          CALL      RSCTCOM1
UPCAT100  CALL      RPCTCOM1
          BRANCH    OVRCD,UPCAT999
.
          MATCH     PMNUADMN,DCTCOADM
          GOTO      UPCAT999 IF NOT EQUAL
.
          PACK      SAVKEY17,CTCOADMN,CTCODATE,CTCOMEAL,SP70
          MOVE      PMNUADMN,CTCOADMN
          MOVE      PMNUDATE,CTCODATE
.
          PACK      KEY17,CTCOADMN,CTCODATE,CTCOMEAL,SP70
          CALL      RACTCOM1
          IF        OVRCD=1
            CALL      WRCTCOM1
          ENDIF
          PACK      KEY17,SAVKEY17
          CALL      RSCTCOM1
          GOTO      UPCAT100                * check for another meal type
.
UPCAT999  RETURN
+
.------------------------------------------------------------
. Add new records to pmsnutaf (current events)
.------------------------------------------------------------
EVTNUT00  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          PACK      KEY8,SP70
          CALL      RSPMEVT1
EVTNUT10  CALL      RKPMEVT1
          BRANCH    OVRCD,EVTNUT99
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT
          CALL      RDCODE1
          BRANCH    OVRCD,EVTNUT10
.
          MATCH     ANSI,TCINDC1
          GOTO      EVTNUT10 IF NOT EQUAL
.
          MATCH     SP70,PMEVDDTE            * current patient (ie not disch)
          GOTO      EVTNUT10 IF NOT EQUAL
.
          PACK      KEY16,PMEVVISN,CURRDATE,Z70
          CALL      RSPMNUT1
          CALL      RPPMNUT1
          BRANCH    OVRCD,EVTNUT10
.
          MATCH     PMEVVISN,PMNUADMN
          GOTO      EVTNUT10 IF NOT EQUAL
.
          MOVE      CURRDATE,PMNUDATE
          MOVE      "dxc.webPAS",PMNUUPDU
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
          MOVE      "dxc.webPAS",PMNUCRTU
          PACK      PMNUCRTD,CURRDATE,CTIMEIS
.
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1
          IF        OVRCD=1
            CALL      WRPMNUT1
            CALL      UPCAT000                * update catcomaf (extra diet)
          ENDIF
          GOTO      EVTNUT10
.
EVTNUT99  RETURN
.------------------------------------------------------------
. Remove old records from current patient file
.------------------------------------------------------------
REMCUR00  CALL      CALRAN00           * calculate range of dates to be stored
.
. --- remove records before the start date for current patients ---
.
          PACK      KEY16,SP70
          CALL      RSPMCUR4
REMCUR10  CALL      RKPMCUR4
          BRANCH    OVRCD,REMCUR99
.
          CALL      CUREVT00
          BRANCH    EXIT,REMCUR10,REMCUR15
.
          MATCH     STRTDATE,PMCUDATE
          GOTO      REMCUR20 IF NOT LESS
.
REMCUR15  PACK      KEY16,PMCUDATE,PMCUVISN,SP70
          MATCH     "1",PMCUSYST
          IF        !@EQUAL
            CALL      DEPMCUR4
          ENDIF
.
          CALL      RSPMCUR4
          GOTO      REMCUR10
.
. --- remove records after the last date for current patients ---
.
REMCUR20  PACK      KEY16,Z70
          CALL      RSPMCUR4
REMCUR30  CALL      RPPMCUR4
          BRANCH    OVRCD,REMCUR99
.
          MATCH     LASTDATE,PMCUDATE
          GOTO      REMCUR99 IF EQUAL
          GOTO      REMCUR99 IF LESS
.
          PACK      KEY16,PMCUDATE,PMCUVISN,SP70
          MATCH     "1",PMCUSYST
          IF        !@EQUAL
            CALL      DEPMCUR4
          ENDIF
.
          CALL      RSPMCUR4
          GOTO      REMCUR30
.
REMCUR99  RETURN
+
.------------------------------------------------------------
. Do not remove current event records                    
.------------------------------------------------------------
CUREVT00  MOVE      ZERO,EXIT
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,CUREVT99
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT
          CALL      RDCODE1
          BRANCH    OVRCD,CUREVT99
.
          MATCH     ANSI,TCINDC1
          GOTO      CUREVT95 IF NOT EQUAL
.
          MATCH     SP70,PMEVDDTE            * current patient (ie not disch)
          GOTO      CUREVT99 IF NOT EQUAL
.
CUREVT90  MOVE      ONE,EXIT
          GOTO      CUREVT99
.
CUREVT95  MOVE      TWO,EXIT
.
CUREVT99  RETURN
.------------------------------------------------------------
. Remove emergency and outpatient visits other than today
.------------------------------------------------------------
REMEOP00  CALL      CALCDB00           * Calc 2 days before today      *I-44794
          PACK      KEY16,SP70
          CALL      RSPMCUR4
REMEOP10  CALL      RKPMCUR4
          BRANCH    OVRCD,REMEOP99
.
          MATCH     CURRDATE,PMCUDATE
          GOTO      REMEOP10 IF EQUAL
.
          MATCH     "1",PMCUSYST
          IF        @EQUAL
            CALL      CHKEMR00              * check if we can delete   *I-44794
            MATCH     ANSY,CANDELT                                     *I-44794
            GOTO      REMEOP20 IF EQUAL     * delete if yes            *I-44794
            GOTO      REMEOP10              * get next record if no    *I-44794
          ENDIF
.
          MATCH     "2",PMCUSYST
          GOTO      REMEOP20 IF EQUAL
.
          MATCH     "8",PMCUSYST
          GOTO      REMEOP10 IF NOT EQUAL
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,REMEOP10
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,REMEOP10
.
          MATCH     ANSO,TCINDC1
          GOTO      REMEOP10 IF NOT EQUAL
.
REMEOP20  PACK      KEY16,PMCUDATE,PMCUVISN,SP70
          CALL      DEPMCUR4
          CALL      RSPMCUR4
          GOTO      REMEOP10
.
REMEOP99  RETURN
.------------------------------------------------------------
. Calculate 2 days before current date.                                *I-44794
.------------------------------------------------------------
CALCDB00  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CALL      DMYCON
          SUB       "2",JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      DTBEFORE,CC,YY,MM,DD
          REP       " 0",DTBEFORE
CALCDB99  RETURN
.
.------------------------------------------------------------
. Remove Bookings other than today
.------------------------------------------------------------
REMBOK00  PACK      KEY16,SP70
          CALL      RSPMCUR4
REMBOK10  CALL      RKPMCUR4
          BRANCH    OVRCD,REMBOK99
.
          MATCH     CURRDATE,PMCUDATE
          GOTO      REMBOK10 IF EQUAL
.
          MATCH     "4",PMCUSYST
          GOTO      REMBOK10 IF NOT EQUAL
.
REMBOK20  PACK      KEY16,PMCUDATE,PMCUVISN,SP70
          CALL      DEPMCUR4
          CALL      RSPMCUR4
          GOTO      REMBOK10
.
REMBOK99  RETURN
+

.------------------------------------------------------------
. Check if Emergency is discharged longer than 2 days.                 *I-44794
.------------------------------------------------------------
CHKEMR00  MOVE      ANSN,CANDELT
          PACK      KEY8,PMCUVISN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,CHKEMR99
.
          IF        EMVISTAT=4
            MATCH     DTBEFORE,EMVIDATE       * emerg. less than 2 days.
            IF        @LESS
              MOVE      ANSY,CANDELT
              GOTO      CHKEMR99
            ENDIF
          ENDIF
.
          MATCH     SP8,EMVIDDAT            * ignore if not discharged
          GOTO      CHKEMR99 IF EQUAL
.
          MATCH     DTBEFORE,EMVIDDAT       * emerg. less than 2 days.
          IF        @LESS
            MOVE      ANSY,CANDELT
          ENDIF
.
CHKEMR99  RETURN
.
.------------------------------------------------------------
. Calculate the date range for current patient records
.------------------------------------------------------------
CALRAN00  READ      CONTROLF,HUND01;*49,CWEBSDAY  * no of days for search
          MOVE      SP70,STRTDATE
          MOVE      SP70,LASTDATE
.
. ---  calculate starting date ---
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CALL      DMYCON
          SUB       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
. ---  calculate last date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          ADD       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      LASTDATE,CC,YY,MM,DD
          REP       " 0",LASTDATE
.
CALRAN99  RETURN
+
.------------------------------------------------------------
. Purge completed Appointment Request records from "outartaf"
.------------------------------------------------------------
ARTPRG00  MOVE      ZERO,EXIT
.                                           * establish date for purge old recds
          READ      CONTROLF,THIRTY2;*133,OTCNNODY
          MOVE      OTCNNODY,F3
          COMPARE   ZERO,F3
          GOTO      ARTPRG99 IF EQUAL
.
          CALL      IBACLOCK 
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,DATEWORK
          SUB       F3,DATEWORK
          MOVE      DATEWORK,PURGDATE
.
.                                           * Read all "Booked" and "Cancelled"
.                                           * records - delete any record with
.                                           * these dates less than PURGDATE
          MOVE      "2",KEY1
          PACK      KEY33,KEY1,SP70
ARTPRG10  CALL      RSOTART2
ARTPRG11  CALL      RKOTART2
          BRANCH    OVRCD,ARTPRG99
.
          MATCH     "2",OTARSTAT            * has Request been Completed ?
          IF        @EQUAL
            MATCH     PURGDATE,OTARCPDT 
            GOTO      ARTPRG20 IF LESS
          ENDIF
.
          MATCH     "3",OTARSTAT            * has Request been Cancelled ?
          IF        @EQUAL
            MATCH     PURGDATE,OTARCADT
            GOTO      ARTPRG20 IF LESS
          ENDIF
.
          GOTO      ARTPRG11
.
ARTPRG20  PACK      KEY33,OTARSTAT,OTARRQDT,OTARRQTM,OTARURNO,OTARREFN,SP20
          CALL      DEOTART2
          GOTO      ARTPRG10
.          
.
ARTPRG99  RETURN
.------------------------------------------------------------
. Add new patients to pmscuraf
.------------------------------------------------------------
ADDCUR00  CALL       ADDEMR00             * add emergency visits
.
          CALL       ADDEMC00             * add all emr patient
.
          CALL       ADDOUT00             * add outpatient bookings
.
          CALL       ADDINP00             * add inpatient bookings
.
          IF         PTCNCPAH=1
            CALL       ADDALL00             * add allied health encounters
          ENDIF
.
          CALL       ADDEVT00             * add patient events
.
          CALL       ADDBOK00             * add bookings for today only
.
ADDCUR99  RETURN
+
.------------------------------------------------------------
. Add new emergency visits
.------------------------------------------------------------
ADDEMR00  PACK      KEY24,CURRDATE,SP70
          CALL      RSEMVIS4
ADDEMR10  CALL      RKEMVIS4
          BRANCH    OVRCD,ADDEMR99
.
          MATCH     EMVIDATE,CURRDATE
          GOTO      ADDEMR99 IF NOT EQUAL
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDEMR10
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDEMR10
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          IF        OVRCD=1
            MOVE      SP70,EMSTHSNO
          ENDIF
.
          MOVE      EMVIADMN,PMCUVISN
          MOVE      EMVIDATE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      SP70,PMCULOCN
          MOVE      "1",PMCUSYST
          MOVE      SP70,PMCUOSIT
          MOVE      EMSTHSNO,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
          GOTO      ADDEMR10
.
ADDEMR99  RETURN
+
.------------------------------------------------------------
. Add new emergency visits
.------------------------------------------------------------
ADDEMC00  PACK      KEY9,ONE,SP70
          CALL      RSEMVIS2
ADDEMC10  CALL      RKEMVIS2
          BRANCH    OVRCD,ADDEMC99
.
          COMPARE   ONE,EMVISTAT
          GOTO      ADDEMC99 IF NOT EQUAL
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDEMC10
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDEMC10
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          IF        OVRCD=1
            MOVE      SP70,EMSTHSNO
          ENDIF
.
          MOVE      EMVIADMN,PMCUVISN
          MOVE      EMVIDATE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      SP70,PMCULOCN
          MOVE      "1",PMCUSYST
          MOVE      SP70,PMCUOSIT
          MOVE      EMSTHSNO,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
          GOTO      ADDEMC10
.
ADDEMC99  RETURN
+
.------------------------------------------------------------
. Add new outpatient bookings 
.------------------------------------------------------------
ADDOUT00  PACK      KEY16,CURRDATE,SP70
          CALL      RDSBOKB2
ADDOUT10  CALL      RDKBOKB2
          BRANCH    OVRCD,ADDOUT99
.
          MATCH     OBADATE,CURRDATE
          GOTO      ADDOUT99 IF NOT EQUAL
.
          MOVE      DOBAOUTN,SAVOUTNO
          PACK      KEY36,OBAOUTNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,ADDOUT10
.
          MATCH     DOBAOUTN,SAVOUTNO
          GOTO      ADDOUT10 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,ADDOUT10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ADDOUT10
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDOUT10
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDOUT10
.
          MOVE      OBAOUTNO,PMCUVISN
          MOVE      OBADATE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "2",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      OBASITE,PMCUOSIT
          MOVE      OTHEHOSP,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
          GOTO      ADDOUT10
.
.
ADDOUT99  RETURN
+
.------------------------------------------------------------
. Add new bookings
.------------------------------------------------------------
ADDBOK00  PACK      KEY16,CURRDATE,SP70
          CALL      RSBKREC4
ADDBOK10  CALL      RKBKREC4
          BRANCH    OVRCD,ADDBOK99
.
          MATCH     BKREEDAT,CURRDATE
          GOTO      ADDBOK99 IF NOT EQUAL
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDBOK10
.
          MATCH     ANSD,TCINDC5
          GOTO      ADDBOK10 IF NOT EQUAL
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDBOK10
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDBOK10
.
          MOVE      BKREBOOK,PMCUVISN
          MOVE      BKREEDAT,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "4",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      SP70,PMCUOSIT
          PACK      PMCUHOSP,SP70
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          IF        OVRCD<>1
            MOVE      PTWDHOSN,PMCUHOSP
          ENDIF
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
          GOTO      ADDBOK10
.
ADDBOK99  RETURN
+

.------------------------------------------------------------
. Add new inpatient preadmissions/admissions
.------------------------------------------------------------
ADDINP00  PACK      KEY16,STRTDATE,SP70
          CALL      RDSMISS3
ADDINP10  CALL      RDKMISS3
          BRANCH    OVRCD,ADDINP20
.
          MATCH     ADATE,LASTDATE
          GOTO      ADDINP20 IF LESS
.
          COMPARE   FIVE,ASTAT          * ignore cancelled admissions
          GOTO      ADDINP10 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDINP10
.
          MOVE      AADMNO,PMCUVISN
          MOVE      ADATE,PMCUDATE
          PACK      KEY8,AURNO,SP70
          CALL      WRTINP00
.
          GOTO      ADDINP10
.
.------ current admissions ------
.
ADDINP20  PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
ADDINP30  CALL      RDKMISS2
          BRANCH    OVRCD,ADDINP40
.
          MATCH     "2",DASTAT
          GOTO      ADDINP40 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDINP30
.
          MOVE      AADMNO,PMCUVISN
          MOVE      ADATE,PMCUDATE
          PACK      KEY8,AURNO,SP70
          CALL      WRTINP00
.
          GOTO      ADDINP30
.
.-----  patients discharged ------
.
ADDINP40  PACK      KEY16,STRTDATE,SP70
          CALL      RDSDSCH2
ADDINP50  CALL      RDKDSCH2
          BRANCH    OVRCD,ADDINP60
.
          MATCH     DDATE,LASTDATE
          GOTO      ADDINP60 IF LESS
.
          PACK      KEY8,DADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDINP50
.
          MOVE      DADMNO,PMCUVISN
          MOVE      DDATE,PMCUDATE
          PACK      KEY8,DURNO,SP70
          CALL      WRTINP00
.
          GOTO      ADDINP50
.
.------ on leave admissions ------
.
ADDINP60  PACK      KEY9,FOUR,SP70
          CALL      RDSMISS2
ADDINP70  CALL      RDKMISS2
          BRANCH    OVRCD,ADDINP90
.
          MATCH     "4",DASTAT
          GOTO      ADDINP90 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDINP70
.
          MOVE      AADMNO,PMCUVISN
          MOVE      ADATE,PMCUDATE
          PACK      KEY8,AURNO,SP70
          CALL      WRTINP00
.
          GOTO      ADDINP70
.
ADDINP90
.
ADDINP99  RETURN
+
.------------------------------------------------------------
. Write an inpatient record   
.------------------------------------------------------------
WRTINP00  CALL      RDMAST1
          BRANCH    OVRCD,WRTINP99
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,WRTINP99
.
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "3",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      SP70,PMCUOSIT
          MOVE      PMVXMHOS,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
.
WRTINP99  RETURN
+
.------------------------------------------------------------
. Add allied health encounters
.------------------------------------------------------------
ADDALL00  PACK      KEY24,CURRDATE,SP70
          CALL      RSALENC4
ADDALL10  CALL      RKALENC4
          BRANCH    OVRCD,ADDALL99
.
          MATCH     ALENSDAT,CURRDATE
          GOTO      ADDALL99 IF NOT EQUAL
.
          PACK      KEY8,ALENVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,ADDALL10
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDALL10
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDALL10
.
          MOVE      ALENVISN,PMCUVISN
          MOVE      ALENSDAT,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "9",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      SP70,PMCUOSIT
          MOVE      ALREHOSN,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
          GOTO      ADDALL10
.
.
ADDALL99  RETURN
+
.------------------------------------------------------------
. Add patient events
.------------------------------------------------------------
ADDEVT00  PACK      KEY16,STRTDATE,SP70
          CALL      RSPMEVT4
ADDEVT10  CALL      RKPMEVT4
          BRANCH    OVRCD,ADDEVT99
.
          MATCH     PMEVADTE,LASTDATE
          GOTO      ADDEVT99 IF LESS
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDEVT10
.
          MATCH     ANSI,TCINDC1
          GOTO      ADDEVT20 IF EQUAL
.
          MATCH     CURRDATE,PMEVADTE
          GOTO      ADDEVT10 IF NOT EQUAL
. 
ADDEVT20  PACK      KEY8,PMEVVISN,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,ADDEVT10
.
          PACK      KEY8,PMEVVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDEVT10
.
          PACK      KEY8,PVIURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDEVT10
.
          PACK      KEY8,PVIURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDEVT10
.
          MOVE      PMEVVISN,PMCUVISN
          MOVE      PMEVADTE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "8",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      SP70,PMCUOSIT
          MOVE      PMVXMHOS,PMCUHOSP 
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
          GOTO      ADDEVT10
.
.
ADDEVT99  RETURN
.*----------------------------------------------------------------------------
.*                                   UPOSDT00                         *I-119436
.*                        Update Outstanding Debt Indicator
.*----------------------------------------------------------------------------
UPOSD000  MOVE      ZERO,EXIT
.
UPOSD100  PACK      KEY8,SP70
          CALL      RSPMOSD1
          CALL      RKPMOSD1
          BRANCH    OVRCD,UPOSD999
.
          PACK      KEY8,PMODURNO,SP8
          CALL      RDPMPX21
          BRANCH    OVRCD,UPOSD500
.
          MOVE      KEY8,PURNO
          PROC      CHKDBT00                * determine Patient debt
.
          MOVE      ZERO,DONE
          MOVE      DEBTOS,KEY1             * Outstanding Debt - 0=No, 1=Yes
          MATCH     PMPXSN15,KEY1           * don't change if equal
          IF        !@EQUAL
            MOVE      KEY1,PMPXSN15         * reset Outstanding Debt flag
            MOVE      ONE,DONE
          ENDIF
.                                                          * start    *I-233229
          MOVE      PMPXSN12,F1             * Patient Only Debt
          IF        F1 <> DEBTPAT
            MOVE      DEBTPAT,PMPXSN12 
            MOVE      ONE,DONE
          ENDIF
.
          MOVE      PMPXSN13,F1             * Payment Plan Debt
          IF        F1 <> DEBTPLN
            MOVE      DEBTPLN,PMPXSN13
            MOVE      ONE,DONE
          ENDIF
.
          MOVE      PMPXSN14,F1             * Debt Collection Agency
          IF        F1 <> DEBTCOL
            MOVE      DEBTCOL,PMPXSN14 
            MOVE      ONE,DONE
          ENDIF                                            * end      *I-233229
.
UPOSD400  IF        DONE = 1
            CALL      UPPMPX21              * update PMI extention record
          ENDIF
.
UPOSD500  CALL      DEPMOSD1                * delete this polling record
          GOTO      UPOSD100                * back to read next polling record
.
.
UPOSD999  RETURN
.
.*----------------------------------------------------------------------------
.*  CHKDBT00
.*  Procedure to process outstanding debt alert Exit=0 No Debts 1 Has Debts
.*                    (Code taken from PATMASTM - was CHKDEBTS)
.*----------------------------------------------------------------------------
          DEFPROC   CHKDBT00
.
          INC       PATINVFD/INC
          INC       PATVISFD/INC
          INC       PATDETFD/INC                                      *I-233229
          INC       PRIINVFD/INC
.
PTCNOUTD  DIM       9
NOTPAID   FORM      12.2
TEMPTOT   FORM      12.2
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,DEBTOS             * Outstanding Debt
          MOVE      ZERO,DEBTPAT            * Patient Debt Only
          MOVE      ZERO,DEBTCOL            * Debt Collection Agency
          MOVE      ZERO,DEBTPLN            * Payment Plan
.
          MOVE      ZERO,F1
.                                           * Patient Billing
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATDETA1,"patdetaf"                               *I-233229
.
          PACK      KEY24,PURNO,SP20
          CALL      RDSVISA2                * position on the visit file
.
.------ read through the visit file ------
.
CHKDD100  CALL      RDKVISA2
          BRANCH    OVRCD,CHKDD500
.
          MATCH     PURNO,PVIURNO           * match U/R numbers
          GOTO      CHKDD500 IF NOT EQUAL
.
          PACK      KEY16,PVIBILL,SP8       * position on the invoice file
          CALL      RDSINV3                 * for this admission number
.
.------ read through the invoice file for this admission number ------
.
CHKDD200  CALL      RDKINV3
          BRANCH    OVRCD,CHKDD100
.
          MATCH     PVIBILL,PINVADM         * compare admission numbers
          GOTO      CHKDD100 IF NOT EQUAL
.
          ASSIGN    PINVAMT+PINVPATA+PINVHFDA+PINVOTHA+PINVJOUR+PTINCRTT,NOTPAID
          IF        IBCNUGST=2 | IBCNUGST=3
            ADD       PTINGSTJ,NOTPAID
          ENDIF
.
          IF        NOTPAID > 0 & DEBTOS = 0
            MOVE      ONE,DEBTOS            * Outstanding Debt
          ENDIF
.
.         Get Patient portion from Reassign debt table
.
          COMPARE   ZERO,NOTPAID
          GOTO      CHKDD230 IF EQUAL            * No outstanding amount
.
          PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          IF        OVRCD=0
            MATCH     PINVNO,PTRAINVN            * Same invoice number?
            IF        @EQUAL
             MATCH     "1",PTRADELE
             GOTO      CHKDD220 IF NOT EQUAL     * not deleted/reset
            ENDIF
          ENDIF
          ADD       ONE,F1        * found Inv which is NOT 'a Patient only Debt'
          MOVE      ZERO,DEBTPAT
          GOTO      CHKDD230
.
CHKDD220  IF        (NOTPAID > 0) & (PTRAPPOR=NOTPAID)
            IF        F1=0
              MOVE      ONE,DEBTPAT           * Patient Only Debt
            ENDIF
          ELSE
            ADD       ONE,F1     * found Inv which is NOT 'a Patient only Debt'
            MOVE      ZERO,DEBTPAT
          ENDIF
.                                           * check for Payment Plan indicator
CHKDD230  MOVE      PINVSYS,PTDESYST        * System
          PACK      KEY10,TWO,PINVNO,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 0
.                                           * is debt clear ?
            IF        NOTPAID = 0
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                PACK      PTDEDTCL,CCC,CYY,CMM,CDD
                REP       " 0",PTDEDTCL
                CALL      UPPTDET1          * update Date Cleared in "patdetaf"
              ENDIF
            ELSE
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                MOVE      ONE,DEBTPLN       * Payment Plan Debt still open
              ENDIF
            ENDIF
          ENDIF
.                                           * check for Debt Collector Ind.
          MOVE      PINVSYS,PTDESYST        * System
          PACK      KEY10,THREE,PINVNO,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 0
.                                           * is debt clear ?
            IF        NOTPAID = 0
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                PACK      PTDEDTCL,CCC,CYY,CMM,CDD
                REP       " 0",PTDEDTCL
                CALL      UPPTDET1          * update Date Cleared in "patdetaf"
              ENDIF
            ELSE
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                MOVE      ONE,DEBTCOL       * Patient Debt Collector debt
              ENDIF
            ENDIF
          ENDIF                                                * end  *I-233229
          GOTO      CHKDD200
.
CHKDD500  CLOSE     PATINVR3
          CLOSE     PATVISA2 
          BRANCH    EXIT,CHKDD900           * already flagged - leave routine
.         
          OPEN      PRIINVO3,"priinvof"                       * start *I-210835
.
          MOVE      " 1",KEY2
          PACK      KEY18,PURNO,KEY2,SP20
          CALL      RSPRIN3
CHKDD600  CALL      RKPRIN3
          BRANCH    OVRCD,CHKDD900
.
          MATCH     PRINDEBT,PURNO
          GOTO      CHKDD900 IF NOT EQUAL
          MATCH     " 1",DPRINSCN
          GOTO      CHKDD600 IF NOT EQUAL
.
          ASSIGN   PRINITOT+PRINPAMT+PRINHAMT+PRINIAMT+PRINMAMT+PRINVAMT,TEMPTOT
          ASSIGN   TEMPTOT+PRINOTHA+PRINJAMT+PRINGSTJ+PRINCNTT,NOTPAID
.
          MOVE      "4",PTDESYST            * System
          PACK      KEY10,TWO,PRINNUMB,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 0
.
            IF        NOTPAID = 0
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                PACK      PTDEDTCL,CCC,CYY,CMM,CDD
                REP       " 0",PTDEDTCL
                CALL      UPPTDET1          * update Date Cleared in "patdetaf"
              ENDIF
            ELSE
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                MOVE      ONE,DEBTPLN       * Payment Plan Debt still open
              ENDIF
            ENDIF
          ENDIF
.                                           * check for Debt Collector Ind.
          MOVE      "4",PTDESYST            * System
          PACK      KEY10,THREE,PRINNUMB,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 0
.                                           * is debt clear ?
            IF        NOTPAID = 0
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                PACK      PTDEDTCL,CCC,CYY,CMM,CDD
                REP       " 0",PTDEDTCL
                CALL      UPPTDET1          * update Date Cleared in "patdetaf"
              ENDIF
            ELSE
              MATCH     SP8,PTDEDTCL        * has Date Debt Cleared been set?
              IF        @EQUAL
                MOVE      ONE,DEBTCOL       * Patient Debt Collector debt
              ENDIF
            ENDIF
          ENDIF                                                * end  *I-233229
.
          IF        NOTPAID > 0 & DEBTOS = 0
            MOVE      ONE,DEBTOS            * Outstanding Debt
          ENDIF
          GOTO      CHKDD600                                    * end *I-210835
.
          INC       IBAOVRIO/INC
          INC       PATINVIO/INC
          INC       PATVISIO/INC
          INC       PATDETIO/INC                                      *I-233229
          INC       PRIINVIO/INC
.
CHKDD900  CLOSE     PRIINVO3
.
CHKDD999  ENDPROC
+
.******************************************************************************
.*  Clear patre1af variables                                                  *
.******************************************************************************
CPTRE100  PACK      DPKADMN,SP70
          PACK      PKNAME,SP70,SP10
          PACK      PKADD1,SP70
          PACK      PKADD2,SP70
          PACK      PKSUBR,SP70
          PACK      PKADD4,SP70
          PACK      PKPOST,SP70
          PACK      PKTELEP,SP70
          PACK      PKTELEB,SP70
          PACK      PKRELP,SP70
.
CPTRE199  RETURN
.
.------------------------------------------------------------
. Add new records to pmsnutaf (current emergency visits)
.------------------------------------------------------------
EMRNUT00  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY9,ONE,SP70
          CALL      RSEMVIS2
EMRNUT10  CALL      RKEMVIS2                * Currect ED visit for all sites
          BRANCH    OVRCD,EMRNUT99
.
          COMPARE   ONE,EMVISTAT            * Exit if not a current visit
          GOTO      EMRNUT99 IF NOT EQUAL
.
          PACK      KEY16,DEMVIADM,CURRDATE,Z70
          CALL      RSPMNUT1
          CALL      RPPMNUT1
          BRANCH    OVRCD,EMRNUT10
.
          MATCH     DEMVIADM,PMNUADMN
          GOTO      EMRNUT10 IF NOT EQUAL
.
          MOVE      CURRDATE,PMNUDATE
          MOVE      "dxc.webPAS",PMNUUPDU
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
          MOVE      "dxc.webPAS",PMNUCRTU
          PACK      PMNUCRTD,CURRDATE,CTIMEIS
.
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1
          IF        OVRCD=1
            CALL      WRPMNUT1
            CALL      UPCAT000                * update catcomaf (extra diet)
          ENDIF
          GOTO      EMRNUT10
.
EMRNUT99  RETURN
.
.*-----------------------------------------------------------------------------
          INC       IBAWEBCD
          INC       CLALLAUD
          INC       CLPATDSC
          INC       CLPMSPX2
          INC       DGCLICAC
          INC       DGCLICCB                                           *I-90201
          INC       DGCLIS14
          INC       DGCLIS15
.
          INC       ALLENCIO/INC 
          INC       ALLREFIO/INC 
          INC       BOKRC1IO/INC 
          INC       CATCOMIO/INC
          INC       PATWR1IO/INC 
          INC       EMRSITIO/INC 
          INC       EMRVISIO/INC 
          INC       NHIMASIO/INC 
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTPREIO/INC
          INC       OUTSESIO/INC
          INC       OUTHEDIO/INC
          INC       OUTARTIO/INC                                      *I-240720
          INC       PATDRGIO/INC
          INC       PATDSCIO/INC
          INC       PATDTHIO/INC
          INC       PATGSRIO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PMSPX2IO/INC
          INC       PATNIDIO/INC
          INC       PATRE1IO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       PMSNUTIO/INC
          INC       PMSCURIO/INC
          INC       PMSEVTIO/INC
          INC       PMSOSDIO/INC
          INC       PATRASIO/INC
.
          INC       GENANVIS
          INC       EOCDELEV
          INC       PATCOMN3
          INC       PATDEATH
          INC       PATITMDS
          INC       PMIGTNID
.
