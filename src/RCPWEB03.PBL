.------------------------------------------------------------------------------
. Program       : RCPWEB03
.
. Function      : Cash Receipting Server for 
.                 Report 2 & 3: Input Receipts                                
.                 Report 4 : Patient Level Input Receipts from Invoice.
.                 Report 5 : Allocate Suspense Receipts
.                 Report 6 : Patient Level Input Deposits.
.                 Report 7 : Input Receipts for PP Bulk Billing
.
. Modifications :
.------------------------------------------------------------------------------
. V12.00.02  27/08/2025  Alina Bhari      TSK 0954453
.            Recompiled for RCPPRTCD - Added Patient Name
. V12.00.01 24/07/2025  J.Tan          TSK 0962500
.           Mod Cash to check for U/R number
. V11.04.03 19/04/2024  J.Tan          Task 0943328
.           Mod checking allocated amount against total payment
. V11.04.02 15/03/2024  J.Tan          Task 0919335
.           Mod to check HF History file for HF Group
. V11.04.01 12/02/2024  J.Tan             TSK 0938600
.           Mod URAS000 to check for existing Reason for Debt movement(REASMOVE)
. V11.03.03 02/10/2023  Nikitha B         TSK 0927699
.           Read header and tail stationary variables for CAPPRVNO and PTCNHABN .           single and multi hospital.
. V11.03.02  05/05/2023  J.Tan          TSK 0847250
.           Recompiled for PRIUPURE - fixed payment amount
. V11.03.01 20/03/2023 J.Tan          TSK 0847250
.           Mod Updating PP Unreconciled invoice(PRIUPURE)
. V11.02.04 03/05/2022  J.Tan          TSK 0902652
.           Fixed auto Patient Reassigned debt for Patient Only invoice
. V11.02.03 08/04/2022  Jacob Jackson  TSK 0864505
.           Recompiled for RCPPRTCD fix - removing branching label
. V11.02.02 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.01 24/01/2022  Jacob Jackson  TSK 0864505
.           Recompiled for RCPPRTCD - Adding preferred name label options
. V11.01.01 15/06/2021  J.Tan          TSK 0907202
.           Mod Updating Reassign debt only if patient portion exists (URAS0000)
. V11.00.06 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.05 29/10/2020  J.Tan                   TSK 0896343
.           Recompiled for RCPBDTTM - blank Card type for EFTPOS Type = Cash
. V11.00.04 27/07/2020  Sunny             TSK 0892373
.           Changed PRNTNAME and PRNTRNAM to DIM 80
. V11.00.03 26/06/2020  Peter Vela        TSK 0892768
.           Changed SUSCOUNT to DIM 5
. V11.00.02 09/04/2020  J.Tan             TSK 0868813
.           Mod PRFANAME to DIM80
. V11.00.01 27/02/2020  Ebon Clements    Task 0816715
.           Added created and updated by fields to future actions
. V10.14.03 25/06/2019  J.Tan            TSK 0876955
.           Fixed reading tmpdteaf - "Receipt Details does not exist"
. V10.14.02 12/06/2019  J.Tan            TSK 0876385
.           Removed "Warning: Code Cat dm Ind1=R not Setup"
. V10.14.01 20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.13.03 01/02/2019  J.Tan              Task 0860026
.           Mod Automatic re-assign debt for Input Patient/Debtor payment
. V10.13.02 21/08/2018  J.Tan           TSK 0859742
.           Mod to use CLPRIHTR - added Hospital Indicator
. V10.13.01 26/07/2018  J.Tan            TSK 0848506
.           Recompiled for RCPPRTCD/PRINTHS1 - PP Doctor from DIM6 to DIM10
.           07/08/2018  J.Tan              Task 0860739
.           Mod DETTAB00 to restore Register fields
. V10.11.03 27/11/2017  Thanh Tieu         Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.02 22/11/2017  Ania P             TSK 0261630
.           Moved TFILNAME to CFNAMEDP in INIT0000
.
. V10.11.01 30/07/2017  Thanh T.           TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.------------------------------------------------------------------------------
.     V10.10.01 21/03/2017  Jill Parkinson TSK 0834646
.               Added error if writing to rcpdteaf with blank register
.     V10.08.03 30/08/2016  J.Tan           TSK 0819992
.               Mods RCDTALLO to 2 instead of 0 for Suspense register
.     V10.08.02 23/08/2016  J.Tan         CAR 0807877
.               Mods to set IBACLOCK at Finishing Receipts
.     V10.08.01 18/04/2016  Peter Vela    CAR 0294177
.               Recompiled for PRINTHS1
.     V10.07.04 13/01/2016  J.Tan         CAR 303942
.               Fixed defaulting payment type
.     V10.07.03 13/01/2016  J.Tan         CAR 303942
.               Fixed defaulting payment type
.     V10.07.02 17/11/2015  J.Tan         CAR 303942
.               Mods for Payment code
.     V10.07.01 12/08/2015  J.Tan         CAR 314900
.               Added HSYS1=5 for Extended Integra interface
.     V10.06.03 10/07/2015  Peter Vela   CAR 318539
.               Added direct read to RCPREGFD earlier in the loop DETTAB00
.     V10.06.02 18/06/2015  Ebon Clement CAR 317589
.               Recompiled for RCPPRTCD - Extra contacts read
.     V10.06.01 08.04.2015  J.Tan        CAR 313294
.               Fixed displaying Register desc. (DETTAB00)
.     V10.05.03 27.02.2015  J.Tan        CAR 305307
.               Fixed Bank Acct for Allocated suspense register for HSYS1=4
.     V10.05.02 04.12.2014  Peter Vela   CAR 309543
.               Recompiled for RCPBNKTM
.     V10.05.01 29.07.2014  J.Tan        CAR 303627
.               Added HSYS1=4 G/L Comma delimied to get Accounts from Register
.     V10.04.05 20.06.2014  J.Tan        CAR 302000
.               Recompiled for RCPPRTCD - printing deposit type desc.
.     V10.04.04 07.04.2014  Peter Vela   CAR 286158
.               Recompiled for PATMASTM
.     V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.               Replace META Tag Redirect with Javascript in Common RDIREC00
.               Routine
.     V10.04.02 03/03/2014  J.Tan            CAR 297922
.               Added PP Service doctor to rcpdteaf file
.     V10.04.01 07/02/2014  Steve Armstrong  CAR 288084
.               Recompiled for changes to TMPDTEFD
.------------------------------------------------------------------------------
.     V10.03.18 26/09/2013  J.Tan         CAR 288013
.               Fixed SCHDPRNT for PINV0000    
.     V10.03.17 23/09/2013  J.Tan         CAR 288013
.               Fixed SCHDPRNT for PINV0000    
.     V10.03.16 24/07/2013  J.Tan         CAR 288013
.               Recompiled for RCPDTETD - increased printer code to DIM6
.     V10.03.15 24/06/2013  J.Tan         CAR 287260
.               Fixed default printer for print receipt & changed PRINTCOD to D6
.     V10.03.14 30/05/2013  Peter Vela    CAR 261630
.               Removed port number from temp file name
.     V10.03.13 22/04/2012  J.Tan         CAR 281302
.               Mods to remove zero amt of receipt from Suspense Allocation list
.     V10.03.12 15/01/2013  J.Tan           CAR 240374
.               Recompiled for RCPPRTCD - added PRFA variables from patre1af
.     V10.03.11 18/12/2012  Ania P          CAR 274932 
.               Added tag for EFTPOS terminal select list        
.     V10.03.10 16/11/2012  J.Tan           CAR 269318
.               Added remote script for List of Medical practice
.     V10.03.09 24/09/2012  J.Tan           CAR 272986
.               Fixed I*C on priinvof file
.     V10.03.08 04/09/2012  J.Tan           CAR 268233
.               Mods for Emergency Reassign Debts
.     V10.03.07 03/07/2012  Mike Laming     CAR 268265
.               Corrected field KEY1 at IRCP8100 for Credit Card Surcharge
.     V10.03.06 18/06/2012  J.Tan           CAR 246555
.               Mods checking for Register for a Medical practice
.     V10.03.05 17/04/2012  J.Tan           CAR 252226
.               Mods to check Credit Card surcharge Register from Reg.file
.     V10.03.04 03/04/2012 J.Tan      CAR 263047
.               Fixed removing records from tmpdteaf and tmpbdtaf
.     V10.03.03 02/02/2012  J.Tan           CAR 246107
.               Mods checking for Inactive Cash drawers
.     V10.03.02 16/01/2012  Sandra Barcham  CAR 256563
.               Recompiled for PATMASTM
.     V10.03.01 16/11/2011 J.Tan  CAR 240262
.               Mods to print Private practice unbalanced invoice
.     V10.02.08 26/10/2011 J.Tan            CAR 253933
.               Mods to set PTMASNAM before packing patient name
.     V10.02.07 12/10/2011 J.Tan  CAR 235370
.               Recompiled for RCPPRTCD - NHI names for SX
.     V10.02.06 23/09/2011 J.Tan            CAR 244159
.               Mods credit card surcharge for Multi hospitals
.     V10.02.05 16/07/2011 J.Tan            CAR 244159
.               Added tag for credit card type
.     V10.02.04 24/07/2011 J.Tan            CAR 244159
.               Mods for Credit Card surcharge Register 89
.               02/08/2011 J.Tan            CAR 244159
.               Fixed income account for Credit Card Surcharge
.     V10.02.03 19/07/2011 Saroeun Soeur    CAR 244160
.               populated TMBNMHOS and TMBNMDHS
.     V10.02.02 04/04/2011  Jill Parkinson CAR 239574
.               Removed open of ibaprntf
.     V10.01.03 21/02/2011  Mike Laming    CAR 233901
.               Add four fields to RCPDTEFD for RCDTRELU,RCDTSPUI,RCDTSPDT/TM
.               Add "Suspense Receipt" table and setup "rcpsrtaf" in MVSUSP00
.               16/03/2011 J.Tan           CAR 233264
.               Fixed updating Unreconciled invoice file to update date/time
.     V10.01.02 18/11/2010 J.Tan            CAR 233971
.               Mods to clear temporary receipt file after cancelling suspense
.     V10.01.01 15/11/2010  Mike Laming   CAR 233264  
.               Add tag for "Warning : with Debt Collection Agent" at IRCP7900
.     V10.00.07 22/09/2010 J.Tan            CAR 222709
.               Added tag for selected Medical practice
.     V10.00.06 03/08/2010 J.Tan            CAR 191023
.               Mods to write un-balanced invoice to un-reconciled invoice file
.     V10.00.05 21/07/2010  J.Tan          CAR 226011 
.               Recompiled for RCPPRTCD - printing Name for HWK Sundry debtor
.     V10.00.04 11/05/2010  J.Tan         CAR 216328
.               Added a new parameter HSYS1=3 for G/L Integra cash interface
.     V10.00.03 28/04/2010  Peter Vela    CAR 219657
.               Added inactive status validation for medical practices MPRSEL00
.     V10.00.02 19/04/2010  J.Tan        CAR 219670
.               Mods to set date/time updated to rcpdteaf file
.     V10.00.01 30/03/2010  J.Tan           CAR 174079
.               Added new field to patfactaf for Act.Plan Inv.number
.     V9.12.17  15/03/2010  Ebon Clements CAR 217959
.               Exit GTNBK000 if no inv number. eg Sundry Debtors
.     V9.12.16  24/02/2010  J.Tan         CAR 216328
.               Mods to setup RCDTGSTC & parameter for using one char of Ledger
.     V9.12.15  19/02/2010  J.Tan         CAR 215866
.               Mods IRCP3900 to check parameter for display registers
.               for users hospital ID only
.     V9.12.14  02/02/2010  Jill Parkinson CAR 215204
.               Changed IRCP6600 to output KEY50 instead of KEY20
.     V9.12.13  14/01/2010  J.Tan         CAR 174079
.               Mods for Action plan
.     V9.12.12  13/01/2010  J.Tan         CAR 213538
.               Mods checking for Eclipse claim
.     V9.12.11  27/11/2009  J.Tan         CAR 208676
.               Removed updating HF payment date to Letter Reminder file
.     V9.12.10  02/11/2009  J.Tan         CAR 208676
.               Fixed updating Health fund payment date to Letter Reminder file
.     V9.12.09  02/11/2009  J.Tan         CAR 208676
.               Mods to update Health fund payment date to Letter Reminder file
.     V9.12.08  23/10/2009  Ebon Clements CAR 185901
.               Recompiled for RCPPRTCD - Print debtor number
.     V9.12.07  06/10/2009  J.Tan         CAR 191023 
.               Mods to write to Unreconcilied invoice file if inv.not balanced
.     V9.12.06  29/07/2009  J.Tan         CAR 201847
.               Mods Not to generate SX G/L for Suspense not allocated
.     V9.12.05  17/07/2009  Peter Vela    CAR 186118
.               Add tag for PTCNNHII nz
.     V9.12.04  09/07/2009  J.Tan         CAR 199760
.               Recompiled for RCPPRTCD - ED Receipt header/tail
.     V9.12.03  24/06/2009  Jill Habasque CAR 191626
.               Recompiled for RCPPRTCD - printing visit number for deposits
.     V9.12.02  26/05/2009  J.Tan      CAR 197291
.               Recompiled for RCPPRTCD - Credit Card description
.     V9.12.01  13/05/2009  J.Tan      CAR 191023
.               Mods for Change Owner of Debt
.     V9.11.04  25/02/2009  J.Tan      CAR 190909
.               Recompiled for RCPDTETM - initialised RCPDTGLEX
.     V9.11.03  28/01/2009  Peter Vela CAR 188375
.               Recompiled for RCPRTCD - Added PRFA for Inpatient Deposits (97)
.     V9.11.02  06/01/2009  J.Tan      CAR 186072
.               Mods to initialise HF group for NZ private
.     V9.11.01  06/11/2008  Peter McMullen CAR 174725
.               convert internal javascript to W3C standards
.     V9.10.06  11/09/2008  J.Tan      CAR 151983
.               Recompiled for RCPPRTCD - PRFA for Sundry Debtors
.     V9.10.05  09/09/2008  J.Tan      CAR 177958
.               Mods checking Z70 for RCPDE004 to avoid "~~~" in Register code
.     V9.10.04  08/09/2008  J.Tan      CAR 170368
.               Mods checking for header/tail code prior printing receipt
.     V9.10.03  27/08/2008  J.Tan      CAR 176988
.               Mods to clear rcpbdtaf variables (CLRPBT00)
.     V9.10.02  12/08/2008  J.Tan      CAR 175949
.               Recompiled for IBAWEBCD - Printer selection for user id
.     V9.10.01  13/05/2008 J.Tan              CAR 162313
.               Added Deposit status to comdepaf 
.     V9.09.25  26/03/2008  Peter Vela        CAR 163975
.               Recompiled for PRINTHS1
.     V9.09.24  19/03/2008  Peter Vela        CAR 163975
.               Recompiled for PRINTHS1
.     V9.09.23  15/02/2008  Peter Vela        CAR 161662
.               Recompiled for RCPPRTCD
.     V9.09.22  15/02/2008  Peter Vela        CAR 161662
.               Cleared RCPBDT fields before assign to TMPBDT variables
.     V9.09.21  07/02/2008  J.Tan             CAR 134035
.               Fixed index of tmpdteaf file
.     V9.09.20  04/02/2008  Ebon Clements     CAR 152833
.               Added update of deposit type to FINDEP00
.     V9.09.19  10/01/2008  J.Tan             CAR 158980
.               Fixed Outstanding balance amt to include credit notes 
.     V9.09.18  28/12/2007  J.Tan             CAR 134035
.               Mods for Internal Receipts Comments
.     V9.09.17  20/11/2007  J.Tan             CAR 154363
.               Mods G/L extract for Suspense re-allocation
.     V9.09.16  16/11/2007  Ebon Clements     CAR 151659
.               Added RCCNPAYF test to IRCP6600
.     V9.09.15  13/11/2007  Ebon Clements     CAR 152066
.               Fixed test for rec total in CHKDET40
.     V9.09.14  16/10/2007  J.Tan             CAR 151560
.               Mods print position for payment type again for SJOG
.     V9.09.13  15/10/2007  J.Tan             CAR 151560
.               Recompiled for RCPPRTCD - mods to print method of payments
.     V9.09.12  08/10/2007  J.Tan             CAR 151560
.               Recompiled for RCPPRTCD - mods to print method of payments
.     V9.09.11  27/09/2007  J.Tan             CAR 151260
.               Recompiled for RCPPRTCD - mods to printing deposits register
.     V9.09.10  27/09/2007  Ebon Clements     CAR 150704
.               Move zero to FORM12 in RINV0000 as spaces doesn't clear a form
.               Added new patient name tag for receipt reference - IRCP7100
.     V9.09.09  26/09/2007  J.Tan             CAR 150443
.               Fixed Suspense to set ZERO for TMDTALLO for HSYS=2
.     V9.09.08  11/09/2007  Jill Habasque     CAR 149117
.               Added tag for health fund group description
.     V9.09.07  07/09/2007  Ebon Clements     CAR 149260
.               Changed Payee to Payer
.     V9.09.06  07/09/2007  Jill Habasque     CAR 149116
.               Added RCCNORUH - only output registers for user's hospital
.     V9.09.05  22/08/2007  Peter Vela        CAR 147717
.               Added Active Indicator validation @ IRCP3900
.     V9.09.04  06/08/2007  Peter Vela        CAR 146743
.               Asdded check for spaces before display @ IRCP6500
.     V9.09.03  30/07/2007  Ebon Clements     CAR 146302
.               Recompiled for RCPPRTCD - Private Prac deposit PRFA
.     V9.09.02  27/07/2007  J.Tan             CAR 140282
.               Mods for SX G/L Extract
.     V9.09.01  05/07/2007  Ebon Clements     CAR 143757
.               Added multi hospital tests to CDSLTN00
.     V9.08.17  24/05/2007  J.Tan             CAR 141545
.               Fixed Payee name
.     V9.08.16  19/04/2007  J.Tan             CAR 138500
.               Recompiled for RCPPRTCD - for JH Patient's name
.     V9.08.15  26/02/2007 Mike Laming        CAR 133897
.               Increase size of temp Address fields PRNTADDn (from 20 to 35)
.     V9.08.14  20/02/2007 Ebon Clements      CAR 132148
.               Recompiled for RCPPRTCD - Private Prac PRFA
.     V9.08.13  07/02/2007  Davin             CAR 126848
.               Added option 8 - allocate hlth fund receipt to multiple invoices
.     V9.08.12  31/01/2007  Peter Vela     CAR 127930
.               Recompiled for MRTMASFD
.     V9.08.11  15/12/2006 Sandra Barcham     CAR 127625
.               Fix print deposit for JH
.     V9.08.10  13/12/2006  J.Tan             CAR 127625
.               Mods to JH HRN
.     V9.08.09  08/12/2006  J.Tan             CAR 127625
.               Recompiled for RCPPRTCD - JH receipt details
.     V9.08.08  04/12/2006  J.Tan             CAR 126773
.               Recompiled for RCPPRTCD - JH receipt details
.     V9.08.07  20/11/2006 Sandra Barcham    125656
.               Incorrect account codes for suspense register transactions
.     V9.08.06  27/11/2006  Steve Armstrong   CAR 126039
.               Recompiled for changes to SGCHKDIG
.     V9.08.05  16/11/2006  Steve Armstrong   CAR 124160
.               Recompiled for RCPPRTCD (Singapore HRN)
.     V9.08.04  13/11/2006 Peter Vela    CAR SJOG Priority 2 3.4
.               Added input and tag display for hlthfund
.               rcpweb0302001.html and rcpweb0302002.html
.     V9.08.03  27/10/2006 J.Tan         CAR 122690
.               Fixed Outstanding amount for Outpatient/AAE
.     V9.08.02  21/10/2006 J.Tan         CAR 121855
.               Mods to sundary cash sales reg for parameter No FMS set to Yes
.     V9.08.01  16/10/2006 J.Tan         CAR 121629
.               Mods to include discount from receipting
.     V9.07.06  24/08/2006 Peter Vela    CAR 117188
.               Recompiled for RCPPRTCD
.     V9.07.05  24/08/2006 Peter Vela    CAR 113680
.               Fixed assignment of printer code PINV0000
.               Retained value of SELPRINT after call to SETDEF00
.               ADDDET00 PINV0000
.     V9.07.04  11/08/2006 J.Tan         CAR 103365
.               Added tag for cfeetyp
.     V9.07.03  27/07/2006 Peter Vela    CAR 114217
.               Recompiled for RCPPRTCD
.     V9.07.02  17/07/2006 Ebon Clements CAR 103365
.               Added Amount Tendered
.     V9.07.01  05/07/2006 J.Tan         CAR 110774
.               Mods to set hospital id for rcpdteaf
.     V9.06.04  26/05/2006 J.Tan         CAR 105543
.               Mods to initialise rcpdte (CLRPDE00) in WRTDTE00 routine
.     V9.06.03  16/05/2006 Peter Vela    CAR 105533
.               Recompiled for RCPPRTCD
.     V9.06.02  10/05/2006 Peter Vela    CAR 104751
.               Added PRNTADD4 Address Line 4
.     V9.06.01  24/04/2006 J.Tan         CAR 102287
.               Recompiled for RCPPRTCD -added fields for multi hospital details
.     V9.05.03  27/03/2006 Peter Vela    CAR 61299
.               Recompiled for RCPPRTCD
.     V9.05.02  10/03/2006 J.Tan         CAR 90428
.               Fixed GETC0000 for GST Account 
.     V9.05.01  09/03/2006  Ebon Clements CAR 78533
.               Mods for PATCODTM - Hospital specific category codes
.     V9.05.B04 30/01/2006  Ebon Clements CAR 93186
.               Mods for REDIRECT length change. Recompiled for IBAWEBDF
.     V9.05.B03 20/12/2005  Ebon Clements CAR 76341
.               Key length changes for encounter number               
.     V9.05.B02 08/12/2005  J.Tan        CAR 88056
.               Fixed error on Receipt header record doesn't exit
.     V9.04.29  28/11/2005  J.Tan        CAR 86165  
.               Mods to schedule re-print invoice ten seconds after receipting
.     V9.04.28  17/11/2005  J.Tan        CAR 84867
.               Mods to update default printer after allocating register inv.
.     V9.04.27  03/11/2005  Ebon Clements CAR 80992 
.               Removed display of redirect in BEDDIR00                         
.               Exit GTNBK000 if no receipt number. eg Sundry Debtors
.     V9.04.26  26/10/2005  J.Tan        CAR 58658  
.               Added option to reprint invoice after receipting patient billing
.     V9.04.25  19/10/2005 J.Tan         CAR 49925
.               Added RCCNRCLN - no of lines for receipt body
.     V9.04.24  12/10/2005 J.Tan  CAR 67445
.               Recompiled for RCPPRTCD - Anne Caudle receipt layout
.     V9.04.23  04/08/2005  J.Tan        CAR 62750
.               Mods not to use the redefined amount variables
.     V9.04.22  17/08/2005  J.Tan        CAR 63871  
.               Default GST code from Register file for GST Sundry
.     V9.04.21  08.06.2005  J.Tan          CAR 56701
.               Added HIC item key to prihtraf file
.     V9.04.20  31/05/2004 J.Tan         CAR 61641
.               Mods for multi hospital
.     V9.04.19  27/05/2004 J.Tan         CAR 61641
.               Recompiled for RCPPRTCD - added page number
.     V9.04.18  26/05/2004 J.Tan         CAR 61939
.               Mods to write RCDTMDHS
.     V9.04.17  26/05/2004 J.Tan         CAR 61641
.               Recompiled for pCPPRTCD - Ballarat layout multiple page
.     V9.04.16  25/05/2004 Jill Habasque CAR 61939
.               Added hospital selection list
.     V9.04.15  19/05/2004 J.Tan         CAR 61641
.               Recompiled for RCPPRTCD - Ballarat layout
.     V9.04.14  19/05/2004 J.Tan         CAR 61641
.               Recompiled for RCPPRTCD - Ballarat layout
.     V9.04.13  24/05/2005  Mike Laming  CAR 58556
.               1) Recompiled for RCPREGFD/IO - New Index and field REGACTIV
.               2) Change REGSLT00 to use Index 4 & test REGACTIV
.     V9.04.12  24/02/2005 Guomin Fu     CAR 58471
.               Fixed a bug that when using sundry receipt(reg code 95,92 or 94)
.               you can change income account, but money still posted to default
.               income account instead of the new account.
.     V9.04.11  15/12/2004 Lina Vo       CAR 55406
.               Changed Input Receipts for PP Bulk Billing
.     V9.04.10  10/12/2004 Lina Vo       CAR 55406
.               Added Input Receipts for PP Bulk Billing
.     V9.04.09  07/12/2004 Lina Vo       CAR 55180
.               Recompiled for RCPPRTCD.
.     V9.04.08  01/12/2004 Lina Vo       CAR 55641
.               Added extra functionality to Complete Receipt after adding
.               invoice/deposit details when complflg=1 (ALLRCP00).
.               30/11/2004 Guomin Fu      CAR 55180
.            Recompiled for RCPPRTCD ( HFORMAT=4 for Pendlebury Receipt Layout)
.     V9.04.07  16/11/2004 Lina Vo            
.               Recompiled for RCPPRTCD.
.     V9.04.06  08/10/2004 Lina Vo CAR 53878
.               Fixed Suspense Allocation
.     V9.04.05  28/09/2004 Lina Vo CAR 53768
.               Added onclick to set incmpflg=1 to disable Incomplete receipt
.               message in DETTAB00.
.     V9.04.04  17/09/2004 Lina Vo   
.               Put in extra checks for HSYS3 and HSYS6 and to not read files
.               10/09/2004 Lina Vo CAR 53324
.               Fixed Register Display list for Multi Hospital receipting 
.     V9.04.03  30/08/2004 Lina Vo CAR 52920
.               Fixed Patient level receipts to write income account and
.               control account.
.     V9.04.02  26/08/2004 Lina Vo CAR 53012
.               Added extra variables for PRINTHS1 called by RCPPRTCD
.     V9.04.01  19/08/2004 Lina Vo  CAR 52746   
.               Added Multi-Hospital to receipting           
.     V9.03.18  10/08/2004 Lina Vo  CAR 52504   
.               Fixed balance amount for non-banked deposit
.     V9.03.17  05/08/2004 Lina Vo  CAR 51719   
.               Add Input Deposits (Report 6)  
.     V9.03.16  05/07/2004 Lina Vo  CAR 51112   
.               Initialise RCPBDTFD fields in INPRCP00 and RCPDTEFD fields 
.               in ALLRCP00 before use.
.     V9.03.15  07/06/2004 Peter Vela   CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
.     V9.03.14  31/05/04 Lina Vo               
.               Fixed I*C by opening outsitaf              
.     V9.03.13  26/05/04 J.Tan   CAR 50150
.               Recompiled RCPPRTCD for RCH receipting
.     V9.03.12 12/05/2004 Lina Vo       CAR 49813                 
.              Changed Money Order to use same field as Cheque Number.       
.     V9.03.11 23/04/2004 Lina Vo       CAR 49254                 
.              Added FORM8P2 field for RCPPRTCD                              
.     V9.03.10 22/04/2004 Lina Vo       CAR 49107                 
.              Save register default Income account (INCMACCT) for display. 
.     V9.03.09 20/04/2004 Lina Vo       CAR 49159                 
.              Changed Input receipts & Patient level input receipts. 
.              Changed display of outstanding balance for invoice to include
.              non-banked totals.
.     V9.03.08 16/03/2004 Jill Habasque CAR 44081                 
.              Changes to suspense reallocation   
.     V9.03.07 01/03/2004 Lina Vo     CAR 47921                   
.              Removed use of PRIDBTFD & PRIDBTIO.
.     V9.03.06 13/02/2004 Lina Vo                        
.              Mods to ALLRCP10 to write Income & Bank Account for all registers
.     V9.03.05 05/02/2004 Jill Habasque      CAR 44081
.              Added Suspense allocation
.              05/02/2004 Lina Vo            
.              Changed heading in INVITM00 from "Invoice Amount" 
.              to "Item Amount".
.     V9.03.04 13/01/2004 Lina Vo            CAR 44085
.              Added Patient level Input Receipts for selected Invoice.    
.     V9.03.03 13/01/2004 Lina Vo            CAR 44073
.              Added extra tag for System specific Register Selection List.
.     V9.03.02 13/01/2004 Lina Vo             
.              Changed Input Receipts.               
.     V9.03.01 28/11/2003 Lina Vo             
.              Added Input Receipts.               
.              Removed Cash Drawer Enquiry and put in RCPWEB01.PBL
.     V9.03.00 06/11/2003 Lina Vo     CAR44080
.               Created New Server with Report 1 - Cash Drawer Enquiry.
.------------------------------------------------------------------------------
.
.------------------------------------------------------------------------------
. FD Includes
.------------------------------------------------------------------------------
.
          INC       IBAWEBDF
          INC       WEBDATDF
          INC       RSHWEBDF
.
          INC       CHKDIGVR/INC
          INC       APSMASFD/INC            
          INC       BOKRC1FD/INC            
          INC       COMDEPFD/INC      * Deposit file
          INC       DEBDBTFD/INC            
          INC       DEBFDTFD/INC            
          INC       DEBFTHFD/INC            
          INC       DEBITMFD/INC
.
          INC       AAEDE1FD/INC
          INC       EMRVISFD/INC
.
          INC       FMSLMAFD/INC      * Ledger Master Details
          INC       FMSAMAFD/INC
          INC       FMSCSAFD/INC
          INC       FMSCHQFD/INC
          INC       FMSEPTFD/INC
.
          INC       IBAGSTFD/INC      * GST Master
          INC       IBATMDFD/INC            * Template Tail
.
          INC       MRTMASFD/INC
.
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
.
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
.
          INC       RCPCONFD/INC
          INC       RCPCIDFD/INC
          INC       RCPBNKFD/INC
          INC       RCPBDTFD/INC
          INC       RCPDTEFD/INC
          INC       RCPDBPFD/INC
          INC       RCPREGFD/INC
          INC       RCPCMNFD/INC
          INC       RCPSRTFD/INC
          INC       RCPCRSFD/INC
.
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       PATCOMM/INC             * IBA Control file
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC            * Patient Control file
          INC       PATDHEAD/INC
          INC       PATDO1FD/INC
          INC       PATDDHFD/INC
          INC       PATDPTHV/INC
          INC       PATFAPFD/INC
          INC       PATFN1FD/INC
          INC       PATGO1FD/INC
          INC       PATHOSFD/INC
          INC       PATHGPFD/INC
          INC       PATHSPFD/INC      * Common system master file
          INC       PATINVFD/INC
          INC       PATIN1FD/INC
          INC       PATMA1FD/INC
          INC       PATRASFD/INC      * Reassign Debt Table
          INC       PMSVX1FD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATRE1FD/INC
          INC       PATREMFD/INC
          INC       PATPR1FD/INC
          INC       PATUREFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PATFACFD/INC
          INC       PATPFAFD/INC
.
          INC       PRIALSFD/INC
          INC       PRISECFD/INC
          INC       PRIRASFD/INC      * Reassign Debt Table
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCGTD/INC
          INC       PMSECTFD/INC
          INC       PMSCEXFD/INC
.
          INC       PRIBULFD/INC            
          INC       PRICONFD/INC            
          INC       PRIDTRFD/INC            
          INC       PRIPRAFD/INC            * required by COMDEPTM.PBL
          INC       PRIHDBFD/INC            
          INC       PRIHREFD/INC
          INC       PRIHTRFD/INC
          INC       PRIINVFD/INC            
.
.         cgi fields
.
          INC       RCPBNKTD/INC
          INC       RCPBDTTD/INC
          INC       RCPDTETD/INC
          INC       NZPEXTFD/INC
.       
.         temporary receipting tables
.
          INC       TMPBNKFD/INC
          INC       TMPBDTFD/INC
          INC       TMPDTEFD/INC
          INC       TMPDBPFD/INC
.
          INC       TFILEVAR/INC
.
.-----------------------------------------------------------------------------
. Variable Declarations
.-----------------------------------------------------------------------------
.
. CGI Parameters
. **************
ACCNTCOD  DIM       12        * I-58471
LEDGERNO  DIM       2         * I-58471
HLTHFUND  DIM       6
HFUNDGRP  DIM       6
FUTRACTN  DIM       3         * Health Fund Future action code
F12P2     FORM      12.2
.
NEXTPAGE  FORM      1         * Nextpage parameter
UPDTTYPE  DIM       1         * Update Type (A)dd,(U)pdate,(D)elete,Blank=disp
STARTKEY  DIM       3         * Starting Key for search
SYSTEMCD  FORM      2         
PATIENTN  DIM       50        
PAYMDAYS  FORM      3         * No of days for payment
.
PAYMTYPE  DIM       3
PRFANAME  DIM       80
PRFAADD1  DIM       35
PRFAADD2  DIM       35
PRFAADD3  DIM       35
PRFAADD4  DIM       35
PRFAPOST  DIM       8
PRINTFLG  DIM       1        
PRINTINV  DIM       1
PRINTCOD  DIM       6
CRCSFLAG  FORM      1
CANCLMSG  DIM       35
CSEC      DIM       2
CLAIMNUM  DIM       8
ACTNPLAN  DIM       1
ACTNCODE  DIM       3
INITDATE  DIM       8
CLAIMFLG  FORM      1
COMPLFLG  FORM      1
BALANCEA  FORM      12.2      
TOTLCRCS  FORM      12.2
TOTLALLC  FORM      12.2      
TOTALBAL  FORM      12.2      
ISEC      FORM      2
INVLINEN  DIM       3[99]     * Array of Invoice Item Line Number
INVPYAMT  FORM      12.2[99]  * Array of Invoice Payment Amount 
INVPYFLG  DIM       1[99]     * Array of Single Invoice Item Payment Flag
CLAIMKEY  DIM       28[99]    * Array of key to pribulkaf
.
INVOICEN  DIM       12
SUSALLOC  DIM       1
SUSCOUNT  DIM       5
VISITTYP  DIM       1
VALDTYPE  FORM      2
.
INVLSTNO  DIM       40[99]        * list of invoice numbers
INVNOCNT  FORM      3             * count for invlstno
.
.
. Program Variables
. *****************
.
AECNAERH  DIM       6          * AAE Receipt Header Code (templated)
AECNAERT  DIM       6          * AAE Receipt Tail Code (templated)
ACCMTOTL  FORM      12.2       * Accumulative Payment Total
ALLCTOTL  FORM      12.2       * Accumulative Allocated Total
ACCNO     DIM       12
.
CASHDRWR  DIM       6
CASHIERC  DIM       10
CASHTOT   FORM      12.2
CFILEPRE  DIM       3                       * Site Prefix
CSHTFLAG  FORM      1 
CHECKFND  DIM       1 
CHQACCNT  DIM       15
CMDLINE   DIM       50
CURRDATE  DIM       8
COUNTER   FORM      3
CRCPDATE  DIM       8
CURRROW   FORM      3
.
COMFILAF  FILE      ASCII, FIXED=127
COMFILPR  INIT      "COMFIL"
COMFILNM  DIM       8
.
DATEFLD   DATE      8
DIM6      DIM       6
DIM5      DIM       5
DIM8      DIM       8
DIM11     DIM       11
DIM15     DIM       15
DIM16     DIM       16
DIM16A    DIM       16
DIM17     DIM       17
DIM12     DIM       12
DIM23A    DIM       23
DIM40     DIM       40
DOCTCODE  DIM       6
.
FORM3     FORM      3 
FORM5     FORM      5
FORM6     FORM      6 
FORM8     FORM      8 
FORM8P2   FORM      8.2 
FORM12    FORM      12
FORM12P2  FORM      12.2
.
GSTCODE   DIM       6
GOVTAGNC  DIM       6
GROUPCOD  DIM       3                 * Occupational Group
.
HEADTAIL  FORM      1
INCMACCT  DIM       14                * Saved Income Accont
INVPFLAG  FORM      1
.
LASTITEM  FORM      3
LEDNO     DIM       2
LEDNUM    DIM       1
LINK2PRT  FORM      1
LSTINVNO  DIM       8
.
MAXCLNO   FORM      2
MPGEFLAG  FORM      1
MRCNNOHS  FORM      2
MOREMBSI  DIM       1
MULDHOSP  DIM       4
.
NOMONIES  FORM      1
NODAYS    FORM      1
NMPNUMB   DIM       20
WARCOUNT  FORM      2
WEBWARNG  DIM       127[20]
.
OUTSTAMT  FORM      12.2
.
PATNAME   DIM       30                * formatted patient name
PNAM15    DIM       15
PRTPPINV  FORM      1
PRACTICE  DIM       6
PPRAADD1  DIM       30
PPRAADD2  DIM       30
PPRASUBR  DIM       30
PPRAPOST  DIM       4
PRNTADD1  DIM       35
PRNTADD2  DIM       35
PRNTSUBR  DIM       35
PRNTADD4  DIM       35
PRNTPOST  DIM       4
PRNTNAME  DIM       80
PRNTRNAM  DIM       80
PRNTPNAM  DIM       30
PRNTPNUM  DIM       8
PRNTSTRT  FORM      3
PRNTPTYP  DIM       15               * I-55180 (payment type)
PRNTCTYP  DIM       3                * I-55180 (card type)
REFERENC  DIM       20
PATPROVD  DIM       20
.
RECEIPTK  DIM       17
RECEIPTN  DIM       12
REGISTER  DIM       3
REF10     DIM       10
REASMOVE  DIM       3
PATRMOVE  DIM       3
.
SAVURNUM  DIM       8
SAVTINCA  DIM       14
SAVPRGID  DIM       8
SAVREPTN  FORM      2
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SHREGIS   DIM       26                      * short register decsription
SVINVLNE  DIM       3 
SVTMPCNT  DIM       5
SAVEKEY   DIM       39
SAVTDATE  DIM       8 
SAVRDATE  DIM       8 
SAVRTIME  DIM       8 
SAVRWUID  DIM       10
SPRAFLAG  FORM      1
STATUS    DIM       10
.
TMPLTFLG  FORM      1
TAILLENG  FORM      3
TOTPAID   FORM      12.2
TOTAMT    FORM      12.2
TOTAMTPD  FORM      12.2
TRANSNO   FORM      3                  * transaction number
.
UPDTFLAG  FORM      1
VARIABLE  DIM       127
VALDCODE  DIM       3
TPAYAMNT  FORM      12.2
.
XXDPATH   DIM       120
.
. Program Constants
. *****************
CODECR    INIT      "CR"
CODEPP    INIT      "P/P"
CODEIR    INIT      "I/R"
CODESP    INIT      "S/P"
CODESR    INIT      "S/R"
CODEUR    INIT      "U/R"
DOLLAR    INIT      "$"
NBSP      INIT      "&nbsp;"
HFHEADER  INIT      "0000    "
.
BANKED    INIT      "Banked"
CANCELLD  INIT      "Cancelled"
NOTBANKD  INIT      "Not Banked"
.
PATIENT   INIT      "Patient"
HEALTHFD  INIT      "Health Fund"
INSRCOMP  INIT      "Insurance Co."
GOVTDEPT  INIT      "Govt. Dept."
HLTHFDGP  INIT      "Fund Group"
.
TYPECASH  INIT      "Cash"
TYPECHEQ  INIT      "Cheque"
TYPECRDT  INIT      "Credit Card"
TYPEDRCT  INIT      "Direct Deposit"
TYPEDRCD  INIT      "Direct Credit"
TYPEMONY  INIT      "Money Order"
TYPEEFTT  INIT      "EFTPOS"
TYPEBPAY  INIT      "BPAY"
TYPEHCAP  INIT      "Virtual Terminal"
TYPEMCAR  INIT      "Medicare"
+
.-----------------------------------------------------------------------------
.
PRGID     INIT      "RCPWEB03"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "Centralised Cash Receipting Server"
+
.------------------------------------------------------------------------------
.
          CALL      WEBINT00                * Initialise Fifo Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      WEBRED00                * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO          * End Server Process if Option=999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00                * Output File & Write HTML Pg Header
          GOTO      MAIN1000
.
MAIN1100  CALL      CSRCHG00                * Check Credit card surcharge
          GOTO      MAIN1000
. 
MAIN1200  CALL      INPRCP00                * Input Receipts - Bank Header
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
. 
MAIN1300  CALL      ALLRCP00                * Input Receipts - Allocate Receipts
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
. 
MAIN1400  CALL      INVRCP00                * Invoice - Input Receipts 
          BRANCH    EXIT,MAIN1000,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
. 
MAIN1500  CALL      ALLSUS00                * Allocate Suspense Receipts
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
. 
MAIN1600  CALL      DEPRCP00                * Deposit - Input Receipts 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
. 
MAIN1700  CALL      CLMRCP00                * Input Receipt for Claims 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN1800  CALL      FNDRCP00                * Allocate Receipts for Health Fund
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN1900  CALL      LMEDPR00                * Selections of all Medical Practice
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
+
.------------------------------------------------------------------------------
.  Next Page URL
.------------------------------------------------------------------------------
.
NXTPG000  IF        NEXTPAGE=0
            CALL      WINCLS00              * Refresh parent and close window
          ENDIF

          IF        NEXTPAGE=1
            CALL      RDIREC00              * Redirect URL
          ENDIF
.
          IF        NEXTPAGE=2
            CALL      GOBACK00              * Go Back 1 html page
          ENDIF
.
          IF        NEXTPAGE=3
            CALL      DAH20000              * Go Back 2 html pages
          ENDIF
.
          IF        NEXTPAGE=4
            CALL      WINPAR00              * Close Window and Goto New Location
          ENDIF
.
          IF        NEXTPAGE=5
            CALL      GORETN00              * Go Back 1 html page
          ENDIF
.
NXTPG999  RETURN
.------------------------------------------------------------------------------
.  Goes back 1 page
.------------------------------------------------------------------------------
.
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"

          CALL      CLOSHTML
.
GOBACK99  RETURN
+
.-------------------------------------------------------------------------------
.  Goes back x number of pages
.-------------------------------------------------------------------------------
GORETN00  CALL      OPENHTML
          BRANCH    EXIT,GORETN99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
.                            "    self.close();":
                             "    window.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GORETN99  RETURN
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name==#"PopUpFrame#") {":
                             "  redirectParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  opener.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML
WINPAR99  RETURN
.------------------------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------------------------
.
INIT0000  OPEN      WEBSECA1,"websecaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      WEBSECA4,"websecaf"
.
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      COMDEPA1,"comdepaf"
.
          OPEN      MRTMASA1,"mrtmasaf"
.
          OPEN      OUTSITA1,"outsitaf"
.
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATGO1A1,"patgo1af"
          OPEN      PATHGRP1,"pathgrpf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A4,"patwr1af"
          OPEN      PATUREA1,"patureaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          OPEN      FMSLMAA1,"fmslmaaf"
          OPEN      FMSAMAA1,"fmsamaaf"
          OPEN      FMSCSAA1,"fmscsaaf"
          OPEN      FMSCHQA1,"fmschqaf"
          OPEN      FMSEPTA1,"fmseptaf"
.
          OPEN      IBAGSTA1,"ibagstaf"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBASPOL1,"ibaspolf"
.
          OPEN      RCPCMNA1,"rcpcmnaf"
          OPEN      RCPCRSA1,"rcpcrsaf"
          OPEN      RCPCIDA1,"rcpcidaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPBNKA2,"rcpbnkaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPDBPA1,"rcpdbpaf"
          OPEN      RCPREGA1,"rcpregaf"
          OPEN      RCPREGA3,"rcpregaf"
          OPEN      RCPREGA4,"rcpregaf"                                *I-58556
          OPEN      RCPSRTA1,"rcpsrtaf"
.
          OPEN      TMPBNKA1,"tmpbnkaf"
          OPEN      TMPBNKA2,"tmpbnkaf"
          OPEN      TMPBDTA1,"tmpbdtaf"
          OPEN      TMPDTEA1,"tmpdteaf"
          OPEN      TMPDBPA1,"tmpdbpaf"
          OPEN      PATHOSP1,"pathospf"
          OPEN      PATHOSP2,"pathospf"
          OPEN      PATREMD1,"patremdf"
.
          OPEN      PATFAPA1,"patfapaf"
.
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEDP
.
          CALL      OPNOUT00                    * Open outpatient file
.
.-------------------------------------------------------------------------------
. Open and Read the Control file variables
.-------------------------------------------------------------------------------
.
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*244,CHOSPNUM
          CALL      PATDPATH
.
          READ      CONTROLF,THIRTY6;*86,HSYS1,HSYS2,HSYS3,HSYS4,HSYS5,HSYS6:
                                     *106,HFORMAT:
                                     *189,RCCNOVRP,*224,RCCNPAYF:
                                     *238,RCCNLEDG,*243,RCCNCRSR
          READ      CONTROLF,THIRTY3;*200,PRCNRDOC
          READ      CONTROLF,FIFTY9;*60,PTCNUFMS
          READ      CONTROLF,SIXTY;*129,MRCNNOHS
          READ      CONTROLF,TEN;*244,CHOSPNUM,*79,CAPPRVNO
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,NINTY8;*148,PTCNINVB
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,THIRTY6;*221,RCCNORUH
          READ      CONTROLF,HUND12;*110,PTCNPRDC
          READ      CONTROLF,HUND14;*249,PTCNDFUP
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN
          READ      CONTROLF,HUND29;*89,PTCNPPIN
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          IF        HSYS2=1
            OPEN      PATMA1A1,"patma1af"
            OPEN      PATMX1A1,"patmx1af"
            OPEN      PATMI1A1,"patmi1af"
            OPEN      PATRE1A1,"patre1af"
            OPEN      PMSPX2A1,"pmspx2af"
            OPEN      PATVISA1,"patvisaf"
            OPEN      PATINVR1,"patinvrf"
          ENDIF
.
.         Open files for Private Practice
.
.         IF        HSYS3=1
.            OPEN      PRIDEBT1,"pridebtf"
            OPEN      PRIBULK1,"pribulkf"
            OPEN      PRIBULK6,"pribulkf"
            OPEN      PRIDTRA1,"pridtraf"
            OPEN      PRIDTRA4,"pridtraf"
            OPEN      PRIINVO1,"priinvof"
            OPEN      PRIPRAC1,"pripracf"
            OPEN      PRIHDBT1,"prihdbtf"
            OPEN      PRIHREF1,"prihreff"
	    OPEN      PRIHTRA1,"prihtraf"
            OPEN      PRIHTRA3,"prihtraf"
.         ENDIF
.
.         Open files for new account receivable
.
          IF        HSYS6=1
            OPEN      DEBDBTA1,"debdbtaf"
            OPEN      DEBFTHA1,"debfthaf"
            OPEN      DEBFTHA6,"debfthaf"
            OPEN      DEBFTHA7,"debfthaf"
            OPEN      DEBFDTA3,"debfdtaf"
            OPEN      DEBFDTA6,"debfdtaf"
            OPEN      DEBFDTA7,"debfdtaf"
            OPEN      DEBITMA1,"debitmaf"
          ENDIF
.
. open controlf file & template header and details for newer layouts
.
          READ      CONTROLF,THIRTY6;*205,RCCNRCHD,RCCNRCTL
.
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          PACK      CRCPDATE,CCC,CYY,CMM,CDD,SP70
.
          READ      CONTROLF,THIRTY6;*219,RCCNRCLN
          LOAD      MAXCLNO,HFORMAT,RCCNRCLN,RCCNRCLN,ZERO,ZERO,ZERO:
                                    ZERO,ZERO,THIRTY1,ZERO
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNM
.
INIT9999  RETURN
+
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,OPNOUT10
.
          MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OPNOUT20 IF NOT EQUAL

OPNOUT10  MOVE      "out",OSTFILE          * open default prefix of out
          GOTO      OPNOUT90
.
OPNOUT20  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OPNOUT10
.
OPNOUT90  MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
OPNOUT99  RETURN
+
.------------------------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------------------------
.
CLRPAR00  
.         PACK      COMFILNM,COMFILPR,PORT
.         REP       " 0",COMFILNM
.         PREP      COMFILAF,COMFILNM
.
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,STARTKEY
.
          MOVE      ZERO,SYSTEMCD
          MOVE      ZERO,COMPLFLG
          MOVE      SP70,PRINTFLG
          MOVE      SP70,SELPRINT
          MOVE      SP70,PRINTINV
          MOVE      SP70,PRINTCOD
.... I-58471
          MOVE      SP70,ACCNTCOD
          MOVE      SP70,LEDGERNO
          MOVE      SP70,HLTHFUND
          MOVE      SP70,HFUNDGRP
          MOVE      SP70,PTHFHGRP
          MOVE      SP70,PAYMTYPE
....
          MOVE      ONE,NOCOPIES
.
          CALL      CPRCBK00       * clear rcpbnkaf cgi fields
          CALL      CPRCBT00       * clear rcpbdtaf cgi fields
          CALL      CPRCDE00       * clear rcpdteaf cgi fields
.
          MOVE      Z70,MULDHOSP
.
          MOVE      ZERO,ACCMTOTL
          MOVE      ZERO,ALLCTOTL
          MOVE      Z70,PATIENTN
          MOVE      ZERO,BALANCEA
.
          MOVE      ONE,COUNTER             * Initialize Arrays
          WHILE     COUNTER <= 99
            MOVE      SP70,CLAIMKEY[COUNTER]
            MOVE      SP70,INVLINEN[COUNTER]
            MOVE      ZERO,INVPYAMT[COUNTER]
            MOVE      ZERO,INVPYFLG[COUNTER]
            ADD       ONE,COUNTER
          DO
.
          MOVE      SP70,INVOICEN
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,VISITTYP
          MOVE      SP70,SUSALLOC
          MOVE      SP70,SUSCOUNT
.
          MOVE      SP70,INCMACCT
          MOVE      SP70,CLAIMNUM
.
          MOVE      ONE,INVNOCNT
          WHILE     INVNOCNT <=99
            PACK      INVLSTNO[INVNOCNT],SP70
            ADD       ONE,INVNOCNT
          DO
          MOVE      ZERO,INVNOCNT
          MOVE      ZERO,NOMONIES
.
          MOVE      SP70,RECEIPTK
          MOVE      SP70,INITDATE
          MOVE      SP70,ACTNPLAN
          MOVE      SP70,ACTNCODE
          MOVE      SP70,VALDCODE
          MOVE      ZERO,TPAYAMNT
          MOVE      ZERO,VALDTYPE
.
          MOVE      SP70,REASMOVE
          MOVE      SP70,PATRMOVE
          MOVE      ZERO,INVPFLAG
          MOVE      ZERO,WARCOUNT
.
CLRPAR99  RETURN
+
.------------------------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------------------------
.
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rcpbk",QRYNAME
          IF        @EQUAL
            CALL      SPRCB000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "rcpbt",QRYNAME
          IF        @EQUAL
            CALL      SPRCT000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "muldhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MULDHOSP
            PACK      KEY4,MULDHOSP,SP70
            CALL      RDHOSP1
            IF        OVRCD<>1
              MOVE      HOSINDX,RCPDE021
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rcpde",QRYNAME
          IF        @EQUAL
            CALL      SPRCE000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "systemcd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SYSTEMCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patientn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATIENTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "balancea=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BALANCEA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clmkey",QRYNAME
          IF        @EQUAL
            CALL      STCLM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invlne",QRYNAME
          IF        @EQUAL
            CALL      STILN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invamt",QRYNAME
          IF        @EQUAL
            CALL      STIPA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invpay",QRYNAME
          IF        @EQUAL
            CALL      STIPF000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printinv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTINV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "complflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,COMPLFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            MOVE      ZERO,FORM12
            MOVE      QRYDATA,FORM12
            MOVE      FORM12,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            PACK      ADMISSNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VISITTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "susalloc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUSALLOC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suscount=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUSCOUNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accntcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCNTCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "paymtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYMTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ledgerno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEDGERNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hlthfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HLTHFUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hfundgrp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HFUNDGRP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invlstno=",QRYNAME
          IF        @EQUAL
            COMPARE   "99",INVNOCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,INVNOCNT
            PACK      INVLSTNO[INVNOCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rcpcomnt=",QRYNAME
          IF        @EQUAL
            CALL      GETCOM00              * Read in Internal Receipts Comments
          ENDIF
.
          MATCH     "receiptk=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECEIPTK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nomonies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOMONIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actnplan=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNPLAN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actncode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "initdate=",QRYNAME
          IF        @EQUAL
            CALL      SCHDAT00
            PACK      INITDATE,KEY8,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tpayamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TPAYAMNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. SCDAT000 - Setup change date for stepdown
.------------------------------------------------------------
SCHDAT00  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8
          ELSE
            MOVE      QRYDATA,KEY8
          ENDIF
SCHDAT99  RETURN
+
.------------------------------------------------------------
. GETCOM00 - Get Internal Receipts Comments
.------------------------------------------------------------
GETCOM00  PREP      COMFILAF,COMFILNM
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETCOM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCOM90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETCOM80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETCOM10
.
GETCOM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCOM90  MOVE      F3,LASTITEM
          OPEN      COMFILAF,COMFILNM
.
GETCOM99  RETURN
+
.----------------------------------------------------------------
. Set Parameters for key to pribulkaf                       
.----------------------------------------------------------------
STCLM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      CLAIMKEY[F2],QRYDATA,SP70
.
STCLM999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Acc Rec Debtors Invoice Item Line Array
.----------------------------------------------------------------
STILN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      INVLINEN[F2],QRYDATA,SP70
.
STILN999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Acc Rec Debtors Invoice Item Payment Amount Array
.----------------------------------------------------------------
STIPA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          MOVE      QRYDATA,INVPYAMT[F2]
.
STIPA999  RETURN
.
.----------------------------------------------------------------
. Set Parameters for Acc Rec Debtors Invoice Item Payment Flag Array
.----------------------------------------------------------------
STIPF000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      INVPYFLG[F2],QRYDATA,SP70
.
STIPF999  RETURN
.
.------------------------------------------------------------
. Check credit card surcharge
.------------------------------------------------------------
CSRCHG00  CALL      XMLHED00
          BRANCH    EXIT,CSRCHG99
.
          BRANCH    VALDTYPE,CSRCHG10
          PACK      KEY5,ANSC,ANSR,VALDCODE
          CALL      RDCODE1
          BRANCH    OVRCD,CSRCHG90
.
          GOTO      CSRCHG20
.
CSRCHG10  MOVE      "Py",KEY2
          PACK      KEY5,KEY2,VALDCODE
          CALL      RDCODE1
          BRANCH    OVRCD,CSRCHG90
.
CSRCHG20  MOVE      TPAYAMNT,FORM12P2
          MULT      PTCDCRSC,TPAYAMNT
          DIV       "100",TPAYAMNT
          ADD       TPAYAMNT,FORM12P2
.
CSRCHG80  MOVE      PTCDCRSC,F12P2
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F12P2,"|",TPAYAMNT,"|",FORM12P2:
                             "</RETURN_VALUE>"
          GOTO      CSRCHG98
.
CSRCHG90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Credit Card- ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      CSRCHG98
.
CSRCHG98  CALL      XMLEND00
CSRCHG99  RETURN
.------------------------------------------------------------------------------
. Input New Receipt - Bank Details
.------------------------------------------------------------------------------
.
INPRCP00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      INPRCP80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Allocate Receipt & Add Details
          GOTO      INPRCP10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Bank Details
          GOTO      INPRCP20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Bank Details
          GOTO      INPRCP30 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Cancel - Delete All 
          GOTO      INPRCP40 IF EQUAL
.
          GOTO      INPRCP99
.
.****************************************************************
.         Allocate new receipt and Add Bank Header & Details
.****************************************************************
.
INPRCP10  MATCH     RCPBK001,Z70          * No receipt found
          GOTO      INPRCP11 IF EQUAL
          MATCH     RCPBK001,SP70         * No receipt found
          GOTO      INPRCP11 IF EQUAL
          GOTO      INPRCP12
.
INPRCP11  CALL      ALLCRC00              * allocate receipt number
.
INPRCP12  MOVE      RCPBK001,RCPBT002     * Receipt number
          MOVE      RCPBK002,RCPBT001     * Transaction Date
.
          PACK      KEY15,RCPBK001,Z70
          CALL      RSTMBDT1
          CALL      RPTMBDT1
          BRANCH    OVRCD,INPRCP13
.
          MATCH     TMBDRECN,RCPBK001
          GOTO      INPRCP13 IF NOT EQUAL
.
          MOVE      TMBDUNIQ,F3           * additional bank detail record
          ADD       ONE,F3
          MOVE      F3,RCPBT003
          GOTO      INPRCP14
.
INPRCP13  MOVE      ONE,F3                * first bank detail record
          MOVE      F3,RCPBT003
.
INPRCP14  CALL      CLRPBT00              * initialise real fields
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
.
          MOVE      "1",TMBDPTYP          * Default to Cash
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,TMBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,PTCDNHCP
            IF        !@EQUAL
              UNPACK    PTCDNHCP,TMBDPTYP    * payment type
            ENDIF
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,TMBDCDAT
          CLOCK     TIME,TMBDCTIM
          MOVE      USERID,TMBDCUID
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      WRTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INPRCP91
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
          CALL      BREDIR00
          GOTO      INPRCP99
.
.****************************************************************
.         Update Bank Details
.****************************************************************
.
INPRCP20  MATCH     RCPBK001,Z70
          GOTO      INPRCP91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INPRCP91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INPRCP91
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,INPRCP92
          CALL      MVTMBT00              * move Temporary fields into Real
.
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
          CALL      UPTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
          CALL      BREDIR00
          GOTO      INPRCP99
.
.****************************************************************
.         Delete Bank Details
.****************************************************************
.
INPRCP30  MATCH     RCPBK001,Z70
          GOTO      INPRCP91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INPRCP91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INPRCP91
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,INPRCP92
          CALL      DETMBDT1
.         
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
          CALL      BREDIR00
          GOTO      INPRCP99
.
.****************************************************************
.         Cancel - Delete All
.****************************************************************
.
INPRCP40  MATCH     RCPBK001,Z70
          GOTO      INPRCP49 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INPRCP49 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INPRCP41
.
          MATCH     RCPBK004,Z70
          IF        @EQUAL
            MOVE      TMBNCDRW,RCPBK004
            MOVE      TMBNCUID,RCPBK017
          ENDIF
.
          CALL      DETMBNK1
.
INPRCP41  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,INPRCP43
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      INPRCP43 IF NOT EQUAL
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      DETMBDT1
          GOTO      INPRCP41
.
INPRCP43  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,INPRCP46
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      INPRCP46 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      DETMDTE1
          CALL      DELDBP00             * Delete Acc Rec Invoice Items
          GOTO      INPRCP43
.
INPRCP46  PACK      KEY20,RCPBK001,SP70
          CALL      RSRCCMN1
          CALL      RKRCCMN1
          BRANCH    OVRCD,INPRCP49          * end of file
.
          MATCH     RCCMRECN,RCPBK001       * same Receipt Number?
          GOTO      INPRCP49 IF NOT EQUAL
.
          PACK      KEY20,RCCMRECN,RCCMTCNT,RCCMLNNO,SP70
          CALL      DERCCMN1
          GOTO      INPRCP46
.
INPRCP49  MOVE      SP70,RCPBK001
          CALL      BREDIR00           
          MOVE      ZERO,EXIT
          GOTO      INPRCP99
.
.****************************************************************
.         Display Bank Header & Details
.****************************************************************
.
INPRCP80  MATCH     RCPBK001,Z70
          GOTO      INPRCP81 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INPRCP81 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP20
          CALL      RDTMBNK1
          BRANCH    OVRCD,INPRCP81
          GOTO      INPRCP82
.
INPRCP81  CALL      CLRPBK00              * clear bank header fields
          CALL      MVRLBK00              * clear temp file
          CALL      CLRPBT00              * clear bank details fields
          CALL      MVRLBT00              * clear temp file
          UNPACK    SP70,TMBNPRIN,TMBNPRNT
          GOTO      INPRCP88
.
INPRCP82  CALL      GTAMT000             * get accumulative amount
.       
          PACK      KEY15,RCPBK001,RCPBT003,SP20
          CALL      RDTMBDT1
          IF        OVRCD=1
            CALL      CLRPBT00
          ENDIF
          CALL      MVTMBK00              * move temporary fields to real fields
          CALL      MVTMBT00              * move temporary fields to real fields
.
INPRCP88  CALL      UFMS0000              * Check for using fms parameter
          MOVE      "Input Receipts",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,INPRCP99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      INPRCP99
.
.
.         ************ DISPLAY ERROR MESSAGE **********
.
INPRCP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPRCP99
.
INPRCP91  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPRCP99
.
INPRCP92  MOVE      "Bank Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPRCP99
.
INPRCP93  MOVE      "Bank Receipt Detail record already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INPRCP99
.
INPRCP99  RETURN
+
.------------------------------------------------------------------------------
. Check for Hospital using fms parameter
.------------------------------------------------------------------------------
UFMS0000  MATCH     SP70,WBSEHOSP
          IF        !@EQUAL
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE       ZERO,PTCNUFMS
              MOVE       PTHSUFMS,PTCNUFMS    * parameter for Using IBA FMS
            ENDIF
          ENDIF
UFMS9999  RETURN
+
.------------------------------------------------------------------------------
. Get Receipt Accumulative amount
.------------------------------------------------------------------------------
GTAMT000  MOVE      ZERO,ACCMTOTL
          PACK      KEY15,RCPBK001,SP20
          CALL      RSTMBDT1
GTAMT100  CALL      RKTMBDT1
          BRANCH    OVRCD,GTAMT999
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      GTAMT999 IF NOT EQUAL
.
          ADD       TMBDPAMT,ACCMTOTL     * get accumulative total
          GOTO      GTAMT100
.
GTAMT999  RETURN
.------------------------------------------------------------------------------
. Allocate New Receipt Number
.------------------------------------------------------------------------------
.
ALLCRC00  READ      CONTROLF,THIRTY6;*193,HRECPT
          ADD       ONE,HRECPT
          WRITAB    CONTROLF,THIRTY6;*193,HRECPT
          SUB       ONE,HRECPT
.
          MOVE      HRECPT,KEY12
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      ALLCRC00 IF EQUAL
.
          MOVE      HRECPT,KEY12
          CALL      RDTMBNK1
          COMPARE   ZERO,OVRCD
          GOTO      ALLCRC00 IF EQUAL
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,TMBNMHOS
            MOVE      CHOSPNUM,TMBNMDHS
          ENDIF
.
          MOVE      HRECPT,RCPBK001
          MOVE      HRECPT,TMBNRECN
          MOVE      RCPBK002,TMBNTDAT
          MOVE      RCPBK003,TMBNTOTP
          MOVE      RCPBK004,TMBNCDRW
          MOVE      RCPBK007,TMBNTTYP
          MOVE      RCPBK008,TMBNRCOD
          MOVE      RCPBK014,TMBNCHQA
          MOVE      ZERO,TMBNSTAT
          MOVE      SP70,TMBNBDAT
          MOVE      SP70,TMBNBTIM
          MOVE      SP70,TMBNRDAT
          MOVE      SP70,TMBNRTIM
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,TMBNCDAT
          CLOCK     TIME,TMBNCTIM 
          MOVE      USERID,TMBNCUID
          MOVE      SP70,TMBNUDAT
          MOVE      SP70,TMBNUTIM
          MOVE      SP70,TMBNUUID
.
          MOVE      HRECPT,KEY12
          CALL      WRTMBNK1
.
ALLCRC99  RETURN
.------------------------------------------------------------------------------
. Build Redirect
.------------------------------------------------------------------------------
.
BREDIR00  REP       " +",RCPBK001 
          REP       " +",RCPBK004 
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&rcpbk001=",REDIRECT
          APPEND    RCPBK001,REDIRECT
          APPEND    "&rcpbk004=",REDIRECT
          APPEND    RCPBK004,REDIRECT
          APPEND    "&printflg=",REDIRECT
          APPEND    PRINTFLG,REDIRECT
          APPEND    "&selprint=",REDIRECT
          APPEND    SELPRINT,REDIRECT
          APPEND    "&nocopies=",REDIRECT
          APPEND    NOCOPIES,REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          APPEND    "&invoicen=",REDIRECT
          APPEND    INVOICEN,REDIRECT
          APPEND    "&visittyp=",REDIRECT
          APPEND    VISITTYP,REDIRECT
          APPEND    "&hlthfund=",REDIRECT
          APPEND    HLTHFUND,REDIRECT
          APPEND    "&hfundgrp=",REDIRECT
          APPEND    HFUNDGRP,REDIRECT
.
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            REP       " +",SUSCOUNT
            APPEND    "&rcpde003=",REDIRECT
            APPEND    SUSCOUNT,REDIRECT
            APPEND    "&susalloc=",REDIRECT
            APPEND    SUSALLOC,REDIRECT
            REP       "+ ",SUSCOUNT
          ENDIF
          REP       "+ ",RCPBK001 
          REP       "+ ",RCPBK004 
          RESET     REDIRECT
.
BREDIR99  RETURN
+
.------------------------------------------------------------------------------
. Allocate Receipt - Invoices for a Health Fund (replicate rcpweb0303002)
.------------------------------------------------------------------------------
.
FNDRCP00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      FNDRCP80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Allocate Receipt & Add Details
          GOTO      FNDRCP10 IF EQUAL
.
          GOTO      FNDRCP99
.
.****************************************************************
.         Add Register Invoice/Deposit payment Details
.****************************************************************
FNDRCP10  MOVE      ZERO,INVNOCNT
.
FNDRCP20  ADD       ONE,INVNOCNT
          MATCH     SP70,INVLSTNO[INVNOCNT]
          GOTO      FNDRCP30 IF EQUAL       * finished allocating receipt
.
          UNPACK    INVLSTNO[INVNOCNT],DIM8,ANS,RCPDE007,RCPDE006,DIM15
          PACK      RCPDE005,SP4,DIM8       * invoice number
          MOVE      DIM15,BALANCEA          * total invoice amount outstanding
.
          MOVE      RCPBK003,TOTLALLC       * total to be allocated
          ASSIGN    (TOTLALLC-ALLCTOTL),TOTALBAL      * amount remaining
          IF        TOTALBAL > BALANCEA
            MOVE      BALANCEA,RCPDE018          * use total invoice outstanding
          ELSE
            MOVE      TOTALBAL,RCPDE018          * use amount remaining
          ENDIF
.
          CALL      ADDDET00
          BRANCH    EXIT,FNDRCP91
.
          GOTO      FNDRCP20                * process next invoice
.
FNDRCP30  MOVE      "rcpweb03.pbl?reportno=3&template=001",REDIRECT
          CALL      BREDIR00
          GOTO      FNDRCP99
.
.****************************************************************
.         Display Receipt Details
.****************************************************************
.
FNDRCP80  CALL      DISDET00
.
          MOVE      "Allocate Receipts",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,FNDRCP99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      FNDRCP99
.
.
.         ************ DISPLAY ERROR MESSAGE **********
.
FNDRCP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FNDRCP99
.
FNDRCP91  MOVE      "Receipt Header record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FNDRCP99
.
FNDRCP92  MOVE      "Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FNDRCP99
.
FNDRCP93  MOVE      "Receipt Header record already exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FNDRCP99
.
FNDRCP99  CLOSE     COMFILAF,DELETE
          RETURN
+
.------------------------------------------------------------------------------
. Allocate Receipt - Register Invoice/Visit Detail
.------------------------------------------------------------------------------
.
ALLRCP00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      ALLRCP80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Allocate Receipt & Add Details
          GOTO      ALLRCP10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Bank Details
          GOTO      ALLRCP20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Bank Details
          GOTO      ALLRCP30 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Cancel - Delete All
          GOTO      ALLRCP40 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * Finish Receipt       
          GOTO      ALLRCP50 IF EQUAL
.
          MATCH     "P",UPDTTYPE            * Set Non-balanced invoice printer
          GOTO      ALLRCP60 IF EQUAL
          MATCH     "S",UPDTTYPE            * Set Receipt invoice printer
          GOTO      ALLRCP62 IF EQUAL
.
          MATCH     "T",UPDTTYPE            * Internal Receipt Comments
          GOTO      ALLRCP70 IF EQUAL
.
          GOTO      ALLRCP99
.
.****************************************************************
.         Add Register Invoice/Deposit payment Details
.****************************************************************
ALLRCP10  COMPARE   ONE,NOMONIES
          GOTO      ALLRCP18 IF NOT EQUAL
          MOVE      ZERO,EXIT
.
          MATCH     Z70,RCPDE005
          GOTO      ALLRCP99 IF EQUAL
.
          MOVE      ZERO,REGIBACD
          MATCH     RCPDE004,Z70
          IF        !@EQUAL
            PACK      KEY3,RCPDE004,SP10
            CALL      RDREGA1
          ENDIF
.
          MOVE      ZERO,FORM12
          MOVE      RCPDE005,FORM12
          IF        FORM12<>0
            CALL      CREC0000            * Check if invoice is now reconciled
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ALLRCP99
.
ALLRCP18  CALL      ADDDET00
          BRANCH    EXIT,ALLRCP91
.
.         Check if we want to Activate Action Plan
.
          MATCH     "1",ACTNPLAN
          GOTO      ALLRCP19 IF NOT EQUAL
.
          MATCH     SP70,ACTNCODE
          GOTO      ALLRCP19 IF EQUAL
.
          MATCH     Z70,RCPDE005
          GOTO      ALLRCP19 IF EQUAL
.
          OPEN      PATFACT1,"patfactf"
          OPEN      PATPFAA1,"patpfaaf"
          CALL      APLN0000              * Get Future action for an Action plan
.
ALLRCP19  IF        COMPLFLG=1
            CALL      CHKDET00
            IF        EXIT=ZERO
              MOVE      FOUR,NEXTPAGE
              MOVE      "rcpweb03.pbl?reportno=2&template=001",REDIRECT
              GOTO      ALLRCP50
            ENDIF
          ENDIF
          CALL      BREDIR00
          GOTO      ALLRCP99
.
.****************************************************************
.         Update Register Invoice/Deposit payment Details
.****************************************************************
.
ALLRCP20  CALL      UPDDET00
          BRANCH    EXIT,ALLRCP91,ALLRCP92
.
          CALL      BREDIR00
          GOTO      ALLRCP99
.
.****************************************************************
.         Delete Register Invoice/Deposit payment Details
.****************************************************************
.
ALLRCP30  CALL      DELDET00
          BRANCH    EXIT,ALLRCP91,ALLRCP92
.
          CALL      BREDIR00
          GOTO      ALLRCP99
.
.****************************************************************
.         Cancel - Delete All
.****************************************************************
.
ALLRCP40  CALL      CANDET00
.
          MOVE      SP70,RCPBK001
          CALL      BREDIR00           
          MOVE      ZERO,EXIT
          GOTO      ALLRCP99
.
.****************************************************************
.         Finish/Complete Receipt
.****************************************************************
.
ALLRCP50  CALL      IBACLOCK
          CALL      FINDET00
          BRANCH    EXIT,ALLRCP91,ALLRCP93,ALLRCP94,ALLRCP95,ALLRCP96
.
          MOVE      SP70,RCPBK001
          CALL      BREDIR00           
.
.         Check for Warning message if there was an invoice payment
.
          IF        INVPFLAG=1 & WARCOUNT<>0
            CALL      WEBWAR00                * Displaying warning
            MOVE      TWO,EXIT
          ELSE
            MOVE      ZERO,EXIT
          ENDIF
.
          GOTO      ALLRCP99
.
.****************************************************************
.         Setup printer for reprint all non-balanced invoices
.****************************************************************
ALLRCP60  CALL      UPTMBN00
.
          MOVE      PRINTCOD,SCHDPRNT
          MOVE      ONE,SCHDCOPY             * no of copies
.
          MOVE      "RCPWEB03",SETDFPRG
          MOVE      "8",SETDFRPT
          MOVE      SELPRINT,DIM6
          CALL      SETDEF00                 * save default printer
          MOVE      DIM6,SELPRINT
.
          MOVE      ZERO,EXIT
          MOVE      "rcpweb03.pbl?reportno=3&template=001",REDIRECT
          CALL      BREDIR00
          GOTO      ALLRCP99
.
.****************************************************************
.         Setup printer for Print receipt
.****************************************************************
ALLRCP62  MOVE      SELPRINT,SCHDPRNT
          MOVE      ONE,SCHDCOPY             * no of copies
.
          MOVE      "RCPWEB03",SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
          MOVE      ZERO,EXIT
          MOVE      "rcpweb03.pbl?reportno=3&template=001",REDIRECT
          CALL      BREDIR00
          GOTO      ALLRCP99
.
.****************************************************************
.         Internal Receipts Comments
.****************************************************************
.
ALLRCP70  UNPACK    RECEIPTK,RCPBK001,RCPDE003
          CALL      IRCCMN00              * Internal receipt comments
          MOVE      ZERO,EXIT
          GOTO      ALLRCP99
.
.****************************************************************
.         Display Receipt Details
.****************************************************************
.
ALLRCP80  CALL      DISDET00
.
          MOVE      "Allocate Receipts",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,ALLRCP99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
.         ************ DISPLAY ERROR MESSAGE **********
.
ALLRCP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLRCP91  MOVE      "Receipt Header record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLRCP92  MOVE      "Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLRCP93  MOVE      "Receipt Header record already exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLRCP94  MOVE      "Receipt Header/Tail Not Setup. Contact I.B.A. - ",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLRCP95  MOVE      "Register not selected ",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLRCP96  MOVE    "Total amount allocated does not match Total Payment",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLRCP99  CLOSE     COMFILAF,DELETE
          RETURN
+
.-------------------------------------------------------------------------------
.         Activate Action plan
.-------------------------------------------------------------------------------
APLN0000  MATCH     "1",PTCNDFUP
          GOTO      APLN9999 IF NOT EQUAL
.
          MOVE      ZERO,FORM12
          MOVE      RCPDE005,FORM12
          MOVE      FORM12,FORM8
.
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,APLN9999
          COMPARE   THREE,PINVSYS
          GOTO      APLN9999 IF NOT EQUAL * Not Inpatient
.
          PACK      KEY8,PINVADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,APLN9999
.
.         Can only Activate Action Plan - record must not already exist
.
          MOVE      PINVNO,KEY8
          CALL      RDPTPFA1
          COMPARE   ZERO,OVRCD
          GOTO      APLN9999 IF EQUAL             * already exist
.
          MOVE      KEY8,PTPFINVN                 * Invoice Number
          MOVE      INITDATE,PTPFIFDT             * Initiate From date
          PACK      PTPFPLAN,ACTNCODE,SP70        * Action Plan code
          MOVE      USERID,PTPFWEBC               * Web user id created
          PACK      PTPFDATC,CCC,CYY,CMM,CDD
          REP       " 0",PTPFDATC                 * Date created
          CLOCK     TIME,PTPFTIMC                 * Time created
          UNPACK    SP70,PTPFSTAT,PTPFMODR,PTPFWEBU,PTPFDATU,PTPFTIMU
          MOVE      SP70,PTPFSPAR
          CALL      WRPTPFA1
.
.         Activate an Action plan
.
          PACK      KEY6,ACLAIM,ACTNCODE,SP70
          CALL      RDPTFAP1
          BRANCH    OVRCD,APLN9999
.
          MOVE      ZERO,F2
APLN6000  ADD       ONE,F2
          COMPARE   TEN1,F2
          GOTO      APLN9999 IF NOT LESS
.
          MOVE      SP70,FUTRACTN           * future action code
          LOAD      FUTRACTN,F2,PTFPFAC1,PTFPFAC2,PTFPFAC3,PTFPFAC4,PTFPFAC5:
                            PTFPFAC6,PTFPFAC7,PTFPFAC8,PTFPFAC9,PTFPFAC0
          MATCH     SP70,FUTRACTN
          GOTO      APLN6000 IF EQUAL
.
          MOVE      SP70,KEY3           * days from initiate date
          LOAD      KEY3,F2,PTFPDFA1,PTFPDFA2,PTFPDFA3,PTFPDFA4,PTFPDFA5:
                            PTFPDFA6,PTFPDFA7,PTFPDFA8,PTFPDFA9,PTFPDFA0
          MATCH     SP70,KEY3
          GOTO      APLN6000 IF EQUAL
          MOVE      ZERO,PAYMDAYS
          SQUEEZE   KEY3
          MOVE      KEY3,PAYMDAYS      * No of days for initiate date
.
          MOVE      SP70,GROUPCOD
          LOAD      GROUPCOD,F2,PTFPOCG1,PTFPOCG2,PTFPOCG3,PTFPOCG4,PTFPOCG5:
                                PTFPOCG6,PTFPOCG7,PTFPOCG8,PTFPOCG9,PTFPOCG0
.
          MOVE      INITDATE,KEY8       * Initialiate from date
          CALL      WFAC0000            * Write record to Future Action
          GOTO      APLN6000
.
APLN9999  RETURN
+
.-------------------------------------------------------------------------
.         Write record to Future Action file
.-------------------------------------------------------------------------
WFAC0000  CALL      SFDT0000               * Set future action date
          MOVE      KEY8,FADATE
          MOVE      FUTRACTN,FACODE
.
          PACK      KEY19,PINVADM,FADATE,FACODE,SP70
          CALL      RDFACT1
          BRANCH    OVRCD,WFAC3000
.
          MOVE      GROUPCOD,PTFCOCGR      * Occupational group
          PACK      PTFCUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCUDAT
          CLOCK     TIME,PTFCUTIM
          MOVE      USERID,PTFCUUID
          CALL      UPFACT1
          GOTO      WFAC9999
.
WFAC3000  UNPACK    KEY19,DFADMNO,FADATE,FACODE
          MOVE      DFADMNO,FADMNO         * Admission Number
          MOVE      SP70,FACOMM            * Comments
          MOVE      AURNO,PTFCURNO         * U/R number
          MOVE      SP70,PTFCDTCP          * Date completed
          MOVE      GROUPCOD,PTFCOCGR      * Occupational group
          MOVE      AFUNDH,PTFCHFND        * Health Fund
          MOVE      SP70,PTFCSTAT          * Status
          MOVE      PINVNO,PTFCINVN        * Invoice number
          PACK      PTFCCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCCDAT
          CLOCK     TIME,PTFCCTIM
          MOVE      USERID,PTFCCUID
          MOVE      SP70,PTFCUDAT
          MOVE      SP70,PTFCUTIM
          MOVE      SP70,PTFCUUID
          MOVE      SP70,PTFCSPAR
          CALL      WRFACT1
.
WFAC9999  RETURN
+
.-------------------------------------------------------------------------
.         Set up the future date
.-------------------------------------------------------------------------
SFDT0000  UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       PAYMDAYS,JULDAY
.
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      KEY8,CC,YY,MM,DD
          REP       " 0",KEY8
SFDT9999  RETURN
+
.-------------------------------------------------------------------------------
.         Check if invoice is reconciled after input receipt
.-------------------------------------------------------------------------------
CREC0000  MOVE      ZERO,FORM8P2
          MOVE      FORM12,FORM8
          MOVE      FORM8,KEY8
.
          COMPARE   "2",REGIBACD
          GOTO      CREC0100 IF EQUAL      * Private Practice register
          COMPARE   "96",REGIBACD
          GOTO      CREC0200 IF NOT EQUAL  * NOT PP Deposits
.
CREC0100  CALL      RDPRIN1                * Check for Private Practice Inv.
          BRANCH    OVRCD,CREC9999
.
          MOVE      PRINNUMB,KEY8
          PROC      PRIUPURE
          GOTO      CREC9999
.
CREC0200  CALL      RDINV1
          BRANCH    OVRCD,CREC9999
.
          MOVE      FORM12,INVOICEN
          PACK      KEY29,INVOICEN,SP70
          CALL      RSRCDTE3
CREC1000  CALL      RKRCDTE3
          BRANCH    OVRCD,CREC2000
.
          MATCH     INVOICEN,RCDTINVN       * Same invoice number?
          GOTO      CREC2000 IF NOT EQUAL
.
          MATCH     PINVUR,RCDTURNO         * Same U/R number?
          GOTO      CREC1000 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CREC1000
.
          BRANCH    REGIBACD,CREC1200      * Patient billing
          COMPARE   "97",REGIBACD
          GOTO      CREC1000 IF NOT EQUAL  * NOT IP Deposits
.
CREC1200  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CREC1000
          MATCH     "1",RCBNSTAT
          GOTO      CREC1000 IF EQUAL       * Receipt cancelled
.
          ADD       RCDTAMNT,FORM8P2       * payment
          GOTO      CREC1000
.
CREC2000  MOVE      PINVAMT,FORM12P2      * Invoice amount +
          SUB       FORM8P2,FORM12P2      * Payments
          ADD       PTINCRTT,FORM12P2     * Credit Notes +
          ADD       PINVJOUR,FORM12P2     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM12P2     * Journal GST = amount outstanding
.
          CALL      GDET0000              * Get patient's Claim and Health Fund
          CALL      RECN0000              * Update Unreconciled invoice
.
CREC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Get patient's Claim and Health fund
.-------------------------------------------------------------------------------
GDET0000  MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GDET9999

          BRANCH    PINVSYS OF GDET1000,GDET2000,GDET3000
          GOTO      GDET9999
.
.         Emergency invoice
.
GDET1000  OPEN      EMRVISA1,"emrvisaf"
          OPEN      AAEDE1A1,"aaede1af"
          MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GDET9999
.
          CALL      RDDETA1
          BRANCH    OVRCD,GDET9999
.
          MOVE      EMVICOMP,ACLAIM
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          GOTO      GDET9999
.
.         Outpatient invoice
.
GDET2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PINVADM,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,GDET9999
.
          MOVE      OBACOMP,ACLAIM
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          GOTO      GDET9999

GDET3000  MOVE      PINVADM,KEY8
          CALL      RDPTMIS1
.
GDET9999  RETURN
+
.-------------------------------------------------------------------------------
.         If invoice balanced, removed record from Unreconciled invoice file
.         if invoice not balanced, write or update the Unreconciled invoice file
.-------------------------------------------------------------------------------
RECN0000  PACK      KEY8,PINVNO
          CALL      RDPTURE1
.
          CALL      IBACLOCK
          IF        FORM12P2=0
            IF        OVRCD=0
              CALL      DEPTURE1              * Delete Un-reconciled record
            ENDIF
          ELSE
            IF        OVRCD=0
              MOVE      FORM8P2,PTURPAYM      * payment
              MOVE      PTINCRTT,PTURJRNL     * Credit Notes +
              ADD       PINVJOUR,PTURJRNL     * Journals = amount outstanding
              ADD       PTINGSTJ,PTURJRNL     * Journal GST = amount outstanding
              MOVE      FORM12P2,PTUROSTD     * Outstanding amount
              PACK      PTURCDAT,CCC,CYY,CMM,CDD
              REP       " 0",PTURCDAT
              MOVE      CTIMEIS,PTURCTIM
              MOVE      USERID,PTURCUID       * WEB user id
              MATCH     "2",PTURSTAT
              IF        @EQUAL
                MOVE      "0",PTURSTAT        * New status
              ENDIF
              CALL      UPPTURE1              * Update outstanding amount
            ELSE
              CALL      SETU0000              * Setup Unreconciled inv.fields
              CALL      WRPTURE1
            ENDIF
          ENDIF
.
RECN9999  RETURN
+
.------------------------------------------------------------
.         Setup fields for the Unreconciled invoices file
.------------------------------------------------------------
SETU0000  MOVE      PINVNO,PTURINVN
          MOVE      PINVADM,PTURVISN
          MOVE      "0",PTURSTAT                * New status
          MOVE      PINVSYS,PTURSYST
          MOVE      ACLAIM,PTURCLMN
          MOVE      AFUNDH,PTURHFND
          MOVE      AFNDTB,PTURHTAB
.
          MOVE      PINVAMT,PTURINVT     * Invoice total
          MOVE      FORM8P2,PTURPAYM     * payment
.
          MOVE      PTINCRTT,PTURJRNL    * Credit Notes +
          ADD       PINVJOUR,PTURJRNL    * Journals = amount outstanding
          ADD       PTINGSTJ,PTURJRNL    * Journal GST = amount outstanding
          MOVE      FORM12P2,PTUROSTD    * Outstanding amount
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      USERID,PTURCUID        * WEB user id
.
          PACK      PTURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURUDAT
          MOVE      CTIMEIS,PTURUTIM
          MOVE      USERID,PTURUUID        * WEB user id
.
SETU9999  RETURN
+
.------------------------------------------------------------------------------
.         Update Option to reprint for all non-balanced invoices
.------------------------------------------------------------------------------
UPTMBN00  MATCH     RCPBK001,Z70
          GOTO      UPTMBN90 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,UPTMBN90
.
          UNPACK    SP70,TMBNPRIN,TMBNPRNT
          MATCH     "1",PRINTINV
          IF        @EQUAL
            MOVE      "1",TMBNPRIN          * Print all un-balanced invoice
            MOVE      PRINTCOD,TMBNPRNT
          ENDIF
          CALL      UPTMBNK1
          GOTO      UPTMBN99
.
UPTMBN90  MOVE      ONE,EXIT
UPTMBN99  RETURN
+
.------------------------------------------------------------------------------
.         Add Register Invoice/Deposit payment Details
.------------------------------------------------------------------------------
ADDDET00  MATCH     RCPBK001,Z70
          GOTO      ADDDET90 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      ADDDET90 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            CALL      RDRCBNK1
          ELSE
            CALL      RDTMBNK1
          ENDIF
          BRANCH    OVRCD,ADDDET90
.
          MOVE      RCPBK001,RCPDE002     * Receipt number
          PACK      KEY17,RCPBK001,Z70
          CALL      RSTMDTE1
          CALL      RPTMDTE1
          BRANCH    OVRCD,ADDDET30
.
          MATCH     TMDTRECN,RCPBK001
          GOTO      ADDDET30 IF NOT EQUAL
.
          MOVE      TMDTTCNT,F5           * additional detail record
          ADD       ONE,F5
          MOVE      F5,RCPDE003
          GOTO      ADDDET40
.
ADDDET30  MOVE      ONE,F5                * first detail record
          MOVE      F5,RCPDE003
.
ADDDET40  CALL      CLRPDE00              * clear real fields
          CALL      MVRCDE00              * move cgi fields into Real fields
          CALL      MVRLDE00              * move Real fields into Temporary
.
          CALL      GTACCT00              * get income and control accounts
.
          MOVE      TMBNTDAT,TMDTTDAT
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,TMDTCDAT
          CLOCK     TIME,TMDTCTIM
          MOVE      USERID,TMDTCUID
.
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            MOVE      "1",RCDTALLO
            PACK      KEY5,NINTY9,SP70
            CALL      RDSREGA3
            CALL      RDKREGA3
            BRANCH    OVRCD,ADDDET80
.           MATCH     "99",REGISTRG
.           GOTO      ADDDET80 IF NOT EQUAL
.           PACK      TMDTBNKA,REGGENBK          * suspense bank account
            GOTO      ADDDET80
          ENDIF
.
          UNPACK    SP70,TMDTPRIN,TMDTPRNT
          UNPACK    SP70,TMBNPRIN,TMBNPRNT
          MOVE      ZERO,TMDTTAMT
.
          MATCH     "1",PRINTINV
          IF        @EQUAL
            MOVE      "1",TMBNPRIN          * Print all un-balanced invoice
            MOVE      PRINTCOD,TMBNPRNT
            MOVE      "1",TMDTPRIN          * Overwrite reprint individual Inv
            MOVE      PRINTCOD,TMDTPRNT
            CALL      UPTMBNK1
            GOTO      ADDDET80
          ENDIF
          CALL      UPTMBNK1
.
          MATCH     RCPDE035,Z70
          IF        !@EQUAL
            MOVE      RCPDE035,TMDTPRIN
          ENDIF
          MATCH     RCPDE036,Z70
          IF        !@EQUAL
            MOVE      RCPDE036,TMDTPRNT
          ENDIF
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
.
ADDDET80  PACK      KEY17,RCPBK001,RCPDE003,SP70
          CALL      WRTMDTE1
.
          MOVE      TMDTPRNT,SCHDPRNT       * printer code
          MOVE      "RCPWEB03",SETDFPRG     
          MOVE      "8",SETDFRPT          
          MOVE      SELPRINT,DIM6
          CALL      SETDEF00                * save default printer
          MOVE      DIM6,SELPRINT
.
          CALL      WRTDBP00                * Write Acc Rec Debtor Invoice Item
.
          MOVE      ZERO,EXIT
          GOTO      ADDDET99
.
ADDDET90  MOVE      ONE,EXIT
.
ADDDET99  RETURN
+
.------------------------------------------------------------------------------
.         Update Register Invoice/Deposit payment Details
.------------------------------------------------------------------------------
UPDDET00  MATCH     RCPBK001,Z70
          GOTO      UPDDET90 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      UPDDET90 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            CALL      RDRCBNK1
          ELSE
            CALL      RDTMBNK1
          ENDIF
          BRANCH    OVRCD,UPDDET90
.
          PACK      KEY17,RCPBK001,RCPDE003,SP70
          CALL      RDTMDTE1
          BRANCH    OVRCD,UPDDET91
          CALL      MVTMDE00              * move Temporary fields into Real
.
          CALL      MVRCDE00              * move cgi fields into Real fields
          CALL      MVRLDE00              * move Real fields into Temporary
          UNPACK    SP70,TMBNPRIN,TMBNPRNT
          UNPACK    SP70,TMDTPRIN,TMDTPRNT
          MOVE      ZERO,TMDTTAMT
.
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            MOVE      "1",RCDTALLO
            GOTO      UPDDET40
          ENDIF
.
          MATCH     "1",PRINTINV
          IF        @EQUAL
            MOVE      "1",TMBNPRIN          * Print all un-balanced invoice
            MOVE      PRINTCOD,TMBNPRNT
            MOVE      "1",TMDTPRIN          * Overwrite reprint individual Inv
            MOVE      PRINTCOD,TMDTPRNT
            CALL      UPTMBNK1
            GOTO      UPDDET40
          ENDIF
          CALL      UPTMBNK1
.
          MATCH     RCPDE035,Z70
          IF        !@EQUAL
            MOVE      RCPDE035,TMDTPRIN     * print individual invoice
          ENDIF
          MATCH     RCPDE036,Z70
          IF        !@EQUAL
            MOVE      RCPDE036,TMDTPRNT     * printer
          ENDIF
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT     * amount tendered
          ENDIF
.
UPDDET40  CALL      UPTMDTE1
.
          CALL      WRTDBP00                * Write Acc Rec Debtor Invoice Item
          MOVE      ZERO,EXIT
          GOTO      UPDDET99
.
UPDDET90  MOVE      ONE,EXIT
          GOTO      UPDDET99
.
UPDDET91  MOVE      TWO,EXIT
          GOTO      UPDDET99
.
UPDDET99  RETURN
+
.------------------------------------------------------------------------------
.         Delete Register Invoice/Deposit payment Details
.------------------------------------------------------------------------------
DELDET00  MATCH     RCPBK001,Z70
          GOTO      DELDET90 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      DELDET90 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            CALL      RDRCBNK1
          ELSE
            CALL      RDTMBNK1
          ENDIF
          BRANCH    OVRCD,DELDET90
.
          PACK      KEY17,RCPBK001,RCPDE003,SP70
          CALL      RDTMDTE1
          BRANCH    OVRCD,DELDET91
.
          CALL      DETMDTE1
.
          CALL      DELDBP00             * Delete Acc Rec Invoice Items
.
          MOVE      ZERO,EXIT
          GOTO      DELDET99
.
DELDET90  MOVE      ONE,EXIT
          GOTO      DELDET99
.
DELDET91  MOVE      TWO,EXIT
          GOTO      DELDET99
.
DELDET99  RETURN
+
.------------------------------------------------------------------------------
.         Cancel - Delete All
.------------------------------------------------------------------------------
CANDET00  MATCH     RCPBK001,Z70
          GOTO      CANDET99 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      CANDET99 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,CANDET10
.
          MATCH     RCPBK004,Z70
          IF        @EQUAL
            MOVE      TMBNCDRW,RCPBK004
            MOVE      TMBNCUID,RCPBK017
          ENDIF
          CALL      DETMBNK1
.
CANDET10  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,CANDET30
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      CANDET30 IF NOT EQUAL
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      DETMBDT1
.
          GOTO      CANDET10
.
CANDET30  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,CANDET99
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      CANDET99 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      DETMDTE1
          CALL      DELDBP00             * Delete Acc Rec Invoice Items
          GOTO      CANDET30
.
CANDET99  RETURN
+
.------------------------------------------------------------------------------
.         Finish/Complete Receipt
.------------------------------------------------------------------------------
FINDET00  MATCH     RCPBK001,Z70
          GOTO      FINDET90 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      FINDET90 IF EQUAL
.
.         Write Tempory fields to Bank Header File (rcpbnkaf)
.
          PACK      KEY12,RCPBK001
          CALL      RDTMBNK1
          BRANCH    OVRCD,FINDET90
.
          CALL      CTTL0000               * Check allocated total amount
          BRANCH    OVRCD,FINDET94
.
          PACK      KEY12,RCPBK001
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      FINDET91 IF EQUAL
.
          CALL      MVTMBK00
          CALL      WRRCBNK1               * write to real file
          CALL      DETMBNK1               * delete from temporary file
.
.         Write Temporary fields to Bank Detail File (rcpbdtaf)
.
          MOVE      ZERO,TOTLCRCS
FINDET10  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,FINDET18
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      FINDET18 IF NOT EQUAL
.
          MOVE      ZERO,FORM12P2          * Surcharge amount
          CALL      CRSC0000               * Check for Credit card surcharge
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      RDRCBDT1
          IF        OVRCD=0
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      UPRCBDT1
          ELSE
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      WRRCBDT1             * write to real file
          ENDIF
          CALL      DETMBDT1             * delete from temporary file
          CALL      WCSR0000             * Write to Credit card surcharge
          GOTO      FINDET10
.
FINDET18  UNPACK    SP70,REASMOVE,PATRMOVE
          MATCH     "0",RCPBK007   * Check for Patient/Debtor Payment
          IF        @EQUAL
            CALL      RMOV0000     * Get the first Cat 'dm' code with Ind1=R
          ENDIF
          MOVE      ZERO,INVPFLAG  * Invoice payment flag
.
.         Write Temporary fields to Receipt Detail File (rcpdteaf)
.
FINDET20  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,FINDET30
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      FINDET30 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      RDRCDTE1
          IF        OVRCD=0
            CALL      MVTMDE00
            PACK      RCDTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTUDAT           * date updated
            CLOCK     TIME,RCDTUTIM           * time updated
            MOVE      USERID,RCDTUUID         * web user id
            CALL      UPRCDTE1
          ELSE
            CALL      MVTMDE00
            MOVE      SP70,RCDTGLEX
            PACK      RCDTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTCDAT        * date updated
            CLOCK     TIME,RCDTCTIM        * time updated
            MOVE      USERID,RCDTCUID      * web user id
            MATCH     SP70,RCDTREGI
            GOTO      FINDET93 IF EQUAL
            CALL      WRRCDTE1             * write to real file
          ENDIF
          CALL      DETMDTE1               * delete from temporary file
.
          MOVE      TMDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,FINDET20
.
          MOVE      ZERO,FORM12
          MOVE      TMDTINVN,FORM12
          IF        FORM12<>0
            CALL      CREC0000          * Check if invoice is now reconciled
            CALL      URAS0000          * Update Reassign Debt file if necessary
          ENDIF
.
          MOVE      ZERO,PRTPPINV          
          COMPARE   "1",REGIBACD               * Patient receipt
          GOTO      FINDET24 IF EQUAL
          COMPARE   "2",REGIBACD               * PP receipt
          GOTO      FINDET20 IF NOT EQUAL
          MOVE      ONE,PRTPPINV         * for private practice invoice
.
FINDET24  MATCH     "1",PRINTINV
          GOTO      FINDET28 IF NOT EQUAL  * No for printing non-balanced inv.
.
.         Check for Non-balanced invoice only
.
          CALL      IBAL0000               * Invoice Total
          MOVE      PINVAMT,FORM12P2
          IF        REGIBACD=2
            MOVE      PRINITOT,FORM12P2    * Private practice invoice amount
          ENDIF
          ADD       TOTPAID,FORM12P2
          COMPARE   ZERO,FORM12P2
          GOTO      FINDET20 IF EQUAL      * Invoice balanced
.
          CALL      PINV0000               * Print invoice
          GOTO      FINDET20
.
FINDET28  MATCH     "1",TMDTPRIN           * print invoice?
          IF        @EQUAL
            CALL      PINV0000             * Print invoice
          ENDIF
          GOTO      FINDET20
.
FINDET30  CALL      UCRD0000               * Update total surcharge if necessary
.
          PACK      KEY32,RCPBK001,SP70
          CALL      RSTMDBP1
          CALL      RKTMDBP1
          BRANCH    OVRCD,FINDET80
.
          MATCH     RCPBK001,TMDBRECN
          GOTO      FINDET80 IF NOT EQUAL
.
          PACK      KEY32,RCPBK001,TMDBTCNT,TMDBINVN,TMDBILNE,SP70
          CALL      RDRCDBP1
.
          MOVE      TMDBRECN,RCDBRECN
          MOVE      TMDBTCNT,RCDBTCNT
          MOVE      TMDBINVN,RCDBINVN
          MOVE      TMDBILNE,RCDBILNE
          MOVE      TMDBPAMT,RCDBPAMT
          MOVE      SP70,RCDBSPAR
.
          IF        OVRCD=0
            CALL      UPRCDBP1
          ELSE
            CALL      WRRCDBP1             * write to real file
          ENDIF
.
          CALL      DETMDBP1             * delete from temporary file
          GOTO      FINDET30
.
FINDET80  MATCH     "1",PRINTFLG
          IF        @EQUAL
            IF        HFORMAT=8 | HFORMAT=4 | HFORMAT=2 | HFORMAT=1
              MOVE      RCPBK001,RECEIPTN
              CALL      STMPL000
              BRANCH    TMPLTFLG,FINDET92
            ENDIF
.
            MOVE      RCPBK001,RECEIPTN
            CALL      OPNPRINT
            CALL      PRTN0000                * Print Receipt
            CALL      CLSPRINT
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      FINDET99
.
FINDET90  MOVE      ONE,EXIT
          GOTO      FINDET99
.
FINDET91  MOVE      TWO,EXIT
          GOTO      FINDET99
.
FINDET92  MOVE      THREE,EXIT
          GOTO      FINDET99
.
FINDET93  MOVE      FOUR,EXIT
          GOTO      FINDET99
.
FINDET94  MOVE      FIVE,EXIT
          GOTO      FINDET99
.
FINDET99  RETURN
+
.------------------------------------------------------------------------------
.         Check total amount allocated equal to Bank header and detail files
.------------------------------------------------------------------------------
CTTL0000  MOVE      ZERO,FORM12P2
          PACK      KEY15,RCPBK001,SP20
          CALL      RSTMBDT1
CTTL2000  CALL      RKTMBDT1
          BRANCH    OVRCD,CTTL4000
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      CTTL4000 IF NOT EQUAL
.
          ADD       TMBDPAMT,FORM12P2     * get accumulative total
          GOTO      CTTL2000
.
CTTL4000  COMPARE   TMBNTOTP,FORM12P2
          GOTO      CTTL9100 IF NOT EQUAL
.
.         get 1otal Allocated amount
.
          MOVE      ZERO,FORM12P2
          PACK      KEY17,RCPBK001,SP20
          CALL      RSTMDTE1
CTTL6000  CALL      RKTMDTE1
          BRANCH    OVRCD,CTTL8000
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      CTTL8000 IF NOT EQUAL
.
          ADD       TMDTAMNT,FORM12P2     * get allocated total
          GOTO      CTTL6000
.
CTTL8000  COMPARE   FORM12P2,TMBNTOTP
          GOTO      CTTL9100 IF NOT EQUAL
.
CTTL9000  MOVE      ZERO,OVRCD
          GOTO      CTTL9999
.
CTTL9100  MOVE      ONE,OVRCD
          GOTO      CTTL9999
CTTL9999  RETURN
+
.------------------------------------------------------------------------------
.         Set Zero amount of Suspense register to 'Allocate'
.------------------------------------------------------------------------------
RREC0000  PACK      KEY17,RCPDE002,RCPDE003,SP70
          CALL      RDRCDTE1
          BRANCH    OVRCD,RREC9999
.
          COMPARE   ZERO,RCDTAMNT
          GOTO      RREC9999 IF NOT EQUAL
.
          MOVE      "Suspense Receipt has been removed.",WEBTITLE
          MOVE      "1",RCDTALLO
          CALL      UPRCDTE1
.
RREC9999  RETURN
+
.------------------------------------------------------------------------------
.   Schedule Invoice Re-Print be run via Program Scheduler
.------------------------------------------------------------------------------
PINV0000  MOVE      "IBABIL21",SCHDPGID   

          MOVE      "Re-Print Invoice",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE   
          CLOCK     TIME,SCHDTIME   
          CALL      ADDS0000                 * Add 5 seconds to schedule time
.
          MOVE      "S  ",SCHDPRNT           * Spool File
.         MATCH     "1",PRINTINV
.         IF        @EQUAL
            MOVE      PRINTCOD,SCHDPRNT
.         ENDIF
.
          MATCH     "1",TMDTPRIN   
          IF        @EQUAL
            MOVE      TMDTPRNT,SCHDPRNT      * printer code
          ENDIF     
.
          MOVE      ONE,SCHDCOPY             * no of copies
.
          MOVE      "RCPWEB03",SETDFPRG     
          MOVE      "8",SETDFRPT          
          MOVE      SELPRINT,DIM6
          CALL      SETDEF00                 * save default printer
          MOVE      DIM6,SELPRINT
.
          BRANCH    PRTPPINV,PINV2000        * Print Private Practice invoice
.
.         Write Keyin parameters for Extract
.
          MOVE      "2",KEYSTARR[1]     * Batch Key
          MOVE      TMDTINVN,KEYSTARR[2] 
          MOVE      "R",KEYSTARR[3] 
          MOVE      SP1,KEYSTARR[4] 
          MOVE      SP1,KEYSTARR[5] 
          MOVE      FIVE,KEYSTCNT           * Number of Keyins
          GOTO      PINV9000
.
PINV2000  MOVE      "IBAPRI21",SCHDPGID
          MOVE      "3",KEYSTARR[1]      * single invoice
          MOVE      USERID,KEYSTARR[2]   * web user id
.
          MOVE      ZERO,FORM12
          MOVE      TMDTINVN,FORM12
          MOVE      FORM12,FORM8
          MOVE      FORM8,KEY8
.
          SQUEEZE   KEY8
          MOVE      KEY8,KEYSTARR[3]
          MOVE      ANSY,KEYSTARR[4]
          MOVE      SP1,KEYSTARR[5]
          MOVE      SP1,KEYSTARR[6]
          MOVE      SIX,KEYSTCNT           * Number of Keyins
.
PINV9000  CALL      SCHPRO00   * Schedule Extract
.
PINV9999  RETURN
+
.------------------------------------------------------------
.         Add five seconds to schedule time
.------------------------------------------------------------
ADDS0000  MOVE      ZERO,NODAYS             * add to number of days
.
.         get time as seconds
.
          UNPACK    SCHDTIME,CHOUR,ANS,CMIN,ANS,CSEC
          MOVE      CHOUR,KEY2              * Save the original hour
          MOVE      CHOUR,FORM2             * hour as a form 2
          MOVE      FORM2,FORM6             * set up work variable
          MULT      "3600",FORM6            * hours turned into seconds
          MOVE      CMIN,FORM2              * minutes as as form 2
          ASSIGN    (FORM2*60)+FORM6,FORM6
          MOVE      CSEC,ISEC              * get seconds as a form field
          ADD       ISEC,FORM6             * the total seconds of time
          ADD       TEN,FORM6              * Add ten seconds
.
          UNPACK    SP6,CHOUR,CMIN,CSEC
          ASSIGN    (FORM6/3600),IHOUR
.
          MOVE      IHOUR,CHOUR               * move to dim field
          IF        IHOUR>0
            ASSIGN    FORM6-(IHOUR*3600),FORM6  * no. seconds remaining
          ENDIF
.
. check how many minutes
.
          ASSIGN    (FORM6/60),IMIN
          MOVE      IMIN,CMIN               * move to dim field
          IF        IMIN>0
            ASSIGN    FORM6-(IMIN*60),FORM6    * no. seconds remaining
          ENDIF
.
          MOVE      FORM6,ISEC              * move to form field
          MOVE      ISEC,CSEC               * move to dim field
.
          IF        IHOUR>=24
            SUB       "24",IHOUR
            MOVE      IHOUR,CHOUR
          ENDIF
.
          REP       " 0",CHOUR
          REP       " 0",CMIN
          REP       " 0",CSEC
.
          IF        IHOUR=0
            PACK      SCHDTIME,SP3,CMIN,COLON,CSEC
            MATCH     "23",KEY2
            IF        @EQUAL
              MOVE      ONE,NODAYS
            ENDIF
          ELSE
            PACK      SCHDTIME,CHOUR,COLON,CMIN,COLON,CSEC
          ENDIF
.
          COMPARE   ZERO,NODAYS
          GOTO      ADDS9999 IF EQUAL       * Schedule on same day
.
          REP       " 0",SCHDDATE   
          MOVE      SCHDDATE,DATEFLD
          ADD       NODAYS,DATEFLD
          MOVE      DATEFLD,SCHDDATE
.
ADDS9999  RETURN
+
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
.------------------------------------------------------------------------------
.         Display Receipt Details
.------------------------------------------------------------------------------
DISDET00  MATCH     RCPDE004,Z70
          IF        !@EQUAL
            PACK      KEY3,RCPDE004,SP10
            CALL      RDREGA1
            IF        OVRCD=0
              MOVE      REGGENLD,INCMACCT
              MOVE      REGGST,GSTCODE            * gst code
            ENDIF
          ENDIF
.
          MATCH     RCPBK001,Z70
          GOTO      DISDET10 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      DISDET10 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP20
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            CALL      RDRCBNK1
          ELSE
            CALL      RDTMBNK1
          ENDIF
          BRANCH    OVRCD,DISDET10
          GOTO      DISDET20
.
DISDET10  CALL      CLRPBK00              * clear bank header fields
          CALL      MVRLBK00              * clear temp file
          CALL      CLRPDE00              * clear receipt details fields
          CALL      MVRLDE00              * clear temp file
          GOTO      DISDET99
.
.         Get Total Allocated amount
.
DISDET20  MATCH     "1",SUSALLOC
          IF        !@EQUAL
            MOVE      TMBNPRIN,PRINTINV
            MOVE      TMBNPRNT,PRINTCOD
          ENDIF
.
          MOVE      ZERO,ALLCTOTL
          PACK      KEY17,RCPBK001,SP20
          CALL      RSTMDTE1
DISDET30  CALL      RKTMDTE1
          BRANCH    OVRCD,DISDET40
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      DISDET40 IF NOT EQUAL
          ADD       TMDTAMNT,ALLCTOTL     * get allocated total
.
          GOTO      DISDET30
.
DISDET40  MOVE      ZERO,CSHTFLAG
          CALL      GTNBK000              * get non-banked amt for invoice
.
.         Read current Receipt Detail Record
.
          PACK      KEY17,RCPBK001,RCPDE003,SP20
          CALL      RDTMDTE1
          IF        OVRCD=1
            CALL      CLRPDE00            * clear receipt detail fields
            CALL      MVRLDE00            * clear temp file
          ENDIF
.
          PACK      KEY12,RCPBK001,SP20
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            CALL      RDRCBNK1          * re-read header file - overwritten
          ELSE
            CALL      MVTMBK00          * move temporary fields to real fields
          ENDIF
          CALL      MVTMDE00            * move temporary fields to real fields
.
DISDET99  RETURN
+
.------------------------------------------------------------------------------
.  Check if ok to finish receipt
.------------------------------------------------------------------------------
CHKDET00  MOVE      ZERO,EXIT
          PACK      KEY12,RCPBK001,SP20
          CALL      RDTMBNK1
          BRANCH    OVRCD,CHKDET90
.
.         Get Total Allocated amount
.
          MOVE      ZERO,ALLCTOTL
          PACK      KEY17,RCPBK001,SP20
          CALL      RSTMDTE1
CHKDET20  CALL      RKTMDTE1
          BRANCH    OVRCD,CHKDET40
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      CHKDET40 IF NOT EQUAL
.
          ADD       TMDTAMNT,ALLCTOTL     * get allocated total
          GOTO      CHKDET20
.
CHKDET40  COMPARE   ALLCTOTL,TMBNTOTP
          GOTO      CHKDET99 IF EQUAL
.
CHKDET90  MOVE      ONE,EXIT
.
CHKDET99  RETURN
.------------------------------------------------------------------------------
.  Get Income account and Control Account
.------------------------------------------------------------------------------
GTACCT00  PACK      KEY3,TMDTREGI
          CALL      RDREGA1
          BRANCH    OVRCD,GTACCT80
          MOVE      REGHOSP,TMDTMHOS       * Hospital id
          MOVE      REGGST,TMDTGSTC        * GST Code
.
          COMPARE   NINTY9,REGIBACD        * Suspense
          IF        @EQUAL
            MOVE      TWO,TMDTALLO
          ENDIF
.
          COMPARE   TWO,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Other FMS - get Acc.from Reg.
          COMPARE   THREE,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Other FMS - for Integra
          COMPARE   FOUR,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Comma Delimeted
          COMPARE   FIVE,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Integra Extended
.
.... I-58471
          IF        REGIBACD=95 | REGIBACD=94 | REGIBACD=92 | REGIBACD=89
            PACK      TMDTINCA,LEDGERNO,ACCNTCOD,SP10
            GOTO      GTACCT99
          ENDIF
.
          MATCH     SP20,REGGENLD,SP20
          GOTO      GTACCT80 IF EQUAL
          GOTO      GTACCT80 IF EOS
.
          MOVE      REGGENLD,TMDTINCA
          MOVE      REGGENLD,INCMACCT
          CALL      GETC0000              * Get Control Account Details
          PACK      TMDTBNKA,FMLALEDG,FMCSBNK
          GOTO      GTACCT99
.
.         Get Credit and Bank Account from Register record
.
GTACCT20  BRANCH    REGIBACD,GTACCT40,GTACCT40    * Patient billing/Priv.Prac.
.
          COMPARE   "90",REGIBACD           * EMR Deposit
          GOTO      GTACCT40 IF EQUAL
          COMPARE   "91",REGIBACD           * Outpatient Deposit
          GOTO      GTACCT40 IF EQUAL
          COMPARE   "96",REGIBACD           * Private Prac.Deposit
          GOTO      GTACCT40 IF EQUAL
          COMPARE   "97",REGIBACD           * Inpatient Deposit
          GOTO      GTACCT40 IF EQUAL
          COMPARE   "94",REGIBACD           * Sundry Debtor
          GOTO      GTACCT40 IF EQUAL
.
          COMPARE   "92",REGIBACD           * GST Sundry
.         GOTO      GTACCT40 IF EQUAL
          GOTO      GTACCT60 IF EQUAL
.
          COMPARE   "89",REGIBACD           * Credit Card Surcharge
          GOTO      GTACCT60 IF EQUAL
          COMPARE   "95",REGIBACD           * Sundry Cash sales
          GOTO      GTACCT60 IF EQUAL
          COMPARE   "98",REGIBACD           * Internal
          GOTO      GTACCT60 IF EQUAL
          COMPARE   "99",REGIBACD           * Suspense
          GOTO      GTACCT60 IF EQUAL
.
          GOTO      GTACCT80
.
GTACCT40  MOVE      REGGENDB,TMDTINCA       * Debtors Control account as Crd.Acc
          GOTO      GTACCT70
.
GTACCT50  MOVE      REGGENGS,TMDTINCA       * GST Control Account as Crd.Acc.
          GOTO      GTACCT70
.
GTACCT60  MOVE      REGGENLD,TMDTINCA       * Credit account
.
GTACCT70  MOVE      REGGENBK,TMDTBNKA       * Debit account
          GOTO      GTACCT99
.
GTACCT80  MOVE      SP70,TMDTINCA
          MOVE      SP70,TMDTBNKA
          GOTO      GTACCT99
.
GTACCT99 RETURN
+
.------------------------------------------------------------------------------
.  Get Non-Banked Total on current invoice number
.------------------------------------------------------------------------------
GTNBK000  MOVE      ZERO,CASHTOT
.
          BRANCH    CSHTFLAG,GTNBK100
.
.         Get invoice number for current record
.
          PACK      KEY17,RCPBK001,RCPDE003,SP20
          CALL      RDTMDTE1
          BRANCH    OVRCD,GTNBK9999
.
GTNBK100  MATCH     SP70,TMDTINVN          * Exit if no receipt number
          GOTO      GTNBK999 IF EQUAL      * eg Sundry Debtors
.
          PACK      KEY29,TMDTINVN,SP70
          CALL      RSRCDTE3
GTNBK200  CALL      RKRCDTE3
          BRANCH    OVRCD,GTNBK999
.
          MATCH     TMDTINVN,RCDTINVN       * Same invoice number?
          GOTO      GTNBK999 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,GTNBK200
.
          MATCH     "0",RCBNSTAT        * Cash Not banked?
          GOTO      GTNBK200 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,GTNBK200
          COMPARE   "1",REGIBACD               * Patient receipt
          GOTO      GTNBK300 IF EQUAL
          COMPARE   "2",REGIBACD               * PP receipt
          GOTO      GTNBK200 IF NOT EQUAL      * Not a payment receipt
.
GTNBK300  MULT      "-1",RCDTAMNT
          ADD       RCDTAMNT,CASHTOT
          GOTO      GTNBK200
.
GTNBK999  RETURN
+
.****************************************************************
.         ALLSUS00 - Allocate Suspense Payments
.****************************************************************
.
ALLSUS00  MOVE      ZERO,EXIT
          CALL      CLRPBK00              * clear bank header fields
          CALL      CLRPDE00              * clear receipt details fields
          CALL      CLRCPSRT              * clear suspense receipt fields
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      ALLSUS60 IF EQUAL
.
          MATCH     ANSF,UPDTTYPE           * Finish suspense allocation
          IF        @EQUAL
            CALL      IBACLOCK
            CALL      FINSUS00
            GOTO      ALLSUS99
          ENDIF
.
          MATCH     ANSC,UPDTTYPE           * Cancel
          IF        @EQUAL
            CALL      CANDET00
            GOTO      ALLSUS99
          ENDIF
.
          MATCH     ANSR,UPDTTYPE     * remove from Suspense Allocation list
          IF        @EQUAL
            CALL      RREC0000
            GOTO      ALLSUS99
          ENDIF
.
          GOTO      ALLSUS90
.
ALLSUS60  MATCH     RCPBK001,Z70
          GOTO      ALLSUS91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      ALLSUS91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP20
          CALL      RDRCBNK1
          BRANCH    OVRCD,ALLSUS91
.
          MOVE      ZERO,ALLCTOTL
          PACK      KEY17,RCPBK001,SP20
          CALL      RSTMDTE1
ALLSUS70  CALL      RKTMDTE1
          BRANCH    OVRCD,ALLSUS80
.
          MATCH     TMDTRECN,RCPBK001
          GOTO      ALLSUS80 IF NOT EQUAL
.
          ADD       TMDTAMNT,ALLCTOTL     * get allocated total
          GOTO      ALLSUS70
.
ALLSUS80  PACK      KEY17,RCPBK001,RCPDE003,SP70
          CALL      RDRCDTE1
          BRANCH    OVRCD,ALLSUS92
.
          MOVE      "Allocate Receipts",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,ALLRCP99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALLRCP99
.
ALLSUS90  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUS99
.
ALLSUS91  MOVE      "Invalid Receipt Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUS99
.
ALLSUS92  MOVE      "Missing detail record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLSUS99
.
ALLSUS99  RETURN
.****************************************************************
.         Finish allocating a suspense receipt
.****************************************************************
.
FINSUS00  MOVE      ZERO,EXIT
          MATCH     RCPBK001,Z70
          GOTO      FINSUS91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      FINSUS91 IF EQUAL
.
.         Read Bank Header File (rcpbnkaf)
.
          PACK      KEY12,RCPBK001
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      FINSUS91 IF NOT EQUAL
.
.         Read the Suspense record from Receipt Detail File (rcpdteaf)
.
          PACK      KEY17,RCPBK001,RCPDE003,SP70
          CALL      RDRCDTE1
          BRANCH    OVRCD,FINSUS92
.
.         Write to SX G/L extract for suspense register
.
...       COMPARE   FIVE,CFEETYP
...       CALL      GLEX0000 IF EQUAL
.
          PACK      KEY17,RCPBK001,RCPDE003,SP70
          PACK      SAVTDATE,RCDTTDAT,SP70  * save Transaction Date
          PACK      SAVRDATE,RCDTRELD,SP70  * save Release Date
          PACK      SAVRTIME,RCDTRELT,SP70  * save Release Time
          PACK      SAVRWUID,RCDTRELU,SP70  * save Release User Id.
.
          MOVE      "1",KEY1
          CALL      MVSUSP00            * store original Suspense Receipt data
          MOVE      RCDTINCA,SAVTINCA   * Save Income Account
.
          CALL      DERCDTE1            * delete suspense record from "rcpdteaf"
.
.                                           * generate new Transaction Count
          PACK      KEY17,RCPBK001,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD=1
            MOVE      ONE,F5
            GOTO      FINSUS15
          ENDIF
.
          MATCH     RCPBK001,RCDTRECN
          IF        !@EQUAL
            MOVE      ONE,F5
          ELSE
            MOVE      RCDTTCNT,F5
            ADD       ONE,F5
          ENDIF
.                                           * write the original Suspense record
.                                           * to "rcpsrtaf" using next Transact.
.                                           * Number, then reserve this No.
FINSUS15  PACK      KEY17,RCSRRECN,F5,SP20
          CALL      RARCSRT1                * check that key dosen't exist
          IF        OVRCD = 0
            ADD       ONE,F5
            GOTO      FINSUS15
          ENDIF
          MOVE      F5,RCSRTCNT
          PACK      KEY17,RCSRRECN,RCSRTCNT,SP70
          CALL      WRRCSRT1                * write original Suspense Receipt
          ADD       ONE,F5                  * reserve suspense Transaction No.  
.
.                                           * read in temporary DTE record
FINSUS20  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,FINSUS50
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      FINSUS50 IF NOT EQUAL
.
          MOVE      TMDTTCNT,SVTMPCNT       * save temp DTE records Trans.Count
.
FINSUS30  MOVE      F5,TMDTTCNT             * insert new Tranaction Count
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      RARCDTE1
          IF        OVRCD=0 
            ADD       ONE,F5
            GOTO      FINSUS30
          ENDIF
.                                           * process this temporary record
          CALL      MVTMDE00
          IF        HSYS1=4
            MOVE      SAVTINCA,RCDTBNKA     * Income account from Suspense Reg.
          ENDIF
          PACK      RCDTTDAT,SAVTDATE,SP70  * restore original Id. data
          PACK      RCDTRELD,SAVRDATE,SP70
          PACK      RCDTRELT,SAVRTIME,SP70
          PACK      RCDTRELU,SAVRWUID,SP70
          MATCH     SP70,RCDTRELD           * already released ?
          IF        !@EQUAL
            MOVE      "1",RCDTALLO
          ENDIF
.                                           * record info for suspense allocated
          PACK      RCDTSPDT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTSPDT           * date allocated
          CLOCK     TIME,RCDTSPTM           * time allocated
          MOVE      USERID,RCDTSPUI         * web user id who allocated
.
          MOVE      SP70,RCDTGLEX
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT           * Create date updated
          CLOCK     TIME,RCDTCTIM           * Create time updated
          MOVE      USERID,RCDTCUID         * Create web user id
          CALL      WRRCDTE1                * write to real file
          ADD       ONE,F5
.
          MOVE      "2",KEY1
          CALL      MVSUSP00                * copy in "Suspense allocated" data
          PACK      KEY17,RCSRRECN,RCSRTCNT,SP70
          CALL      WRRCSRT1                * write Suspense allocated record
.
          PACK      KEY17,RCPBK001,SVTMPCNT,SP70
          CALL      DETMDTE1                * delete from temporary file
          GOTO      FINSUS20
.
.                                           * Process Acc Received Debtor Inv.
FINSUS50  PACK      KEY32,RCPBK001,SP70
          CALL      RSTMDBP1
          CALL      RKTMDBP1
          BRANCH    OVRCD,FINSUS90
.
          MATCH     RCPBK001,TMDBRECN
          GOTO      FINSUS90 IF NOT EQUAL
.
          MOVE      TMDBTCNT,SVTMPCNT
.
FINSUS70  MOVE      F5,TMDBTCNT
          PACK      KEY32,RCPBK001,TMDBTCNT,TMDBINVN,TMDBILNE,SP70
          CALL      RDRCDBP1
          IF        OVRCD=0 
            ADD       ONE,F5
            GOTO      FINSUS70
          ENDIF
.
          MOVE      TMDBRECN,RCDBRECN
          MOVE      TMDBTCNT,RCDBTCNT
          MOVE      TMDBINVN,RCDBINVN
          MOVE      TMDBILNE,RCDBILNE
          MOVE      TMDBPAMT,RCDBPAMT
          MOVE      SP70,RCDBSPAR
          CALL      WRRCDBP1             * write to real file
          ADD       ONE,F5
.
          PACK      KEY32,RCPBK001,SVTMPCNT,TMDBINVN,TMDBILNE,SP70
          CALL      DETMDBP1             * delete from temporary file
          GOTO      FINSUS50
.
FINSUS90  MATCH     "1",PRINTFLG
          IF        @EQUAL
            IF        HFORMAT=8 | HFORMAT=4 | HFORMAT=2 | HFORMAT=1
              MOVE      RCPBK001,RECEIPTN
              CALL      STMPL000
              BRANCH    TMPLTFLG,FINSUS93
            ENDIF
            MOVE      RCPBK001,RECEIPTN
            CALL      OPNPRINT
            CALL      PRTN0000                * Print Receipt
            CALL      CLSPRINT
          ENDIF
.
          MOVE      SP70,RCPBK001
          CALL      BREDIR00
          MOVE      ZERO,EXIT
          GOTO      FINSUS99
.
FINSUS91  MOVE      "Invalid Receipt Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FINSUS99
.
FINSUS92  MOVE      "Missing Detail Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FINSUS99
.
FINSUS93  MOVE      "Receipt Header/Tail Not Setup. Contact I.B.A. - ",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      FINSUS99
.
FINSUS99  RETURN
.
.*****************************************************************************
.         Setup record for Suspense Receipt table 
.*****************************************************************************
MVSUSP00  CALL      CLRCPSRT                * clear Suspense Receipt record
          MATCH     "1",KEY1
          GOTO      MVSUSP10 IF EQUAL
.
          MOVE      "3",KEY1                * determine suspense record type
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          IF        OVRCD<>1
            COMPARE   "99",REGIBACD
            IF        @EQUAL
              MOVE      "2",KEY1
            ENDIF
          ENDIF
.
MVSUSP10  MOVE      RCDTRECN,RCSRRECN       * setup Suspense Receipt record
          MOVE      RCDTTCNT,RCSRTCNT
          MOVE      RCDTTDAT,RCSRTDAT
          MOVE      KEY1,RCSRRECT           * 1=Original, 2=Residual, 3=Allocatn
          MOVE      RCDTREGI,RCSRREGI
          MOVE      RCDTINVN,RCSRINVN
          MOVE      RCDTVIST,RCSRVIST
          MOVE      RCDTNAME,RCSRNAME
          MOVE      RCDTADD1,RCSRADD1
          MOVE      RCDTADD2,RCSRADD2
          MOVE      RCDTADD3,RCSRADD3
          MOVE      RCDTADD4,RCSRADD4
          MOVE      RCDTPOST,RCSRPCOD
          MOVE      RCDTSFLG,RCSRSFLG
          MOVE      RCDTREFR,RCSRREFR
          MOVE      RCDTAMNT,RCSRAMNT       * original amount on Suspense
.
          PACK      RCSRALDT,CCC,CYY,CMM,CDD
          REP       " 0",RCSRALDT           * Allocated date (same as Create Dat
          MOVE      RCSRALDT,RCSRCDAT       * Create date updated
          CLOCK     TIME,RCSRCTIM           * Create time updated
          MOVE      USERID,RCSRCUID         * Create web user id
.
MVSUSP99  RETURN
.
.*****************************************************************************
.         Write to G/L extract file for re-allocation suspense register
.*****************************************************************************
GLEX0000  CMATCH    "1",RCDTGLEX
          GOTO      GLEX9999 IF NOT EQUAL   * Not Extracted yet
.
          CALL      CLNZPEXT                * clear variables
.
          MOVE      SP70,NZEXSYST           * System
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,GLEX9999          * Invalid register
.
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,GLEX9999
          MATCH     RCBDRECN,RCDTRECN       * Same receipt no?
          GOTO      GLEX9999 IF NOT EQUAL
.
          MOVE      RCDTAMNT,NZEXCAMT
          MULT      "-1",NZEXCAMT
          MOVE      RCDTAMNT,NZEXDAMT
.
          MOVE      RCDTBNKA,NZEXCACC       * Credit account
          MOVE      RCDTINCA,NZEXDACC       * Debit account
.
          MOVE      "5",NZEXRTYP
          CLEAR     NZEXDESC
          APPEND    "Payment",NZEXDESC
          APPEND    SP70,NZEXDESC
          RESET     NZEXDESC
.
          MOVE      RCDTMHOS,NZEXHCOD
          MOVE      RCDTVIST,NZEXADMN
          UNPACK    RCDTINVN,KEY4,NZEXINVN
          PACK      NZEXTRNO,SP1,RCDTTCNT,SP70   * Transaction count
          MOVE      RCDTURNO,NZEXURNO
          MOVE      RCDTTDAT,NZEXTDAT
          REP       " 0",NZEXTDAT
          MOVE      RCDTRECN,NZEXRCNO
          MOVE      RCDTREFR,NZEXPREF
.
          PACK      NZEXBNAM,RCBDPAYD
          MOVE      "5",NZEXPMTH               * Direct Deposit
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          IF        F2=1
            MOVE      "1",NZEXPMTH             * Cash payment
          ENDIF
          IF        F2=2
            MOVE      "2",NZEXPMTH             * Cheque payment
            PACK      NZEXBNAM,RCBDDRAW,SP70
          ENDIF
.
          COMPARE   "3",F2
          GOTO      GLEX4000 IF NOT EQUAL
.
          MOVE      "3",NZEXPMTH               * Credit payment
          PACK      KEY5,ANSC,ANSR,RCBDCRDT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GLEX4000
.
          MATCH     "C",TCINDC1
          GOTO      GLEX4000 IF NOT EQUAL
.
          MOVE      "4",NZEXPMTH         * Merchant card payment
          MOVE      RCBDCRDT,NZEXMCTY    * Card type
          MOVE      SP70,KEY6
          MOVE      TCFORM6,KEY6
          UNPACK    KEY6,ANS,KEY4,KEY1
          MOVE      ".",ANS
          PACK      KEY6,KEY4,ANS,KEY1
          SQUEEZE   KEY6
          MOVE      KEY6,NZEXCOMS        * Commission percentage
.
GLEX4000  MOVE      "00000",NZEXGLBT
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,NZEXCDAT               * date created
          CLOCK     TIME,NZEXCTIM               * time created
          MOVE      PASSCODE,NZEXCUID           * user id
          MOVE      SP70,NZEXSPAR
.
          PACK      KEY30,NZEXADMN,NZEXINVN,NZEXGLBT,NZEXHCOD,NZEXTRNO,SP70
          OPEN      NZPEXTA2,"nzpextaf"
          CALL      WRNZEXT2                     * Write a record
GLEX9999  RETURN
+
.------------------------------------------------------------------------------
. Write Acc Rec Debtor Invoice individual Item payment.
.------------------------------------------------------------------------------
WRTDBP00  PACK      KEY3,TMDTREGI
          CALL      RDREGA1
          BRANCH    OVRCD,WRTDBP99
.
          COMPARE   FIVE,REGIBACD        * Acc Rec Debtor/Sundry Debtor
          GOTO      WRTDBP90 IF NOT EQUAL
.
          MOVE      ONE,COUNTER
.
.         Delete All Invoice Item Payment
.
WRTDBP10  PACK      KEY32,RCPDE002,RCPDE003,SP70
          CALL      RSTMDBP1
          CALL      RKTMDBP1
          BRANCH    OVRCD,WRTDBP20
.
          MATCH     TMDBRECN,RCPDE002
          GOTO      WRTDBP20 IF NOT EQUAL
          MATCH     TMDBRECN,RCPDE002
          GOTO      WRTDBP20 IF NOT EQUAL
.
          PACK      KEY32,RCPDE002,RCPDE003,TMDBINVN,TMDBILNE,SP70
          CALL      DETMDBP1
          GOTO      WRTDBP10
.
WRTDBP20  MATCH     SP10,INVLINEN[COUNTER]
          GOTO      WRTDBP90 IF EQUAL
.
.         Write New Invoice Item Payment
.
          MATCH     "1",INVPYFLG[COUNTER]
          IF        @EQUAL
            MOVE      RCPDE002,TMDBRECN
            MOVE      RCPDE003,TMDBTCNT
            MOVE      RCPDE005,TMDBINVN
            MOVE      INVLINEN[COUNTER],TMDBILNE
            MOVE      INVPYAMT[COUNTER],TMDBPAMT
            MOVE      SP70,TMDBSPAR
            PACK      KEY32,RCPDE002,RCPDE003,TMDBINVN,TMDBILNE,SP70
            CALL      WRTMDBP1
          ENDIF
          ADD       ONE,COUNTER
          GOTO      WRTDBP20
.
WRTDBP90  IF        REGIBACD=98
            CALL      IRCCMN00              * Internal receipt comments
          ENDIF
.
WRTDBP99  RETURN
+
.------------------------------------------------------------
. Internal Receipts Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
IRCCMN00  PACK      KEY20,RCPBK001,RCPDE003,SP70
          CALL      RSRCCMN1
          CALL      RKRCCMN1
          BRANCH    OVRCD,IRCCMN50          * end of file
.
          MATCH     RCCMRECN,RCPBK001       * same Receipt Number?
          GOTO      IRCCMN50 IF NOT EQUAL
          MATCH     RCCMTCNT,RCPDE003       * same Transaction Count?
          GOTO      IRCCMN50 IF NOT EQUAL
.
          PACK      KEY20,RCCMRECN,RCCMTCNT,RCCMLNNO,SP70
          CALL      DERCCMN1
          GOTO      IRCCMN00
.
.         now write the new comments back
.
IRCCMN50  MOVE      RCPBK001,RCCMRECN          * set Receipt Number
          MOVE      RCPDE003,RCCMTCNT          * set Transaction Count
          MOVE      SP70,RCCMLNNO
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,IRCCMN99
.
IRCCMN60  ADD       ONE,F3                    * add to line number
          MOVE      SP70,KEY50
          READ      COMFILAF,SEQ;KEY50
.
          MATCH     SP70,KEY50
          IF        @EQUAL
            IF        F3>=LASTITEM
              GOTO      IRCCMN99
            ELSE
              GOTO      IRCCMN60
            ENDIF
          ENDIF
.
          MOVE      F3,RCCMLNNO
          PACK      RCCMLNDA,KEY50,SP70
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,RCCMCRDT
          CLOCK     TIME,RCCMCRTM
          MOVE      USERID,RCCMCRUD
          UNPACK    SP70,RCCMUPDT,RCCMUPTM,RCCMUPUD
          MOVE      SP70,RCCMSPAR
.
          PACK      KEY20,RCCMRECN,RCCMTCNT,RCCMLNNO,SP70
          CALL      WRRCCMN1
          IF        F3>=LASTITEM
            GOTO      IRCCMN99
          ENDIF
          GOTO      IRCCMN60
.
IRCCMN99  RETURN
+
.------------------------------------------------------------------------------
. Write Acc Rec Debtor Invoice individual Item payment.
.------------------------------------------------------------------------------
DELDBP00  PACK      KEY3,TMDTREGI
          CALL      RDREGA1
          BRANCH    OVRCD,DELDBP99
.
          COMPARE   FIVE,REGIBACD        * Acc Rec Debtor/Sundry Debtor
          GOTO      DELDBP90 IF NOT EQUAL
.
DELDBP10  PACK      KEY32,TMDTRECN,TMDTTCNT,SP70
          CALL      RSTMDBP1
          CALL      RKTMDBP1
          BRANCH    OVRCD,DELDBP90
.
          MATCH     TMDTRECN,TMDBRECN
          GOTO      DELDBP90 IF NOT EQUAL
          MATCH     TMDTTCNT,TMDBTCNT
          GOTO      DELDBP90 IF NOT EQUAL

          PACK      KEY32,TMDBRECN,TMDBTCNT,TMDBINVN,TMDBILNE,SP70
          CALL      DETMDBP1
          GOTO      DELDBP10
.
DELDBP90  IF        REGIBACD=98
            CALL      DECCMN00              * Delete Internal receipt comments
          ENDIF
DELDBP99  RETURN
+
.------------------------------------------------------------------------------
. Delete Internal Receipt comments
.------------------------------------------------------------------------------
DECCMN00  PACK      KEY20,RCPBK001,TMDTTCNT,SP70
          CALL      RSRCCMN1
          CALL      RKRCCMN1
          BRANCH    OVRCD,DECCMN99          * end of file
.
          MATCH     RCCMRECN,RCPBK001       * same Receipt Number?
          GOTO      DECCMN99 IF NOT EQUAL
          MATCH     RCCMTCNT,TMDTTCNT       * same Transaction Count?
          GOTO      DECCMN99 IF NOT EQUAL
.
          PACK      KEY20,RCCMRECN,RCCMTCNT,RCCMLNNO,SP70
          CALL      DERCCMN1
          GOTO      DECCMN00
DECCMN99  RETURN
+
.------------------------------------------------------------------------------
. Input New Receipt for Patient Invoice
.------------------------------------------------------------------------------
.
INVRCP00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      INVRCP80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Allocate Receipt & Add Details
          GOTO      INVRCP10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Bank Details
          GOTO      INVRCP20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Bank Details
          GOTO      INVRCP30 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Cancel - Delete All 
          GOTO      INVRCP40 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * Finish Receipt    
          GOTO      INVRCP50 IF EQUAL
.
          GOTO      INVRCP99
.
.****************************************************************
.         Allocate new receipt and Add Bank Header & Details
.****************************************************************
.
INVRCP10  MOVE      ZERO,UPDTFLAG         * Update tmpdteaf file
          MATCH     RCPBK001,Z70          * No receipt found
          GOTO      INVRCP11 IF EQUAL
          MATCH     RCPBK001,SP70         * No receipt found
          GOTO      INVRCP11 IF EQUAL
          GOTO      INVRCP12
.
INVRCP11  CALL      ALLCRC00              * allocate receipt number
          CALL      WRTDTE00              * write invoice details
          MOVE      ONE,UPDTFLAG          * do not update tmpdteaf file
.
INVRCP12  MOVE      RCPBK001,RCPBT002     * Receipt number
          MOVE      RCPBK002,RCPBT001     * Transaction Date
.
          PACK      KEY15,RCPBK001,Z70
          CALL      RSTMBDT1
          CALL      RPTMBDT1
          BRANCH    OVRCD,INVRCP13
.
          MATCH     TMBDRECN,RCPBK001
          GOTO      INVRCP13 IF NOT EQUAL
.
          MOVE      TMBDUNIQ,F3           * additional bank detail record
          ADD       ONE,F3
          MOVE      F3,RCPBT003
          GOTO      INVRCP14
.
INVRCP13  MOVE      ONE,F3                * first bank detail record
          MOVE      F3,RCPBT003
.
INVRCP14  CALL      CLRPBT00              * initialise real fields
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
.
          MOVE      "1",TMBDPTYP          * Default to Cash
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,TMBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,PTCDNHCP
            IF        !@EQUAL
              UNPACK    PTCDNHCP,TMBDPTYP   * payment type
            ENDIF
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,TMBDCDAT
          CLOCK     TIME,TMBDCTIM
          MOVE      USERID,TMBDCUID
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      WRTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INVRCP91
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
          BRANCH    UPDTFLAG,INVRCP18    * skip update tmpdteaf
.
.         Update Receipt Details file
.
          MOVE      "    1",D5
          PACK      KEY17,RCPBK001,D5,SP20
          CALL      RDTMDTE1
          BRANCH    OVRCD,INVRCP95
          MATCH     RCPDE004,Z70
          IF        !@EQUAL
            MOVE      RCPDE004,TMDTREGI
          ENDIF
          MOVE      RCPDE015,TMDTREFR
          MOVE      RCPDE018,TMDTAMNT
          MOVE      RCPDE019,TMDTDISC
.
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
.
          CALL      GTACCT00              * get income and control accounts
.
          CALL      UPTMDTE1
.
INVRCP18  CALL      BREDIR00
          GOTO      INVRCP99
.
.****************************************************************
.         Update Bank Details
.****************************************************************
.
INVRCP20  MATCH     RCPBK001,Z70
          GOTO      INVRCP91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INVRCP91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INVRCP91
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,INVRCP92
          CALL      MVTMBT00              * move Temporary fields into Real
.
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
          CALL      UPTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
.         Update Receipt Details file
.
          MOVE      "    1",D5
          PACK      KEY17,RCPBK001,D5,SP20
          CALL      RDTMDTE1
          BRANCH    OVRCD,INVRCP95
          MATCH     RCPDE004,Z70
          IF        !@EQUAL
            MOVE      RCPDE004,TMDTREGI
          ENDIF
          MOVE      RCPDE015,TMDTREFR
          MOVE      RCPDE018,TMDTAMNT
          MOVE      RCPDE019,TMDTDISC
.
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
.
          CALL      GTACCT00              * get income and control accounts
.
          CALL      UPTMDTE1
.
          CALL      BREDIR00
          GOTO      INVRCP99
.
.****************************************************************
.         Delete Bank Details
.****************************************************************
.
INVRCP30  MATCH     RCPBK001,Z70
          GOTO      INVRCP91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INVRCP91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INVRCP91
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,INVRCP92
.         
          CALL      DETMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
          CALL      BREDIR00
          GOTO      INVRCP99
.
.****************************************************************
.         Cancel - Delete All
.****************************************************************
.
INVRCP40  MATCH     RCPBK001,Z70
          GOTO      INVRCP49 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INVRCP49 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,INVRCP41
.
          MATCH     RCPBK004,Z70
          IF        @EQUAL
            MOVE      TMBNCDRW,RCPBK004
            MOVE      TMBNCUID,RCPBK017
          ENDIF
.
          CALL      DETMBNK1
.
INVRCP41  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,INVRCP43
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      INVRCP43 IF NOT EQUAL
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      DETMBDT1
          GOTO      INVRCP41
.
INVRCP43  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,INVRCP49
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      INVRCP49 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      DETMDTE1
          GOTO      INVRCP43
.
INVRCP49  MOVE      SP70,RCPBK001
          CALL      BREDIR00           
          MOVE      ZERO,EXIT
          GOTO      INVRCP99
.
.****************************************************************
.         Finish/Complete Receipt
.****************************************************************
.
INVRCP50  MATCH     RCPBK001,Z70
          GOTO      INVRCP91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INVRCP91 IF EQUAL
.
          CALL      IBACLOCK
.
.         Update Receipt Details file
.
          MOVE      "    1",D5
          PACK      KEY17,RCPBK001,D5,SP20
          CALL      RDTMDTE1
          BRANCH    OVRCD,INVRCP95
          MATCH     RCPDE004,Z70
          IF        !@EQUAL
            MOVE      RCPDE004,TMDTREGI
          ENDIF
          MOVE      RCPDE015,TMDTREFR
          MOVE      RCPDE018,TMDTAMNT
          MOVE      RCPDE019,TMDTDISC
.
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
.
          CALL      GTACCT00              * get income and control accounts
.
          CALL      UPTMDTE1
.
.         Write Tempory fields to Bank Header File (rcpbnkaf)
.
          PACK      KEY12,RCPBK001
          CALL      RDTMBNK1
          BRANCH    OVRCD,INVRCP91
.
          PACK      KEY12,RCPBK001
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      INVRCP94 IF EQUAL
.
          CALL      MVTMBK00
          CALL      WRRCBNK1               * write to real file
          CALL      DETMBNK1               * delete from temporary file
.
          UNPACK    SP70,REASMOVE,PATRMOVE
          MATCH     "0",RCPBK007   * Check for Patient/Debtor Payment
          IF        @EQUAL
            CALL      RMOV0000     * Get the first Cat 'dm' code with Ind1=R
          ENDIF
          MOVE      ZERO,INVPFLAG  * Invoice payment flag
.
.         Write Temporary fields to Bank Detail File (rcpbdtaf)
.
          MOVE      ZERO,TOTLCRCS
INVRCP51  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,INVRCP52
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      INVRCP52 IF NOT EQUAL
.
          MOVE      ZERO,FORM12P2          * Surcharge amount
          CALL      CRSC0000               * Check for Credit card surcharge
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      RDRCBDT1
          IF        OVRCD=0
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      UPRCBDT1
          ELSE
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      WRRCBDT1             * write to real file
          ENDIF
          CALL      DETMBDT1             * delete from temporary file
          CALL      WCSR0000             * Write to Credit card surcharge
          GOTO      INVRCP51
.
.         Write Temporary fields to Receipt Detail File (rcpdteaf)
.
INVRCP52  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,INVRCP53
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      INVRCP53 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      RDRCDTE1
          IF        OVRCD=0
            CALL      MVTMDE00
            PACK      RCDTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTUDAT           * date updated
            CLOCK     TIME,RCDTUTIM           * time updated
            MOVE      USERID,RCDTUUID         * web user id
            CALL      UPRCDTE1
          ELSE
            CALL      MVTMDE00
            MOVE      SP70,RCDTGLEX
            PACK      RCDTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTCDAT        * date updated
            CLOCK     TIME,RCDTCTIM        * time updated
            MOVE      USERID,RCDTCUID      * web user id
            CALL      WRRCDTE1             * write to real file
          ENDIF
          CALL      DETMDTE1               * delete from temporary file
.
          MOVE      TMDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,INVRCP52
.
          MOVE      ZERO,FORM12
          MOVE      TMDTINVN,FORM12
          IF        FORM12<>0
            CALL      CREC0000          * Check if invoice is now reconciled
            CALL      URAS0000          * Update Reassign Debt file if necessary
          ENDIF
          GOTO      INVRCP52          
.
INVRCP53  CALL      UCRD0000               * Update total surcharge if necessary
          PACK      KEY32,RCPBK001,SP70
          CALL      RSTMDBP1
          CALL      RKTMDBP1
          BRANCH    OVRCD,INVRCP59
.
          MATCH     RCPBK001,TMDBRECN
          GOTO      INVRCP59 IF NOT EQUAL
.
          PACK      KEY32,RCPBK001,TMDBTCNT,TMDBINVN,TMDBILNE,SP70
          CALL      RDRCDBP1
.
          MOVE      TMDBRECN,RCDBRECN
          MOVE      TMDBTCNT,RCDBTCNT
          MOVE      TMDBINVN,RCDBINVN
          MOVE      TMDBILNE,RCDBILNE
          MOVE      TMDBPAMT,RCDBPAMT
          MOVE      SP70,RCDBSPAR
.
          IF        OVRCD=0
            CALL      UPRCDBP1
          ELSE
            CALL      WRRCDBP1             * write to real file
          ENDIF
.
          CALL      DETMDBP1             * delete from temporary file
          GOTO      INVRCP53
.
INVRCP59  MATCH     "1",PRINTFLG
          IF        @EQUAL
            IF        HFORMAT=8 | HFORMAT=4 | HFORMAT=2 | HFORMAT=1
              MOVE      RCPBK001,RECEIPTN
              CALL      STMPL000
              BRANCH    TMPLTFLG,INVRCP96
            ENDIF
.
            MOVE      RCPBK001,RECEIPTN
            CALL      OPNPRINT
            CALL      PRTN0000                * Print Receipt
            CALL      CLSPRINT
          ENDIF
.
          MOVE      SP70,RCPBK001
          CALL      BREDIR00
.
.         Check for Warning message if there was an invoice payment
.
          IF        INVPFLAG=1 & WARCOUNT<>0
            CALL      WEBWAR00                * Displaying warning
            MOVE      TWO,EXIT
          ELSE
            MOVE      ZERO,EXIT
          ENDIF
          GOTO      INVRCP99
.
.****************************************************************
.         Display Bank Header & Details
.****************************************************************
.
INVRCP80  MATCH     RCPBK001,Z70
          GOTO      INVRCP81 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      INVRCP81 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP20
          CALL      RDTMBNK1
          BRANCH    OVRCD,INVRCP81
.
          MOVE      ONE,CSHTFLAG
          MOVE      INVOICEN,TMDTINVN
          CALL      GTNBK000              * get non-banked amt for invoice
.
          MOVE      "    1",RCPDE001
          PACK      KEY17,RCPBK001,RCPDE001,SP20
          CALL      RDTMDTE1
          IF        OVRCD=1
            CALL      CLRPDE00            * clear receipt detail fields
            CALL      MVRLDE00            * clear temp file
          ENDIF
          GOTO      INVRCP82
.
INVRCP81  MOVE      ONE,CSHTFLAG
          MOVE      INVOICEN,TMDTINVN
          CALL      GTNBK000              * get non-banked amt for invoice
.
          CALL      CLRPBK00              * clear bank header fields
          CALL      MVRLBK00              * clear temp file
          CALL      CLRPBT00              * clear bank details fields
          CALL      MVRLBT00              * clear temp file
          CALL      CLRPDE00              * clear receipt detail fields
          CALL      MVRLDE00              * clear temp file
          GOTO      INVRCP88
.
.         Calculate Accumulative Total
.
INVRCP82  MOVE      ZERO,ACCMTOTL
          PACK      KEY15,RCPBK001,SP20
          CALL      RSTMBDT1
INVRCP83  CALL      RKTMBDT1
          BRANCH    OVRCD,INVRCP84
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      INVRCP84 IF NOT EQUAL
.
          ADD       TMBDPAMT,ACCMTOTL     * get accumulative total
          GOTO      INVRCP83
.       
INVRCP84  PACK      KEY15,RCPBK001,RCPBT003,SP20
          CALL      RDTMBDT1
          IF        OVRCD=1
            CALL      CLRPBT00
          ENDIF
          CALL      MVTMBK00              * move temporary fields to real fields
          CALL      MVTMBT00              * move temporary fields to real fields
          CALL      MVTMDE00              * move temporary fields to real fields
.
INVRCP88  CALL      UFMS0000              * Check for using fms parameter
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,INVRCP89
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
. 
INVRCP89  MOVE      "Input Receipts",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,INVRCP99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
.
.         ************ DISPLAY ERROR MESSAGE **********
.
INVRCP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
INVRCP91  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
INVRCP92  MOVE      "Bank Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
INVRCP93  MOVE      "Bank Receipt Detail record already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
INVRCP94  MOVE      "Receipt Header record already exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
INVRCP95  MOVE      "Receipt Details does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
INVRCP96  MOVE      "Receipt Header/Tail Not Setup. Contact I.B.A. - ",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      INVRCP99
.
INVRCP99  RETURN
+
.------------------------------------------------------------
. Display Warnings
.------------------------------------------------------------
WEBWAR00  CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                              "<script type=#"text/javascript#">{ "
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,FORM2
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[FORM2],"#");",012
          ADD       ONE,FORM2
          COMPARE   FORM2,WARCOUNT
          GOTO      WEBWAR20 IF LESS
          GOTO      WEBWAR10
.
WEBWAR20  WRITE     HTMLFILE;"}</script>"
.
          IF        NEXTPAGE=1
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                               " location.href=#"",REDIRECT,"#";":
                               "}":
                               "</script>"
            GOTO      WEBWAR90
          ENDIF
.
          IF        NEXTPAGE=4
            WRITE     HTMLFILE;"<script type=#"text/javascript#">{":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#");}":
                             " else {":
                             "  location.href=#"",REDIRECT,"#"}":
                             "}":
                             "</script>"
            GOTO      WEBWAR90
          ENDIF
.
WEBWAR90  CALL      CLOSHTML
          MOVE      TWO,EXIT
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBWAR99  RETURN
+
.------------------------------------------------------------------------------
.         Get the first Cat 'dm' code with Ind1=R
.------------------------------------------------------------------------------
RMOV0000  MOVE      ZERO,EXIT
          MOVE      "dm",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
RMOV1000  CALL      RDKCODE1
          BRANCH    OVRCD,RMOV9000
.
          MATCH     KEY2,TCODE
          GOTO      RMOV9000 IF NOT EQUAL
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            MATCH     "P",TCINDC1
            GOTO      RMOV2000 IF EQUAL    * Patient Reason for Debt Movement
          ENDIF
.
          MATCH     "R",TCINDC1
          GOTO      RMOV1000 IF NOT EQUAL
.
          MOVE      ACODE,REASMOVE         * Reson for Debt Movement
          GOTO      RMOV1000
.
RMOV2000  MOVE      ACODE,PATRMOVE         * Reson for Debt Movement (Patient)
          GOTO      RMOV1000
.
RMOV9000  
.         CLEAR     DIM127
.         APPEND    "Warning: Code Cat dm Ind1=R not Setup - ",DIM127
.         APPEND    "Please use Reassign Debt to manually adjust.",DIM127
.         APPEND    SP70,DIM127
.         RESET     DIM127
.         ADD       ONE,WARCOUNT
.         MOVE      DIM127,WEBWARNG[WARCOUNT]
RMOV9999  RETURN
+
.------------------------------------------------------------------------------
.         Set up a warning message for negative Patient Portion
.------------------------------------------------------------------------------
SWRN0000  CLEAR     DIM127
          APPEND    "Warning: Patient Portion is negative for Invoice: ",DIM127
          APPEND    PINVNO,DIM127
          APPEND    " Please use Reassign Debt to adjust.",DIM127
          APPEND    SP70,DIM127
          RESET     DIM127
          ADD       ONE,WARCOUNT
          MOVE      DIM127,WEBWARNG[WARCOUNT]
.
SWRN9999  RETURN
+
.------------------------------------------------------------------------------
.         Update Reassign debt if necessary
.------------------------------------------------------------------------------
URAS0000  MATCH     "0",RCPBK007           * Check for Patient/Debtor Payment
          GOTO      URAS9999 IF NOT EQUAL
.
          MOVE      ONE,INVPFLAG           * Invoice payment flag
          MOVE      TMDTINVN,FORM12
          MOVE      FORM12,FORM8
          MOVE      FORM8,KEY8
.
          COMPARE   TWO,REGIBACD
          GOTO      URAS0800 IF NOT EQUAL  * Not a Private Practice Register
.
          CALL      RDPRIN1
          BRANCH    OVRCD,URAS9999         * Invalid invoice number
.
          MATCH     SP70,REASMOVE
          GOTO      URAS9999 IF EQUAL      * Reason for Debt Movement not setup
.
          OPEN      PRIRASA1,"prirasaf"
.
          MOVE      FORM12P2,OUTSTAMT
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,F1
.
          MOVE      ONE,FORM2
          PACK      KEY10,PRINNUMB,Z70
          CALL      RSPRRAS1
URAS0100  CALL      RPPRRAS1
          BRANCH    OVRCD,URAS0200
.
          MATCH     PRINNUMB,PRRAINVN      * Same invoice ?
          GOTO      URAS0200 IF NOT EQUAL
.
          IF        F1=0
            MOVE      PRRACNTN,FORM2
          ENDIF
.
          ADD       ONE,F1
          MATCH     "1",PRRADELE       * Deleted record ?
          GOTO      URAS0100 IF EQUAL
.
          MOVE      PRRAPPOR,FORM12P2  * Save current Patient portion
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            COMPARE   TWO,PINVTYP
            GOTO      URAS0200 IF EQUAL    * patient invoice
          ENDIF
          MOVE      PTRARMOV,REASMOVE  * save existing reason for debt movement
.
URAS0200  COMPARE   ZERO,FORM12P2
          GOTO      URAS9999 IF EQUAL       * No patient portion
.
URAS0300  MOVE      FORM2,PRRACNTN
          PACK      KEY10,PINVNO,PRRACNTN,SP70
          CALL      RDPRRAS1
          IF        OVRCD=0
            ADD       ONE,FORM2
            GOTO      URAS0300
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD  * write a new "prirasaf" record
          REP       " 0",CURRDATE
          MOVE      FORM2,PRRACNTN
          MOVE      PINVNO,PRRAINVN
          MOVE      FORM2,PRRACNTN
          MOVE      OUTSTAMT,PRRAOUST       * Outstanding amount
          MOVE      REASMOVE,PRRARMOV       * Reason of Movement
          MOVE      SP70,PRRADBAG           * Debt Collection Agency (code)
          SUB       TMDTAMNT,FORM12P2
          MOVE      FORM12P2,PRRAPPOR       * Patient portion=Outstanding amt
          IF        PRRAPPOR<0
            CALL      SWRN0000              * Set Warning message
          ENDIF
          MOVE      "0",PRRADELE            * set Deleted flag off
          CALL      IBACLOCK
          MOVE      CURRDATE,PRRACDAT
          MOVE      CTIMEIS,PRRACTIM
          MOVE      WBSEUID,PRRACUID        * WEB user id
.
          MOVE      CURRDATE,PRRAUDAT
          MOVE      CTIMEIS,PRRAUTIM
          MOVE      WBSEUID,PRRAUUID        * WEB user id
          CALL      WRPRRAS1
.
          GOTO      URAS9999
.
URAS0800  COMPARE   ONE,REGIBACD
          GOTO      URAS9999 IF NOT EQUAL  * Not a Patient Billing Register
.
          CALL      RDINV1
          BRANCH    OVRCD,URAS9999         * Invalid invoice number
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        PINVTYP=2
              MOVE      PATRMOVE,REASMOVE  * Patient Reson for Debt Movement
            ENDIF
          ENDIF
.
          MATCH     SP70,REASMOVE
          GOTO      URAS9999 IF EQUAL      * Reason for Debt Movement not setup
.
          OPEN      PATRASA1,"patrasaf"
.
          MOVE      FORM12P2,OUTSTAMT
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,F1
.
          MOVE      ONE,FORM2
          PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
URAS1000  CALL      RPPTRAS1
          BRANCH    OVRCD,URAS2000
.
          MATCH     PINVNO,PTRAINVN      * Same invoice ?
          GOTO      URAS2000 IF NOT EQUAL
.
          IF        F1=0
            MOVE      PTRACNTN,FORM2
          ENDIF
.
          ADD       ONE,F1
          MATCH     "1",PTRADELE       * Deleted record ?
          GOTO      URAS1000 IF EQUAL
.
          MOVE      PTRAPPOR,FORM12P2  * Save current Patient portion
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            COMPARE   TWO,PINVTYP
            GOTO      URAS2000 IF EQUAL
          ENDIF
          MOVE      PTRARMOV,REASMOVE  * save existing reason for debt movement
.
URAS2000  COMPARE   ZERO,FORM12P2
          GOTO      URAS9999 IF EQUAL       * No patient portion
.
URAS3000  MOVE      FORM2,PTRACNTN
          PACK      KEY10,PINVNO,PTRACNTN,SP70
          CALL      RDPTRAS1
          IF        OVRCD=0
            ADD       ONE,FORM2
            GOTO      URAS3000
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD  * write a new "patrasaf" record
          REP       " 0",CURRDATE
          MOVE      FORM2,PTRACNTN
          MOVE      PINVNO,PTRAINVN
          MOVE      FORM2,PTRACNTN
          MOVE      "3",PTRASYST            * Inpatient
          MOVE      OUTSTAMT,PTRAOUST       * Outstanding amount
          MOVE      REASMOVE,PTRARMOV       * Reason of Movement
          MOVE      SP70,PTRADBAG           * Debt Collection Agency (code)
          SUB       TMDTAMNT,FORM12P2
          MOVE      FORM12P2,PTRAPPOR       * Patient portion=Outstanding amt
          IF        PTRAPPOR<0
            CALL      SWRN0000              * Set Warning message
          ENDIF
          IF        FORM12P2=0
            MOVE      PINVBLCD,PTRAIBAL       * Date invoice balanced
            REP       " 0",PTRAIBAL
          ENDIF
          MOVE      "0",PTRADELE            * set Deleted flag off
.
          CALL      IBACLOCK
          MOVE      CURRDATE,PTRACDAT
          MOVE      CTIMEIS,PTRACTIM
          MOVE      WBSEUID,PTRACUID        * WEB user id
.
          MOVE      CURRDATE,PTRAUDAT
          MOVE      CTIMEIS,PTRAUTIM
          MOVE      WBSEUID,PTRAUUID        * WEB user id
          CALL      WRPTRAS1
.
URAS9999  RETURN
+
.------------------------------------------------------------------------------
. Write Receipt register/invoice details        
.------------------------------------------------------------------------------
.
WRTDTE00  MOVE      RCPBK001,RCPDE002     * Receipt number
          PACK      KEY17,RCPBK001,Z70
          CALL      RSTMDTE1
          CALL      RPTMDTE1
          BRANCH    OVRCD,WRTDET10
.
          MATCH     TMDTRECN,RCPBK001
          GOTO      WRTDET10 IF NOT EQUAL
.
          MOVE      TMDTTCNT,F5           * additional detail record
          ADD       ONE,F5
          MOVE      F5,RCPDE003
          GOTO      WRTDET20
.
WRTDET10  MOVE      ONE,F5                * first detail record
          MOVE      F5,RCPDE003
.
WRTDET20  CALL      CLRPDE00              * clear real fields
          CALL      MVRCDE00              * move cgi fields into Real fields
          CALL      MVRLDE00              * move Real fields into Temporary
.
          CALL      GTACCT00              * get income and control accounts
.
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            MOVE      RCBNTDAT,TMDTTDAT
          ENDIF
          MOVE      TMBNTDAT,TMDTTDAT
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,TMDTCDAT
          CLOCK     TIME,TMDTCTIM
          MOVE      USERID,TMDTCUID
          UNPACK    SP70,TMDTPRIN,TMDTPRNT
.
          MOVE      ZERO,TMDTTAMT
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
.
          PACK      KEY17,RCPBK001,RCPDE003,SP70
          CALL      WRTMDTE1
.
WRTDTE99  RETURN
+
.------------------------------------------------------------------------------
. Input Deposit Receipt for Patient 
.------------------------------------------------------------------------------
.
DEPRCP00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      DEPRCP70 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Allocate Receipt & Add Details
          GOTO      DEPRCP10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Bank Details
          GOTO      DEPRCP20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Bank Details
          GOTO      DEPRCP30 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Cancel - Delete All
          GOTO      DEPRCP40 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * Finish Receipt
          GOTO      DEPRCP50 IF EQUAL
.
          GOTO      DEPRCP99
.
.****************************************************************
.         Allocate new receipt and Add Bank Header & Details
.****************************************************************
.
DEPRCP10  CALL      ADDDEP00
          GOTO      DEPRCP99
.
.****************************************************************
.         Update Bank Details
.****************************************************************
.
DEPRCP20  CALL      UPDDEP00
          GOTO      DEPRCP99
.
.****************************************************************
.         Delete Bank Details
.****************************************************************
.
DEPRCP30  CALL      DELDEP00
          GOTO      DEPRCP99
.
.****************************************************************
.         Cancel - Delete All
.****************************************************************
.
DEPRCP40  CALL      CANDEP00
          GOTO      DEPRCP99
.
.****************************************************************
.         Finish/Complete Receipt
.****************************************************************
.
DEPRCP50  CALL      IBACLOCK
          CALL      FINDEP00
          GOTO      DEPRCP99
.
.****************************************************************
.         Display Bank Header & Details
.****************************************************************
.
DEPRCP70  MATCH     "001",TEMPLATE
          GOTO      DEPRCP75 IF NOT EQUAL    
.
          MATCH     ADMISSNO,Z70
          GOTO      DEPRCP96 IF EQUAL
          GOTO      DEPRCP96 IF EOS
          MATCH     ADMISSNO,SP70
          GOTO      DEPRCP96 IF EQUAL
.
          CALL      GETTYP00            * get visit type
          BRANCH    EXIT,DEPRCP99
.
DEPRCP75  MATCH     RCPBK001,Z70
          GOTO      DEPRCP81 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      DEPRCP81 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP20
          CALL      RDTMBNK1
          BRANCH    OVRCD,DEPRCP81
.
          MOVE      "    1",RCPDE003
          PACK      KEY17,RCPBK001,RCPDE003,SP20
          CALL      RDTMDTE1
          IF        OVRCD=1
            CALL      CLRPDE00            * clear receipt detail fields
            CALL      MVRLDE00            * clear temp file
          ENDIF
          GOTO      DEPRCP82
.
DEPRCP81  CALL      CLRPBK00              * clear bank header fields
          CALL      MVRLBK00              * clear temp file
          CALL      CLRPBT00              * clear bank details fields
          CALL      MVRLBT00              * clear temp file
          CALL      CLRPDE00              * clear receipt detail fields
          CALL      MVRLDE00              * clear temp file
          GOTO      DEPRCP88
.
.         Calculate Accumulative Total
.
DEPRCP82  MOVE      ZERO,ACCMTOTL
          PACK      KEY15,RCPBK001,SP20
          CALL      RSTMBDT1
DEPRCP83  CALL      RKTMBDT1
          BRANCH    OVRCD,DEPRCP84
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      DEPRCP84 IF NOT EQUAL
.
          ADD       TMBDPAMT,ACCMTOTL     * get accumulative total
          GOTO      DEPRCP83
.
DEPRCP84  PACK      KEY15,RCPBK001,RCPBT003,SP20
          CALL      RDTMBDT1
          IF        OVRCD=1
            CALL      CLRPBT00
          ENDIF
          CALL      MVTMBK00              * move temporary fields to real fields
          CALL      MVTMBT00              * move temporary fields to real fields
          CALL      MVTMDE00              * move temporary fields to real fields
.
DEPRCP88  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DEPRCP89
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
DEPRCP89  MOVE      "Input Deposits",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,DEPRCP99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
.
.         ************ DISPLAY ERROR MESSAGE **********
.
DEPRCP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
DEPRCP91  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
DEPRCP92  MOVE      "Bank Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
DEPRCP93  MOVE      "Bank Receipt Detail record already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
DEPRCP94  MOVE      "Receipt Header record already exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
DEPRCP95  MOVE      "Receipt Details does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
DEPRCP96  MOVE      "Cannot find Visit number. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEPRCP99
.
DEPRCP99  RETURN
+
.------------------------------------------------------------
. Add Deposits                    
.------------------------------------------------------------
ADDDEP00  MOVE      ZERO,UPDTFLAG         * Update tmpdteaf file
          MATCH     RCPBK001,Z70          * No receipt found
          GOTO      ADDDEP10 IF EQUAL
          MATCH     RCPBK001,SP70         * No receipt found
          GOTO      ADDDEP10 IF EQUAL
          GOTO      ADDDEP20
.
ADDDEP10  CALL      ALLCRC00              * allocate receipt number
          MOVE      SP70,RCPDE005
          CALL      WRTDTE00              * write deposit details
          MOVE      ONE,UPDTFLAG          * do not update tmpdteaf file
.
ADDDEP20  MOVE      RCPBK001,RCPBT002     * Receipt number
          MOVE      RCPBK002,RCPBT001     * Transaction Date
.
          PACK      KEY15,RCPBK001,Z70
          CALL      RSTMBDT1
          CALL      RPTMBDT1
          BRANCH    OVRCD,ADDDEP30
.
          MATCH     TMBDRECN,RCPBK001
          GOTO      ADDDEP30 IF NOT EQUAL
.
          MOVE      TMBDUNIQ,F3           * additional bank detail record
          ADD       ONE,F3
          MOVE      F3,RCPBT003
          GOTO      ADDDEP40
.
ADDDEP30  MOVE      ONE,F3                * first bank detail record
          MOVE      F3,RCPBT003
.
ADDDEP40  CALL      CLRPBT00              * Clear Real RCPBDT fields first
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
.
          MOVE      "1",TMBDPTYP          * Default to Cash
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,TMBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,PTCDNHCP
            IF        !@EQUAL
              UNPACK    PTCDNHCP,TMBDPTYP   * payment type
            ENDIF
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,TMBDCDAT
          CLOCK     TIME,TMBDCTIM
          MOVE      USERID,TMBDCUID
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      WRTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,ADDDEP90
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
          BRANCH    UPDTFLAG,ADDDEP80    * skip update tmpdteaf
.
.         Update Receipt Details file
.
          MOVE      "    1",D5
          PACK      KEY17,RCPBK001,D5,SP20
          CALL      RDTMDTE1
          BRANCH    OVRCD,ADDDEP91
          MATCH     RCPDE004,Z70
          IF        !@EQUAL
            MOVE      RCPDE004,TMDTREGI
          ENDIF
          MOVE      RCPDE015,TMDTREFR
          MOVE      RCPDE018,TMDTAMNT
          MOVE      RCPDE019,TMDTDISC
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
          CALL      GTACCT00              * get income and control accounts
.
          CALL      UPTMDTE1
.
ADDDEP80  CALL      BREDIR00         * set redirect
          GOTO      ADDDEP99
.
ADDDEP90  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDDEP99
.
ADDDEP91  MOVE      "Receipt Details does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDDEP99
.
ADDDEP99  RETURN
+
.------------------------------------------------------------
. Update Deposit                  
.------------------------------------------------------------
UPDDEP00  MATCH     RCPBK001,Z70
          GOTO      UPDDEP90 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      UPDDEP90 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,UPDDEP90
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,UPDDEP91
          CALL      MVTMBT00              * move Temporary fields into Real
.
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
          CALL      UPTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
.         Update Receipt Details file
.
          MOVE      "    1",D5
          PACK      KEY17,RCPBK001,D5,SP20
          CALL      RDTMDTE1
          BRANCH    OVRCD,UPDDEP92
          MATCH     RCPDE004,Z70
          IF        !@EQUAL
            MOVE      RCPDE004,TMDTREGI
          ENDIF
          MOVE      RCPDE015,TMDTREFR
          MOVE      RCPDE018,TMDTAMNT
          MOVE      RCPDE019,TMDTDISC
.
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
.
          CALL      GTACCT00              * get income and control accounts
.
          CALL      UPTMDTE1
.
          CALL      BREDIR00
          GOTO      UPDDEP99
.
UPDDEP90  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDEP99
.
UPDDEP91  MOVE      "Bank Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDEP99
.
UPDDEP92  MOVE      "Receipt Details does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDEP99
.
UPDDEP99  RETURN
+
.------------------------------------------------------------
. Delete Deposit                  
.------------------------------------------------------------
DELDEP00  MATCH     RCPBK001,Z70
          GOTO      DELDEP90 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      DELDEP90 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,DELDEP90
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,DELDEP91
.
          CALL      DETMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
          CALL      BREDIR00
          GOTO      DELDEP99
.
DELDEP90  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELDEP99
.
DELDEP91  MOVE      "Bank Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELDEP99
.
DELDEP99  RETURN
+
.------------------------------------------------------------
. Cancel Deposit                  
.------------------------------------------------------------
CANDEP00  MATCH     RCPBK001,Z70
          GOTO      CANDEP80 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      CANDEP80 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,CANDEP10
.
          MATCH     RCPBK004,Z70
          IF        @EQUAL
            MOVE      TMBNCDRW,RCPBK004
            MOVE      TMBNCUID,RCPBK017
          ENDIF
.
          CALL      DETMBNK1
.
CANDEP10  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,CANDEP30
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      CANDEP30 IF NOT EQUAL
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      DETMBDT1
          GOTO      CANDEP10
.
CANDEP30  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,CANDEP80
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      CANDEP80 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      DETMDTE1
          GOTO      CANDEP30
.
CANDEP80  MOVE      SP70,RCPBK001
          CALL      BREDIR00
          MOVE      ZERO,EXIT
          GOTO      CANDEP99
.
CANDEP99  RETURN
+
.------------------------------------------------------------
. Finish Deposit                 
.------------------------------------------------------------
FINDEP00  MATCH     RCPBK001,Z70
          GOTO      FINDEP90 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      FINDEP90 IF EQUAL
.
.         Update Receipt Details file
.
          MOVE      "    1",D5
          PACK      KEY17,RCPBK001,D5,SP20
          CALL      RDTMDTE1
          BRANCH    OVRCD,FINDEP92
          MATCH     RCPDE004,Z70
          IF        !@EQUAL
            MOVE      RCPDE004,TMDTREGI
          ENDIF
          MOVE      RCPDE015,TMDTREFR
          MOVE      RCPDE018,TMDTAMNT
          MOVE      RCPDE019,TMDTDISC
.
          MATCH     Z70,RCPDE034
          IF        !@EQUAL
            MOVE      RCPDE034,TMDTDPTY
          ENDIF
.
          MATCH     RCPDE037,Z70
          IF        !@EQUAL
            MOVE      RCPDE037,TMDTTAMT
          ENDIF
.
          CALL      GTACCT00              * get income and control accounts
.
          CALL      UPTMDTE1
.
.         Write Tempory fields to Bank Header File (rcpbnkaf)
.
          PACK      KEY12,RCPBK001
          CALL      RDTMBNK1
          BRANCH    OVRCD,FINDEP90
.
          MATCH     RCPBK004,Z70
          IF        @EQUAL
            MOVE      TMBNCDRW,RCPBK004
            MOVE      TMBNCUID,RCPBK017
          ENDIF
.
          PACK      KEY12,RCPBK001
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      FINDEP91 IF EQUAL
.
          CALL      MVTMBK00
          CALL      WRRCBNK1               * write to real file
          CALL      DETMBNK1               * delete from temporary file
.
.         Write Temporary fields to Bank Detail File (rcpbdtaf)
.
          MOVE      ZERO,TOTLCRCS
FINDEP10  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,FINDEP20
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      FINDEP20 IF NOT EQUAL
.
          MOVE      ZERO,FORM12P2          * Surcharge amount
          CALL      CRSC0000               * Check for Credit card surcharge
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      RDRCBDT1
          IF        OVRCD=0
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      UPRCBDT1
          ELSE
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      WRRCBDT1             * write to real file
          ENDIF
          CALL      DETMBDT1             * delete from temporary file
          CALL      WCSR0000             * Write to Credit card surcharge
          GOTO      FINDEP10
.
.         Write Temporary fields to Receipt Detail File (rcpdteaf)
.
FINDEP20  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,FINDEP30
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      FINDEP30 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      RDRCDTE1
          IF        OVRCD=0
            CALL      MVTMDE00
            PACK      RCDTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTUDAT           * date updated
            CLOCK     TIME,RCDTUTIM           * time updated
            MOVE      USERID,RCDTUUID         * web user id
            CALL      UPRCDTE1
          ELSE
            CALL      MVTMDE00
            MOVE      SP70,RCDTGLEX
            PACK      RCDTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTCDAT        * date updated
            CLOCK     TIME,RCDTCTIM        * time updated
            MOVE      USERID,RCDTCUID      * web user id
            CALL      WRRCDTE1             * write to real file
          ENDIF
          CALL      DETMDTE1             * delete from temporary file
          GOTO      FINDEP20
.
FINDEP30  CALL      UCRD0000               * Update total surcharge if necessary
          PACK      KEY32,RCPBK001,SP70
          CALL      RSTMDBP1
          CALL      RKTMDBP1
          BRANCH    OVRCD,FINDEP80
.
          MATCH     RCPBK001,TMDBRECN
          GOTO      FINDEP80 IF NOT EQUAL
.
          PACK      KEY32,RCPBK001,TMDBTCNT,TMDBINVN,TMDBILNE,SP70
          CALL      RDRCDBP1
.
          MOVE      TMDBRECN,RCDBRECN
          MOVE      TMDBTCNT,RCDBTCNT
          MOVE      TMDBINVN,RCDBINVN
          MOVE      TMDBILNE,RCDBILNE
          MOVE      TMDBPAMT,RCDBPAMT
          MOVE      SP70,RCDBSPAR
.
          IF        OVRCD=0
            CALL      UPRCDBP1
          ELSE
            CALL      WRRCDBP1             * write to real file
          ENDIF
.
          CALL      DETMDBP1             * delete from temporary file
          GOTO      FINDEP30
.
FINDEP80  MATCH     "1",PRINTFLG
          IF        @EQUAL
            IF        HFORMAT=8 | HFORMAT=4 | HFORMAT=2 | HFORMAT=1
              MOVE      RCPBK001,RECEIPTN
              CALL      STMPL000
              BRANCH    TMPLTFLG,FINDEP93
            ENDIF
.
            MOVE      RCPBK001,RECEIPTN
            CALL      OPNPRINT
            CALL      PRTN0000                * Print Receipt
            CALL      CLSPRINT
          ENDIF
.
          MOVE      SP70,RCPBK001
          CALL      BREDIR00
          MOVE      ZERO,EXIT
          GOTO      FINDEP99
.
FINDEP90  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FINDEP99
.
FINDEP91  MOVE      "Receipt Header record already exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FINDEP99
.
FINDEP92  MOVE      "Receipt Details does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FINDEP99
.
FINDEP93  MOVE      "Receipt Header/Tail Not Setup. Contact I.B.A. - ",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      FINDEP99
.
FINDEP99  RETURN
+
.------------------------------------------------------------
. Get Visit Type                  
.------------------------------------------------------------
GETTYP00  MOVE      ZERO,EXIT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1                * read visit
          BRANCH    OVRCD,GETTYP10
.
          MOVE      PVITYPE,VISITTYP
.
          MATCH     "3",VISITTYP         * Inpatient
          GOTO      GETTYP99 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,GETTYP90
.
          COMPARE   FIVE,ASTAT            * cancelled admission
          GOTO      GETTYP91 IF EQUAL
          GOTO      GETTYP99
.
GETTYP10  PACK      KEY8,ADMISSNO,SP10   
          CALL      RDBKREC1               * read inpatient booking
          BRANCH    OVRCD,GETTYP20
.
          COMPARE   TWO,BKRESTAT           * Cancelled Status       
          GOTO      GETTYP92 IF EQUAL
.
          COMPARE   ZERO,BKRESTAT          * Booking Status       
          GOTO      GETTYP20 IF NOT EQUAL
.
          MOVE      THREE,VISITTYP         * Inpatient 
          GOTO      GETTYP99
.
GETTYP20  PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,GETTYP90    
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      GETTYP90 IF NOT EQUAL
.
          MOVE      TWO,VISITTYP           * Outpatient 
          GOTO      GETTYP99
.
GETTYP90  MOVE      "Cannot find Admission Record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GETTYP99

GETTYP91  MOVE      "Admission has been cancelled. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GETTYP99
.
GETTYP92  MOVE      "Booking has been cancelled. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GETTYP99
.
GETTYP99  RETURN
+
.------------------------------------------------------------------------------
. Input New Receipt for Private Practice Bulk Billing (by Claim)
.------------------------------------------------------------------------------
CLMRCP00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      CLMRCP80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Allocate Receipt & Add Details
          GOTO      CLMRCP10 IF EQUAL
.
          MATCH     "B",UPDTTYPE            * Add rcpdteaf
          GOTO      CLMRCP15 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Bank Details
          GOTO      CLMRCP20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Bank Details
          GOTO      CLMRCP30 IF EQUAL
.
          MATCH     "E",UPDTTYPE            * Delete rcpdteaf Details
          GOTO      CLMRCP35 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Cancel - Delete All
          GOTO      CLMRCP40 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * Finish Receipt
          GOTO      CLMRCP50 IF EQUAL
.
          GOTO      CLMRCP99
.
.****************************************************************
.         Allocate new receipt and Add Bank Header & Details
.****************************************************************
.
CLMRCP10  CALL      ADDCLM00                * rcpbnkaf & rcpbdtaf
          BRANCH    EXIT,CLMRCP91,CLMRCP95
.
          CALL      BREDIR00
          GOTO      CLMRCP99
.
.****************************************************************
.         Allocate new receipt and Add Bank Header & Details
.****************************************************************
.
CLMRCP15  CALL      ADTCLM00                * rcpdteaf
          BRANCH    EXIT,CLMRCP91
.
          CALL      BREDIR00
          GOTO      CLMRCP99
.
.****************************************************************
.         Update Bank Details
.****************************************************************
.
CLMRCP20  CALL      UPDCLM00
          BRANCH    EXIT,CLMRCP91,CLMRCP92,CLMRCP95
.
          CALL      BREDIR00
          GOTO      CLMRCP99
.
.****************************************************************
.         Delete Bank Details
.****************************************************************
.
CLMRCP30  CALL      DELCLM00                * rcpbdtaf
          BRANCH    EXIT,CLMRCP91,CLMRCP92
.
          CALL      BREDIR00
          GOTO      CLMRCP99
.
.****************************************************************
.         Delete Bank Details
.****************************************************************
.
CLMRCP35  CALL      DDTCLM00                * rcpdteaf
          BRANCH    EXIT,CLMRCP91,CLMRCP95
.
          CALL      BREDIR00
          GOTO      CLMRCP99
.
.****************************************************************
.         Cancel - Delete All
.****************************************************************
.
CLMRCP40  CALL      CANCLM00
          BRANCH    EXIT,CLMRCP91,CLMRCP92,CLMRCP95
.
          MOVE      SP70,RCPBK001
          CALL      BREDIR00
          MOVE      ZERO,EXIT
          GOTO      CLMRCP99
.
.****************************************************************
.         Finish/Complete Receipt
.****************************************************************
.
CLMRCP50  CALL      IBACLOCK
          CALL      FINCLM00
          BRANCH    EXIT,CLMRCP91,CLMRCP92,CLMRCP93,CLMRCP94,CLMRCP95:
                         CLMRCP96
.
          MOVE      SP70,RCPBK001
          CALL      BREDIR00
          MOVE      ZERO,EXIT
          GOTO      CLMRCP99
.
.****************************************************************
.         Display Bank Header & Details
.****************************************************************
.
CLMRCP80  CALL      DISCLM00
.
          MOVE      "Input Receipts",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,CLMRCP99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
.
.         ************ DISPLAY ERROR MESSAGE **********
.
CLMRCP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
CLMRCP91  MOVE      "Receipt Header does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
CLMRCP92  MOVE      "Bank Receipt Detail does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
CLMRCP93  MOVE      "Bank Receipt Detail record already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
CLMRCP94  MOVE      "Receipt Header record already exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
CLMRCP95  MOVE      "Receipt Details does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
CLMRCP96  MOVE      "Receipt Header/Tail Not Setup. Contact I.B.A. - ",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      CLMRCP99
.
CLMRCP99  RETURN
+
.------------------------------------------------------------------------------
. Input Receipt for Claims - Add rcpbnkaf & rcpbdtaf
.------------------------------------------------------------------------------
ADDCLM00  MATCH     RCPBK001,Z70          * No receipt found
          GOTO      ADDCLM10 IF EQUAL
          MATCH     RCPBK001,SP70         * No receipt found
          GOTO      ADDCLM10 IF EQUAL
          GOTO      ADDCLM20
.
ADDCLM10  CALL      ALLCRC00              * allocate receipt number
.
ADDCLM20  MOVE      RCPBK001,RCPBT002     * Receipt number
          MOVE      RCPBK002,RCPBT001     * Transaction Date
.
          PACK      KEY15,RCPBK001,Z70
          CALL      RSTMBDT1
          CALL      RPTMBDT1
          BRANCH    OVRCD,ADDCLM30
.
          MATCH     TMBDRECN,RCPBK001
          GOTO      ADDCLM30 IF NOT EQUAL
.
          MOVE      TMBDUNIQ,F3           * additional bank detail record
          ADD       ONE,F3
          MOVE      F3,RCPBT003
          GOTO      ADDCLM40
.
ADDCLM30  MOVE      ONE,F3                * first bank detail record
          MOVE      F3,RCPBT003
.
ADDCLM40  CALL      CLRPBT00              * initialise real fields
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
.
          MOVE      "1",TMBDPTYP          * Default to Cash
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,TMBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,PTCDNHCP
            IF        !@EQUAL
              UNPACK    PTCDNHCP,TMBDPTYP    * payment type
            ENDIF
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,TMBDCDAT
          CLOCK     TIME,TMBDCTIM
          MOVE      USERID,TMBDCUID
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      WRTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,ADDCLM91
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
ADDCLM90  MOVE      ZERO,EXIT
          GOTO      ADDCLM99
.
ADDCLM91  MOVE      ONE,EXIT
          GOTO      ADDCLM99
.
ADDCLM92  MOVE      TWO,EXIT
          GOTO      ADDCLM99
.
ADDCLM99  RETURN
+
.------------------------------------------------------------------------------
. Input Receipt for Claims - Add rcpdteaf 
.------------------------------------------------------------------------------
ADTCLM00  MATCH     RCPBK001,Z70          * No receipt found
          GOTO      ADTCLM91 IF EQUAL
          MATCH     RCPBK001,SP70         * No receipt found
          GOTO      ADTCLM91 IF EQUAL
.
          MOVE      ZERO,CLAIMFLG
          MOVE      ZERO,COUNTER
.
ADTCLM10  ADD       ONE,COUNTER
          MATCH     SP70,CLAIMKEY[COUNTER]
          GOTO      ADTCLM90 IF EQUAL
.
          MATCH     "1",INVPYFLG[COUNTER]
          IF        @EQUAL
            PACK      KEY28,CLAIMKEY[COUNTER],SP70
            CALL      RDPRBB1
            BRANCH    OVRCD,ADTCLM10
.
            IF        CLAIMFLG=ZERO
              MOVE      ONE,CLAIMFLG
              PACK      KEY12,RCPBK001,SP10
              CALL      RDTMBNK1
              BRANCH    OVRCD,ADTCLM91
              MOVE      ONE,TMBNTTYP        * hardcode health fund
              MOVE      PRBBCODE,TMBNRCOD
              CALL      UPTMBNK1
            ENDIF
.
            PACK      KEY8,PRBBINVN,SP10
            CALL      RDPRIN1
            BRANCH    OVRCD,ADTCLM10
.
            MOVE      PRBBINVN,FORM12
            MOVE      FORM12,RCPDE005
            MOVE      PRBBREGR,RCPDE004
            MOVE      CLAIMNUM,RCPDE006   * save claim number
            MOVE      PRINDEBT,RCPDE007
            MOVE      PRINSCAN,RCPDE014
            MOVE      SP70,RCPDE015
            MOVE      INVPYAMT[COUNTER],RCPDE018
            CALL      WRTDTE00
.
          ENDIF
          GOTO      ADTCLM10
.
ADTCLM90  MOVE      ZERO,EXIT
          GOTO      ADTCLM99
.
ADTCLM91  MOVE      ONE,EXIT
          GOTO      ADTCLM99
.
ADTCLM99  RETURN
.------------------------------------------------------------------------------
. Input Receipt for Claims - Update    
.------------------------------------------------------------------------------
UPDCLM00  MATCH     RCPBK001,Z70
          GOTO      UPDCLM91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      UPDCLM91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,UPDCLM91
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,UPDCLM92
          CALL      MVTMBT00              * move Temporary fields into Real
.
          CALL      MVRCBT00              * move cgi fields into Real fields
          CALL      MVRLBT00              * move Real fields into Temporary
          CALL      UPTMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
UPDCLM90  MOVE      ZERO,EXIT
          GOTO      ADDCLM99
.
UPDCLM91  MOVE      ONE,EXIT
          GOTO      ADDCLM99
.
UPDCLM92  MOVE      TWO,EXIT
          GOTO      ADDCLM99
.
UPDCLM93  MOVE      THREE,EXIT
          GOTO      ADDCLM99
.
UPDCLM99  RETURN
+
.------------------------------------------------------------------------------
. Input Receipt for Claims - Delete    
.------------------------------------------------------------------------------
DELCLM00  MATCH     RCPBK001,Z70
          GOTO      DELCLM91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      DELCLM91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,DELCLM91
.
          PACK      KEY15,RCPBK001,RCPBT003,SP70
          CALL      RDTMBDT1
          BRANCH    OVRCD,DELCLM92
.
          CALL      DETMBDT1
.
.         Update Total Payments Amount in Header file
.
          CALL      GTAMT000             * get accumulative amount
          MOVE      ACCMTOTL,TMBNTOTP
          CALL      UPTMBNK1
.
DELCLM90  MOVE      ZERO,EXIT
          GOTO      DELCLM99
.
DELCLM91  MOVE      ONE,EXIT
          GOTO      DELCLM99
.
DELCLM92  MOVE      TWO,EXIT
          GOTO      DELCLM99
.
DELCLM99  RETURN
+
.------------------------------------------------------------------------------
. Input Receipt for Claims - Delete    
.------------------------------------------------------------------------------
DDTCLM00  MATCH     RCPBK001,Z70
          GOTO      DDTCLM91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      DDTCLM91 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,DDTCLM91
.
          PACK      KEY17,RCPBK001,RCPDE003,SP70
          CALL      RDTMDTE1
          BRANCH    OVRCD,DDTCLM92
.
          CALL      DETMDTE1
.
DDTCLM90  MOVE      ZERO,EXIT
          GOTO      DDTCLM99
.
DDTCLM91  MOVE      ONE,EXIT
          GOTO      DDTCLM99
.
DDTCLM92  MOVE      TWO,EXIT
          GOTO      DDTCLM99
.
DDTCLM99  RETURN
.------------------------------------------------------------------------------
. Input Receipt for Claims - Cancel    
.------------------------------------------------------------------------------
CANCLM00  MATCH     RCPBK001,Z70
          GOTO      CANCLM99 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      CANCLM99 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,CANCLM10
.
          MATCH     RCPBK004,Z70
          IF        @EQUAL
            MOVE      TMBNCDRW,RCPBK004
            MOVE      TMBNCUID,RCPBK017
          ENDIF
.
          CALL      DETMBNK1
.
CANCLM10  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,CANCLM30
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      CANCLM30 IF NOT EQUAL
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      DETMBDT1
          GOTO      CANCLM10
.
CANCLM30  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,CANCLM99
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      CANCLM99 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      DETMDTE1
          GOTO      CANCLM30
.
CANCLM99  RETURN
+
.------------------------------------------------------------------------------
. Input Receipt for Claims - Finish    
.------------------------------------------------------------------------------
FINCLM00  MATCH     RCPBK001,Z70
          GOTO      FINCLM91 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      FINCLM91 IF EQUAL
.
.         Write Tempory fields to Bank Header File (rcpbnkaf)
.
          PACK      KEY12,RCPBK001
          CALL      RDTMBNK1
          BRANCH    OVRCD,FINCLM91
.
          PACK      KEY12,RCPBK001
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      FINCLM94 IF EQUAL
.
          CALL      MVTMBK00
          CALL      WRRCBNK1               * write to real file
          CALL      DETMBNK1               * delete from temporary file
.
.         Write Temporary fields to Bank Detail File (rcpbdtaf)
.
          MOVE      ZERO,TOTLCRCS
FINCLM10  PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
          CALL      RKTMBDT1
          BRANCH    OVRCD,FINCLM20
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      FINCLM20 IF NOT EQUAL
.
          MOVE      ZERO,FORM12P2          * Surcharge amount
          CALL      CRSC0000               * Check for Credit card surcharge
.
          PACK      KEY15,RCPBK001,TMBDUNIQ,SP70
          CALL      RDRCBDT1
          IF        OVRCD=0
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      UPRCBDT1
          ELSE
            CALL      MVTMBT00
            ADD       FORM12P2,RCBDPAMT    * include surcharge
            CALL      WRRCBDT1             * write to real file
          ENDIF
          CALL      DETMBDT1             * delete from temporary file
          CALL      WCSR0000             * Write to Credit card surcharge
          GOTO      FINCLM10
.
.         Write Temporary fields to Receipt Detail File (rcpdteaf)
.
FINCLM20  PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
          CALL      RKTMDTE1
          BRANCH    OVRCD,FINCLM30
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      FINCLM30 IF NOT EQUAL
.
          PACK      KEY17,RCPBK001,TMDTTCNT,SP70
          CALL      RDRCDTE1
          IF        OVRCD=0
            CALL      MVTMDE00
            PACK      RCDTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTUDAT           * date updated
            CLOCK     TIME,RCDTUTIM           * time updated
            MOVE      USERID,RCDTUUID         * web user id
            CALL      UPRCDTE1
          ELSE
            CALL      MVTMDE00
            MOVE      SP70,RCDTGLEX
            PACK      RCDTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTCDAT        * date updated
            CLOCK     TIME,RCDTCTIM        * time updated
            MOVE      USERID,RCDTCUID      * web user id
            CALL      WRRCDTE1           * write to real file
          ENDIF
          CALL      DETMDTE1             * delete from temporary file
.
          MOVE      TMDTVIST,CLAIMNUM  * get claim number
          MOVE      ZERO,FORM12
          MOVE      TMDTINVN,FORM12
          MOVE      SP70,DIM12
          MOVE      FORM12,DIM12
          UNPACK    DIM12,KEY4,KEY8
.
          PACK      KEY28,CLAIMNUM,KEY8,SP70
          CALL      RSPRBB1
FINCLM25  CALL      RKPRBB1
          BRANCH    OVRCD,FINCLM20
.
          MATCH     CLAIMNUM,DPRBBCLM
          GOTO      FINCLM20 IF NOT EQUAL
          MATCH     KEY8,PRBBINVN
          GOTO      FINCLM20 IF NOT EQUAL
          IF        PRBBSTAT=1
            MOVE      TWO,PRBBSTAT    * update status to receipted
            CALL      UPPRBB1
          ENDIF
          GOTO      FINCLM25
.
FINCLM30  CALL      UCRD0000               * Update total surcharge if necessary
          PACK      KEY28,CLAIMNUM,SP70
          CALL      RSPRBB1
FINCLM35  CALL      RKPRBB1
          BRANCH    OVRCD,FINCLM90
.
          MATCH     CLAIMNUM,DPRBBCLM
          GOTO      FINCLM90 IF NOT EQUAL
.
          IF        PRBBSTAT=1
            MOVE      THREE,PRBBSTAT   * update status to rejected
            CALL      UPPRBB1
.
            CALL      UNINV000
.
..            PACK      KEY22,PRBBINVN,SP70
..            CALL      RSPRDT4
..            CALL      RKPRDT4
..            BRANCH    OVRCD,FINCLM35
..            MATCH     PRBBINVN,PRDTINVN
..            GOTO      FINCLM35 IF NOT EQUAL
.
..            PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
..            CALL      RSPRHR1
..            CALL      RKPRHR1
..            BRANCH    OVRCD,FINCLM35
..            PACK      DIM27A,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
..            MATCH     KEY27,DIM27A
..            GOTO      FINCLM35 IF NOT EQUAL
..            MOVE      ONE,PRHRPINV
..            CALL      UPPRHR1
          ENDIF
.
          GOTO      FINCLM35
.
FINCLM90  MATCH     "1",PRINTFLG
          IF        @EQUAL
            IF        HFORMAT=8 | HFORMAT=4 | HFORMAT=2 | HFORMAT=1
              MOVE      RCPBK001,RECEIPTN
              CALL      STMPL000
              BRANCH    TMPLTFLG,FINCLM96
            ENDIF
.
            MOVE      RCPBK001,RECEIPTN
            CALL      OPNPRINT
            CALL      PRTN0000                * Print Receipt
            CALL      CLSPRINT
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      FINCLM99
.
FINCLM91  MOVE      ONE,EXIT
          GOTO      FINCLM99
.
FINCLM92  MOVE      TWO,EXIT
          GOTO      FINCLM99
.
FINCLM93  MOVE      THREE,EXIT
          GOTO      FINCLM99
.
FINCLM94  MOVE      FOUR,EXIT
          GOTO      FINCLM99
.
FINCLM95  MOVE      FIVE,EXIT
          GOTO      FINCLM99
.
FINCLM96  MOVE      SIX,EXIT
          GOTO      FINCLM99
.
FINCLM99  RETURN
+
.----------------------------------------------------------------
.         Undo Invoice in Bulk Billing                                     
.----------------------------------------------------------------
UNINV000  PACK      KEY8,PRBBINVN,SP10
          CALL      RDPRIN1
          BRANCH    OVRCD,UNINV999
.
          PACK      KEY22,PRINUNIQ,PRINNUMB,SP6
          CALL      RSPRDT1
UNINV100  CALL      RKPRDT1
          BRANCH    OVRCD,UNINV999
.
          COMPARE   PRINUNIQ,PRDTUNIQ
          GOTO      UNINV999 IF NOT EQUAL
          MATCH     PRINNUMB,PRDTINVN
          GOTO      UNINV999 IF NOT EQUAL
.
          CALL      WRHTR000
          GOTO      UNINV100
.
UNINV999  RETURN
.----------------------------------------------------------------
.         Write record to prihtraf (Holding Table for Billing Transactions)
.----------------------------------------------------------------
WRHTR000  CALL      GTRN0000
          CALL      CLPRIHTR
          MOVE      PRDTUNIQ,PRHTUNIQ
          MOVE      PRDTPRAC,PRHTPRAC
          MOVE      PRDTDOCT,PRHTDOCT
          MOVE      PRDTCODE,PRHTPIND
          MOVE      PRDTREFD,PRHTREFD
          MOVE      PRDTIFLG,PRHTFLAG
          MOVE      PRDTITMN,PRHTITMN
          MOVE      PRDTSUBN,PRHTSUBN
          MOVE      TRANSNO,PRHTNUMB
          MOVE      PRDTSDAT,PRHTDATE
          MOVE      PRDTSTIM,PRHTTIME
          MOVE      PRDTSERV,PRHTSERN
          MOVE      PRDTDESC,PRHTIDES
          MOVE      PRDTIAMT,PRHTIAMT
          MOVE      PRDTPFLG,PRHTPFLG
          MOVE      PRDTS4B3,PRHTS4B3
.
          MOVE      PRDTMEDA,PRHTMEDA
          MOVE      PRDTRDTE,PRHTRDAT
          MOVE      PRDTREFT,PRHTREFT
          MOVE      PRDTGSTA,PRHTGSTA
          MOVE      PRDTGSTC,PRHTGSTC
          MOVE      PRDTRFPD,PRHTRFPD
          MOVE      PRDTREFN,PRHTREFN
          MOVE      PRDTENCN,PRHTENCN
          MOVE      SP70,PRHTHICI
.
          PACK      KEY62,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD,PRHTRDAT:
                          PRHTFLAG,PRHTITMN,PRHTSUBN,PRHTNUMB,SP70
          CALL      WRPRHT1
.
          PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,WRHTR999
.
          COMPARE   ONE,PRHRPINV          * Check status To be Invoiced
          GOTO      WRHTR999 IF EQUAL
.
          MOVE      ONE,PRHRPINV          * Change status To be Invoiced
          CALL      UPPRHR1
.
WRHTR999  RETURN
+
.**********************************************************************
.      Get last transaction number
.**********************************************************************
GTRN0000  MOVE      ZERO,TRANSNO
          IF        PRCNRDOC = 1
            PACK      KEY62,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,PRDTREFD:
                            PRDTRDTE,Z70
          ELSE
            PACK      KEY62,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,Z70
          ENDIF
          CALL      RSPRHT3                      * position in trans. file
          CALL      RPPRHT3                      * read trans. record
          BRANCH    OVRCD,GTRN9000               * end of file
.
          COMPARE   PRDTUNIQ,PRHTUNIQ            * same unique identifier ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRDTPRAC,PRHTPRAC            * same medical practice ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRDTDOCT,PRHTDOCT            * same service doctor ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRDTCODE,PRHTPIND            * same patient indicator ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          IF        PRCNRDOC = 1
             MATCH     PRDTREFD,PRHTREFD         * same referring doctor ?
             GOTO      GTRN9000 IF NOT EQUAL     * no
             MATCH     PRDTRDTE,PRHTRDAT         * same referral date?
             GOTO      GTRN9000 IF NOT EQUAL     * no
          ENDIF
          MOVE      PRHTNUMB,TRANSNO
.
GTRN9000  ADD       ONE,TRANSNO                  * next available trans no
GTRN9999  RETURN
+
.------------------------------------------------------------------------------
. Input Receipt for Claims - Display    
.------------------------------------------------------------------------------
DISCLM00  MATCH     RCPBK001,Z70
          GOTO      DISCLM10 IF EQUAL
          MATCH     RCPBK001,SP70
          GOTO      DISCLM10 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP20
          CALL      RDTMBNK1
          BRANCH    OVRCD,DISCLM10
          GOTO      DISCLM20
.
DISCLM10  CALL      CLRPBK00              * clear bank header fields
          CALL      MVRLBK00              * clear temp file
          CALL      CLRPBT00              * clear bank details fields
          CALL      MVRLBT00              * clear temp file
          CALL      CLRPDE00              * clear receipt detail fields
          CALL      MVRLDE00              * clear temp file
          GOTO      DISCLM80
.
.         Calculate Accumulative Total
.
DISCLM20  MOVE      ZERO,ACCMTOTL
          PACK      KEY15,RCPBK001,SP20
          CALL      RSTMBDT1
DISCLM30  CALL      RKTMBDT1
          BRANCH    OVRCD,DISCLM40
.
          MATCH     RCPBK001,TMBDRECN
          GOTO      DISCLM40 IF NOT EQUAL
.
          ADD       TMBDPAMT,ACCMTOTL     * get accumulative total
          GOTO      DISCLM30
.
DISCLM40  PACK      KEY15,RCPBK001,RCPBT003,SP20
          CALL      RDTMBDT1
          IF        OVRCD=1
            CALL      CLRPBT00
          ENDIF
.
.         1et 1otal Allocated amount
.
DISDET50  MOVE      ZERO,ALLCTOTL
          PACK      KEY17,RCPBK001,SP20
          CALL      RSTMDTE1
DISDET60  CALL      RKTMDTE1
          BRANCH    OVRCD,DISDET70
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      DISDET70 IF NOT EQUAL
.
          ADD       TMDTAMNT,ALLCTOTL     * get allocated total
          GOTO      DISDET60
.
DISDET70  CALL      MVTMBK00              * move temporary fields to real fields
          CALL      MVTMBT00              * move temporary fields to real fields
          CALL      MVTMDE00              * move temporary fields to real fields
.
DISCLM80  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DISCLM85
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
DISCLM85  MATCH    Z70,CLAIMNUM
          GOTO     DISCLM99 IF EQUAL
          MATCH    SP70,CLAIMNUM
          GOTO     DISCLM99 IF EQUAL
.
          PACK     KEY28,CLAIMNUM,SP70
          CALL     RSPRBB1
          CALL     RKPRBB1
          BRANCH   OVRCD,DISCLM99
.
          MATCH    CLAIMNUM,DPRBBCLM
          GOTO     DISCLM99 IF NOT EQUAL
.
          MOVE     PRBBCODE,RCBNRCOD
          MOVE     PRBBREGR,RCDTREGI
.
DISCLM99  RETURN
+
.------------------------------------------------------------------------------
. Process Fields called from WEBBOD00
.------------------------------------------------------------------------------
.
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD30:
                             PROFLD40,PROFLD70,PROFLD30
.
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
          GOTO      PROFLD99
.
PROFLD11                         
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23,PROFLD24
          GOTO      PROFLD99
.
PROFLD21  CALL      RCBK0000    * Receipt Bank Header Details (rcpbnkaf) tags
          GOTO      PROFLD99
.
PROFLD22  CALL      RCBT0000    * Receipt Bank Details (rcpbdtaf) tags
          GOTO      PROFLD99
.
PROFLD23  CALL      RCDE0000    * Receipt Details (rcpdteaf) tags   
          GOTO      PROFLD99
.
PROFLD24  CALL      IRCP0000    * Misc Input receipt tags                   
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34
          GOTO      PROFLD99
.
PROFLD31  CALL      RCBK0000    * Receipt Bank Header Details (rcpbnkaf) tags
          GOTO      PROFLD99
.
PROFLD32  CALL      RCBT0000    * Receipt Bank Details (rcpbdtaf) tags
          GOTO      PROFLD99
.
PROFLD33  CALL      RCDE0000    * Receipt Details (rcpdteaf) tags   
          GOTO      PROFLD99
.
PROFLD34  CALL      IRCP0000    * Misc Input receipt tags                   
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44,PROFLD45
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000    * Patient master file
          GOTO      PROFLD99
.
PROFLD42  CALL      RCBK0000    * Receipt Bank Header Details (rcpbnkaf) tags
          GOTO      PROFLD99
.
PROFLD43  CALL      RCBT0000    * Receipt Bank Details (rcpbdtaf) tags
          GOTO      PROFLD99
.
PROFLD44  CALL      IRCP0000    * Misc Input receipt tags
          GOTO      PROFLD99
.
PROFLD45  CALL      RCDE0000    * Receipt Details (rcpdteaf) tags
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73,PROFLD74
          GOTO      PROFLD99
.
PROFLD71  CALL      RCBK0000    * Receipt Bank Header Details (rcpbnkaf) tags
          GOTO      PROFLD99
.
PROFLD72  CALL      RCBT0000    * Receipt Bank Details (rcpbdtaf) tags
          GOTO      PROFLD99
.
PROFLD73  CALL      RCDE0000    * Receipt Details (rcpdteaf) tags   
          GOTO      PROFLD99
.
PROFLD74  CALL      IRCP0000    * Misc Input receipt tags                   
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.-----------------------------------------------------------
.  Cash Drawer Selection List - rcpcidaf
.-----------------------------------------------------------
CDSLTN00  PACK      KEY6,SP70
          CALL      RDSCIDA1
CDSLTN10  CALL      RDKCIDA1
          BRANCH    OVRCD,CDSLTN99
.
          MATCH     "1",RCCIACTV
          GOTO      CDSLTN10 IF EQUAL   * Inactive
.
          CLEAR     FORMATNM
          APPEND    RCPGIVEN,FORMATNM
          APPEND    SP1,FORMATNM
          APPEND    RCPSUR,FORMATNM
          RESET     FORMATNM
.
          MATCH     SP10,RCPPASS
          IF        @EQUAL
            MOVE      ZERO,DIM1    * No password flag
          ELSE
            MOVE      ONE,DIM1     * Password found flag
          ENDIF
.
          PACK      KEY9,QUOTE,RCPCASH,DIM1,QUOTE
          MATCH     CASHDRWR,RCPCASH
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY9,"selected>",FORMATNM:
                               "</option>";
          ELSE
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCCIHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,RCCIHOSP
                GOTO      CDSLTN10 IF NOT EQUAL
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=",KEY9,">",FORMATNM:
                               "</option>";
          ENDIF
.
          GOTO      CDSLTN10
.
CDSLTN99  RETURN
.-----------------------------------------------------------
.  Cashier Selection List - websecaf
.-----------------------------------------------------------
CSHRSL00  PACK      KEY11,ONE,SP70
          CALL      RSWBSE4 
CSHRSL10  CALL      RKWBSE4 
          BRANCH    OVRCD,CSHRSL99
.
          MATCH     "1",WBSECASH  
          GOTO      CSHRSL99 IF NOT EQUAL
.
          PACK      KEY12,QUOTE,WBSEUID,QUOTE
          MATCH     CASHIERC,WBSEUID
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY12,"selected>",WBSENAM:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY12,">",WBSENAM:
                               "</option>";
          ENDIF
          GOTO      CSHRSL10
.
CSHRSL99  RETURN
+
.-----------------------------------------------------------
. Option 1: Input Receipt
.-----------------------------------------------------------
IRCP0000  BRANCH    FLDITMNO,IRCP0100,IRCP0200,IRCP0300,IRCP0400,IRCP0500:
                             IRCP0600,IRCP0700,IRCP0800,IRCP0900,IRCP1000:
                             IRCP1100,IRCP1200,IRCP1300,IRCP1400,IRCP1500:
                             IRCP1600,IRCP1700,IRCP1800,IRCP1900,IRCP2000:
                             IRCP2100,IRCP2200,IRCP2300,IRCP2400,IRCP2500:
                             IRCP2600,IRCP2700,IRCP2800,IRCP2900,IRCP3000:
                             IRCP3100,IRCP3200,IRCP3300,IRCP3400,IRCP3500:
                             IRCP3600,IRCP3700,IRCP3800,IRCP3900,IRCP4000:
                             IRCP4100,IRCP4200,IRCP4300,IRCP4400,IRCP4500:
                             IRCP4600,IRCP4700,IRCP4800,IRCP4900,IRCP5000:
                             IRCP5100,IRCP5200,IRCP5300,IRCP5400,IRCP5500:
                             IRCP5600,IRCP5700,IRCP5800,IRCP5900,IRCP6000:
                             IRCP6100,IRCP6200,IRCP6300,IRCP6400,IRCP6500:
                             IRCP6600,IRCP6700,IRCP6800,IRCP6900,IRCP7000:
                             IRCP7100,IRCP7200,IRCP7300,IRCP7400,IRCP7500:
                             IRCP7600,IRCP7700,IRCP7800,IRCP7900,IRCP8000:
                             IRCP8100,IRCP8200,IRCP8300,IRCP8400,IRCP8500:
                             IRCP8600,IRCP8700,IRCP8800
.
          GOTO      IRCP9999
.
IRCP0100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,IRCP0110
          WRITE     HTMLFILE;RCPBK004;     * Cash Drawer
          GOTO      IRCP9999
.
IRCP0110  MOVE      RCPBK004,CASHDRWR
          CALL      CDSLTN00               * Cash Drawer Selection List
          GOTO      IRCP9999
.
IRCP0200  PACK      KEY6,RCBNCDRW
          CALL      RDCIDA1
          IF        OVRCD=1       
            MOVE      "Unknown",FORMATNM
          ELSE
            CLEAR     FORMATNM
            STRIP     RCPGIVEN
            APPEND    RCPGIVEN,FORMATNM
            APPEND    SP1,FORMATNM
            STRIP     RCPSUR
            APPEND    RCPSUR,FORMATNM
            RESET     FORMATNM
          ENDIF
          WRITE     HTMLFILE;FORMATNM;
          GOTO      IRCP9999
.
IRCP0300  PACK      KEY10,USERID,SP70      * Cashier / Web user
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      USERID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      IRCP9999
.
IRCP0400  MOVE      SP10,GOVTAGNC          * Govt Agency
          CALL      GOVTAG00
          GOTO      IRCP9999
.
IRCP0500  CALL      PAYTAB00               * Payment List
          GOTO      IRCP9999
.
IRCP0600  WRITE     HTMLFILE;ACCMTOTL;     * accumulative Total
          GOTO      IRCP9999
.
IRCP0700  MOVE      CODECR,CATEGORY        * Card Type Selection List
          MOVE      RCBDCRDT,CODE
          CALL      CODITM00
          GOTO      IRCP9999
.
IRCP0800  WRITE     HTMLFILE;ALLCTOTL;     * allocated Total
          GOTO      IRCP9999
.
IRCP0900  PACK      KEY6,RCPBK004
          CALL      RDCIDA1
          BRANCH    OVRCD,IRCP9999
          WRITE     HTMLFILE;RCCICHQA;      * get default cheq account
          GOTO      IRCP9999
.
IRCP1000  MOVE      SP10,REGISTER           * register   
          CALL      REGSLT00
          GOTO      IRCP9999
.
IRCP1100  MOVE      ZERO,CLAIMFLG
          CALL      DETTAB00               * Receipt Detail List
          GOTO      IRCP9999
.
IRCP1200  MOVE      TMDTPRAC,PRACTICE        * private practice
          CALL      MPRSEL00
          GOTO      IRCP9999
.
IRCP1300  
.         MOVE      REGGST,GSTCODE            * gst code   
          CALL      IBAGST00
          GOTO      IRCP9999
.
IRCP1400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      SP70,LEDNO
          MATCH     "1",RCCNLEDG          * One char of Ledger account
          IF        @EQUAL
            UNPACK    INCMACCT,LEDNUM,ACCNO
          ELSE
            UNPACK    INCMACCT,LEDNO,ACCNO
          ENDIF
          BRANCH    F1,IRCP1410,IRCP1420
.
          MATCH     SP70,LEDNO        
          GOTO      IRCP9999 IF EQUAL
.
          PACK      KEY2,LEDNO,SP70
          CALL      RDFMLA1
          BRANCH    OVRCD,IRCP9999
.
          WRITE     HTMLFILE;FMLADESC;    * General Ledger Desc
          GOTO      IRCP9999
.
IRCP1410  MATCH     "1",RCCNLEDG          * One char of Ledger account
          IF        @EQUAL
            MATCH     SP70,LEDNUM
            GOTO      IRCP9999 IF EQUAL
            WRITE     HTMLFILE;LEDNUM;      * General Ledger Code
          ELSE
            MATCH     SP70,LEDNO
            GOTO      IRCP9999 IF EQUAL
            WRITE     HTMLFILE;LEDNO;       * General Ledger Code
          ENDIF
          GOTO      IRCP9999
.
IRCP1420  CALL      LEDGER00              * Ledger Selection List
          GOTO      IRCP9999
.
IRCP1500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,INCMACCT         * General Ledger Income A/C
          GOTO      IRCP9999 IF EQUAL
.
          BRANCH    F1,IRCP1510
.
          PACK      KEY14,INCMACCT,SP70
          CALL      RDFMAM1
          BRANCH    OVRCD,IRCP9999
.
          WRITE     HTMLFILE;FMAMDESC;    * Income Account Description
          GOTO      IRCP9999
.
IRCP1510  MATCH     "1",RCCNLEDG          * One char of Ledger account
          IF        @EQUAL
            UNPACK    INCMACCT,LEDNUM,ACCNO
          ELSE
            UNPACK    INCMACCT,LEDNO,ACCNO
          ENDIF
          WRITE     HTMLFILE;ACCNO;       * Income Account Code
          GOTO      IRCP9999
.
IRCP1600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      GETC0000              * Get Control Account Details
.
.  Get Bank Ledger/Account Code and Name
.
          PACK      KEY14,FMAMLEDG,FMCSBNK,SP20
          CALL      RDFMAM1              * Account Master Details
          BRANCH    OVRCD,IRCP9999
          BRANCH    F1,IRCP1610
.
          WRITE     HTMLFILE;FMAMDESC;               * Bank Ledger/Acc Desc
          GOTO      IRCP9999
IRCP1610  PACK      KEY18,FMLALEDG,SLASH,FMCSBNK     * Bank Ledger/Acc Code
          WRITE     HTMLFILE;KEY18;
          GOTO      IRCP9999
.
IRCP1700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      GETC0000              * Get Control Account Details
.
.  Get Debtor Control Ledger/Account
.
          PACK      KEY14,FMAMLEDG,FMCSDEB,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,IRCP9999
          BRANCH    F1,IRCP1710
.
          WRITE     HTMLFILE;FMAMDESC;               * Desc
          GOTO      IRCP9999
.
IRCP1710  PACK      KEY18,FMLALEDG,SLASH,FMCSDEB     * Debtors Cont Ledger/Acc
          WRITE     HTMLFILE;KEY18;
          GOTO      IRCP9999
.
IRCP1800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      GETC0000              * Get Control Account Details
.
.  Get GST Control Account
.
          PACK      KEY14,FMAMLEDG,FMCSAGST,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,IRCP9999
          BRANCH    F1,IRCP1810
.
          WRITE     HTMLFILE;FMAMDESC;              * Desc
          GOTO      IRCP9999
.
IRCP1810  PACK      KEY18,FMLALEDG,SLASH,FMCSAGST
          WRITE     HTMLFILE;KEY18;
          GOTO      IRCP9999
.
IRCP1900  WRITE     HTMLFILE;SYSTEMCD;
          GOTO      IRCP9999
.
.         Get Invoice outstanding Amount for Input receipt at hospital level
.
IRCP2000  MOVE      ZERO,OUTSTAMT
          IF        SYSTEMCD=1
            MOVE      ZERO,CSHTFLAG    * Do not recalc non-banked total
            CALL      GTINVT00         * Invoice Total
          ENDIF
          IF        SYSTEMCD=2
            MOVE      ZERO,CSHTFLAG    * Do not recalc non-banked total
            CALL      GTPPIT00         * Priv Prac Invoice Total
          ENDIF
          IF        SYSTEMCD=5
            MOVE      ZERO,CSHTFLAG    * Do not recalc non-banked total
            CALL      GTARIT00         * Acc Rec Invoice Total
          ENDIF
          WRITE     HTMLFILE;OUTSTAMT;
          GOTO      IRCP9999
.
IRCP2100  MATCH     TMDTURNO,SP10
          GOTO      IRCP9999 IF EQUAL
.
          IF        SYSTEMCD=1          
            GOTO      IRCP2110
          ENDIF
          IF        (SYSTEMCD=2 | SYSTEMCD=96)
            MATCH     "1",TMDTSFLG
            GOTO      IRCP2110 IF EQUAL
            GOTO      IRCP2120
          ENDIF
          IF        SYSTEMCD=5
            MATCH     "1",TMDTSFLG
            GOTO      IRCP2110 IF EQUAL
            GOTO      IRCP2130
          ENDIF
.
.         PMI 
.
IRCP2110  PACK      KEY8,TMDTURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,IRCP9999
          GOTO      IRCP2190
.
.         PP Debtor 
.
IRCP2120  
.          PACK      KEY8,TMDTURNO,SP70
.          CALL      RDPRDB1
.          BRANCH    OVRCD,IRCP9999
.
.          MOVE      PRDBSNAM,PSNAME
.          MOVE      PRDBGNAM,PGNAME
.          MOVE      PRDBTITL,PTITL
          MOVE      SP70,PSNAME
          MOVE      SP70,PGNAME
          PACK      PTMASNAM,SP70
          MOVE      SP70,PTITL
          GOTO      IRCP2190
.
.         Acc Rec Debtor 
.
IRCP2130  COMPARE   ONE,HSYS6
          GOTO      IRCP9999 IF NOT EQUAL
.
          PACK      KEY8,TMDTURNO,SP70
          CALL      RDDBDB1
          BRANCH    OVRCD,IRCP9999
.
          MOVE      DBDBNA1,PSNAME
          MOVE      DBDBNA2,PGNAME
          PACK      PTMASNAM,PSNAME,SP70
          MOVE      SP10,PTITL
          GOTO      IRCP2190
.
IRCP2190  CALL      PATNAA00
          WRITE     HTMLFILE;PATFNAME;
          GOTO      IRCP9999
.
.
IRCP2200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      SP70,LEDNO
          MATCH     "1",RCCNLEDG          * One char of Ledger account
          IF        @EQUAL
            UNPACK    RCDTINCA,LEDNUM,ACCNO
          ELSE
            UNPACK    RCDTINCA,LEDNO,ACCNO
          ENDIF
          BRANCH    F1,IRCP2210,IRCP2220
.
          MATCH     SP70,LEDNO        
          GOTO      IRCP9999 IF EQUAL
.
          PACK      KEY2,LEDNO,SP70
          CALL      RDFMLA1
          BRANCH    OVRCD,IRCP9999
.
          WRITE     HTMLFILE;FMLADESC;    * General Ledger Desc
          GOTO      IRCP9999
.
IRCP2210  MATCH     "1",RCCNLEDG          * One char of Ledger account
          IF        @EQUAL
            MATCH     SP70,LEDNUM
            GOTO      IRCP9999 IF EQUAL
            WRITE     HTMLFILE;LEDNUM;     * General Ledger Code
          ELSE
            MATCH     SP70,LEDNO
            GOTO      IRCP9999 IF EQUAL
            WRITE     HTMLFILE;LEDNO;       * General Ledger Code
          ENDIF
          GOTO      IRCP9999
.
IRCP2220  CALL      LEDGER00              * Ledger Selection List
          GOTO      IRCP9999
.
IRCP2300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,RCDTINCA         * General Ledger Income A/C
          GOTO      IRCP9999 IF EQUAL
.
          BRANCH    F1,IRCP2310
.
          PACK      KEY14,RCDTINCA,SP70
          CALL      RDFMAM1
          BRANCH    OVRCD,IRCP9999
.
          WRITE     HTMLFILE;FMAMDESC;    * Income Account Description
          GOTO      IRCP9999
.
IRCP2310  MATCH     "1",RCCNLEDG          * One char of Ledger account
          IF        @EQUAL
            UNPACK    RCDTINCA,LEDNUM,ACCNO
          ELSE
            UNPACK    RCDTINCA,LEDNO,ACCNO
          ENDIF
          WRITE     HTMLFILE;ACCNO;       * Income Account Code
          GOTO      IRCP9999
.
IRCP2400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      RCDTINCA,INCMACCT
          CALL      GETC0000              * Get Control Account Details
.
.  Get Bank Ledger/Account Code and Name
.
          PACK      KEY14,FMAMLEDG,FMCSBNK,SP20
          CALL      RDFMAM1              * Account Master Details
          BRANCH    OVRCD,IRCP9999
          BRANCH    F1,IRCP2410
.
          WRITE     HTMLFILE;FMAMDESC;               * Bank Ledger/Acc Desc
          GOTO      IRCP9999
IRCP2410  PACK      KEY18,FMLALEDG,SLASH,FMCSBNK     * Bank Ledger/Acc Code
          WRITE     HTMLFILE;KEY18;
          GOTO      IRCP9999
.
IRCP2500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      RCDTINCA,INCMACCT
          CALL      GETC0000              * Get Control Account Details
.
.  Get Debtor Control Ledger/Account
.
          PACK      KEY14,FMAMLEDG,FMCSDEB,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,IRCP9999
          BRANCH    F1,IRCP2510
.
          WRITE     HTMLFILE;FMAMDESC;               * Desc
          GOTO      IRCP9999
.
IRCP2510  PACK      KEY18,FMLALEDG,SLASH,FMCSDEB     * Debtors Cont Ledger/Acc
          WRITE     HTMLFILE;KEY18;
          GOTO      IRCP9999
.
IRCP2600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      RCDTINCA,INCMACCT
          CALL      GETC0000              * Get Control Account Details
.
.  Get GST Control Account
.
          PACK      KEY14,FMAMLEDG,FMCSAGST,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,IRCP9999
          BRANCH    F1,IRCP2610
.
          WRITE     HTMLFILE;FMAMDESC;              * Desc
          GOTO      IRCP9999
.
IRCP2610  PACK      KEY18,FMLALEDG,SLASH,FMCSAGST
          WRITE     HTMLFILE;KEY18;
          GOTO      IRCP9999
.
IRCP2700  MOVE      TMBNCHQA,CHQACCNT           * cheque account selection list
          CALL      CHQSLT00
          GOTO      IRCP9999
.
IRCP2800  CALL      INVITM00                    * Acc Rec Invoice items list
          GOTO      IRCP9999
.
IRCP2900  MATCH     Z70,RCPDE005                  
          IF        @EQUAL
            MATCH     SP70,TMDTINVN             * used for Update Screen
            GOTO      IRCP9999 IF EQUAL
            MOVE      TMDTINVN,RCPDE005
          ENDIF
          WRITE     HTMLFILE;RCPDE005;
          GOTO      IRCP9999
.
IRCP3000  MATCH     Z70,RCPDE007                  
          GOTO      IRCP9999 IF EQUAL
          WRITE     HTMLFILE;RCPDE007;
          GOTO      IRCP9999
.
IRCP3100  MATCH     Z70,PATIENTN                  
          GOTO      IRCP9999 IF EQUAL
          WRITE     HTMLFILE;PATIENTN;
          GOTO      IRCP9999
.
IRCP3200  MATCH     Z70,RCPDE015                  
          GOTO      IRCP9999 IF EQUAL
          WRITE     HTMLFILE;RCPDE015;
          GOTO      IRCP9999
.
IRCP3300  COMPARE   ZERO,BALANCEA                  
          GOTO      IRCP9999 IF EQUAL
          WRITE     HTMLFILE;BALANCEA;
          GOTO      IRCP9999
.
IRCP3400  MATCH     Z70,RCPDE018                  
          GOTO      IRCP9999 IF EQUAL
          WRITE     HTMLFILE;RCPDE018;
          GOTO      IRCP9999
.
IRCP3500  MATCH     Z70,RCPDE019                  
          GOTO      IRCP9999 IF EQUAL
          WRITE     HTMLFILE;RCPDE019;
          GOTO      IRCP9999
.
IRCP3600  WRITE     HTMLFILE;PRINTFLG;
          GOTO      IRCP9999
.
IRCP3700  WRITE     HTMLFILE;SELPRINT;
          GOTO      IRCP9999
.
IRCP3800  WRITE     HTMLFILE;NOCOPIES;
          GOTO      IRCP9999
.
IRCP3900  UNPACK    DIM127,D1,KEY2,DIM127
          MOVE      ZERO,FORM2
          MOVE      KEY2,FORM2
.
          IF        IBCNMHOS=1
            MATCH     SP10,ADMISSNO          * skip if no visit no.
            IF        !@EQUAL
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDPMVX11
              IF        OVRCD=1
                MOVE      SP10,PMVXMHOS
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY5,FORM2,SP70
          CALL      RDSREGA3
IRCP3910  CALL      RDKREGA3
          BRANCH    OVRCD,REGSLT99
.
          MATCH     "1",REGACTIV
          GOTO      IRCP3910 IF EQUAL
.
          COMPARE   REGIBACD,FORM2
          GOTO      IRCP9999 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     "1",RCCNORUH
            IF        @EQUAL
              MATCH     WBSEHOSP,REGHOSP
              GOTO      IRCP3910 IF NOT EQUAL
            ENDIF
.
            MATCH     SP10,ADMISSNO
            IF        !@EQUAL
              MATCH     PMVXMHOS,REGHOSP
              GOTO      IRCP3910 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY7,QUOTE,REGCODE,REGIBACD,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY7,">",REGDESC:
                             "</option>";
          GOTO      IRCP3910
.
IRCP4000  WRITE     HTMLFILE;INVOICEN;
          GOTO      IRCP9999
.
IRCP4100  WRITE     HTMLFILE;URNUMBER;
          GOTO      IRCP9999
.
IRCP4200  WRITE     HTMLFILE;ADMISSNO;
          GOTO      IRCP9999
.
IRCP4300  WRITE     HTMLFILE;VISITTYP;
          GOTO      IRCP9999
.
IRCP4400  WRITE     HTMLFILE;RCCNOVRP;
          GOTO      IRCP9999
.
IRCP4500  WRITE     HTMLFILE;SUSALLOC;
          GOTO      IRCP9999
.
.         Get Invoice outstanding Amount for Input receipt at patient level
.
IRCP4600  MOVE      ZERO,OUTSTAMT
          MOVE      INVOICEN,TMDTINVN
.
          MATCH     "1",VISITTYP
          GOTO      IRCP4620 IF EQUAL   * A&E
          MATCH     "2",VISITTYP
          GOTO      IRCP4620 IF EQUAL   * Outpatient
          MATCH     "3",VISITTYP
          GOTO      IRCP4640 IF NOT EQUAL * Not Inpatient
.
IRCP4620  MOVE      ZERO,CSHTFLAG    * Do not recalc non-banked total
          CALL      GTINVT00          * Get Patient Invoice outstanding amt
.
IRCP4640  MATCH     "4",VISITTYP
          IF        @EQUAL
            MOVE      ZERO,CSHTFLAG    * Do not recalc non-banked total
            CALL      GTPPIT00          * Get Pri Prac Invoice outstanding amt
          ENDIF
          WRITE     HTMLFILE;OUTSTAMT;
          GOTO      IRCP9999
.
IRCP4700  PACK      KEY16,ADMISSNO,SP8
          CALL      RDSINV3
          CALL      RDKINV3
          BRANCH    OVRCD,IRCP4790
.
          MATCH     ADMISSNO,DPINVADM      * no invoices on file so valid
          GOTO      IRCP4790 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;          * An invoice already exists
          GOTO      IRCP9999

IRCP4790  WRITE     HTMLFILE;ZERO;         * No invoice exists
          GOTO      IRCP9999
.
IRCP4800  WRITE     HTMLFILE;IBCNMHOS;     * Multi-Hospital Indicator 1=Yes
          GOTO      IRCP9999
.
IRCP4900  MATCH     SP1,RCBNSTAT
          GOTO      IRCP9999 IF EQUAL
          MOVE      ZERO,F1
          MOVE      RCBNSTAT,F1
          MOVE      NOTBANKD,STATUS
          LOAD      STATUS,F1,CANCELLD,BANKED
          WRITE     HTMLFILE;STATUS;
          GOTO      IRCP9999
.
IRCP5000  MATCH     SP1,RCBNTTYP
          GOTO      IRCP9999 IF EQUAL
          MOVE      ZERO,F1
          MOVE      RCBNTTYP,F1
          BRANCH    F1,IRCP5010,IRCP5020,IRCP5030,IRCP5040
          WRITE     HTMLFILE;PATIENT;
          GOTO      IRCP9999
.
IRCP5010  PACK      KEY14,RCBNRCOD,HFHEADER,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            MOVE      "02",KEY2               * check HF history for HF Group
            PACK      KEY17,RCBNRCOD,KEY2,SP70
            CALL      PATDDHRD
.
            WRITE     HTMLFILE;HEALTHFD," - ",HFNAME;
          ELSE
            WRITE     HTMLFILE;HEALTHFD;
          ENDIF
          GOTO      IRCP9999
.
IRCP5020  PACK      KEY6,RCBNRCOD,SP70
          CALL      RDINSR1
          IF        OVRCD=0
            WRITE     HTMLFILE;INSRCOMP," - ",INAME;
          ELSE
            WRITE     HTMLFILE;INSRCOMP;
          ENDIF
          GOTO      IRCP9999
.
IRCP5030  PACK      KEY6,RCBNRCOD,SP70
          CALL      RDGOVR1
          IF        OVRCD=0
            WRITE     HTMLFILE;GOVTDEPT," - ",GNAME;
          ELSE
            WRITE     HTMLFILE;GOVTDEPT;
          ENDIF
          GOTO      IRCP9999
.
IRCP5040  PACK      KEY6,RCBNRCOD,SP70
          CALL      RDPAHGP1
          IF        OVRCD=0
            WRITE     HTMLFILE;HLTHFDGP," - ",PTHGDESC;
          ELSE
            WRITE     HTMLFILE;HLTHFDGP;
          ENDIF
          GOTO      IRCP9999
.
IRCP5100  CALL      PRIBUL00                 * PP Bulk Invoice item list
          GOTO      IRCP9999
.
IRCP5200  WRITE     HTMLFILE;CLAIMNUM;         
          GOTO      IRCP9999
.
IRCP5300  MOVE      ONE,CLAIMFLG
          CALL      DETTAB00                 * Receipt Detail List
          GOTO      IRCP9999
.
IRCP5400  CALL      HSEL0000                 * PP Bulk Invoice item list
          GOTO      IRCP9999
.
IRCP5500  MOVE      ZERO,PINVAMT
          MOVE      ZERO,PRTPPINV
          CALL      RINV0000
          BRANCH    OVRCD,IRCP9999
          WRITE     HTMLFILE;PINVAMT;        * total invoice amount
          GOTO      IRCP9999
.
IRCP5600  MOVE      ZERO,PINVREB
          MOVE      ZERO,PRTPPINV
          CALL      RINV0000
          BRANCH    OVRCD,IRCP9999
          WRITE     HTMLFILE;PINVREB;        * total estimate fund rebate
          GOTO      IRCP9999
.
IRCP5700  MOVE      ZERO,PRTPPINV
          CALL      IBAL0000                 * Get invoice balance
          WRITE     HTMLFILE;TOTPAID;
          GOTO      IRCP9999
.
IRCP5800  MOVE      "0",KEY1
          MATCH     "1",TMDTPRIN
          IF        @EQUAL
            MOVE      "1",KEY1
          ENDIF
          WRITE     HTMLFILE;KEY1;             * print invoice Y/N
          GOTO      IRCP9999
.
IRCP5900  WRITE     HTMLFILE;TMDTPRNT;
          GOTO      IRCP9999
.
IRCP6000  WRITE     HTMLFILE;PRINTINV;
          GOTO      IRCP9999
.
IRCP6100  WRITE     HTMLFILE;PRINTCOD;
          GOTO      IRCP9999
.
IRCP6200  COMPARE   ZERO,TMDTTAMT
          GOTO      IRCP9999 IF EQUAL
.
          WRITE     HTMLFILE;TMDTTAMT;
          GOTO      IRCP9999
.
IRCP6300  WRITE     HTMLFILE;CFEETYP;
          GOTO      IRCP9999
.
IRCP6400  WRITE     HTMLFILE;PTCNUFMS;     * Using IBA FMS
          GOTO      IRCP9999
.
IRCP6500  MATCH     SP70,HLTHFUND
          GOTO      IRCP9999 IF EQUAL
          GOTO      IRCP9999 IF EOS
          WRITE     HTMLFILE;HLTHFUND;     * Receipting Health Fund
          GOTO      IRCP9999
.
IRCP6600  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,IRCP9999
.
          MOVE      PSNAME,PACSNAME
.
          MATCH     "1",RCCNPAYF
          IF        @EQUAL
            MOVE      PGNAME,D1            * Use initial not full given name
            MOVE      D1,PACGNAME
          ELSE
            MOVE      PGNAME,PACGNAME
          ENDIF
.
          MOVE      PTITL,PACTITLE
.
          MOVE      ONE,PACFRMT
          CALL      PACNAME                 * Format the patient name
          MATCH     SP70,PACFNAME
          GOTO      IRCP9999 IF EQUAL
          GOTO      IRCP9999 IF EOS
          MOVE      PACFNAME,KEY50
          STRIP     KEY50
          WRITE     HTMLFILE;*+,KEY50;      * Patient name
          GOTO      IRCP9999
.
IRCP6700  MATCH     Z70,RCPDE004
          GOTO      IRCP9999 IF EQUAL
          WRITE     HTMLFILE;RCPDE004;
          GOTO      IRCP9999
.
IRCP6800  CALL      FNDGRP00            *Health Fund Group Selection List
          GOTO      IRCP9999
.
IRCP6900  WRITE     HTMLFILE;HFUNDGRP;     * Receipting Health Fund Group
          GOTO      IRCP9999
.
IRCP7000  MATCH     SP70,HLTHFUND
          IF        @EQUAL|@EOS
            MATCH     SP70,HFUNDGRP
            IF        @EQUAL|@EOS
              WRITE     HTMLFILE;"Patient/Debtor";
            ENDIF
          ENDIF
          MATCH     SP70,HLTHFUND
          IF        !@EQUAL
            WRITE     HTMLFILE;HLTHFUND;
          ENDIF
          PACK      KEY6,HFUNDGRP,SP70
          CALL      RDPAHGP1
          BRANCH    OVRCD,IRCP9999
.
          WRITE     HTMLFILE;PTHGDESC;
          GOTO      IRCP9999
.
IRCP7100  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,IRCP9999
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,DIM1
          PACK      PACGNAME,DIM1,SP70
          MOVE      PTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          REP       UPPLOW,PACFNAME
          WRITE     HTMLFILE;PACFNAME;
          GOTO      IRCP9999
.
IRCP7200  MATCH     Z70,RCPDE003                  
          GOTO      IRCP9999 IF EQUAL
.
          PACK      KEY20,RCPBK001,RCPDE003,SP70
          CALL      RSRCCMN1
IRCP7210  CALL      RKRCCMN1
          BRANCH    OVRCD,IRCP9999
.
          MATCH     RCCMRECN,RCPBK001       * same Receipt Number?
          GOTO      IRCP9999 IF NOT EQUAL
          MATCH     RCCMTCNT,RCPDE003       * same Transaction Count?
          GOTO      IRCP9999 IF NOT EQUAL
.
          MOVE      SP70,KEY50
          UNPACK    RCCMLNDA,KEY50
          WRITE     HTMLFILE;KEY50
          GOTO      IRCP7210
.
IRCP7300  WRITE     HTMLFILE;RECEIPTK;
          GOTO      IRCP9999
.
IRCP7400  MATCH     SP70,RECEIPTK
          GOTO      IRCP9999 IF EQUAL
.
          PACK      KEY20,RECEIPTK,SP70
          CALL      RSRCCMN1
IRCP7410  CALL      RKRCCMN1
          BRANCH    OVRCD,IRCP9999
.
          PACK      DIM17,RCCMRECN,RCCMTCNT,SP70
          MATCH     DIM17,RECEIPTK       * same Receipt Number and Trans.Count?
          GOTO      IRCP9999 IF NOT EQUAL
.
          MOVE      SP70,KEY50
          UNPACK    RCCMLNDA,KEY50
          WRITE     HTMLFILE;KEY50
          GOTO      IRCP7410
.
IRCP7500  WRITE     HTMLFILE;PTCNNHII;
          GOTO      IRCP9999
.
IRCP7600  CALL      SACT0000                * Selection of Action plans
          GOTO      IRCP9999
.
IRCP7700  MOVE      ZERO,F1             * Inv.has not been submitted via Eclipse
          UNPACK    INVOICEN,KEY4,KEY8
          PACK      KEY16,KEY8,SP70
          OPEN      PMSECTA2,"pmsectaf"
          CALL      RDPMECT2
          COMPARE   ZERO,OVRCD
          GOTO      IRCP7740 IF EQUAL
.
IRCP7720  CALL      RKPMECT2
          BRANCH    OVRCD,IRCP7760
.
          MATCH     PMECINVN,PINVNO     * same invoice?
          GOTO      IRCP7760 IF NOT EQUAL
.
IRCP7740  MOVE      ONE,F1
IRCP7760  WRITE     HTMLFILE;F1;        * invoice already been submitted
          GOTO      IRCP9999
.
IRCP7800  WRITE     HTMLFILE;TMDTPRAC;        * Medical practice
          GOTO      IRCP9999
.
IRCP7900  MOVE      "0",KEY1             * set "warning: with Debt Coll. Agency"
          MATCH     "1",PTCNPRDC
          GOTO      IRCP7999 IF NOT EQUAL
.         
          UNPACK    INVOICEN,KEY4,KEY8
.
          MATCH     "3",VISITTYP
          GOTO      IRCP7920 IF EQUAL   * Inpatient
.
.         Check Private Practice
.
          CALL      RDPRIN1
          BRANCH    OVRCD,IRCP7999
.
          PACK      KEY10,KEY8,Z70
          OPEN      PRIRASA1,"prirasaf"
          CALL      RSPRRAS1
          CALL      RPPRRAS1
          COMPARE   ZERO,OVRCD
          GOTO      IRCP7999 IF NOT EQUAL
.
          MATCH     PRRAINVN,KEY8
          GOTO      IRCP7999 IF NOT EQUAL
          MATCH     "1",PRRADELE
          GOTO      IRCP7999 IF EQUAL
          MATCH     SP3,PRRADBAG
          GOTO      IRCP7999 IF EQUAL
          MOVE      "1",KEY1             * set "Warning" flag
          GOTO      IRCP7999
.
IRCP7920  PACK      KEY10,KEY8,Z70
          OPEN      PATRASA1,"patrasaf"
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          COMPARE   ZERO,OVRCD
          GOTO      IRCP7999 IF NOT EQUAL
.
          MATCH     PTRAINVN,KEY8
          GOTO      IRCP7999 IF NOT EQUAL
          MATCH     "1",PTRADELE
          GOTO      IRCP7999 IF EQUAL
          MATCH     SP3,PTRADBAG
          GOTO      IRCP7999 IF EQUAL
          MOVE      "1",KEY1             * set "Warning" flag
IRCP7999  WRITE     HTMLFILE;KEY1;       * Debt Collection Agent warning flag
          GOTO      IRCP9999
.
IRCP8000  PACK      KEY5,ANSC,ANSR,RCBDCRDT
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ZERO,PTCDCRSC
          ENDIF
          WRITE     HTMLFILE;PTCDCRSC;
          GOTO      IRCP9999
.
IRCP8100  MOVE      "0",KEY1
          PACK      KEY6,RCPBK004
          CALL      RDCIDA1
          IF        OVRCD=0
            PACK      KEY1,RCCICCRD,SP70
            REP       " 0",KEY1
          ENDIF
...       WRITE     HTMLFILE;RCCICCRD;      * Charging Credit Card surcharge
          WRITE     HTMLFILE;KEY1;          * Charging Credit Card surcharge
          GOTO      IRCP9999
.
IRCP8200  PACK      KEY6,RCPBK004
          CALL      RDCIDA1
          BRANCH    OVRCD,IRCP9999
          WRITE     HTMLFILE;RCCIINVR;      * default Invoice Register
          GOTO      IRCP9999
.
IRCP8300  PACK      KEY6,RCPBK004
          CALL      RDCIDA1
          BRANCH    OVRCD,IRCP9999
          WRITE     HTMLFILE;RCCIDEPR;      * default Deposit Register
          GOTO      IRCP9999
.
IRCP8400  UNPACK    INVOICEN,KEY4,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,IRCP9999
.
          MATCH     SP70,PRINPRAC
          GOTO      IRCP9999 IF EQUAL
.
          PACK      KEY6,PRINPRAC,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,IRCP9999
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,FORM1
          MOVE      KEY1,FORM1
          BRANCH    FORM1,IRCP8410
.
          WRITE     HTMLFILE;PRPRREGI;      * Register for Private Prac.
          GOTO      IRCP9999
.
IRCP8410  PACK      KEY3,PRPRREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,IRCP9999
          WRITE     HTMLFILE;REGDESC;
          GOTO      IRCP9999
.
IRCP8500  PACK      KEY18,RCPBK014,SP70
          CALL      RSFMEPT1
IRCP8510  CALL      RKFMEPT1
          BRANCH    OVRCD,IRCP9999
.
          MATCH     RCPBK014,FMEPCHQA
          GOTO      IRCP9999 IF NOT EQUAL
.
          MATCH     "1",FMEPACTV
          GOTO      IRCP8510 IF NOT EQUAL
.
          WRITE     HTMLFILE;SP8,"<option value=#"",FMEPPPID,FMEPADDR:
                                  FMEPPORT,"#">",FMEPDESC,"</option>"
          GOTO      IRCP8510
.
IRCP8600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,FORM1
          MOVE      KEY1,FORM1
          BRANCH    FORM1,IRCP8610
.
          WRITE     HTMLFILE;TMDTSDOC;
          GOTO      IRCP9999
.
IRCP8610  PACK      PACFNAME,SP70
          MOVE      SP70,KEY25
          PACK      KEY10,TMDTSDOC,SP10
          CALL      RDPMHCP1                * read the doctors file
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME                 * pack the doctors name
            PACK      KEY25,PACFNAME
          ENDIF
          WRITE     HTMLFILE;KEY25;
          GOTO      IRCP9999
.
IRCP8700  MOVE      "Py",CATEGORY        * Payment Type Selection List
          MOVE      PAYMTYPE,CODE
          CALL      CODITM00
          GOTO      IRCP9999
.
IRCP8800  MOVE      "0",KEY1
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,PAYMTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,IRCP8880
.
          COMPARE   ZERO,PTCDCRSC
          GOTO      IRCP8880 IF EQUAL     * no surcharge
          MOVE      "1",KEY1
.
IRCP8880  WRITE     HTMLFILE;KEY1;
          GOTO      IRCP9999
        
IRCP9999  RETURN
+
.------------------------------------------------------------
. Selection of Action plans
.------------------------------------------------------------
SACT0000  PACK      KEY6,PINVCLM,SP70
          CALL      RSPTFAP1
SACT1000  CALL      RKPTFAP1
          BRANCH    OVRCD,SACT9999
.
          MATCH     PINVCLM,PTFPCLAI
          GOTO      SACT9999 IF NOT EQUAL
.
          MOVE      "AK",KEY2
          PACK      KEY5,KEY2,PTFPACPL,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SACT1000
.
          WRITE     HTMLFILE;"<option value=",PTFPACPL,">",TDESC,"</option>"
          GOTO      SACT1000
.
SACT9999  RETURN
+
.-----------------------------------------------------------
.  Read invoice file
.-----------------------------------------------------------
RINV0000  MOVE      ZERO,FORM12
          MOVE      TMDTINVN,FORM12
          MOVE      FORM12,FORM8
          MOVE      FORM8,KEY8
          IF        PRTPPINV=1
            CALL      RDPRIN1
          ELSE
            CALL      RDINV1
          ENDIF
RINV9999  RETURN
+
.-----------------------------------------------------------
.  Get the invoice outstanding amount including non-banked
.-----------------------------------------------------------
IBAL0000  MOVE      ZERO,TOTPAID
          CALL      RINV0000
          BRANCH    OVRCD,IBAL9999
.
          IF        PRTPPINV=1
            MOVE      PRINPAMT,TOTPAID         * Total Paid
            ADD       PRINHAMT,TOTPAID
            ADD       PRINIAMT,TOTPAID
            ADD       PRINMAMT,TOTPAID
            ADD       PRINVAMT,TOTPAID
            ADD       PRINOTHA,TOTPAID
          ELSE
            MOVE      PINVPATA,TOTPAID         * Total Paid
            ADD       PINVHFDA,TOTPAID
            ADD       PINVOTHA,TOTPAID
          ENDIF
.
          PACK      KEY29,TMDTINVN,SP70
          CALL      RSRCDTE3
IBAL5710  CALL      RKRCDTE3
          BRANCH    OVRCD,IBAL9999
.
          MATCH     TMDTINVN,RCDTINVN        * Same invoice number?
          GOTO      IBAL9999 IF NOT EQUAL
.
          IF        PRTPPINV=1
            MATCH     PRINDEBT,RCDTURNO      * Same debtore?
          ELSE
            MATCH     PINVUR,RCDTURNO        * Same U/R?
          ENDIF
          GOTO      IBAL5710 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,IBAL5710
.
          MATCH     "0",RCBNSTAT             * Cash Not banked?
          GOTO      IBAL5710 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,IBAL5710
          COMPARE   "1",REGIBACD               * Patient receipt
          GOTO      IBAL8000 IF EQUAL
          COMPARE   "2",REGIBACD               * PP receipt
          GOTO      IBAL5710 IF NOT EQUAL
.
IBAL8000  MULT      "-1",RCDTAMNT
          ADD       RCDTAMNT,TOTPAID
          MULT      "-1",RCDTDISC
          ADD       RCDTDISC,TOTPAID
          GOTO      IBAL5710
IBAL9999  RETURN
+
.-----------------------------------------------------------
.  Govt Agency Selection List - patgo1af
.-----------------------------------------------------------
GOVTAG00  PACK      KEY6,SP70
          CALL      RDSGOVR1
GOVTAG10  CALL      RDKGOVR1
          BRANCH    OVRCD,GOVTAG99
.
          PACK      KEY8,QUOTE,GCODE,QUOTE
          MATCH     GOVTAGNC,GCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8,"selected>",GNAME:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">",GNAME:
                               "</option>";
          ENDIF
          GOTO      GOVTAG10
.
GOVTAG99  RETURN
+
.------------------------------------------------------------
. Health Fund Group Selection List
.------------------------------------------------------------
FNDGRP00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,PTHFHGRP
          GOTO      FNDGRP20 IF EQUAL
          PACK      KEY6,PTHFHGRP
          CALL      RDPAHGP1
          BRANCH    OVRCD,FNDGRP20
          BRANCH    F1,FNDGRP10,FNDGRP20
          WRITE     HTMLFILE;PTHGCODE;
          GOTO      FNDGRP99
.
FNDGRP10  WRITE     HTMLFILE;PTHGDESC;
          GOTO      FNDGRP99
.
FNDGRP20  CALL      HGRP0000
.
FNDGRP99  RETURN
.------------------------------------------------------------
. Health Fund Group Selection
.------------------------------------------------------------
HGRP0000  PACK      KEY6,SP70
          CALL      RSPAHGP1
HGRP0100  CALL      RKPAHGP1
          BRANCH    OVRCD,HGRP9999
.
          MOVE      PTHGDESC,KEY50
          PACK      KEY8,QUOTE,PTHGCODE,QUOTE
          MATCH     PTHFHGRP,PTHGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">",KEY50,"</option>"
          ENDIF
          GOTO      HGRP0100
.
HGRP9999  RETURN
+
.-----------------------------------------------------------
.  Cheque Account Selection List - fmschqaf
.-----------------------------------------------------------
CHQSLT00  PACK      KEY15,SP70
          CALL      RSFMCH1
CHQSLT10  CALL      RKFMCH1
          BRANCH    OVRCD,CHQSLT99
.
          PACK      KEY17,QUOTE,FMCHCHQ,QUOTE
          MATCH     CHQACCNT,FMCHCHQ
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY17,"selected>":
                               FMCHDES,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY17,">":
                               FMCHDES,"</option>";
          ENDIF
          GOTO      CHQSLT10
.
CHQSLT99  RETURN
+
.------------------------------------------------------------
.         Remote script for List of medical practice
.------------------------------------------------------------
LMEDPR00  CALL      XMLHED00
          BRANCH    EXIT,LMEDPR99
.
          OPEN      PRIALSA1,"prialsaf"
          OPEN      PRISECA1,"prisecaf"
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY6,SP70
          CALL      RSPRPR1
LMEDPR10  CALL      RKPRPR1
          BRANCH    OVRCD,LMEDPR80
.
          COMPARE   ONE,PRPRSTAT
          GOTO      LMEDPR10 IF EQUAL
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      LMEDPR40 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRPRCODE,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,LMEDPR10
.
LMEDPR40  MOVE      " (",KEY2
          MOVE      " )",DIM2
          PACK      KEY44,PRPRDESC,KEY2,PRPRPDOC,DIM2,SP70
          WRITE     HTMLFILE;PRPRCODE,",",KEY44,"|";
          GOTO      LMEDPR10
.
LMEDPR80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      LMEDPR98

LMEDPR98  CALL      XMLEND00
LMEDPR99  RETURN
+
.------------------------------------------------------------
.  Outputs a selection list of Medical Practices
.----------------------------------------------------------------
MPRSEL00  COMPARE   ONE,HSYS3
          GOTO      MPRSEL99 IF NOT EQUAL
.
          MOVE      ZERO,F1
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,MPRSEL20,MPRSEL30
.
          PACK      KEY6,SP70
          CALL      RSPRPR1
MPRSEL10  CALL      RKPRPR1
          BRANCH    OVRCD,MPRSEL99
.
          COMPARE   ONE,PRPRSTAT
          GOTO      MPRSEL10 IF EQUAL
.
          MATCH     PRACTICE,PRPRCODE    * Default Medical Records Location
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PRPRCODE,"#" selected>":
                                 PRPRDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PRPRCODE,"#">":
                                 PRPRDESC,"</option>"
          ENDIF
.
          GOTO    MPRSEL10
.
MPRSEL20  WRITE     HTMLFILE;PRACTICE;
          GOTO      MPRSEL99
.
MPRSEL30  PACK      KEY6,PRACTICE,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,MPRSEL99
          WRITE     HTMLFILE;PRPRDESC;
.
MPRSEL99  RETURN
+
.-------------------------------------------------
. GST Selection List
.-------------------------------------------------
IBAGST00  PACK      KEY6,SP70
          CALL      RSIBGS1
IBAGST10  CALL      RKIBGS1
          BRANCH    OVRCD,IBAGST99
.
          COMPARE   ONE,IBGSACTV          * Active Indicator
          GOTO      IBAGST10 IF EQUAL
.
          MATCH     GSTCODE,IBGSCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected>":
                               IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#">":
                               IBGSDESC,"</option>"
          ENDIF
          GOTO      IBAGST10
.
IBAGST99  RETURN
+
.------------------------------------------------------------
. Ledger Selection List
.------------------------------------------------------------
LEDGER00  PACK      KEY2,SP70
          CALL      RSFMLA1
LEDGER10  CALL      RKFMLA1
          BRANCH    OVRCD,LEDGER99
.
          MATCH     LEDNO,FMLALEDG
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",FMLALEDG," selected>":
                               FMLADESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",FMLALEDG,">":
                               FMLADESC,"</option>"
          ENDIF
          GOTO      LEDGER10
.
LEDGER99  RETURN
+
.------------------------------------------------------------------------
. Get Control Account Details
.------------------------------------------------------------------------
GETC0000  UNPACK    INCMACCT,LEDNO,ACCNO
          PACK      KEY2,LEDNO
          CALL      RDFMLA1              * Ledger Master Details
          MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
          PACK      KEY14,INCMACCT,SP70
          CALL      RDFMCS1              * Selected Control Accounts
          BRANCH    OVRCD,GETC9000
.
          MATCH     SP70,FMCSBNK
          GOTO      GETC0010 IF NOT EQUAL
.
          MOVE      FMLABNK,FMCSBNK
.
GETC0010  MATCH     SP70,FMCSDEB
          GOTO      GETC0020 IF NOT EQUAL
.
          MOVE      FMLADEB,FMCSDEB
.
GETC0020  MATCH     SP70,FMCSAGST
          GOTO      GETC9999 IF NOT EQUAL
.
          MOVE      FMLAAGST,FMCSAGST
.
          GOTO      GETC9999
.
GETC9000  MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
GETC9999  RETURN
.-----------------------------------------------------------
.  Register Selection List - rcpregaf
.-----------------------------------------------------------
REGSLT00  READ      CONTROLF,THIRTY6;*221,RCCNORUH
.
          PACK      KEY38,SP70                                         *C-58556
          CALL      RDSREGA4                                           *C-58556
REGSLT10  CALL      RDKREGA4                            * was RDKREGA1 *C-58556
          BRANCH    OVRCD,REGSLT99
.
          MATCH     "1",REGACTIV            * 1=Inactive               *I-58556
          GOTO      REGSLT10 IF EQUAL       * bypass Inactive          *I-58556
.
          IF        IBCNMHOS=1
            MATCH     "1",RCCNORUH
            IF        @EQUAL
              MATCH     WBSEHOSP,REGHOSP
              GOTO      REGSLT10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          COMPARE    "89",REGIBACD
          GOTO       REGSLT10 IF EQUAL     * skip Credit Card surcharge register
.
          PACK      KEY7,QUOTE,REGCODE,REGIBACD,QUOTE
          MATCH     REGISTER,REGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY7,"selected>",REGDESC:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY7,">",REGDESC:
                               "</option>";
          ENDIF
          GOTO      REGSLT10
.
REGSLT99  RETURN
+
.-----------------------------------------------------------
.  Payment Type Detail Table
.-----------------------------------------------------------
PAYTAB00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,LINK2PRT
          MOVE      KEY1,LINK2PRT
.
          MATCH     RCPBK001,Z70
          GOTO      PAYTAB99 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          CALL      RDTMBNK1
          BRANCH    OVRCD,PAYTAB99 
.
          PACK      KEY15,RCPBK001,SP70
          CALL      RSTMBDT1
PAYTAB05  CALL      RKTMBDT1
          BRANCH    OVRCD,PAYTAB99
.
          MATCH     TMBDRECN,RCPBK001
          GOTO      PAYTAB99 IF NOT EQUAL
.
          MOVE      ZERO,F2
          SQUEEZE   TMBDPTYP
          MOVE      TMBDPTYP,F2
          MOVE      SP20,KEY16
.
          IF        PTCNNHII=ONE
            LOAD      KEY16,F2,TYPECASH,TYPECHEQ,TYPECRDT,TYPEDRCD,TYPEMONY:
                               TYPEEFTT,TYPEBPAY,TYPEHCAP,TYPEMCAR
          ELSE
            LOAD      KEY16,F2,TYPECASH,TYPECHEQ,TYPECRDT,TYPEDRCT,TYPEMONY:
                               TYPEEFTT,TYPEBPAY,TYPEHCAP,TYPEMCAR
          ENDIF
.
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,TMBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            SQUEEZE   PTCDNHCP
            MOVE      PTCDNHCP,F2
            PACK      KEY16,TDESC
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap>";
.
          IF        LINK2PRT=1
            WRITE     HTMLFILE;"<A HREF='javascript:UpdateReceipt":
                               "(#"",TMBDRECN,"#",#"",TMBDUNIQ,"#",#"":
                               TMBDPCOD,"#")'>":
                               "<img src=../images/MaintenanceIcon.gif":
                               " hspace=4 border=0 align=absmiddle></a>";
          ENDIF
.
          WRITE     HTMLFILE;KEY16,"</td>":
                             "<td align=right>$",TMBDPAMT,NBSP,"</td>";
.
          BRANCH    F2,PAYTAB10:         * Cash
                       PAYTAB20:         * Cheque
                       PAYTAB30:         * Credit Card
                       PAYTAB40:         * Direct Deposit
                       PAYTAB50:         * Money Order
                       PAYTAB60:         * EFTPOS
                       PAYTAB40:         * BPAY
                       PAYTAB40:         * HICAPS
                       PAYTAB10          * Medicare
.
          WRITE     HTMLFILE;"<td>",NBSP,"<b>Payer: </b>",TMBDPAYD:
                             NBSP,"<b>Reference: </b>",TMBDSTRF:
                             "</td></tr>";
          GOTO      PAYTAB05
.
.         Cash
.
PAYTAB10  WRITE     HTMLFILE;"<td>",NBSP,"<b>Payer: </b>",TMBDPAYD,"</td></tr>";
          GOTO      PAYTAB05
.
.         Cheque
.
PAYTAB20  WRITE     HTMLFILE;"<td>",NBSP,"<b>Chq#: </b>",TMBDCHQN:
                             NBSP,"<b>Drawer: </b>",TMBDDRAW:
                             NBSP,"<b>Bank: </b>",TMBDBANK:
                             NBSP,"<b>Branch: </b>",TMBDBRCH:
                             "</td></tr>";
          GOTO      PAYTAB05
.
.         Credit Card
.
PAYTAB30  PACK      KEY5,CODECR,TMBDCRDT,SP10
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Unknown",TDESC
          ENDIF
.
          WRITE     HTMLFILE;"<td>",NBSP,"<b>Card Type: </b>",TDESC:
                             NBSP,"<b>Payer: </b>",TMBDPAYD:
                             "</td></tr>";
          GOTO      PAYTAB05
.
.         Direct Deposit
.
PAYTAB40  WRITE     HTMLFILE;"<td>",NBSP,"<b>Payer: </b>",TMBDPAYD:
                             NBSP,"<b>Statement Reference: </b>":
                             TMBDSTRF,"</td></tr>";
          GOTO      PAYTAB05
.
.         Money Order
.
PAYTAB50  WRITE     HTMLFILE;"<td>",NBSP,"<b>Money Order#: </b>":
                             TMBDCHQN,"</td></tr>";
          GOTO      PAYTAB05
.
.         EFTPOS
.
PAYTAB60  PACK      KEY5,CODECR,TMBDCRDT,SP10
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Unknown",TDESC
          ENDIF
.
          MOVE      "Unknown",KEY10
          MATCH     "1",TMBDEFTT
          IF        @EQUAL
            MOVE      "Cash",KEY10
          ENDIF
          MATCH     "2",TMBDEFTT
          IF        @EQUAL
            MOVE      "Credit",KEY10
          ENDIF
.
          WRITE     HTMLFILE;"<td>",NBSP,"<b>EFT Type: </b>",KEY10;
.
          MATCH     "2",TMBDEFTT
          IF        @EQUAL
            WRITE     HTMLFILE;NBSP,"<b>Card Type: </b>",TDESC;
          ENDIF
.
          WRITE     HTMLFILE;NBSP,"<b>Payer: </b>",TMBDPAYD:
                             NBSP,"<b>Reference: </b>",TMBDSTRF:
                             "</td></tr>";
          GOTO      PAYTAB05
.
PAYTAB99  RETURN
.-----------------------------------------------------------
.  Receipt Detail List
.-----------------------------------------------------------
DETTAB00  MATCH     RCPBK001,Z70
          GOTO      DETTAB99 IF EQUAL
.
          PACK      KEY12,RCPBK001,SP70
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            CALL      RDRCBNK1
          ELSE
            CALL      RDTMBNK1
          ENDIF
          BRANCH    OVRCD,DETTAB99
.
          PACK      KEY17,RCPBK001,SP70
          CALL      RSTMDTE1
DETTAB05  CALL      RKTMDTE1
          BRANCH    OVRCD,DETTAB99
.
          MATCH     RCPBK001,TMDTRECN
          GOTO      DETTAB99 IF NOT EQUAL
.
          PACK      KEY3,TMDTREGI,SP10
          CALL      RDREGA1
          IF        OVRCD=1
            MOVE      "Unknown",REGDESC
          ENDIF
.
          MOVE      ZERO,OUTSTAMT
          IF        REGIBACD=1 
            MOVE      ONE,CSHTFLAG     * Recalc non-banked total
            CALL      GTINVT00         * Invoice Total
          ENDIF
.
          IF        REGIBACD=2
            MOVE      ONE,CSHTFLAG     * Recalc non-banked total
            CALL      GTPPIT00         * Priv Prac Invoice Total
          ENDIF
.
          IF        REGIBACD=5
            MOVE      ONE,CSHTFLAG     * Recalc non-banked total
            CALL      GTARIT00         * Acc Rec Invoice Total
          ENDIF
.
          PACK      KEY3,TMDTREGI,SP10   * restore Register fields
          CALL      RDREGA1
          IF        OVRCD=1
            MOVE      "Unknown",REGDESC
          ENDIF
.
          BRANCH    CLAIMFLG,DETTAB90
.
          MOVE      SP70,KEY3
          WRITE     HTMLFILE;"<tr><td nowrap>";
          MATCH     "1",SUSALLOC
          IF        @EQUAL
            WRITE     HTMLFILE;"<A HREF='javascript:UpdateSuspensePayment":
                               "(#"",TMDTRECN,"#",#"",TMDTTCNT,"#",#"":
                               REGIBACD,"#")'>";
          ELSE
            WRITE     HTMLFILE;"<A HREF='javascript:GoUpdatePayment":
                               "(#"",TMDTRECN,"#",#"",TMDTTCNT,"#",#"":
                               REGIBACD,"#",#"",HLTHFUND,"#",#"":
                               HFUNDGRP,"#")'":
                               " onClick=AddForm.incmpflg.value=1>";
          ENDIF
.
          COMPARE   "1",REGIBACD               * Patient receipt
          GOTO      DETTAB40 IF NOT EQUAL
          MATCH     "1",TMBNPRIN       * Check for All non-balanced Inv.
          GOTO      DETTAB20 IF EQUAL
          MATCH     "1",TMDTPRIN       * Check for reprint individual Inv.
          GOTO      DETTAB20 IF EQUAL
          MOVE      "No ",KEY3
          GOTO      DETTAB40
.
DETTAB20  MOVE      "Yes",KEY3         * Reprint invoice
DETTAB40  WRITE     HTMLFILE;"<img src=../images/MaintenanceIcon.gif":
                             " hspace=4 border=0 align=absmiddle></a>":
                             REGDESC,"</td>":
                             "<td align>",NBSP,TMDTURNO,"</td>":
                             "<td align>",NBSP,TMDTINVN,"</td>":
                             "<td align>",NBSP,TMDTREFR,"</td>":
                             "<td align=right>$",OUTSTAMT,NBSP,"</td>":
                             "<td align=right>$",TMDTAMNT,NBSP,"</td>":
                             "<td align=right>$",TMDTDISC,NBSP,"</td>";
.
          MATCH     "1",SUSALLOC
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td align=center>",KEY3,NBSP,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
          GOTO      DETTAB05
.
DETTAB90  WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<A HREF='javascript:DeleteClaim":
                             "(#"",TMDTRECN,"#",#"",TMDTTCNT,"#")'":
                             " onClick=AddForm.incmpflg.value=1>":
                             "<img src=../images/DeleteIcon.gif":
                             " hspace=4 border=0 align=absmiddle></a>":
                             REGDESC,"</td>":
                             "<td align>",NBSP,TMDTURNO,"</td>":
                             "<td align>",NBSP,TMDTINVN,"</td>":
                             "<td align=right>$",OUTSTAMT,NBSP,"</td>":
                             "<td align=right>$",TMDTAMNT,NBSP,"</td></tr>";
          GOTO      DETTAB05
.
DETTAB99  RETURN
+
.------------------------------------------------------------------------------
. Get Invoice Total               
.------------------------------------------------------------------------------
GTINVT00  MOVE      TMDTINVN,FORM12
          MOVE      FORM12,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,GTINVT99
.
          MOVE      PINVPATA,TOTPAID     * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
          MOVE      PINVAMT,OUTSTAMT      * Total Outstanding
          ADD       TOTPAID,OUTSTAMT
          ADD       PINVJOUR,OUTSTAMT
          ADD       PTINGSTJ,OUTSTAMT
          ADD       PTINCRTT,OUTSTAMT
.
.         Add Non-banked amount
.
          COMPARE   ZERO,CSHTFLAG
          GOTO      GTINVT90 IF EQUAL
.
          CALL      GTNBK000             * recalc non-banked total
.
GTINVT90  ADD       CASHTOT,OUTSTAMT
GTINVT99  RETURN
+
.------------------------------------------------------------------------------
. Get Private Practice Invoice Total               
.------------------------------------------------------------------------------
GTPPIT00  COMPARE   ONE,HSYS3
          GOTO      GTPPIT99 IF NOT EQUAL
.
          MOVE      ZERO,OUTSTAMT
          MOVE      TMDTINVN,FORM12
          MOVE      FORM12,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,GTPPIT99
.
          MOVE      PRINPAMT,TOTPAID     * Total Paid
          ADD       PRINHAMT,TOTPAID
          ADD       PRINIAMT,TOTPAID
          ADD       PRINMAMT,TOTPAID
          ADD       PRINVAMT,TOTPAID
          ADD       PRINOTHA,TOTPAID
.
          MOVE      PRINITOT,OUTSTAMT      * Total Outstanding
          ADD       TOTPAID,OUTSTAMT
          ADD       PRINJAMT,OUTSTAMT
          ADD       PRINCNTT,OUTSTAMT
.
.         Add Non-banked amount
.
          COMPARE   ZERO,CSHTFLAG
          GOTO      GTPPIT90 IF EQUAL
.
          CALL      GTNBK000             * recalc non-banked total
.
GTPPIT90  ADD       CASHTOT,OUTSTAMT
.
GTPPIT99  RETURN
+
.------------------------------------------------------------------------------
. Get Account Receivable Invoice Total               
.------------------------------------------------------------------------------
GTARIT00  COMPARE   ONE,HSYS6
          GOTO      GTARIT99 IF NOT EQUAL
.
          MOVE      ZERO,FRSTFLAG
          MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
.
          PACK      KEY36,TMDTURNO,TMDTINVN,SP70
          CALL      RSDBFD6
GTARIT20  CALL      RKDBFD6
          BRANCH    OVRCD,GTARIT50
.
          MATCH     TMDTURNO,DBFDDEB
          GOTO      GTARIT50 IF NOT EQUAL   * Not same debtor
          MATCH     DBFDINV,TMDTINVN
          GOTO      GTARIT50 IF NOT EQUAL   * Not same invoice
.
GTARIT30  MOVE      ONE,FRSTFLAG
          MOVE      ZERO,FORM1
          MOVE      DBFDDTY,FORM1
          BRANCH    FORM1,GTARIT31,GTARIT32,GTARIT32,GTARIT34,GTARIT35
          GOTO      GTARIT20
.
GTARIT31  ADD       DBFDTOT,PINVAMT       * invoice amount
          ADD       DBFDTAX,PINVAMT       * Tax amount
          GOTO      GTARIT20
.
GTARIT32  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,TOTPAID     * payments
          GOTO      GTARIT20
.
GTARIT34  ADD       DBFDPAID,PINVJOUR    * Debit Adjustment Journals
          GOTO      GTARIT20
.
GTARIT35  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,PINVJOUR    * Credit Adjustment Journals
          GOTO      GTARIT20
.
GTARIT50  COMPARE   ZERO,FRSTFLAG
          GOTO      GTARIT99 IF EQUAL
. 
          MOVE      PINVAMT,OUTSTAMT    * Total Outstanding
          ADD       TOTPAID,OUTSTAMT
          ADD       PINVJOUR,OUTSTAMT      
          ADD       PTINCRTT,OUTSTAMT
.
.         Add Non-banked amount
.
          COMPARE   ZERO,CSHTFLAG
          GOTO      GTARIT90 IF EQUAL
.
          CALL      GTNBK000             * recalc non-banked total
.
GTARIT90  ADD       CASHTOT,OUTSTAMT
.
GTARIT99  RETURN
+
.------------------------------------------------------------------------------
. Display Invoice Items Table
.------------------------------------------------------------------------------
INVITM00  COMPARE   ONE,HSYS6
          GOTO      INVITM99 IF NOT EQUAL
.
          MATCH     Z70,RCPDE005
          IF        @EQUAL
            MATCH     SP70,TMDTINVN           * for Update screen
            GOTO      INVITM99 IF EQUAL
            MOVE      TMDTINVN,RCPDE005
          ENDIF
.
          MOVE      ZERO,TOTAMT  
          MOVE      ZERO,TOTAMTPD
          MOVE      RCPDE005,KEY12
          MOVE      ZERO,FORM12
          MOVE      KEY12,FORM12
          MOVE      FORM12,KEY12
          REP       " 0",KEY12
          PACK      KEY21,ONE,KEY12,SP70
          CALL      RSDBFH6
          CALL      RKDBFH6
          BRANCH    OVRCD,INVITM99
.
          MATCH     "1",DBFHDTY
          GOTO      INVITM99 IF NOT EQUAL
          MATCH     KEY12,DBFHDOC
          GOTO      INVITM99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td colspan=2><hr></td></tr>":
                             "<tr><td align=center colspan=2>":
                             "<b>Invoice ",FORM12,"</b></td></tr>":
                             "<tr><td colspan=2>":
                             "<table align=center cellspacing=0 ":
                             "cellpadding=1 border=1 width=100%>":
                             "<tr><td class=HeadingCell>Sales Item</td>":
                             "<td class=HeadingCell>Date</td>":
                             "<td class=HeadingCell align=right>Quantity</td>":
                             "<td class=HeadingCell align=right width=10%>":
                             "Item Amount</td>":
                             "<td class=HeadingCell align=right width=10%>":
                             "Paid</td>":
                             "<td class=HeadingCell align=right width=10%>":
                             "Journals</td>":
                             "<td class=HeadingCell align=right width=10%>":
                             "Outstanding</td>":
                             "<td class=HeadingCell>Payment</td>":
                             "<td class=HeadingCell>&nbsp;</td>":
                             "</tr>";
.
          MOVE      ZERO,COUNTER            * Initalize counter (record number)
          PACK      KEY36,DBFHDEB,DBFHDOC,SP70
          CALL      RSDBFD6
INVITM10  CALL      RKDBFD6
          BRANCH    OVRCD,INVITM90
.
          MATCH     DBFHDEB,DBFDDEB
          GOTO      INVITM90 IF NOT EQUAL   * Not same debtor
          MATCH     DBFDDOC,DBFHDOC
          GOTO      INVITM90 IF NOT EQUAL   * Not same invoice
.
          MOVE      DBFDILN,SVINVLNE
          CALL      INVTOT00                * Calculate outstanding item amt
          ADD       OUTSTAMT,TOTAMT  
.
          ADD       ONE,COUNTER             * Increment counter
          IF        COUNTER > 99
            GOTO      INVITM90              * Display only first 99 records
          ENDIF
          MOVE      COUNTER,FORM2
          MOVE      FORM2,KEY2
          REP       " 0",KEY2
.
          PACK      KEY8,DBFDITM
          CALL      RDDBIT1        * Read Sales Item Details
          IF        OVRCD=1
            MOVE      "UNKNOWN",DBITIDE
          ENDIF
.
          UNPACK    DBFDIDAT,CCENT,CYEAR,CMON,CDAY
          PACK      KEY10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;",DBITIDE:
                             "<input type=hidden name=invlne",KEY2:
                             " value='",DBFDILN,"'></td>":
                             "<td>&nbsp;",KEY10,"</td>":
                             "<td align=right>&nbsp;",DBFDQTY,"</td>":
                             "<td align=right>&nbsp;$",PINVAMT,"</td>":
                             "<td align=right>&nbsp;$",TOTPAID,"</td>":
                             "<td align=right>&nbsp;$",PINVJOUR,"</td>":
                             "<td align=right>&nbsp;$",OUTSTAMT,"</td>";
.
          PACK      KEY32,RCPBK001,RCPDE003,DBFDINV,DBFDILN,SP70
          CALL      RDTMDBP1
          BRANCH    OVRCD,INVITM20
          ADD       TMDBPAMT,TOTAMTPD
.
          WRITE     HTMLFILE;"<td><input type=text name=invamt",KEY2:
                             " value=",TMDBPAMT," class=Number":
                             " onblur='RoundNumber(this,2);":
                             "chkARAmount();'></td>":
                             "<td><input type=checkbox name=invpay",KEY2:
                             " value=1 onclick='checkPayFlg(this,invamt",KEY2:
                             ");' checked></td>":
                             "<tr>";
          GOTO      INVITM10
.
INVITM20  IF        OUTSTAMT<0
            MOVE      ZERO,OUTSTAMT
          ENDIF
          WRITE     HTMLFILE;"<td><input type=text name=invamt",KEY2:
                             " value=",OUTSTAMT," class='Readonly Number'":
                             " readOnly onblur='RoundNumber(this,2);":
                             "chkARAmount();' tabindex=-1></td>":
                             "<td><input type=checkbox name=invpay",KEY2:
                             " value=1 onclick='checkPayFlg(this,invamt",KEY2:
                             ");'></td>":
                             "<tr>";
          GOTO      INVITM10
.
INVITM90  IF        TOTAMTPD>0
            MOVE      ONE,CHECKFND
          ELSE
            MOVE      ZERO,CHECKFND
          ENDIF
          WRITE     HTMLFILE;"<tr><td colspan=6 align=right>":
                             "<b>Total&nbsp;</b></td>":
                             "<td align=right><b>&nbsp;$",TOTAMT,"</b></td>":
                             "<td><input type=text name=invtotal":
                             " value=",TOTAMTPD," class='Readonly Number'":
                             " readOnly tabindex=-1></td>":
                             "<input type=hidden name=checkfnd value=",CHECKFND:
                             ">":
                             "<td>&nbsp;</td></tr>";
          WRITE     HTMLFILE;"</table></td></tr>";
.
INVITM99  RETURN
+
.------------------------------------------------------------------------------
. Calculate individual invoice item's outstanding amount.
.------------------------------------------------------------------------------
INVTOT00  MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
          MOVE      ZERO,OUTSTAMT
.
.         Save current invoice record
.
          PACK      SAVEKEY,DBFDDEB,DBFDINV,DBFDILN,DBFDDTY,DBFDDOC,DBFDDLN
.
.         Read Invoice item total, amount paid and adjustments
.
          PACK      KEY39,DBFHDEB,DBFHDOC,SVINVLNE,SP70
          CALL      RSDBFD7
INVTOT10  CALL      RKDBFD7
          BRANCH    OVRCD,INVTOT90
.
          MATCH     DBFHDEB,DBFDDEB
          GOTO      INVTOT90 IF NOT EQUAL
          MATCH     DBFHDOC,DBFDINV
          GOTO      INVTOT90 IF NOT EQUAL
          MATCH     SVINVLNE,DBFDILN
          GOTO      INVTOT90 IF NOT EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      DBFDDTY,FORM1
          BRANCH    FORM1,INVTOT21,INVTOT22,INVTOT22,INVTOT24,INVTOT25
          GOTO      INVTOT10
.
INVTOT21  ADD       DBFDTOT,PINVAMT     * invoice amount
          ADD       DBFDTAX,PINVAMT     * Tax amount
          GOTO      INVTOT10
.
INVTOT22  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,TOTPAID     * payments
          GOTO      INVTOT10
.
INVTOT24  ADD       DBFDPAID,PINVJOUR    * Debit Adjustment Journals
          GOTO      INVTOT10
.
INVTOT25  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,PINVJOUR    * Credit Adjustment Journals
          GOTO      INVTOT10
.
INVTOT90  MOVE      PINVAMT,OUTSTAMT   * Total Outstanding
          ADD       TOTPAID,OUTSTAMT
          ADD       PINVJOUR,OUTSTAMT
          ADD       PTINCRTT,OUTSTAMT
.
.         Re-read current invoice item
.
          MOVE      SAVEKEY,KEY39
          CALL      RDDBFD7             
          BRANCH    OVRCD,INVITM99
.
INVTOT99  RETURN
.
.-----------------------------------------------------------
. Private Practice Bulk Billing
.-----------------------------------------------------------
PRIBUL00  COMPARE   ONE,HSYS3
          GOTO      PRIBUL99 IF NOT EQUAL
.
          MATCH     Z70,CLAIMNUM
          GOTO      PRIBUL99 IF EQUAL
          MATCH     SP70,CLAIMNUM
          GOTO      PRIBUL99 IF EQUAL
.
          MOVE      ZERO,TOTAMTPD
          WRITE     HTMLFILE;"<tr><td colspan=2><hr></td></tr>":
                             "<tr><td align=center colspan=2>":
                             "<b>Claim ",CLAIMNUM,"</b></td></tr>":
                             "<tr><td colspan=2>":
                             "<table align=center cellspacing=0 ":
                             "cellpadding=1 border=1 width=100%>":
                             "<tr><td class=HeadingCell>UR Number</td>":
                             "<td class=HeadingCell>Patient Name</td>":
                             "<td class=HeadingCell>Invoice</td>":
                             "<td class=HeadingCell>Medicare</td>":
                             "<td class=HeadingCell>Service Date</td>":
                             "<td class=HeadingCell>Item</td>":
                             "<td class=HeadingCell align=right>":
                             "Amount</td>":
                             "<td class=HeadingCell>Payment</td>":
                             "<td class=HeadingCell>Pay</td>":
                             "</tr>"
.
          MOVE      ZERO,COUNTER            * Initalize counter (record number)
          MOVE      SP10,LSTINVNO            
          PACK      KEY38,ONE,CLAIMNUM,SP70 * only show Printed status
          CALL      RSPRBB6
PRIBUL10  CALL      RKPRBB6
          BRANCH    OVRCD,PRIBUL90
.
          COMPARE   ONE,PRBBSTAT
          GOTO      PRIBUL90 IF NOT EQUAL   * Not printed status
          MATCH     DPRBBCLM,CLAIMNUM
          GOTO      PRIBUL90 IF NOT EQUAL   * Not same claim
.
          MATCH     LSTINVNO,PRBBINVN       * only write one line per invoice
          GOTO      PRIBUL10 IF EQUAL
          MOVE      PRBBINVN,LSTINVNO
.
          ADD       ONE,COUNTER             * Increment counter
          IF        COUNTER > 30
            GOTO      PRIBUL90              * Display only first 30 records
          ENDIF
          MOVE      COUNTER,FORM2
          MOVE      FORM2,KEY2
          REP       " 0",KEY2
.
          MOVE      PRBBINVN,FORM12
          MOVE      FORM12,TMDTINVN
          MOVE      ONE,CSHTFLAG     * Recalc non-banked total
          CALL      GTPPIT00       * Read Invoice and get outstanding balance
          BRANCH    OVRCD,PRIBUL10
          ADD       OUTSTAMT,TOTAMTPD
.
          MOVE      "Unknown Patient",PATFNAME
          IF        PRINSCAN=1
            MOVE      PRINDEBT,KEY8
            CALL      RDMAST1
            IF        OVRCD=0
              CALL      PATNAA00
            ENDIF
          ENDIF
.
          MOVE      "&nbsp;",KEY10
          PACK      KEY22,PRBBINVN,SP70
          CALL      RSPRDT4
          CALL      RKPRDT4
          IF        OVRCD=0
            MATCH     PRDTINVN,PRBBINVN
            IF        @EQUAL
              UNPACK    PRDTSDAT,CCENT,CYEAR,CMON,CDAY
              PACK      KEY10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
            ENDIF
          ENDIF
.
          MOVE      SP10,MOREMBSI
          PACK      DIM16,PRBBCLAM,PRBBINVN,SP70
          PACK      KEY28,PRBBCLAM,PRBBINVN,PRBBITMN,PRBBREGR,SP70
          CALL      RDPRBB1
          CALL      RKPRBB1        * check if more than 1 item
          IF        OVRCD=0       
            PACK      DIM16A,PRBBCLAM,PRBBINVN,SP70
            MATCH     DIM16,DIM16A 
            IF        @EQUAL
              MOVE      "*",MOREMBSI
            ENDIF
          ENDIF
          CALL      RPPRBB1       * re-read original record    
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;",PRINDEBT,"</td>":
                             "<td>&nbsp;",PATFNAME:
                             "<input type=hidden name=clmkey",KEY2:
                             " value='",KEY28,"'></td>":
                             "<td>&nbsp;",PRINNUMB,"</td>":
                             "<td align=right>&nbsp;",PRBBMEDN,"</td>":
                             "<td>&nbsp;",KEY10,"</td>":
                             "<td>&nbsp;",MOREMBSI,PRBBITMN,"</td>":
                             "<td align=right>&nbsp;$",OUTSTAMT,"</td>":
                             "<td><input type=text name=invamt",KEY2:
                             " value=",OUTSTAMT," class='Number'":
                             " onchange='RoundNumber(this,2);":
                             "chkARAmount();'></td>":
                             "<td><input type=checkbox name=invpay",KEY2:
                             " value=1 onclick='checkPayFlg(this,invamt",KEY2:
                             ");' checked></td>":
                             "<tr>";
          GOTO      PRIBUL10
.
PRIBUL90  WRITE     HTMLFILE;"<tr><td colspan=7 align=right>":
                             "<b>Total&nbsp;</b></td>":
                             "<td><input type=text name=invtotal":
                             " value=",TOTAMTPD," class='Readonly Number'":
                             " readOnly tabindex=-1></td>":
                             "<input type=hidden name=checkfnd value=0>":
                             "<td>&nbsp;</td></tr>";
          WRITE     HTMLFILE;"</table></td></tr>";
.
PRIBUL99  RETURN
+
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  PACK      KEY4,SP70 
          CALL      RDSHOSP1
HSEL0100  CALL      RDKHOSP1
          BRANCH    OVRCD,HSEL9999
.
          MOVE      HOSDESC,KEY50
          PACK      KEY6,QUOTE,HOSCODE,QUOTE
          MATCH     Z70,MULDHOSP
          IF        !@EQUAL
            MATCH     MULDHOSP,HOSCODE
          ELSE
            PACK      KEY2,CHOSPNUM
            CALL      RDHOSP2
            IF        OVRCD<>1
              MOVE      HOSCODE,MULDHOSP
            ENDIF
          ENDIF
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
+
.------------------------------------------------------------------------------
.         Check for Credit Card surcharge
.------------------------------------------------------------------------------
CRSC0000  MOVE      ZERO,CRCSFLAG
          MATCH     "6",TMBDPTYP
          GOTO      CRSC9999 IF NOT EQUAL     * not EFTPOS
          MATCH     "2",TMBDEFTT
          GOTO      CRSC9999 IF NOT EQUAL     * not Credit
.
          PACK      KEY5,ANSC,ANSR,TMBDCRDT
          CALL      RDCODE1
          BRANCH    OVRCD,CRSC9999
          COMPARE   ZERO,PTCDCRSC
          GOTO      CRSC9999 IF EQUAL         * no surcharge
.
          PACK      KEY6,TMBNCDRW,SP70
          CALL      RDCIDA1
          IF        OVRCD=0
            MATCH     "1",RCCICCRD
            GOTO      CRSC9999 IF EQUAL    * No Surcharge for the Cash drawer
          ENDIF
.
          MOVE      ONE,CRCSFLAG
          MOVE      TMBDPAMT,FORM12P2         * payment amount
          MULT      PTCDCRSC,FORM12P2
          DIV       "100",FORM12P2            * surcharge amount
.
CRSC9999  RETURN
+
.------------------------------------------------------------------------------
.         Write to Credit Card surcharge
.------------------------------------------------------------------------------
WCSR0000  COMPARE   ZERO,CRCSFLAG
          GOTO      WCSR9999 IF EQUAL
.
          PACK      KEY15,RCBDRECN,RCBDUNIQ,SP70
          CALL      RDRCCRS1
          IF        OVRCD=1
            MOVE      RCBDRECN,RCCRRECN         * Receipt number
            MOVE      RCBDUNIQ,RCCRUNIQ         * Transaction count
            MOVE      RCBDCRDT,RCCRCRTY         * Credit card type
            MOVE      SP70,RCCRACCN             * Account number
            MOVE      ZERO,RCCRSAMN             * surcharge amount
            MOVE      ZERO,RCCRSGST             * surcharge gst amount
            MOVE      SP70,RCCRSPAR
            MOVE      FORM12P2,RCCRSAMN         * payment amount
            CALL      WRRCCRS1
          ELSE
            MOVE      FORM12P2,RCCRSAMN         * payment amount
            CALL      UPRCCRS1
          ENDIF
          ADD       RCCRSAMN,TOTLCRCS           * Total credit card surcharge
.
WCSR9999  RETURN
+
.------------------------------------------------------------------------------
.         Update total of surcharge
.------------------------------------------------------------------------------
UCRD0000  COMPARE   ZERO,TOTLCRCS
          GOTO      UCRD9999 IF EQUAL           * no surcharge
.
          PACK      KEY12,RCPBK001
          CALL      RDRCBNK1
          BRANCH    OVRCD,UCRD9999
.
          ADD       TOTLCRCS,RCBNTOTP           * add surcharge
          CALL      UPRCBNK1
.
.         Write a new record to rcpdetaf file for Surcharge amount
.
          PACK      KEY17,RCPBK001,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          BRANCH    OVRCD,UCRD9999
.
          MATCH     RCPBK001,RCDTRECN           * same receipt number?
          GOTO      UCRD9999 IF NOT EQUAL
.
          CALL      RSUR0000                    * Get Register for Multi Hosp.
.
          MOVE      ZERO,F5
          MOVE      RCDTTCNT,F5
          PACK      KEY20,RCDTTDAT,RCDTRECN
          CALL      CLRPDE00              * clear receipt detail fields
          MOVE      F5,RCDTTCNT
          UNPACK    KEY20,RCDTTDAT,RCDTRECN
          MOVE      "Credit Card Surcharge",RCDTNAME
.
UCRD2000  MOVE      ZERO,F5
          MOVE      RCDTTCNT,F5
          ADD       ONE,F5
          MOVE      F5,RCDTTCNT
.
          MOVE      TOTLCRCS,RCDTAMNT           * total surcharge
          PACK      RCDTREGI,RCCNCRSR,SP70      * Register for Surcharge
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      RARCDTE1
          COMPARE   ZERO,OVRCD
          GOTO      UCRD2000 IF EQUAL
.
          UNPACK    SP70,TMDTMHOS,TMDTGSTC,TMDTINCA,TMDTBNKA
          MOVE      RCDTREGI,TMDTREGI
          CALL      GTACCT00              * get income and control accounts
          MOVE      TMDTMHOS,RCDTMHOS
          MOVE      TMDTGSTC,RCDTGSTC
          MOVE      TMDTINCA,RCDTINCA
          MOVE      TMDTBNKA,RCDTBNKA
.
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT        * date updated
          CLOCK     TIME,RCDTCTIM        * time updated
          MOVE      USERID,RCDTCUID      * web user id
          CALL      WRRCDTE1
.
UCRD9999  RETURN
+
.------------------------------------------------------------------------------
.         Get Register for Credit card surcharge for Multi hospitals
.------------------------------------------------------------------------------
RSUR0000  COMPARE   ONE,IBCNMHOS
          GOTO      RSUR8000 IF NOT EQUAL      * Not multi hospital
.
          MATCH     SP10,RCDTVIST              * skip if no visit no.
          GOTO      RSUR6000 IF EQUAL
.
          PACK      KEY8,RCDTVIST,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,RSUR6000
.
          MATCH     SP70,PMVXMHOS
          GOTO      RSUR6000 IF EQUAL        * blank hospital id
          PACK      KEY3,PMVXMHOS,SP70
          GOTO      RSUR7000
.
RSUR6000  MATCH     SP70,WBSEHOSP
          GOTO      RSUR8000 IF EQUAL        * blank hospital id
          PACK      KEY3,WBSEHOSP,SP70
.
RSUR7000  CALL      RDPTHSP1
          BRANCH    OVRCD,RSUR8000
.
          MATCH     SP70,PTHSCRSR
          GOTO      RSUR8000 IF EQUAL
.
          PACK      RCCNCRSR,PTHSCRSR,SP70
.
RSUR8000  MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          IF        OVRCD=0
            MATCH     SP70,RCRECSUR         * Register for Credit Card Surcharge
            IF        !@EQUAL
              PACK      RCCNCRSR,RCRECSUR,SP70
            ENDIF
          ENDIF
RSUR9999  RETURN
+
.------------------------------------------------------------------------------
. I/O and Subroutine Includes
.------------------------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       DAYOFWEK
          INC       RSHWEBCD
          INC       WEBDATCD
          INC       PATDDHRD
.
          INC       APSMASIO/INC            
          INC       BOKRC1IO/INC            
          INC       COMDEPIO/INC      * Deposit file
.
          INC       DEBDBTIO/INC            
          INC       DEBFTHIO/INC            
          INC       DEBFDTIO/INC            
          INC       DEBITMIO/INC
.
          INC       AAEDE1IO/INC
          INC       EMRVISIO/INC
.
          INC       FMSLMAIO/INC      * Ledger Master Details
          INC       FMSAMAIO/INC
          INC       FMSCSAIO/INC
          INC       FMSCHQIO/INC
          INC       FMSEPTIO/INC
.
          INC       IBAGSTIO/INC      * GST Master
          INC       IBATMDIO/INC            * Template Tail
.
          INC       MRTMASIO/INC
.
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
.
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
.
          INC       RCPCIDIO/INC
          INC       RCPBNKIO/INC
          INC       RCPBDTIO/INC
          INC       RCPDTEIO/INC
          INC       RCPDBPIO/INC
          INC       RCPREGIO/INC
          INC       RCPCMNIO/INC
          INC       RCPSRTIO/INC
          INC       RCPCRSIO/INC
.
          INC       PATALRIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDO1IO/INC
          INC       PATDDHIO/INC
          INC       PATFN1IO/INC
          INC       PATFAPIO/INC
          INC       PATGO1IO/INC
          INC       PATHOSIO/INC
          INC       PATHGPIO/INC
          INC       PATHSPIO/INC      * Common system master file
          INC       PATINVIO/INC
          INC       PATIN1IO/INC
          INC       PATMA1IO/INC
          INC       PMSVX1IO/INC
          INC       PATMI1IO/INC
          INC       PATNIDIO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATREMIO/INC
          INC       PATUREIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       PATFACIO/INC
          INC       PATPFAIO/INC
          INC       PATRASIO/INC      * Reassign Debt Table
.
          INC       PRIALSIO/INC
          INC       PRISECIO/INC
          INC       PRIRASIO/INC      * Reassign Debt Table
.
          INC       PMSPX2IO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSECTIO/INC
          INC       PMSCEXIO/INC
.
          INC       PRIBULIO/INC            
          INC       PRIDTRIO/INC            
          INC       PRIPRAIO/INC            * required by COMDEPTM.PBL
          INC       PRIINVIO/INC          
          INC       PRIHDBIO/INC          
          INC       PRIHREIO/INC
          INC       PRIHTRIO/INC
.          INC       PRIDBTIO/INC            
.
          INC       TMPBNKIO/INC
          INC       TMPBDTIO/INC
          INC       TMPDTEIO/INC
          INC       TMPDBPIO/INC
.
          INC       NZPEXTIO/INC
.         
          INC       PRIUPURE
          INC       CLPRIHTR
          INC       CLNZPEXT
          INC       CALCAGE
          INC       CLNHIMAS
          INC       CLPMSPX2
          INC       NAMSTRCD    
          INC       RCPPRTCD                * print receipt
          INC       PATDPATH
          INC       PMIGTNID
          INC       RCPBNKTM    
          INC       RCPBDTTM    
          INC       RCPDTETM     
          INC       RCPSRTTM
          INC       PATDOCCD
          INC       PATDOCTM     
          INC       PATMASTM     
          INC       PATMSXTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSPX2TM
          INC       GETALTID
          INC       TFILENAM
+
.------------------------------------------------------------------------------
. End Of Program
.------------------------------------------------------------------------------
