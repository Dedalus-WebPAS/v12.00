.******************************************************************************
.* EDWSERVS - This is a routine used by IBAPMS40 to extract NSW EDWARD        *
.*            Service Scheduling Department Data                              *
.*                                                                            *
.* PARAMETERS  :                                                              *
.* RETURNS     :                                                              *
.* Mods        :                                                              *
.* V12.00.01 04/08/2025 Ebon Clements  Task 0959930                           *
.*           Only send a delete RFC obj 70 record if the last sent suspension *
.*           from and to date match - SPDL0000                                *
.* V11.03.06 04/08/2023 Ebon Clements  Task 0925076                           *
.*           Added read WL treatment file in LP650000 ,WTCHUPTY - 16          *
.*           prior to CHKHIS00 call                                           *
.* V11.03.05 26/07/2023 Ebon Clements  Task 0925076                           *
.*           Fixed population of WL_RELISTING_DATE when reporting cancelled   *
.*           bookings - LP650000 ,WTCHUPTY - 16                               *
.* V11.03.04 31/03/2023 Ebon Clements  Task 0928833                           *
.*           Added delete of OBJ 66 attributes 01 and 11 when date on list    *
.*           is changed - LP667000                                            *
.* V11.03.03 09/02/2023 Bella Turco    Task 0923869                           *
.*           In LP663000 & WLRS0500 added code to check if ENDDATE >= 20210701*
.*           and if no Claim Type selected set ATTRVALU to "MNW"              *
.* V11.03.02 15/12/2022 Bella Turco    Task 0923869                           *
.*           In LP663000 & WLRS0500 added code to check if ENDDATE >= 20210701*
.*           for Obj 66 attr 01 financial class                               *
.* V11.03.01 06/12/2022 Bella Turco    Task 0926531                           *
.*           Changed hardcoded SOURCE_ID value to parameter PTCNNSSI in       *
.*           WR732000                                                         *
.* V11.02.02 10/11/2022 Jill Parkinson Task 0899769                           *
.*           Added chkhis00 to determine if patient was ever admitted         *
.* V11.02.01 05/09/2022 Ebon Clements  Task 0923873                           *
.*           Use WTCNBRSR for REQUEST_SOURCE_TYPE_CODE category Obj 72        *
.*           WR720000 and LP720000                                            *
.* V11.00.16 24/03/2021 Jill Parkinson Task 0892530                           *
.*           Mods to use wtchupty=31 to resend all 68 objects                 *
.* V11.00.15 01/10/2020 Jill Parkinson Task 0897100                           *
.*           Corrected sending of object 66 attribute 11 for financial class  *
.* V11.00.14 02/09/2020 Jill Parkinson Task 0896840                           *
.*           Added move of WTCHOVAL to WMBOOK for booking created in WR73000  *
.*           to cater for old data where a new wmbook may already exist       *
.* V11.00.13 19/07/2020 Jill Parkinson Task 0894600                           *
.*           Changed object 68 field 9 to be wtwmecnt,date,time               *
.* V11.00.12 10/07/2020 Jill Parkinson Task 0894370                           *
.*           update column 16 for object 69 when dol changes                  *
.* V11.00.11 07/07/2020 Jill Parkinson Task 0894161                           *
.*           Changed offer_issued_date_time from bkrebkdt to wtchdate/time    *
.* V11.00.10 30/06/2020 Jill Parkinson Task 0893853                           *
.*           Updated end times for removal and admissions on 65,66,68 and 69  *
.* V11.00.09 29/06/2020 Jill Parkinson Task 0893853                           *
.*           Updated 68 and 83 for removals and cancellations                 *
.* V11.00.08 25/06/2020 Jill Parkinson Task 0893720                           *
.*           Removals to end 66, 68 and 69                                    *
.* V11.00.07 15/06/2020 Jill Parkinson Task 0893706                           *
.*           Updated column 11 with wmdate1 object 72                         *
.* V11.00.06 09/06/2020 Jill Parkinson Task 0892683                           *
.*           Changes to clear end date/times wen put back on WL               *
.* V11.00.05 26/05/2020 Jill Parkinson Task 0892120                           *
.*           Added WD66000 to send deletes for 66 and 69 date on list changes *
.* V11.00.04 24/05/2020 Jill Parkinson Task 0892120                           *
.*           Changed wr730000 to use bkrebkdt instead of opdacrdt for source  *
.*           created date                                                     *
.* V11.00.03 23/05/2020 Jill Parkinson Task 0892120                           *
.*           Mods to send wmdate1 for updates to 66                           *
.* V11.00.02 15/05/2020 Jill Parkinson Task 0891375                           *
.*           Mods to send O,I and OPUB for object 69                          *
.* V11.00.01 26/02/2020 Jill Parkinson Task 0888778                           *
.*           Mods to end 73 when claim code changed                           *
.* V10.15.15 14/02/2020 Jill Parkinson Task 0888322                           *
.*           Mods to end 66,68 and 69 when supervisor linked to admission     *
.* V10.15.14 05/02/2020 Jill Parkinson Task 0887253                           *
.*           Mods to resend 65,66 and 72 when DOL changed                     *
.*           Mods to resend 66 when financial class changed                   *
.* V10.15.13 18/12/2019 Jill Parkinson Task 0885010 0886383                   *
.*           Mods to end last 73 when supervisor relinked to another visit    *
.*           Mods to end last 65 and 65 when upervisor relinked to another vis*
.* V10.15.12 27/11/2019 Jill Parkinson Task 0885290                           *
.*           Mods to always send NRFC_PERIOD_REVIEW_DATE                      *
.* V10.15.11 22/11/2019 Jill Parkinson Task 0885039                           *
.*           Object 65 to be sent for watchaaf 05 records                     *
.* V10.14.11 25/09/2019 Jill Parkinson Task 0881755                           *
.*           Corrected object 74 prefix for record_id                         *
.* V10.14.10 21/08/2019 Jill Parkinson Task 0880212                           *
.*           Mods to end ll 66 objects when admitted/removed                  *
.* V10.14.09 16/08/2019 Jill Parkinson Task 0879236                           *
.*           Corrected ignore of cancelled theatre bookings                   *
.* V10.14.08 14/08/2019 Jill Parkinson Task 0879236                           *
.*           Mods to source created for suspensions and theatre bookings      *
.* V10.14.07 17/07/2019 Jill Parkinson Task 0878418                           *
.*           Changed to use bkrxcrdt/bkrxcrtm for 73 source created           *
.* V10.14.06 07/05/2019 Jill Parkinson Task 0874164                           *
.*           Fixed packing of changnvl for ending 66 objects                  *
.* V10.14.05 10/04/2019 Jill Parkinson Task 0872286                           *
.*           Added financial class changed to end and send object 66          *
.* V10.14.04 08/04/2019 Jill Parkinson Task 0872797                           *
.*           Corrected source modified for object 72                          *
.* V10.14.03 19/03/2019 Jill Parkinson Task 0871879                           *
.*           Corrected 73 key fields                                          *
.* V10.14.02 11/03/2019 Jill Parkinson Task                                   *
.*           Added loop to resend changed 72 objects                          *
.* V10.14.01 06/02/2019 Jill Parkinson Task 0870128                           *
.*           Added default to N if short notice is blank                      *
.*           Removed PREVDATE from object 66 WL_ATTRIBUTE_RECORD_ID           *
.* V10.13.11 14/01/2019 Jill Parkinson Task 0867308                           *
.*           Added W in front of each wluniq                                  *
.* V10.13.10 11/01/2019 Jill Parkinson Task 0867308                           *
.*           Populated source modified date/times                             *
.* V10.13.09 15/12/2018 Jill Parkinson Task 0867308                           *
.*           Recycle SIT1 WL Issues                                           *
.* V10.13.08 27/11/2018 Ebon Clements  Task 0864975                           *
.*           Added merge functionality for OBJ 65 & 72 to resend new U/R      *
.*           WMRG0000                                                         *
.* V10.13.07 08/10/2018 Jill Parkinson Task 0863558                           *
.*           Added read of wattx1af                                           *
.* V10.13.06 26/09/2018 Jill Parkinson Task 0862271                           *
.*           Correct key for object 68                                        *
.* V10.13.05 26/09/2018 Jill Parkinson Task 0863558                           *
.*           Added I or O to field 7 of the 74 object                         *
.* V10.13.04 18/09/2018 Jill Parkinson Task 0863558                           *
.*           Mods to resend 67 objects when ppp changed and 74 when doct changed
.* V10.13.03 16/09/2018 Jill Parkinson Task 0863557                           *
.*           Mods to resend 73 when bkreedat has changed/cancelled            *
.* V10.13.02 12/09/2018 Jill Parkinson Task 0862563                           *
.*           Fixed key for suspension records                                 *
.* V10.13.01 03/09/2018 Jill Parkinson Task 0862563                           *
.*           Mods to end previous 66                                          *
.* V10.12.13 22/08/2018 Jill Parkinson Task 0861709                           *
.*           Fixed rebound document issue                                     *
.* V10.12.12 22/08/2018 Jill Parkinson Task 0861709                           *
.*           Fixed rebound document issues 1-6                                *
.* V10.12.11 19/08/2018 Jill Parkinson Task 0858752                           *
.*           Fixed date format in EN680000                                    *
.* V10.12.10 10/08/2018 Jill Parkinson Task 0861709                           *
.*           Fixes and cr fro objexcts 65,68,69,70,72,73 and 74               *
.* V10.12.09 03/08/2018 Jill Parkinson Task 0846170                           *
.*           Corrected obj 70 and 73                                          *
.* V10.12.08 31/07/2018 Jill Parkinson Task 0858752                           *
.*           Fixed date format when resending 68 object with end date         *
.* V10.12.07 06/07/2018 Jill Parkinson Task 0858752                           *
.*           Mods to resend 68 and 69 objects with ending dates for prior rec *
.* V10.12.06 17/05/2018 Jill Parkinson Task 0816170                           *
.*           Fixed setting of relisting date                                  *
.* V10.12.05 14/05/2018 Jill Parkinson Task 0816170                           *
.*           Beta rebounds 45 and 47                                          *
.* V10.12.04 04/05/2018 Jill Parkinson Task 0816170                           *
.*           Beta rebounds 37-40                                              *
.* V10.12.03 30/04/2018 Jill Parkinson Task 0816170                           *
.*           Beta rebounds 31,41,42,43 and 44                                 *
.* V10.12.02 26/04/2018 Jill Parkinson Task 0816170                           *
.*           Beta rebounds 230418 and 240418                                  *
.* V10.12.01 23/04/2018 Jill Parkinson Task 0816170                           *
.*           Beta rebounds 200418 and 190418                                  *
.* V10.12.00 23/01/2018 Jill Parkinson Task 0846167                           *
.*           Created include                                                  *
.******************************************************************************
EDSS0000  CALL      WLRS0000 * extract Request for Service (72)
.                            * object records
          CALL      LP720000 * extract changed Request for Service (72)
.                            * object records
          CALL      LP650000 * extract Waiting List Booking (65)
.                            * object records
          CALL      LP660000 * extract Waiting List Booking Attribute (66)
.                            * object records
          CALL      LP670000 * extract Planned Service Activity (67)
.                            * object records
          CALL      LP680000 * extract Waiting List Booking Priority (68)
.                            * object records
          CALL      LP690000 * extract Waiting List Booking Provider (69)
.                            * object records
          CALL      WR700000 * extract Waiting List NRFC (70)
.                            * object records
          CALL      WR730000 * extract Waiting List Planned Event (73)
.                            * object records
          CALL      WMRG0000 * Process WL merges
.
EDSS9999  RETURN
+
.******************************************************************************
.*  WLRS0000 - Loop wattr1af and extract Request for Service records
.******************************************************************************
WLRS0000  PACK      KEY27,STRTDATE,SP70
          CALL      RSWTTX12         *   get new WL's in the period
WLRS0500  CALL      RKWTTX12
          BRANCH    OVRCD,WLRS9999
.
          MATCH     WTTXCDTE,ENDDATE
          GOTO      WLRS9999 IF LESS
.
          MOVE      ZERO,RECCOUNT
          PACK      KEY19,WTTXURNO,WTTXPCOD,WTTXPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WLRS0500
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WR720000     * write object type 72 record
.
          CALL      WR740000     * write object type 74 record
.
          MOVE      SP70,DIM10B
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          PACK      KEY8,WMBOOK,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      D5,SP70
          CALL      WR650000     * write object type 65 record
.
          MOVE      WMDATE1,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          PACK      PRIOTIMA,TIME001
.
. * send financial class attribute *
          MOVE      "01",ATTRTYPE
          MOVE      "MW",ATTRVALU
          MATCH     SP70,WTTXINTD
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSI,WTTXINTD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     "2",TCINDC2
              IF        @EQUAL
                MOVE      "M3",ATTRVALU
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,WTTXCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     "11",PTCDNHCP        * Extract reciprocal
            IF        @EQUAL
              MOVE      "RW",ATTRVALU
            ENDIF
          ENDIF
.
           MATCH     "20210701",ENDDATE
           IF        !@LESS
            PACK      KEY5,ANSC,ANSL,WTTXCTYP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     SP70,ACODE
              IF        @EQUAL
                MOVE      "MNW",ATTRVALU
              ENDIF
              MATCH     "P",TCINDC1
              IF        @EQUAL
                MATCH     SP70,PTCDUDF3
                IF        !@EQUAL
                  MOVE      PTCDUDF3,ATTRVALU
                ELSE
                  MOVE      "MNW",ATTRVALU
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WR660000     * write object type 66 record
.
. * send Hero location attribute *
          MATCH     SP70,WTTXPOWD
          GOTO      WLRS1000 IF EQUAL
.
          PACK      KEY7,ONE,WTTXPOWD,SP70
          CALL      RDPMUHL1
          BRANCH    OVRCD,WLRS1000
.
          MOVE      "11",ATTRTYPE
          MOVE      PMULUHID,ATTRVALU
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WR660000     * write object type 66 record
.                                * Booking attribute
WLRS1000  PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WR670000     * write object type 67 record
.                                * planned service activity
.
          MOVE      WMDATE1,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      SP70,DIM10B
          MOVE      TIME001,PRIOTIMA
          MOVE      SP70,PRIOTIMB
          MOVE      SP70,WTCHDATE
          MOVE      SP70,WTCHTIME
.
          MATCH     SP70,WTCHDATE
          IF        @EQUAL
            MOVE      WMDATE1,WTCHDATE
          ENDIF
.
          MATCH     SP70,WTCHTIME
          IF        @EQUAL
            MOVE      TIME001,WTCHTIME
          ENDIF
.
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      WTCHTIME,PRIOTIMA
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
.
          PACK      OBJECTKY,WTWMECNT,WTCHDATE,WTCHTIME,SP70,SP70
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          RJUSTIFY  WMURNO
          PACK      KEY29,WMDATE1,ANST,ANSP,WMURNO,WMCODE,DWMCNT,SP70
          CALL      RDWTCAT1
          IF        OVRCD<>1
            PACK      WMPTY,WTCACODT
          ENDIF
          SQUEEZE   WMURNO
          CALL      WR680000     * write object type 68 record
.                                * waiting list booking priority 
          PACK      OBJECTKY,WTWMECNT,ANSI,WMDOCTOR,SP70,SP70
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WR69A000     * write object type 69 record
.                                * waiting list booking provider
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WR69B000     * write object type 69 record
.                                * waiting list booking provider
          GOTO      WLRS0500
.
WLRS9999  RETURN
+
.******************************************************************************
.*  WR720000 - Write object type 72                                  
.*  Requires wattr1af record
.******************************************************************************
WR720000  LOAD      BRSRCAT,WTCNBRSR,CATW1,CATW2,CATW3,CATW4,CATX5:
                                     CATX6,CATX7,CATX8
.
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      BRSRCAT,ANSS,SP70
          ENDIF 
.
          LOAD      BRSRCOD,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      BRSRCOD,WTWMSRCR,SP70
          ENDIF
.
          PACK      D8,SP70
          PACK      KEY5,BRSRCAT,BRSRCOD,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      D8,PTCDASC2,SP70
          ENDIF
          STRIP     D8
.
          PACK      KEY16,WMDOCTOR,SP70
          CALL      RSPMHCP4
          CALL      RKPMHCP4
          IF        OVRCD=1
            MOVE      SP70,PMHCPRV1
          ELSE
            MATCH     PMHCLDOC,WMDOCTOR
            IF        !@EQUAL
              MOVE      SP70,PMHCPRV1
            ENDIF
          ENDIF
          SQUEEZE   DIM4
          SQUEEZE   PMHCPRV1
          MOVE      "72",OBJECTTY
          SQUEEZE   WMURNO
          PACK      OBJECTKY,WTWMECNT,SP70,SP70
          PACK      OBJECTTX,PTCNNSSI,TILDA: * REQUEST_FOR_SERVICE_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * REQUEST_FOR_SERVICE_RECORD_ID
                             TWO,TILDA:      * EVENT_TYPE_CODE
                             D8,TILDA:       * SOURCE_TYPE_CODE
                             TILDA:          * CORRESPONDENCE_DATE
                             WMDATE1,TILDA:  * RECIEVED_DATE
                             TILDA:          * EXPIRY_DATE
                             TILDA:          * COMMENTS
                             WMDATE1,TILDA:  * ACCEPTANCE_DATE
                             TILDA:          * REJECTION_DATE
                             ZERO,ONE,SIX,TILDA: * CLIENT_ID_TYPE_CODE
                             PTCNNIAI,TILDA: * CLIENT_ID_ISSUING_AUTHORITY
                             WMURNO,TILDA: * CLIENT_ID
                             TILDA:          * REQUESTING_OSP_ID_TYPE_CODE
                             TILDA:          * REQUESTING_OSP_SOURCE_CODE
                             TILDA:          * REQUESTING_OSP_ID
                             ZERO,THREE,FIVE,TILDA: * REQUESTING_ISP_ID_TYPE_COD
                             PTCNNSSI,TILDA: * SOURCE_ID
                             WMDOCTOR,SP900  * REQUESTING_ISP_ID
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
.
          CALL      WRCOND00     * write record to container detail table
.
WR729999  RETURN
+
.******************************************************************************
.*  WR740000 - Write object type 74 - Request for Service Provider
.*  Requires wattr1af record
.******************************************************************************
WR740000  MOVE      SP70,PTCDUDF3
.
          PACK      KEY16,WMDOCTOR,SP70
          CALL      RSPMHCP4
          CALL      RKPMHCP4
          IF        OVRCD=1
            MOVE      SP70,PMHCPRV1
          ELSE
            MATCH     PMHCLDOC,WMDOCTOR
            IF        !@EQUAL
              MOVE      SP70,PMHCPRV1
            ENDIF
          ENDIF
          SQUEEZE   PMHCPRV1
          MATCH     SP70,PMHCSPC1
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,PTCDUDF3
            ENDIF
          ENDIF
.
          SQUEEZE   PTCDUDF3
          STRIP     WMDOCTOR
          MOVE      "74",OBJECTTY
          PACK      OBJECTKY,WTWMECNT,ANSI,SP70,SP70
          PACK      OBJECTTX,PTCNNSSI,TILDA: * REQUEST_FOR_SERVICE_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * REQUEST_FOR_SERVICE_RECORD_ID
                             ANSI,WLUNIQ,TILDA: *REQUEST_FOR_SERVICE_PROVIDER_ID
                             ANSI,TILDA:     * SERVICE_PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA:      * ID_TYPE_CODE
                             PTCNNSSI,TILDA: * SERVICE_PROVIDER_SOURCE_ID
                             WMDOCTOR,TILDA: * SERVICE_PROVIDER_ID
                             PTCDUDF3,SP900  * REQUESTING_ISP_ID
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
          MOVE      "74",OBJECTTY
          PACK      OBJECTKY,WTWMECNT,ANSO,SP70,SP70
          PACK      OBJECTTX,PTCNNSSI,TILDA: * REQUEST_FOR_SERVICE_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * REQUEST_FOR_SERVICE_RECORD_ID
                             ANSO,WLUNIQ,TILDA: *REQUEST_FOR_SERVICE_PROVIDER_ID
                             ANSO,TILDA:     * SERVICE_PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA:      * ID_TYPE_CODE
                             NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE,TILDA: 
.                               * SERVICE_PROVIDER_SOURCE_ID
                             PTCNNIAI,TILDA: * SERVICE_PROVIDER_ID
                             SP900           * REQUESTING_ISP_ID
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTTXCDTE,SP70
          PACK      SRMDTIME,WTTXCTIM,SP70
          CALL      WRCOND00     * write record to container detail table
.
WR749999  RETURN
+
.******************************************************************************
.*  LP650000 - Write object type 65 - Waiting List Booking
.******************************************************************************
LP650000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
LP651000  CALL      RKWTCHA2
          BRANCH    OVRCD,LP659999
.
          MATCH     WTCHDATE,ENDDATE
          GOTO      LP659999 IF LESS
.
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      WTCHTIME,PRIOTIMA
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
.
          MATCH     "01",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "05",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "07",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "09",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "03",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "20",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "28",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "31",WTCHUPTY
          GOTO      LP652000 IF EQUAL
.
          MATCH     "16",WTCHUPTY           * Cancel Booking
          IF        @EQUAL
            PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
            CALL      RDTREA1
            BRANCH    OVRCD,LP651000
.
            PACK      DIM10B,WTCHDATE
. added lines below for 0899679
            MATCH     DIM10B,ENDDATE
            IF        @LESS
              PACK      DIM10B,SP70   * 0899679 dont send if hasn't happened
            ELSE
              CALL      CHKHIS00     * 0899679 check if ever admitted
              IF        EXIT=0
                PACK      DIM10B,SP70   * 0899679 dont send if hasn't happened
              ENDIF
            ENDIF
. end of added lines for 0899679
            GOTO      LP652000
          ENDIF
          GOTO      LP651000
.
LP652000  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,LP651000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          PACK      D5,SP70
          MOVE      SP70,ATIME
.
          MATCH     "01",WTCHUPTY
          GOTO      LP653000 IF EQUAL
.
          MATCH     "31",WTCHUPTY
          GOTO      LP653000 IF EQUAL
.
          MATCH     "03",WTCHUPTY
          GOTO      LP653000 IF EQUAL
.
          MATCH     "16",WTCHUPTY
          GOTO      LP653000 IF EQUAL
.
          MATCH     "05",WTCHUPTY
          IF        @EQUAL
            MOVE      WMDATE4,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      TIME059,PRIOTIMA
            GOTO      LP653000
          ENDIF
.
          MATCH     "09",WTCHUPTY
          GOTO      LP653000 IF EQUAL
.
          MATCH     "20",WTCHUPTY
          GOTO      LP653000 IF EQUAL
          GOTO      LP654000
.
LP653000  PACK       KEY8,WMBOOK,SP70
          CALL       RDMISS1
          BRANCH     OVRCD,LP653500 * admission not found, don't end WL
.
          IF         ASTAT=1 | ASTAT=5
            GOTO       LP653500     * admission hasn't ocurred yet, don't end
          ENDIF
.
          PACK      WMDATE4,ADATE
          MOVE      WMDATE4,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      ATIME,PRIOTIMA
          PACK      D5,ZERO,ONE,DOT,ZERO,ONE
          CALL      CEMR0000    * check if admitted from ED
          IF        EXIT=0
            PACK      D5,ZERO,ONE,DOT,ZERO,THREE
          ENDIF 
... end all 66 objects - attribute 01 and 11
LP653500  PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
.
          MATCH     "16",WTCHUPTY                      * Cancel Booking
          IF        !@EQUAL
            MOVE      SP70,DIM10B
          ENDIF
.
          MOVE      SP70,PRIOTIMB
.
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "66 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "14",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          IF        WMSTAT<4 | WMSTAT>6
            PACK      CHANGNVL,SP70
          ENDIF
          PACK      CHANGKEY,WTWMECNT,ZERO,ONE,SP70,SP70 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "66 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "14",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          IF        WMSTAT<4 | WMSTAT>6
            PACK      CHANGNVL,SP70
          ENDIF
          PACK      CHANGKEY,WTWMECNT,ONE,ONE,SP70,SP70 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "68 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "13",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          IF        WMSTAT<4 | WMSTAT>6
            PACK      CHANGNVL,SP70
          ENDIF
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "69 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "17",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          IF        WMSTAT<4 | WMSTAT>6
            PACK      CHANGNVL,SP70
          ENDIF
          PACK      CHANGKEY,WTWMECNT,ANSO,ONE,SP70,SP70   * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "69 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "17",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          IF        WMSTAT<4 | WMSTAT>6
            PACK      CHANGNVL,SP70
          ENDIF
          PACK      CHANGKEY,WTWMECNT,ANSO,ANSP,ANSU,ANSB,SP70,SP70 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "69 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "17",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          IF        WMSTAT<4 | WMSTAT>6
            PACK      CHANGNVL,SP70
          ENDIF
          PACK      CHANGKEY,WTWMECNT,ANSI,SP70,SP70 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
LP654000  PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR650000
.
          MATCH     "31",WTCHUPTY
          IF        @EQUAL
            GOTO      LP655000
          ENDIF
.
          MATCH     "01",WTCHUPTY
          IF        !@EQUAL
            GOTO      LP651000
          ENDIF
.
. * task if dol changed, or priority records updated -
. * delete all previous 68 records
LP655000  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,LP651000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          MOVE      "6  ",DELETSTM          * 6=Service Scheduling
          MOVE      "68 ",DELETOBJ          * Priority
          PACK      KEY8,WTCHOVAL,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WD680000                * write delete for last 68
          CALL      RS680000
.
          MATCH     "31",WTCHUPTY
          GOTO      LP651000 IF EQUAL
.
          MOVE      WMDATE1,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
.         MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
.         MOVE      "69 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
.         MOVE      "16",CHANGCOL                      * Change column
.         MOVE      SP70,CHANGOVL                      * End date
.         PACK      CHANGNVL,DIM10A,SP1,TIME001,SP70   * Change new start date
.         PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
.         PACK      CHANGPRM,SP70,SP70                 * Change primary key
.         CALL      LSOF0000           * Change sent stream object field
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "11",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,WMDATE1,SP70              * Change new start date
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "14",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,WMDATE1,SP70              * Change new start date
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          GOTO      LP651000
.
LP659999  RETURN
+
.*******************************************************************************
.          Check if ever admitted before sending re-listing date
.   any records exist on wathisaf with wthidat3
.   returns 1 if yes
.*******************************************************************************
CHKHIS00  MOVE      ZERO,EXIT
          PACK      KEY31,WMURNO,WMCODE,DWMCNT,Z70
          CALL      RSWTHIS1
CHKHIS10  CALL      RPWTHIS1
          BRANCH    OVRCD,CHKHIS99
.
          MATCH     WMURNO,WTHIURNO
          GOTO      CHKHIS99 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      CHKHIS99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      CHKHIS99 IF NOT EQUAL
.
          MATCH     SP70,WTHIDAT3
          GOTO      CHKHIS10 IF EQUAL
.
          MOVE      ONE,EXIT
.
CHKHIS99  RETURN
+
.*******************************************************************************
.          Check if pat.linked to EMR Adm.
.*******************************************************************************
CEMR0000  PACK      KEY16,WMURNO,Z70
          CALL      RSEMVIS3
CEMR1000  CALL      RPEMVIS3
          BRANCH    OVRCD,CEMR9000
.
          MATCH     WMURNO,EMVIURNO          * Same U/R No ?
          GOTO      CEMR9000 IF NOT EQUAL
.
          PACK      DIM8,WMBOOK
          MATCH     EMVIPADM,DIM8           * check patient system adm.no
          GOTO      CEMR1000 IF NOT EQUAL
.
          MOVE      ZERO,EXIT               * admission linked to EMR
          GOTO      CEMR9999
.
CEMR9000  MOVE      ONE,EXIT
CEMR9999  RETURN
+
.******************************************************************************
.*  LP670000 - Write object type 67 - Planned Service Activity
.******************************************************************************
LP670000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
LP671000  CALL      RKWTCHA2
          BRANCH    OVRCD,LP679999
.
          MOVE      SP70,DIM10B
          MATCH     WTCHDATE,ENDDATE
          GOTO      LP679999 IF LESS
.
          MATCH     "25",WTCHUPTY
          GOTO      LP672000 IF EQUAL
.
          GOTO      LP671000
.
LP672000  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,LP671000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR670000
          GOTO      LP671000
.
LP679999  RETURN
+
.******************************************************************************
.*  LP720000 - Write object type 72 - Request for Service
.******************************************************************************
LP720000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
LP721000  CALL      RKWTCHA2
          BRANCH    OVRCD,LP729999
.
          MOVE      SP70,DIM10B
          MATCH     WTCHDATE,ENDDATE
          GOTO      LP729999 IF LESS
.
          MATCH     "27",WTCHUPTY
          GOTO      LP722000 IF EQUAL
.
          GOTO      LP721000
.
LP722000  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,LP721000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
.
          LOAD      BRSRCAT,WTCNBRSR,CATW1,CATW2,CATW3,CATW4,CATX5:
                                     CATX6,CATX7,CATX8
.
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      BRSRCAT,ANSS,SP70
          ENDIF
.
          LOAD      BRSRCOD,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
          COMPARE   ZERO,WTCNBRSR
          IF        @EQUAL
            PACK      BRSRCOD,WTWMSRCR,SP70
          ENDIF
.
          PACK      D8,SP70
          PACK      KEY5,BRSRCAT,BRSRCOD,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      D8,PTCDASC2,SP70
          ENDIF
          STRIP     D8

          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      " 9",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * Change old U/R value
          MOVE      D8,CHANGNVL                        * Change new U/R value
          SQUEEZE   CHANGNVL
          PACK      CHANGKEY,WTWMECNT,SP70,SP70         * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      CSOF0000           * Change sent stream object field
.
          GOTO      LP721000
.
LP729999  RETURN
+
.******************************************************************************
.*  WR650000 - Write object type 65 - Waiting List Booking          
.*  Requires wattr1af record
.*  re-listing_date
.******************************************************************************
WR650000  MOVE      "65",OBJECTTY
          PACK      D1,SP70
          MATCH     SP70,WMNOTICE
          IF        !@EQUAL
            PACK      KEY5,ANSW,ANSS,WMNOTICE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      D1,THCSCOD,SP70
            ENDIF
          ENDIF
          REP       " N",D1
          MATCH     SP70,WMREMOVE
          IF        !@EQUAL
            PACK      KEY5,ANSW,ANSR,WMREMOVE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      D5,PTCDASC1,SP70
            ENDIF
          ENDIF
.              
          PACK      KEY1,SP70
          MATCH     SP70,WTTXINTD
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSI,WTTXINTD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      KEY1,THCSCOD,SP70
            ENDIF
          ENDIF
.
          SQUEEZE   WMURNO
          MOVE      ZERO,KEY5
          MOVE      WMSTAY,KEY5
          SQUEEZE   KEY5
.
          MOVE      SP70,PRIOTIMA
          MOVE      SP70,DIM10A
          MATCH     SP70,WMDATE4
          IF        !@EQUAL
            MOVE      WMDATE4,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MATCH     SP70,ATIME
            IF        !@EQUAL
              MOVE      ATIME,PRIOTIMA
            ELSE
              MOVE      TIME059,PRIOTIMA
            ENDIF
          ENDIF
          STRIP     DIM10A
          STRIP     PRIOTIMA
.
          STRIP     DIM10B
.
          SQUEEZE   KEY1   
          SQUEEZE   D1   
          SQUEEZE   D5   
          PACK      OBJECTKY,WTWMECNT,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA: * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * WL_BOOKING_RECORD_ID
                             ZERO,ONE,SIX,TILDA:  * CLIENT_ID_TYPE_CODE
                             PTCNNIAI,TILDA: * CLIENT_ID_ISSUING_AUTH
                             WMURNO,TILDA:   * CLIENT_ID
                             PTCNNSSI,TILDA: * REQUEST_FOR_SERVICE_SOURCE_ID
                             ANSW,WLUNIQ,TILDA:   * RECORD_ID
                             WMDATE1,TILDA:  * WL_LISTING_DATE
                             DIM10B,TILDA:   * WL_RELISTING_DATE
                             KEY1,TILDA:     * INTENDED_LOS_CODE
                             KEY5,TILDA:     * INTENDED_LOS_DAYS
                             TILDA:          * POOLED_LIST_ID
                             TILDA:          * POOLED_LIST_DISC_SPEC_CODE
                             ANSY,TILDA:     * COLLABORATIVE_CARE_FLAG
                             D1,TILDA:       * SHORT_NOTICE_FLAG
                             DIM10A,SP1,PRIOTIMA,TILDA:  * REMOVAL_DATE_TIME
                             TILDA:          * REMOVAL_REASON_LOCAL_CODE
                             D5,SP900        * REMOVAL_REASON_CODE
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
.       * modified date set before calling this
          CALL      WRCOND00     * write record to container detail table
.
WR659999  RETURN
+
.******************************************************************************
.*  LP660000 - Write object type 66 - Waiting List Booking Attribute
.******************************************************************************
LP660000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
LP661000  CALL      RKWTCHA2
          BRANCH    OVRCD,LP669999
.
          MATCH     WTCHDATE,ENDDATE
          GOTO      LP669999 IF LESS
.
          MATCH     "01",WTCHUPTY     * date on list changed
          GOTO      LP662000 IF EQUAL
.
          MATCH     "05",WTCHUPTY     * removal      
          GOTO      LP662000 IF EQUAL
.
          MATCH     "21",WTCHUPTY     * post op ward
          GOTO      LP662000 IF EQUAL
.
          MATCH     "29",WTCHUPTY     * intended stay (financial class)
          GOTO      LP662000 IF EQUAL
.
          MATCH     "30",WTCHUPTY     * financial class
          GOTO      LP661000 IF NOT EQUAL
.
LP662000  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,LP661000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MATCH     SP70,WTCHCVAL
          GOTO      LP661000 IF EQUAL
.
          PACK      PREVDATE,WTCHDATE
.
          MATCH     "30",WTCHUPTY           * financial class
          GOTO      LP663000 IF EQUAL
.
          MATCH     "21",WTCHUPTY           * post op ward
          GOTO      LP663000 IF NOT EQUAL
.
          PACK      KEY7,ONE,WTCHCVAL,SP70
          CALL      RDPMUHL1
          BRANCH    OVRCD,LP661000
.
          MOVE      "11",ATTRTYPE
          MOVE      PMULUHID,ATTRVALU
          GOTO      LP664000
.
LP663000  MOVE      "01",ATTRTYPE        * intended stay (financial class)
          MOVE      "MW",ATTRVALU
          MATCH     SP70,WTTXINTD
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSI,WTTXINTD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     "2",TCINDC2
              IF        @EQUAL
                MOVE      "M3",ATTRVALU
              ENDIF
            ENDIF
          ENDIF
          PACK      KEY5,ANSC,ANSL,WTTXCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     "11",PTCDNHCP        * Extract reciprocal
            IF        @EQUAL
              MOVE      "RW",ATTRVALU
            ENDIF
          ENDIF
.
           MATCH     "20210701",ENDDATE
           IF        !@LESS
            PACK      KEY5,ANSC,ANSL,WTTXCTYP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     SP70,ACODE
              IF        @EQUAL
                MOVE      "MNW",ATTRVALU
              ENDIF
              MATCH     "P",TCINDC1
              IF        @EQUAL
                MATCH     SP70,PTCDUDF3
                IF        !@EQUAL
                  MOVE      PTCDUDF3,ATTRVALU
                ELSE
                  MOVE      "MNW",ATTRVALU
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
LP664000  MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          MOVE      WMDATE1,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          PACK      PRIOTIMA,TIME001
.
.    changed to use date on list 0892120
.         MOVE      WTCHDATE,DATFIELD
.         CALL      FMTD0000
.         MOVE      FORMATDT,DIM10A
.         MOVE      WTCHTIME,PRIOTIMA
.
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MOVE      ZERO,RECCOUNT
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
.
. if date on list changed, just update record, not end
          MATCH     "01",WTCHUPTY
          IF        @EQUAL
. * added delete of previous 0892120
            MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
            MOVE      "69 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
            MOVE      "16",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL                      *
            PACK      CHANGNVL,DIM10A,SP1,TIME001,SP70   * Change new start date
            PACK      CHANGKEY,WTWMECNT,ANSI,SP70,SP70   * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            CALL      LSOF0000           * Change sent stream object field
.
            MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
            MOVE      "69 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
            MOVE      "16",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL                      *
            PACK      CHANGNVL,DIM10A,SP1,TIME001,SP70   * Change new start date
            PACK      CHANGKEY,WTWMECNT,ANSO,ONE,SP70,SP70   * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            CALL      LSOF0000           * Change sent stream object field
.
            MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
            MOVE      "69 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
            MOVE      "16",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL                      *
            PACK      CHANGNVL,DIM10A,SP1,TIME001,SP70   * Change new start date
            PACK   CHANGKEY,WTWMECNT,ANSO,ANSP,ANSU,ANSB,SP70,SP70 *Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            CALL      LSOF0000           * Change sent stream object field
.
.... removed 0894379
....        CALL      UP690000                * write delete for last 69
....        PACK      KEY3,ANSO,ONE
....        CALL      UP690000                * write delete for last 69
....        PACK      KEY3,ANSO,ANSP,ANSU
....        CALL      UP690000                * write delete for last 69
            GOTO      LP667000
          ENDIF
.
LP665000  MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "66 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "14",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          MATCH     "05",WTCHUPTY    * removal - only end previous
          IF        @EQUAL
            MOVE      WTCHDATE,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            MOVE      TIME059,PRIOTIMA
          ENDIF
.
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          PACK      CHANGKEY,WTWMECNT,ATTRTYPE,SP70,SP70 * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
LP667000  MATCH     "05",WTCHUPTY    * removal - only end previous
          GOTO      LP661000 IF EQUAL
.
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",DELETSTM          * 6=Service Scheduling
          MOVE      "66 ",DELETOBJ          * PERIOD_NRFC
          PACK      KEY3,ZERO,ONE
.
          MATCH     "30",WTCHUPTY
          IF        @EQUAL
            CALL      WD660000                * write delete for last 66 01
          ENDIF
.
          MATCH     "01",WTCHUPTY
          IF        @EQUAL
            CALL      WD660000                * write delete for last 66 01
          ENDIF
.  
          PACK      KEY3,ONE,ONE
          MATCH     "21",WTCHUPTY
          IF        @EQUAL
            CALL      WD660000                * write delete for last 66 11
          ENDIF
.
          MATCH     "01",WTCHUPTY
          IF        @EQUAL
            CALL      WD660000                * write delete for last 66 11
          ENDIF
.
          PACK      OBJECTKY,WTWMECNT,ATTRTYPE,DIM10A,SP70,SP70
          CALL      WR660000
. if date on list changed or claim type, also send an attribute 11
          MATCH     "01",WTCHUPTY
          GOTO      LP661000 IF NOT EQUAL
.
LP667100  PACK      KEY7,ONE,WTTXPOWD,SP70
          CALL      RDPMUHL1
          BRANCH    OVRCD,LP661000
.
          MOVE      "11",ATTRTYPE
          MOVE      PMULUHID,ATTRVALU
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR660000     * write object type 66 record
.
          GOTO      LP661000
.
LP669999  RETURN
+
.******************************************************************************
.*  WR660000 - Write object type 66 - Waiting List Booking Attribute
.*  Requires wattr1af record
.*  ATTRTYPE - attribute type
.*  ATTRVALU - attribute code
.******************************************************************************
WR660000  MOVE      "66",OBJECTTY
.
          SQUEEZE   ATTRVALU
          PACK      OBJECTKY,WTWMECNT,ATTRTYPE,DIM10A,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA: * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA:   * WL_BOOKING_RECORD_ID
                             ATTRTYPE,DIM10A,TILDA: * WL_ATTRIBUTE_RECORD_ID
                             ATTRTYPE,TILDA: * WL_ATTRIBUTE_TYPE_CODE
                             TILDA:          * WL_ATTRIBUTE_LOCAL_CODE
                             ATTRVALU,TILDA: * WL_ATTRIBUTE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA:  * EFFECTIVE_START_DATE
                             DIM10B,SP1,PRIOTIMB: * EFFECTIVE_END_DATE
                             SP900
.
.       * modified and created date set before calling this
          CALL      WRCOND00     * write record to container detail table
.
WR669999  RETURN
+
.******************************************************************************
.*  WR670000 - Write object type 67 - Planned Service Activity    
.*  Requires wattr1af record
.******************************************************************************
WR670000  PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1
          IF        OVRCD=1
            MOVE      SP70,WTWPHDPE
          ENDIF
          MOVE      "67",OBJECTTY
          PACK      OBJECTKY,WTWMECNT,SP70,SP70
          SQUEEZE   WTWPHDPE
          PACK      OBJECTTX,TWO,TILDA:      * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * WL_BOOKING_RECORD_ID
                             ANSW,WLUNIQ,TILDA: * PLANNED_ACTIVITY_RECORD_ID
                             SEVEN,FOUR,FIVE,TWO,DASH,ZERO,ZERO,ONE,TILDA: * REF_SOURCE_ID
                             NINE,TWO,SEVEN,SIX,TILDA: * REF_DOMAIN_ID
                             WTWPHDPE,TILDA: * PLANNED_ACTIVITY_CODE
                             ANSY,TILDA:     * PLANNED_ACTIVITY_CODE
                             SP900           * PLANNED_ACTIVITY_COMMENTS
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
.       * modified date set before calling this
          CALL      WRCOND00     * write record to container detail table
.
WR679999  RETURN
+
.******************************************************************************
.*  LP680000 - Write object type 68 - Waiting List Booking Priority  
.******************************************************************************
LP680000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
LP681000  CALL      RKWTCHA2
          BRANCH    OVRCD,LP689999
.
          MATCH     WTCHDATE,ENDDATE
          GOTO      LP689999 IF LESS
.
          MATCH     "02",WTCHUPTY
          GOTO      LP681000 IF NOT EQUAL
.
LP682000  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,LP681000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MATCH     SP70,WTCHCVAL
          GOTO      LP681000 IF EQUAL
.
          MOVE      WTCHCVAL,WMPTY
.
.  **** find watcataf record ****
          PACK      KEY29,WMURNO,WMCODE,DWMCNT,SP70
          CALL      RSWTCAT2  
LP683000  CALL      RKWTCAT2
          BRANCH    OVRCD,LP684000
.
          MATCH     WMURNO,WTCAURNO
          GOTO      LP684000 IF NOT EQUAL
. 
          MATCH     WMCODE,WTCAPROC
          GOTO      LP684000 IF NOT EQUAL
. 
          MATCH     DWMCNT,DWTCAPCN
          GOTO      LP684000 IF NOT EQUAL
. 
          MATCH     WTCAADTE,WTCHDATE
          GOTO      LP683000 IF NOT EQUAL
. 
          MATCH     WTCACODT,WTCHCVAL
          GOTO      LP684000 IF NOT EQUAL
. 
          MOVE      WTCAEDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      SP70,DIM10B
          MOVE      WTCHTIME,PRIOTIMA
.
          GOTO      LP685000

LP684000  MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      SP70,DIM10B
          MOVE      WTCHTIME,PRIOTIMA
.
LP685000  MOVE      SP70,PRIOTIMB
. 
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "68 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "13",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      OBJECTKY,WTWMECNT,WTCHDATE,WTCHTIME,SP70,SP70
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR680000     * write new priority
. 
          GOTO      LP681000
.
LP689999  RETURN
+
.******************************************************************************
.*  RS680000 -Resend all 68 records from the start if DOL was changed
.*  Requires wattr1af record
.******************************************************************************
RS680000  MOVE      ZERO,F3
          PACK      KEY29,WMURNO,WMCODE,DWMCNT,SP70
.  **** find watcataf record ****
          CALL      RSWTCAT2
RS683000  CALL      RKWTCAT2
          BRANCH    OVRCD,RS689999
.
          MATCH     WMURNO,WTCAURNO
          GOTO      RS689999 IF NOT EQUAL
.
          MATCH     WMCODE,WTCAPROC
          GOTO      RS689999 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTCAPCN
          GOTO      RS689999 IF NOT EQUAL
.
          MATCH     "TP",WTCACATF
          GOTO      RS683000 IF NOT EQUAL
.
          MOVE      WTCAEDAT,DATFIELD
          IF        F3=0
            MOVE      WMDATE1,DATFIELD
          ENDIF
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      SP70,DIM10B
          MOVE      TIME001,PRIOTIMA
.  RS685000  MOVE      SP70,PRIOTIMB
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          IF        F3=0
            PACK      OBJECTKY,WTWMECNT,WMDATE1,TIME001,SP70,SP70
            PACK      SRCRDATE,WTTXCDTE,SP70
            PACK      SRCRTIME,WTTXCTIM,SP70
            PACK      SRCRDATE,WTCHDATE,SP70
            PACK      SRMDTIME,WTCHTIME,SP70
            PACK      WMPTY,WTCACODT
            CALL      WR680000     * write new priority
            ADD       ONE,F3
            GOTO      RS683000
          ENDIF
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "68 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "13",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Change new end date
          PACK      CHANGKEY,WTWMECNT,WMDATE1,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          PACK      OBJECTKY,WTWMECNT,WTCHDATE,WTCHTIME,SP70,SP70
          PACK      WMPTY,WTCACODT
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR680000     * write new priority
.
          GOTO      RS683000
.
RS689999  RETURN
+
.******************************************************************************
.*  EN680000 -Write object type 68 to end previous Waiting List Booking Priority
.*  Requires wattr1af record
.******************************************************************************
. * end previous 68 - read last sent 68 for this key
.
EN680000  CALL      PREID000
.
          PACK      OBJECTKY,WTWMECNT,PREVDATE,PREVTIME,SP70,SP70
          MOVE      WTCHOVAL,WMPTY
.
          MOVE      PREVDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      PREVTIME,PRIOTIMA
.
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
.
          MOVE      WTCHTIME,PRIOTIMB
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR680000     * write new priority
.
EN689999  RETURN
+
.******************************************************************************
.*  WR680000 - Write object type 68 - Waiting List Booking Priority
.*  Requires wattr1af record
.******************************************************************************
WR680000  PACK      PTCDASC1,SP70
          MATCH     SP70,WMPTY
          IF        !@EQUAL
            PACK      KEY5,ANST,ANSP,WMPTY,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      PTCDASC1,SP70
            ENDIF
          ENDIF
.
          SQUEEZE   PTCDASC1
.
          SQUEEZE   DIM10A
          SQUEEZE   DIM10B
          MOVE      "68",OBJECTTY
.
          UNPACK    DIM10A,CCENT,CYEAR,D1,CMON,D1,CDAY
          UNPACK    PRIOTIMA,XHOUR,D1,XMIN,D1,XSEC
          PACK      KEY11,CYEAR,CMON,CDAY,XHOUR,XMIN,XSEC
          STRIP     KEY11
.
          PACK      OBJECTTX,TWO,TILDA:      * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * WL_BOOKING_RECORD_ID
                             WLUNIQ,KEY11,TILDA: * WL_PRIORITY_BOOKING_ID
                             TILDA:          * CLINICAL_PRIORITY_LOCAL_CODE
                             PTCDASC1,TILDA: * CLINICAL_PRIORITY_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA:*EFFECTIVE_START_DATETIME
                             DIM10B,SP1,PRIOTIMB,SP900  * EFFECTIVE_END_DATETIME
.
. source modified set before calling this
          CALL      WRCOND00     * write record to container detail table
.
WR689999  RETURN
+
.******************************************************************************
.*  Find the previous record on watchaaf
.*  Requires : SAVKEY37 - exact watchaaf key
.*  returns: RECCOUNT
.*  returns: PREVDATE (the last change date prior - used for start date of rec)
.******************************************************************************
PREID000  MOVE      ZERO,RECCOUNT
          MOVE      SP70,PREVDATE
          MOVE      SP70,PREVTIME
.
          PACK      SAVKEY37,WTCHDATE,WTCHTIME,WTCHUPTY,WTCHURNO,WTCHPROC,WTCHPCNT
          PACK      PREVDATE,WMDATE1
          PACK      PREVTIME,TIME001
.
          UNPACK    SAVKEY37,THISDATE,THISTIME,D2,URNUMBER,WLPROC,WLCOUNT
.
          PACK      KEY35,URNUMBER,WLPROC,WLCOUNT,THISDATE,THISTIME,Z70
          CALL      RSWTCHA1
PREID100  CALL      RPWTCHA1
          BRANCH    OVRCD,PREID900
.
          MATCH     URNUMBER,WTCHURNO
          GOTO      PREID900 IF NOT EQUAL
.
          MATCH     WLPROC,WTCHPROC
          GOTO      PREID900 IF NOT EQUAL
.
          MATCH     WLCOUNT,WTCHPCNT
          GOTO      PREID900 IF NOT EQUAL
.
          MATCH     THISDATE,WTCHDATE
          GOTO      PREID800 IF LESS
.
          MATCH     THISTIME,WTCHTIME
          GOTO      PREID100 IF NOT LESS
.
PREID800  MATCH     WTCHUPTY,D2
          GOTO      PREID100 IF NOT EQUAL
.
          PACK      PREVDATE,WTCHDATE
          PACK      PREVTIME,WTCHTIME
.
. * re-position back on current record
.
PREID900  PACK      KEY37,SAVKEY37
          CALL      RDWTCHA2
          BRANCH    OVRCD,PREID999
.
PREID999  RETURN
+
.******************************************************************************
.*  LP690000 - Write object type 69 - Waiting List Booking Provider
.******************************************************************************
LP690000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
LP691000  CALL      RKWTCHA2
          BRANCH    OVRCD,LP699999
.
          MATCH     WTCHDATE,ENDDATE
          GOTO      LP699999 IF LESS
.
          MATCH     "19",WTCHUPTY
          GOTO      LP691000 IF NOT EQUAL
.
LP692000  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,LP691000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MATCH     SP70,WTCHCVAL
          GOTO      LP691000 IF EQUAL
.
          MOVE      WTCHCVAL,WMDOCTOR
.
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      SP70,DIM10B
          MOVE      WTCHTIME,PRIOTIMA
          MOVE      SP70,PRIOTIMB
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          PACK      OBJECTKY,WTWMECNT,ANSI,WMDOCTOR,SP70,SP70
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR69A000     * write new doctor
. commented out for task 0893076
......    CALL      WR74A000     * write new doctor
          CALL      EN690000     * end previous
.
          GOTO      LP691000
.
LP699999  RETURN
+
.******************************************************************************
.*  WR69A000 - Write object type 69 - Waiting List Booking Provider
.*  Requires wattr1af record
.******************************************************************************
WR69A000  MOVE      SP70,PTCDUDF3
          MOVE      SP70,DIM20
          PACK      KEY16,WMDOCTOR,SP70
          CALL      RSPMHCP4
          CALL      RKPMHCP4
          IF        OVRCD=1
            MOVE      SP70,PMHCPRV1
          ELSE
            MATCH     PMHCLDOC,WMDOCTOR
            IF        !@EQUAL
              MOVE      SP70,PMHCPRV1
            ENDIF
          ENDIF
.
          PACK      DIM20,PMHCPRV1,SP70
.
          MATCH     SP70,PMHCSPC1
          GOTO      WR69A100 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,PTCDUDF3
          ENDIF
.
WR69A100  MOVE      "69",OBJECTTY
          SQUEEZE   PMHCPRV1
          SQUEEZE   PTCDUDF3
          SQUEEZE   DIM20
          STRIP     DIM10B
          STRIP     PRIOTIMB
          STRIP     WMDOCTOR
.
          PACK      OBJECTTX,TWO,TILDA:      * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * WL_BOOKING_RECORD_ID
                             WMDOCTOR,TILDA: * WL_PROVIDER_RECORD_ID
                             ANSI,TILDA:     * SERVICE_PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA: * ID_TYPE_CODE
                             PTCNNSSI,TILDA: * SOURCE_ID
                             WMDOCTOR,TILDA:    * PROVIDER_ID
                             PTCDUDF3,TILDA: * ISP_DISC_SPEC_CODE
                             TWO,TILDA:     * COLLABORATIVE_CARE_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA:  * EFFECTIVE_START_DATETIME
                             DIM10B,SP1,PRIOTIMB,SP900  * EFFECTIVE_END_DATETIME
.
. source modified set before calling this
          CALL      WRCOND00     * write record to container detail table
.
WR69A999  RETURN
+
.******************************************************************************
.*  EN690000 -Write object type 69 to end previous Waiting List Booking Provider
.******************************************************************************
. * end previous 69 - read last sent 69 for this key
.
EN690000  MOVE      WTCHOVAL,WMDOCTOR
          CALL      PREID000
.
          PACK      OBJECTKY,WTWMECNT,ANSI,WMDOCTOR,SP70,SP70
.
          MOVE      PREVDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          MOVE      PREVTIME,PRIOTIMA
.
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
.
          MOVE      WTCHTIME,PRIOTIMB
          PACK      SRCRDATE,PREVDATE,SP70
          PACK      SRCRTIME,PREVTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WR69A000     * write new priority
.
EN699999  RETURN
+
.******************************************************************************
.*  WR740000 -Write object type 74
.******************************************************************************
WR74A000  MOVE      SP70,PTCDUDF3
.
          PACK      KEY16,WMDOCTOR,SP70
          CALL      RSPMHCP4
          CALL      RKPMHCP4
          IF        OVRCD=1
            MOVE      SP70,PMHCPRV1
          ELSE
            MATCH     PMHCLDOC,WMDOCTOR
            IF        !@EQUAL
              MOVE      SP70,PMHCPRV1
            ENDIF
          ENDIF
          SQUEEZE   PMHCPRV1
          MATCH     SP70,PMHCSPC1
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,PMHCSPC1,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,PTCDUDF3
            ENDIF
          ENDIF
.
          SQUEEZE   PTCDUDF3
          STRIP     WMDOCTOR
          MOVE      "74",OBJECTTY
          PACK      OBJECTKY,WTWMECNT,ANSI,SP70,SP70
          PACK      OBJECTTX,PTCNNSSI,TILDA: * REQUEST_FOR_SERVICE_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * REQUEST_FOR_SERVICE_RECORD_ID
                             ANSI,WLUNIQ,TILDA: *REQUEST_FOR_SERVICE_PROVIDER_ID
                             ANSI,TILDA:     * SERVICE_PROVIDER_TYPE_CODE
                             ZERO,THREE,FIVE,TILDA:      * ID_TYPE_CODE
                             PTCNNSSI,TILDA: * SERVICE_PROVIDER_SOURCE_ID
                             WMDOCTOR,TILDA: * SERVICE_PROVIDER_ID
                             PTCDUDF3,SP900  * REQUESTING_ISP_ID
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WRCOND00     * write record to container detail table
.
          RETURN
+
.******************************************************************************
.*  WR69B000 - Write object type 69 - Waiting List Booking Provider
.*  Requires wattr1af record
.******************************************************************************
WR69B000  MOVE      "69",OBJECTTY
          PACK      OBJECTKY,WTWMECNT,ANSO,ONE,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * WL_BOOKING_RECORD_ID
                             ANSO,TILDA: * WL_PROVIDER_RECORD_ID
                             ANSO,TILDA:     * SERVICE_PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA: * ID_TYPE_CODE
                      NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE,TILDA: * SOURCE_ID
                             PTCNNIAI,TILDA: * PROVIDER_ID
                             TILDA:          * ISP_DISC_SPEC_CODE
                             TWO,TILDA:     * COLLABORATIVE_CARE_CODE
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATETIME
                             SP900           * EFFECTIVE_END_DATETIME
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
. modified set before call
          CALL      WRCOND00     * write record to container detail table
.
          STRIP     PTCNNCPP
          PACK      OBJECTKY,WTWMECNT,ANSO,ANSP,ANSU,ANSB,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * WL_BOOKING_RECORD_ID
                             ANSO,ANSP,ANSU,ANSB,TILDA: * WL_PROVIDER_RECORD_ID
                             ANSO,TILDA:     * SERVICE_PROVIDER_TYPE_CODE
                             ONE,ZERO,ZERO,TILDA: * ID_TYPE_CODE
                      NINE,FOUR,SEVEN,FIVE,DASH,ZERO,ZERO,ONE,TILDA: * SOURCE_ID
                             PTCNNCPP,TILDA: * PROVIDER_ID
                             TILDA:          * ISP_DISC_SPEC_CODE
                             ONE,TILDA:     * COLLABORATIVE_CARE_CODE
                             DIM10A,SP1,TIME001,TILDA:  * EFFECTIVE_START_DATETIME
                             SP900           * EFFECTIVE_END_DATETIME
.
          PACK      SRCRDATE,WTTXCDTE,SP70
          PACK      SRCRTIME,WTTXCTIM,SP70
. modified set before call
          CALL      WRCOND00     * write record to container detail table
.
WR69B999  RETURN
+
.******************************************************************************
.*  WR700000 - Write object type 70 - Period Not Ready for Care     
.*  Requires wattr1af record
.******************************************************************************
WR700000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
WR701000  CALL      RKWTCHA2
          BRANCH    OVRCD,WR709999
.
          MATCH     WTCHDATE,ENDDATE
          GOTO      WR709999 IF LESS
.
          MATCH     "14",WTCHUPTY
          GOTO      WR702000 IF EQUAL
.
          MATCH     "22",WTCHUPTY
          GOTO      WR702000 IF EQUAL
.
          MATCH     "23",WTCHUPTY
          GOTO      WR701000 IF NOT EQUAL
.
WR702000  PACK      SAVKEY37,WTCHDATE,WTCHTIME,WTCHUPTY,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WR701000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MATCH     "14",WTCHUPTY    * deleted
          IF        @EQUAL
            CALL      SPDL0000                * write delete for last 70
            GOTO      WR701000
          ENDIF
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
          PACK      KEY21,WMURNO,WMCODE,DWMCNT,SP70
          CALL      RSWTSUS1
WR702100  CALL      RKWTSUS1
          BRANCH    OVRCD,WR701000
.
          MATCH     WMURNO,WTSUURNO
          GOTO      WR701000 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      WR701000 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTSUCNT
          GOTO      WR701000 IF NOT EQUAL
.
          UNPACK    WTCHCVAL,DIM8
          MATCH     DIM8,WTSUFDAT
          GOTO      WR702100 IF NOT EQUAL
.
          PACK      KEY3,SP70
          MATCH     SP70,WTSUREAS
          IF        !@EQUAL
            PACK      KEY5,ANSW,ANSN,WTSUREAS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      KEY3,THCSCOD,SP70
            ENDIF
          ENDIF
          STRIP     KEY3
.
          MOVE      WTSUFDAT,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
.
          MOVE      SP70,DIM10B
          MOVE      SP70,PRIOTIMB
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
            MOVE      WTSUTDAT,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10B
            MOVE      TIME001,PRIOTIMB
          ENDIF
          STRIP     DIM10B
          STRIP     PRIOTIMB
.
          MOVE      SP70,KEY10
          MATCH     WTSUTDAT,ENDDATE
          IF        @LESS
            MOVE      WTSUTDAT,KEY10  
          ENDIF
          STRIP     KEY10
.
          UNPACK    WTCHDATE,CCENT,CYEAR,CMON,CDAY
          UNPACK    WTCHTIME,XHOUR,D1,XMIN,D1,XSEC
.
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
.
          MOVE      "70",OBJECTTY
          PACK      OBJECTKY,WTWMECNT,WTSUSCNT,SP70,SP70
          SQUEEZE   WTWMECNT
          SQUEEZE   DWTSUSCN
          PACK      KEY20,WTWMECNT,DASH,DWTSUSCN,SP70
          STRIP     KEY20
          STRIP     WTSUTDAT
          PACK      OBJECTTX,TWO,TILDA:      * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             ANSW,WLUNIQ,TILDA: * WL_BOOKING_RECORD_ID
                             KEY20,TILDA:    * NRFC_RECORD_ID
                             TILDA:          * NRFC_REASON_LOCAL_CODE
                             KEY3,TILDA:     * NRFC_REASON_CODE
                             WTSUTDAT,TILDA: * NRFC_PERIOD_REVIEW_DATE
                             TILDA:          * COMMENTS
                             DIM10A,SP1,TIME001,TILDA:* EFFECTIVE_START_DATETIME
                             DIM10B,SP1,PRIOTIMB:  * EFFECTIVE_END_DATETIME
                             SP900        
.
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          MATCH     "23",WTCHUPTY
          IF        @EQUAL
            CALL      GETSC000  * get source created date/time
          ENDIF
          PACK      KEY37,SAVKEY37
          CALL      RDWTCHA2
          IF        OVRCD=1
            GOTO      WR709999
          ENDIF
.
          CALL      WRCOND00     * write record to container detail table
          GOTO      WR701000
.
WR709999  RETURN
+
.******************************************************************************
.*  GETSC000 - Get source created date/time for when suspension was added
.******************************************************************************
GETSC000  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,Z70
          CALL      RSWTCHA1
GETSC100  CALL      RPWTCHA1
          BRANCH    OVRCD,GETSC999
.
          MATCH     WTSUURNO,WTCHURNO
          GOTO      GETSC999 IF NOT EQUAL
.
          MATCH     WTSUCODE,WTCHPROC
          GOTO      GETSC999 IF NOT EQUAL
.
          MATCH     DWTSUCNT,WTCHPCNT
          GOTO      GETSC999 IF NOT EQUAL
.
          MATCH     "22",WTCHUPTY
          GOTO      GETSC100 IF NOT EQUAL
.
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
.
GETSC999  RETURN
+
.******************************************************************************
.*  WR730000 - Write object type 73 - Planned Event Offer
.*  Requires wattr1af record
.******************************************************************************
WR730000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
WR731000  CALL      RKWTCHA2
          BRANCH    OVRCD,WR739999
.
          MATCH     WTCHDATE,ENDDATE
          GOTO      WR739999 IF LESS
.
          MATCH     "08",WTCHUPTY
          GOTO      WR731200 IF EQUAL
.
          MATCH     "18",WTCHUPTY
          GOTO      WR731200 IF EQUAL
.
          MATCH     "16",WTCHUPTY
          GOTO      WR731200 IF EQUAL
.
          MATCH     "03",WTCHUPTY
          GOTO      WR731200 IF EQUAL
.
          MATCH     "09",WTCHUPTY
          GOTO      WR731000 IF NOT EQUAL
.
WR731200  PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WR731000
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
. admitted task 0894573
          MATCH     "03",WTCHUPTY
          IF        @EQUAL
            PACK      SRMDDATE,WTCHDATE,SP70
            PACK      SRMDTIME,WTCHTIME,SP70
            MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
            MOVE      "73 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
            MOVE      "11",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL                      * End date
            PACK      CHANGNVL,ZERO,ONE,SP70             * Outcome=01
            PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            CALL      LSOF0000           * Change sent stream object field
            MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
            MOVE      "73 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
            MOVE      "12",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL                      * End date
            UNPACK    WTCHOVAL,WMDATE3,PRIOTIMB
            MOVE      WMDATE3,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
            PACK      PRIOTIMA,PRIOTIMB
            PACK      CHANGNVL,DIM10A,SP1,PRIOTIMA,SP70  * Outcome=01
            PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            CALL      LSOF0000           * Change sent stream object field
            GOTO      WR731000
          ENDIF
.
. **** if wtchupty=09, close existing booking first,
.         then resend current wmbook*****
          MATCH     "09",WTCHUPTY
          IF        @EQUAL
            PACK      SRMDDATE,WTCHDATE,SP70
            PACK      SRMDTIME,WTCHTIME,SP70
            MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
            MOVE      "73 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
            MOVE      "11",CHANGCOL                      * Change column
            MOVE      SP70,CHANGOVL                      * End date
            PACK      CHANGNVL,ZERO,SIX,SP70             * Outcome=06
            PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
            PACK      CHANGPRM,SP70,SP70                 * Change primary key
            CALL      LSOF0000           * Change sent stream object field
          ENDIF
.
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          PACK      PRIOTIMA,WTCHTIME
.
          MOVE      SP70,PRIOTIMB
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          IF        OVRCD<>1
            CALL      RDBKRX11
            PACK      WMDATE3,BKREEDAT,SP70
            PACK      PRIOTIMB,BKREATIM,SP70
          ELSE
            MATCH     "03",WTCHUPTY
            IF        @EQUAL
              UNPACK    WTCHOVAL,WMDATE3,PRIOTIMB
              MOVE      WMDATE3,DATFIELD
              CALL      FMTD0000
              MOVE      FORMATDT,DIM10A
              PACK      PRIOTIMA,PRIOTIMB
            ENDIF
          ENDIF
.
          MOVE      WTWMECNT,WLUNIQ
          SQUEEZE   WLUNIQ
.
. **** if wtchupty=16, cancel last booking with cat BC ptcdudf3
          MATCH     "16",WTCHUPTY
          GOTO      WR731300 IF NOT EQUAL
.
          PACK      CHANGNVL,ZERO,TWO,DOT,NINE,ZERO,SP70
          PACK      KEY5,ANSB,ANSC,WTCHREAS,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     SP70,PTCDUDF3
            IF        !@EQUAL
              PACK      CHANGNVL,PTCDUDF3,SP70
            ENDIF
          ENDIF
          STRIP     CHANGNVL
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "73 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "11",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field
.
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10A
          PACK      CHANGNVL,DIM10A,SP1,WTCHTIME,SP70  * Change new end date
          STRIP     CHANGNVL
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "73 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "12",CHANGCOL                      * Change column
          MOVE      SP70,CHANGOVL                      * End date
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      LSOF0000           * Change sent stream object field

          GOTO      WR731000
.
WR731300  MATCH     "18",WTCHUPTY
          IF        @EQUAL
            PACK      KEY8,WTCHOVAL,SP70
            CALL      RDBKREC1
            IF        OVRCD<>1
              PACK      WMDATE3,BKREEDAT,SP70
              PACK      PRIOTIMB,BKREATIM,SP70
              MOVE      WTCHOVAL,WMBOOK
            ENDIF
          ENDIF
.
          MOVE      WMDATE3,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10B
          MATCH     SP70,DIM10B
          IF        !@EQUAL
            MATCH     SP70,PRIOTIMB
            IF        @EQUAL
              MOVE      TIME001,PRIOTIMB
            ENDIF
          ENDIF
          STRIP     DIM10B
          STRIP     PRIOTIMB
.
          MOVE      SP70,DIM10C
          MOVE      SP70,PRIOTIMC
          MOVE      SP70,OPDADATE
          MOVE      SP70,OPDATIME
.
          PACK      KEY31,WMBOOK,SP70
          CALL      RSOPDEA2
WR731500  CALL      RKOPDEA2
          BRANCH    OVRCD,WR732000
.
          MOVE      WMBOOK,DIM8
          MATCH     DIM8,OPDAADMN
          GOTO      WR732000 IF NOT EQUAL
          MATCH     "3",DOPDASTA
          GOTO      WR731500 IF EQUAL
.
          MATCH     OPDAPROC,WMCODE
          GOTO      WR732000 IF NOT EQUAL
.
          MATCH     DWMCNT,OPDACONT
          GOTO      WR732000 IF NOT EQUAL
.
          MOVE      OPDADATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10C
.
          MATCH     SP70,DIM10C
          IF        !@EQUAL
            PACK      PRIOTIMC,OPDATIME,COLON,ZERO,ZERO
          ENDIF
.
WR732000  MOVE      "73",OBJECTTY
.  * changed from bkrebkdt to wtchdate for task 0894161
          MOVE      WTCHDATE,DATFIELD
          CALL      FMTD0000
          MOVE      FORMATDT,DIM10D
          UNPACK    WTCHTIME,PRIOTIMD
.
          PACK      D2,ZERO,ZERO
          MATCH     "03",WTCHUPTY
          IF        @EQUAL
            PACK      D2,ZERO,ONE
            UNPACK    WTCHOVAL,WMDATE3,PRIOTIMA
            MOVE      WMDATE3,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10A
          ENDIF
          SQUEEZE   DIM10C
.
          STRIP     PRIOTIMC
          STRIP     WTCHOVAL
          PACK      KEY30,ANSW,WTWMECNT,DASH,WMBOOK
          SQUEEZE   KEY30
          PACK      KEY20,ANSW,WTWMECNT
          SQUEEZE   KEY20
          PACK      OBJECTKY,WTWMECNT,WMBOOK,SP70,SP70
          PACK      OBJECTTX,TWO,TILDA:      * WL_SERVICE_EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * WL_BOOKING_SOURCE_ID
                             KEY30,TILDA:    *PLANNED_OFFER_RECORD_ID
                             DIM10D,SP1,PRIOTIMD,TILDA: *OFFER_ISSUED_DATETIME
                             TILDA:          * OFFER_OUTCOME_LOCAL_CODE
                             D2,TILDA:       * OFFER_OUTCOME_CODE
                             DIM10A,SP1,PRIOTIMA,TILDA: * OFFER_OUTCOME_DATETIME
                      DIM10B,SP1,PRIOTIMB,TILDA:*PLANNED_SERVICE_EVENT_STARTDATE
                      DIM10C,SP1,PRIOTIMC,TILDA: * PRIMARY_INTERVENTION_DATETIME
                             PTCNNSSI,TILDA: * SOURCE_ID
                             KEY20,TILDA: * REQUEST_FOR_SERVICE_RECORD_ID
                             TWO,TILDA:      * EVENT_TYPE_CODE
                             PTCNNSSI,TILDA: * BOOKING_SOURCE_ID
                             KEY20,SP70 * BOOKING_RECORD_ID
.
          PACK      SRCRDATE,WTCHDATE,SP70
          PACK      SRCRTIME,WTCHTIME,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WRCOND00     * write record to container detail table
          GOTO      WR731000
.
WR739999  RETURN
+
.******************************************************************************
.* SPDL0000 - Send delete record for object 70 if the last sent record
.*            was for the same suspension from and to dates
.******************************************************************************
SPDL0000  MOVE      "6  ",DELETSTM          * 6=Service Scheduling
          MOVE      "70 ",DELETOBJ          * PERIOD_NRFC
.
          PACK      WTCHOVAL,WTCHOVAL,SP70,SP70
          UNPACK    WTCHOVAL,DIM8G,DIM8H    * Suspension from and to date
.
          MOVE      SP70,DIM10G
          MATCH     SP70,DIM8G
          IF        !@EQUAL
            MOVE      DIM8G,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10G       * Formattted suspension from date
          ENDIF
.
          MOVE      SP70,DIM10H
          MATCH     SP70,DIM8H
          IF        !@EQUAL
            MOVE      DIM8H,DATFIELD
            CALL      FMTD0000
            MOVE      FORMATDT,DIM10H       * Formattted suspension to date
          ENDIF
.
          PACK      KEY112,DELETSTM,DELETOBJ,WTWMECNT,Z70
          CALL      RSCMEWD2
SPDL1000  CALL      RPCMEWD2
          BRANCH    OVRCD,SPDL9999
.
          MATCH     DELETSTM,CMEWDSTR            * 6=Service scheduling
          GOTO      SPDL9999 IF NOT EQUAL
.
          MATCH     DELETOBJ,CMEWOBJT            * Correct Object
          GOTO      SPDL9999 IF NOT EQUAL
.
          UNPACK    CMEWOKEY,DIM9
          MATCH     WTWMECNT,DIM9                * First 9 chars is wl key
          GOTO      SPDL9999 IF NOT EQUAL        * number
.
          MATCH     ANSY,RERUNFL            * Ignore curreat date range
          IF        @EQUAL
            MOVE      CMEWCNTN,F8           * Include current extract records
            IF        CONTNUMB <> F8
              MATCH     STRTDATE,CMEWSDAT
              GOTO      SPDL1000 IF NOT LESS
            ENDIF
          ENDIF
.
          MATCH     ANSD,CMEWRTYP
          GOTO      SPDL1000 IF EQUAL
.
          MOVE      "8",CHANGCOL                 * Get columns value for the
          CALL      GCOL0000                     * suspension from date
          MATCH     DIM10G,CHANGAAA              * Correct from date
          GOTO      SPDL9999 IF NOT EQUAL
.
          MOVE      "9",CHANGCOL                 * Get columns value for the
          CALL      GCOL0000                     * suspension from date
          MATCH     DIM10H,CHANGAAA              * Correct to date
          GOTO      SPDL9999 IF NOT EQUAL
.
          MOVE      CMEWOBJT,OBJECTTY            * Object
          PACK      OBJECTKY,CMEWOKEY,SP70       * Key
          PACK      OBJECTTX,CMEWTEXT,SP900      * Text
.
          MOVE      ANSD,OBJECTRT
          PACK      SRCRDATE,CMEWSCDT,SP70
          PACK      SRCRTIME,CMEWSCTM,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WRCOND00     * write record to container detail table
.
SPDL9999  RETURN
+
.******************************************************************************
.* WD660000 - Send delete records for all objects for this visit
.******************************************************************************
WD660000  PACK      D3,KEY3,SP70
          REP       " ~",D3
          PACK      KEY112,DELETSTM,DELETOBJ,WTWMECNT,D3,Z70
          CALL      RSCMEWD2
WD661000  CALL      RPCMEWD2
          BRANCH    OVRCD,WD669999
.
          MATCH     DELETSTM,CMEWDSTR            * 6=Service scheduling
          GOTO      WD669999 IF NOT EQUAL
.
          MATCH     DELETOBJ,CMEWOBJT            * Correct Object
          GOTO      WD669999 IF NOT EQUAL
.
          UNPACK    CMEWOKEY,DIM9,DIM3
          MATCH     WTWMECNT,DIM9                * First 9 chars is wl key
          GOTO      WD669999 IF NOT EQUAL        * number
.
          SQUEEZE   KEY3
          MATCH     KEY3,DIM3
          GOTO      WD669999 IF NOT EQUAL
.
          MOVE      CMEWOBJT,OBJECTTY            * Object
          PACK      OBJECTKY,CMEWOKEY,SP70       * Key
          PACK      OBJECTTX,CMEWTEXT,SP900      * Text
.
          MOVE      ANSD,OBJECTRT
          PACK      SRCRDATE,CMEWSCDT,SP70
          PACK      SRCRTIME,CMEWSCTM,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WRCOND00     * write record to container detail table
.
WD669999  RETURN
+
.******************************************************************************
.* UP690000 - send update records for all objects for this visit
.******************************************************************************
UP690000  PACK      D3,KEY3,SP70
          REP       " ~",D3
          PACK      KEY112,DELETSTM,DELETOBJ,WTWMECNT,D3,Z70
          CALL      RSCMEWD2
UP691000  CALL      RPCMEWD2
          BRANCH    OVRCD,UP699999
.
          MATCH     DELETSTM,CMEWDSTR            * 6=Service scheduling
          GOTO      UP699999 IF NOT EQUAL
.
          MATCH     DELETOBJ,CMEWOBJT            * Correct Object
          GOTO      UP699999 IF NOT EQUAL
.
          UNPACK    CMEWOKEY,DIM9,DIM3
          MATCH     WTWMECNT,DIM9                * First 9 chars is wl key
          GOTO      UP699999 IF NOT EQUAL        * number
.
          SQUEEZE   KEY3
          MATCH     KEY3,DIM3
          GOTO      UP699999 IF NOT EQUAL
.
          MOVE      SP70,OBJECTRT
          MOVE      CMEWOBJT,OBJECTTY            * Object
          PACK      OBJECTKY,CMEWOKEY,SP70       * Key
          PACK      OBJECTTX,CMEWTEXT,SP900      * Text
.
          PACK      SRCRDATE,CMEWSCDT,SP70
          PACK      SRCRTIME,CMEWSCTM,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WRCOND00     * write record to container detail table
.
UP699999  RETURN
+
.******************************************************************************
.* WD880000 - Send delete records for all 68 objects for this visit
.******************************************************************************
WD680000  PACK      D8,KEY8,SP70
          REP       " ~",D8
          PACK      KEY112,DELETSTM,DELETOBJ,WTWMECNT,Z70
          CALL      RSCMEWD2
WD681000  CALL      RPCMEWD2
          BRANCH    OVRCD,WD689999
.
          MATCH     DELETSTM,CMEWDSTR            * 6=Service scheduling
          GOTO      WD689999 IF NOT EQUAL
.
          MATCH     DELETOBJ,CMEWOBJT            * Correct Object
          GOTO      WD689999 IF NOT EQUAL
.
          UNPACK    CMEWOKEY,DIM9,DIM8
          MATCH     WTWMECNT,DIM9                * First 9 chars is wl key
          GOTO      WD689999 IF NOT EQUAL        * number
.
.         SQUEEZE   KEY8
.         MATCH     KEY8,DIM8
.         GOTO      WD689999 IF NOT EQUAL
.
          MATCH     ANSD,OBJECTRT
          GOTO      WD681000 IF EQUAL
          MOVE      CMEWOBJT,OBJECTTY            * Object
          PACK      OBJECTKY,CMEWOKEY,SP70       * Key
          PACK      OBJECTTX,CMEWTEXT,SP900      * Text
.
          MOVE      ANSD,OBJECTRT
          PACK      SRCRDATE,CMEWSCDT,SP70
          PACK      SRCRTIME,CMEWSCTM,SP70
          PACK      SRMDDATE,WTCHDATE,SP70
          PACK      SRMDTIME,WTCHTIME,SP70
          CALL      WRCOND00     * write record to container detail table
.
          GOTO      WD681000
.
WD689999  RETURN
+
.******************************************************************************
.* WMRG0000 - Loop patmrgaf and watchaaf and process any WL visit PMI merges
.******************************************************************************
WMRG0000  PACK      KEY25,STRTDATE,SP70
          CALL      RSPTMRG3
WMRG1000  CALL      RKPTMRG3                * Loop merge file
          BRANCH    OVRCD,WMRG5000
.
          MATCH     PTMRRDTE,ENDDATE        * Date created
          GOTO      WMRG5000 IF LESS
.
          PACK      KEY19,PTMRNWUR,SP70
          CALL      RDSTREA1                * Read W/L file by U/R
WMRG2000  CALL      RDKTREA1
          BRANCH    OVRCD,WMRG1000
.
          MATCH     PTMRNWUR,WMURNO         * Correct U/R
          GOTO      WMRG1000 IF NOT EQUAL
.
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "65 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "11",CHANGCOL                      * Change column
          MOVE      PTMROLUR,CHANGOVL                  * Change old U/R value
          MOVE      PTMRNWUR,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL 
          PACK      CHANGKEY,WTWMECNT,SP70,SP70         * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      CSOF0000           * Change sent stream object field
.
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "18",CHANGCOL                      * Change column
          MOVE      PTMROLUR,CHANGOVL                  * Change old U/R value
          MOVE      PTMRNWUR,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL 
          PACK      CHANGKEY,WTWMECNT,SP70,SP70         * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      CSOF0000           * Change sent stream object field
.
          GOTO      WMRG2000
.
WMRG5000  PACK      KEY37,STRTDATE,SP70
          CALL      RSWTCHA2
WMRG6000  CALL      RKWTCHA2                * Loop WL change file
          BRANCH    OVRCD,WMRG9999
.
          MATCH     WTCHDATE,ENDDATE        * Date created
          GOTO      WMRG9999 IF LESS
.
          MATCH     "26",WTCHUPTY           * WL Changed U/R
          GOTO      WMRG6000 IF NOT EQUAL
.
          PACK      KEY19,WTCHCVAL,SP70
          CALL      RDSTREA1                * Read W/L file by new U/R
WMRG7000  CALL      RDKTREA1
          BRANCH    OVRCD,WMRG6000
.
          MATCH     WMURNO,WTCHCVAL         * Correct U/R
          GOTO      WMRG6000 IF NOT EQUAL
.
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "65 ",CHANGOBJ                     * CLIENT_SERVICE_EVENT
          MOVE      "11",CHANGCOL                      * Change column number
          MOVE      WTCHOVAL,CHANGOVL                  * Change old U/R value
          MOVE      WTCHCVAL,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL 
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      CSOF0000           * Change sent stream object field
.
          MOVE      "6  ",CHANGSTM                     * 6=Service Scheduling
          MOVE      "72 ",CHANGOBJ                     * REQUEST_FOR_SERVICE
          MOVE      "18",CHANGCOL                      * Change column number
          MOVE      WTCHOVAL,CHANGOVL                  * Change old U/R value
          MOVE      WTCHCVAL,CHANGNVL                  * Change new U/R value
          SQUEEZE   CHANGNVL 
          PACK      CHANGKEY,WTWMECNT,SP70,SP70        * Change Key
          PACK      CHANGPRM,SP70,SP70                 * Change primary key
          CALL      CSOF0000           * Change sent stream object field
.
          GOTO      WMRG7000
.
WMRG9999  RETURN
