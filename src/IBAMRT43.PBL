.******************************************************************************
.*                                                                            *
.*                        P R O G R A M   S U M M A R Y                       *
.*                        -------------   -------------                       *
.*                                                                            *
.*     PROGRAM NAME:    IBAMRT43                                              *
.*                                                                            *
.*     FUNCTION:        DISCHARGES WITH/WITHOUT DISEASE                       *
.*                                                                            *
.*     DATE WRITTEN:    14/10/1985                                            *
.*                                                                            *
.*     AUTHOR:          MALCOLM HAYSE                                         *
.*                                                                            *
.*     COMMENT:         Copied from IBAPAT43 and modified for the new Medical *
.*                      Records Tracking system for H.R.H.  - Performed by    *
.*                                                            Chucky.         *
.*                                                                            *
.*     MODIFICATIONS:                                                         *
.*                                                                            *
.******************************************************************************
.* V12.00.01 22/05/2025 Thanh T         TSK 0955096                           *
.*           Changed for alphanumeric visit number                            *
.******************************************************************************
.*        V10.13.01 05/12/2018  Don Nguyen       TSK 0838558                  *
.*                  Deleted temp file (PSTROL) after processing               *
.*        V10.11.01 08/09/2017  Ebon Clements  TSK 0818097                    *
.*                  Added excluded newborn functionality -  EXNB0000          *
.*        V10.08.01 22/11/2016  Ebon Clements  TSK 0319860                    *
.*                  Ignore patecdaf ICD coding lock record - NXDISE           *
.*        V10.05.02 10/11/2014  Ebon Clements     CAR 306935                  *
.*                  Check for blank MR home hospital if running multi hospital*
.*        V10.05.01 10/11/2014  Ebon Clements     CAR 306935                  *
.*                  Fixed multi hospital MR location tests                    *
.*        V10.04.01 14/07/2014  Ebon Clements     CAR 261630                  *
.*                  Removed port number from temp file name                   *
.*        V10.03.03 25/11/2013  Patrick Adair     CAR 199297                  *
.*                   Exclude Residential Admissions - NZ only                 *
.*        V10.03.02 18/07/2013  Davin          CAR 288704                     *
.*                  Fix for check of default home location (chkadma1)         *
.*        V10.03.01 09/07/2012  Mike Laming    CAR 266254                     *
.*                  Mods to correct "All Hospitals" report for Multi Hospital *
.*        V10.02.03 04/07/2011  Ebon Clements  CAR 240724                     *
.*                  Mods for MRT hospital/location - Added hospital to        *
.*                  location key                                              *
.*        V10.02.02 10/06/2011  Jill Parkinson CAR 243907                     *
.*                  Changed to use PTHSHLOC if multi hospital                 *
.*        V10.02.01 28/03/2011  Mike Laming   CAR 240107                      *
.*                  Mods to PATECDaf & PATECOaf variables & Keys - file change*
.*        V9.09/02  12/02/2008  Mike Laming    CAR 161310                     *
.*                  Remove test CINVLAY=8 to allow "exclude borders" to work  *
.*        V9.09.01  01/11/2007  Peter McMullen CAR 153023 (see below)         *
.*        V9.08.02  01/11/2007  Peter McMullen CAR 153023                     *
.*                  re-apply CAR 80273 (from 6.13.01) exclude borders from    *
.*                  discharge report                                          *
.*        V9.08.01  25/01/2007  Peter Vela CAR 127930                         *
.*                  Recompiled for MRTMASFD                                   *
.*        V9.04.02  21/10/2004 Henry Son         CAR 49649                    *
.*                  Fix Medical record history Search.                        *
.*        V9.04.01  12/10/2004  Lina Vo CAR 54176                             *
.*                  Added Multi-Hospital processing     
.*        V5.09.B03 09.01.2001 J.Tan                                          *
.*                  Changes for WEB report                                    *
.*        V5.09.B02 03.01.2001 J.Tan                                          *
.*                  Changes for WEB report                                    *
.*        V5.09.00  20.12.2000 Bronko Sosic                                   *
.*                  Recompiled for MRTHISFD                                   *
.*        V5.08.02  05/12/2000  J.Tan                                         *
.*                  Mods to print current ward for current inpatients         *
.*        V5.08.01  28/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.08.B02 16/03/2000  Greg Horvat                                   *
.*                  Changed to get the coding from the episode coding files   *
.*           V5.08.B01  31/12/1999  Tonii Tang     SRF 636621                 *
.*                      Added new subroutine PSTA0000, called by READLOP      *
.******************************************************************************
.*           V5.07.01   30/06/1999  Caleb Sharman  SRF 645753                 *
.*                      Mods to print layout                                  *
.*           V5.07.B04  15/01/1999  Nicole Harrington 507 rebound 068         *
.*                      Mods to use HEAD132                                   *
.                   22/10/1998  Glenn Berry      5.07 changes
.******************************************************************************
.*           V5.01.02   13/01/93  Whirlpool                                   *
.*                      Dudley Address changes                                *
.*           V5.01.03   13/01/93  Whirlpool                                   *
.*                      Dudley Address changes                                *
.*           V5.01.04   16/03/93  DIG                                         *
.*                      Added options 2 + 3 and changed report layout for     *
.*                      H.R.H.                                                *
.*           V5.01.05   17/05/1993  Robert Sumsion                            *
.*                      Converted vars and includes to mrt in                 *
.*                      standard form.                                        *
.*           V5.01.06   25/05/1994  Sandra Barcham                            *
.*                      Fix for global recompile                              *
.*        V5.04.01  26/06/1997  Howellsy         505                          *
.*                  Use PATDOCKY instead of PATDOCDS                          *
.*                                                                            *
.******************************************************************************
.
          INC       STD001FD
          INC       IBACONFD/INC
          INC       IBASEQFD/INC
          INC       MRTMASFD/INC
          INC       PATCONFD/INC
          INC       PATCODFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC
          INC       PMSVX1FD/INC
          INC       TFILEVAR/INC
          INC       MRTHISFD/INC
          INC       MRTLOCFD/INC
          INC       WEBERRFD/INC
+
.
.         TEMP FILES DECLARATION
.
PSTROL    FILE      ASCII, FIXED=256
TMPFILE1  IFILE     SQL, FIXED=160, KEY="u1-23"
TMPFILE2  IFILE     SQL, FIXED=160, KEY="u70-77,1-23"
TMPFILE3  IFILE     SQL, FIXED=160, KEY="u127-136,1-23"
.
. ----- TMPFILE consists of following vars -----
.
. Name   Type      Length     Physical     Start   Description
. ----   ----      ------     --------     -----   -----------
XLOCN     DIM       7          7             1
XLDATE    DIM       8          8             8
DUNIQUE   DIM       8          8            16
.DCODE    DIM       6          6            24
.DNAME23  DIM      23         23            30
.DTELES   DIM      20         20            53
.PURNO    DIM       8          8            73
.DADMNO   DIM       8          8            81
.PSNAME   DIM      20         20            89
.PNAME21  DIM      21         21           109
.PADATE   DIM      10         10           130
.A5TIME   DIM       5          5           140
.PDDATE   DIM      10         10           145
.D5TIME   DIM       5          5           155
.End of Record                             160
.
.         WORK VARIABLES
.
A5TIME    DIM       5
ALLHOSP   FORM      1     * Multi Hospital ind. for "All Hospitals"   *I-266254
BOARDFLG  FORM      1     * used to branch over boarder check
.
CMDLINE   DIM       50
COUNT     FORM      8
.
D5TIME    DIM       5
DIM2A     DIM       2
DIM3      DIM       3     * required by PATDOCDS
DNAME23   DIM       23
DOCCODE   DIM       6
DOCTEMP   DIM       6
.
EDOC23    DIM       23    * Ending Doctor description
END6      DIM       6
ENDATE    DIM       8
.
FADMNO    DIM       8
FIRST     DIM       1
FNAMER    DIM       8
FNAMET    DIM       8
.
.
LNO       FORM      2
LSTDATE   DIM       8
LOCNDATA  DIM       28       * formated Location data for printing    *I-266254
.
MRCNHLOC  DIM       4
NODIS     FORM      1
.
PAGENO    FORM      3
PADATE    DIM       10
PATHOSP   DIM       3        * Patient's Hospital Id.                 *Imte266254
PDDATE    DIM       10
PFDATE    DIM       10
PRNINP    DIM       3
PTDATE    DIM       10
PNAME21   DIM       21
.
QUESTFLG  FORM      1     * Doctor codes "?" routine flag
.
SAMEF     FORM      1
SAVLOCN   DIM       7
SAVURNO   DIM       8
SDOC23    DIM       23    * Starting Doctor description
START6    DIM       8
STARTD    DIM       8
STATUS    FORM      1
.
.
UNIQUE    FORM      8
UKDOCFLG  FORM      1     * Unknown Doctor flag  (0=Used, 1=Not used)
.
XDIM6     DIM       6
XLDATFRM  DIM       10
XLOCNDSC  DIM       25
YDIM6     DIM       6
.
.         CONSTANTS
.
CODEP     INIT      "P "
CBB       INIT      ")"
OBB       INIT      "("
FIVE5     FORM      "55"
FSTREC    INIT      "Start "
LSTREC    INIT      "Finish"
.
SP12      INIT      "            "
SP14      INIT      "              "
SP23      INIT      "                       "
SP28      INIT      "                            "
Z30       INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
ZED30     INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
.
PRGID     INIT      "IBAMRT43"
PRGNAM    INIT      "Discharges With/without Disease Codes"
VERSION   INIT      "V12.00.01"
+
.
.         Display screen header and open files
.
          CALL      DISPHEAD
.
          DISPLAY   *P56:24,"Opening patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATDO1A2,"patdo1af"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH2,"patdschf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patecdaf";
          OPEN      PATECDA2,"patecdaf"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"pattranf"
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"mrthisaf";
          OPEN      MRTHISA1,"mrthisaf"
.
          DISPLAY   *P64:24,"mrtlocaf";
          OPEN      MRTLOCA1,"mrtlocaf"
.
          DISPLAY   *P64:24,"mrtmasaf";
          OPEN      MRTMASA1,"mrtmasaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN5;*249,CRDRTYP
          READ      CONTROLF,TEN;*66,CINVLAY
          READ      CONTROLF,TWENTY1;*247,PTCNDCQS
          READ      CONTROLF,SIXTY;*84,MRCNHLOC
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
...       MOVE      ONE,BOARDFLG
...       COMPARE   EIGHT,CINVLAY
...       GOTO      INIT0000 IF NOT EQUAL
          MOVE      ZERO,BOARDFLG
.
INIT0000  CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMER
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMET
.
          MOVE      ZERO,ALLHOSP                                      *I-266254
          MOVE      ONE,CNEWDS              * set new standard for PATDOCDS
+
.
.         SELECT OPTION
.
.*******************************************************************************
.*       (NOTE: If new option(s) is to be added after Option 4 please check    *
.*              print routine to make sure it handles printing for the new     *
.*              option(s) as well)                                             *
.*******************************************************************************
.
          DISPLAY   *P1:4,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = ":
                    "Discharges Without Disease Code By File Location":
                    *P1:6,*V2LON,TWO,*HOFF," = ":
                    "Discharges Without Disease Code By U/R Number":
                    *P1:7,*V2LON,THREE,*HOFF," = ":
                    "Discharges Without Disease Code By Admission Date":
                    *P1:9,"Select Option :";
.
REKSTRT   KEYIN     *P17:9,*EL,*DV,UNDLN1,*P17:9,*V2LON,OPTION;
.
          COMPARE   ZERO TO OPTION
          GOTO      ENDIT IF EQUAL
.
          BRANCH    OPTION,VALID,VALID,VALID
          BEEP
          GOTO      REKSTRT
.
VALID     DISPLAY   *P1:11,"Starting Discharge Date :":
                    *P1:12,"Ending   Discharge Date :"
.
.         Keyin Start Discharge Date
.
KSTART    MOVE      ZERO,CHIGHLT            * 0 = highlight
          MOVE      ONE,CDEFDTE             * 1 = check day only for default 
.
          MOVE      "28",CCOL               * column for keyin
          MOVE      "11",CVERT              * row for keyin
          MOVE      "50",ECOL               * column for error
          MOVE      "11",EVERT              * row for error
.                                           * 1 = check day only for default
KSTART1   MOVE      SP2,CDAY                * set up defaults
          MOVE      SP2,CMON
          MOVE      SP2,CYEAR
          CALL      KEYDATE
          BRANCH    CQUEST,KSTART1          * "?" keyed
          BRANCH    OVRCD,FINISH            * no date keyed
.
          PACK      STARTD,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STARTD
          PACK      PFDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          REP       " 0",PFDATE
.
.         Keyin End Discharge Date
.
KEND      MOVE      "12",CVERT              * row for keyin
          MOVE      "12",EVERT              * row for error
.
KEND1     MOVE      SP2,CDAY                * set up defaults
          MOVE      SP2,CMON
          MOVE      SP2,CYEAR
          CALL      KEYDATE
          BRANCH    CQUEST,KEND1            * "?" keyed
          BRANCH    OVRCD,CURDAY            * no date keyed
          GOTO      CHKDAT2
.
CURDAY    MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CYY,CYEAR
          REP       " 0",CDAY
          REP       " 0",CMON
          REP       " 0",CYEAR
          DISPLAY   *P28:12,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
.
CHKDAT2   PACK      ENDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDATE
          PACK      PTDATE WITH CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          REP       " 0",PTDATE
.
          MATCH     STARTD,ENDATE
          GOTO      CHKDAT3 IF LESS
..          GOTO      CONFIRM IF NOT LESS
.
          CALL      KHOS0000
          BRANCH    EXIT,VALID
          GOTO      CONFIRM 
.
CHKDAT3   DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Ending Date must be > or equal to Starting Date **  ";
          CALL      HITENTER
          GOTO      KEND
.
.         Keyin Start Doctor Code
.
KFDOC     MOVE      SP23,SDOC23
          MOVE      "17",CCOL1
          DISPLAY   *P40:17,"( ",*V2LON,"?",*HOFF," for Doctors Scan )";
.
          MOVE      SP10,START6
          MOVE      "29",ECOL
          MOVE      "17",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
          CALL      PATDOCKY
          BRANCH    EXIT,KFDOC1,KFDOC
.
          MOVE      DCODE,START6
          GOTO      KFDOC2
.
.
KFDOC1    MOVE      ZERO,UKDOCFLG          * set Unknown Doctor flag to used
          DISPLAY   *P29:17,*EL,*V2LON,FSTREC;
          GOTO      KTDOC
.
KFDOC2    MOVE      START6,KEY6
          MOVE      DGNAME,ANS
          PACK      SDOC23,ANS,DOT,SP1,DSNAME
          MOVE      ONE,UKDOCFLG           * set Unknown Doctor flag to not used
          DISPLAY   *P29:17,*EL,*V2LON,START6,*HOFF,*P40:17,SDOC23;
          GOTO      KTDOC
.
.         Keyin End Doctor Code
.
KTDOC     MOVE      SP23,EDOC23
          MOVE      "18",CCOL1
          DISPLAY   *P40:18,"( ",*V2LON,"?",*HOFF," for Doctors Scan )";
.
          MOVE      SP10,END6
          MOVE      "29",ECOL
          MOVE      "18",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
          CALL      PATDOCKY
          BRANCH    EXIT,KTDOC11,KTDOC
.
          MOVE      DCODE,END6
          GOTO      KTDOC2
.
KTDOC11   DISPLAY   *P29:18,*EL,*V2LON,LSTREC;
          CALL      KHOS0000
          BRANCH    EXIT,VALID
          GOTO      CONFIRM
.
KTDOC2    MOVE      END6,KEY6
.
          MATCH     START6,END6
          GOTO      KTDOC31 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Ending Code must be > or equal to Starting Code **  ";
          CALL      HITENTER
          GOTO      KTDOC
.
KTDOC31   MOVE      DGNAME,ANS
          PACK      EDOC23,ANS,DOT,SP1,DSNAME
KTDOC32   DISPLAY   *P29:18,*EL,*V2LON,END6,*HOFF,*P40:18,EDOC23;
          GOTO      KTDOC4
.
.       Unknown Doctor flag is only used if Doctor Code range is Start to Finish
.       - added for SRF 106567
.
KTDOC4    CALL      KHOS0000
          BRANCH    EXIT,VALID
          BRANCH    UKDOCFLG,CONFIRM
          MOVE      ONE,UKDOCFLG
          GOTO      CONFIRM
.
.         Redisplay Screen after "?" option for Doctor codes
.
RDSP0000  DISPLAY   *P1:4,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = ":
                    "Discharges Without Disease Code By Attending Doctor":
                    *P1:6,*V2LON,TWO,*HOFF," = ":
                    "Discharges Without Disease Code By Referring Doctor":
                    *P1:7,*V2LON,THREE,*HOFF," = ":
                    "All Discharges By Attending Doctor":
                    *P1:8,*V2LON,FOUR,*HOFF," = ":
                    "All Discharges By Referring Doctor":
                    *P1:10,"Select Option : ",*V2LON,OPTION,*HOFF:
                    *P1:14,"Starting Discharge Date  :  ",*V2LON,PFDATE,*HOFF:
                    *P1:15,"Ending   Discharge Date  :  ",*V2LON,PTDATE,*HOFF:
                    *P1:17,"Starting Doctor Code     :  ":
                    *P1:18,"Ending   Doctor Code     :  ";
.
          MATCH     SP6,START6
          GOTO      RDSP1000 IF EQUAL
          DISPLAY   *P29:17,*V2LON,START6,*HOFF,*P40:17,SDOC23;
          GOTO      RDSP9999
.
RDSP1000  DISPLAY   *P29:17,*V2LON,FSTREC;
.
RDSP9999  RETURN
+
.******************************************************************************
.*                                  KHOS0000              Called by: ML0000   *
.*                            Enter The Date Ranges                           *
.******************************************************************************
KHOS0000  COMPARE   ONE,IBCNMHOS
          GOTO      KHOS9999 IF NOT EQUAL
.
          DISPLAY   *P1:14,*EL,"Hospital Id : ";
          MOVE      TEN5,ECOL
          MOVE      TEN4,EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ZERO,CKYIMAND           * Not Mandatory
          OPEN      PATHSPA1,"pathspaf"
.
          CALL      PATHSPKY
          BRANCH    EXIT,KHOS2000,KHOS9500
          GOTO      KHOS3000
.
KHOS2000  MOVE      "All Hospitals",PTHSNAME
          MOVE      SP10,PTHSHOSP
          MOVE      ONE,ALLHOSP                                       *I-266254
          MOVE      ZERO,EXIT
.
KHOS3000  CLOSE     PATHSPA1
.
          DISPLAY   *P20:14,*V2LON,PTHSNAME;
          GOTO      KHOS9999
.
KHOS9500  MOVE      ONE,EXIT
KHOS9999  RETURN
+
.
.         Confirm Date and Doctor Code ranges
.
CONFIRM   DISPLAY   *P1:24,*EL,"Ok to Continue (":
                    *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ?";
.
CONFIRM1  KEYIN     *P24:24,*DV,UNDLN1,*P24:24,*V2LON,ANS;
.
          RESET     ANS
          GOTO      CONFIRM2 IF EOS
          REP       UPPLOW,ANS
          DISPLAY   *P24:24,*V2LON,ANS;
.
          MATCH     "N",ANS
          GOTO      CLSCR IF EQUAL
          MATCH     "Y",ANS
          GOTO      PROCESS IF EQUAL
.
CONFIRM2  BEEP
          GOTO      CONFIRM1
.
CLSCR     DISPLAY   *P29:14,*EL,*P29:15,*EL,*P29:17,*EL,*P29:18,*EF;
          GOTO      KSTART
.
FINISH    DISPLAY   *P1:10,*EF;
          GOTO      REKSTRT
.
.         Start processing data for report
.
PROCESS   CALL      KILLIDX
          CALL      CREAIDX
.
          OPEN      TMPFILE1,FNAMET
          OPEN      TMPFILE2,FNAMET
          OPEN      TMPFILE3,FNAMET
          MOVE      ZERO,PAGENO
          MOVE      "60",LNO
          MOVE      ONE TO UNIQUE
.
NODET     DISPLAY   *P1:24,*EL,*V2LON:
                    *P20:24,"** Scanning Discharge File **",*W2:
                    *HOFF,*P1:24,*EL,*P40:24,"Discharge Date :"
.
.         READ DISCHARGE FILE BASE ON START & END DATE
.
          PACK      KEY16,STARTD,SP20
          CALL      RDSDSCH2
.
LOOP      CALL      RDKDSCH2
          BRANCH    OVRCD OF PRINTR
          REP       " 0",DDATE
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          PACK      LSTDATE,CCENT,CYEAR,CMON,CDAY
.
          MATCH     SP8,ENDATE                    * in date range?
          GOTO      NEXT10 IF EQUAL
.
          MATCH     LSTDATE,ENDATE
          GOTO      PRINTR IF LESS
.
NEXT10    MOVE      SP3,PATHOSP                                       *I-266254
          IF        IBCNMHOS=1
            PACK      KEY8,DADMNO,SP10
            CALL      RDPMVX11
            BRANCH    OVRCD,LOOP
            MATCH     SP10,PTHSHOSP
            IF        !@EQUAL
              MATCH     PTHSHOSP,PMVXMHOS   * is it "All Hospitals"?
              GOTO      LOOP IF NOT EQUAL
            ENDIF
            MOVE      PMVXMHOS,PATHOSP      * save Patient's Hosp     *I-266254
          ENDIF
.
          DISPLAY   *P57:24,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
.
          BRANCH    OPTION OF NODISE,NODISE,NODISE
.
NODISE    PACK      KEY16,DADMNO,SP20
          CALL      RSPTECD2
NXDISE    CALL      RKPTECD2
          BRANCH    OVRCD,CHKADM
.
          MATCH     DADMNO,PTEDADMN
          GOTO      CHKADM IF NOT EQUAL
.
          COMPARE   ZERO,PTEDEPNO                * Skip coding locked record
          GOTO      NXDISE IF EQUAL
.
          GOTO      LOOP
.
CHKADM    MOVE      DADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF LOOP
.
          MATCH     AURNO,DURNO
          GOTO      LOOP IF NOT EQUAL
.
          MOVE      SP7,XLOCN                                          *I-49649
          MOVE      SP8,XLDATE                                         *I-49649
.
. first check if a medical record exists                               *I-49649
.
          PACK      KEY20,AURNO,ZED30                                  *I-49649
          CALL      RSMRMAS1                * Position.                *I-49649
          CALL      RPMRMAS1                * read previous record     *I-49649
          BRANCH    OVRCD,CHKADM00          * none exists report it.   *I-49649
.
          MATCH     AURNO,MRMAURNO          * Same UR?                 *I-49649
          GOTO      CHKADM00 IF NOT EQUAL   * no mstr rec, report it.  *I-49649
.
. a master record exists but get history key of most recent volume     *I-49649
. and must be the same home location.
. get history key of most recent volume
.
          PACK      KEY20,AURNO,ZED30
.
          CALL      RSMRMAS1
CHKADMA1  CALL      RPMRMAS1                      * read previous record
          BRANCH    OVRCD,LOOP                                         *C-49649
.
          MATCH     AURNO,MRMAURNO                * same U/R number?
          GOTO      LOOP IF NOT EQUAL                                  *C-49649
.
          IF        IBCNMHOS=1
            IF        ALLHOSP = 1
              PACK      XLOCN,MRMAHHOS,MRMAHLOC,SP10
              GOTO      CHKADMA2                                      *I-266254
            ENDIF                                                     *I-266254
.
            MATCH     SP70,PTHSHHOS
            IF        !@EQUAL
              MATCH     MRMAHHOS,PTHSHHOS         * check default home location
              GOTO      CHKADMA1 IF NOT EQUAL
.
              MATCH     MRMAHLOC,PTHSHLOC         * check default home location
              GOTO      CHKADMA1 IF NOT EQUAL
            ENDIF
          ELSE
.288704     MATCH     MRMAHLOC,SP3                * check default home location
.288704     GOTO      CHKADMA1 IF NOT EQUAL
.
            MATCH     MRMAHLOC,MRCNHLOC           * check default home location
            GOTO      CHKADMA1 IF NOT EQUAL
          ENDIF
.
. get details from History file
.
CHKADMA2  PACK      KEY26,MRMAKEY,Z30
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,CHKADM00
.
          MATCH     MRMAKEY,MRHIKEY
          GOTO      CHKADM00 IF NOT EQUAL
.
          PACK      XLOCN,MRHIDHOS,MRHILOC,SP70     * location
          MOVE      MRHIDATE,XLDATE                 * date of movement
.
CHKADM00  CALL      EXNB0000                  * Excluded newborn
          BRANCH    EXIT,LOOP
.
          BRANCH    BOARDFLG,CHKADM01
          PACK      KEY5,CODEP,ACLSS
          CALL      RDCODE1                * Cat."P "
          BRANCH    OVRCD,CHKADM01
          MATCH     "3",TCINDC1                * boarder patient ?
          GOTO      LOOP IF EQUAL              * ignore if yes
          IF        PTCNHDPS=1
            MATCH     "R",TCINDC7              * Residential Admission?
            GOTO      LOOP IF EQUAL            * ignore if yes
          ENDIF
.
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                * Cat."A "
          BRANCH    OVRCD,CHKADM01
          MATCH     "B",TCINDC3            * is this a boarder?
          GOTO      LOOP IF EQUAL          * ignore boarders
.
CHKADM01  BRANCH    OPTION,CHKADM04,CHKADM04,CHKADM04
.
CHKADM02  COMPARE   ONE,CRDRTYP               * Free format Referring Doc used ?
          GOTO      CHKADM03 IF NOT EQUAL     * no
.
          MATCH     ARDRNAM,SP23              * null Free format Referring Doc ?
          GOTO      NEXT14 IF EQUAL           * yes
.
          MOVE      SP6,DOCTEMP
          MOVE      SP20,DTELES
          MOVE      ARDRNAM,DNAME23
          GOTO      NEXT18
.
CHKADM03  MOVE      ADOCTR,DOCTEMP
          GOTO      NEXT11
.
CHKADM04  MOVE      ADOCTA,DOCTEMP
.
NEXT11   
...       MATCH     SP6,START6
...       GOTO      NEXT12 IF EQUAL
.
...       MATCH     START6,DOCTEMP
...       GOTO      LOOP IF LESS
.
NEXT12   
...       MATCH     SP6,END6
...       GOTO      NEXT13 IF EQUAL
.
...       MATCH     DOCTEMP,END6
...       GOTO      LOOP IF LESS
.
NEXT13    MOVE      DOCTEMP,KEY6                 * get Doctor's code and name
          CALL      RDDOCT1
          COMPARE   ZERO,OVRCD
          GOTO      NEXT17 IF EQUAL
.
NEXT14    BRANCH    UKDOCFLG,LOOP                  * added for SRF 106567
          MOVE      "UNKN  ",DOCTEMP                          "
          MOVE      SP20,DTELES                               "
          BRANCH    OPTION,NEXT15,NEXT15,NEXT15
.
NEXT15    MOVE      "Unknown Attending Doc. ",DNAME23         "
          GOTO      NEXT18                                    "
.
NEXT16    MOVE      "Unknown Referring Doc. ",DNAME23         "
          GOTO      NEXT18                                    "
.
NEXT17    MOVE      SP23,DNAME23
          MOVE      DGNAME,ANS
          PACK      DNAME23 WITH ANS,DOT,SP1,DSNAME
.
NEXT18    MOVE      SP23,PNAME21
          MOVE      DURNO,KEY8
          CALL      RDMAST1
.
          MOVE      PGNAME,PNAME21
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          PACK      PADATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          REP       " 0",PADATE
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          PACK      PDDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          REP       " 0",PDDATE
.
          MOVE      ATIME,A5TIME
          MOVE      DTIME,D5TIME
.
........  DISPLAY   *P24:24,*V2LON,DOCTEMP;
.
          MOVE      UNIQUE,DUNIQUE
          PACK      KEY23 WITH XLOCN,XLDATE,DUNIQUE
.
          WRITE    TMPFILE1,KEY23;XLOCN,XLDATE,DUNIQUE,DOCTEMP,DNAME23,DTELES:
                                  PURNO,DADMNO,PSNAME,PNAME21,PADATE,A5TIME:
                                  PDDATE,D5TIME
          ADD       ONE TO UNIQUE
          GOTO      LOOP
.
PRINTR    DISPLAY   *P1:24,*EL,*V2LON,*P29:24,"** Generating Report **";
.
          MOVE      SP7,SAVLOCN
          MOVE      SP8,SAVURNO
          CALL      HEADSET
.
          SUB       ONE,UNIQUE
.....     DISPLAY   *P1:23,*EF,"Total Records       : ",*V2LON,UNIQUE,*HOFF:
.....               *P1:24,"Printing Record No. :",*P35:24,"Doctor Code :";
.
          MOVE      ONE,COUNT
          MOVE      "Y",FIRST
          MOVE      SP20 TO KEY20
          MOVE      SP20 TO KEY31
          MOVE      SP30 TO KEY33
          IF        OPTION = 1
            READ      TMPFILE1,KEY20;;
          ELSE
            IF      OPTION = 2
              READ      TMPFILE2,KEY31;;
            ELSE
              READ      TMPFILE3,KEY33;;
            ENDIF
          ENDIF
.
READLOP   IF        OPTION = 1
            READKS    TMPFILE1;XLOCN,XLDATE,DUNIQUE,DCODE,DNAME23,DTELES:
                               PURNO,DADMNO,PSNAME,PNAME21,PADATE,A5TIME:
                               PDDATE,D5TIME
          ELSE
            IF      OPTION = 2
              READKS    TMPFILE2;XLOCN,XLDATE,DUNIQUE,DCODE,DNAME23,DTELES:
                                 PURNO,DADMNO,PSNAME,PNAME21,PADATE,A5TIME:
                                 PDDATE,D5TIME
            ELSE
              READKS    TMPFILE3;XLOCN,XLDATE,DUNIQUE,DCODE,DNAME23,DTELES:
                                 PURNO,DADMNO,PSNAME,PNAME21,PADATE,A5TIME:
                                 PDDATE,D5TIME
            ENDIF
          ENDIF
          GOTO      ENDP IF OVER
.
          MOVE      DUNIQUE,UNIQUE
........  DISPLAY   *P23:24,*V2LON,COUNT,*P49:24,DCODE;
.
          COMPARE   FIVE5,LNO
          CALL      HEAD IF NOT LESS
.
          UNPACK    XLDATE,CCENT,CYEAR,CMON,CDAY     * format movement date
          CALL      PACDATE
          MOVE      CPCDATE,XLDATFRM
.
          MOVE      "--No Med Rec--",MRLODESC  * get location description
          PACK      KEY7,XLOCN
          CALL      RDMRLOC1
          MOVE      MRLODESC,XLOCNDSC
.
          CALL      PSTA0000
.
          PACK      KEY30,DADMNO,Z30
          CALL      RDSTRAN2
          CALL      RDPTRAN2
.
          MATCH     DADMNO,TADMN
          IF        (OVRCD = 1) | !@EQUAL
            MOVE       SP3,TWARD
          ENDIF
.
          MATCH     "Y",FIRST
          GOTO      NOTFST IF NOT EQUAL
          MOVE      "N",FIRST
          MOVE      DCODE,DOCTEMP
.
          BRANCH    OPTION OF NODIS1,NODIS1,NODIS1
          MOVE      "2",SAMEF
          CALL      PRINTD1
          GOTO      NEXTL
.
NODIS1    CALL      NEWREC
          GOTO      NEXTL
.
NOTFST    MATCH     DCODE,DOCTEMP
          GOTO      SAMEH IF EQUAL
          MOVE      DCODE,DOCTEMP
.
          BRANCH    OPTION OF NODIS2,NODIS2,NODIS2
          MOVE      "2",SAMEF
          CALL      PRINTD1
          GOTO      NEXTL
.
NODIS2    CALL      NEWREC
          GOTO      NEXTL
.
SAMEH     BRANCH    OPTION OF NODIS3,NODIS3,NODIS3
          MOVE      "1",SAMEF
          CALL      PRINTD1
          GOTO      NEXTL
.
NODIS3    CALL      LINE1
.
NODIS3A   
..        PRINT     *119,"|",*132,"|"
          CALL      LINE22
..        PRINT     *119,"|",*132,"|"
          CALL      LINE3
..        PRINT     *119,"|",*132,"|"
          GOTO      NEXTL
.
NODIS4    COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
          GOTO      NODIS3 IF NOT EQUAL        * no
          MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
          GOTO      NODIS3 IF EQUAL            * yes
          CALL      LINE1                      * no
          GOTO      NODIS3A
.
NEXTL     ADD       ONE,COUNT
          GOTO      READLOP
.
NEWREC    CALL      LINE1
...       PRINT     *119,"|",*132,"|"
.
          BRANCH    OPTION,NEWREC2,NEWREC2,NEWREC2
          COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
          GOTO      NEWREC2 IF NOT EQUAL       * no
.
NEWREC1   CALL      LINE22
          GOTO      NEWREC3
.
NEWREC2   MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
          GOTO      NEWREC1 IF EQUAL           * yes
          CALL      LINE2                      * no
.
NEWREC3   
...       PRINT     *119,"|",*132,"|"
          CALL      LINE3
...       PRINT     *119,"|",*132,"|"
          RETURN
+
.
.         OVER Condition found..print last line of -- and display message
.
ENDP      COMPARE   ZERO,PAGENO
          GOTO      NOREC IF EQUAL
.
          CALL      HLINE
.
          PRINT     *N,"Location     = Current Location of the record":
                    *N,"Movement     = Last Movement Date":
                    *N,"Doctor       = Admitting Doctor for this visit":
                    *N,"Ward         = Discharge Ward":
                    *N,"Current Ward = Current Inpatient - Current Ward"
          PRINT     *N,"Note: Only the latest volume of Records with a":
                       " Location (",MRCNHLOC,") are shown at this report" 
          PRINT     *N,"***  End of Report  ***"
.
          DISPLAY   *P1:23,*EF,*P24:24,*V2LON:
                    "** Report Generation Completed **",*W2;
.
          CALL      KILLIDX
          GOTO      FINISH
.
NOREC     DISPLAY   *P1:23,*EF,*P28:24,*V2LON,"** No Record Selected **",*W2;
.
          MATCH     "IBARSH99",PGM
          IF        @EQUAL
            PRINT      *N,"No Record Selected "
          ENDIF
.
          CALL      KILLIDX
          GOTO      FINISH
.
.         PRINT ACTUAL DATA
.
PRINTD1   
...       MOVE      "1",NODIS
...       PACK      KEY16,DADMNO,SP20
...       MOVE      SP9,PTEDCODE
...       CALL      RSPTECD2
LOOPX     
...       CALL      RKPTECD2
...       BRANCH    OVRCD,NODISS
.
...       MATCH     DADMNO,PTEDADMN
...       GOTO      NODISS IF NOT EQUAL
.
...       BRANCH    NODIS OF LNON...ECOND,THIRD,FOURTH,FIFTH
...       CALL      LINE3
...       PRINT     *109,PTEDCODE,*119,"|",*132,"|"
...       SUB       ONE,NODIS
...       GOTO      LOOPX
.
FIFTH  
...       CALL      LINE3
...       PRINT     *98,PTEDCODE;
...       ADD       ONE,NODIS
...       GOTO      LOOPX
.
FOURTH   
...       PRINT     *109,PTEDCODE,*119,"|",*132,"|"
...       ADD       ONE,NODIS
...       GOTO      LOOPX
.
THIRD    
...       BRANCH    SAMEF OF THIRD1            * same Doctor code
...       COMPARE   FOUR,OPTION                * not the same Doctor code
...       GOTO      THIRDA IF NOT EQUAL        * not Option 4
...       COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
...       GOTO      THIRDA IF NOT EQUAL        * no
...       GOTO      THIRD1                     * yes
.
THIRDA  
...       MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
...       GOTO      THIRD1 IF EQUAL            * yes
...       CALL      LINE2                      * no
...       PRINT     *98,PTEDCODE;
...       GOTO      THIRD2
.
THIRD1  
...       CALL      LINE22
...       PRINT     *98,PTEDCODE;
.
THIRD2  
...       ADD       ONE,NODIS
...       GOTO      LOOPX
.
SECOND 
...       PRINT     *109,PTEDCODE,*119,"|",*132,"|"
...       ADD       ONE,NODIS
...       GOTO      LOOPX
.
LNONE     BRANCH    SAMEF OF LNONE1            * same Doctor code
          CALL      LINE1                      * not the same Doctor code
          PRINT     *98,PTEDCODE;
          GOTO      LNONE2
.
LNONE1    COMPARE   FOUR,OPTION                * Option 4 ?
          GOTO      LNONE1A IF NOT EQUAL       * no
          COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
          GOTO      LNONE1A IF NOT EQUAL       * no
          MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
          GOTO      LNONE1A IF EQUAL           * yes
          CALL      LINE1                      * no
          GOTO      LNONE1B
.
LNONE1A   CALL      LINE1
.
LNONE1B   PRINT     *98,PTEDCODE;
.
LNONE2    ADD       ONE,NODIS
          GOTO      LOOPX
.
NODISS    BRANCH    NODIS OF ONE1,TWO2,THREE3,OKCONT,OKCONT1
          GOTO      OKCONT
.
ONE1      BRANCH    SAMEF OF ONE11             * same Doctor code
          CALL      LINE1                      * not the same Doctor code
...       PRINT     *119,"|",*132,"|"
.
          COMPARE   FOUR,OPTION                * Option 4 ?
          GOTO      ONE1B IF NOT EQUAL         * no
          COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
          GOTO      ONE1B IF NOT EQUAL         * no
.
ONE1A     CALL      LINE22
          GOTO      OKCONT
.
ONE1B     MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
          GOTO      ONE1A IF EQUAL             * yes
          CALL      LINE2                      * no
          GOTO      OKCONT
.
ONE11     COMPARE   FOUR,OPTION                * Option 4 ?
          GOTO      ONE11A IF NOT EQUAL        * no
          COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
          GOTO      ONE11A IF NOT EQUAL        * no
          MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
          GOTO      ONE11A IF EQUAL            * yes
          CALL      LINE1                      * no
          GOTO      ONE11B
.
ONE11A    CALL      LINE1
.
ONE11B  
....      PRINT     *119,"|",*132,"|"
          CALL      LINE22
          GOTO      OKCONT
.
TWO2      
....      PRINT     *119,"|",*132,"|"
          BRANCH    SAMEF OF TWO21             * same Doctor code
          COMPARE   FOUR,OPTION                * not the same Doctor code
          GOTO      TWO2A IF NOT EQUAL         * not Option 4
          COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
          GOTO      TWO2A IF NOT EQUAL         * no
          GOTO      TWO21                      * yes
.
TWO2A     MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
          GOTO      TWO21 IF EQUAL             * yes
          CALL      LINE2                      * no
          GOTO      OKCONT
.
TWO21     CALL      LINE22
          GOTO      OKCONT
.
THREE3    BRANCH    SAMEF OF THREE31           * same Doctor code
          COMPARE   FOUR,OPTION                * not the same Doctor code
          GOTO      THREE3A IF NOT EQUAL       * not Option 4
          COMPARE   ONE,CRDRTYP                * Free format Referring Doctor ?
          GOTO      THREE3A IF NOT EQUAL       * no
          GOTO      THREE31                    * yes
.
THREE3A   MATCH     "UNKN  ",DCODE             * unknown Doctor code ?
          GOTO      THREE31 IF EQUAL           * yes
          CALL      LINE2                      * no
          GOTO      OKCONT
.
THREE31   CALL      LINE22
.
OKCONT    
....      PRINT     *119,"|",*132,"|"
.
OKCONT1   CALL      LINE3
...       PRINT     *119,"|",*132,"|"
          RETURN
+
.
LINE1     UNPACK    XLOCN,KEY3,KEY4    * Hosp code & Locn code        *I-266254
          IF        ALLHOSP = 1
            MATCH     SP3,KEY3
            IF        !@EQUAL
              PACK      LOCNDATA,OBB,KEY3,CBB,SP1,KEY4,SP2,XLOCNDSC
            ELSE
              PACK      LOCNDATA,SP6,KEY4,SP2,XLOCNDSC
            ENDIF
          ELSE
            PACK      LOCNDATA,KEY4,SP2,XLOCNDSC
          ENDIF                                                * end  *I-266254
LINE1A    IF        OPTION = 1
            MATCH     SP7,XLOCN
            GOTO      LINE105 IF EQUAL
            MATCH     SAVLOCN,XLOCN                 * same location code?
            GOTO      LINE110 IF EQUAL
          ELSE
            MATCH     SP8,SAVURNO
            GOTO      LINE105 IF EQUAL
.
            MATCH     SAVURNO,PURNO
            GOTO      LINE115 IF EQUAL
          ENDIF
LINE105   PRINT     *1,"|",PURNO,*10,"|",PSNAME,*34,"| ",LOCNDATA:    *C-266254
                    *65,"|",XLDATFRM,*76,"| ",DCODE,*84,"| ",TWARD,*91,"| ":
                    *98,PRNINP,*106,"|",DADMNO,"|",PADATE,*127,A5TIME,*132,"|"
          ADD       ONE,LNO
.         MOVE      XLOCN,SAVLOCN                 * save location code *D-49649
.         MOVE      PURNO,SAVURNO                 * save U/R number    *D-49649
          RETURN
LINE110   PRINT     *1,"|",PURNO,*10,"|",PSNAME,*34,"|",*65,"|",XLDATFRM:
                    *76,"| ",DCODE,*84,"| ",TWARD,*91,"| ",*98,PRNINP,*106:
                        "|",DADMNO,"|",PADATE,*127,A5TIME,*132,"|"
          ADD       ONE,LNO
          RETURN
LINE115   PRINT     *1,"|",*10,"|",*34,"| ",LOCNDATA:                 *C-266254
                    *65,"|",XLDATFRM,*76,"| ",DCODE,*84,"| ",TWARD,*91,"| ":
                    *98,PRNINP,*106,"|",DADMNO,"|",PADATE,*127,A5TIME,*132,"|"
          ADD       ONE,LNO
.         MOVE      PURNO,SAVURNO                 * save U/R number    *D-49649
          RETURN
.
LINE2     PRINT     *1,"|",*10,"|",PNAME21,*34,"|",*65,"|",*76,"|":
                    *84,"|",*91,"|",*106,"|",*115,"|",PDDATE:
                    *127,D5TIME,*132,"|"
          ADD       ONE,LNO
          RETURN
.
LINE22    PRINT     *1,"|",*10,"|",PNAME21,*34,"|",*65,"|",*76,"|",*84,"|":
                    *91,"|",*106,"|",*115,"|",PDDATE,*127,D5TIME,*132,"|"
          ADD       ONE,LNO
          RETURN
.
LINE3     PRINT     *1,"|",*10,"|",*34,"|",*65,"|",*76,"|",*84,"|",*91,"|":
                    *106,"|",*115,"|",*132,"|"
          ADD       ONE,LNO
          RETURN
.
.         HEADINGS FOR OUTPUT
.
HEAD      MOVE      SP7,SAVLOCN
          MOVE      SP8,SAVURNO
          COMPARE   ZERO,PAGENO
          CALL      HLINE IF NOT EQUAL
          CLOCK     TIME,CTIMEIS
.
          ADD       ONE,PAGENO
          MOVE      ONE,CNOUNDLN
          CALL      IBACLOCK
          CALL      HEAD132
.
          MOVE      "8",LNO
          BRANCH    OPTION OF PHEAD1,PHEAD2,PHEAD3
.
PHEAD1    PRINT     *N,*40,"DISCHARGES WITHOUT DISEASES CODE BY LOCATION CODE";
          GOTO      PREST 
.
PHEAD2    PRINT     *N,*40,"DISCHARGES WITHOUT DISEASES CODE BY U/R NUMBER";
          GOTO      PREST 
.
PHEAD3    PRINT     *N,*40,"DISCHARGES WITHOUT DISEASES CODE BY ADMISSION DATE";
          GOTO       PREST
.
PHEAD4    PRINT     *N,*40,"ALL DISCHARGES BY REFERRING DOCTOR";
.
PREST     PRINT     *N,*40,"Discharge Date : From  ",PFDATE,"  To  ",PTDATE,*N;
.........           *40,"Doctor Code    : From   ",XDIM6,"   To   ",YDIM6,*N
.
          IF        IBCNMHOS=1
            PRINT     *40,"Hospital : ",PTHSNAME,*N
          ENDIF
.
          CALL      HLINE
          PRINT     *1,"| U/R No",*10,"| Patient's Surname /":
                    *34,"| Current Location",*65,"| Last Date":
                    *76,"| Doctor":
                    "| Ward | Current Ward",*106,"| Adm No | ":
                    "Adm.  Date/Time",*132,"|":
                    *N,*1,"|",*10,"|",*22,"Given Names |":
                    *65,"| Movement |  Code",*84,"| Code",*91,"|",*106,"|":
                    *115,"| Dsch. Date/Time",*132,"|"
          CALL      HLINE
.
          MOVE      "Y",FIRST
          RETURN
+
.
HLINE     PRINT      *1,"*--------------------------------------------------":
                    *52,"---------------------------------------------------":
                   *103,"-----------------------------*"
          ADD       ONE,LNO
          RETURN
+
.         Deleting an Indexed File based on PORT
.
KILLIDX   CLOSE     TMPFILE1
          CLOSE     TMPFILE2
          CLOSE     TMPFILE3
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMET,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.
.         Creating Temp Indexed file used for this report
.
CREAIDX   PREP      PSTROL,FNAMER
          WRITE     PSTROL,SEQ;"isbuild ",FNAMET," 160 u1-23 u70-77,1-23 u127-136,1-23"
          WEOF      PSTROL,SEQ
.
          CLEAR     CMDLINE
          APPEND    "sh ",CMDLINE
          APPEND    FNAMER,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CLOSE     PSTROL,DELETE
          RETURN
+
.
HEADSET   MOVE      SP6,XDIM6
          MOVE      SP6,YDIM6
.
          MOVE      START6,XDIM6
          MOVE      END6,YDIM6
.
          MATCH     SP6,START6
          GOTO      CONT3 IF NOT EQUAL
          MOVE      FSTREC,XDIM6
.
CONT3     MATCH     SP6,END6
          RETURN    IF NOT EQUAL
          MOVE      LSTREC,YDIM6
          RETURN
+
.****************************************************************************
.*                               PSTA0000                 Called by READLOP *
.*       Function determine whether or not patient status is                *
.*                       current inpatient                                  *
.*          RETURNS:    YES or NO                                           *
.****************************************************************************
PSTA0000  MOVE      SP10,PRNINP                * Default status to No
          PACK      KEY24,PURNO,Z30
          CALL      RDSVISA2
PSTA1000  CALL      RDPVISA2
          BRANCH    OVRCD,PSTA9999
.
          MATCH     PVIURNO,PURNO
          GOTO      PSTA9999 IF NOT EQUAL
.
          COMPARE   PVITYPE,THREE
          GOTO      PSTA1000 IF NOT EQUAL
.
          MOVE      DADMNO,FADMNO         * Change admission number to form
          MATCH     FADMNO,PVIBILL
          GOTO      PSTA9999 IF EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PSTA1000
.
          IF        ASTAT = 2
            MOVE      AWARD,PRNINP
          ELSE
            GOTO      PSTA1000
          ENDIF
.
PSTA9999  RETURN
+
.
ENDIT     CHAIN     PGM
          STOP
+
.==============================================================================
.
          INCLUDE   STD001IO
.
          INC       EXCLNEWB
          INC       PATDOCKY
          INC       PATHSPKY    
          INC       TFILENAM
.
          INC       IBASEQIO/INC
          INC       MRTMASIO/INC
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATHSPIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       MRTHISIO/INC
          INC       MRTLOCIO/INC
          INC       WEBERRIO/INC
+
