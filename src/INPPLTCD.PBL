.******************************************************************************
.*  Include Name : INPPLTCD.PBL                                               *
.*                                                                            *
.*  Description  : Routines for Patient Letter printing                       *
.*  Author       : Don Nguyen                                                 *
.*  Date         : 14/11/2018                                                 *
.*                                                                            *
.*  Routines     : SET0000   Set the % Variables                              *
.*                                                                            *
.*               : CASE0000  Routine to convert all except first character of *
.*                           each word to lower case.                         *
.*                                                                            *
.*               : CLGP0000  Clear GP Details                                 *
.*                                                                            *
.*               : SHSP0000  Set up hospital details for multi hospital       *
.*                                                                            *
.*               : FILSTR00  Fill variables with '*'                          *
.*                                                                            *
.*               : FILSPA00  Fill variables with a single space               *
.*                                                                            *
.*               : CONS0000  Set Up Constant % Variables                      *
.*                                                                            *
.*               : FDAT0000  Format the Date                                  *
.*                                                                            *
.*               : PRLT0000  Set up and print letter one line at a time       *
.*                           Returns : EXIT = 0 ask if to print more letters  *
.*                                     EXIT = 1 select another letter to print*
.*                                     EXIT = 2 get next item on temp file    *
.*                                                                            *
.*               : PAGE0000  Routine to paginate if a new page is required    *
.*                                                                            *
.*               : MOD0000   Modify a line to substitute "%" variable values  *
.*                                                                            *
.*               : GETV0000  Extracts the "%" variable from the line          *
.*                                                                            *
.*               : COMX0000  Routine to compress trailing blanks in PRTSTRNG  *
.*                                                                            *
.*                                                                            *
.*  Modifications:                                                            *
.*----------------------------------------------------------------------------*
.* V12.00.02 05/09/2025  Thanh T          TSK 0949457                         *
.*           Added LXPUSRAC-LXPUSRIL fields                                   *
.* V12.00.01 19/05/2025 Thanh T           TSK 0955096                         *
.*           Changed for alphanumeric visit number                            *
.*----------------------------------------------------------------------------*
.* V11.05.01 03/03/2025  J.Tan            TSK 0957529                         *
.*           Fixed unreleased deposit                                         *
.* V11.04.06 06/11/2024  Alina Bhari       TSK 0947770                        *
.*           calculated total out of pocket amount after deducitng from the   *
.*           deposit transaction  -SET0105                                    *
.* V11.04.05 17/07/2024  Thanh T           TSK 0939648                        *
.*           Added LXPXSN18-LXPXSN30 fields                                   *
.* V11.04.04 17/05/2024  Thanh T           TSK 0941543                        *
.*           Added ETHLAN00 section for Ethnicity1-2, Main Language Spoken At *
.*           Home 1-2 and Next Of Kin Main Language Spoken At Home 1-2        *
.*           variables for Codes and long descriptions (206-217)              *
.* V11.04.03 05.02.2024  DA Sarkies    TSK 0936282                            *
.*           Increased size of variable to hold health fund number            *
.* V11.04.02 07/12/2023  Don Nguyen    TSK 0893290                            *
.*           Added ability to send SMS to other contact numbers only; OCONTSMS*
.* V11.04.01 27/11/2023  Peter Vela     TSK 0935874                           *
.*           Added validation for PTCNUNET = 3                                *
.* V11.03.01 20/07/2023  Nikitha B        TSK 0934383                         *
.*           Suqeezed LXELTOOP for white spaces                               *
.* V11.02.01 26/04/2022  Thanh T          TSK 0903453                         *
.*           Added LXPXUCC4, LXUCC4LD, LXPXATF1, LXPXUCC5, LXUCC5LD and       *
.*           LXPXATF2 fields                                                  *
.* V11.01.02 20/08/2021  Ebon Clements    TSK 0910423                         *
.*           Added last ward bed variables 194 and 199                        *
.* V11.01.01 27/05/2021  Ebon Clements    TSK 0900650                         *
.*           Added SMS leave register variables 189 to 193                    *
.* V11.00.02 15/07/2020  Tracey Nguyen    TSK 0893621                         *
.*           Added %smsusrnm (LCCSMSUN/LXXSMSUN)                              *
.* V10.15.02 29/11/2019  Thanh T          TSK 0885262                         *
.*           Added LXPGNAM1 and LXPGNAM2                                      *
.* V10.15.01 17/10/2019  Thanh T          TSK 0877294                         *
.*           Changed SET0210 to show leading zeros for %atimem                *
.*----------------------------------------------------------------------------*
.* V10.14.01 28/08/2019  Thanh T          TSK 0877294                         *
.*           Add %aday(LXADAY), %adays(LXADAYS) and %atimem(LXATIMEM)         *
.*----------------------------------------------------------------------------*
.*     V10.13.00   14/11/2018  Don Nguyen        TSK 0863187                  *
.*                 Create new                                                 *
.*     V10.13.01   23/11/2018  Ken Bell          TSK 0866588                  *
.*                 Added %adatex (LXADATEX) and %adaten (LXADATEN)            *
.******************************************************************************
.
.******************************************************************************
.*                            SET0000                                         *
.*                  Set the % Variables                                       *
.******************************************************************************
SET0000   MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          IF        @EQUAL
            CALL      FILSPA00              * Fill % Var's with a single space
          ELSE
            CALL      FILSTR00              * Fill % Var's with '*'
          ENDIF
          MOVE      ZERO,DSCHFLAG
.
          PACK      KEY8,AADMNO
          CALL      RDMISS1
          BRANCH    OVRCD,SET9000
.
          MOVE      SP8,DDATE               * clear discharge date
          CALL      RDDSCH1
.
SET0100   PACK      KEY8,AURNO
          CALL      RDMAST1
          BRANCH    OVRCD,SET9200
.
          PACK      KEY8,PURNO
          CALL      RDPMPX21
          BRANCH    OVRCD,SET9200
.
          PACK      KEY8,AADMNO
          CALL      RDPMVX11
          BRANCH    OVRCD,SET0110
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTELG1
          IF        OVRCD=1
            CALL      CLPATELG
          ENDIF
.
          PACK      KEY25,DAADMNO,SP70
          CALL      RSRCDTE6
SET0105   CALL      RKRCDTE6
          BRANCH    OVRCD,SET0106
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      SET0106 IF NOT EQUAL
.
          MATCH     SP70,RCDTINVN          * Invoice number must be blank
          GOTO      SET0105 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,SET0105
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      SET0105 IF EQUAL
.
.         Subtract amount to total out of pocket exp
.
          SUB       RCDTAMNT,PTELTOOP
          GOTO      SET0105
.
SET0106   MOVE      PTELTOOP,LXELTOOP              * total out of pocket exp
          SQUEEZE   LXELTOOP
.
          PACK      KEY5,CODEVA,PMVXABRG           * Aboriginality
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXABRG
          ENDIF
.
          PACK      KEY5,CODEVB,PMVXCADM           * Admission Criteria
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXCADM
          ENDIF
.
          PACK      KEY5,CODEVR,PMVXIRAD           * Intention to readmit
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXIRAD
          ENDIF
.
          PACK      KEY5,CODEVI,PMVXIDUS           * Intended stay duration
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXIDUS
          ENDIF
.
          PACK      KEY5,CODEVK,PMVXCRAV           * Carer Availability     
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXCRAV
          ENDIF
.
          PACK      KEY5,CODEVJ,PMVXRCCT           * Crit care Xref         
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE     TDESC,LXVXRCCT
          ENDIF
.
          PACK      KEY6,PMVXAPWD,PMVXAPBD
          CALL      RDWARD1
          IF        OVRCD = 0
            MOVE      WBDESC,LXVXAPWD
          ELSE
            MOVE      "ap",KEY2
            PACK      KEY5,KEY2,PMVXAPWD
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      LXVXAPWD,TDESC,SP70
            ENDIF
          ENDIF
          MOVE      PMVXAPBD,LXVXAPBD
.
          MOVE      PMVXCASE,LXVXCASC
          MATCH     SP70,PMVXCASE
          IF        !@EQUAL
            PACK      KEY10,PMVXCASE,SP70
            CALL      RDALCAS1
            IF        OVRCD=0
              MOVE      ALCADESC,LXVXCASD
            ENDIF
          ENDIF
.
. ---- Set up mother and fathers details
.
SET0110   MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details         
            MOVE      PMCESNAM,PACSNAME              * Mothers Details
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPXMSNA
            MOVE      PMCEGNAM,LXPXMGNA
            MOVE      PMCETITL,LXPXMTLE
            MOVE      PMCEADD1,LXPXMAD1
            MOVE      PMCEADD2,LXPXMAD2
            MOVE      PMCEADD3,LXPXMAD3
            MOVE      PMCEADD4,LXPXMAD4
            MOVE      PMCEPOST,LXPXMPOS
            MOVE      PMCETELP,LXPXMPNO
            MOVE      PMCETELB,LXPXMBNO
            MOVE      PMCETELM,LXPXMMNO
            MOVE      PMCEEMAI,LXPXMEML
.
            PACK      KEY5,CODEC,PMCECONT
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE    TDESC,LXPXMCNT
            ELSE
              MOVE    SP30,LXPXMCNT
            ENDIF
.
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPXMCRP
            ELSE
              MOVE     DNO,LXPXMCRP
            ENDIF
.
            MOVE      SP70,LXPXMLAB
.
            MOVE      PMCERELP,LXPXMREL
          ELSE
            MOVE      PMPXMSNA,PACSNAME              * Mothers Details
            MOVE      PMPXMGNA,PACGNAME
            MOVE      PMPXMTLE,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPXMSNA
            MOVE      PMPXMGNA,LXPXMGNA 
            MOVE      PMPXMTLE,LXPXMTLE 
            MOVE      PMPXMAD1,LXPXMAD1 
            MOVE      PMPXMAD2,LXPXMAD2 
            MOVE      PMPXMAD3,LXPXMAD3 
            MOVE      PMPXMAD4,LXPXMAD4 
            MOVE      PMPXMPOS,LXPXMPOS 
            MOVE      PMPXMPNO,LXPXMPNO 
            MOVE      PMPXMBNO,LXPXMBNO 
            MOVE      PMPXMMNO,LXPXMMNO 
            MOVE      PMPXMEML,LXPXMEML 
.
            PACK      KEY5,CODEC,PMPXMCNT
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE    TDESC,LXPXMCNT
            ELSE
              MOVE    SP30,LXPXMCNT
            ENDIF
.
            MATCH     "1",PMPXMCRP
            IF        @EQUAL
              MOVE     DYES,LXPXMCRP
            ELSE
              MOVE     DNO,LXPXMCRP
            ENDIF
.
            MATCH     "1",PMPXMLAB
            IF        @EQUAL
              MOVE     DYES,LXPXMLAB
            ELSE
              MOVE     DNO,LXPXMLAB
            ENDIF
.
            MOVE      PMPXMREL,LXPXMREL 
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME              * Fathers Details
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPXFSNA
            MOVE      PMCEGNAM,LXPXFGNA
            MOVE      PMCETITL,LXPXFTLE
            MOVE      PMCEADD1,LXPXFAD1
            MOVE      PMCEADD2,LXPXFAD2
            MOVE      PMCEADD3,LXPXFAD3
            MOVE      PMCEADD4,LXPXFAD4
            MOVE      PMCEPOST,LXPXFPOS
            MOVE      PMCETELP,LXPXFPNO
            MOVE      PMCETELB,LXPXFBNO
            MOVE      PMCETELM,LXPXFMNO
            MOVE      PMCEEMAI,LXPXFEML
.
            PACK      KEY5,CODEC,PMCECONT
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE    TDESC,LXPXFCNT
            ELSE
              MOVE    SP30,LXPXFCNT
            ENDIF
.
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPXFCRP
            ELSE
              MOVE     DNO,LXPXFCRP
            ENDIF
.
            MOVE      SP70,LXPXFLAB
.
            MOVE      PMCERELP,LXPXFREL
          ELSE
            MOVE      PMPXFSNA,PACSNAME              * Fathers Details
            MOVE      PMPXFGNA,PACGNAME
            MOVE      PMPXFTLE,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPXFSNA
            MOVE      PMPXFGNA,LXPXFGNA 
            MOVE      PMPXFTLE,LXPXFTLE 
            MOVE      PMPXFAD1,LXPXFAD1 
            MOVE      PMPXFAD2,LXPXFAD2 
            MOVE      PMPXFAD3,LXPXFAD3 
            MOVE      PMPXFAD4,LXPXFAD4 
            MOVE      PMPXFPOS,LXPXFPOS 
            MOVE      PMPXFPNO,LXPXFPNO 
            MOVE      PMPXFBNO,LXPXFBNO 
            MOVE      PMPXFMNO,LXPXFMNO 
            MOVE      PMPXFEML,LXPXFEML 
.
            PACK      KEY5,CODEC,PMPXFCNT
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE    TDESC,LXPXFCNT
            ELSE
              MOVE    SP30,LXPXFCNT
            ENDIF
.
            MATCH     "1",PMPXFCRP
            IF        @EQUAL
              MOVE     DYES,LXPXFCRP
            ELSE
              MOVE     DNO,LXPXFCRP
            ENDIF
.
            MATCH     "1",PMPXFLAB
            IF        @EQUAL
              MOVE     DYES,LXPXFLAB
            ELSE
              MOVE     DNO,LXPXFLAB
            ENDIF
.
            MOVE      PMPXMREL,LXPXFREL 
          ENDIF
.
          MOVE      PMPXSN18,LXPXSN18   
          MOVE      PMPXSN19,LXPXSN19   
          MOVE      PMPXSN20,LXPXSN20   
          MOVE      PMPXSN21,LXPXSN21   
          MOVE      PMPXSN22,LXPXSN22   
          MOVE      PMPXSN23,LXPXSN23   
          MOVE      PMPXSN24,LXPXSN24   
          MOVE      PMPXSN25,LXPXSN25   
          MOVE      PMPXSN26,LXPXSN26   
          MOVE      PMPXSN27,LXPXSN27   
          MOVE      PMPXSN28,LXPXSN28   
          MOVE      PMPXSN29,LXPXSN29   
          MOVE      PMPXSN30,LXPXSN30   
.
.
.         Get DVA Number using concession card details
.
          MOVE      THREE,DIM1                  * set for DVA card type
          CALL      GCCARD00                    * get DVA card details
          PACK      KEY5,CODEDX,PMCDDVAC        * DVA Card colour
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,LXPXDVAC
          ENDIF
.
          PACK      KEY5,CODEVA,PMPXABRG         * Aboriginality    
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,LXPXABRG
          ENDIF
.
          PACK      KEY5,CODEPV,PMPXPRVI         * Privacy          
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,LXPXPRVI
          ENDIF
.
. Identify Gender/pronoun 
.
          MOVE      PMPXUCC4,LXPXUCC4
          MOVE      PMPXATF1,LXPXATF1
          MOVE      PMPXUCC5,LXPXUCC5
          MOVE      PMPXATF2,LXPXATF2
.
          MATCH     SP70,PMPXUCC4
          IF        !@EQUAL
            MOVE      "Gi",DIM2
            PACK      KEY5,DIM2,PMPXUCC4,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      PTCDLDES,LXUCC4LD
            ENDIF
          ENDIF
.
          MATCH     SP70,PMPXUCC5
          IF        !@EQUAL
            MOVE      "Gp",DIM2
            PACK      KEY5,DIM2,PMPXUCC5,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      PTCDLDES,LXUCC5LD
            ENDIF
          ENDIF
.
SET0120   MATCH     SP70,PMPXUSR7
          GOTO      SET0130 IF EQUAL
.
          PACK      KEY5,ANSP,SEVEN,PMPXUSR7,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PMPXUSR7,LXPUSRGC
          MOVE      TDESC,LXPUSRGD
          MOVE      PTCDLDES,LXPUSRGL
.
SET0130   MATCH     SP70,PMPXUSR8
          GOTO      SET0140 IF EQUAL
.
          PACK      KEY5,ANSP,EIGHT,PMPXUSR8,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PMPXUSR8,LXPUSRHC
          MOVE      TDESC,LXPUSRHD
          MOVE      PTCDLDES,LXPUSRHL
.
SET0140   MATCH     SP70,PMPXUSR9
          GOTO      SET0150 IF EQUAL
.
          PACK      KEY5,ANSP,NINE,PMPXUSR9,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PMPXUSR9,LXPUSRIC
          MOVE      TDESC,LXPUSRID
          MOVE      PTCDLDES,LXPUSRIL

.
. Ethnicity and Main Language Spoken At Home
.
SET0150   CALL      ETHLAN00
.
. -----   Set Up hospital details for multi hospitals ------
.
          IF        IBCNMHOS = 1
            CALL      SHSP0000              * set up hospital
          ENDIF 
.
. -----   LXACLASS  Admission Class   -----
.
          MATCH     SP3,ACLSS
          GOTO      SET0200 IF EQUAL        * no code to print
          PACK      KEY5,CODEP,ACLSS
          CALL      RDCODE1
          BRANCH    OVRCD,SET0200
.
          MOVE      TDESC,LXACLASS
.
. -----   LXADATE   Admission Date   -----
.
SET0200   MOVE      "97",CDAY               * 99/12/1999
          CALL      FDAT0000
          MOVE      DATELINE,LXADATEN
.
          MOVE      "98",CDAY               * 99th Dec 1999
          CALL      FDAT0000
          MOVE      DATELINE,LXADATEX
.
          MOVE      "99",CDAY               * 99th December 1999 
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
.          CALL      PACDATE
.          MOVE      CPCDATE,LXADATE
          MOVE      DATELINE,LXADATE
          CMATCH    "0",LXADATE
          IF        @EQUAL
            BUMP      LXADATE
          ENDIF          
.
          CALL      DATECONV
          LOAD      LXADAY,WEEKDAY,MONDAY,TUESDAY,WEDNSDAY,THURSDAY:
                                   FRIDAY,SATURDAY,SUNDAY
          MOVE      LXADAY,LXADAYS
.
          MATCH     SP2,CDAY
          GOTO      SET0210 IF EQUAL
.
          MOVE      MONTH,KEY3
          MOVE      DATELINE,KEY5
          PACK      LXADATEX,KEY5,KEY3,SP1,CCENT,CYEAR
          CMATCH    "0",LXADATEX
          IF        @EQUAL
            BUMP      LXADATEX
          ENDIF          
          PACK      LXADATEN,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
. -----   LXATIME Admission Time  -----
.
SET0210   MOVE      ATIME,LXATIME
          UNPACK    ATIME,CHOUR,ANS,CMIN
          MOVE      CHOUR,FORM2
          IF        FORM2 < 12
            MATCH     "00",CHOUR                 * 00:45 becomes 12:45 am
            IF        @EQUAL
              MOVE      TEN2,FORM2
            ENDIF
            MOVE      FORM2,CHOUR
            REP       " 0",CHOUR
            PACK      LXATIMEM,CHOUR,COLON,CMIN,SP1,AM   * am
          ELSE
            MATCH     "12",CHOUR                 * 22:45 becomes 10:45 pm
            IF        !@EQUAL
              SUB       TEN2,FORM2
              MOVE      FORM2,CHOUR
            ENDIF
            REP       " 0",CHOUR
            PACK      LXATIMEM,CHOUR,COLON,CMIN,SP1,PM   * pm
          ENDIF
.
. -----   LXADCFUL  Attending Doctor's Full Name   -----
.
          PACK      KEY6,ADOCTA
          CALL      RDDOCT1
          BRANCH    OVRCD,SET0300
.
          MOVE      DSNAME,PACSNAME
          MOVE      DGNAME,PACGNAME
          MOVE      DTITL,PACTITLE
.
          MOVE      "1",PACFRMT
          CALL      PACNAME
.
          MOVE      PACFNAME,LXADCFUL
.
. -----   Attending Doctor's Details   -----
.
          MOVE      DSNAME,LXADCSUR
          MOVE      DGNAME,LXADCGIV
          MOVE      DGNAME,LXADCINI
          MOVE      DTITL,LXADCTTL
.
. -----   Patient's Address   -----
.
SET0300   MOVE      PADD1,LXADDA
          MOVE      PADD2,LXADDB
          MOVE      PSUBRB,LXADDC
          MOVE      PADD4,LXADDD
          IF        PSAGE<16
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MOVE      "1",CONTTYPE          * Next of Kin
              CALL      XCON0000              * Get extra contact details
              MOVE      PMCESNAM,PACSNAME
              MOVE      PMCEGNAM,PACGNAME
              MOVE      PMCETITL,PACTITLE
              MOVE      "1",PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,LXKNNAME
              MOVE      PMCEADD1,LXNKADD1
              MOVE      PMCEADD2,LXNKADD2
              MOVE      PMCEADD3,LXNKADD3
              MOVE      PMCEADD4,LXNKADD4
              MOVE      PMCEPOST,LXNKPOST
            ELSE
              MOVE      PNKNAME,LXKNNAME
              MOVE      PNKADD1,LXNKADD1
              MOVE      PNKADD2,LXNKADD2
              MOVE      PNKSUBR,LXNKADD3
              MOVE      PNKADD4,LXNKADD4
              MOVE      PNKPOST,LXNKPOST
            ENDIF
          ELSE
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXFULLN
.
            MOVE      LXFULLN,LXKNNAME
            MOVE      PADD1,LXNKADD1
            MOVE      PADD2,LXNKADD2
            MOVE      PSUBRB,LXNKADD3
            MOVE      PADD4,LXNKADD4
            MOVE      PPOST,LXNKPOST
          ENDIF
.
            CALL       CLGP0000             * Clear Gp details
            PACK       KEY10,PMPXRHC1,SP70
            CALL       RDPMHCP1
            BRANCH     OVRCD,SET0350
            MOVE       PMHCSNAM,LXGPSNAM
            MOVE       PMHCGNAM,LXGPGNAM
            MOVE       PMHCADR1,LXGPADD1
            MOVE       PMHCADR2,LXGPADD2
            MOVE       PMHCADR3,LXGPADD3
            MOVE       PMHCADR4,LXGPADD4
            MOVE       PMHCFAXN,LXRGFAXN
            MOVE       PMHCPOST,LXGPPOST
.
SET0350     PACK       KEY10,PMVXRHC1,SP70
            CALL       RDPMHCP1
            BRANCH     OVRCD,SET0356
            MOVE       PMHCSNAM,LXRGPSNM
            MOVE       PMHCGNAM,LXRGPGNM
            MOVE       PMHCHAD1,LXRGPAD1
            MOVE       PMHCHAD2,LXRGPAD2
            MOVE       PMHCHAD3,LXRGPAD3
            MOVE       PMHCHAD4,LXRGPAD4
            MOVE       PMHCFAXN,LXRGFAXN
            MOVE       PMHCHPCD,LXRGPPST
.
. get the Registered GP Practice address
.
SET0353   PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0356
          MOVE      SP70,RGPRSURG
          MOVE      PMHCADR1,RGPRSAD1
          MOVE      PMHCADR2,RGPRSAD2
          MOVE      PMHCADR3,RGPRSAD3
          MOVE      PMHCADR4,RGPRSAD4
          MOVE      PMHCFAXN,RGPRFAXN
          MOVE      SP70,RGPRSPCD
          MOVE      PMHCSTEL,RGPRTELE
.
. get the Referring GP Practice address
.
SET0356   PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0360
          MOVE      SP70,RFPRSURG
          MOVE      PMHCADR1,RFPRSAD1
          MOVE      PMHCADR2,RFPRSAD2
          MOVE      PMHCADR3,RFPRSAD3
          MOVE      PMHCADR4,RFPRSAD4
          MOVE      PMHCFAXN,RFPRFAXN
          MOVE      SP70,RFPRSPCD
          MOVE      PMHCSTEL,RFPRTELE
.
SET0360   MOVE      PTMSFHAN,LXGPFH               * GPFH Approval Number
          MOVE      PTMSECRA,LXECR                * ECR Approval Number
.
.>>>>     LXLSTINV - Get last invoice for the visit
.         
          PACK      KEY16,AADMNO,Z70
          CALL      RDSINV3                 * position after last record
          CALL      RDPINV3                 * read previous record
          BRANCH    OVRCD,SET0375           * end of file
.         
          MATCH     AADMNO,PINVADM          * same visit # ?
          GOTO      SET0375 IF NOT EQUAL    * no
.
          MOVE      PINVNO,LXLSTINV         * last invoice no.
.         
.         LXBPAYRN - Get BPAY Customer Reference Number
.
          MOVE      PINVNO,BPAYINVN         * use last invno for BPAY CRN
.
          IF        IBCNMHOS=1
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,BPAYHOSP
            ENDIF
          ENDIF
.
          CALL      GBCRN000                * BPAY CRN for last invoice
          MOVE      BPAYREFN,LXBPAYRN
.
. -----   LXADMN  Admission Number   -----
.
SET0375   PACK      LXADMN,AADMNO,SP10
.>>>>     PACK      LXADMN,SP2,AADMNO
.
. -----   LXATYPE  Admission Type   -----
.
          MATCH     SP3,ATYPE
          GOTO      SET0400 IF EQUAL
.
          PACK      KEY5,CODEA,ATYPE
          CALL      RDCODE1
          BRANCH    OVRCD,SET0400
.
          MOVE      TDESC,LXATYPE
.
. -----   Admission User Defineds   -----
.
SET0400   MATCH     SP3,AUSR1
          GOTO      SET0500 IF EQUAL
.
          PACK      KEY5,CODEU1,AUSR1
          CALL      RDCODE1
          BRANCH    OVRCD,SET0500
.
          MOVE      TDESC,LXAUSRA
.
SET0500   MATCH     SP3,AUSR2
          GOTO      SET0600 IF EQUAL
.
          PACK      KEY5,CODEU2,AUSR2
          CALL      RDCODE1
          BRANCH    OVRCD,SET0600
.
          MOVE      TDESC,LXAUSRB
.
SET0600   MATCH     SP3,AUSR3
          GOTO      SET0700 IF EQUAL
.
          PACK      KEY5,CODEU3,AUSR3
          CALL      RDCODE1
          BRANCH    OVRCD,SET0700
.
          MOVE      TDESC,LXAUSRC
.
SET0700   MATCH     SP3,AUSR4
          GOTO      SET0800 IF EQUAL
.
          PACK      KEY5,CODEU4,AUSR4
          CALL      RDCODE1
          BRANCH    OVRCD,SET0800
.
          MOVE      TDESC,LXAUSRD
.
SET0800   MATCH     SP3,AUSR5
          GOTO      SET0900 IF EQUAL
.
          PACK      KEY5,CODEU5,AUSR5
          CALL      RDCODE1
          BRANCH    OVRCD,SET0900
.
          MOVE      TDESC,LXAUSRE
.
. -----   LXBTELE Patient's Business Telephone Number   -----
.
SET0900   MOVE      PTELEB,LXBTELE
.
. -----   LXCARECL  Patient's Care Class   -----
.
          MATCH     SP3,ACARE
          GOTO      SET1000 IF EQUAL
.
          PACK      KEY5,CODECC,ACARE
          CALL      RDCODE1
          BRANCH    OVRCD,SET1000
.
          MOVE      TDESC,LXCARECL
.
. -----   LXCLMCOD  Patient's Claim Code   ------
.
SET1000   MATCH     SP3,ACLAIM
          GOTO      SET1100 IF EQUAL
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,SET1100
.
          MOVE      TDESC,LXCLMCOD
.
. -----   LXCOFB    Patient's Country of Birth   -----
.
SET1100   MATCH     SP3,PCONT
          GOTO      SET1200 IF EQUAL
.
          PACK      KEY5,CODEC,PCONT
          CALL      RDCODE1
          BRANCH    OVRCD,SET1200
.
          MOVE      TDESC,LXCOFB
. 
. -----   LXCURDAT  Current Date   -----
.
SET1200    UNPACK    CDATE,CDAY,DUMMY,CMON,DUMMY,CCENT,CYEAR
           CMATCH    "0",CDAY
           IF        @EQUAL
             UNPACK    CDAY,DIM1,DIM2
             REP       "0 ",DIM1
             PACK      CDAY,DIM1,DIM2
           ENDIF
           CALL      FDAT0000
           MOVE      DATELINE,LXCURDAT
           LJUSTIFY  LXCURDAT
.          MOVE      CDATE,LXCURDAT
.------   LXCURDTN  Current Date - no extension
.
           UNPACK    DATELINE,DIM2,KEY3,DIM20
           PACK      LXCURDTN,DIM2,SP1,DIM20
           LJUSTIFY  LXCURDTN
.
. -----   LXDDATE  Discharge Date   -----
.
          MOVE      SP8,LXDDATE
          MATCH     SP8,DDATE
          IF        !@EQUAL
            MOVE      "99",CDAY
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CCC,CCENT
            CALL      FDAT0000               * Format Date 99th XXXXXXXX 1999
.            CALL      PACDATE
.            MOVE      CPCDATE,LXDDATE
            MOVE      DATELINE,LXDDATE
          ENDIF
.
. -----   LXDOB  Patient's Date of Birth   -----
.
          MOVE      "99",CDAY
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                  * Format Date XX/XX/XXXX
          MOVE      CPCDATE,LXDOB
.
. -----   LXFRSTI  Patient's First Initial  -----
.
          MOVE      PGNAME,LXFRSTI
.
. -----   LXFULLN  Patient's Full Name   -----
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
.
          MOVE      "1",PACFRMT
          CALL      PACNAME
.
          MOVE      PACFNAME,LXFULLN
.
. -----   LXGIVN  Patient's Given Name   -----
.
          MOVE      PGNAME,LXGIVN
          MOVE      PMPXFNAM,LXPGNAM1
          MOVE      PMPXSNAM,LXPGNAM2
.
. -----   LXHFMEM  Patient's Health Fund Membership Number   -----
.
          MOVE      AFNDMM,LXHFMEM
.
. -----   LXHFTAB  Patient's Health Fund Table   -----
.
          MATCH     SP8,AFNDTB
          IF        !@EQUAL
            MOVE      "Invalid Fund Table",HFNAME
            PACK      KEY14,AFUNDH,AFNDTB,SP10
            CALL      RDFUND1
            MOVE      HFNAME,LXHFTAB
          ENDIF
.
. -----   LXHFUND  Patient's Health Fund   -----
.
          MATCH     SP6,AFUNDH
          IF        !@EQUAL
            MOVE      "Invalid Health Fund",HFNAME
            PACK      KEY14,AFUNDH,ZEROS8,SP10
            CALL      RDFUND1
            MOVE      HFNAME,LXHFUND
          ENDIF
.
. -----   LXLOCDOC  Patient's Local Doctor   -----
.
          MOVE      ADOCTL,LXLOCDOC
.
. -----   LXMEDI  Patient's Medicare Number   -----
.
          MOVE      PMEDI,LXMEDI
.
. -----   Next Of Kin Details   -----
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,LXNOKAA
            MOVE      PMCEADD2,LXNOKAB
            MOVE      PMCEADD3,LXNOKAC
            MOVE      PMCEPOST,LXNOKPC
            MOVE      PMCETELB,LXNOKBT
            MOVE      PMCETELP,LXNOKPT
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXNOKNM
          ELSE
            MATCH     SP10,PNKADD1
            GOTO      SET1250 IF EQUAL
.
            MOVE      PNKADD1,LXNOKAA
            MOVE      PNKADD2,LXNOKAB
            MOVE      PNKSUBR,LXNOKAC
            MOVE      PNKPOST,LXNOKPC
            MOVE      PNKTELB,LXNOKBT
            MOVE      PNKTELP,LXNOKPT
            MOVE      PNKNAME,LXNOKNM
          ENDIF
.
. -----   LXPOST  Patient's Home Post Code   -----
.
SET1250   MOVE      PPOST,LXPOST
.
. -----   LXPTELE  Patient's Home Telephone Number   -----
.
          MOVE      PTELEP,LXPTELE
.
. -----   Master File User Defineds   -----
.
          MATCH     SP3,PUSR1
          GOTO      SET1300 IF EQUAL
.
          PACK      KEY5,CODEP1,PUSR1
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PUSR1,LXPUSRAC
          MOVE      TDESC,LXPUSRA
          MOVE      PTCDLDES,LXPUSRAL
.
SET1300   MATCH     SP3,PUSR2
          GOTO      SET1310 IF EQUAL
.
          PACK      KEY5,CODEP2,PUSR2
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PUSR2,LXPUSRBC
          MOVE      TDESC,LXPUSRB
          MOVE      PTCDLDES,LXPUSRBL
.
SET1310   MATCH     SP3,PUSR3
          GOTO      SET1320 IF EQUAL
.
          PACK      KEY5,CODEP3,PUSR3
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PUSR3,LXPUSRCC
          MOVE      TDESC,LXPUSRC
          MOVE      PTCDLDES,LXPUSRCL
.
SET1320   MATCH     SP3,PUSR4
          GOTO      SET1330 IF EQUAL
.
          PACK      KEY5,ANSP,FOUR,PUSR4,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PUSR4,LXPUSRDC
          MOVE      TDESC,LXPUSRDD
          MOVE      PTCDLDES,LXPUSRDL
.
SET1330   MATCH     SP3,PUSR5
          GOTO      SET1340 IF EQUAL
.
          PACK      KEY5,ANSP,FIVE,PUSR5,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PUSR5,LXPUSREC
          MOVE      TDESC,LXPUSRED
          MOVE      PTCDLDES,LXPUSREL
.
SET1340   MATCH     SP3,PUSR6
          GOTO      SET1500 IF EQUAL
.
          PACK      KEY5,ANSP,SIX,PUSR6,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      SP70,TDESC
            MOVE      SP70,PTCDLDES
          ENDIF
.
          MOVE      PUSR6,LXPUSRFC
          MOVE      TDESC,LXPUSRFD
          MOVE      PTCDLDES,LXPUSRFL
.
. -----   LXRDCFUL  Referring Doctor's Details   -----
.
SET1500   IF        CRDRTYP = ONE
            MOVE      ADOCTR,LXRDCFUL
          ELSE
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1
            IF        OVRCD = ZERO
              MOVE      DSNAME,PACSNAME
              MOVE      DGNAME,PACGNAME
              MOVE      DTITL,PACTITLE
              MOVE      "1",PACFRMT
              CALL      PACNAME
              MOVE      PACFNAME,LXRDCFUL
              MOVE      DSNAME,LXRDCSUR
              MOVE      DGNAME,LXRDCGIV
              MOVE      DGNAME,LXRDCINI
              MOVE      DTITL,LXRDCTTL
            ENDIF
          ENDIF
.
. -----   LXREFERL  Source of Referral   -----
.
          MATCH     SP3,ASRCE
          GOTO      SET1600 IF EQUAL
.
          PACK      KEY5,CODES,ASRCE
          CALL      RDCODE1
          BRANCH    OVRCD,SET1600
.
          MOVE      TDESC,LXREFERL
.
. -----   LXRELIG  Patient's Religion   -----
.
SET1600   MATCH     SP3,PREG
          GOTO      SET1700 IF EQUAL
.
          PACK      KEY5,CODER,PREG
          CALL      RDCODE1
          BRANCH    OVRCD,SET1700
.
          MOVE      TDESC,LXRELIG
.
. -----   LXSURN  Patient's Surname   -----
.
SET1700   MOVE      PSNAME,LXSURN
.
. -----   LXTDCFUL  Treating Doctor's Full Name   -----
.
          PACK      KEY6,ADOCTT
          CALL      RDDOCT1
          BRANCH    OVRCD,SET1800
.
          MOVE      DSNAME,PACSNAME
          MOVE      DGNAME,PACGNAME
          MOVE      DTITL,PACTITLE
.
          MOVE      "1",PACFRMT
          CALL      PACNAME
.
          MOVE      PACFNAME,LXTDCFUL
.
. -----   Treating Doctor's Details   -----
.
          MOVE      DSNAME,LXTDCSUR
          MOVE      DGNAME,LXTDCGIV
          MOVE      DGNAME,LXTDCINI
          MOVE      DTITL,LXTDCTTL
.
. -----   LXTITLE  Patient's Title   -----
.
SET1800   MOVE      PTITL,LXTITLE
.
. -----   NO,PURN Patient's U/R Number   -----
.
          PACK      LXURNO,PURNO,SP10
...          PACK      LXURNO,SP2,PURNO
.
.
.         Get IHI Number
.
          MATCH     "1",PTCNUNET
          IF        @EQUAL
            CALL      GTIHINUM
            MOVE      IHINUMBR,LXIHINUM
          ELSE
            MATCH     "3",PTCNUNET
            IF        @EQUAL
              CALL      GTIHINUM                   * IHI Number
              LJUSTIFY  IHINUMBR
              UNPACK    IHINUMBR,DIM4,DIM4A,DIM4B,DIM4C
              PACK      LXIHINUM,DIM4,SP1,DIM4A,SP1,DIM4B,SP1,DIM4C
            ENDIF
          ENDIF
.
. -----   Case Conversion Section   -----
.
          MOVE      LXADCFUL,LINE
          CALL      CASE0000
          MOVE      LINE,LXADCFUL
.
          MOVE      LXADCGIV,LINE
          CALL      CASE0000
          MOVE      LINE,LXADCGIV
.
          MOVE      LXADCSUR,LINE
          CALL      CASE0000
          MOVE      LINE,LXADCSUR
.
          MOVE      LXADCTTL,LINE
          CALL      CASE0000
          MOVE      LINE,LXADCTTL
.
          MOVE      LXADDA,LINE
          CALL      CASE0000
          MOVE      LINE,LXADDA
.
          MOVE      LXADDB,LINE
          CALL      CASE0000
          MOVE      LINE,LXADDB
.
          MOVE      LXADDC,LINE
          CALL      CASE0000
          MOVE      LINE,LXADDC
.
          MOVE      LXFULLN,LINE
          CALL      CASE0000
          MOVE      LINE,LXFULLN
.
          MOVE      LXGIVN,LINE
          CALL      CASE0000
          MOVE      LINE,LXGIVN
.
          MOVE      LXPGNAM1,LINE
          CALL      CASE0000
          MOVE      LINE,LXPGNAM1
.
          MOVE      LXPGNAM2,LINE
          CALL      CASE0000
          MOVE      LINE,LXPGNAM2
.
          MOVE      LXHADDA,LINE
          CALL      CASE0000
          MOVE      LINE,LXHADDA
.
          MOVE      LXHADDB,LINE
          CALL      CASE0000
          MOVE      LINE,LXHADDB
.
          MOVE      LXHOSP,LINE
          CALL      CASE0000
          MOVE      LINE,LXHOSP
.
          MOVE      LXLOCDOC,LINE
          CALL      CASE0000
          MOVE      LINE,LXLOCDOC
.
          MOVE      LXNOKAA,LINE
          CALL      CASE0000
          MOVE      LINE,LXNOKAA
.
          MOVE      LXNOKAB,LINE
          CALL      CASE0000
          MOVE      LINE,LXNOKAB
.
          MOVE      LXNOKAC,LINE
          CALL      CASE0000
          MOVE      LINE,LXNOKAC
.
          MOVE      LXNOKNM,LINE
          CALL      CASE0000
          MOVE      LINE,LXNOKNM
.
          MOVE      LXRDCFUL,LINE
          CALL      CASE0000
          MOVE      LINE,LXRDCFUL
.
          MOVE      LXRDCGIV,LINE
          CALL      CASE0000
          MOVE      LINE,LXRDCGIV
.
          MOVE      LXRDCSUR,LINE
          CALL      CASE0000
          MOVE      LINE,LXRDCSUR
.
          MOVE      LXRDCTTL,LINE
          CALL      CASE0000
          MOVE      LINE,LXRDCTTL
.
          MOVE      LXSURN,LINE
          CALL      CASE0000
          MOVE      LINE,LXSURN
.
          MOVE      LXTDCFUL,LINE
          CALL      CASE0000
          MOVE      LINE,LXTDCFUL
.
          MOVE      LXTDCGIV,LINE
          CALL      CASE0000
          MOVE      LINE,LXTDCGIV
.
          MOVE      LXTDCSUR,LINE
          CALL      CASE0000
          MOVE      LINE,LXTDCSUR
.
          MOVE      LXTDCTTL,LINE
          CALL      CASE0000
          MOVE      LINE,LXTDCTTL
.
          MOVE      LXTITLE,LINE
          CALL      CASE0000
          MOVE      LINE,LXTITLE
.
          MOVE      LXHSPNAM,LINE
.         CALL      CASE0000
          MOVE      LINE,LXHSPNAM
.
          MOVE      LXHSPAD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXHSPAD1
.
          MOVE      LXHSPAD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXHSPAD2
.
          MOVE      LXHSPAD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXHSPAD3
.
          MOVE      LXHSPAD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXHSPAD4
.
          MOVE      LXHSPOST,LINE
          CALL      CASE0000
          MOVE      LINE,LXHSPOST
.
          MOVE      RGPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSURG
.
          MOVE      RGPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD1
.
          MOVE      RGPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD2
.
          MOVE      RGPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD3
.
          MOVE      RGPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD4
.
          MOVE      RGPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRTELE
.
          MOVE      RGPRFAXN,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRFAXN
.
          MOVE      RFPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSURG
.
          MOVE      RFPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD1
.
          MOVE      RFPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD2
.
          MOVE      RFPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD3
.
          MOVE      RFPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD4
.
          MOVE      RFPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRTELE
.
          MOVE      LXGPSNAM,LINE
          CALL      CASE0000
          MOVE      LINE,LXGPSNAM
.
          MOVE      LXGPGNAM,LINE
          CALL      CASE0000
          MOVE      LINE,LXGPGNAM
.
          MOVE      LXGPADD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXGPADD1
.
          MOVE      LXGPADD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXGPADD2
.
          MOVE      LXGPADD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXGPADD3
.
          MOVE      LXGPADD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXGPADD4
.
          MOVE      LXRGPSNM,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPSNM
.
          MOVE      LXRGPGNM,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPGNM
.
          MOVE      LXRGPAD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPAD1
.
          MOVE      LXRGPAD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPAD2
.
          MOVE      LXRGPAD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPAD3
.
          MOVE      LXRGPAD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXRGPAD4
.
          MOVE      LXKNNAME,LINE
          CALL      CASE0000
          MOVE      LINE,LXKNNAME
.
          MOVE      LXNKADD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXNKADD1
.
          MOVE      LXNKADD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXNKADD2
.
          MOVE      LXNKADD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXNKADD3
.
          MOVE      LXNKADD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXNKADD4
.
          MOVE      LXNKPOST,LINE
          CALL      CASE0000
          MOVE      LINE,LXNKPOST
.
          MOVE      PTMXCELL,LINE              * load cellular phone number
          CALL      CASE0000
          MOVE      LINE,LXCELL
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,LINE            * load postal address line 1
            CALL      CASE0000
            MOVE      LINE,LXPADDA
            MOVE      PMCEADD2,LINE            * load postal address line 2
            CALL      CASE0000
            MOVE      LINE,LXPADDB
            MOVE      PMCEADD3,LINE            * load postal address line 3
            CALL      CASE0000
            MOVE      LINE,LXPADDC
            MOVE      PMCEADD4,LINE            * load postal address line 4
            CALL      CASE0000
            MOVE      LINE,LXPADDD
            MOVE      PMCEPOST,LINE            * load postal Post Code
            CALL      CASE0000
            MOVE      LINE,LXPPOST
          ELSE
            MOVE      PTMXADD1,LINE            * load postal address line 1
            CALL      CASE0000
            MOVE      LINE,LXPADDA
            MOVE      PTMXADD2,LINE            * load postal address line 2
            CALL      CASE0000
            MOVE      LINE,LXPADDB
            MOVE      PTMXADD3,LINE            * load postal address line 3
            CALL      CASE0000
            MOVE      LINE,LXPADDC
            MOVE      PTMXADD4,LINE            * load postal address line 4
            CALL      CASE0000
            MOVE      LINE,LXPADDD
            MOVE      PTMXPOST,LINE            * load postal Post Code     
            CALL      CASE0000
            MOVE      LINE,LXPPOST
          ENDIF
.
          MOVE      LXPXMSNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMSNA
.
          MOVE      LXPXMGNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMGNA
.
          MOVE      LXPXMTLE,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMTLE
.
          MOVE      LXPXMAD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD1
.
          MOVE      LXPXMAD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD1
.
          MOVE      LXPXMAD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD3
.
          MOVE      LXPXMAD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMAD4
.
          MOVE      LXPXMCNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMCNT
.
          MOVE      LXPXFSNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFSNA
.
          MOVE      LXPXMREL,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXMREL
.
          MOVE      LXPXFGNA,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFGNA
.
          MOVE      LXPXFTLE,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFTLE
.
          MOVE      LXPXFAD1,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD1
.
          MOVE      LXPXFAD2,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD2
.
          MOVE      LXPXFAD3,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD3
.
          MOVE      LXPXFAD4,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFAD4
.
          MOVE      LXPXFCNT,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFCNT
.
          MOVE      LXPXFREL,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXFREL
.
          MOVE      LXVXABRG,LINE 
          CALL      CASE0000
          MOVE      LINE,LXVXABRG
.
          MOVE      LXVXCADM,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXCADM
.
          MOVE      LXVXIRAD,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXIRAD
.
          MOVE      LXVXIDUS,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXIDUS
.
          MOVE      LXVXCRAV,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXCRAV
.
          MOVE      LXVXRCCT,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXRCCT
.
          MOVE      LXVXAPWD,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXAPWD
.
          MOVE      LXVXAPBD,LINE
          CALL      CASE0000
          MOVE      LINE,LXVXAPBD
.
          MOVE      LXPXDVAC,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXDVAC
.
          MOVE      LXPXABRG,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXABRG
.
          MOVE      LXPXPRVI,LINE
          CALL      CASE0000
          MOVE      LINE,LXPXPRVI
.
          CALL      GSMSID00                 * Get SMS message id
          MOVE      IBSQNEXT,LXXSMSID        * SMS message id
.
SET2000   PACK      LXXSMSKY,SP1,THREE,AADMNO,SP70 * SMS message key
          MOVE      LETTFORM,LXSMSCOD        * SMS Code (Letter Number)
          MOVE      PTMXCELL,LXXSMSPH        * SMS Phone Number
          STRIP     LXXSMSPH
          MOVE      PURNO,LXXSMSUR           * SMS U/R
          MOVE      SP70,LXXSMSUS            * SMS User
          MOVE      SP70,LXXSMSUN            * SMS User name
          PACK      KEY14,PASSCODE,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD<>1
           MATCH      PASSCODE,WBSEPCD
           IF         @EQUAL
             MOVE      WBSEUID,LXXSMSUS      * SMS User
             MOVE      WBSENAM,LXXSMSUN      * SMS User Name
           ENDIF
          ENDIF
.
          MOVE      "N/A",LXFOODDT           * Fasting date food
          MOVE      "N/A",LXFOODTM           * Fasting time food
          MOVE      "N/A",LXFLUIDD           * Fasting date fluid
          MOVE      "N/A",LXFLUIDT           * Fasting time fluid
.
          MOVE      SP8,LXLVDATE
          MATCH     SP70,PMLRDATE            * Date on leave
          IF        !@EQUAL
            MOVE      "99",CDAY
            UNPACK    PMLRDATE,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE                  * Format Date XX/XX/XXXX
            MOVE      CPCDATE,LXLVDATE
          ENDIF
.
          MOVE      SP8,LXLVTIME
          MATCH     SP70,PMLRTIME            * Time on leave
          IF        !@EQUAL
            MOVE      PMLRTIME,LXLVTIME
          ENDIF
.
          MOVE      SP8,LXLVEXRD
          MATCH     SP70,PMLREXRD            * Expected leave return date
          IF        !@EQUAL
            MOVE      "99",CDAY
            UNPACK    PMLREXRD,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE                  * Format Date XX/XX/XXXX
            MOVE      CPCDATE,LXLVEXRD
          ENDIF
.
          MOVE      SP8,LXLVEXRT
          MATCH     SP70,PMLREXRT            * Expected leave return time
          IF        !@EQUAL
            MOVE      PMLREXRT,LXLVEXRT
          ENDIF
.
          MOVE      SP70,LXLVLTYP
          MATCH     SP70,PMLRTLEV            * Type of leave
          IF        !@EQUAL
            PACK      KEY5,ANST,ANSL,PMLRTLEV,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,LXLVLTYP
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWARDCD           * Last ward code
          MOVE      SP70,LXWARDSN           * Last ward short name    
          MOVE      SP70,LXWARDLN           * Last ward long name
          MOVE      SP70,LXBEDDCD           * Last bed code
          MOVE      SP70,LXBEDDSN           * Last bed short name
          MOVE      SP70,LXBEDDLN           * Last bed long name
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2                * Read last tran record 
          BRANCH    OVRCD,SET3000           * to get ward/bed
.
          MATCH     TADMN,AADMNO
          GOTO      SET3000 IF NOT EQUAL
.
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1                 * Read ward record
          BRANCH    OVRCD,SET3000
.
          MOVE      TWARD,LXWARDCD          
          MOVE      PTWDSDES,LXWARDSN
          MOVE      WBDESC,LXWARDLN
.
          PACK      KEY6,TWARD,TBED,SP70
          CALL      RDWARD1                 * Read ward/bed record
          BRANCH    OVRCD,SET3000
.
          MOVE      TBED,LXBEDDCD
          MOVE      PTWDSDES,LXBEDDSN
          MOVE      WBDESC,LXBEDDLN
.
SET3000   PACK      KEY31,AADMNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2                 * Find first theatre case
          BRANCH    OVRCD,SET9500            * for this visit number
.
          MOVE      AADMNO,KEY8
          MATCH     KEY8,OPDAADMN
          GOTO      SET9500 IF NOT EQUAL
.
          UNPACK    OPDADTFF,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,LXFOODDT         * Fasting date food
          MOVE      OPDAFAST,LXFOODTM        * Fasting time food
.
          UNPACK    OPDADTFL,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,LXFLUIDD         * Fasting date fluid
          MOVE      OPDAPRE5,LXFLUIDT        * Fasting time fluid
.
          GOTO      SET9500
.
SET9000   DISPLAY   *P1:24,*EL,*B,"Admission File Record Missing - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
          GOTO      SET9400
.
SET9100   MOVE      ONE,DSCHFLAG
          GOTO      SET1000
.
SET9200   DISPLAY   *P1:24,*EL,*B,"Master File Record Missing - Hit <":
                               *V2LON,"ENTER",*HOFF,"> to Continue ";
          KEYIN     *EOFF,ANS;
          DISPLAY   *P1:24,*EL;
          GOTO      SET9400
.
SET9400   MOVE      TRUE,EXIT
          GOTO      SET9999
.
SET9500   MOVE      FALSE,EXIT
.
SET9999   RETURN
+
.******************************************************************************
.*                            CASE0000                                        *
.*        Routine to convert all except first character of each word to       *
.*        lower case.                                                         *
.******************************************************************************
CASE0000  MOVE      ONE,FIRSTCH
          RESET     LINE
.
CASE1000  CMATCH    SP1,LINE
          GOTO      CASE5000 IF EQUAL            * match char to space
          BRANCH    FIRSTCH,CASE2000
          MOVE      LINE,ANS
          RESET     UPPLOW
          SCAN      ANS,UPPLOW                   * test to see if char is
          GOTO      CASE1100 IF EQUAL            *   a letter
          MOVE      ONE,FIRSTCH
          GOTO      CASE3000                     * any char but a letter
          *         found
.
CASE1100  OR        040,LINE                     * actual conversion to
          RESET     UPPLOW
          *         lower case (believe it
          *         or not!)
.
CASE2000  MOVE      ZERO,FIRSTCH                 * not on first char any
.                                                   *   more
CASE3000  BUMP      LINE
          GOTO      CASE1000 IF NOT EOS          * move to next char
          RESET     LINE                         * end of line reached
          GOTO      CASE9999
.
CASE5000  MOVE      ONE,FIRSTCH                  * first char was a space
          GOTO      CASE3000
.
CASE9999  RETURN
+
.******************************************************************************
.*                            CLGP0000                                        *
.*                  Clear GP Details                                          *
.******************************************************************************
CLGP0000  MOVE      SP40,LXGPSNAM  
          MOVE      SP40,LXGPGNAM 
          MOVE      SP40,LXGPADD1
          MOVE      SP40,LXGPADD2 
          MOVE      SP40,LXGPADD3 
          MOVE      SP40,LXGPADD4  
          MOVE      SP40,LXGPPOST  
          MOVE      SP40,LXRGPSNM  
          MOVE      SP40,LXRGPGNM  
          MOVE      SP40,LXRGPAD1 
          MOVE      SP40,LXRGPAD2 
          MOVE      SP40,LXRGPAD3 
          MOVE      SP40,LXRGPAD4 
          MOVE      SP40,LXRGPPST 
.
. Registered GP Practice address
.
          MOVE      SP40,RGPRSURG  
          MOVE      SP40,RGPRSAD1  
          MOVE      SP40,RGPRSAD2 
          MOVE      SP40,RGPRSAD3 
          MOVE      SP40,RGPRSAD4 
          MOVE      SP40,RGPRFAXN 
          MOVE      SP40,RGPRSPCD 
          MOVE      SP40,RGPRTELE 
.
. Referring GP Practice address
.
          MOVE      SP40,RFPRSURG  
          MOVE      SP40,RFPRSAD1  
          MOVE      SP40,RFPRSAD2 
          MOVE      SP40,RFPRSAD3 
          MOVE      SP40,RFPRSAD4 
          MOVE      SP40,RFPRFAXN 
          MOVE      SP40,RFPRTELE 
          MOVE      SP40,RFPRSPCD 
          MOVE      SP40,RFPRTELE 
.
CLGP9999  RETURN
+
.******************************************************************************
.*                            SHSP0000                                        *
.*                  Set up hospital details for multi hospital                *
.******************************************************************************
SHSP0000  BRANCH    ASTAT,SHSP0050          * Pre-admission?
.
          COMPARE   THREE,ASTAT
          GOTO      SHSP2000 IF NOT EQUAL
          GOTO      SHSP1000
.
.-------  Use PMVXMHOS to get multi hospital details -------
.
SHSP0050  MOVE      PMVXMHOS,PTWDHOSN
          GOTO      SHSP9000
.
.-------  Use the discharge ward to get multi hospital details -------
.
SHSP1000  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,SHSP2000
.
          MATCH     TADMN,AADMNO
          GOTO      SHSP2000 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE
          GOTO      SHSP2000 IF NOT EQUAL
.
          GOTO      SHSP5000                
.
.-------  Use the Admission ward to get multi hospital details -------
.
SHSP2000  PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,SHSP9999
.
          MATCH     TADMN,AADMNO
          GOTO      SHSP9999 IF NOT EQUAL
.
          MATCH     ANSA,TMOVE
          GOTO      SHSP9999 IF NOT EQUAL
.
.-------  Use the ward to get hospital details  --------
.
SHSP5000  PACK      KEY6,TWARD,SP10
          CALL      RDWARD1
          BRANCH    OVRCD,SHSP9999
.
SHSP9000  PACK      KEY3,PTWDHOSN
          CALL      RDPTHSP1
          BRANCH    OVRCD,SHSP9999
.
          MOVE      PTHSNAME,LXHSPNAM
          MOVE      PTHSADD1,LXHSPAD1
          MOVE      PTHSADD2,LXHSPAD2
          MOVE      PTHSADD3,LXHSPAD3
          MOVE      PTHSADD4,LXHSPAD4
          MOVE      PTHSPCOD,LXHSPOST
          MOVE      PTHSTELE,LXHSPHON
.
SHSP9999  RETURN
+
.******************************************************************************
.*                            FILSTR00                                        *
.*                  Fill the Var's with '*'                                   *
.******************************************************************************
FILSTR00  MOVE      "********************",LXACLASS
.         MOVE      "**/**/****",LXADATE
          MOVE      "99TH ********* 1999",LXADATE
          MOVE      "99TH *** 1999",LXADATEX
          MOVE      "**/**/****",LXADATEN
          PACK      LXADCFUL,STAR56
          MOVE      "*************************",LXADCGIV
          MOVE      "*",LXADCINI
          MOVE      "********************",LXADCSUR
          MOVE      "*********",LXADCTTL
          MOVE      "*************************",LXADDA
          MOVE      "*************************",LXADDB
          MOVE      "********************",LXADDC
          MOVE      "********",LXADMN
          MOVE      "********************",LXATYPE
          MOVE      "********************",LXAUSRA
          MOVE      "********************",LXAUSRB
          MOVE      "********************",LXAUSRC
          MOVE      "********************",LXAUSRD
          MOVE      "********************",LXAUSRE
          MOVE      "************",LXBTELE
          MOVE      "********************",LXCARECL
          MOVE      "********************",LXCLMCOD
          MOVE      "********************",LXCOFB
          MOVE      "99TH ********* 1999",LXCURDAT
          MOVE      "99TH ********* 1999",LXDDATE
          MOVE      "**/**/****",LXDOB
          MOVE      "*",LXFRSTI
          PACK      LXFULLN,STAR51
          MOVE      "*************************",LXGIVN
          MOVE      "*******************",LXHFMEM
          MOVE      "********************",LXHFTAB
          MOVE      "********************",LXHFUND
          PACK      LXLOCDOC,STAR56
          MOVE      "**********",LXMEDI
          MOVE      "*************************",LXNOKAA
          MOVE      "*************************",LXNOKAB
          MOVE      "***************",LXNOKAC
          MOVE      "************",LXNOKBT
          MOVE      "********************",LXNOKNM
          MOVE      "****",LXNOKPC
          MOVE      "************",LXNOKPT
          MOVE      "****",LXPOST
          MOVE      "************",LXPTELE
          MOVE      "********************",LXPUSRA
          MOVE      "********************",LXPUSRB
          MOVE      "********************",LXPUSRC
          PACK      LXRDCFUL,STAR56
          MOVE      "*************************",LXRDCGIV
          MOVE      "*",LXRDCINI
          MOVE      "********************",LXRDCSUR
          MOVE      "*********",LXRDCTTL
          MOVE      "********************",LXREFERL
          MOVE      "********************",LXRELIG
          MOVE      "*************************",LXSURN
          PACK      LXTDCFUL,STAR56
          MOVE      "*************************",LXTDCGIV
          MOVE      "*",LXTDCINI
          MOVE      "********************",LXTDCSUR
          MOVE      "*********",LXTDCTTL
          MOVE      "****",LXTITLE
          MOVE      "********",LXURNO
       MOVE      "****************************************************",LXKNNAME
          MOVE      "***********************************",LXNKADD1  
          MOVE      "***********************************",LXNKADD2  
          MOVE      "***********************************",LXNKADD3  
          MOVE      "***********************************",LXNKADD4  
          MOVE      "********",LXNKPOST  
          MOVE      "********************",LXGPSNAM
          MOVE      "********************",LXGPGNAM
          MOVE      "***********************************",LXGPADD1
          MOVE      "***********************************",LXGPADD2      
          MOVE      "***********************************",LXGPADD3      
          MOVE      "***********************************",LXGPADD4      
          MOVE      "***********************************",LXGPPOST
          MOVE      "********************",LXRGPSNM
          MOVE      "********************",LXRGPGNM    
          MOVE      "***********************************",LXRGPAD1   
          MOVE      "***********************************",LXRGPAD2      
          MOVE      "***********************************",LXRGPAD3      
          MOVE      "***********************************",LXRGPAD4      
          MOVE      "********",LXRGPPST   
          MOVE      "********************",LXGPFH
          MOVE      "********************",LXECR
.
          MOVE      "**************************************************",LXHSPNAM 
          MOVE      "***********************************",LXHSPAD1 
          MOVE      "***********************************",LXHSPAD2 
          MOVE      "***********************************",LXHSPAD3 
          MOVE      "***********************************",LXHSPAD4 
          MOVE      "********",LXHSPOST  
          MOVE      "*********************",LXHSPHON 
          MOVE      "********************",LXCELL
          MOVE      "***********************************",LXPADDA
          MOVE      "***********************************",LXPADDB
          MOVE      "***********************************",LXPADDC
          MOVE      "***********************************",LXPADDD
          MOVE      "********",LXPPOST
.
          MOVE      "********************",LXPXMSNA 
          MOVE      "************************",LXPXMGNA 
          MOVE      "****",LXPXMTLE 
          MOVE      "***********************************",LXPXMAD1 
          MOVE      "***********************************",LXPXMAD2 
          MOVE      "***********************************",LXPXMAD3 
          MOVE      "***********************************",LXPXMAD4 
          MOVE      "********",LXPXMPOS 
          MOVE      "********************",LXPXMPNO 
          MOVE      "********************",LXPXMBNO 
          MOVE      "********************",LXPXMMNO 
          MOVE      "*******************************************************************************",LXPXMEML 
          MOVE      "********************",LXPXMCNT 
          MOVE      "***",LXPXMCRP 
          MOVE      "***",LXPXMLAB 
          MOVE      "**********",LXPXMREL 
          MOVE      "********************",LXPXFSNA 
          MOVE      "*************************",LXPXFGNA 
          MOVE      "****",LXPXFTLE 
          MOVE      "***********************************",LXPXFAD1 
          MOVE      "***********************************",LXPXFAD2 
          MOVE      "***********************************",LXPXFAD3 
          MOVE      "***********************************",LXPXFAD4 
          MOVE      "********",LXPXFPOS 
          MOVE      "********************",LXPXFPNO 
          MOVE      "********************",LXPXFBNO 
          MOVE      "********************",LXPXFMNO 
          MOVE      "*******************************************************************************",LXPXFEML 
          MOVE      "********************",LXPXFCNT 
          MOVE      "***",LXPXFCRP 
          MOVE      "***",LXPXFLAB 
          MOVE      "**********",LXPXFREL 
          MOVE      "********************",LXPXDVAC 
          MOVE      "********************",LXPXABRG 
          MOVE      "********************",LXPXPRVI 
          MOVE      "********************",LXVXABRG 
          MOVE      "********************",LXVXCADM 
          MOVE      "********************",LXVXIRAD 
          MOVE      "********************",LXVXIDUS 
          MOVE      "********************",LXVXCRAV 
          MOVE      "********************",LXVXRCCT 
          MOVE      "********************",LXVXAPWD 
          MOVE      "********************",LXVXAPBD 
          MOVE      "********************",LXRGFAXN 
          MOVE      "********************",LXRFFAXN 
          MOVE      "***************",LXBPAYRN
          MOVE      "********",LXLSTINV
          MOVE      "********************",LXIHINUM
          MOVE      "**********",LXVXCASC
          MOVE      "****************************************",LXVXCASD
          MOVE      "****************",LXXSMSID
          MOVE      "******************************",LXXSMSKY
          MOVE      "***",LXSMSCOD
          MOVE      "********************",LXXSMSPH
          MOVE      "********",LXXSMSUR
          MOVE      "**********",LXXSMSUS
          MOVE      "******************************",LXXSMSUN
          MOVE      "***************",LXELTOOP
          MOVE      "*****",LXATIME
          MOVE      "*********",LXADAY
          MOVE      "***",LXADAYS
          MOVE      "********",LXATIMEM
          MOVE      "****************************************",LXPGNAM1
          MOVE      "****************************************",LXPGNAM2
          MOVE      "***",LXPXUCC4
          MOVE      "**************************************************",LXUCC4LD
          MOVE      "********************************************************************************",LXPXATF1
          MOVE      "***",LXPXUCC5
          MOVE      "**************************************************",LXUCC5LD
          MOVE      "********************************************************************************",LXPXATF2
.
          MOVE      "***",LXETHCO1
          MOVE      "**************************************************",LXETHLD1
          MOVE      "***",LXETHCO2
          MOVE      "**************************************************",LXETHLD2
          MOVE      "***",LXMLNCO1
          MOVE      "**************************************************",LXMLNLD1
          MOVE      "***",LXMLNCO2
          MOVE      "**************************************************",LXMLNLD2
          MOVE      "***",LXNKLCO1
          MOVE      "**************************************************",LXNKLLD1
          MOVE      "***",LXNKLCO2
          MOVE      "**************************************************",LXNKLLD2
          MOVE      "*",LXPXSN18
          MOVE      "*",LXPXSN19
          MOVE      "*",LXPXSN20
          MOVE      "*",LXPXSN21
          MOVE      "*",LXPXSN22
          MOVE      "*",LXPXSN23
          MOVE      "*",LXPXSN24
          MOVE      "*",LXPXSN25
          MOVE      "*",LXPXSN26
          MOVE      "*",LXPXSN27
          MOVE      "*",LXPXSN28
          MOVE      "*",LXPXSN29
          MOVE      "*",LXPXSN30
.
          MOVE      "***",LXPUSRAC
          MOVE      "**************************************************",LXPUSRAL
          MOVE      "***",LXPUSRBC
          MOVE      "**************************************************",LXPUSRBL
          MOVE      "***",LXPUSRCC
          MOVE      "**************************************************",LXPUSRCL
          MOVE      "***",LXPUSRDC
          MOVE      "********************",LXPUSRDD
          MOVE      "**************************************************",LXPUSRDL
          MOVE      "***",LXPUSREC
          MOVE      "*******************",LXPUSRED
          MOVE      "**************************************************",LXPUSREL
          MOVE      "***",LXPUSRFC
          MOVE      "*******************",LXPUSRFD
          MOVE      "**************************************************",LXPUSRFL
          MOVE      "***",LXPUSRGC
          MOVE      "*******************",LXPUSRGD
          MOVE      "**************************************************",LXPUSRGL
          MOVE      "***",LXPUSRHC
          MOVE      "*******************",LXPUSRHD
          MOVE      "**************************************************",LXPUSRHL
          MOVE      "***",LXPUSRIC
          MOVE      "*******************",LXPUSRID
          MOVE      "**************************************************",LXPUSRIL
.
FILSTR99  RETURN
+
.******************************************************************************
.*                            FILSPA00                                        *
.*                  Fill the Var's with a single space                        *
.******************************************************************************
FILSPA00  MOVE      SP1,LXACLASS
          MOVE      SP1,LXADATE
          MOVE      SP1,LXADATEX
          MOVE      SP1,LXADATEN
          MOVE      SP1,LXADCFUL
          MOVE      SP1,LXADCGIV
          MOVE      SP1,LXADCINI
          MOVE      SP1,LXADCSUR
          MOVE      SP1,LXADCTTL
          MOVE      SP1,LXADDA
          MOVE      SP1,LXADDB
          MOVE      SP1,LXADDC
          MOVE      SP1,LXADMN
          MOVE      SP1,LXATYPE
          MOVE      SP1,LXAUSRA
          MOVE      SP1,LXAUSRB
          MOVE      SP1,LXAUSRC
          MOVE      SP1,LXAUSRD
          MOVE      SP1,LXAUSRE
          MOVE      SP1,LXBTELE
          MOVE      SP1,LXCARECL
          MOVE      SP1,LXCLMCOD
          MOVE      SP1,LXCOFB
          MOVE      SP1,LXCURDAT
          MOVE      SP1,LXDDATE
          MOVE      SP1,LXDOB
          MOVE      SP1,LXFRSTI
          MOVE      SP1,LXFULLN
          MOVE      SP1,LXGIVN
          MOVE      SP1,LXPGNAM1
          MOVE      SP1,LXPGNAM2
          MOVE      SP1,LXHFMEM
          MOVE      SP1,LXHFTAB
          MOVE      SP1,LXHFUND
          MOVE      SP1,LXLOCDOC
          MOVE      SP1,LXMEDI
          MOVE      SP1,LXNOKAA
          MOVE      SP1,LXNOKAB
          MOVE      SP1,LXNOKAC
          MOVE      SP1,LXNOKBT
          MOVE      SP1,LXNOKNM
          MOVE      SP1,LXNOKPC
          MOVE      SP1,LXNOKPT
          MOVE      SP1,LXPOST
          MOVE      SP1,LXPTELE
          MOVE      SP1,LXPUSRA
          MOVE      SP1,LXPUSRB
          MOVE      SP1,LXPUSRC
          MOVE      SP1,LXRDCFUL
          MOVE      SP1,LXRDCGIV
          MOVE      SP1,LXRDCINI
          MOVE      SP1,LXRDCSUR
          MOVE      SP1,LXRDCTTL
          MOVE      SP1,LXREFERL
          MOVE      SP1,LXRELIG
          MOVE      SP1,LXSURN
          MOVE      SP1,LXTDCFUL
          MOVE      SP1,LXTDCGIV
          MOVE      SP1,LXTDCINI
          MOVE      SP1,LXTDCSUR
          MOVE      SP1,LXTDCTTL
          MOVE      SP1,LXTITLE
          MOVE      SP1,LXURNO
          MOVE      SP1,LXKNNAME
          MOVE      SP1,LXNKADD1  
          MOVE      SP1,LXNKADD2  
          MOVE      SP1,LXNKADD3  
          MOVE      SP1,LXNKADD4  
          MOVE      SP1,LXNKPOST  
          MOVE      SP1,LXGPSNAM
          MOVE      SP1,LXGPGNAM
          MOVE      SP1,LXGPADD1
          MOVE      SP1,LXGPADD2      
          MOVE      SP1,LXGPADD3      
          MOVE      SP1,LXGPADD4      
          MOVE      SP1,LXGPPOST
          MOVE      SP1,LXRGPSNM
          MOVE      SP1,LXRGPGNM    
          MOVE      SP1,LXRGPAD1   
          MOVE      SP1,LXRGPAD2      
          MOVE      SP1,LXRGPAD3      
          MOVE      SP1,LXRGPAD4      
          MOVE      SP1,LXRGPPST   
          MOVE      SP1,LXGPFH
          MOVE      SP1,LXECR
.
          MOVE      SP1,LXHSPNAM 
          MOVE      SP1,LXHSPAD1 
          MOVE      SP1,LXHSPAD2 
          MOVE      SP1,LXHSPAD3 
          MOVE      SP1,LXHSPAD4 
          MOVE      SP1,LXHSPOST  
          MOVE      SP1,LXHSPHON 
          MOVE      SP1,LXCELL
          MOVE      SP1,LXPADDA
          MOVE      SP1,LXPADDB
          MOVE      SP1,LXPADDC
          MOVE      SP1,LXPADDD
          MOVE      SP1,LXPPOST
.
          MOVE      SP1,LXPXMSNA 
          MOVE      SP1,LXPXMGNA 
          MOVE      SP1,LXPXMTLE 
          MOVE      SP1,LXPXMAD1 
          MOVE      SP1,LXPXMAD2 
          MOVE      SP1,LXPXMAD3 
          MOVE      SP1,LXPXMAD4 
          MOVE      SP1,LXPXMPOS 
          MOVE      SP1,LXPXMPNO 
          MOVE      SP1,LXPXMBNO 
          MOVE      SP1,LXPXMMNO 
          MOVE      SP1,LXPXMEML 
          MOVE      SP1,LXPXMCNT 
          MOVE      SP1,LXPXMCRP 
          MOVE      SP1,LXPXMLAB 
          MOVE      SP1,LXPXMREL 
          MOVE      SP1,LXPXFSNA 
          MOVE      SP1,LXPXFGNA 
          MOVE      SP1,LXPXFTLE 
          MOVE      SP1,LXPXFAD1 
          MOVE      SP1,LXPXFAD2 
          MOVE      SP1,LXPXFAD3 
          MOVE      SP1,LXPXFAD4 
          MOVE      SP1,LXPXFPOS 
          MOVE      SP1,LXPXFPNO 
          MOVE      SP1,LXPXFBNO 
          MOVE      SP1,LXPXFMNO 
          MOVE      SP1,LXPXFEML 
          MOVE      SP1,LXPXFCNT 
          MOVE      SP1,LXPXFCRP 
          MOVE      SP1,LXPXFLAB 
          MOVE      SP1,LXPXFREL 
          MOVE      SP1,LXPXDVAC 
          MOVE      SP1,LXPXABRG 
          MOVE      SP1,LXPXPRVI 
          MOVE      SP1,LXVXABRG 
          MOVE      SP1,LXVXCADM 
          MOVE      SP1,LXVXIRAD 
          MOVE      SP1,LXVXIDUS 
          MOVE      SP1,LXVXCRAV 
          MOVE      SP1,LXVXRCCT 
          MOVE      SP1,LXVXAPWD 
          MOVE      SP1,LXVXAPBD 
          MOVE      SP1,LXRGFAXN 
          MOVE      SP1,LXRFFAXN 
          MOVE      SP1,LXBPAYRN
          MOVE      SP1,LXLSTINV
          MOVE      SP1,LXIHINUM
          MOVE      SP1,LXVXCASC
          MOVE      SP1,LXVXCASD
          MOVE      SP1,LXXSMSID
          MOVE      SP1,LXXSMSKY
          MOVE      SP1,LXSMSCOD
          MOVE      SP1,LXXSMSPH
          MOVE      SP1,LXXSMSUR
          MOVE      SP1,LXXSMSUS
          MOVE      SP1,LXXSMSUN
          MOVE      SP1,LXELTOOP
          MOVE      SP1,LXATIME
          MOVE      SP1,LXADAY
          MOVE      SP1,LXADAYS
          MOVE      SP1,LXATIMEM
.
          MOVE      SP70,LXPXUCC4  
          MOVE      SP70,LXUCC4LD  
          PACK      LXPXATF1,SP70,SP70  
          MOVE      SP70,LXPXUCC5  
          MOVE      SP70,LXUCC5LD  
          PACK      LXPXATF2,SP70,SP70  
.
          MOVE      SP70,LXETHCO1  
          MOVE      SP70,LXETHLD1  
          MOVE      SP70,LXETHCO2
          MOVE      SP70,LXETHLD2
          MOVE      SP70,LXMLNCO1
          MOVE      SP70,LXMLNLD1
          MOVE      SP70,LXMLNCO2
          MOVE      SP70,LXMLNLD2
          MOVE      SP70,LXNKLCO1
          MOVE      SP70,LXNKLLD1
          MOVE      SP70,LXNKLCO2
          MOVE      SP70,LXNKLLD2
.
          MOVE      SP70,LXPXSN18
          MOVE      SP70,LXPXSN19
          MOVE      SP70,LXPXSN20
          MOVE      SP70,LXPXSN21
          MOVE      SP70,LXPXSN22
          MOVE      SP70,LXPXSN23
          MOVE      SP70,LXPXSN24
          MOVE      SP70,LXPXSN25
          MOVE      SP70,LXPXSN26
          MOVE      SP70,LXPXSN27
          MOVE      SP70,LXPXSN28
          MOVE      SP70,LXPXSN29
          MOVE      SP70,LXPXSN30
.
          MOVE      SP70,LXPUSRAC
          MOVE      SP70,LXPUSRAL
          MOVE      SP70,LXPUSRBC
          MOVE      SP70,LXPUSRBL
          MOVE      SP70,LXPUSRCC
          MOVE      SP70,LXPUSRCL
          MOVE      SP70,LXPUSRDC
          MOVE      SP70,LXPUSRDD
          MOVE      SP70,LXPUSRDL
          MOVE      SP70,LXPUSREC
          MOVE      SP70,LXPUSRED
          MOVE      SP70,LXPUSREL
          MOVE      SP70,LXPUSRFC
          MOVE      SP70,LXPUSRFD
          MOVE      SP70,LXPUSRFL
          MOVE      SP70,LXPUSRGC
          MOVE      SP70,LXPUSRGD
          MOVE      SP70,LXPUSRGL
          MOVE      SP70,LXPUSRHC
          MOVE      SP70,LXPUSRHD
          MOVE      SP70,LXPUSRHL
          MOVE      SP70,LXPUSRIC
          MOVE      SP70,LXPUSRID
          MOVE      SP70,LXPUSRIL
.
FILSPA99  RETURN
+
.******************************************************************************
.*                            CONS0000                                        *
.*                  Set Up Constant % Variables                               *
.******************************************************************************
CONS0000  OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,TWO;*4,CONAME
          READ      CONTROLF,TEN3;*65,CHPADD1,CHPADD2,CHPPOST,CHTELEB
.
          MOVE      CONAME,LXHOSP
          MOVE      CHPADD1,LXHADDA
          MOVE      CHPADD2,LXHADDB
          MOVE      CHPPOST,LXHPOST
          MOVE      CHTELEB,LXHOSTEL
.
          CLOSE     CONTROLF
.
          UNPACK    LETTDATE,CDAY,DUMMY,CMON,DUMMY,CYEAR
          CALL      FDAT0000
          MOVE      DATELINE,LXLETDAT
.
CONS9999  RETURN
+
.******************************************************************************
.*                            FDAT0000                                        *
.*                  Routine to Format the Date                                *
.******************************************************************************
FDAT0000  CLEAR     DATELINE
          MATCH     SP2,CDAY
          GOTO      FDAT2000 IF EQUAL
          MATCH     "99",CDAY
          GOTO      FDAT2000 IF EQUAL
          MOVE      CDAY,FORM2
.
.------ add date extension onto the day ------
.
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                               DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT1
          MOVE      CMON,FORM2
.
.------ change month into long format ------
.
          LOAD      MONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                                MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      FDAT1000 IF NOT EQUAL
.
.------ pack the formatted date ------
.
FDAT1000  PACK      DATELINE,CDAY,DEXT,SP1,MONTH,SP1,CCENT,CYEAR
          MOVE      DATELINE,LINE
.          CALL      COMP0000
          MOVE      LINE,DATELINE
          GOTO      FDAT9999
.
.------ date does not exist ------
.
FDAT2000  MOVE      "99th December 1999",DATELINE
          GOTO      FDAT9999
.
FDAT9999  RETURN
+
.******************************************************************************
.*                            PRLT0000                                        *
.*        Set up and print letter one line at a time                          *
.*                                                                            *
.*        Returns : EXIT = 0      ask if to print more letters                *
.*                  EXIT = 1      select another letter to print              *
.*                  EXIT = 2      get next item on temp file                  *
.******************************************************************************
PRLT0000  MOVE      FALSE,EXIT
          MOVE      ONE,COUNT               * line number to print
.
          MOVE      ZERO,FORM3              * read letter file header
          PACK      KEY6,LETTFORM,FORM3     *    record
          CALL      RDPTLET1
.
          MOVE      PTLEPPAG,PHYSPAGE       * physical paper length
          MOVE      PTLEPTOP,TOPMARG        * top margin
          MOVE      PTLEPBOT,BOTTMARG       * bottom margin
          SUB       PTLEPBOT,PTLEPPAG       * where to print to at bottom
          MOVE      PTLEPPAG,MLETPLEN       * length to print to 
          MOVE      PTLEPTAB,LEFTMARG       * left margin
.
          MOVE      SP1,LETRCOMM
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      PRLT0050 IF NOT EQUAL
.
          MOVE      PTLECOMM,LETRCOMM       * Store our Communication Method
          MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            MOVE      ONE,TOPMARG           * Default top margin to 1
            MOVE      ONE,BOTTMARG          * Default bottom margin to 1
            MOVE      ONE,LEFTMARG          * Default left margin to 1
.
            IF        LEAVESMS=1
              CALL      LVSMSH00      * Print Leave SMS Message XML Header Tag
              GOTO      PRLT1000      * Skip to print actual letter lines
            ENDIF
.
            IF        OCONTSMS=1
              CALL      OCTMSH00      * Print SMS Message XML Header Tags for
                                      * other contact numbers only.
              GOTO      PRLT1000      * Skip to print actual letter lines
            ENDIF
.
            CALL      PRSMSH00          * Print SMS Message XML Header Tag
            GOTO      PRLT1000          * Skip to print actual letter lines
          ENDIF
.
.
.------ print top margin ------
.
PRLT0050  PRINT     *N;                     * print blank line
          COMPARE   COUNT,TOPMARG
          GOTO      PRLT1000 IF EQUAL       * printed top margin
.
          ADD       ONE,COUNT
          GOTO      PRLT0050
.
. ------- print letter one line at a time ------
.
PRLT1000  CALL      RKPTLET1
          BRANCH    OVRCD,PRLT9000          * end of letter reached
.
          COMPARE   LETTFORM,PTLELTNO
          GOTO      PRLT9000 IF NOT EQUAL   * different letter number
.
          BRANCH    PTLELVAR,PRLT2000       * have a % var
.
.         printing when no % variables
.
          PRINT     *N,*LEFTMARG,PTLETEXT;  * print text if no % vars
          ADD       ONE,COUNT
.
          MATCH     "1",LETRCOMM            * SMS Notification?
          GOTO      PRLT1000 IF EQUAL
.
          COMPARE   COUNT,MLETPLEN
          CALL      PAGE0000 IF EQUAL       * print page when required
          GOTO      PRLT1000
.
.         printing when have % variables
.
PRLT2000  CALL      MOD0000                 * substitute % var value
          PRINT     *N,*LEFTMARG,PRTSTRNG;  * print text with % vars
          ADD       ONE,COUNT
.
          MATCH     "1",LETRCOMM            * SMS Notification?
          GOTO      PRLT1000 IF EQUAL
.
          COMPARE   COUNT,MLETPLEN
          CALL      PAGE0000 IF EQUAL       * print page when required
          GOTO      PRLT1000
.
. ------- end of current letter reached -------
.
PRLT9000  MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRSMSF00              * Print SMS Message XML Footer Tag
            GOTO      PRLT9050
          ENDIF
.
          COMPARE   TOPMARG,COUNT
          GOTO      PRLT9500 IF EQUAL       * no lines of text printed
.
PRLT9050  DISPLAY   *P60:24,*EL,*V2LON,COUNTER,*HOFF," Printed";
          MOVE      PHYSPAGE,TEMP3          * set up variables for paging
          SUBTRACT  COUNT,PHYSPAGE
          MOVE      ONE,COUNT
.
.------ paginate at end of each letter ------
.
PRLT9100  PRINT     *N;
          COMPARE   COUNT,PHYSPAGE
          GOTO      PRLT9400 IF EQUAL       * printed bottom margin
.
          ADD       ONE,COUNT
          GOTO      PRLT9100
.
PRLT9400  MOVE      TEMP3,PHYSPAGE          * restore physical page length
          MOVE      TWO,EXIT                * indicate to continue
          GOTO      PRLT9999
.
.------ letter header is on file but nothing else ------
.
PRLT9500  DISPLAY   *P1:24,*EL,*B,"Letter has not been set up yet - Tap <":
                    *V2LON,"ENTER",*HOFF,">";
          KEYIN     ANS;
          MOVE      TRUE,EXIT               * enter another letter code
.
PRLT9999  RETURN
+
.******************************************************************************
.*                            PAGE0000                   Called by : PRLT0000 *
.*        Routine to paginate if a new page is required                       *
.******************************************************************************
PAGE0000  MOVE      PTLELTNO,FORM3
          MOVE      PTLELINO,FORM3A
          CALL      RKPTLET1
          BRANCH    OVRCD,PAGE8000                * check to see that
          COMPARE   LETTFORM,PTLELTNO             *  another line of the
          GOTO      PAGE8000 IF NOT EQUAL         *  letter exists
          MOVE      TOPMARG,TEMP2
          ADD       BOTTMARG,TOPMARG
          MOVE      ONE,COUNT
.
.------ loop to paginate ------
.
PAGE1000  PRINT     *N;
          COMPARE   COUNT,TOPMARG
          GOTO      PAGE9000 IF EQUAL
          ADD       ONE,COUNT
          GOTO      PAGE1000
.
.------ no need to paginate ------
.
PAGE8000  PACK      KEY6,FORM3,FORM3A
          CALL      RDPTLET1
          GOTO      PAGE9999
.
.------ reset read to previous record to continue processing ------
.
PAGE9000  MOVE      TEMP2,COUNT
          MOVE      TEMP2,TOPMARG
          PACK      KEY6,FORM3,FORM3A
          CALL      RDPTLET1
.
PAGE9999  RETURN
+
.******************************************************************************
.*                            MOD0000                    Called by : PRLT2000 *
.*        Modify a line to substitute "%" variable values                     *
.******************************************************************************
MOD0000   MOVE      PTLETEXT,DIM70
          PACK      PRTSTRNG,SP30,SP30,SP10          * initialise PRTSTRNG
          RESET     PRTSTRNG,0                       *   and pointer positions
          MOVE      ONE,STARTSTR
          MOVE      ONE,ENDSTR
.
MOD2000   SCAN      SPECCHAR,DIM70                * Scan the Input Line for
          GOTO      MOD8000 IF NOT EQUAL          * a "%" sign
.
MOD3000   MOVEFPTR  DIM70,PERCPOS
          BUMP      DIM70,-1                     * Go to the character before
.                                                * the "%" sign
          GOTO      MOD3100 IF NOT EOS            * Test if the % sign is the
          RESET     DIM70,0                      * first character on the line
.                                                * set f.p. to 0 if it is
.
MOD3100   MOVEFPTR  DIM70,ENDSTR                  * store endtsr at position
          COMPARE   STARTSTR,ENDSTR               *   1 char before the % sign
          GOTO      MOD3200 IF NOT LESS           *   and ensure that end and
.                                                *   start positions dont
.                                                *   overlap
          RESET     DIM70,STARTSTR                * set pointer to next % sign
          GOTO      MOD9999 IF EOS                *   if end < start
          GOTO      MOD3300
.
MOD3200   RESET     DIM70,STARTSTR                * reset the pointers to
          SETLPTR   DIM70,ENDSTR                  *   extract text preceding
          APPEND    DIM70,PRTSTRNG                *   the % sign
.
MOD3300   SETLPTR   DIM70,70                      * set the pointers to start at
          RESET     DIM70,PERCPOS                 *    % and go to position 70
.
.         SRF 642798
.
          MOVE      DIM70,TEMP70                  * delete preceding text from
          PACK      TEMP70,DIM70,SP30,SP30,SP30   *    the DIM70 string
.
MOD4000   CALL      GETV0000                      * extract the % var
          MOVEFPTR  DIM70,STARTSTR                * store finish pos. of var
          BRANCH    EXIT,MOD5000
          RESET     SRCHVAR
.
.------ search for the % var in the list of constants ------
.
          SEARCH    SRCHVAR,LCPAGE,LCNOVARS,SRCHNUM
.
          COMPARE   ONE,SRCHNUM
          GOTO      MOD7000 IF EQUAL        * Page Variable
.
MOD4500   COMPARE   ZERO,SRCHNUM                   * % var not found in list
          GOTO      MOD5000 IF EQUAL
.
.------ load DISPSTRN with the actual value of the % var ------
.
          LOAD    DISPSTRN,SRCHNUM,LXPAGE,LXACLASS,LXADATE,LXADCFUL,LXADCGIV: *5
                           LXADCINI,LXADCSUR,LXADCTTL,LXADDA,LXADDB:      * 10
                           LXADDC,LXADDD,LXADMN,LXATYPE,LXAUSRA:          * 15
                           LXAUSRB,LXAUSRC,LXAUSRD,LXAUSRE,LXBTELE:       * 20
                           LXCARECL,LXCLMCOD,LXCOFB,LXCURDAT,LXDDATE:     * 25
                           LXDOB,LXFRSTI,LXFULLN,LXGIVN,LXHADDA:          * 30
                           LXHADDB,LXHFMEM,LXHFTAB,LXHFUND,LXHOSP:        * 35
                           LXHOSTEL,LXHPOST,LXLETDAT,LXLOCDOC,LXMEDI:     * 40
                           LXNOKAA,LXNOKAB,LXNOKAC,LXNOKAD,LXNOKBT:       * 45
                           LXNOKNM,LXNOKPC,LXNOKPT,LXPOST,LXPTELE:        * 50
                           LXPUSRA,LXPUSRB,LXPUSRC,LXRDCFUL,LXRDCGIV:     * 55
                           LXRDCINI,LXRDCSUR,LXRDCTTL,LXREFERL,LXRELIG:   * 60
                           LXSURN,LXTDCFUL,LXTDCGIV,LXTDCINI,LXTDCSUR:    * 65
                           LXTDCTTL,LXTITLE,LXURNO,LXKNNAME,LXNKADD1:     * 70
                           LXNKADD2,LXNKADD3,LXNKADD4,LXNKPOST,LXGPSNAM:  * 75
                           LXGPGNAM,LXGPADD1,LXGPADD2,LXGPADD3,LXGPADD4:  * 80
                           LXGPPOST,LXRGPSNM,LXRGPGNM,LXRGPAD1,LXRGPAD2:  * 85
                           LXRGPAD3,LXRGPAD4,LXRGPPST,LXGPFH,LXECR:       * 90
                           LXHSPNAM,LXHSPAD1,LXHSPAD2,LXHSPAD3,LXHSPAD4:  * 95
                           LXHSPOST,LXHSPHON,RGPRSURG,RGPRSAD1,RGPRSAD2:  * 100
                           RGPRSAD3,RGPRSAD4,RGPRSPCD,RGPRTELE,RFPRSURG:  * 105
                           RFPRSAD1,RFPRSAD2,RFPRSAD3,RFPRSAD4,RFPRSPCD:  * 110
                           RFPRTELE,LXCELL,LXPADDA,LXPADDB,LXPADDC:       * 115
                           LXPADDD,LXPPOST,LXPXMSNA,LXPXMGNA,LXPXMTLE:    * 120
                           LXPXMAD1,LXPXMAD2,LXPXMAD3,LXPXMAD4,LXPXMPOS:  * 125
                           LXPXMPNO,LXPXMBNO,LXPXMMNO,LXPXMEML,LXPXMCNT:  * 130
                           LXPXMCRP,LXPXMLAB,LXPXMREL,LXPXFSNA,LXPXFGNA:  * 135
                           LXPXFTLE,LXPXFAD1,LXPXFAD2,LXPXFAD3,LXPXFAD4:  * 140
                           LXPXFPOS,LXPXFPNO,LXPXFBNO,LXPXFMNO,LXPXFEML:  * 145
                           LXPXFCNT,LXPXFCRP,LXPXFLAB,LXPXFREL,LXPXDVAC:  * 150
                           LXPXABRG,LXPXPRVI,LXVXABRG,LXVXCADM,LXVXIRAD:  * 155
                           LXVXIDUS,LXVXCRAV,LXVXRCCT,LXVXAPWD,LXVXAPBD:  * 160
                           RGPRFAXN,RFPRFAXN,LXCURDTN,LXBPAYRN,LXLSTINV:  * 165
                           LXIHINUM,LXVXCASC,LXVXCASD,LXXSMSID,LXXSMSKY:  * 170
                           LXSMSCOD,LXXSMSPH,LXXSMSUR,LXXSMSUS,LXELTOOP:  * 175
                           LXFOODDT,LXFOODTM,LXFLUIDD,LXFLUIDT,LXATIME:   * 180
                           LXADATEX,LXADATEN,LXADAY,LXADAYS,LXATIMEM:     * 185
                           LXPGNAM1,LXPGNAM2,LXXSMSUN,LXLVDATE,LXLVTIME:  * 190
                           LXLVEXRD,LXLVEXRT,LXLVLTYP,LXWARDCD,LXWARDSN:  * 195
                           LXWARDLN,LXBEDDCD,LXBEDDSN,LXBEDDLN,LXPXUCC4:  * 200
                           LXUCC4LD,LXPXATF1,LXPXUCC5,LXUCC5LD,LXPXATF2:  * 205
                           LXETHCO1,LXETHLD1,LXETHCO2,LXETHLD2,LXMLNCO1:  * 210
                           LXMLNLD1,LXMLNCO2,LXMLNLD2,LXNKLCO1,LXNKLLD1:  * 215
                           LXNKLCO2,LXNKLLD2,LXPXSN18,LXPXSN19,LXPXSN20:  * 220
                           LXPXSN21,LXPXSN22,LXPXSN23,LXPXSN24,LXPXSN25:  * 225
                           LXPXSN26,LXPXSN27,LXPXSN28,LXPXSN29,LXPXSN30:  * 230
                           LXPUSRAC,LXPUSRAL,LXPUSRBC,LXPUSRBL,LXPUSRCC:  * 235
                           LXPUSRCL,LXPUSRDC,LXPUSRDD,LXPUSRDL,LXPUSREC:  * 240
                           LXPUSRED,LXPUSREL,LXPUSRFC,LXPUSRFD,LXPUSRFL:  * 245
                           LXPUSRGC,LXPUSRGD,LXPUSRGL,LXPUSRHC,LXPUSRHD:  * 250
                           LXPUSRHL,LXPUSRIC,LXPUSRID,LXPUSRIL            * 255
.
          APPEND    DISPSTRN,PRTSTRNG
          CALL      COMX0000                   * compress trailing blanks in
          GOTO      MOD2000                    *    PRTSTRNG
.
MOD5000   RESET     SRCHVAR                    * add the string starting with
          APPEND    SRCHVAR,PRTSTRNG           *    a % if not found in the
          GOTO      MOD8000 IF EOS             *    list of constants
          GOTO      MOD2000
.
.------ %page variable found ------
.
MOD7000   MOVE      PHYSPAGE,TEMP3
          SUBTRACT  COUNT,PHYSPAGE
          MOVE      ONE,COUNT
          ADD       TOPMARG,PHYSPAGE
          SUBTRACT  ONE,PHYSPAGE
.
MOD7100   PRINT     *N;
          COMPARE   COUNT,PHYSPAGE
          GOTO      MOD7500 IF EQUAL
          ADD       ONE,COUNT
          GOTO      MOD7100
.
MOD7500   MOVE      TEMP3,PHYSPAGE
          MOVE      TOPMARG,COUNT
          SUBTRACT  ONE,COUNT
          PACK      PRTSTRNG,SP30,SP30,SP10
          GOTO      MOD9999
.
MOD8000   APPEND    DIM70,PRTSTRNG                    * add remaining text to
          RESET     PRTSTRNG                          *   PRTSTRNG if no %
.                                                     *   signs left
MOD9999   RETURN
+
.******************************************************************************
.*                            COMX0000                                        *
.*        Routine to compress trailing blanks in PRTSTRNG                     *
.******************************************************************************
COMX0000  ENDSET    PRTSTRNG
.
COMX1000  CMATCH    SP1,PRTSTRNG
          GOTO      COMX9999 IF NOT EQUAL
          BUMP      PRTSTRNG,-1
          GOTO      COMX9999 IF EOS
          GOTO      COMX1000
.
COMX9999  RETURN
+
.******************************************************************************
.*                            GETV0000                                        *
.*        Extracts the "%" variable from the line                             *
.******************************************************************************
GETV0000  MOVE      FALSE,EXIT
          PACK      SRCHVAR,SP30,SP30,SP10
          RESET     SRCHVAR,0
          MOVE      DIM70,ANS
          APPEND    ANS,SRCHVAR
          RESET     SRCHVAR,0
          BUMP      DIM70
          MOVE      DIM70,ANS
          REPLACE   REPSTR,ANS                        * check to see if first
          MATCH     "0",ANS                           *   char after % is a
          GOTO      GETV9000 IF NOT EQUAL             *   lower case letter
          BUMP      DIM70,-1
          PACK      SRCHVAR,SP30,SP30,SP10            * initialise SRCHVAR
          RESET     SRCHVAR,0                         *   value and pointers
.
.------ append % var to SRCHVAR until anything but ------
.------ a lower case letter is found ------
.
GETV1000  MOVE      DIM70,ANS
          APPEND    ANS,SRCHVAR
.
          BUMP      DIM70
          GOTO      GETV9999 IF EOS
          MOVE      DIM70,ANS
          REPLACE   REPSTR,ANS
          MATCH     "0",ANS
          GOTO      GETV9999 IF NOT EQUAL
          GOTO      GETV1000
.
.------ string found is not a valid % var ------
.
GETV9000  MOVE      TRUE,EXIT
.
GETV9999  RETURN
.
.----------------------------------------------------------------------------
. Get Ethnicty 1-2 and Main language spoken at home 1-2
.----------------------------------------------------------------------------
ETHLAN00  MOVE      PMPXETH1,LXETHCO1        * Ethnicity 1 Code
.
          MOVE      SP70,LXETHLD1
          MATCH     SP70,PMPXETH1
          GOTO      ETHLAN10 IF EQUAL
.  
          MOVE      "EN",DIM2
          PACK      KEY5,DIM2,PMPXETH1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ETHLAN10
.
          MOVE      PTCDLDES,LXETHLD1        * Ethnicity 1 Long Desc
.
ETHLAN10  MOVE      PMPXETH2,LXETHCO2        * Ethnicity 2 Code
.
          MOVE      SP70,LXETHLD2
          MATCH     SP70,PMPXETH2
          GOTO      ETHLAN20 IF EQUAL
.  
          MOVE      "EN",DIM2
          PACK      KEY5,DIM2,PMPXETH2,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ETHLAN20
.
          MOVE      PTCDLDES,LXETHLD2        * Ethnicity 2 Long Desc
.
ETHLAN20  MOVE      PMPXLAN1,LXMLNCO1        * Lang Spoken At Home 1 Code
.
          MOVE      SP70,LXMLNLD1
          MATCH     SP70,PMPXLAN1
          GOTO      ETHLAN30 IF EQUAL
.  
          MOVE      "l1",DIM2
          PACK      KEY5,DIM2,PMPXLAN1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ETHLAN30
.
          MOVE      PTCDLDES,LXMLNLD1        * Lang Spoken At Home 1 Long Desc
.
ETHLAN30  MOVE      PMPXLAN2,LXMLNCO2        * Lang Spoken At Home 2 Code
.
          MOVE      SP70,LXMLNLD2
          MATCH     SP70,PMPXLAN2
          GOTO      ETHLAN40 IF EQUAL
.  
          MOVE      "l1",DIM2
          PACK      KEY5,DIM2,PMPXLAN2,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ETHLAN40
.
          MOVE      PTCDLDES,LXMLNLD2        * Lang Spoken At Home 2 Long Desc
.
ETHLAN40  MOVE      SP70,LXNKLCO1
          MOVE      SP70,LXNKLLD1
          MOVE      SP70,LXNKLCO2
          MOVE      SP70,LXNKLLD2
.
          CALL      GPMCEX00
          BRANCH    EXIT,ETHLAN99
.
          MOVE      PMCELAN1,LXNKLCO1        * NOK Main Lang 1 Code 
          MOVE      PMCELAN2,LXNKLCO2        * NOK Main Lang 2 Code
.    
          MATCH     SP70,PMCELAN1
          GOTO      ETHLAN50 IF EQUAL
.  
          MOVE      "l1",DIM2
          PACK      KEY5,DIM2,PMCELAN1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ETHLAN50
.
          MOVE      PTCDLDES,LXNKLLD1        * NOK Main Lang 1 Long Desc
.
ETHLAN50  MATCH     SP70,PMCELAN2
          GOTO      ETHLAN99 IF EQUAL
.  
          MOVE      "l1",DIM2
          PACK      KEY5,DIM2,PMCELAN2,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ETHLAN99
.
          MOVE      PTCDLDES,LXNKLLD2        * NOK Main Lang 2 Long Desc
.
ETHLAN99  RETURN
+
          INC       GPMCEX00
