.******************************************************************************
.*                                                                            *
.*                        P R O G R A M   S U M M A R Y                       *
.*                        -------------   -------------                       *
.*                                                                            *
.*     PROGRAM NAME:     IBAHOS20                                             *
.*                                                                            *
.*     FUNCTION:         PRINT STATEMENT PROGRAM                              *
.*                                                                            *
.*     AUTHOR:           JENI TAN                                             *
.*                                                                            *
.*     DATE WRITTEN:     19/05/1988                                           *
.*                                                                            *
.*     MODIFICATIONS:                                                         *
.*                                                                            *
.*----------------------------------------------------------------------------*
.* V12.00.01 15.05.2025  DA Sarkies     TSK 0955096                           *
.*           Updated for Alpha-Numeric Visit Number                           *
.*----------------------------------------------------------------------------*
.* V11.04.03 31/05/2024  J.Tan          TSK 0936282                           *
.*           Defaulting Master Health fund membership to admission HF         *
.* V11.04.02 21/05/2024  J.Tan          TSK 0936282                           *
.*           Mod to set WEBFLAG                                               *
.* V11.04.01 05.02.2024  DA Sarkies     TSK 0936282                           *
.*           Increased size of variable to fund Healthfund Number             *
.* V11.03.02 08/11/2023  Nikitha B      TSK 0927699c                          *
.*           Read CAPPRVNO and PTCNHABN for Hospital Approval and ABN number. *
.* V11.03.01 04/10/2023  Nikitha B     TSK 0927699                            *
.*           Recomplied for PATINVHL, PATINVTL - Stationary variables         *
.* V11.02.01 09/02/2022  Thanh T       TSK 0905641                            *
.*           Recompiled as OUTMA1FD changes                                   *
.* V11.01.03 14/09/2021  Davin           TSK 0911277                          *
.*           Recompiled for PRTINVBD                                          *
.* V11.01.02 10/09/2021  Davin           TSK 0911277                          *
.*           Recompiled for PATINVTL - Changed field 20 length to 12.2        *
.* V11.01.01 24/08/2021  Davin          TSK 0897318                           *
.*           Recompiled for PATINVTL - added field 57(Adjustment Total)       *
.*----------------------------------------------------------------------------*
.* V11.00.01 08/04/2020 J.Tan           TSK 0868813                           *
.*           Recompiled for PATINVHL                                          *
.*           15/04/2020 Thanh T         TSK 0879163                           *
.*           Added SEXDSP00                                                   *
.*----------------------------------------------------------------------------*
.* V10.12.01 28/02/2018  J.Tan          TSK 0852351                           *
.*           Recompiled for PATINVHL-fields 226 & 227(Program Code/Desc)      *
.* V10.11.01 23/11/2017  Ania P        TSK 0261630                            *
.*           Removed use of PORT                                              *
.* V10.08.02 07/11/2016  Ebon Clements TSK 0827937                            *
.*           Recompiled for PATINVHL - Hospital approval number               *
.* V10.08.01 02/05/2016  Ebon Clements TSK 0268970                            *
.*           Change to use OUTCLIFD index 1 instead of index 2                *
.* V10.06.01 15/05/2015  Davin         CAR 310155                             *
.*           Recompiled for PATGBCRN - added MOD10V05 for BPAY                *
.* V10.05.02 10/02/2015 J.Tan      CAR 311717                                 *
.*           Recompiled for PATINVHL                                          *
.* V10.05.01 28/10/2014 J.Tan          CAR 304455                             *
.*           Recompiled for PATINVHL - fixed Doctor Name and Provider no      *
.* V10.04.01 28/01/2014  Patrick Adair CAR 265844                             *
.*           Recompiled for PATINVHL                                          *
.* V10.03.04 09/12/2013  Ania P        CAR 294740                             *
.*           Recompiled for PATINVHL                                          *
.* V10.03.03 12/09/2013  Peter Vela    CAR 271911                             *
.*           Recompiled for PATINVTL                                          *
.* V10.03.02 20/06/2013  Davin         CAR 287161                             *
.*           Recompiled for PATGBCRN - right justify ptcnhbpi                 *
.* V10.03.01 18/07/2012  Don Nguyen    CAR 264561                             *
.*           Recompiled for PATGBCRN                                          *
.******************************************************************************
.* V10.02.02 07/07/2011  Steve Armstrong  CAR 240722                          *
.*           Added RDPMPX21 prior to calling PMIHEAD                          *
.* V10.02.01 04/04/2011 Jill Parkinson CAR 239574                             *
.*           Removed open of ibaprntf                                         *
.******************************************************************************
.* V9.12.01  04/12/2009  Peter Vela    CAR 202333                             *
.*           Recompiled for PATINVHL - Changed variable 88 to surname only    *
.******************************************************************************
.* V9.11.02  23/03/2009  Davin         CAR 178015                             *
.*           Recompiled for PATINVHL - Changed BPAY CRN to use invoice number *
.* V9.11.01  14/10/2008  Peter Vela    CAR 159227                             *
.*           Recompiled for PATINVHL - Added Emergency Invoice                *
.*           Arrival Date and Time                                            *
.******************************************************************************
.* V9.09.07  27/12/2007  Peter Vela    CAR 155907                             *
.*           Recompiled for PATINVTL                                          *
.* V9.09.06  16/11/2007  Peter Vela    CAR 110766                             *
.*           Recompiled for PATINVHL                                          *
.* V9.09.05  12/11/2007  Peter Vela    CAR 151199                             *
.*           Added new Emergency Cancellation status                          *
.* V9.09.04  11/07/2007  Mike Laming   CAR 140395                             *
.*           Add Statement flag STATMENT for PATINVL Header/Tail in INIT0000  *
.* V9.09.03  03/07/2007  Mike Laming   CAR 140395                             *
.*           Add Private Practice to Opt.2 (By UR) & Opt.3 (Range of Dates)   *
.* V9.09.02  03/07/2007  Peter Vela    CAR 142173                             *
.*           Recompiled for PATINVTL                                          *
.* V9.09.01  15/06/2007  Mike Laming   CAR 140395                             *
.*           Re-compile for PATINVTL - add Statements "Net Balance"           *
.******************************************************************************
.* V9.08.11  22/06/2007  Mike Laming   CAR 140395                             *
.*           Add Private Practice to Opt.2 (By UR) & Opt.3 (Range of Dates)   *
.* V9.08.10  20/06/2007  Mike Laming   CAR 140395                             *
.*           Add OPEN for RDBOKB1 at OP3T2000, set PINVSYS=3 for "CALL HEAD"  *
.* V9.08.09  15/06/2007  Mike Laming   CAR 140395                             *
.*           Add GROSSTOT at CALCIN1A & Re-compile for PATINVTL               *
.* V9.08.08  15/06/2007  Mike Laming   CAR 140395                             *
.*           Re-compile for PATINVTL - add Statements "Net Balance"           *
.* V9.08.07  29/03/2007  Mike Laming   CAR 125313                             *
.*           Re-align PATINVFD Amount fields for both DISPLAY and PRINT -     *
.*           PINVAMT *67=>*66 PINVPATA,PINVHFDA & PINVOTHA *68=>*66           *
.* V9.08.06  19/02/2007 Peter Vela     CAR 135241                             *
.*           Recompiled for WEBDINVS - St. John of God invoice layout         *
.* V9.08.05  13/12/2006  J.Tan         CAR 127625                             *
.*           Mods to JH HRN                                                   *
.* V9.08.04  27/11/2006  Steve Armstrong   CAR 126039                         *
.*           Recompiled for changes to SGCHKDIG                               *
.* V9.08.03  16/11/2006  Steve Armstrong   CAR 124160                         *
.*           Recompiled for PATINVHL (Singapore HRN)                          *
.*           Recompiled for PATINVTL (Singapore HRN)                          *
.* V9.08.02  14/11/2006  Peter Vela    CAR 124547                             *
.*           Added reads for PTCNDEES PTCNDDES                                *
.* V9.08.01  07/09/2006  Jill Habasque CAR 109852                             *
.*           Recompiled for PATINVHL - Changed to output alt id if ptcndaur=1 *
.******************************************************************************
.* V9.07.01  30/08/2006  J.Tan         CAR 115853                             *
.*           Recompiled for PATINVTL - Print invoice for Pendlebury           *
.******************************************************************************
.* V9.06.02  17/05/2006  Peter Vela    CAR 104103                             *
.*           Recompiled for PATINVHL - Changed doc surname to formatted doc nm*
.* V9.06.01  24/04/2006  J.Tan         CAR 102287                             *
.*           Recompiled for PATINVHL - Added fields for multi hospital details*
.******************************************************************************
.* V9.05.03  29/03/2006 Peter Vela CAR 95780                                  *
.*           Recompiled for PATINVHL - Added emg mobile contact numbers       *
.* V9.05.02  27/03/2006 Peter Vela CAR 61299                                  *
.*           Increased field no size from DIM3 to DIM5                        *
.*        V9.05.01  10/03/2006  Mike Laming   CAR 79281                       *
.*                  Increase PATFACT1 to KEY19 & add FACODE to key string     *
.******************************************************************************
.* V9.04.05  03/08/05 J.Tan    CAR 62750                                      *
.*           Removed redefined amount variables                               *
.* V9.04.04  14/07/2005  Peter Vela    CAR 62172                              *
.*           Recompiled for PATINVTL                                          *
.* V9.04.03  19/11/2004  J.Tan         CAR 54589                              *
.*           Fixed checking for report type                                   *
.* V9.04.02  08/11/2004  J.Tan         CAR 54569                              *
.*           Fixed O/P and EMR header/tail template                           *
.* V9.04.01  02/09/2004 J.Tan   CAR 53073                                     *
.*           Mods for multi hospital                                          *
.*           06/09/2004 Lina Vo CAR 52998                                     *
.*           Initialise Page number.                                          *
.******************************************************************************
.* V9.03.07  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2             *
.*           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"*
.* V9.03.06  06/04/2004  Peter Vela    CAR 48227                              *
.*           Added VARGBCRN and PATGBCRN - BPAY Reference Number              *
.* V9.03.05  07/11/2003 Peter Vela       CAR 44849                            *
.*           Recompiled for PATINVTL                                          *
.* V9.03.04  03/11/2003 Peter Vela       CAR 44757                            *
.*           Recompiled for PATINVTL                                          *
.* V9.03.03  29/10/2003 Sandra Barcham   43783                                *
.*           Recompiled for NZHISIIO and NZHISIUP                             *
.* V9.03.02  04/09/2003  CAR 42713   Mike Laming                              *
.*           Recompiled for PATINVTL (correct GST twice in final Total)       *
.* V9.03.01  14/08/2003  Lina Vo    CAR 41196                                 *
.*           Recompiled for big changes in PATSELFN.                          *
.*           Added dummy section WEBERR00 for PATANVS.PBL.                    *
.******************************************************************************
.* V9.02.07  12/07/2002  Dean Cramer                                          *
.*           Include open of EMRVISA1 left out in error.                      *
.* V9.02.06  12/07/2002  Dean Cramer                                          *
.*           Include open of EMRVISA1 left out in error.                      *
.* V9.02.05  07/05/2002  J.Tan                                                *
.*           Recompiled for release 6.09 changes                              *
.* V9.02.04  28/03/2002  J.Tan                                                *
.*           Recompiled for PATINVHL - STV invoice                            *
.* V9.02.03  07/12/2001  Tonii                                                *
.*           Recompiled for PATDINVS                                          *
.* V9.02.02  01/11/2001  Greg Horvat                                          *
.*           Recompiled for ACTCOMN1 - Added xtra option to the               *
.*           parameter PNSWRACE                                               *
.* V9.02.01  22/09/2001  Tonii  SRF 13075                                     *
.*           Recompiled for PATDINVS                                          *
.******************************************************************************
.*        V5.10.B01 23/03/2001  Glenn Saunders                                *
.*                  Remove all references to PATSUR file (old surname file).  *
.*        V5.08.04  28/08/2000  Tonii                                         *
.*                  Mods to accept Unknown and Indeterminate as valid patient *
.*                  sex description                                           *
.*        V5.08.03  16/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.08.02  07/06/2000  Jill Habasque  SRF 2441                       *
.*                  Added ENDFLG for WWH to stop infinite loop                *
.*        V5.08.01  06/06/2000  Jill Habasque                                 *
.*                  Changed from key10 to key14 for the health fund file      *
.*        V5.08.B04 27/04/2000  Tonii    SRF 639008                           *
.*                  Added new variable INVDATE, to fix date display problems  *
.*                  when printing multiple pages                              *
.*        V5.08.B03 03/04/2000  Davin                                         *
.*                  Added parameters for invoice templating                   *
.*        V5.08.B02 30/03/2000  Davin                                         *
.*                  Recompiled for invoice templating                         *
.*        V5.08.B01 08/03/2000  Steve Armstrong     5.08 mods                 *
.*                  Mods for changes to OUTCLIFD (effective date)             *
.******************************************************************************
.*        V5.07.06  03/11/1999  Steve Downing  SRF 634625                     *
.*                  Fixed to not print cancelled invoices in "by date" for WWH*
.*        V5.07.05  08/08/1999  Jill Habasque                                 *
.*                  Fixed U/R Number statements for WWH (clear admno)         *
.*        V5.07.04  05/08/1999  Jill Habasque                                 *
.*                  Fixed to read the PRIDEBTF if the last inv is a private   *
.*                  practice invoice (WWH only)                               *
.*        V5.07.03  09/06/1999  Greg Horvat                                   *
.*                  Recompiled for PRIINVIO - Fixed problem with direct read  *
.*        V5.07.02  24/05/1999  Jill Habasque                                 *
.*                  Fixed overprinting of invoice number & corrected the      *
.*                  invoice date to be PINVDTE                                *
.*        V5.07.01  01/04/1999  Jill Habasque SRF 630671                      *
.*                  Recompiled for changes to PATSTA18                        *
.*       V5.07.B02  13/01/1999  Jim Stathopoulos                              *
.*                  Fixed Global Compile Errors                               *
.*       V5.07.B01  10/11/1998  Davin                                         *
.*                  Mods for 507                                              *
.******************************************************************************
.*        V5.06.03  20/10/1998  Steve Armstrong   SRF 628407                  *
.*                  Fixed set up of PRA for date range option (WWH)           *
.*                  Also recompiled for IBAPRINT                              *
.*        V5.06.02  01/10/1998  Steve Armstrong   SRF 628407                  *
.*                  Major modifications to the way WWH statements are produced*
.*                  as the original code was slightly off the mark.           *
.*                  Also fixed WWDT0000 routine to finished looping through   *
.*                  priinvof when end date is reached.                        *
.*                  Also fixed printing of invoice date for PRI invoices.     *
.*                  Also fixed printing of pt. postcode for invoice date      *
.*                  range option.                                             *
.*                  Also added OPNPRINT and CLSPRINT for WWH statements for   *
.*                  invoice date range.                                       *
.*        V5.06.01  04/09/1998  J.Tan   SRF 627779                            *
.*                  Fixed I*C on priinvof and ward index 4                    *
.*        V5.05.02  02/10/1997  Nick Read                                     *
.*                  Mods for West Wimmera Statements                          *
.*        V5.05.01  14/10/1997  Steve Armstrong    SRF 643393                 *
.*                  Removed invoice message for THC                           *
.******************************************************************************
.*        V5.04.07  07/07/1997  Nick Read      SRF 643160                     *
.*                  Added Address Line 4 to Invoice/Statement Printing        *
.*        V5.04.06  14/06/1997  Steve Armstrong                               *
.*                  Fixed bugs in global recompile                            *
.*        V5.04.05  17/12/1996  Steve Armstrong   SRF 642046                  *
.*                  Fixed bug whereby CALCOUT was resetting the value of      *
.*                  PINVUR so wrong patient master record was read - by       *
.*                  invoice date only.                                        *
.*        V5.04.04  01/11/1996  Steve Armstrong   SRF 642046                  *
.*                  Mods to print THC statements in surname sequence.         *
.*        V5.04.03  22/07/1996  Steve Armstrong                               *
.*                  Recompiled for changes to PATINV15.  SRF 641785           *
.*                  Added form feed for THC prior to printing first page.     *
.*                  Also move THC statement printing 3 chars. to right.       *
.*        V5.04.02  15/06/1996  Greg Horvat      SRF 616143                   *
.*                  Recompiled for PATINVL - Added new statement layout for   *
.*                  MBF - layout 17                                           *
.*        V5.04.01  01/07/1996  Steve Armstrong  Quote 8678                   *
.*                  Mods for new THC layout.                                  *
.*                  Also fixed bug in ageing calculations for HWK. SRF 641xxx *
.*                  Also added "?" for U/R Number.                            *
.*                                                                            *
.* ************************************************************************** *
.*                                                                            *
.*        V5.03.03  04/08/1995  Greg Horvat      SRF 611050                   *
.*                  Recompiled for PATINV16 - Fixed invoice line ups          *
.*        V5.03.02  01/08/1995  Greg Horvat      SRF 610897                   *
.*                  Recompiled for PATDINVS                                   *
.*        V5.03.01  10/07/1995    Justin Coates  SRF 136738                   *
.*                  Recompiled for PATINV16                                   *
.******************************************************************************
.*        V5.03.B1  06/06/95  Paul Howells                  SRF 136735        *
.*                  Recompiled for PATSELFN                                   *
.*        V5.02.01  13/02/1995  Greg Horvat      SRF 134920 134922 134932     *
.*                  Recompiled for IBAPRINT                                   *
.*                                                                            *
.******************************************************************************
.
          INC       STD001FD
          INC       AAEDE1FD/INC
          INC       AAEDEBFD/INC
          INC       AAEDI1FD/INC
          INC       BOKRC1FD/INC
          INC       CHKDIGVR/INC
          INC       EMRVISFD/INC
          INC       IBACONFD/INC
          INC       IBAPRNFD/INC
          INC       IBATMDFD/INC
          INC       IBATMHFD/INC
          INC       IBASECFD/INC
          INC       MLTCFNFD/INC
          INC       NHIMASFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTDTRFD/INC
          INC       OUTPREFD/INC
          INC       OUTSITFD/INC
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       PATCODFD/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATDHEAD/INC
          INC       PATDINVS/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATFACFD/INC
          INC       PATFN1FD/INC
          INC       PATGSRFD/INC
          INC       PATHSPFD/INC
          INC       PATICDFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATITMFD/INC
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
          INC       PMSTLEFD/INC
          INC       PATMI1FD/INC
          INC       PATNOBFD/INC
          INC       PATNIDFD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATSELDT/INC
          INC       PATVISFD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PMSVX1FD/INC
          INC       PMSPRGFD/INC
          INC       PRIINVFD/INC
          INC       PRIPRAFD/INC            * Private Practice Medical Practice
          INC       PMSHCPFD/INC            * Health Care Professional Table
          INC       PMSEVTFD/INC
          INC       SCRPSTFD/INC
          INC       VARGBCRN/INC
          INC       WEBERRFD/INC
          INC       TFILEVAR/INC
          INC       NZHISIFD/INC
.
.-------------------------------------------------------------------
.  TEMP FILES
.-------------------------------------------------------------------
.         Temp File
.
TMPFILO3  IFILE     SQL, FIXED=64, KEY="U1-8"
TMPFILO4  IFILE     SQL, FIXED=64, KEY="U9-28,29-53,1-8"
.
XXURNO    DIM       8         8         1         U/R Number
XXSNAME   DIM      20        20         9         Surname
XXGNAME   DIM      25        25        29         Given Names
XXITYPE   DIM       1         1        54         Priv.Prac only flag (Y=yes)
XXSPARE   DIM       9         9        63
.
.End of Record                         64
.
.-------------------------------------------------------------------
.         West Wimmera Temp File for Printing Statements by U/R
.-------------------------------------------------------------------
.
WTMPFIL1  IFILE     SQL, FIXED=51, KEY="U1-8,9-16,25-25"
WTMPFIL2  IFILE     SQL, FIXED=51, KEY="U26-33,1-8,9-16,25-25"     
.
WWINVDTE  DIM       8         8         1         Invoice Date CCYYMMDD
WWINVNO   DIM       8         8         9         Invoice Number
WWINVTOT  FORM     12.2       8         17        Invoice Total
WWINVSYS  DIM       1         1         25        System
.                                                 1 = A & E          
.                                                 2 = Outpatients    
.                                                 3 = Inpatients     
.                                                 4 = Other Financial
.                                                 5 = Day Centre     
.                                                 P = Private Practice
.                                                 (Diag. Billing at WWH)
WWURNO    DIM       8         8         26        U/R Number
WWADMN    DIM       8         8         34
WWINVBAL  FORM     12.2       8         42        Outstanding Balance
WWSYS     DIM       1         1         50 
.End of Record                          51
.
.
.         Work Variables
.
ADMISSNO  DIM       8
AECNAEIH  DIM       6
AECNAEIT  DIM       6
AGEMASK1  DIM       9               * EDIT field for AGEING[1]
AGEMASK2  DIM       9               * EDIT field for AGEING[2]
AGEMASK3  DIM       9               * EDIT field for AGEING[3]
AGEMASK4  DIM       9               * EDIT field for AGEING[4]
AGEING    FORM      12.2[4]
AMOUNT    FORM      12.2
CDYSDAYS  FORM      6
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CDYSYEAR  FORM      2
CMDLINE   DIM       70
CODE      DIM       2
CURRDATE  DIM       9
CURRENT   FORM      8.2
DAYSDIFF  FORM      2
DIM9      DIM       9
DIM18     DIM       18
DIM30     DIM       30
DIM4      DIM       4
DOCTCODE  DIM       6
DOCNAME   DIM       22
DOPRIVPR  FORM      1
DPSTAT    DIM       25
EDCLM     DIM       3
EDFAC     DIM       3
.ENDFLAG   FORM      1             * finished flag
.                                      0 = more records to print
.                                      1 = no more records to print
EMCNGINV  DIM       1       221        Group Invoice by Service Doctor
ENDFLG    FORM      1
FFFLAG    FORM      1             * form feed flag
.                                      0 = no form feed
.                                      1 = form feed
FORM5     FORM      5
FNAME     DIM       8
FNAME1    DIM       8
FNAME2    DIM       8
.
FROMDAT8  DIM       8
FRSTFLAG  FORM      1             * first record printed flag
.                                      0 = first record not printed
.                                      1 = first record printed
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
HOSPID    DIM       3
HINVDES   DIM       30
HOPTION   FORM      2
HTMLFILE  FIFO      ASCII, FIXED=250
INVDATE   DIM       10            * New Variable for invoice date. SRF 639008
LASTVIST  DIM       8
MAXSEPDY  FORM      "35"
MENUTYPE  DIM       2
NMPNUMB   DIM       20
OTCNOTIH  DIM       6
OTCNOTIT  DIM       6
OVERDUE   FORM      8.2
PAMOUNT   FORM      12.2
PINVOICE  DIM       8
PREVPRAC  DIM       6
PRIVPRAC  FORM      1
PRTALL    FORM      1                  * Indicator to print zero balances
PSZERBAL  FORM      1
PTOTPAT   FORM      8.2
PTOTBAL   FORM      8.2
PTOTREB   FORM      8.2
RECFLG    FORM      1
REGIST8   DIM       2
RMONTH    DIM       3
RUNBAL    FORM      8.2
SERVDOCT  DIM       10
SAVURNO   DIM       8
SAVADMN   DIM       8
SAVSYS    DIM       8 
SCNDGNAM  DIM       40
STATBAL   FORM      12.2
STATTYPE  FORM      1
STCLM     DIM       3
STFAC     DIM       3
STOTBAL   FORM      12.2
SYSDESC   DIM       15       * System Description for Wimmera Statements
TODATE8   DIM       8
TOTBAL    FORM      8.2
TOTREB    FORM      8.2
.
.         Constants
.
CLMFLAG   FORM      "0"
CODECL    INIT      "CL"
.
DMON01    INIT      "Jan"
DMON02    INIT      "Feb"
DMON03    INIT      "Mar"
DMON04    INIT      "Apr"
DMON05    INIT      "May"
DMON06    INIT      "Jun"
DMON07    INIT      "Jul"
DMON08    INIT      "Aug"
DMON09    INIT      "Sep"
DMON10    INIT      "Oct"
DMON11    INIT      "Nov"
DMON12    INIT      "Dec"
FIVE9     FORM      "59"
.
AAEDESC   INIT      "A & E"
OUTDESC   INIT      "Outpatients"
INPDESC   INIT      "Inpatients"
OTHDESC   INIT      "Other Financial"
DAYDESC   INIT      "Day Centre"
.
HYPHEN    INIT      "-"
.
STAT1     INIT      "Patient is pre-admitted "
STAT2     INIT      "Admitted on "
STAT3     INIT      "Discharged on "
STAT4     INIT      "Patient is on leave     "
STAT5     INIT      "Patient is cancelled    "
STATO     INIT      "Outpatient on "
STATE     INIT      "A & E on "
STATFLG   FORM      "1"
.
Z20       INIT      "zzzzzzzzzzzzzzzzzzzz"
Z30       INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
.
PRGID     INIT      "IBAHOS20"
PRGNAM    INIT      "Print Statement"
VERSION   INIT      "V12.00.01"
+
.*********************************************************************
.         what there is of a mainline
.*********************************************************************
ML0000    CALL      INIT0000
.
.         SELECT OPTION
.
START     CALL      OPTN0000
          BRANCH    EXIT,ENDIT
          MOVE      ONE,WEBFLAG
          BRANCH    HOPTION OF OPTION1,OPTION2,OPTION3,KLINEP
          GOTO      START
.
ENDIT     CALL      KILL0000
          CHAIN     PGM
          STOP
+
.
.******************************************************************************
. ------- Line-up Print -------
.
KLINEP    MATCH     "IBARSH",PGM
          GOTO      KLINEP1 IF EQUAL
.
          CALL      OPNPRINT
KLINEP1   CALL      PLINEUP
          DISPLAY   *P1:24,*EL,*V2LON,"***  Line-up Print Generated  ***",*W2;
.
          MATCH     "IBARSH",PGM
          GOTO      START IF EQUAL
.
          CALL      CLSPRINT
          GOTO      START
.
.******************************************************************************
. ------- Option 1 : Single Admission Number -------
.
OPTION1   DISPLAY   *P1:4,*EF,"Billing Number :";
          KEYIN     *P18:4,*V2LON,PVIBILL;
          MATCH     ZEROVISN,PVIBILL
          GOTO      START IF EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF NOVISA
.
          MOVE      PVIURNO,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,NOMAST
.
          MOVE      PFUNDH,AFUNDH           * default HF from master
          MOVE      PFNDTB,AFNDTB
          MOVE      PFNDMM,AFNDMM
          MOVE      PFNDMM,PMVXFNDM
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,NOMAST
.
          MOVE      PVIBILL,AADMNO
          CALL      GETPDET
.
.         Display the basic details for this patient
.
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATWR1A4,"patwr1af"
          CALL      PATHEAD 
          CLOSE     PATDO1A1 
          CALL      DISPB
          CALL      DATAB000
          CALL      CHKPAT
          BRANCH    FORM1,OPT1PROC,OPTION1  * contine,return
          GOTO      START
.
.         Start processing
.
OPT1PROC  MATCH     "IBARSH",PGM
          GOTO      OPT1PRCC IF EQUAL
.
          CALL      OPNPRINT
OPT1PRCC  CALL      PRTSTAT
          DISPLAY   *P1:24,*EL,*V2LON:
                    "***  Print Statement Generation Completed  ***",*W2,*EL
.
          MATCH     "IBARSH",PGM
          GOTO      OPTION1 IF EQUAL
.
          CALL      CLSPRINT
          GOTO      OPTION1
.
.******************************************************************************
. ------- Option 2 : By U/R Number -------
.
OPTION2   MOVE      SP8,PURNO
          DISPLAY   *P1:4,*EF,"U/R Number :";
.
          MOVE      TEN8,CCOL               * set column
          MOVE      FOUR,CVERT              * set row
          MOVE      ZERO,SRCHOPT
          MOVE      ZERO,SRCHSYS            * All systems
          CALL      KURN                    * get U/R keyin
          BRANCH    EXIT,START              * nothing entered
.
          MOVE      PFUNDH,AFUNDH           * default HF from master
          MOVE      PFNDTB,AFNDTB
          MOVE      PFNDMM,AFNDMM
          MOVE      PFNDMM,PMVXFNDM
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
.
          CALL      PRBAL00                 * print zero outstanding option ?
          CALL      KHOS0000                * Keyin hospital ID
.
          CALL      PMIHEAD
.
.         Start processing
.
          DISPLAY   *P1:7,*EF,*P1:8,*V2LON,*ULON,"  Date  ":
                    *P20:8,"Description                          ":
                    *P68:8,"    Amount";
          MOVE      NINE,CVERT
.
.         Zero totals
.
          MOVE      ZERO,TOTBAL
          MOVE      ZERO,TOTREB
          MOVE      ZERO,TOTPAT
          MOVE      ZERO,RECFLG
.
NICK      IF        PTCNINVL=9
            CALL      WWUR0000 * If West Wimmera Layout, process differently
            GOTO      START
          ENDIF
.
.                                           * DISPLAY patient visit Invoices
          MOVE      PURNO,PVIURNO
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2
NXTVISA   CALL      RDKVISA2
          BRANCH    OVRCD OF ENDDPMI
.
          MATCH     PURNO,PVIURNO           * Same U/R ?
          GOTO      ENDDPMI IF NOT EQUAL    * no
          MOVE      PVIBILL,AADMNO
.
          COMPARE   SIX,PVITYPE
          GOTO      NXTVISA IF EQUAL
.
          IF          IBCNMHOS=1
            MATCH       SP10,HOSPID
            IF          !@EQUAL
              PACK        KEY8,PVIBILL,SP8
              CALL        RDPMVX11
              BRANCH      OVRCD,NXTVISA
              MATCH       PMVXMHOS,HOSPID
              GOTO        NXTVISA IF NOT EQUAL
            ENDIF
          ENDIF
.
.         Check for a non-zero balance
.
NXTV005   CALL      CALCOUT                      * calc total for this Visit
          BRANCH    PRTALL,NXTV010               * Print zero balances
          COMPARE   ZERO,STOTBAL
          GOTO      NXTVISA IF EQUAL
.
NXTV010   COMPARE   TWENTY2,CVERT                * was TEN9
          GOTO      NXTV300 IF LESS
.
          MATCH     "IBARSH",PGM
          GOTO      ENDDISP1 IF EQUAL
.
          KEYIN     *P1:24,*EL,"Display more (":
                    *V2LON,*DV,ANSY,*HOFF,*DV,SLASH,*V2LON,*DV,ANSN,*HOFF:
                    ") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
.
          MATCH     ANSN,ANS
          GOTO      ENDDISP1 IF EQUAL
          DISPLAY   *P1:9,*EF;
          MOVE      NINE,CVERT
.
NXTV300   MOVE      PVIBILL,AADMNO
          DISPLAY   *P1:CVERT,*EL,"Admission No. ",AADMNO;
          ADD       TWO,CVERT
.
          MOVE      ZERO,EXIT
          MOVE      ONE,RECFLG              * found an invoice
.
          CALL      DISPINV0                * display PMI Invoices
          BRANCH    EXIT,ENDDISP1
.
          GOTO      NXTVISA
.
.
.                   Check for Private Practice Invoices
ENDDPMI   MOVE      ZERO,EXIT               * end of PMI Invoices
          MOVE      ONE,DOPRIVPR            * set Private Practice switch
          CALL      DSPP0000                * print any Private Practice Invs.
.
ENDDALL   MOVE      ZERO,EXIT               * end of all Invoices
.
ENDDISP   CALL      DISPIN11                * Display payment due to patient/HF.
.
ENDDISP1  CALL      CHKPAT
          BRANCH    FORM1,OPT2PROC,OPTION2
          GOTO      START
.
.******************************************************************************
.                   prepare to Print the statement     *******
.
OPT2PROC  BRANCH    PRTALL,OPT2PRO1         * to print zero total amount
.
.         to print non zero amount only
.
          COMPARE   ZERO,RECFLG
          GOTO      ENDPR10 IF EQUAL        * no rec.found with non zero amount
.
OPT2PRO1  MATCH     "IBARSH",PGM
          GOTO      OPT2PRO2 IF EQUAL
.
          CALL      OPNPRINT
.
.         If statement for THC, then call separate routines to print
.
OPT2PRO2  IF        PTCNSTMT = 1
            CALL      GTHC0000
            GOTO      ENDPRS1               * finished printing THC statement
          ENDIF
.
          MOVE      ZEROVISN,AADMNO             * no admission no.
          MOVE      SP10,ADATE
          MOVE      SP10,ATIME
          MOVE      SP10,DDATE
          MOVE      SP10,DTIME
          MOVE      SP10,A8DATE
          MOVE      SP10,D8DATE
          PACK      KEY50,SP20,SP20,SP20
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPDATE,B8DATE
          MOVE      CPCDATE,B10DATE
.
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          MOVE      PFNDMM,AFNDMM
          MOVE      PFNDMM,PMVXFNDM
          MOVE      SP30,HFNAME
          MOVE      SP30,TABLNM
          MOVE      SP70,TABLNN
          CLEAR     KEY14
          APPEND    AFUNDH,KEY14
          APPEND    "0000",KEY14
          RESET     KEY14
          OPEN      PATFN1A1,"patfn1af"
          CALL      RDFUND1
.
          MOVE      HFNAME,FUNDNM
.
          MOVE      SP30,HFNAME
          PACK      KEY14,AFUNDH,AFNDTB,SP10
          CALL      RDFUND1
          CLOSE     PATFN1A1
.
          MOVE      HFNAME,TABLNM
          MOVE      AFNDMM,TABLNN
          CALL      GETPNAM
          CALL      GETPRES                 * uses AADMNO="       0"
.
          MOVE      ZERO,TOTBAL
          MOVE      ZERO,TOTREB
          MOVE      ZERO,TOTPAT
          MOVE      ZERO,PAGENO
.
.                   Print the statement heading section
.
OPT2PRO3  MOVE      "3",PINVSYS             * use Inpatient Heading   *I-140395
          MOVE      "3",PVITYPE                                       *I-140395
          MOVE      ZEROVISN,AADMNO             * print zero admission number
          CALL      HEAD                    * for the heading
.kkkkk
.
          MOVE      PURNO,PVIURNO
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2
NXTPATS   CALL      RDKVISA2
          BRANCH    OVRCD OF ENDPMII        * end of PMI invoices
.
          MATCH     PURNO,PVIURNO
          GOTO      ENDPMII IF NOT EQUAL
          MOVE      PVIBILL,AADMNO
.
          COMPARE   SIX,PVITYPE
          GOTO      NXTPATS IF EQUAL
.
          IF          IBCNMHOS=1
            MATCH       SP10,HOSPID
            IF          !@EQUAL
              PACK        KEY8,PVIBILL,SP8
              CALL        RDPMVX11
              BRANCH      OVRCD,NXTPATS
              MATCH       PMVXMHOS,HOSPID
              GOTO        NXTPATS IF NOT EQUAL
            ENDIF
          ENDIF
.
.                                           * check if outpatients    *I-140395
OPT2PRO4  IF        PINVSYS = 2 | PINVSYS = 4
            MATCH     PVISITE,OSTSITE
            GOTO      NXTP005 IF EQUAL
.           
            MOVE      SP3,OSTSYST
            MOVE      PVISITE,KEY6
            CALL      RDSITA1
            CLOSE     OUTBB1A1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            PACK      CFNAME,OSTFILE,FILBB1A1
            CALL      OPOTBB11
            TRAPCLR   IO
            BRANCH    OVRCD,NXTPATS         * file not found, ignore
          ENDIF
.
.         Check for a non-zero balance
.
NXTP005   CALL      CALCOUT                      * calc total for this Visit
          BRANCH    PRTALL,NXTP010          * Print zero balances
          COMPARE   ZERO,STOTBAL
          GOTO      NXTPATS IF EQUAL
.
NXTP010   COMPARE   TWO,PTCNINVL            * Anne Caudle invoice ?
          GOTO      NXTP020 IF NOT EQUAL    * no
          COMPARE   TWENTY3,COUNT
          GOTO      NXTP050 IF LESS
          GOTO      NXTP040 IF NOT EQUAL
          GOTO      NXTP030
.
NXTP020   IF        PTCNINVL=6
            COMPARE   TWENTY7,COUNT
          ELSE
            COMPARE   TWENTY1,COUNT
          ENDIF
          GOTO      NXTP050 IF LESS
          GOTO      NXTP040 IF NOT EQUAL
.
NXTP030   PRINT     *N;
          ADD       ONE,COUNT
.
NXTP040   CALL      TLHEAD
.
NXTP050   PRINT     *1,"Admission No.:",AADMNO,*N
          ADD       TWO,COUNT
          CALL      PRTIVADM
          GOTO      NXTPATS
.
ENDPMII   MOVE      ZERO,EXIT               * end of PMI Invoices             
          MOVE      ONE,DOPRIVPR            * set Private Practice switch
          CALL      FWPP0000                * print any Private Practice Invs.
.
ENDALLI   MOVE      ZERO,EXIT               * end of all Invoices             
.
          COMPARE   ZERO,RECFLG
          GOTO      ENDPR10 IF EQUAL        * no rec.found with non zero amount
.
          MOVE      TOTBAL,NETTOT           * set NETTOT for PATINVTL *I-140395
          CALL      CHKLINE                 * print payment due to patient/HF.
.
ENDPRS1   DISPLAY   *P1:24,*EL,*V2LON:
                    "***  Print Statement Generation Completed  ***",*W2;
.
          MATCH     "IBARSH",PGM
          GOTO      OPTION2 IF EQUAL
.
          CALL      CLSPRINT
          GOTO      OPTION2
.
ENDPR10   DISPLAY   *P1:24,*EL,*B,"No Statement Found.  ";
          CALL      HITENTER
          GOTO      OPTION2
.
.******************************************************************************
.         Check which system this is from to determine
.         what other data needs to be read in, and from where
.
.******************************************************************************
GETPDET   BRANCH    PVITYPE OF AAEDAT,OUTDAT,INPDAT,OTHDAT,INVTYP,NOADMN
          GOTO      NOADMN
.
.         Inpatient data needed
.
INPDAT    MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF NOADMN
.
          MOVE      SP8,DDATE
          MOVE      SP3,DSTAT
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          GOTO      ENDPDET
.
.         Outpatient data needed
.
OUTDAT    MOVE      "out",OSTFILE
          MOVE      PVISITE,KEY6
          CALL      RDSITA1
.
          CLOSE     OUTBB1A2
          PACK      CFNAME,OSTFILE,FILBB1A2
          CALL      OPOTBB12
.
          PACK      KEY16,PVIDATE,PVIBILL
          CALL      RDBOKB2
          BRANCH    OVRCD,NOOUTB
.
          MOVE      PVIURNO,OBAURNO
          MOVE      PVISITE,OBASITE
          UNPACK    OBADATE,ADATE     * Initialize ADATE
          MOVE      SP10,DDATE
          GOTO      ENDPDET
.
.         A & E data needed
.
AAEDAT    MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD OF NOAAED
.
          UNPACK    ADADATE,ADATE     * Initialize ADATE
          MOVE      SP10,DDATE
          GOTO      ENDPDET
.
.         Other Financial data needed
.
OTHDAT    UNPACK    PVIDATE WITH,ADATE
          MOVE      SP10,DDATE
          MOVE      "out",OSTFILE
ENDPDET   RETURN
+
.******************************************************************************
.
.******************************************************************************
CHKPAT    MOVE      SP1,ANS
          MOVE      ZERO,FORM1
          MOVE      ZERO,AGEING[1]
          MOVE      ZERO,AGEING[2]
          MOVE      ZERO,AGEING[3]
          MOVE      ZERO,AGEING[4]
.
          MATCH     "IBARSH",PGM
          MOVE      "Y",ANS
          GOTO      CHKPAT1 IF EQUAL
.
          KEYIN     *P1:24,*EL,"Correct Patient (":
                    *V2LON,*DV,ANSY,*HOFF,*DV,SLASH,*V2LON,*DV,ANSN:
                    *HOFF,*DV,SLASH,*V2LON,*DV,ANSC,*HOFF,") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
.
          MATCH     ANSY,ANS
          GOTO      CHKPAT1 IF EQUAL
          MATCH     ANSN,ANS
          GOTO      CHKPAT1 IF EQUAL
          MATCH     ANSC,ANS
          GOTO      CHKPAT1 IF EQUAL
          BEEP
          GOTO      CHKPAT
.
CHKPAT1   REP       "Y1y1N2n2C3c3",ANS
          MOVE      ANS,FORM1
          RETURN
.
.******************************************************************************
.                         Messages for Option 1 & 2
.
.******************************************************************************
NOVISA    DISPLAY   *P1:24,*EL,*B,"Billing Number does not Exist.  ";
          CALL      HITENTER
          GOTO      OPTION1
.
INVTYP    DISPLAY   *P1:24,*EL,*B,"Invalid Visit Type.  ";
          CALL      HITENTER
          GOTO      OPTION1
.
NOADMN    DISPLAY   *P1:24,*EL,*B,"Admission Number does not Exist.  ";
          CALL      HITENTER
          GOTO      OPTION1
.
NOOUTB    DISPLAY   *P1:24,*EL,*B,"Outpatient Number does not Exist.  ";
          CALL      HITENTER
          GOTO      OPTION1
.
NOAAED    DISPLAY   *P1:24,*EL,*B,"A & E  Number does not Exist.  ";
          CALL      HITENTER
          GOTO      OPTION1
.
NOMAST    DISPLAY   *P1:24,*EL,*B,"U/R Number ",PURNO," does not Exist.  ";
          CALL      HITENTER
          BRANCH    HOPTION,OPTION1,OPTION2
          GOTO      OPTION1
.
.******************************************************************************
. ------- Option 3 : Range of invoice dates -------
.
.******************************************************************************
OPTION3   DISPLAY   *P48:2,*V2LON,"- Range of Invoice Dates ";
.
OPT3SDAT  DISPLAY   *P1:13,"Starting Date       : ",*EF;
          MOVE      TEN3,CVERT
          MOVE      TWENTY3,CCOL
          MOVE      CCC,CCENT
.
OPT3DAT1  UNPACK    SP6,CYEAR,CMON,CDAY
          CALL      KEYDATE
          BRANCH    CQUEST,OPT3DAT1
          BRANCH    OVRCD,START
.
          PACK      FROMDAT8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",FROMDAT8
.
          MOVE      TEN4,CVERT
          DISPLAY   *P1:CVERT,"Ending   Date       : ",*EF;
.
OPT3DAT2  UNPACK    FROMDAT8,CCENT,CYEAR,CMON,CDAY
          CALL      KEYDATE
          BRANCH    CQUEST,OPT3DAT2
.
          PACK      TODATE8 WITH CCENT,CYEAR,CMON,CDAY
          REP       " 0",TODATE8
.
          MATCH     FROMDAT8,TODATE8
          GOTO      INVDTE01 IF LESS
          GOTO      GETRNGE
.
INVDTE01  DISPLAY   *P1:24,*EL,*B,"Invalid date range.  ";
          CALL      HITENTER
          GOTO      OPT3SDAT
.
.         Get range of claim codes
.
.         ** Starting Claim Code **
.
GETRNGE   MOVE      SP3,STCLM
          KEYIN     *P1:16,"Starting Claim Code : ",*DV,UNDLN3,*EF:
                    *P23:16,*V2LON,STCLM;
          RESET     STCLM
          GOTO      FRSTCLM IF EOS
.
          ENDSET    STCLM
          APPEND    SP3,STCLM
          RESET     STCLM
.
          MATCH     SP3,STCLM
          GOTO      FRSTCLM IF EQUAL
          DISPLAY   *P23:16,*EL,*V2LON,STCLM;
.
          PACK      KEY5,CODECL,STCLM
          CALL      RDCODE1
          BRANCH    OVRCD,GETSCLM1
          DISPLAY   *P30:16,TDESC;
          GOTO      GETECLM
.
GETSCLM1  DISPLAY   *P1:24,*EL,*B,"Invalid Claim Code.  ";
          CALL      HITENTER
          GOTO      GETRNGE
.
FRSTCLM   DISPLAY   *P23:16,*EL,*V2LON,"Start";
          MOVE      SP3,STCLM
.
.         ** Ending Claim Code **
.
GETECLM   MOVE      SP3,EDCLM
          KEYIN     *P1:17,"Ending   Claim Code : ",*DV,UNDLN3,*EF:
                    *P23:17,*V2LON,EDCLM;
          RESET     EDCLM
          GOTO      LASTCLM IF EOS
.
          ENDSET    EDCLM
          APPEND    SP3,EDCLM
          RESET     EDCLM
.
          MATCH     SP3,EDCLM
          GOTO      LASTCLM IF EQUAL
          DISPLAY   *P23:17,*EL,*V2LON,EDCLM;
.
          PACK      KEY5,CODECL,EDCLM
          CALL      RDCODE1
          BRANCH    OVRCD,GETECLM1
          DISPLAY   *P30:17,TDESC;
          GOTO      CHKVRNG
.
GETECLM1  DISPLAY   *P1:24,*EL,*B,"Invalid Claim Code.  ";
          CALL      HITENTER
          GOTO      GETECLM
.
LASTCLM   DISPLAY   *P23:17,*EL,*V2LON,"Finish";
          MOVE      "ZZZ",EDCLM
.
CHKVRNG   MATCH     STCLM,EDCLM
          GOTO      GETRNGE2 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B,"Invalid Claim Code range.  ";
          CALL      HITENTER
          GOTO      GETRNGE
.
GETRNGE2  IF        PTCNSUFA=1    
            CALL      GFAC0000               * get future action codes range
            BRANCH    EXIT,OPTION3           * exitchar
          ENDIF
.
OKCONT    CALL      CONTQST                      * Ok to continue ?
          BRANCH    CEXIT,OPT3PARM:              * yes
                          OPT3SDAT:              * no
                          START                  * cancel
.
.         Check that these parameters are correct
.
OPT3PARM  CALL      PSZB0000                * print stats with 0 balance?
          CALL      WHTS0000                * print what on statements?
          BRANCH    EXIT,OPT3PARM
.
          CALL      PRBAL00                 * print zero outstanding option ?
.
          CALL      PATSELFN
          BRANCH    EXIT,OP3T9999
          CALL      KHOS0000                * Keyin hospital ID
.
.
.         Loop over invoice file, and print statements for everyone
.
OPT3PROC  MATCH     "IBARSH",PGM
          GOTO      OPT3PRCC IF EQUAL
.
          CALL      OPNPRINT
.
OPT3PRCC  CALL      CRET0000                * open/create temp file
.
          DISPLAY   *P1:24,*EL,*V2LON,*P26:24,"***  Generating Statements  ***":
                    *HOFF,*P1:24,*EL,*P29:24,"Scanning : ";
.
          IF        PTCNINVL=9
              CALL      WWDT0000
              GOTO      START
          ENDIF
.
.         Read through the Invoice file for Date Range
.
INV       PACK      KEY16,FROMDAT8,SP10
          CALL      RDSINV2
OP3T0100  CALL      RDKINV2
          BRANCH    OVRCD,OP3T4000
.
          MATCH     PINVDTE,TODATE8
          GOTO      OP3T4000 IF LESS
.
          IF        IBCNMHOS=1
            MATCH     SP10,HOSPID
            IF        !@EQUAL
              PACK      KEY8,PINVADM,SP8
              CALL      RDPMVX11
              BRANCH    OVRCD,OP3T0100
              MATCH     PMVXMHOS,HOSPID
              GOTO      OP3T0100 IF NOT EQUAL
            ENDIF
          ENDIF
.
          IF        (FSTSYS > PINVSYS) | (PINVSYS > FEDSYS)
              GOTO      OP3T0100            * not in range so ignore
          ENDIF
.
          BRANCH    PTCNSUFA,OP3T0200        * using future action codes
          GOTO      OP3T0300                 * not using future action codes
.
.---ignore if we have a Future Action Code within range
.
.                                            * start at invoice date
OP3T0200  PACK      KEY19,PINVADM,PINVDTE,SP20
          CALL      RDSFACT1
.
OP3T0250  CALL      RDKFACT1
          BRANCH    OVRCD,OP3T0300
.
OP3T0260  MATCH     FADMNO,PINVADM           * same admission number?
          GOTO      OP3T0300 IF NOT EQUAL
.
.---check ranges
          MATCH     STFAC,FACODE             
          GOTO      OP3T0250 IF LESS
          MATCH     FACODE,EDFAC             
          GOTO      OP3T0250 IF LESS
          DISPLAY   *P40:24,*EL,"Suppressing : ",PINVADM;
          GOTO      OP3T0100                 * within supress range so ignore
.
.                     Invoice is within all ranges - process it
.
OP3T0300  IF        PINVSYS = 2 | PINVSYS = 4
            MATCH     FSTSITE,PINVSITE
            GOTO      OP3T0100 IF LESS
            MATCH     PINVSITE,FEDSITE
            GOTO      OP3T0100 IF LESS
.
            MOVE      "out",OSTSITE
            MOVE      SP3,OSTSYST
            MOVE      PINVSITE,KEY6
            CALL      RDSITA1
.
            MATCH     FSTDEPT,OSTSYST
            GOTO      OP3T0100 IF LESS
            MATCH     OSTSYST,FEDDEPT
            GOTO      OP3T0100 IF LESS
.
            CLOSE     OUTBB1A1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            PACK      CFNAME,OSTFILE,FILBB1A1
            CALL      OPOTBB11
            TRAPCLR   IO
            BRANCH    OVRCD,OP3T0100        * file not found, ignore
          ENDIF
.
.         Check for a valid claim code
.
          MATCH     STCLM,PINVCLM
          GOTO      OP3T0100 IF LESS
.
          MATCH     PINVCLM,EDCLM
          GOTO      OP3T0100 IF LESS
.
          MOVE      PINVUR,XXURNO           * post this U/R to temp file
.
.                             A&E      OUT      INP
OP3T0500  BRANCH    PINVSYS,OP3T1000,OP3T2000,OP3T3000
          GOTO      OP3T0100
.
.         A & E patients
.         ==============
.
OP3T1000  DISPLAY   *P40:24,"AE ",*EL,PINVADM;
.
          MOVE      PINVADM,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,OP3T0100
.
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,OP3T0100
.
.         Check for a non-zero balance
.
          MOVE      ZERO,DOPRIVPR                * set for PMI. system
          CALL      WCAL0000                     * calculate outstand. balance
.
          IF        PRTALL <> 1 & STOTBAL = 0.00
            GOTO      OP3T0100
          ENDIF
.
          MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,OP3T0100
.
          PACK      KEY8,PINVUR,SP8
          CALL      RATEMP1
          IF        OVRCD = 1
            MOVE      PINVUR,XXURNO
            MOVE      PGNAME,XXGNAME
            MOVE      PSNAME,XXSNAME
            UNPACK    SP10,XXITYPE,XXSPARE
            CALL      WRTEMP1
          ENDIF
          GOTO      OP3T0100
.
.         Outpatients
.         ===========
.
OP3T2000  PACK      KEY8,PINVADM
          CALL      RDBOKB1
          BRANCH    OVRCD,OP3T0100
.
          DISPLAY   *P40:24,OSTFILE," ",*EL,PINVADM;
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF OP3T0100
.
.         Check for a non-zero balance
.
          MOVE      ZERO,DOPRIVPR                * set for PMI. system
          CALL      WCAL0000                     * calculate outstand. balance
.
          IF        PRTALL <> 1 & STOTBAL = 0.00
            GOTO      OP3T0100
          ENDIF
.
          MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF OP3T0100
.
          PACK      KEY8,PINVUR,SP8
          CALL      RATEMP1
          IF        OVRCD = 1
            MOVE      PINVUR,XXURNO
            MOVE      PGNAME,XXGNAME
            MOVE      PSNAME,XXSNAME
            UNPACK    SP10,XXITYPE,XXSPARE
            CALL      WRTEMP1
          ENDIF
          GOTO      OP3T0100
.
.         Inpatients
.         ==========
.
OP3T3000  MOVE      PINVADM,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,OP3T0100
.
          DISPLAY   *P40:24,"IP ",*EL,PINVADM;
.
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF OP3T0100
.
.         Check for a non-zero balance
.
          MOVE      ZERO,DOPRIVPR                * set for PMI. system
          CALL      WCAL0000                     * calculate outstand. balance
.
          IF        PRTALL <> 1 & STOTBAL = 0.00
            GOTO      OP3T0100
          ENDIF
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF OP3T0100
.
          PACK      KEY8,AURNO,SP8
          CALL      RATEMP1
          IF        OVRCD = 1
            MOVE      AURNO,XXURNO
            MOVE      PGNAME,XXGNAME
            MOVE      PSNAME,XXSNAME
            UNPACK    SP10,XXITYPE,XXSPARE
            CALL      WRTEMP1
          ENDIF
          GOTO      OP3T0100
.
.                   now check for Private Practice Invoices
.
OP3T4000  MOVE      ZERO,EXIT
          IF        (FSTSYS <> FEDSYS) | (FSTSYS = 4)
            CALL      PPDT0000              * read Priv.Prac by Date Range
          ENDIF
.
.*****************************************************************************
. we have finished loading data so print details for each UR No.
.
OP3T5000  MOVE      ZERO,FFFLAG 
.
          IF        PTCNSTMT = 1
            PACK      KEY53,SP30,SP30       * Surname sequence
            CALL      RSTEMP2
          ELSE
            PACK      KEY8,SP8              * UR sequence
            CALL      RSTEMP1
          ENDIF
.
OP3T5100  IF        PTCNSTMT = 1
            CALL      RKTEMP2
          ELSE
            CALL      RKTEMP1
          ENDIF
OP3T5500  BRANCH    OVRCD,OP3T9000
.
          CALL      ZBAL0000                * determine statement balance
          MOVE      LASTVIST,AADMNO         * print last admission number
.
. check whether or not to print zero balance statements
.
          IF        (PSZERBAL=0) & (STATBAL=0)
            GOTO      OP3T5100
          ENDIF
.
. determine whether to print credit/non credit statements or ALL statements
.
          IF        STATTYPE<>1
            IF        STATTYPE=2
              COMPARE   ZERO,STATBAL
              GOTO      OP3T5100 IF LESS         * credit. ignore if < 0
            ELSE
              COMPARE   ZERO,STATBAL
              GOTO      OP3T5100 IF NOT LESS     * non credit. ignore if >= 0
            ENDIF
          ENDIF
.
          MOVE      ZERO,DOPRIVPR
          CALL      SAGE0000
.
.
          MOVE      XXURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,OP3T5100
.
.         If we are using THC statement layout, then call appropriate routines.
.         If this is the first U/R to be printed, then we don't need to form
.         feed, but we do for subsequent U/R's.
.
          IF        PTCNSTMT = 1
            IF        FFFLAG = 1
              PRINT     *F
            ENDIF
            CALL      GTHC0000                   * THC layout
            MOVE      ONE,FFFLAG
            GOTO      OP3T5100                   * get next U/R
          ENDIF
.
          MOVE      SP10,ADATE
          MOVE      SP10,ATIME
          MOVE      SP10,DDATE
          MOVE      SP10,DTIME
          MOVE      SP10,A8DATE
          MOVE      SP10,D8DATE
          MOVE      SP10,A10DATE
          MOVE      SP10,D10DATE
          PACK      KEY50,SP20,SP20,SP20
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPDATE,B8DATE
          MOVE      CPCDATE,B10DATE
.
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          MOVE      PFNDMM,AFNDMM
          MOVE      PFNDMM,PMVXFNDM
          MOVE      SP30,HFNAME
          MOVE      SP30,TABLNM
          MOVE      SP70,TABLNN
          CLEAR     KEY14
          APPEND    AFUNDH,KEY14
          APPEND    "0000",KEY14
          RESET     KEY14
          OPEN      PATFN1A1,"patfn1af"
          CALL      RDFUND1
.
          MOVE      HFNAME,FUNDNM
.
          MOVE      SP30,HFNAME
          PACK      KEY14,AFUNDH,AFNDTB,SP10
          CALL      RDFUND1
.
          MATCH     "Y",XXITYPE             * processing Priv.Prac. only ?
          IF        @EQUAL
            CALL      CLPATVIS
            GOTO      OP3T6100              * now CALL HEAD (??)
          ENDIF
.
.**************************************************************************
.         Get the last visit for this U/R Number, and use their
.         person responsible for the account details
.
          MOVE      XXURNO,PVIURNO
          PACK      KEY24,PVIURNO,Z20
          CALL      RDSVISA2
OP3T6000  CALL      RDPVISA2                * read the UR's last Visit record
          BRANCH    OVRCD OF OP3T6100
.
          MATCH     XXURNO,PVIURNO
          GOTO      OP3T6100 IF NOT EQUAL
          MOVE      PVIBILL,AADMNO
.
          COMPARE   SIX,PVITYPE
          GOTO      OP3T6000 IF EQUAL
.
.         Check for a non-zero balance
.
.                                                * CALCOUT uses PVIBILL & TODATE
          CALL      CALCOUT                      * calc total for this Visit
          IF        NUMINVS = 0
            GOTO      OP3T6000
          ENDIF
.
          BRANCH    PRTALL,OP3T6100         * Print zero balances
          COMPARE   ZERO,STOTBAL
          GOTO      OP3T6000 IF EQUAL
.
.         Set up P.R.A. and patients name
.
OP3T6100  MOVE      HFNAME,TABLNM
          MOVE      AFNDMM,TABLNN
          CALL      GETPNAM
          CALL      GETPRES
.
          MOVE      ZERO,TOTBAL
          MOVE      ZERO,TOTREB
          MOVE      ZERO,TOTPAT
          MOVE      ZERO,PAGENO
.
.         Print the statement heading section
.
          MOVE      ZERO,AGEING[1]
          MOVE      ZERO,AGEING[2]
          MOVE      ZERO,AGEING[3]
          MOVE      ZERO,AGEING[4]
          MOVE      ZEROVISN,AADMNO
          CALL      HEAD                    * for the heading
.
          MATCH     "Y",XXITYPE             * processing Priv.Prac. only ?
          GOTO      OP3T8000 IF EQUAL
.
.*****************************************************************************
.           Heading now finished - print the Statement
.
          MOVE      XXURNO,PVIURNO
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2
OP3T7000  CALL      RDKVISA2                * read the UR's first Visit
          BRANCH    OVRCD OF OP3T8000
.
          MATCH     XXURNO,PVIURNO
          GOTO      OP3T8000 IF NOT EQUAL
.
          COMPARE   SIX,PVITYPE
          GOTO      OP3T7000 IF EQUAL
.
          MOVE      PVIBILL,AADMNO
.
.         Check for a non-zero balance
.
          CALL      CALCOUT                      * calc total for this Visit
          IF        NUMINVS = 0
            GOTO      OP3T7000
          ENDIF
          BRANCH    PRTALL,OP3T7100         * Print zero balances
          COMPARE   ZERO,STOTBAL
          GOTO      OP3T7000 IF EQUAL
.
OP3T7100  COMPARE   TWO,PTCNINVL            * Anne Caudle invoice ?
          GOTO      OP3T7200 IF NOT EQUAL   * no
          COMPARE   TWENTY3,COUNT           * yes
          GOTO      OP3T7500 IF LESS
          GOTO      OP3T7400 IF NOT EQUAL
          GOTO      OP3T7300
.
OP3T7200  IF        PTCNINVL=6
            COMPARE   TWENTY7,COUNT
          ELSE
            COMPARE   TWENTY1,COUNT
          ENDIF
          GOTO      OP3T7500 IF LESS
          GOTO      OP3T7400 IF NOT EQUAL
.
OP3T7300  PRINT     *N;
          ADD       ONE,COUNT
.
OP3T7400  CALL      TLHEAD
.
OP3T7500  IF        PTCNINVL<>9
              PRINT     *1,"Admission No.:",AADMNO,*N
              ADD       TWO,COUNT
          ENDIF
.
          CALL      PRTIVADM
          GOTO      OP3T7000
.
.                   finished all PMI Invoices - check for Private Practice
OP3T8000  MOVE      ZERO,EXIT
.
          IF        (FSTSYS <> FEDSYS) | (FSTSYS = 4)
            MOVE      ONE,DOPRIVPR          * set Private Practice switch
            CALL      FWPP0000              * print any Private Practice Invs.
          ENDIF
.
          MOVE      TOTBAL,NETTOT           * set NETTOT for PATINVTL *I-140395
          CALL      CHKLINE                 * print payment due to patient/HF.
          GOTO      OP3T5100
.
.    Finished generating all statements
.
OP3T9000  DISPLAY   *P1:24,*EL,*V2LON:
                    "***  Statement(s) Generation Completed  ***",*W2;
.
          MATCH     "IBARSH",PGM
          GOTO      OP3T9999 IF EQUAL
.
          CALL      CLSPRINT
.
.         Redisplay Main Menu after having called PATSELFN
.
OP3T9999  BRANCH    PTCNSTMT,OP3U9999
.
          DISPLAY   *P1:4,*EF,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = Billing Number":
                    *P1:6,*V2LON,TWO,*HOFF," = U/R Number":
                    *P1:7,*V2LON,THREE,*HOFF," = Range of Invoice Dates":
                    *P1:8,*V2LON,FOUR,*HOFF," = Line-up Print":
                    *P1:10,"Select Option : ",*V2LON,THREE;
          GOTO      OPT3SDAT
.
OP3U9999  DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = U/R Number":
                    *P1:6,*V2LON,TWO,*HOFF," = Range of Invoice Dates":
                    *P1:7,*V2LON,THREE,*HOFF," = Line-up Print":
                    *P1:9,"Select Option : ";
          GOTO      OPT3SDAT
.
+
.**************************************************************************
.*  ZBAL0000  :  Check if statement has a zero balance                    *
.*               Requires: XXURNO  -  current U/R No.                     *
.**************************************************************************
ZBAL0000  MOVE      XXURNO,PVIURNO
          MOVE      ZERO,STATBAL            * init statement balance
          MOVE      ZERO,LASTVIST           * last visit number
.
          MATCH     "Y",XXITYPE             * Priv.Prac. only ?
          GOTO      ZBAL5000 IF EQUAL
.
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2
.
ZBAL1000  CALL      RDKVISA2
          BRANCH    OVRCD,ZBAL5000
.
          MATCH     PVIURNO,XXURNO
          GOTO      ZBAL5000 IF NOT EQUAL
.
          COMPARE   SIX,PVITYPE
          GOTO      ZBAL1000 IF EQUAL
.
. now calculate amount outstanding for this patient
.
          CALL      CALCOUT                      * calc total for this Visit
          ADD       STOTBAL,STATBAL              * add to statement balance
.
          MATCH     PVIDATE,TODATE8
          GOTO      ZBAL1000 IF LESS
          MOVE      PVIBILL,LASTVIST        * save last visit number
          GOTO      ZBAL1000
.
.
ZBAL5000  PACK      KEY18,XXURNO,SP20
          CALL      RSPRIN3                      * position in file

ZBAL6000  CALL      RKPRIN3                      * read next record
          BRANCH    OVRCD,ZBAL9999               * eof - finished
.
          MATCH     XXURNO,PRINDEBT              * same debtor ?
          GOTO      ZBAL9999 IF NOT EQUAL        * no - finished
.
          IF        PRINSCAN<>1
              GOTO      ZBAL6000                 * not PMI patient
          ENDIF
.
          IF        HOPTION = 3
            MATCH     PRINDATE,TODATE8
            GOTO      ZBAL6000 IF LESS
.                                                * Check for a valid claim code
            MATCH     STCLM,PRINCLAM
            GOTO      ZBAL6000 IF LESS
.
            MATCH     PRINCLAM,EDCLM
            GOTO      ZBAL6000 IF LESS
          ENDIF
.
          MOVE      ONE,DOPRIVPR                 * set for PRI. system
          CALL      WCAL0000                     * calculate outstand. balance
          ADD       STOTBAL,STATBAL
          GOTO      ZBAL6000
.
ZBAL9999  RETURN
+
.*************************************************************************
.*  PSZB0000  :  Ask 'Print statements with a Zero balance?'              *
.*               Returns PSZERBAL : 0=No ; 1=Yes                          *
.**************************************************************************
PSZB0000  DISPLAY   *P1:12,*EF:
                    *P1:13,"Print statements with a zero balance (",*V2LON:
                    "Y",*HOFF,"/",*V2LON,"N",*HOFF,")? ";
.
PSZB1000  KEYIN     *P45:13,*EL,*DV,UNDLN1,*P45:13,*V2LON,ANS;
          REP       UPPLOW,ANS
.
          MATCH     ANSY,ANS
          IF        @EQUAL
            DISPLAY   *P45:13,*EL,*V2LON,"Yes";
            MOVE      ONE,PSZERBAL          * print stat. with 0 balance
            GOTO      PSZB9999
          ENDIF
.
          MATCH     ANSN,ANS
          IF        @EQUAL
            DISPLAY   *P45:13,*EL,*V2LON,"No";
            MOVE      ZERO,PSZERBAL         * dont print stat. with 0 balance
            GOTO      PSZB9999
          ELSE
            BEEP
            GOTO      PSZB1000
          ENDIF
.
PSZB9999  RETURN
+
.**************************************************************************
.*  WHTS0000  :  What sort of statement to print ?                        *
.**************************************************************************
WHTS0000  DISPLAY   *P1:15,*V2LON,"0",*HOFF," = Exit":
                    *P1:16,*V2LON,"1",*HOFF," = All statements":
                    *P1:17,*V2LON,"2",*HOFF," = Non-credit balance statement":
                    *P1:18,*V2LON,"3",*HOFF," = Credit balance statement":
                    *P1:20,"Select Option : ";
.
WHTS1000  KEYIN     *P17:20,*EL,*DV,UNDLN1,*P17:20,*V2LON,STATTYPE;
.
          IF        STATTYPE=0
            MOVE      ONE,EXIT
            GOTO      WHTS9999
          ENDIF
.
          IF        (STATTYPE<1) | (STATTYPE>3)
            BEEP
            GOTO      WHTS1000
          ENDIF
          MOVE      ZERO,EXIT
.
WHTS9999  RETURN
+
.**************************************************************************
.*  PRBAL00  : Option to print zero balance outstanding                   *
.**************************************************************************
PRBAL00   MOVE      ANSN,ANS
          KEYIN     *P1:20,*EL,"Do you want to print invoices with zero ":
                    "amount outstanding (",*V2LON,"Y",*HOFF,"/",*V2LON,"N":
                    *HOFF,") ? ",*P68:20,*DV,ANS,*P68:20,*V2LON,ANS;
          RESET     ANS
          REP       UPPLOW,ANS
          MATCH     ANSY,ANS
          GOTO      PRBAL10 IF EQUAL
          MATCH     ANSN,ANS
          GOTO      PRBAL20 IF EQUAL
          BEEP
          GOTO      PRBAL00
.
PRBAL10   MOVE      ONE,PRTALL         * to print zero balances
          GOTO      PRBAL99
.
PRBAL20   MOVE      ZERO,PRTALL        * do not print zero balances
PRBAL99   RETURN
+
.*******************************************************************************
.       Keyin hospital ID
.*******************************************************************************
KHOS0000  MOVE       ZERO,EXIT
          MOVE       SP70,HOSPID
          COMPARE    ONE,IBCNMHOS
          GOTO       KHOS9999 IF NOT EQUAL
.
          DISPLAY    *P1:22,*EL,"Hospital Id : ";
          MOVE       TEN5,ECOL
          MOVE       "22",EVERT
          MOVE       SP3,CKYIDEF3
          MOVE       ZERO,CKYIMAND           * Not Mandatory
          OPEN       PATHSPA1,"pathspaf"
.
          CALL       PATHSPKY
          BRANCH     EXIT,KHOS1000,KHOS9000
          MOVE       PTHSHOSP,HOSPID
          MOVE       ZERO,EXIT
          GOTO       KHOS9999
.
KHOS1000  MOVE       "All Hospitals",PTHSNAME
          MOVE       SP70,HOSPID
          MOVE       ZERO,EXIT
          GOTO       KHOS9999
.
KHOS9000  MOVE       ONE,EXIT
KHOS9999  RETURN
+
******************************************************************************
* DSPP0000          Find Invoices for Private Practice Display               *
******************************************************************************
DSPP0000  MOVE      ZERO,EXIT     
          MOVE      SP6,PREVPRAC
          PACK      KEY18,PURNO,SP20
          CALL      RSPRIN3                      * position in file
DSPP1000  CALL      RKPRIN3                      * read next record
          BRANCH    OVRCD,DSPP9999               * eof - finished
.         
          MATCH     PURNO,PRINDEBT               * same debtor ?
          GOTO      DSPP9999 IF NOT EQUAL        * no - finished
.         
          IF        PRINSCAN<>1
              GOTO      DSPP1000                 * not PMI patient
          ENDIF
.         
          MOVE      ONE,DOPRIVPR                 * set for PRI. system
          CALL      WCAL0000                     * calculate outstand. balance
.         
          BRANCH    PRTALL,DSPP2000              * printing all
          COMPARE   ZERO,STOTBAL                 * zero balance ?
          GOTO      DSPP1000 IF EQUAL            * yes - ignore
.
DSPP2000  MOVE      ONE,RECFLG                   * set flag for records found
.
.                                                                     *I-140395
          IF        HOPTION = 3
            MATCH     FROMDAT8,PRINDATE          * check "from" date
            GOTO      DSPP1000 IF LESS
            MATCH     PRINDATE,TODATE8           * check "to" date
            GOTO      DSPP1000 IF LESS
          ENDIF
.
          CALL      DSUR0000                     * Display Private Prac Invoice
          BRANCH    EXIT,DSPP9999
.
          GOTO      DSPP1000                     * get next record
.
DSPP9999  RETURN
+
.**************************************************************************
.         Subroutine to display Private Practice Invoices for a UR
.
.**************************************************************************
DSUR0000  MOVE      ZERO,EXIT 
.
          COMPARE   TWENTY2,CVERT              * was TEN9
          GOTO      DSUR1000 IF LESS
.
          MATCH     "IBARSH",PGM
          GOTO      DSUR9000 IF EQUAL
.
          KEYIN     *P1:24,*EL,"Display more (":
                    *V2LON,*DV,ANSY,*HOFF,*DV,SLASH,*V2LON,*DV,ANSN,*HOFF:
                    ") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
.
          MATCH     ANSN,ANS
          GOTO      DSUR9000 IF EQUAL
          DISPLAY   *P1:9,*EF;
          MOVE      NINE,CVERT
.
DSUR1000  MATCH     PREVPRAC,PRINPRAC
          GOTO      DSUR1500 IF EQUAL
.
          CALL      PPPR0000                * get Practice & Doctor names
          DISPLAY   *P1:CVERT,PRPRDESC," - ",DOCNAME;  
          ADD       TWO,CVERT
.
DSUR1500  ADD       STOTBAL,TOTBAL          * STOTBAL comes from WCAL0000
          MOVE      ZERO,FORM1
.
DSUR2000  ADD       ONE,FORM1
          BRANCH    FORM1,DSUR3001,DSUR3002,DSUR3003,DSUR3004,DSUR3005:
                          DSUR3006,DSUR3007,DSUR3008,DSUR3009
          ADD       ONE,CVERT
          GOTO      DSUR9999
.
DSUR3001  MOVE      PRINDATE,KEY8
          UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P1:CVERT,CPDATE,*P20:CVERT,"Invoice No: ",PRINNUMB:
                    *P66:CVERT,PRINITOT;
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3002  COMPARE   ZERO,PRINPAMT
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Receipt(s) From Patient",*P66:CVERT,PRINPAMT
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3003  COMPARE   ZERO,PRINHAMT
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Receipt(s) From Health Fund",*P66:CVERT,PRINHAMT
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3004  COMPARE   ZERO,PRINIAMT
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Receipt(s) From Insurer",*P66:CVERT,PRINIAMT
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3005  COMPARE   ZERO,PRINMAMT
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Receipt(s) From Medicare",*P66:CVERT,PRINMAMT
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3006  COMPARE   ZERO,PRINVAMT
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Receipt(s) From Vet Affairs",*P66:CVERT,PRINVAMT
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3007  COMPARE   ZERO,PRINOTHA
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Receipt(s) From Other",*P66:CVERT,PRINOTHA
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3008  COMPARE   ZERO,PRINJAMT
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Journals",*P66:CVERT,PRINJAMT
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR3009  COMPARE   ZERO,PRINCNTT
          GOTO      DSUR2000 IF EQUAL
.
          DISPLAY   *P32:CVERT,"Credit Note(s)",*P66:CVERT,PRINCNTT
          ADD       ONE,CVERT
          GOTO      DSUR2000
.
DSUR9000  MOVE      ONE,EXIT
.
DSUR9999  RETURN
+
.**************************************************************************
.         Subroutine to print the statement for an admission
.
.**************************************************************************
PRTSTAT   MOVE      SP8,A8DATE
          MOVE      SP10,A10DATE
          MOVE      SP8,D8DATE
          MOVE      SP10,D10DATE
          MOVE      SP8,B8DATE
          MOVE      SP10,B10DATE
.
          MOVE      ONE,PAGENUM
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPDATE,A8DATE
          MOVE      CPCDATE,A10DATE
.
          MOVE      ADIAG1,KEY50
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPDATE,B8DATE
          MOVE      CPCDATE,B10DATE
.
          MATCH     SP8,DDATE
          GOTO      GETFUN IF EQUAL
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPDATE,D8DATE
          MOVE      CPCDATE,D10DATE
.
GETFUN    MOVE      SP30,HFNAME
          MOVE      SP30,TABLNM
          MOVE      SP70,TABLNN
          CLEAR     KEY14
          APPEND    AFUNDH,KEY14
          APPEND    "0000",KEY14
          RESET     KEY14
          OPEN      PATFN1A1,"patfn1af"
          CALL      RDFUND1
.
          MOVE      HFNAME,FUNDNM
.
          MOVE      SP30,HFNAME
          PACK      KEY14 WITH AFUNDH,AFNDTB,SP10
          CALL      RDFUND1
.
          MOVE      HFNAME,TABLNM
          MOVE      AFNDMM,TABLNN
          CALL      GETPNAM
          CALL      GETPRES
          MOVE      ZERO,PAGENO
.
.         Print the statement heading section
.
          MOVE      PVIBILL,AADMNO
          CALL      HEAD
.
.         Print all the invoices
.
          MOVE      ZERO,TOTBAL
          MOVE      ZERO,TOTREB
          MOVE      ZERO,TOTPAT
.
          CALL      PRTIVADM                * print Invoices for an admission
.
          CALL      CHKLINE
.
          RETURN
.
.*****************************************************************************
.                   Print Invoice details for an Admission
.
.*****************************************************************************
PRTIVADM  DISPLAY   *P1:24,*EL,*P30:24,"Invoice No. : ";
          PACK      KEY16,AADMNO,SP8
          CALL      RDSINV3                      * position on admission
CALCINV1  CALL      RDKINV3                      * read next record
          BRANCH    OVRCD,ENDINV                 * eof - finished admission
.
          MATCH     AADMNO,PINVADM               * same admission still ?
          GOTO      ENDINV IF NOT EQUAL          * no - finished admission
.
          DISPLAY   *P44:24,*V2LON,PINVNO;
.
          IF        PINVSYS = 2 | PINVSYS = 4
            MOVE      "out",OSTSITE
            MOVE      SP3,OSTSYST
            MOVE      PINVSITE,KEY6
            CALL      RDSITA1
            CLOSE     OUTBB1A1
            PACK      CFNAME,OSTFILE,FILBB1A1
            CALL      OPOTBB11
          ENDIF
.
.         If processing for a range of invoice dates, then validate invoice date
.
          IF        HOPTION = 3
            MATCH     PINVDTE,TODATE8
            GOTO      CALCINV1 IF LESS
.
.           Check for a valid claim code
.
            MATCH     STCLM,PINVCLM
            GOTO      CALCINV1 IF LESS
.
            MATCH     PINVCLM,EDCLM
            GOTO      CALCINV1 IF LESS
          ENDIF
.
          BRANCH    PTCNSTMT,CALCIN1A            * using THC layout
.
          MOVE      ZERO,FORM1
.
.         Calculate total invoice for health fund
.
          ADD       PINVREB,TOTREB         * Total invoice for health fund
          ADD       PINVOTHA,TOTREB        * subtract any insurance payment
          ADD       PINVHFDA,TOTREB        * subtract amount paid by health fund
.
.         Calculate total invoice payable to patient
.
          ADD       PINVAMT,TOTPAT
          SUB       PINVREB,TOTPAT
          ADD       PINVJOUR,TOTPAT
          ADD       PINVPATA,TOTPAT         * subtract amount paid by patient
          ADD       PTINCRTT,TOTPAT         * sub Credit Note total   *I-140395
.
.         Calculate balance outstanding
.
CALCIN1A  ADD       PINVAMT,TOTBAL
          ADD       PINVPATA,TOTBAL
          ADD       PINVHFDA,TOTBAL
          ADD       PINVOTHA,TOTBAL
          ADD       PINVJOUR,TOTBAL
          ADD       PTINCRTT,TOTBAL         * sub Credit Note total   *I-140395
.
...       MOVE      TOTBAL,NETTOT           * set NETTOT for PATINVTL *I-140395
.
.         If using THC statement layout, then process differently
.
          IF        PTCNSTMT = 1
            IF        TOTBAL = 0 & PRTALL <> 1
              GOTO      CALCINV1                 * not printing zero balances
            ENDIF
.
.           The P.R.A. details are obtained from the first admission record
.           printed and will remain so for all pages printed, regardless of
.           whether the P.R.A. changes as admission number changes.
.
            COMPARE   ZERO,FRSTFLAG
            IF        @EQUAL
              CALL      GETPRES                  * Get P.R.A.
              CALL      IBACLOCK                 * get current date
              MOVE      CCC,CCENT
              MOVE      CYY,CYEAR
              MOVE      CMM,FORM2                * load current month
              MOVE      CDD,CDAY
              CALL      FDAT0000                 * format date
              MOVE      DIM9,CURRDATE            * load formatted date
              PRINT     *N
.
.             Print the header details
.
              CALL      HTHC0000                 * print statement header
              MOVE      ONE,FRSTFLAG
            ENDIF
            CALL      PLIN0000                   * print line of statement body
            MOVE      ZERO,TOTBAL                * reset invoice balance
            GOTO      CALCINV1                   * get next invoice
          ENDIF
. 
CALCINV2  COMPARE   SEVEN,FORM1                                       *C-140395
          GOTO      CALCINV1 IF NOT LESS
.
          COMPARE   TWO,PTCNINVL            * Anne Caudle invoice ?
          GOTO      CALCINV3 IF NOT EQUAL   * no
          COMPARE   TWENTY4,COUNT           * yes
          CALL      TLHEAD IF NOT LESS
          GOTO      CALCINV4
.
CALCINV3  IF        PTCNINVL=6
            COMPARE   TWENTY8,COUNT
          ELSE
            IF        PTCNINVL=9
              COMPARE   TWENTY7,COUNT
              CALL      TLHEAD IF NOT LESS
            ELSE
              COMPARE   TWENTY2,COUNT
              CALL      TLHEAD IF NOT LESS
            ENDIF
          ENDIF
.
.                                           * other print lines
.
CALCINV4  ADD       ONE,FORM1
          BRANCH    FORM1,CALCINV5,CALCINV6,CALCINV7,CALCINV8,CALCINV9,CALCIN10
          PRINT     *N;
          ADD       ONE,COUNT
          GOTO      CALCINV2
.
.         Print the invoice amount
.
CALCINV5  MOVE      PINVADM,KEY8
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY 
.         CALL      RDVISA1
.         UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *1,CPDATE;
.
          MOVE      ZERO,DOPRIVPR
          CALL      SAGE0000                * do the statement ageing
.
          COMPARE   THREE,PINVSYS
          GOTO      CALCIN5A IF NOT EQUAL   * Not inpatient
.
          MOVE      SP10,DDATE
          MOVE      PINVADM,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,CALCIN5A
.
..        MATCH     SP8,DDATE
..        GOTO      CALCIN5A IF EQUAL
..        UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
..        CALL      PACDATE
..        PRINT     *10,"- ",CPDATE;
.
CALCIN5A  IF        PTCNINVL=9
              PRINT     *12,"Inv. No: ",PINVNO,*66,PINVAMT
          ELSE
              PRINT     *25,"Invoice No: ",PINVNO,*66,PINVAMT
          ENDIF
          ADD       ONE,COUNT
          GOTO      CALCINV2
.
.         Print the receipts from patient
.
CALCINV6  COMPARE   ZERO,PINVPATA
          GOTO      CALCINV2 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Patient",*66,PINVPATA
          ELSE
              PRINT     *27,"Receipt/s From Patient",*66,PINVPATA
          ENDIF
          ADD       ONE,COUNT
          GOTO      CALCINV2
.
.         Print the receipts from Health fund
.
CALCINV7  COMPARE   ZERO,PINVHFDA
          GOTO      CALCINV2 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Health Fund",*66,PINVHFDA
          ELSE
              PRINT     *27,"Receipt/s From Health Fund",*66,PINVHFDA
          ENDIF
          ADD       ONE,COUNT
          GOTO      CALCINV2
.
.         Print the receipts from Insurance
.
CALCINV8  COMPARE   ZERO,PINVOTHA
          GOTO      CALCINV2 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Insurance",*66,PINVOTHA
          ELSE
              PRINT     *27,"Receipt/s From Insurance",*66,PINVOTHA
          ENDIF
          ADD       ONE,COUNT
          GOTO      CALCINV2
.
.         Print the journals
.
CALCINV9  COMPARE   ZERO,PINVJOUR
          GOTO      CALCINV2 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Journals",*66,PINVJOUR
          ELSE
              PRINT     *27,"Journals",*66,PINVJOUR
          ENDIF
          ADD       ONE,COUNT
          GOTO      CALCINV2
.
.         Print Credit Note total
.
CALCIN10  COMPARE   ZERO,PTINCRTT           * print Credit Note/s     *I-140395
          GOTO      CALCINV2 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Credit Note/s",*66,PTINCRTT
          ELSE
              PRINT     *27,"Credit Note/s",*66,PTINCRTT
          ENDIF
          ADD       ONE,COUNT
          GOTO      CALCINV2
.
..ENDINV    IF        (HOPTION=2) | (HOPTION=3)
..            RETURN
..          ENDIF
.
ENDINV    RETURN
+
.******************************************************************************
.
.******************************************************************************
CHKLINE   IF        PTCNINVL=6
            COMPARE   THIRTY,COUNT
          ELSE
            COMPARE   TWENTY5,COUNT
          ENDIF
          GOTO      PRTREBT IF NOT LESS
          PRINT     *N;
          ADD       ONE,COUNT
          GOTO      CHKLINE
.
.         Check if we need to print the patient/hf portion messages
.
PRTREBT   BRANCH    PTCNSTMS,PRTR100        * To print the message
          PRINT     *N,*N,*N
          GOTO      PRTR200
.
PRTR100   IF        PTCNINVL=9
          PRINT     *N,*N,*N
          ELSE
             PRINT     *N,*N,"We will Claim from your Health Fund an ":
                    "Exp. Rebate of $",TOTREB:
                    *N,"Payment now due from Patient $",TOTPAT
          ENDIF
.
PRTR200   ADD       TWO,COUNT
.
.         Calculate the balance payable
.
          COMPARE   TWO,HOPTION
          GOTO      BYADMN IF NOT EQUAL
.
          MOVE      ZEROVISN,AADMNO
BYADMN    CALL      ENDPRT
.
          RETURN
+
.******************************************************************************
.                   Print the tail and heading
.
.******************************************************************************
TLHEAD    IF        HOPTION = 2 | HOPTION = 3
            MOVE      AADMNO,DIM8VISN       * Save the Admission Number
            MOVE      ZEROVISN,AADMNO           * Print zero admission for
            CALL      TAIL                  * the heading and tail
            MOVE      DIM8VISN,AADMNO
          ELSE
            CALL      TAIL                  * Print with the Admission Number
          ENDIF
          RETURN
+
.*****************************************************************************
.         Subroutine to calculate the total amount outstanding for the patient
.                    for the current Visit (In-pat, Outpat or A&E)
.*****************************************************************************
CALCOUT   MOVE      ZERO,STOTBAL
          MOVE      ZERO,NUMINVS
          PACK      KEY16 WITH PVIBILL,SP8
          CALL      RDSINV3           
CALCOLP   CALL      RDKINV3
          BRANCH    OVRCD OF CALCOEND
.
          MATCH     PVIBILL,PINVADM
          GOTO      CALCOEND IF NOT EQUAL
.
          IF        HOPTION = 3
            MATCH     PINVDTE,TODATE8
            GOTO      CALCOLP IF LESS
.
.         Check for a valid claim code
.
            MATCH     STCLM,PINVCLM
            GOTO      CALCOLP IF LESS
.
            MATCH     PINVCLM,EDCLM
            GOTO      CALCOLP IF LESS
          ENDIF
.
.         Accumulate totals
.
          ADD       PINVAMT,STOTBAL
          ADD       PINVPATA,STOTBAL
          ADD       PINVHFDA,STOTBAL
          ADD       PINVOTHA,STOTBAL
          ADD       PINVJOUR,STOTBAL
          ADD       PTINCRTT,STOTBAL       * subtrct Credit Note tot. *I-140395
          ADD       ONE,NUMINVS
          GOTO      CALCOLP
.
CALCOEND  RETURN
+
.*****************************************************************************
.         Subroutine to display the basic patient field names on the screen
.
.*****************************************************************************
DISPB     
.         DISPLAY   *P1:4,*EF,"U/R Number :",*P27:4,"Name :":
.                    *P1:5,"Billing No :",*P27:5,"Sex  :":
.                    *P43:5,"Born :",*P60:5,"Age :";
.
          BRANCH    PVITYPE OF AAEDPB,OUTDPB,INPDPB,OUTDPB,DISPB9
          RETURN
.
.         Inpatient Basic Data Display
.
INPDPB    DISPLAY   *P26:6,"Ward :",*P42:6,"Doct :";
          RETURN
+
.         Outpatient Basic Data Display
.
OUTDPB    DISPLAY   *P26:6,"Site :",*P42:6,"Clin :";
          RETURN
.
DISPB9
.         A & E  Basic Data Display
.
AAEDPB    DISPLAY   *P26:6,"Time :",*P42:6,"Doct :";
          RETURN
+
.*****************************************************************************
.         Subroutine to display patient detail by U/R Number option
.
.*****************************************************************************
DISPB1    DISPLAY   *P1:4,*EF,"U/R Number :",*P27:4,"Name :":
                    *P27:5,"Sex  :",*P43:5,"Born :",*P60:5,"Age :";
          RETURN
+
.*****************************************************************************
.         Subroutine to display the basic patient details on the screen
.
.*****************************************************************************
DATAB000
..        BRANCH    PVITYPE,AAEDTB,OUTDTB,INPDTB,OTHDTB,GETSEX,GETSEX
..        GOTO      GETSEX
.
.         Inpatient Basic Data
.
.INPDTB    MOVE      SP30,DPSTAT
..         LOAD      DPSTAT FROM ASTAT OF STAT1,STAT2,STAT3,STAT4,STAT5
..
..        Add dates if this is a current admission or discharge
.
..         BRANCH    ASTAT OF GETSEX,XSTAT1,XSTAT2
..         GOTO      GETSEX
.
.XSTAT1    UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
..         PACK      DPSTAT WITH STAT2,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR,SP10
..         GOTO      GETSEX
.
.XSTAT2    UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
..         PACK      DPSTAT WITH STAT3,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR,SP10
..         GOTO      GETSEX
.
.         Outpatient Basic Data
.
.OUTDTB    UNPACK    OBADATE WITH XCENT,XYEAR,XMON,XDAY
..         PACK      DPSTAT WITH STATO,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR,SP10
..         GOTO      GETSEX
.
.         A & E  Basic Data
.
.AAEDTB    UNPACK    ADADATE WITH XCENT,XYEAR,XMON,XDAY
..         PACK      DPSTAT WITH STATE,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR,SP10
..         GOTO      GETSEX
.
.         Other Financial Basic Data
.
.OTHDTB    UNPACK    PVIDATE WITH XCENT,XYEAR,XMON,XDAY
..         PACK      DPSTAT WITH XDAY,SLASH,XMON,SLASH,XCENT,XYEAR,SP10
.
.         Continue with the determining of the data
.
.GETSEX    MOVE      DMALE,DSEX
..         CMATCH    ANSM,PSEX
..         GOTO      GETPNME IF EQUAL
..         MOVE      DFEMALE,DSEX
.
.GETPNME   UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
..         CALL      PACDATE
..         DISPLAY   *P13:4,*V2LON,PVIURNO,*P34:4,PSNAME,PGNAME:
..                   *P13:5,PVIBILL,*P34:5,DSEX,*P50:5,CPCDATE,*P65:5,PSAGE:
..                   *P1:6,DPSTAT;
.
.
.
          BRANCH    PVITYPE OF AAEDT1,OUTDT1,INPDT1,OTHDT1,DISP9,DISP9
          GOTO      DISP9
.
.         Inpatient extra information
.              - Only current admissions should have beds
.
INPDT1    COMPARE   TWO,ASTAT
          GOTO      NOWRDS IF NOT EQUAL
.
.         Blank ward indicates a standby patient
.
          MATCH     SP3,AWARD
          GOTO      CHKSTBY IF EQUAL
          DISPLAY   *P33:6,*V2LON,AWARD,SLASH,ABED;
          GOTO      ENDDB
.
.         Loop through the Ward/bed file to find this patient
.
CHKSTBY   OPEN      PATWR1A4,"patwr1af"
          MOVE      AADMNO,WSTBY
          PACK      KEY14,WSTBY,SP6
          CALL      RDSWARD4
          CALL      RDKWARD4
          BRANCH    OVRCD OF NOSTBY
.
.         Check for the correct patient
.
          MATCH     AADMNO,WSTBY
          GOTO      NOSTBY IF NOT EQUAL
          CLOSE     PATWR1A4
.
.         Found it
.
          DISPLAY   *P33:6,*V2LON,*BLINKON,WWARD,SLASH,WBED;
          GOTO      ENDDB
.
.         Patient doesn't have a bed
.
NOSTBY    CLOSE     PATWR1A4
NOWRDS    DISPLAY   *P33:6,*V2LON," N/A";
.
ENDDB     MATCH     SP6,ADOCTA
          GOTO      SHINVS IF EQUAL
.
          MOVE      ADOCTA,KEY6
          OPEN      PATDO1A1,"patdo1af"
          CALL      RDDOCT1
          CLOSE     PATDO1A1
          BRANCH    OVRCD OF SHINVS
.
          MOVE      DGNAME,ANS
          DISPLAY   *P49:6,*V2LON,ANS,DOT,DSNAME;
          GOTO      SHINVS
.
.         Outpatient Extra information
.
OUTDT1    MOVE      SP30,OCADESC
.
.         Get the doctor description from the clinic file
.
          PACK      CFNAME,OSTFILE,FILCLIA1
          OPEN      OUTCLIA1,CFNAME
.
          PACK      KEY20,OBASITE,OBACLIN,PVIDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     OBASITE,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ELSE
                MATCH     OBACLIN,OCACLIN
                IF        !@EQUAL
                  MOVE      ONE,OVRCD
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CLOSE     OUTCLIA1
          IF        OVRCD = 1
            MOVE      "Unknown clinic",OCADESC
            PACK      OCADESC,OCADESC,SP30
            GOTO      DSPOUTBD
          ENDIF
.
          MATCH     SP6,OCADOCT
          GOTO      DSPOUTBD IF EQUAL
.
.         We have a doctor code - get the description from the doctors file
.
          MOVE      OCADOCT,KEY6
          OPEN      PATDO1A1,"patdo1af"
          CALL      RDDOCT1
          CLOSE     PATDO1A1
          BRANCH    OVRCD OF DSPOUTBD
.
          MOVE      DGNAME,ANS
          PACK      OCADESC WITH ANS,DOT,DSNAME
.
DSPOUTBD  DISPLAY   *P33:6,*V2LON,OBASITE,*P49:6,OCADESC;
          GOTO      SHINVS
.
.         A & E  Extra Information
.
AAEDT1    MOVE      SP30,DOCNAME
.
.         Get the doctors name
.
          MOVE      ADADOCT,KEY6
          OPEN      PATDO1A1,"patdo1af"
          CALL      RDDOCT1
          CLOSE     PATDO1A1
          BRANCH    OVRCD OF DSPAAEBD
.
          MOVE      DGNAME,ANS
          PACK      DOCNAME WITH ANS,DOT,DSNAME
.
DSPAAEBD  DISPLAY   *P33:6,*V2LON,ADATIME,*P49:6,DOCNAME;
          GOTO      SHINVS
.
.         Other Financial Extra information
.
OTHDT1    MOVE      SP30,OCADESC
.
.         Get the doctor description from the clinic file
.
          PACK      CFNAME,OSTFILE,FILCLIA1
          OPEN      OUTCLIA1,CFNAME
.
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE
          CALL      RDCLIA1
          IF        OVRCD = 1
            CALL      RDPCLIA1
            IF        OVRCD = 0
              MATCH     PVISITE,OCASITE
              IF        !@EQUAL
                MOVE      ONE,OVRCD
              ELSE
                MATCH     PVIDOCT,OCACLIN
                IF        !@EQUAL
                  MOVE      ONE,OVRCD
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CLOSE     OUTCLIA1
          IF        OVRCD = 1
            MOVE      "Unknown clinic",OCADESC
            PACK      OCADESC,OCADESC,SP30
            GOTO      DSPOTHBD
          ENDIF
.
          MATCH     SP6,OCADOCT
          GOTO      DSPOTHBD IF EQUAL
.
.         We have a doctor code - get the description from the doctors file
.
          MOVE      OCADOCT,KEY6
          OPEN      PATDO1A1,"patdo1af"
          CALL      RDDOCT1
          CLOSE     PATDO1A1
          BRANCH    OVRCD OF DSPOTHBD
.
          MOVE      DGNAME,ANS
          PACK      OCADESC WITH ANS,DOT,DSNAME
.
DSPOTHBD  DISPLAY   *P33:6,*V2LON,PVISITE,*P49:6,OCADESC;
          GOTO      SHINVS
.
.         Display the invoices for this patient
.
SHINVS    DISPLAY   *P1:7,*EF:
                    *P1:8,*V2LON,*ULON,"  Date  ",*P20:8,"Description       ":
                    "                   ",*P68:8,"    Amount";
          MOVE      NINE,CVERT
.
.         Zero totals
.
          MOVE      ZERO,TOTBAL
          MOVE      ZERO,TOTREB
          MOVE      ZERO,TOTPAT
.
DISPINV0  MOVE      ZERO,EXIT
          PACK      KEY16 WITH AADMNO,SP8
          CALL      RDSINV3           
DISPINV1  CALL      RDKINV3
          BRANCH    OVRCD OF DISPIN10
.
          MATCH     AADMNO,PINVADM
          GOTO      DISPIN10 IF NOT EQUAL
          MOVE      ZERO,FORM1
.
.         Calculate total invoice for health fund
.
          ADD       PINVREB,TOTREB         * Total invoice for health fund
          ADD       PINVOTHA,TOTREB        * subtract any insurance payment
          ADD       PINVHFDA,TOTREB        * subtract amount paid by health fund
.
.         Calculate total invoice payable to patient
.
          ADD       PINVAMT,TOTPAT
          SUB       PINVREB,TOTPAT
          ADD       PINVJOUR,TOTPAT
          ADD       PINVPATA,TOTPAT
          ADD       PTINCRTT,TOTPAT        * sub Credit Note total    *I-140395
.
.         Calculate balance outstanding
.
          ADD       PINVAMT,TOTBAL
          ADD       PINVPATA,TOTBAL
          ADD       PINVHFDA,TOTBAL
          ADD       PINVOTHA,TOTBAL
          ADD       PINVJOUR,TOTBAL
          ADD       PTINCRTT,TOTBAL        * sub Credit Note total    *I-140395
.
DISPINV2  COMPARE   TWENTY2,CVERT             * was TEN9
          GOTO      DSPSUMMK IF NOT LESS
.
          COMPARE   SEVEN,FORM1                                       *C-140395
          GOTO      DISPINV1 IF NOT LESS
.
          ADD       ONE,FORM1
          BRANCH    FORM1,DISPINV3,DISPINV4,DISPINV5,DISPINV6,DISPINV7,DISPINV8
          ADD       ONE,CVERT
          GOTO      DISPINV2
.
DISPINV3  MOVE      PINVADM,KEY8
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY  * Invoice Date 
.         CALL      RDVISA1
.         UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P1:CVERT,CPDATE;
.
          COMPARE   THREE,PINVSYS
          GOTO      DISPIN3A IF NOT EQUAL   * Not inpatient
          MOVE      SP10,DDATE
          MOVE      PINVADM,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,DISPIN3A
.
          MATCH     SP8,DDATE
          GOTO      DISPIN3A IF EQUAL
.         UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
.         DISPLAY   *P9:CVERT,"- ",XDAY,SLASH,XMON,SLASH,XYEAR;
.
DISPIN3A  DISPLAY   *P20:CVERT,"Invoice No.",PINVNO,*P66:CVERT,PINVAMT;
          ADD       ONE,CVERT
          GOTO      DISPINV2
.
DISPINV4  COMPARE   ZERO,PINVPATA
          GOTO      DISPINV2 IF EQUAL
.
          DISPLAY   *P20:CVERT,"  Receipt/s From Patient",*P66:CVERT,PINVPATA;
          ADD       ONE,CVERT
          GOTO      DISPINV2
.
DISPINV5  COMPARE   ZERO,PINVHFDA
          GOTO      DISPINV2 IF EQUAL
.
          DISPLAY   *P20:CVERT,"  Receipt/s From Health Fund":
                    *P66:CVERT,PINVHFDA;
          ADD       ONE,CVERT
          GOTO      DISPINV2
.
DISPINV6  COMPARE   ZERO,PINVOTHA
          GOTO      DISPINV2 IF EQUAL
.
          DISPLAY   *P20:CVERT,"  Receipt/s From Insurance",*P66:CVERT,PINVOTHA;
          ADD       ONE,CVERT
          GOTO      DISPINV2
.
DISPINV7  COMPARE   ZERO,PINVJOUR
          GOTO      DISPINV2 IF EQUAL
.
          DISPLAY   *P20:CVERT,"  Journals",*P66:CVERT,PINVJOUR;
          ADD       ONE,CVERT
          GOTO      DISPINV2
.
DISPINV8  COMPARE   ZERO,PTINCRTT           * display Credit Note     *I-140395
          GOTO      DISPINV2 IF EQUAL
.
          DISPLAY   *P20:CVERT,"  Credit Note",*P66:CVERT,PTINCRTT;
          ADD       ONE,CVERT
          GOTO      DISPINV2
.
.******************************************************************************
.         Check if more of the invoices are to be displayed
.
.******************************************************************************
DSPSUMMK  MATCH     "IBARSH",PGM
          GOTO      DSPSUMM1 IF EQUAL
.
          KEYIN     *P1:24,"Display more (",*V2LON,*DV,ANSY,*HOFF,*DV,SLASH:
                    *V2LON,*DV,ANSN,*HOFF,") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
.
          MATCH     ANSN,ANS
          GOTO      DSPSUMM1 IF EQUAL
          MATCH     ANSY,ANS
          IF        @EQUAL
            DISPLAY   *P1:9,*EF;
            MOVE      NINE,CVERT
            GOTO      DISPINV2
          ENDIF
          BEEP
          GOTO      DSPSUMMK
.
DSPSUMM1  COMPARE   TWO,HOPTION
          RETURN    IF NOT EQUAL
          MOVE      ONE,EXIT
          RETURN
+
.*****************************************************************************
.                         Display Nett Balance
.
.*****************************************************************************
DISPIN10  BRANCH    HOPTION,DISPIN11        * We don't want to print the
          RETURN                            * rebate section for option two
.
DISPIN11  COMPARE   TWENTY1,CVERT           * Get to the bottom of the inv.
          GOTO      DSPREBT IF NOT LESS     * body to display payment due
          ADD       ONE,CVERT               * to patient and health fund
          GOTO      DISPIN11
.
.         Check if we are doing by U/R Number or Admission Number
.
.DSPREBT   DISPLAY      *P1:CVERT,"We will Claim from your Health Fund":
..                      " an Expected Rebate of $",*V2LON,TOTREB,*HOFF
..         ADD          ONE,CVERT
..
..         DISPLAY      *P1:CVERT,"Payment now Due from Patient $":
..                      *V2LON,TOTPAT,*HOFF
..         ADD          TWO,CVERT
..------  The above code has been commented out for a quick fix for Well ----
.
DSPREBT   IF        CVERT > 21   
            MOVE      TWENTY1,CVERT
          ENDIF
          DISPLAY   *P1:CVERT,"";
          ADD       ONE,CVERT
.
          DISPLAY   *P50:CVERT,"Totals",*P69:CVERT,*V2LON,TOTBAL;
          RETURN
+
.******************************************************************************
.         Subroutine to display the basic patient details on the screen
.         
.******************************************************************************
DATAB1    MOVE      SP8,DSEX
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DSEX
.
DATAB1A   UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P13:4,*V2LON,PURNO,*P34:4,PSNAME,PGNAME:
                    *P34:5,DSEX,*P50:5,CPCDATE,*P65:5,PSAGE;
DISP9     RETURN
+
.         Create Temporary Index File
.
.*************************************************************************
.*  KILL0000  :  erase temp file                                         *
.*************************************************************************
KILL0000  IF        PTCNINVL=9 & HOPTION=2
              PACK      FNAME,FNAME2
              GOTO      KILL5000
          ENDIF
.
          PACK      FNAME,FNAME1
          CLOSE     TMPFILO3
          CLOSE     TMPFILO4
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAME,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          IF        PTCNINVL=9 & HOPTION=3
              PACK      FNAME,FNAME2
              GOTO      KILL5000
          ENDIF
          
          GOTO      KILL9999
.
KILL5000  CLOSE     WTMPFIL1
          CLOSE     WTMPFIL2
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAME,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
KILL9999  RETURN
+
.*************************************************************************
.*                             CRET0000            Called by : OPT3PROC  *
.*                      create temporary file                            *
.*************************************************************************
CRET0000  CALL      KILL0000 
.
          IF        PTCNINVL=9 & HOPTION=2
               PACK      FNAME,FNAME2
               GOTO      CRET5000
          ENDIF
.
          PACK      FNAME,FNAME1
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAME,CMDLINE
          APPEND    " 64 U1-8 U9-28,29-53,1-8",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          OPEN      TMPFILO3,FNAME
          OPEN      TMPFILO4,FNAME
          IF        PTCNINVL=9 & HOPTION=3
              PACK      FNAME,FNAME2
              GOTO      CRET5000
          ENDIF
          GOTO      CRET9999
.
CRET5000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAME,CMDLINE
          APPEND    " 51 U1-8,9-16,25-25 U26-33,1-8,9-16,25-25",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          OPEN      WTMPFIL1,FNAME
          OPEN      WTMPFIL2,FNAME
CRET9999  RETURN
+
.********************************************************************** 
. GFAC0000 : Get future action codes
.********************************************************************** 
GFAC0000
.
.------   Ask Question
.
GFAC0500  KEYIN     *P1:24,*EL,"Do you wish to supress a range of statements":
                      " by Future Action Code (",*V2LON,"Y",*HOFF,"/":
                      *V2LON,"N",*HOFF,")? ",ANS
          REP       UPPLOW,ANS
          MATCH     "Y",ANS
          GOTO      GFAC1000 IF EQUAL
          MATCH     "N",ANS
          GOTO      GFAC9990 IF EQUAL
          BEEP
          GOTO      GFAC0500
         
.------   Starting Future Action Code
.
GFAC1000  DISPLAY   *P1:24,*EL,"Note : Statements in the Future Action Code ":
                               "range will be NOT be printed. ";
.
          MOVE      ZERO,EXIT
          MOVE      SP3,STCLM
          MOVE      "FA",CODE
          MOVE      "31",ECOL
          MOVE      "19",EVERT
          DISPLAY   *P1:EVERT,"Starting Future Action Code : ";
          CALL      PATCODKY
          BRANCH    EXIT,GFAC4000:           * no input
                         GFAC9980            * exitchar
.
          MOVE      ACODE,STFAC
          GOTO      GFAC5000
.
GFAC4000  DISPLAY   *PECOL:EVERT,*EL,*V2LON,"Start";
          MOVE      SP3,STFAC
.
.------   Ending Claim Code 
.
GFAC5000  MOVE      SP3,EDFAC
          MOVE      ZERO,EXIT
          MOVE      "FA",CODE
          MOVE      "31",ECOL
          MOVE      "20",EVERT
          DISPLAY   *P1:EVERT,"Ending   Future Action Code : "
          CALL      PATCODKY
          BRANCH    EXIT,GFAC9000:           * no input
                         GFAC9980            * exitchar 
.
          MOVE      ACODE,EDFAC
          GOTO      GFAC9900
.
GFAC9000  DISPLAY   *PECOL:EVERT,*EL,*V2LON,"Finish";
          MOVE      "ZZZ",EDFAC
.
GFAC9900  MATCH     STFAC,EDFAC             * validate range
          GOTO      GFAC9970 IF LESS
          GOTO      GFAC9990
.
GFAC9970  DISPLAY   *P1:24,*EL,*B,"Invalid Code range.  ";
          CALL      HITENTER
          GOTO      GFAC1000
.
GFAC9980  MOVE      ONE,EXIT                 * exitchar
          GOTO      GFAC9999
.
GFAC9990  MOVE      ZERO,EXIT
.
GFAC9999  RETURN
+
.*********************************************************************
.*        calculate the ageing for the statements
.*        SRF 641xxx - Fixed so that routine calculates difference
.*        between dates, and uses invoice date instead of visit date
.*        as the start date
.*********************************************************************
.
SAGE0000  BRANCH    DOPRIVPR,SAGE5000  * Doing Priv Prac Invoices
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          PACK      CDYSFDTE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CDYSFDTE
          PACK      CDYSTDTE,CCC,CYY,CMM,CDD
          REP       " 0",CDYSTDTE
          CALL      CALCDAYS                * number of days
          SUB       ONE,CDYSDAYS            * get difference
.
          MOVE      ZERO,AMOUNT
          ADD       PINVAMT,AMOUNT
          ADD       PINVPATA,AMOUNT
          ADD       PINVHFDA,AMOUNT
          ADD       PINVOTHA,AMOUNT
          ADD       PINVJOUR,AMOUNT
          ADD       PTINCRTT,AMOUNT                                   *I-140395
.
.
          IF        CDYSDAYS > 90
            ADD       AMOUNT,AGEING[1]      * 90 days debt
            GOTO      SAGE9999
          ENDIF
          IF        CDYSDAYS > 60
            ADD       AMOUNT,AGEING[2]      * 60 days debt
            GOTO      SAGE9999
          ENDIF
          IF        CDYSDAYS > 30
            ADD       AMOUNT,AGEING[3]      * 30 days debt
            GOTO      SAGE9999
          ENDIF
.
          ADD       AMOUNT,AGEING[4]        * current debt
          GOTO      SAGE9999
.
. ----    Do Ageing of Priv. Prac. Invoices for West Wimmera ----
.
SAGE5000  UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          PACK      CDYSFDTE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CDYSFDTE
          PACK      CDYSTDTE,CCC,CYY,CMM,CDD
          REP       " 0",CDYSTDTE
          CALL      CALCDAYS                * number of days
          SUB       ONE,CDYSDAYS            * get difference
.
          MOVE      ZERO,AMOUNT
          ADD       PRINITOT,AMOUNT
          ADD       PRINPAMT,AMOUNT
          ADD       PRINHAMT,AMOUNT
          ADD       PRINOTHA,AMOUNT
          ADD       PRINJAMT,AMOUNT
          ADD       PRINIAMT,AMOUNT
          ADD       PRINMAMT,AMOUNT
          ADD       PRINVAMT,AMOUNT
          ADD       PRINCNTT,AMOUNT         * sub Credit Note         *I-140395
.
          IF        CDYSDAYS > 90
            ADD       AMOUNT,AGEING[1]      * 90 days debt
            GOTO      SAGE9999
          ENDIF
          IF        CDYSDAYS > 60
            ADD       AMOUNT,AGEING[2]      * 60 days debt
            GOTO      SAGE9999
          ENDIF
          IF        CDYSDAYS > 30
            ADD       AMOUNT,AGEING[3]      * 30 days debt
            GOTO      SAGE9999
          ENDIF
.
          ADD       AMOUNT,AGEING[4]        * current debt
          MOVE      ZERO,EXIT
.
.
SAGE9999  RETURN
+
.*********************************************************************
.         initilisation
.*********************************************************************
INIT0000  CALL      DISPHEAD
          DISPLAY   *P56:24,"Opening aaede1af";
          OPEN      AAEDE1A1,"aaede1af"
.
          DISPLAY   *P64:24,"aaedi1af";
          OPEN      AAEDI1A1,"aaedi1af"
.
          DISPLAY   *P64:24,"emrvisaf";
          OPEN      EMRVISA1,"emrvisaf"
.
          DISPLAY   *P64:24,"ibanobef";
          OPEN      PATNOBE1,"patnobef"
.
          DISPLAY   *P64:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN	    PATDSCH1,"patdschf"
          OPEN	    PATDSCH2,"patdschf"
.
          DISPLAY   *P64:24,"patgsrnf";
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          DISPLAY   *P64:24,"patinvrf";
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR2,"patinvrf"
          OPEN      PATINVR3,"patinvrf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"patpramf";
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P64:24,"priinvof";
          OPEN      PRIINVO3,"priinvof"
          OPEN      PRIINVO2,"priinvof"
          OPEN      PRIINVO1,"priinvof"
.
          DISPLAY   *P64:24,"pripracf"
          OPEN      PRIPRAC1,"pripracf"
.
          DISPLAY   *P64:24,"pmshcpaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          DISPLAY   *P64:24,"mltcfnaf"
          OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MLTCFNA2,"mltcfnaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*66,CINVLAY,*79,CAPPRVNO,*166,CMEMB
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST:
                                  CHPADD1,CHPADD2,CHPPOST,CHTELEB
          READ      CONTROLF,TEN4;CNOCLMS,*228,CINVFF
          READ      CONTROLF,TWENTY;*208,PTCNSTMS
          READ      CONTROLF,TWENTY1;*51,PTCNINVL,*237,PTCNPAOF
          READ      CONTROLF,THIRTY2;*57,OTCNOTIH,*63,OTCNOTIT
          READ      CONTROLF,SEVENTY7;*212,PTCNSUFA
          READ      CONTROLF,SEVENTY8;*40,AECNAEIH,*46,AECNAEIT
          READ      CONTROLF,SEVENTY9;*244,PTCNSTMT
          READ      CONTROLF,NINTY8;*136,PTCNPAIH,*142,PTCNPAIT
          READ      CONTROLF,HUND03;*9,PTCNSMTH,*15,PTCNSMTT          *I-140395
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND05;*195,PTCNLASR
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          IF        PTCNSUFA=1
            DISPLAY   *P64:24,"patfactf";
            OPEN      PATFACT1,"patfactf"
          ENDIF
.
          MOVE      THREE,HEADTYPE          * set to statements
          MOVE      ONE,STATMENT                                      *I-140395
.
.         IF        PTCNINVL=9
.            DISPLAY   *P64:24,"priinvof";
.            OPEN      PRIINVO3,"priinvof"
.            OPEN      PRIINVO2,"priinvof"
.            OPEN      PRIINVO1,"priinvof"
.         ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAME
          CALL      TFILENAM
          MOVE      TFILNAME,FNAME1
          CALL      TFILENAM
          MOVE      TFILNAME,FNAME2
.
          MATCH     "IBARSH",PGM
          GOTO      INIT9999 IF EQUAL
.
          CALL      SELPRINT
.
INIT9999  RETURN
+
.*********************************************************************
.         which option ??
.*********************************************************************
OPTN0000  HLINE     *G37,2,48,80
          BRANCH    PTCNSTMT,OPTN1000
.
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = Billing Number":
                    *P1:6,*V2LON,TWO,*HOFF," = U/R Number":
                    *P1:7,*V2LON,THREE,*HOFF," = Range of Invoice Dates":
                    *P1:8,*V2LON,FOUR,*HOFF," = Line-up Print":
                    *P1:10,"Select Option : ";
.
OPTN0500  KEYIN     *P17:10,*EF,*V2LON,HOPTION;
          MOVE      ONE,EXIT
          COMPARE   ZERO,HOPTION
          GOTO      OPTN9999 IF EQUAL
.
          MOVE      ZERO,PRTALL
          MOVE      ZERO,EXIT
          BRANCH    HOPTION,OPTN9999,OPTN9999,OPTN9999,OPTN9999
          BEEP
          GOTO      OPTN0500
.
.         Options for THC layout
.
OPTN1000  DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = U/R Number":
                    *P1:6,*V2LON,TWO,*HOFF," = Range of Invoice Dates":
                    *P1:7,*V2LON,THREE,*HOFF," = Line-up Print":
                    *P1:9,"Select Option : ";
.
OPTN1500  KEYIN     *P17:9,*EF,*V2LON,HOPTION;
          MOVE      ONE,EXIT
          COMPARE   ZERO,HOPTION
          GOTO      OPTN9999 IF EQUAL
.
          MOVE      ZERO,PRTALL
          MOVE      ZERO,EXIT
          BRANCH    HOPTION,OPTN9000,OPTN9000,OPTN9000
          BEEP
          GOTO      OPTN1500
.
OPTN9000  ADD       ONE,HOPTION              * bring into line with other layouts
.
OPTN9999  MOVE      ZERO,ENDFLG
          RETURN
+
.****************************************************************************
.*                                GTHC0000             Called by:           *
.*                Get THC header details prior and print                    *
.****************************************************************************
.
GTHC0000  MOVE      ZERO,RUNBAL                  * initialise running balance
          MOVE      ZERO,OVERDUE                 * initialise overdue amount
          MOVE      ZERO,CURRENT                 * initialise current amount
          MOVE      ZERO,ENDFLAG                 * initialise finished flag
          MOVE      ZERO,TOTBAL                  * initialise total balance
          MOVE      ONE,PAGENUM                  * initialise page number
          MOVE      ZERO,FRSTFLAG                * initialise first rec. flag
.
          MOVE      PURNO,PVIURNO
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2                     * re - position on first visit
GTHC0500  CALL      RDKVISA2                     * read next record
          BRANCH    OVRCD,GTHC9000               * eof - finished
.
          MATCH     PURNO,PVIURNO                * same U/R ?
          GOTO      GTHC9000 IF NOT EQUAL        * no - finished
.
          MOVE      PVIBILL,AADMNO               * save admission number
.
          IF        OPTION=3
            IF        (FSTSYS > PVITYPE) | (PVITYPE > FEDSYS)
                GOTO      GTHC0500            * not in range so ignore
            ENDIF
          ENDIF
.
          IF          IBCNMHOS=1
            MATCH       SP10,HOSPID
            IF          !@EQUAL
              PACK        KEY8,PVIBILL,SP8
              CALL        RDPMVX11
              BRANCH      OVRCD,GTHC0500
              MATCH       PMVXMHOS,HOSPID
              GOTO        GTHC0500 IF NOT EQUAL
            ENDIF
          ENDIF
.
          COMPARE   SIX,PVITYPE                  * Comm. Health visit ?
          GOTO      GTHC0500 IF EQUAL            * yes - ignore
.
          BRANCH    PRTALL,GTHC1000              * Print zero balances
          CALL      CALCOUT                      * calc total for this Visit
          COMPARE   ZERO,STOTBAL                 * balance zero ?
          GOTO      GTHC0500 IF EQUAL            * yes - ignore
.
GTHC1000  BRANCH    FRSTFLAG,GTHC2000
.
.
GTHC2000  CALL      PRTIVADM                     * print admiss. transactions
          MOVE      TOTBAL,NETTOT           * set NETTOT for PATINVTL *I-140395
          GOTO      GTHC0500                     * get next visit record
.
GTHC9000  MOVE      ONE,ENDFLAG                  * set finished flag
          CALL      TTHC0000                     * print statement tail
.
GTHC9999  RETURN
+
.*************************************************************************
.*                             FDAT0000              Called by: PLIN0000 *
.*                    Format Date Printed (dd-MMM-yy)           GTHC0000 *
.* Requires: CDAY   (Day - DD)                                           *
.*           CYEAR  (Year - YY)                                          *
.*           FORM2  (Month - MM)                                         *
.* Returns:  DIM9 - formatted date                                       *
.*************************************************************************
.
FDAT0000  LOAD      RMONTH,FORM2,DMON01,DMON02,DMON03,DMON04,DMON05,DMON06:
                    DMON07,DMON08,DMON09,DMON10,DMON11,DMON12
.
.         Format full date
.
          PACK      DIM9,CDAY,HYPHEN,RMONTH,HYPHEN,CYEAR
          REP       " 0",DIM9
.
FDAT9999  RETURN
+
.****************************************************************************
.*                              PPHD0000               Called by:           *
.*               Print Page Header for Private Practice invoices            *
.****************************************************************************
.
PPHD0000  MOVE      ZERO,EXIT    
PPHD9999  RETURN
+
.****************************************************************************
.*                              PPDT0000               Called by:           *
.*               Read Priv.Practice by Date Range                           *
.****************************************************************************
.
PPDT0000  MOVE      ZERO,EXIT    
.
          PACK      KEY16,FROMDAT8,SP10
          CALL      RSPRIN2                      * position in file
PPDT1000  CALL      RKPRIN2                      * read next record
          BRANCH    OVRCD,PPDT9999               * eof - finished loop
.
          MATCH     PRINDATE,TODATE8             * invoice in date range ?
          GOTO      PPDT9999 IF LESS             * no - finished loop
.
          COMPARE   PRINSCAN,ONE                 * PMI patient ?
          GOTO      PPDT1000 IF NOT EQUAL        * no - ignore
.
          MATCH     STCLM,PRINCLAM               * valid claim code ?
          GOTO      PPDT1000 IF LESS             * no - ignore
.
          MATCH     PRINCLAM,EDCLM               * valid claim code ?
          GOTO      PPDT1000 IF LESS             * no - ignore
.
          MOVE      ONE,DOPRIVPR                 * set flag for patient invoice
          CALL      WCAL0000                     * calculate invoice balance
.
          BRANCH    PRTALL,PPDT2000              * printing all invoices
          COMPARE   ZERO,STOTBAL                 * zero outstanding balance ?
          GOTO      PPDT1000 IF EQUAL            * yes - ignore
.
PPDT2000  MOVE      PRINDEBT,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PPDT1000    
.
          PACK      KEY8,PRINDEBT,SP8
          CALL      RATEMP1
          IF        OVRCD = 1
            MOVE      PRINDEBT,XXURNO
            MOVE      PGNAME,XXGNAME
            MOVE      PSNAME,XXSNAME
            MOVE      "Y",XXITYPE
            UNPACK    SP10,XXSPARE
            CALL      WRTEMP1
          ENDIF
.
          GOTO      PPDT1000
.
. ----- U/R's have been compiled -----
.
PPDT9999  RETURN
+
.****************************************************************************
.*                              PLIN0000               Called by: PRITVADM  *
.*               Print a line in the statement body for THC                 *
.****************************************************************************
.
PLIN0000  MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PLIN9999
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY      * load invoice date
          MOVE      CMON,FORM2                   * load month
          CALL      FDAT0000                     * format date
.
          COMPARE   THIRTY3,CLNO                 * page full ?
          IF        !@LESS
            CALL      TTHC0000                   * yes - print tail
            ADD       ONE,PAGENUM                * increment page number
            CALL      HTHC0000                   * yes - print header
          ENDIF
.
.         Calculate the ageing of the debt if outstanding balance exists.
.         If an invoice is in credit, then this is part of the current debt.
.
          IF        TOTBAL > 0
            CALL      TAGE0000
            ASSIGN    (OVERDUE+AGEING[3]),OVERDUE
            ADD       AGEING[4],CURRENT
          ELSE
            IF        TOTBAL < 0
              ADD       TOTBAL,CURRENT           * account in credit
            ENDIF
          ENDIF
          ADD       TOTBAL,RUNBAL                * update running balance
.
          PRINT     *6,PINVNO,*15,DIM9,*52,PINVADM,*66,TOTBAL:
                    *77,RUNBAL,*92,PINVNO,*104,TOTBAL
.
          ADD       ONE,CLNO
.
PLIN9999  RETURN
+
.*****************************************************************************
.*                             TAGE0000                Called by: PLIN0000   *
.*        calculate the ageing for the THC statements                        *
.* Returns: AGEING[3] = debts > 30 days old                                  *
.*          AGEING[4] = debts < 31 days old                                  *
.*****************************************************************************
.
TAGE0000  MOVE      ZERO,AGEING[3]
          MOVE      ZERO,AGEING[4]
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          PACK      CDYSFDTE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CDYSFDTE
          PACK      CDYSTDTE,CCC,CYY,CMM,CDD     * load current date
          REP       " 0",CDYSTDTE
          CALL      CALCDAYS                     * number of days
          SUB       ONE,CDYSDAYS                 * get difference
.
          MOVE      ZERO,AMOUNT                  * total outstanding debt
          ADD       PINVAMT,AMOUNT
          ADD       PINVPATA,AMOUNT
          ADD       PINVHFDA,AMOUNT
          ADD       PINVOTHA,AMOUNT
          ADD       PINVJOUR,AMOUNT
          ADD       PTINCRTT,AMOUNT                                   *I-140395
.
          IF        CDYSDAYS > 30
            ADD       AMOUNT,AGEING[3]           * 31 days+ debt
          ELSE
            ADD       AMOUNT,AGEING[4]           * current debt
          ENDIF
.
TAGE9999  RETURN
+
.****************************************************************************
.*                               HTHC0000              Called by: PLIN0000  *
.*                       Print header of THC statement            GTHC0000  *
.****************************************************************************
.
HTHC0000  PRINT     *N,*N,*N,*44,PFNAME,*80,CURRDATE:
                    *N,*44,PKADD1:
                    *N,*44,PKADD2,*80,PURNO:
                    *N,*44,PKSUBR:
                    *N,*44,PKADD4:
                    *N,*44,PKPOST,*80,PAGENUM:
                    *N,*N,*92,PFNAME:
                    *N,*N,*N,*92,PURNO,*104,CURRDATE,*N,*N;
.
          MOVE      TEN6,CLNO                    * initialise line count
.
HTHC9999  RETURN
+
.****************************************************************************
.*                               TTHC0000              Called by: PLIN0000  *
.*                        Print tail of THC statement             GTHC0000  *
.****************************************************************************
.
.         Print blank lines until we are at the second bottom line of the 
.         body of the statement
.
TTHC0000  WHILE     CLNO < 34
            PRINT     *N;
            ADD       ONE,CLNO
          DO
.
.         Print message at bottom of body of statement
.
          PRINT     *N
.
.         Check if we have printed the last record for the current U/R, and
.         if so, print ageing details and total outstanding balance
.
          COMPARE   ZERO,ENDFLAG                 * last record printed for U/R ?
          IF        @EQUAL
            PRINT     *F                         * no - form feed then finish
            GOTO      TTHC9999 IF EQUAL
          ENDIF
.
          PRINT     *N,*102,RUNBAL               * yes - print total
.
.         If there is any overdue debt, then print a warning
.
          IF        OVERDUE > 0 & RUNBAL > 0
            PRINT     *N,*6,"PART OF THE BALANCE IS OVERDUE.  IF PAYMENT":
                      *N,*6,"IS NOT MADE WITHIN 7 DAYS THEN YOUR FILE";
          ELSE
            PRINT     *N,*N;
          ENDIF
.
          PRINT     *50,CURRENT,*61,OVERDUE,*75,RUNBAL;      * print ageing
          IF        OVERDUE > 0
            PRINT     *N,*6,"MAY BE REFERRED TO DUNN & BRADSTREET FOR":
                      *N,*6,"COLLECTION ACTION."
          ENDIF
.
TTHC9999  RETURN
+
.*************************************************************************
.
.*************************************************************************
.
.         I/Os for Option 3's Temp file
.
RSTEMP1   READ      TMPFILO3,KEY8;;
          RETURN
.
RKTEMP1   MOVE      ZERO,OVRCD
          READKS    TMPFILO3;XXURNO,XXSNAME,XXGNAME,XXITYPE,XXSPARE
          GOTO      OVERCOND IF OVER
          RETURN
.
RATEMP1   RESET     KEY8
          MOVE      ZERO,OVRCD
          READ      TMPFILO3,KEY8;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDTEMP1   RESET     KEY8
          MOVE      ZERO,OVRCD
          READ      TMPFILO3,KEY8;XXURNO,XXSNAME,XXGNAME,XXITYPE,XXSPARE
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   RESET     KEY8
          WRITE     TMPFILO3,KEY8;XXURNO,XXSNAME,XXGNAME,XXITYPE,XXSPARE
          RETURN
.
UPTEMP1   UPDATE    TMPFILO3;XXURNO,XXSNAME,XXGNAME,XXITYPE,XXSPARE
          RETURN
.
.         I/Os for Option 3's Temp file (for THC - surname sequence)
.
RSTEMP2   READ      TMPFILO4,KEY53;;
          RETURN
.
RKTEMP2   MOVE      ZERO,OVRCD
          READKS    TMPFILO4;XXURNO,XXSNAME,XXGNAME,XXITYPE,XXSPARE
          GOTO      OVERCOND IF OVER
          RETURN
+
OPEN0000
CLOS0000
GETSVAR   RETURN
.
******************************************************************************
* WWUR0000       Process West Wimmera Statements by UR                       *
******************************************************************************
.
WWUR0000  CALL      CRET0000   * Setup Appropriate Temp File
.         
          MOVE      ZERO,AGEING[1]
          MOVE      ZERO,AGEING[2]
          MOVE      ZERO,AGEING[3]
          MOVE      ZERO,AGEING[4]
.
.         Get all the invoices for this patient's visits
.
          PACK      KEY24,PURNO,SP20
          CALL      RDSVISA2                     * position in file
WWUR1000  CALL      RDKVISA2                     * read next record
          BRANCH    OVRCD,WWUR2200               * eof - finished
.
          MATCH     PURNO,PVIURNO                * same U/R still ?
          GOTO      WWUR2200 IF NOT EQUAL        * no - finished
.
          COMPARE   SIX,PVITYPE                  * community visit ?
          GOTO      WWUR1000 IF EQUAL            * yes - ignore
.
WWUR2000  CALL      FWPT0000                     * get invoices for admission
          GOTO      WWUR1000                     * get next visit
.
WWUR2200  CALL      FWPP0000                     * get Pri. Invoices for U/R
.
          CALL      DWUR0000                     * display all invoices
.
          BRANCH    RECFLG,WWUR2500              * records found
.
.         No records were found
.
WWUR2300  DISPLAY   *P1:24,*EL,*B,"No Statement Found.  ";
          CALL      HITENTER
          GOTO      WWUR9999
.
.         Check if statement is to be printed
.
WWUR2500  KEYIN     *P1:24,*EL,"Print This Statement (",*V2LON,*DV,ANSY:
                    *HOFF,*DV,SLASH,*V2LON,*DV,ANSN,*HOFF,") ? ",ANS;
.
          REP       "Y1y1N2n2",ANS
          MOVE      ANS,FORM1
.
          BRANCH    FORM1,WWUR5000:              * Yes
                          WWUR9999               * No
          BEEP                                   * invalid
          GOTO      WWUR2500                  
.
WWUR5000  CALL      WLAD0000                     * update tempfile with latest
.                                                * admission number for PRA
          CALL      PWUR0000                     * print statement
.
          DISPLAY   *P1:24,*EL,*V2LON:
                    "***  Print Statement Generation Completed  ***",*W2;
.
          MATCH     "IBARSH",PGM
          GOTO      WWUR9999 IF EQUAL
.
          CALL      CLSPRINT
          GOTO      WWUR9999
.
WWUR8000  MATCH     "IBARSH",PGM
          GOTO      WWUR9000 IF EQUAL
.
          KEYIN     *P1:24,*EL,"Display More (",*V2LON,ANSY,*HOFF,SLASH:
                    *V2LON,ANSN,*HOFF,") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
          MATCH     ANSN,ANS
          GOTO      ENDDISP1 IF EQUAL
          DISPLAY   *P1:9,*EF;
.
WWUR9000  MOVE      NINE,CVERT
          BRANCH    RECFLG,WWUR2500
          GOTO      WWUR2300
.
WWUR9999  RETURN
+
******************************************************************************
* FWPT0000       Display West Wimmera Invoices - Patient System              *
******************************************************************************
.
FWPT0000  PACK      KEY16,PVIBILL,SP8
          CALL      RDSINV3                      * position in file
FWPT1000  CALL      RDKINV3                      * read next record
          BRANCH    OVRCD,FWPT9999               * eof - finished
.
          MATCH     PVIBILL,PINVADM              * same visit number ?
          GOTO      FWPT9999 IF NOT EQUAL        * no - finished
.
          MOVE      ZERO,DOPRIVPR                * set for pat. system
          CALL      WCAL0000                     * calculate out. balance
.
          BRANCH    PRTALL,FWPT2000              * printing all
          COMPARE   ZERO,STOTBAL                 * zero balance ?
          GOTO      FWPT1000 IF EQUAL            * yes - ignore
.
FWPT2000  MOVE      ZERO,DOPRIVPR
          CALL      SAGE0000                     * calculate invoice ageing
.
          MOVE      ONE,RECFLG                   * set flag for records found
.
FWPT3000  UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.             
          MOVE      ZERO,DOPRIVPR                * set flag for PAT. system
          CALL      WTUR0000                     * write Invoice to temp File
          GOTO      FWPT1000
.
FWPT9999  RETURN
+
******************************************************************************
* FWPP0000          Find Invoices for Private Practice                       *
******************************************************************************
.
FWPP0000  OPEN      PRIINVO3,"priinvof"
          MOVE      SP6,PREVPRAC
          PACK      KEY18,PURNO,SP20
          CALL      RSPRIN3                      * position in file
FWPP1000  CALL      RKPRIN3                      * read next record
          BRANCH    OVRCD,FWPP9999               * eof - finished
.
          MATCH     PURNO,PRINDEBT               * same debtor ?
          GOTO      FWPP9999 IF NOT EQUAL        * no - finished
.
          IF        PRINSCAN<>1   
              GOTO      FWPP1000                 * not PMI patient
          ENDIF
.
          MOVE      ONE,DOPRIVPR                 * set for PRI. system
          CALL      WCAL0000                     * calculate outstand. balance
.
          BRANCH    PRTALL,FWPP2000              * printing all
          COMPARE   ZERO,STOTBAL                 * zero balance ?
          GOTO      FWPP1000 IF EQUAL            * yes - ignore
.
FWPP2000  MOVE      ONE,DOPRIVPR
          CALL      SAGE0000                     * calculate invoice ageing
.
          MOVE      ONE,RECFLG                   * set flag for records found
.
          MOVE      ONE,DOPRIVPR                 * set flag for PRI
          IF        PTCNINVL=9
            CALL      WTUR0000                   * write record to temp file
          ELSE
.                                                                     *I-140395
            IF        HOPTION = 3                  
....          MATCH     FROMDAT8,PRINDATE        * check "from" date
....          GOTO      FWPP1000 IF LESS
              MATCH     PRINDATE,TODATE8         * check "to" date
              GOTO      FWPP1000 IF LESS
            ENDIF
            CALL      PTUR0000                   * print Private Prac Invoice 
          ENDIF
          GOTO      FWPP1000                     * get next record
.
FWPP9999  RETURN
+
******************************************************************************
* DWUR0000          Read Temp File and Display All West Wimmera Invoices     *
******************************************************************************
.
DWUR0000  MOVE      ZERO,TOTBAL
          PACK      KEY17,SP20
          CALL      RSWTMP1                      * position at start of file
DWUR1000  CALL      RKWTMP1                      * read next record
          BRANCH    OVRCD,DWUR8200               * eof - finished
.
          UNPACK    WWINVDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MATCH     "P",WWINVSYS                 * PRI invoice ?
          GOTO      DWUR2000 IF NOT EQUAL        * no
.
          MOVE      "Diag. Billing",SYSDESC      * yes
          GOTO      DWUR3000  
.
DWUR2000  MOVE      WWINVSYS,FORM1
          LOAD      SYSDESC,FORM1,AAEDESC,OUTDESC,INPDESC,OTHDESC,DAYDESC
.
DWUR3000  COMPARE   TWENTY2,CVERT                * screen full ?
          GOTO      DWUR7000 IF NOT LESS         * yes
.
DWUR5000  DISPLAY   *P1:CVERT,CPCDATE,*P20:CVERT,"Invoice No.:  ",WWINVNO:
                    *P50:CVERT,SYSDESC:
                    *P67:CVERT,WWINVBAL
          ADD       ONE,CVERT
          ADD       WWINVBAL,TOTBAL
.
          GOTO      DWUR1000
.
DWUR7000  MOVE      SP1,ANS
          KEYIN     *P1:24,*EL,"Display More (",*V2LON,"Y",*HOFF,"/":
                    *V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
          PACK      ANS,ANS,SP1
          REP       UPPLOW,ANS
.
          MATCH     ANSN,ANS
          GOTO      DWUR9000 IF EQUAL
.
          MATCH     ANSY,ANS
          GOTO      DWUR8000 IF EQUAL
.
          BEEP
          GOTO      DWUR7000
.
DWUR8000  DISPLAY   *P1:9,*EF;
          MOVE      NINE,CVERT
          GOTO      DWUR5000
.
DWUR8200  COMPARE   TWENTY1,CVERT
          GOTO      DWUR8600 IF NOT LESS
          ADD       ONE,CVERT
          DISPLAY   *P50:CVERT,*V2LON,"Total : ",*P67:CVERT,TOTBAL
          GOTO      DWUR9000
.
DWUR8600  DISPLAY   *P1:9,*EF;
          MOVE      NINE,CVERT
          GOTO      DWUR8200
.
DWUR9000  MOVE      ZERO,EXIT
.
DWUR9999  RETURN
+
******************************************************************************
* PTUR0000      Print Private Practice Invoice line                           *
******************************************************************************
PTUR0000  MOVE      ZERO,EXIT
          BRANCH    PRIVPRAC,PTUR1000       * first time into Private Prac.
.
....      CALL      TLHEAD                  * force a new page with headings
....      PRINT     *N,*1,"Private Practice Visits",*N
....      ADD       TWO,COUNT
          MOVE      ONE,PRIVPRAC
.
PTUR1000  MATCH     PREVPRAC,PRINPRAC
          GOTO      PTUR1500 IF EQUAL
.
          CALL      PPPR0000
          PRINT     *1,PRPRDESC," - ",DOCNAME,*N
          ADD       TWO,COUNT
.
PTUR1500  MOVE      ZERO,STOTBAL
          ADD       PRINITOT,STOTBAL
          ADD       PRINPAMT,STOTBAL
          ADD       PRINHAMT,STOTBAL
          ADD       PRINIAMT,STOTBAL
          ADD       PRINMAMT,STOTBAL
          ADD       PRINVAMT,STOTBAL
          ADD       PRINOTHA,STOTBAL
          ADD       PRINJAMT,STOTBAL
          ADD       PRINCNTT,STOTBAL       * sub Credit Note         *I-140395
          ADD       STOTBAL,TOTBAL
.
          MOVE      ZERO,FORM1
.
PTUR2000  MOVE      ZERO,EXIT
.                                          * check for statement length
          IF        PTCNINVL=2
            COMPARE   TWENTY4,COUNT         *Anne Caudle invoice
            CALL      TLHEAD IF NOT LESS
          ELSE
            IF        PTCNINVL=6
              COMPARE   TWENTY8,COUNT
              CALL      TLHEAD IF NOT LESS
            ELSE
              IF        PTCNINVL=9
                COMPARE   TWENTY7,COUNT            
                CALL      TLHEAD IF NOT LESS
              ELSE
                COMPARE   TWENTY2,COUNT            
                CALL      TLHEAD IF NOT LESS       
              ENDIF
            ENDIF     
          ENDIF
.
          ADD       ONE,FORM1
          BRANCH    FORM1,PTUR3001,PTUR3002,PTUR3003,PTUR3004,PTUR3005:
                          PTUR3006,PTUR3007,PTUR3008,PTUR3009
          PRINT     *N;
          ADD       ONE,COUNT
          GOTO      PTUR9999
.
PTUR3001  MOVE      PRINDATE,KEY8
          UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *1,CPDATE;
.
          MOVE      ONE,DOPRIVPR
          CALL      SAGE0000                * do the statement ageing
.
          IF        PTCNINVL=9
              PRINT     *12,"Inv. No: ",PRINNUMB,*66,PRINITOT
          ELSE
              PRINT     *25,"Invoice No: ",PRINNUMB,*66,PRINITOT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3002  COMPARE   ZERO,PRINPAMT
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Patient",*66,PRINPAMT
          ELSE
              PRINT     *27,"Receipt/s From Patient",*66,PRINPAMT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3003  COMPARE   ZERO,PRINHAMT
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Health Fund",*66,PRINHAMT
          ELSE
              PRINT     *27,"Receipt/s From Health Fund",*66,PRINHAMT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3004  COMPARE   ZERO,PRINIAMT
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Insurer",*66,PRINIAMT
          ELSE
              PRINT     *27,"Receipt/s From Insurer",*66,PRINIAMT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3005  COMPARE   ZERO,PRINMAMT
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Medicare",*66,PRINMAMT
          ELSE
              PRINT     *27,"Receipt/s From Medicare",*66,PRINMAMT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3006  COMPARE   ZERO,PRINVAMT
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Veteran Affairs",*66,PRINVAMT
          ELSE
              PRINT     *27,"Receipt/s From Veteran Affairs",*66,PRINVAMT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3007  COMPARE   ZERO,PRINOTHA
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Receipt(s) From Insurer",*66,PRINOTHA
          ELSE
              PRINT     *27,"Receipt/s From Insurer",*66,PRINOTHA
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3008  COMPARE   ZERO,PRINJAMT
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Journals",*66,PRINJAMT
          ELSE
              PRINT     *27,"Journals",*66,PRINJAMT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR3009  COMPARE   ZERO,PRINCNTT
          GOTO      PTUR2000 IF EQUAL
.
          IF        PTCNINVL=9
              PRINT     *12,"Credit Note/s",*66,PRINCNTT
          ELSE
              PRINT     *27,"Credit Note/s",*66,PRINCNTT
          ENDIF
          ADD       ONE,COUNT
          GOTO      PTUR2000
.
PTUR9999  RETURN
+
******************************************************************************
* PPPR0000       Get Private Practice details                                 *
******************************************************************************
PPPR0000  MOVE      PRINPRAC,PREVPRAC                          
.
          MOVE      "Unknown practice",PRPRDESC  * get medical practice name
          PACK      KEY6,PRINPRAC
          CALL      RDPRPR1
.
          MOVE      "Unknown doctor",DOCNAME     * get serv. doctor name
          PACK      KEY6,PRINDOCT
          PACK      KEY10,PRINDOCT,SP10
          CALL      RDPMHCP1
          BRANCH    OVRCD,PPPR9999               * not on file
.
          MOVE      PMHCTITL,PACTITLE            * format doctor name
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCSNAM,PACSNAME
          MOVE      ONE,PACFRMT
.
          CALL      PACNAME
          MOVE      PACFNAME,DOCNAME
.
PPPR9999  RETURN
+
******************************************************************************
* WTUR0000       Write an Invoice to the WWH Temp File Using HOPTION 2        *
******************************************************************************
.
WTUR0000  BRANCH    DOPRIVPR,WTUR5000            * PRI invoice
.
.         Patient invoice
.
          PACK      WWINVDTE,PINVDTE
          MOVE      PINVNO,WWINVNO
          MOVE      PINVAMT,WWINVTOT
          MOVE      PINVSYS,WWINVSYS
          MOVE      PINVUR,WWURNO
          MOVE      STOTBAL,WWINVBAL
          MOVE      DPINVADM,WWADMN
          MOVE      PINVSYS,WWSYS
.
          PACK      KEY25,WWINVDTE,WWINVNO,WWINVSYS
          CALL      WRWTMP1                      * write new record
          GOTO      WTUR9999
.
.         PRI Invoice
.
WTUR5000  MOVE      PRINDATE,WWINVDTE
          MOVE      PRINNUMB,WWINVNO
          MOVE      PRINITOT,WWINVTOT
          MOVE      "P",WWINVSYS
          MOVE      PRINDEBT,WWURNO
          MOVE      STOTBAL,WWINVBAL
          MOVE      SP8,WWADMN
.
          PACK      KEY17,WWINVDTE,WWINVNO,WWINVSYS
          CALL      WRWTMP1                      * write new record
.
WTUR9999  RETURN
+
******************************************************************************
* WLAD0000       Update the West Wimmera tempfile with the latest adm no     *
******************************************************************************
.
WLAD0000  PACK      KEY25,SP25
          CALL      RSWTMP2
          CALL      RKWTMP2               * Position at start of tempfile
          BRANCH    OVRCD,WLAD9999
.
          MOVE      WWURNO,SAVURNO
.
WLAD1000  CALL      RKWTMP2
          BRANCH    OVRCD,WLAD9999
.
          MATCH     WWURNO,SAVURNO
          GOTO      WLAD1000 IF EQUAL
.
          CALL      RPWTMP2               * Read previous record
          BRANCH    OVRCD,WLAD9999
.
          MOVE      WWADMN,SAVADMN
          MOVE      WWSYS,SAVSYS
.
          PACK      KEY25,SAVURNO,SP20
          CALL      RSWTMP2
WLAD1500  CALL      RKWTMP2
          BRANCH    OVRCD,WLAD9999
.
          MATCH     SAVURNO,WWURNO
          IF        @EQUAL
            MOVE      SAVADMN,WWADMN
            MOVE      SAVSYS,WWSYS
            CALL      UPWTMP2
          ELSE 
            GOTO      WLAD1700
          ENDIF
.
          GOTO      WLAD1500
.
WLAD1700  PACK      KEY25,SAVURNO,Z30
WLAD2000  CALL      RKWTMP2
          MATCH     SAVURNO,WWURNO
          GOTO      WLAD2000 IF EQUAL
.
          MOVE      WWURNO,SAVURNO
          GOTO      WLAD1000
.
WLAD9999  RETURN
+
******************************************************************************
* PWUR0000       Print West Wimmera Statement                                *
******************************************************************************
.
PWUR0000  MATCH     "IBARSH",PGM
          GOTO      PWUR0500 IF EQUAL
.
          CALL      OPNPRINT
PWUR0500  CALL      GETPNAM
          MATCH     SP8,WWADMN
          IF        !@EQUAL
            CALL      GETPRES
            GOTO      PWUR1300
          ENDIF
.
          PACK      KEY18,WWURNO,ANS1,SP10
          OPEN      PRIINVO3,"priinvof"
          CALL      RSPRIN3                      * invoice on file ?
PWUR1250  CALL      RKPRIN3
          BRANCH    OVRCD,PWUR1300
.
          MATCH     PRINDEBT,WWURNO
          GOTO      PWUR1250 IF EQUAL
.
          CALL      RPPRIN3
          BRANCH    OVRCD,PWUR1300
.
          MOVE      PRINNAMR,PFNAME
          MOVE      PRINPRA1,PKADD1
          MOVE      PRINPRA2,PKADD2
          MOVE      PRINPRA3,PKSUBR
          MOVE      PRINPRA4,PKADD4
          MOVE      PRINPOST,PKPOST
.
PWUR1300  MOVE      ZERO,PAGENO
          CALL      HEAD
.
          MOVE      "ZZZZZ9.99",AGEMASK1
          MOVE      "ZZZZZ9.99",AGEMASK2
          MOVE      "ZZZZZ9.99",AGEMASK3
          MOVE      "ZZZZZ9.99",AGEMASK4
.
          IF        AGEING[1]=0
             EDIT   AGEING[1],AGEMASK1
          ELSE
             MOVE   AGEING[1],AGEMASK1
          ENDIF
.
          IF        AGEING[2]=0
             EDIT   AGEING[2],AGEMASK2
          ELSE
             MOVE   AGEING[2],AGEMASK2
          ENDIF
.
          IF        AGEING[3]=0
             EDIT   AGEING[3],AGEMASK3
          ELSE
             MOVE   AGEING[3],AGEMASK3
          ENDIF
.
          IF        AGEING[4]=0
             EDIT   AGEING[4],AGEMASK4
          ELSE
             MOVE   AGEING[4],AGEMASK4
          ENDIF
.
          MOVE      ZERO,TOTBAL
          PACK      KEY17,SP20      
          CALL      RSWTMP1
PWUR1000  CALL      RKWTMP1
          BRANCH    OVRCD,PWUR9000
.
          UNPACK    WWINVDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,INVDATE                * SRF 639008
.
          MATCH     "P",WWINVSYS
          GOTO      PWUR3000 IF NOT EQUAL
.
          MOVE      "Diag. Billing",SYSDESC
          GOTO      PWUR3500
.
PWUR3000  MOVE      WWINVSYS,FORM1
          LOAD      SYSDESC,FORM1,AAEDESC,OUTDESC,INPDESC,OTHDESC,DAYDESC
.
. -- Using variable INVDATE instead of CPCDATE ..  SRF 639008
.
PWUR3500  IF        COUNT<27
             PRINT     *1,INVDATE,*12,"Inv. No: ",WWINVNO,*31,SYSDESC:
                       *67,WWINVBAL
             ADD       ONE,COUNT
          ELSE
             CALL      TLHEAD
             PRINT     *1,INVDATE,*12,"Inv. No: ",WWINVNO,*31,SYSDESC:
                       *67,WWINVBAL
             ADD       ONE,COUNT
          ENDIF
          ADD       WWINVBAL,TOTBAL
          GOTO      PWUR1000
.
PWUR9000  WHILE     COUNT<29
              PRINT    *N;
              ADD      ONE,COUNT
          DO
          CALL      ENDPRT18
.
PWUR9999  RETURN
+
******************************************************************************
* WWDT0000       Print Wimmera Statements by Date Range                      *
******************************************************************************
.
.         First loop through all invoices in the date range from patinvrf
.
WWDT0000  PACK      KEY16,FROMDAT8,SP20
          CALL      RDSINV2                      * position in file
WWDT1000  CALL      RDKINV2                      * read next record
          BRANCH    OVRCD,WWDT5000               * eof - finished loop
.
          MATCH     PINVDTE,TODATE8              * still in date range ?
          GOTO      WWDT5000 IF LESS             * no - finished loop
.
          MATCH     "       0",DPINVADM          * has invoice been cancelled ?
          GOTO      WWDT1000 IF EQUAL            * yes - ignore invoice
.
          MATCH     STCLM,PINVCLM                * valid claim code ?
          GOTO      WWDT1000 IF LESS             * no - ignore invoice
.
          MATCH     PINVCLM,EDCLM                * valid claim code ?
          GOTO      WWDT1000 IF LESS             * no - ignore invoice
.
          MOVE      ZERO,DOPRIVPR                * set flag for patient invoice
          CALL      WCAL0000                     * Calculate invoice balance
.
          BRANCH    PRTALL,WWDT2000              * printing all invoices
          COMPARE   ZERO,STOTBAL                 * outstanding balance zero ?
          GOTO      WWDT1000 IF EQUAL            * yes - ignore
.
WWDT2000  PACK      WWINVDTE,PINVDTE
          MOVE      PINVNO,WWINVNO
          MOVE      PINVAMT,WWINVTOT
          MOVE      PINVSYS,WWINVSYS
          MOVE      PINVUR,WWURNO
          MOVE      STOTBAL,WWINVBAL
          MOVE      DPINVADM,WWADMN
          MOVE      PINVSYS,WWSYS
          CALL      WRWTMP2                      * write invoice to temp file
.
          LOAD      SYSDESC,PINVSYS,AAEDESC,OUTDESC,INPDESC,OTHDESC,DAYDESC
          DISPLAY   *P40:24,*EL,*V2LON,SYSDESC,SP2,PINVUR 
          GOTO      WWDT1000
.
.         Secondly, loop through all invoices in the date range in priinvof
.
WWDT5000  OPEN      PRIINVO2,"priinvof"
          PACK      KEY16,FROMDAT8,SP10
          CALL      RSPRIN2                      * position in file
WWDT6000  CALL      RKPRIN2                      * read next record
          BRANCH    OVRCD,WWDT8000               * eof - finished loop
.
          MATCH     PRINDATE,TODATE8             * invoice in date range ?
          GOTO      WWDT8000 IF LESS             * no - finished loop
.
          COMPARE   PRINSCAN,ONE                 * PMI patient ?
          GOTO      WWDT6000 IF NOT EQUAL        * no - ignore
.
          MATCH     STCLM,PRINCLAM               * valid claim code ?
          GOTO      WWDT6000 IF LESS             * no - ignore
.
          MATCH     PRINCLAM,EDCLM               * valid claim code ?
          GOTO      WWDT6000 IF LESS             * no - ignore
.
          MOVE      ONE,DOPRIVPR                 * set flag for patient invoice
          CALL      WCAL0000                     * calculate invoice balance
.
          BRANCH    PRTALL,WWDT7000              * printing all invoices
          COMPARE   ZERO,STOTBAL                 * zero outstanding balance ?
          GOTO      WWDT6000 IF EQUAL            * yes - ignore
.
WWDT7000  MOVE      PRINDATE,WWINVDTE
          MOVE      PRINNUMB,WWINVNO
          MOVE      PRINITOT,WWINVTOT
          MOVE      ANSP,WWINVSYS
          MOVE      PRINDEBT,WWURNO
          MOVE      STOTBAL,WWINVBAL
          MOVE      ANSP,WWSYS
          MOVE      SP8,WWADMN
          CALL      WRWTMP2                      * write invoice to temp file
.
          MOVE      "Diag. Billing",SYSDESC
          DISPLAY   *P40:24,*EL,*V2LON,SYSDESC,SP2,PRINDEBT
          GOTO      WWDT6000
.
. ----- U/R's have been compiled -----
.
WWDT8000  CALL      WLAD0000
          CALL      WPDT0000                     * print statements
.
WWDT9999  RETURN
+
******************************************************************************
* WCAL0000       Calculate Balance of Invoices for WWH using  HOPTION 3       *
******************************************************************************
.
WCAL0000  MOVE      ZERO,STOTBAL                 * initialise outstanding bal.
.
          BRANCH    DOPRIVPR,WCAL5000            * PRI invoice
.
.         Calculate outstanding balance on patient invoice
.
          ADD       PINVAMT,STOTBAL
          ADD       PINVPATA,STOTBAL
          ADD       PINVHFDA,STOTBAL
          ADD       PINVOTHA,STOTBAL
          ADD       PINVJOUR,STOTBAL
          ADD       PTINCRTT,STOTBAL        * sub Credit Note         *I-140395
.
          GOTO      WCAL9999
.
.         Calculate outstanding balance on PRI invoice
.
WCAL5000  ADD       PRINITOT,STOTBAL
          ADD       PRINPAMT,STOTBAL
          ADD       PRINHAMT,STOTBAL
          ADD       PRINIAMT,STOTBAL
          ADD       PRINMAMT,STOTBAL
          ADD       PRINVAMT,STOTBAL
          ADD       PRINOTHA,STOTBAL
          ADD       PRINJAMT,STOTBAL
          ADD       PRINCNTT,STOTBAL        * sub Credit Note         *I-140395
.
WCAL9999  RETURN
+
******************************************************************************
* WPDT0000      Print West Wimmera Invoices                                  *
******************************************************************************
.
WPDT0000  MATCH     "IBARSH",PGM
          GOTO      WPDT0500 IF EQUAL
.
          CALL      OPNPRINT                     * open spool file
.
WPDT0500  MOVE      ZERO,TOTBAL
          PACK      KEY25,SP30
          CALL      RSWTMP2                      * position at start of file
WPDT1000  CALL      RKWTMP2                      * read next record
          BRANCH    OVRCD,WPDT9000               * eof - finished
.
          PACK      KEY8,WWURNO
WPDT1200  CALL      RDMAST1                      * U/R on file ?
          BRANCH    OVRCD,WPDT1000               * no - ignore (shouldnt happen)
.
          CALL      GETPNAM                      * format name
          MATCH     SP8,WWADMN
          IF        !@EQUAL
            CALL      GETPRES
            GOTO      WPDT1300
          ENDIF
.
          PACK      KEY18,WWURNO,ANS1,SP10
          OPEN      PRIINVO3,"priinvof"
          CALL      RSPRIN3                      * invoice on file ?
WPDT1250  CALL      RKPRIN3
          BRANCH    OVRCD,WPDT1500
.
          MATCH     PRINDEBT,WWURNO
          GOTO      WPDT1250 IF EQUAL
.
          CALL      RPPRIN3
          BRANCH    OVRCD,WPDT1300
.
          MOVE      PRINNAMR,PFNAME
          MOVE      PRINPRA1,PKADD1
          MOVE      PRINPRA2,PKADD2
          MOVE      PRINPRA3,PKSUBR
          MOVE      PRINPRA4,PKADD4
          MOVE      PRINPOST,PKPOST
.
WPDT1300  CALL      HEAD28
.
WPDT1500  MATCH     WWINVSYS,ANSP                * PRI invoice ?
          GOTO      WPDT2000 IF EQUAL            * yes
.
.         Patient system invoice
.
          PACK      KEY8,WWINVNO
WPDT1800  CALL      RDINV1                       * invoice on file ?
          BRANCH    OVRCD,WPDT3500               * no - ignore
.
          MOVE      ZERO,DOPRIVPR                * set for pat. system
          CALL      SAGE0000                     * calculate ageing
.
          MOVE      AMOUNT,PAMOUNT
          MOVE      PINVNO,PINVOICE
          MOVE      PINVSYS,FORM1
.
          LOAD      SYSDESC,FORM1,AAEDESC,OUTDESC,INPDESC,OTHDESC,DAYDESC
          DISPLAY   *P29:24,*EL,"Printing : ",*V2LON,SYSDESC,SP2,PINVUR
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          GOTO      WPDT3000
.
.         PRI invoice 
.
WPDT2000  PACK      KEY8,WWINVNO
          OPEN      PRIINVO1,"priinvof"
          CALL      RDPRIN1                      * invoice on file ?
          BRANCH    OVRCD,WPDT3500               * no - ignore
.
          MOVE      ONE,DOPRIVPR                 * set flag for PRI
          CALL      SAGE0000                     * calculate ageing
.
          MOVE      AMOUNT,PAMOUNT
          MOVE      PRINNUMB,PINVOICE
.
          MOVE      "Diag. Billing",SYSDESC
          DISPLAY   *P29:24,*EL,"Printing : ",*V2LON,SYSDESC,SP2,PRINDEBT
          UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
WPDT3000  IF        COUNT<27
              PRINT     *1,CPDATE:
                        *12,"Inv. No: ",PINVOICE,*34,SYSDESC,*66,PAMOUNT
              ADD        ONE,COUNT
              ADD        PAMOUNT,TOTBAL
          ELSE
              CALL      TAIL
              PRINT     *1,CPDATE:
                        *12,"Inv. No: ",PINVOICE,*34,SYSDESC,*66,PAMOUNT
              ADD        ONE,COUNT
              ADD        PAMOUNT,TOTBAL
          ENDIF
.
WPDT3500  CALL      RKWTMP2
          BRANCH    OVRCD,WPDT5000
.
          MATCH     WWURNO,PURNO
          IF        !@EQUAL
              GOTO      WPDT5000
          ELSE
              GOTO  WPDT1500
          ENDIF
.
WPDT5000  IF        OVRCD=1
            MOVE      ONE,ENDFLG
          ENDIF
          MOVE      "ZZZZZ9.99",AGEMASK1
          MOVE      "ZZZZZ9.99",AGEMASK2
          MOVE      "ZZZZZ9.99",AGEMASK3
          MOVE      "ZZZZZ9.99",AGEMASK4
.
          IF        AGEING[1]=0
             EDIT   AGEING[1],AGEMASK1
          ELSE
             MOVE   AGEING[1],AGEMASK1
          ENDIF
.
          IF        AGEING[2]=0
             EDIT   AGEING[2],AGEMASK2
          ELSE
             MOVE   AGEING[2],AGEMASK2
          ENDIF
.
          IF        AGEING[3]=0
             EDIT   AGEING[3],AGEMASK3
          ELSE
             MOVE   AGEING[3],AGEMASK3
          ENDIF
.
          IF        AGEING[4]=0
             EDIT   AGEING[4],AGEMASK4
          ELSE
             MOVE   AGEING[4],AGEMASK4
          ENDIF
. 
WPDT5500  IF        COUNT<29
              PRINT     *N;
              ADD       ONE,COUNT
              GOTO      WPDT5500
          ELSE 
              CALL      ENDPRT
              MOVE      ZERO,TOTBAL
              MOVE      ZERO,AGEING[1]
              MOVE      ZERO,AGEING[2]
              MOVE      ZERO,AGEING[3]
              MOVE      ZERO,AGEING[4]
          ENDIF
.
          BRANCH    ENDFLG,WPDT9000   * Finish, if end of Temp File #2
.
          PACK      KEY8,WWURNO
          GOTO      WPDT1200
.
WPDT9000  DISPLAY   *P1:24,*EL,*V2LON:
                    "***  Print Statement Generation Completed  ***",*W2;
.
          MATCH     "IBARSH",PGM
          GOTO      WPDT9999 IF EQUAL
.
          CALL      CLSPRINT                     * close spool file
.
WPDT9999  RETURN
+
WEBERR00  RETURN       * Required by PATINVL
+
.------------------------------------------------------------
. Procedure to get Doctor Code from Outpatient Clinic ID
. COPTION - 1 Return DOCTCODE
.           2 Output Location
.           3 (N/A)
.           4 Output Menu Type
.           5 Output Unit
.------------------------------------------------------------
          DEFPROC  OUTDET00
.
          INC      OUTPREFD/INC
          INC      OUTCLIFD/INC
          INC      OUTBOAFD/INC
          INC      OUTMA1FD/INC
          INC      OUTBB1FD/INC
.
KEYBOA    DIM      28
KEYCLI    DIM      20
.
          MOVE     SP70,DOCTCODE
          COMPARE  ZERO,PVITYPE
          GOTO     OUTDET50 IF EQUAL
.
          PACK     KEY6,PVISITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,PVISITE,PVIDOCT,PVIDATE,SP70
          BRANCH   COPTION,OUTDET60
.
          PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYBOA,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL     RDSBOKA1
OUTDET10  CALL     RDKBOKA1
          BRANCH   OVRCD,OUTDET95
          PACK     KEYBOA,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH    KEY20,KEYBOA
          GOTO     OUTDET95 IF NOT EQUAL
          MATCH    OBAOUTNO,PVIBILL         * Set up billing number
          GOTO     OUTDET10 IF NOT EQUAL
          GOTO     OUTDET80
.
OUTDET50  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     OUTPREA1,"outpreaf"   * Pre Attendance File
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
          MOVE     ADMISSNO,KEY8
          CALL     RDPREA1               * Check for Pre-Attendance
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY6,OPRSITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,OPRSITE,OPRCLIN,OPRDATE,SP70
          PACK     KEYBOA,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
.
          BRANCH   COPTION,OUTDET60,OUTDET70,OUTDET70,OUTDET70
.
OUTDET60  MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILCLIA1 * Determine Doctor from Clinic ID
          TRAP     OVERCOND IF IO
          OPEN     OUTCLIA1,KEY8         * Clinic Details
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY20,KEYCLI,SP70  * Read for Current Effective Clinic
          CALL     RDCLIA1
          COMPARE  ONE,OVRCD
          GOTO     OUTDET65 IF NOT EQUAL
.
          PACK     KEY20,KEYCLI,Z70  * Read for Current Effective Clinic
          CALL     RDSCLIA1
          CALL     RDPCLIA1
          BRANCH   OVRCD,OUTDET95
.
OUTDET65  MOVE     OCADOCT,DOCTCODE
          MATCH    SP70,DOCTCODE
          IF       @EQUAL
            MOVE     OCACCONS,DOCTCODE
          ENDIF
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET70  PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          MOVE     KEYBOA,KEY28
          CALL     RDBOKA1
          BRANCH   OVRCD,OUTDET95
.
OUTDET80  IF       COPTION=4
            PACK     MENUTYPE,TWO,OBASTAT * Outpatient Booking
            MOVE     ZERO,EXIT
            GOTO     OUTDET99
          ENDIF
.
          IF       COPTION=5
            PACK     CFNAME,OSTFILE,FILBB1A1
            CALL     OPOTBB11
            MOVE     ADMISSNO,KEY8
            CALL     RDBOKB1
            IF       OVRCD=0
              MATCH    SP6,OTBBDEPT
              GOTO     OUTDET95 IF EQUAL
              MOVE     OTBBDEPT,CODE       * Unit code
              MOVE     ZERO,EXIT
            ENDIF
            GOTO     OUTDET99
          ENDIF
.
          MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILMA1A1  * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTMA1A1,KEY8          * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT
          CALL     RDMASA1
          BRANCH   OVRCD,OUTDET95
.
          WRITE    HTMLFILE;OTMACLOC;
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET95  MOVE     ONE,EXIT
          GOTO     OUTDET99
.
          INC       OUTCLIIO/INC
          INC      OUTPREIO/INC
          INC       OUTBOAIO/INC
          INC       OUTMA1IO/INC
          INC       IBAOVRIO/INC
          INC       OUTBB1IO/INC
.
OUTDET99  ENDPROC
.------------------------------------------------------------
. Procedure to get Emergency Details
.   COPTION = 1 Return Consultant DOCTCODE
.             2 Output Location
.             3 Output Triage Status
.             4 Output Menu Type
.------------------------------------------------------------
          DEFPROC  EMRCHK00
.
          INC      EMRVISFD/INC
          INC      EMRLOCFD/INC
.
EMRCHK10  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     EMRVISA1,"emrvisaf"
          TRAPCLR  IO
          BRANCH   OVRCD,EMRCHK90
.
          MOVE     ADMISSNO,KEY8
          CALL     RDEMVIS1
          BRANCH   OVRCD,EMRCHK90
.
          COMPARE  FOUR,EMVISTAT
          GOTO     EMRCHK90 IF EQUAL
.
          MOVE     EMVIDOCT,DOCTCODE
          IF       COPTION=4
            PACK     MENUTYPE,ONE,EMVISTAT
            GOTO     EMRCHK99
          ENDIF
          IF       COPTION=2
            IF       EMVISTAT=1
              OPEN     EMRLOCA1,"emrlocaf"
              MOVE     "Other Departments",EMLODESC
              MOVE     EMVILOCN,KEY3
              CALL     RDEMLOC1
              WRITE    HTMLFILE;"Emergency - ",EMLODESC;
            ELSE
              WRITE    HTMLFILE;"Discharged";
            ENDIF
          ENDIF
          IF       COPTION=3
            WRITE    HTMLFILE;EMVITRIG;
          ENDIF
          GOTO     EMRCHK99
.
EMRCHK90  MOVE     PVIDOCT,DOCTCODE
          IF       COPTION=2
            WRITE    HTMLFILE;"Emergency";
          ENDIF
          GOTO     EMRCHK99
.
          INC      EMRVISIO/INC
          INC      EMRLOCIO/INC
          INC       IBAOVRIO/INC
.
EMRCHK99  ENDPROC
.------------------------------------------------------------------------
.         I/Os for West Wimmera's Temp File
.------------------------------------------------------------------------
.
.---- INDEX #1 ----
.
RSWTMP1   READ      WTMPFIL1,KEY17;;
          RETURN
.
RKWTMP1   MOVE      ZERO,OVRCD
          READKS    WTMPFIL1;WWINVDTE,WWINVNO,WWINVTOT,WWINVSYS:
                             WWURNO,WWADMN,WWINVBAL,WWSYS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDWTMP1   RESET     KEY17
          MOVE      ZERO,OVRCD
          READ      WTMPFIL1,KEY17;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
WRWTMP1   RESET     KEY17
          WRITE     WTMPFIL1,KEY17;WWINVDTE,WWINVNO,WWINVTOT,WWINVSYS:
                    WWURNO,WWADMN,WWINVBAL,WWSYS
          RETURN
.
.---- INDEX #2 ----
.
RSWTMP2   READ      WTMPFIL2,KEY25;;
          RETURN
.
RKWTMP2   MOVE      ZERO,OVRCD
          READKS    WTMPFIL2;WWINVDTE,WWINVNO,WWINVTOT,WWINVSYS,WWURNO:
                             WWADMN,WWINVBAL,WWSYS
          GOTO      OVERCOND IF OVER
          RETURN
.
.
RPWTMP2   MOVE      ZERO,OVRCD
          READKP    WTMPFIL2;WWINVDTE,WWINVNO,WWINVTOT,WWINVSYS,WWURNO:
                             WWADMN,WWINVBAL,WWSYS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDWTMP2   RESET     KEY25
          MOVE      ZERO,OVRCD
          READ      WTMPFIL2,KEY25;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
WRWTMP2   RESET     KEY25
          WRITE     WTMPFIL2,KEY25;WWINVDTE,WWINVNO,WWINVTOT,WWINVSYS,WWURNO:
                                   WWADMN,WWINVBAL,WWSYS
          RETURN
.
.
UPWTMP2   MOVE      ZERO,OVRCD
          UPDATE    WTMPFIL2;WWINVDTE,WWINVNO,WWINVTOT,WWINVSYS,WWURNO:
                                   WWADMN,WWINVBAL,WWSYS
          RETURN
..
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC
..==============================================================================
.
          INC       STD001IO
          INC       AAEDE1IO/INC
          INC       AAEDI1IO/INC
          INC       BOKRC1IO/INC
          INC       CALCAGE
          INC       CALCDAYS
          INC       CLPATMAS
          INC       CLPATVIS
          INC       PATHSPKY
          INC       EMRVISIO/INC
          INC       IBAPRNIO/INC
          INC       IBATMDIO/INC
          INC       IBATMHIO/INC
          INC       IBAPRINT
          INC       IBASECIO/INC
          INC       MLTCFNIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCLIIO/INC
          INC       OUTDTRIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
          INC       PATALERT
          INC       PATALRIO/INC 
          INC       PATCODKY
          INC       PATGBCRN                  * I-48227
          INC       PATHEAD
          INC       PATSTA28
          INC       PATINVL
          INC       PATINVHL
          INC       PATINVTL
          INC       SEXDSP00
.
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATFACIO/INC
          INC       PATFN1IO/INC
          INC       PATGSRIO/INC
          INC       PATHSPIO/INC
          INC       PATICDIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PMSTLEIO/INC
          INC       PATMI1IO/INC
          INC       PATNOBIO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       PATNIDIO/INC
          INC       PATSELFN
          INC       PMIHEAD 
          INC       PATCOMN1
          INC       PATSNDX
          INC       PATSNX2
          INC       GETALTID
          INC       NZIBSRCH
          INC       NZHISIIO
          INC       TFILENAM
          INC       NHIMASIO/INC
          INC       PRIINVIO/INC
          INC       PRIPRAIO/INC            * Private Practice Medical Practice
          INC       PMSHCPIO/INC            * Health Care Professional Table
          INC       PMSEVTIO/INC
          INC       PMSVX1IO/INC
          INC       PMSPRGIO/INC
          INC       WEBERRIO/INC
