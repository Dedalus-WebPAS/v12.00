. Mods:
. V11.02.02 01/07/2022  Jill Parkinson Task 0921270
.                       Removed changes to RESF2400 and RESF2500. Added RESF6900
. V11.02.01 11/03/2022  Alina Bhari    Task 0913264
.                       Display Laboratory description if laboratory field is set
.                       otherwise current provider field is displayed
.                       - RESF2500,RESF2400
. V11.01.01 19/04/2021  Jill Parkinson Task 0900976
.                       Mods to read backwards so most recent document first in
.                       DOCLNK00
. V10.08.01 30.05.2016  Ania P        CAR 303363
.                       Added extra checks for deleted records in DOCLNK00
. V10.05.01 16.10.2014  Peter Vela    CAR 301518
.                       Added Clinical Documents audit functionality OBSAUDFD
. V10.04.01 04.06.2014  B.G. Ackland  CAR 301992 
.                       Added Linked Document for Error Reporting Link
.           02.04.2014  B.G. Ackland  CAR 299627
.                       Added Document Path in Linked Document Return
.           10/05/2012  B.G. Ackland  CAR 265085
.                       New Tags for Mobility Suite
.------------------------------------------------------------
. Add Field
.------------------------------------------------------------
RESF0000  BRANCH    FLDITMNO,RESF0100,RESF0200,RESF0300,RESF0400,RESF0500:
                             RESF0600,RESF0700,RESF0800,RESF0900,RESF1000:
                             RESF1100,RESF1200,RESF1300,RESF1400,RESF1500:
                             RESF1600,RESF1700,RESF1800,RESF1900,RESF2000:
                             RESF2100,RESF2200,RESF2300,RESF2400,RESF2500:
                             RESF2600,RESF2700,RESF2800,RESF2900,RESF3000:
                             RESF3100,RESF3200,RESF3300,RESF3400,RESF3500:
                             RESF3600,RESF3700,RESF3800,RESF3900,RESF4000:
                             RESF4100,RESF4200,RESF4300,RESF4400,RESF4500:
                             RESF4600,RESF4700,RESF4800,RESF4900,RESF5000:
                             RESF5100,RESF5200,RESF5300,RESF5400,RESF5500:
                             RESF5600,RESF5700,RESF5800,RESF5900,RESF6000:
                             RESF6100,RESF6200,RESF6300,RESF6400,RESF6500:
                             RESF6600,RESF6700,RESF6800,RESF6900
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      RESF9999
.
RESF0100  REP       " +",RESULTKY
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          WRITE     HTMLFILE;LINKPRG,".pbl?":
                             "&reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&resultky=",RESULTKY;
          REP       "+ ",RESULTKY
          GOTO      RESF9999
.
RESF0200  MATCH     SP70,REHARDT
          GOTO      RESF9999 IF EQUAL
          UNPACK    REHARDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESF9999
.
RESF0300  WRITE     HTMLFILE;REHARTM;
          GOTO      RESF9999
.
RESF0400  WRITE     HTMLFILE;REHAPID;
          GOTO      RESF9999
.
RESF0500  WRITE     HTMLFILE;REHAVIS;
          GOTO      RESF9999
.
RESF0600  WRITE     HTMLFILE;REHASID;
          GOTO      RESF9999
.
RESF0700  MATCH     SP70,REHAMDT
          GOTO      RESF9999 IF EQUAL
          UNPACK    REHAMDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESF9999
.
RESF0800  WRITE     HTMLFILE;REHAMTM;
          GOTO      RESF9999
.
RESF0900  WRITE     HTMLFILE;REHAMID;
          GOTO      RESF9999
.
RESF1000  WRITE     HTMLFILE;REHAPAP;
          GOTO      RESF9999
.
RESF1100  WRITE     HTMLFILE;REHAPOR;
          GOTO      RESF9999
.
RESF1200  WRITE     HTMLFILE;REHAFAP;
          GOTO      RESF9999
.
RESF1300  WRITE     HTMLFILE;REHAFOR;
          GOTO      RESF9999
.
RESF1400  WRITE     HTMLFILE;REHAUSC;
          GOTO      RESF9999
.
RESF1500  MOVE      "OBR04",KEY5
          PACK      KEY32,REHALAB,KEY5,REHAUCS,REHAUSC,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REHAUSC,SP70
          ENDIF
          MATCH     SP70,RECTDES
          IF        @EQUAL
            PACK      RECTDES,REHAUSC,SP70
          ENDIF
          WRITE     HTMLFILE;RECTDES;
          GOTO      RESF9999
.
RESF1600  WRITE     HTMLFILE;REHAUCS;
          GOTO      RESF9999
.
RESF1700  MATCH     SP70,REHACDT
          GOTO      RESF9999 IF EQUAL
          UNPACK    REHACDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESF9999
.
RESF1800  WRITE     HTMLFILE;REHACTM;
          GOTO      RESF9999
.
RESF1900  WRITE     HTMLFILE;REHACID;
          GOTO      RESF9999
.
RESF2000  MATCH     "1",REHAFCI
          IF        @EQUAL
            MOVE      RESULTKY,KEY17
            CALL      RDREHD1    * Check Result on File
            IF        OVRCD=0
              WRITE     HTMLFILE;REHDRCI;
            ENDIF
          ENDIF
          GOTO      RESF9999
.
RESF2100  MATCH     SP70,REHASDT
          GOTO      RESF9999 IF EQUAL
          UNPACK    REHASDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESF9999
.
RESF2200  WRITE     HTMLFILE;REHASTM;
          GOTO      RESF9999
.
RESF2300  WRITE     HTMLFILE;REHAOID;
          GOTO      RESF9999
.
RESF2400  WRITE     HTMLFILE;REHAOSN;
          GOTO      RESF9999
.
RESF2500  WRITE     HTMLFILE;REHAOGN;
          GOTO      RESF9999
.
RESF2600  MATCH     SP70,REHARRD
          GOTO      RESF9999 IF EQUAL
          UNPACK    REHARRD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESF9999
.
RESF2700  WRITE     HTMLFILE;REHARRT;
          GOTO      RESF9999
.
RESF2800  MOVE      "0074",HL7TAB
          MOVE      REHADSS,HL7COD
          CALL      HL7ITM00
          GOTO      RESF9999
.
RESF2900  MATCH     SP70,REHARED
          GOTO      RESF9999 IF EQUAL
          UNPACK    REHARED,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      RESF9999
.
RESF3000  WRITE     HTMLFILE;REHARET;
          GOTO      RESF9999
.
RESF3100  MOVE      "0123",HL7TAB
          MOVE      REHARST,HL7COD
          CALL      HL7ITM00
          GOTO      RESF9999
.
RESF3200  WRITE     HTMLFILE;REHAIBY;
          GOTO      RESF9999
.
RESF3300  PACK      KEY20,RESULTKY,SP70
          CALL      RSREHB1
RESF3310  CALL      RKREHB1
          BRANCH    OVRCD,RESF9999
          PACK      KEY17,REHBRDT,REHBRTM,REHBRUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      RESF9999 IF NOT EQUAL
          STRIP     REHBTXT
          MOVELPTR  REHBTXT,LENGTH
          COMPARE   ZERO,LENGTH
          IF        @EQUAL
            WRITE     HTMLFILE;SP1
          ELSE
            SFORMAT   VAR,LENGTH
            MOVE      REHBTXT,VAR
            WRITE     HTMLFILE;VAR
          ENDIF
          SFORMAT   VAR,127
          GOTO      RESF3310
.
RESF3400  PACK      KEY19,RESULTKY,SP70
          CALL      RSREHC1
RESF3410  CALL      RKREHC1
          BRANCH    OVRCD,RESF9999
          PACK      KEY17,REHCRDT,REHCRTM,REHCRUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      RESF9999 IF NOT EQUAL
          WRITE     HTMLFILE;REHCCTO,SP1;
          GOTO      RESF3410
.
RESF3500  WRITE     HTMLFILE;REPIPID;
          GOTO      RESF9999
.
RESF3600  WRITE     HTMLFILE;REPISNM;
          GOTO      RESF9999
.
RESF3700  WRITE     HTMLFILE;REPIGNM;
          GOTO      RESF9999
.
RESF3800  WRITE     HTMLFILE;REPIINT;
          GOTO      RESF9999
.
RESF3900  UNPACK    REPIDOB,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR; 
          GOTO      RESF9999
.
RESF4000  WRITE     HTMLFILE;REPISEX;
          GOTO      RESF9999
.
RESF4100  WRITE     HTMLFILE;REPIAD1;
          GOTO      RESF9999
.
RESF4200  WRITE     HTMLFILE;REPIAD2;
          GOTO      RESF9999
.
RESF4300  WRITE     HTMLFILE;REPIAD3;
          GOTO      RESF9999
.
RESF4400  WRITE     HTMLFILE;REPIAD4;
          GOTO      RESF9999
.
RESF4500  WRITE     HTMLFILE;REPIPC;
          GOTO      RESF9999
.
RESF4600  WRITE     HTMLFILE;REPIPHH;
          GOTO      RESF9999
.
RESF4700  WRITE     HTMLFILE;REPIPHB;
          GOTO      RESF9999
.
RESF4800  CALL      OBXTAB00
          GOTO      RESF9999
.
RESF4900  CALL      AUDTAB00
          GOTO      RESF9999
.
RESF5000  MOVE      REHAADC,DOCTCODE
          CALL      DOCDET00
          GOTO      RESF9999
.
RESF5100  WRITE     HTMLFILE;RESULTKY;
          GOTO      RESF9999
.
RESF5200  WRITE     HTMLFILE;AUDITKEY;
          GOTO      RESF9999
.
RESF5300  CALL      LSTRES00    * Link to Last Result for Patient
          GOTO      RESF9999
.
RESF5400  CALL      NXTRES00    * Link to Next Result for Patient
          GOTO      RESF9999
.
RESF5500  MOVE      ZERO,TEXTFMT
          CALL      OBXTAC00
          GOTO      RESF9999
.
RESF5600  MOVE      "wm",CATEGORY
          PACK      CODE,SP70
          CALL      CODITM00 
          GOTO      RESF9999
.
RESF5700  MOVE      ZERO,TEXTFMT
          CALL      COLSUM00
          GOTO      RESF9999
.
RESF5800  MOVE      ZERO,TABTYPE
          CALL      DOCLNK00  * Document Links
          GOTO      RESF9999
.
RESF5900  CALL      DOCFRM00  * Document Links
          GOTO      RESF9999
.
RESF6000  CALL      NTEDEA00  * Output result notes   
          GOTO      RESF9999
.
RESF6100  PACK      KEY19,RESULTKY,SP70
          CALL      RSREHC1
RESF6110  CALL      RKREHC1
          BRANCH    OVRCD,RESF9999
          PACK      KEY17,REHCRDT,REHCRTM,REHCRUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      RESF9999 IF NOT EQUAL
.
          SCAN      "^",REHCCTO
          MOVEFPTR  REHCCTO,LENGTH
          ADD       ONE,LENGTH
          RESET     REHCCTO,LENGTH
          PACK      KEY50,REHCCTO,SP70
.
          WRITE     HTMLFILE;KEY50,"<br>";
          GOTO      RESF6110
.
RESF6200  MOVE      RESULTKY,KEY17
          CALL      RDREHD1    * Check Result on File
          IF        OVRCD=0
            WRITE     HTMLFILE;REHDRCI;
          ENDIF
          GOTO      RESF9999
.
RESF6300  PACK      KEY20,RESULTKY,SP70
          CALL      RSREHB1
RESF6310  CALL      RKREHB1
          BRANCH    OVRCD,RESF9999
          PACK      KEY17,REHBRDT,REHBRTM,REHBRUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      RESF9999 IF NOT EQUAL
          WRITE     HTMLFILE;REHBTXT,"<br>";
          GOTO      RESF6310
.
RESF6400  MOVE      ONE,TABTYPE
          CALL      DOCLNK00  * Document Links
          GOTO      RESF9999
.
RESF6500  MOVE      ONE,TEXTFMT
          CALL      OBXTAC00
          GOTO      RESF9999
.
RESF6600  MOVE      ONE,TEXTFMT
          CALL      COLSUM00
          GOTO      RESF9999
.
RESF6700  CALL      ERRLNK00
          GOTO      RESF9999
.
RESF6800  WRITE     HTMLFILE;DELTVIEW;
          GOTO      RESF9999
.
RESF6900  MATCH     SP70,REHALAB
          IF        !@EQUAL
            RESET     KEY3
            PACK      KEY3,REHALAB
            CALL      RDRELB1
            BRANCH    OVRCD,RESF9999
.
            WRITE     HTMLFILE;RELBDES;
          ENDIF
          GOTO      RESF9999

RESF9999  RETURN
.------------------------------------------------------------
. Output Frame of First Linked Documents
.------------------------------------------------------------
ERRLNK00  PACK      KEY21,RESULTKY,SP70
          CALL      RSREDA1
ERRLNK10  CALL      RKREDA1
          BRANCH    OVRCD,ERRLNK99
          PACK      KEY17,REDARDT,REDARTM,REDARUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      ERRLNK99 IF NOT EQUAL
          MATCH     "ED",REDAVTY  * Check for Embedded Document
          GOTO      ERRLNK10 IF NOT EQUAL
.
          MOVE      SEVEN,LINENO
          PACK      KEY24,REDARDT,REDARTM,REDARUN,REDASID,LINENO
          CALL      RDREDB1
          BRANCH    OVRCD,ERRLNK10
          PACK      KEY4,REDBTXT
          CALL      RDOBPT1
          STRIP     OBPTURLP
          MOVE      EIGHT,LINENO
          PACK      KEY24,REDARDT,REDARTM,REDARUN,REDASID,LINENO
          CALL      RDREDB1
          BRANCH    OVRCD,ERRLNK10
          PACK      HTMLLINK,OBPTURLP,REDBTXT
          WRITE     HTMLFILE;"<a href='javascript:OpenDocument(#"",HTMLLINK,"#");'>":
                             "<img src=../images/DocumentIcon.gif ":
                             "border=0 hspace=4>Click to View Document</a>"
ERRLNK99  RETURN
.
.------------------------------------------------------------
. Output Frame of First Linked Documents
.------------------------------------------------------------
DOCFRM00  PACK      KEY20,RESULTKY,SP70
          CALL      RSRECL1
          CALL      RKRECL1
          BRANCH    OVRCD,DOCFRM99
          PACK      KEY17,RECLRDT,RECLRTM,RECLRUN,SP70
          MATCH     KEY17,RESULTKY
          GOTO      DOCFRM99 IF NOT EQUAL
.
          PACK      KEY20,RECLURN,RECLVIS,RECLCID,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,DOCFRM99
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          STRIP     OBPTURLP
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      HTMLLINK,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      HTMLLINK,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     HTMLLINK
          REP       " 0",HTMLLINK
          MOVELPTR  HTMLLINK,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      HTMLLINK,VAR
          WRITE     HTMLFILE;VAR;
          SFORMAT   VAR,127
.
DOCFRM99  RETURN
.------------------------------------------------------------
. Output List of Linked Documents
.------------------------------------------------------------
DOCLNK00  IF        TABTYPE=1
            WRITE     HTMLFILE;"[";
          ENDIF
          MOVE      ZERO,FIRSTFLG
          PACK      KEY20,RESULTKY,Z70
          CALL      RSRECL1
DOCLNK10  CALL      RPRECL1
          BRANCH    OVRCD,DOCLNK99
          PACK      KEY17,RECLRDT,RECLRTM,RECLRUN,SP70
          MATCH     KEY17,RESULTKY
          GOTO      DOCLNK99 IF NOT EQUAL
.
          MATCH     "1",RECLDEL
          GOTO      DOCLNK10 IF EQUAL
.
          PACK      KEY20,RECLURN,RECLVIS,RECLCID,SP70
          CALL      RDOBPC1
          BRANCH    OVRCD,DOCLNK10
.
          MATCH     "1",OBPCMDEL
          GOTO      DOCLNK10 IF EQUAL
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          STRIP     OBPTURLP
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      HTMLLINK,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
            PACK      FILELINK,OBPTSDIR,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      HTMLLINK,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
            PACK      FILELINK,OBPTSDIR,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     FILELINK
          REP       " 0",FILELINK
          STRIP     HTMLLINK
          REP       " 0",HTMLLINK
          MOVELPTR  HTMLLINK,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      HTMLLINK,VAR
          MOVE      "wi",CATEGORY
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
.
          MOVE      SP70,WBSENAM
          MOVE      OBPCINUS,KEY10
          CALL      RDWBSE1
.
          UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,OBSPCOKY
          PACK      OBSPCOKY,OBPCURNO,OBPCCVIS,OBPCCPID,SP70
          REP       " +",OBSPCOKY
.
          IF        TABTYPE=0
            WRITE     HTMLFILE;"<tr><td>":
                               "<a href='javascript:OpenDocument(#"",VAR,"#");viewCliDoc(#"",OBSPCOKY,"#");'>":
                               "<img src=../images/DocumentIcon.gif ":
                               "border=0 hspace=4></a>",TDESC,"</td>":
                               "<td>",OBPCCOM1,OBPCCOM2,"</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",WBSENAM,"</td></tr>"
          ENDIF
          IF        TABTYPE=1
            IF        FIRSTFLG=1
              WRITE     HTMLFILE;",";
            ENDIF
            WRITE     HTMLFILE;"{#"url#":#"",VAR,"#",":
                                "#"file#":#"",FILELINK,"#",":
                                "#"comment1#":#"",OBPCCOM1,"#",":
                                "#"comment2#":#"",OBPCCOM2,"#",":
                                "#"date#":#"",OBPCINDT,"#",":
                                "#"from#":#"",OBPCCFRM,"#",":
                                "#"to#":#"",OBPCCTOO,"#",":
                                "#"type#":#"",TDESC,"#",":
                                "#"pid#":#"",OBPCCPID,"#"}";
          ENDIF
.
          MOVE      ONE,FIRSTFLG
          SFORMAT   VAR,127
          GOTO      DOCLNK10
.
DOCLNK99  MOVE      USERID,KEY10
          CALL      RDWBSE1
          IF        TABTYPE=1
            WRITE     HTMLFILE;"]";
          ENDIF
          RETURN
.------------------------------------------------------------
. Determine Link to Next Result for the Patient
.------------------------------------------------------------
NXTRES00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      RESLNKFL,PRELEN,RESULTKY          * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      NXTRES90 IF EQUAL                 * end I CAR 38290
.
          MOVE      "01",LINKTYPE
          MOVE      PURNO,URNUMBER
          PACK      LINKKEYF,URNUMBER,SP70
          PACK      KEY29,LINKTYPE,LINKKEYF,RESULTKY
          CALL      RDRELN1
          BRANCH    OVRCD,NXTRES90
          CALL      RKRELN1
          BRANCH    OVRCD,NXTRES90
          MATCH     "01",RELNLTY
          GOTO      NXTRES90 IF NOT EQUAL
          MATCH     URNUMBER,RELNLKY
          GOTO      NXTRES90 IF NOT EQUAL
.
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          REP       " +",KEY17
          WRITE     HTMLFILE;"location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&resultky=",KEY17,"#"";
          GOTO      NXTRES99
.
NXTRES90  WRITE     HTMLFILE;"alert(#"No More Patient Results#")";
.
NXTRES99  RETURN
.------------------------------------------------------------
. Determine Link to Last Result for the Patient
.------------------------------------------------------------
LSTRES00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      RESLNKFL,PRELEN,RESULTKY          * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      LSTRES90 IF EQUAL                 * end I CAR 38290
.
          MOVE      "01",LINKTYPE
          MOVE      PURNO,URNUMBER
          PACK      LINKKEYF,URNUMBER,SP70
          PACK      KEY29,LINKTYPE,LINKKEYF,RESULTKY
          CALL      RDRELN1
          BRANCH    OVRCD,LSTRES90
          CALL      RPRELN1
          BRANCH    OVRCD,LSTRES90
          MATCH     "01",RELNLTY
          GOTO      LSTRES90 IF NOT EQUAL
          MATCH     URNUMBER,RELNLKY
          GOTO      LSTRES90 IF NOT EQUAL
.
          PACK      KEY17,RELNRDT,RELNRTM,RELNRUN
          REP       " +",KEY17
          WRITE     HTMLFILE;"location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&resultky=",KEY17,"#"";
          GOTO      LSTRES99
.
LSTRES90  WRITE     HTMLFILE;"alert(#"No More Patient Results#")";
.
LSTRES99  RETURN
.------------------------------------------------------------
. HL7 Coded Field Option 
.
.  Parameters    HL7COD & HL7TAB
.
.  Tag Parameter 0=Description
.                1=Code
.                2=Selection List
.------------------------------------------------------------
HL7ITM00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,HL7ITM10
          CALL      GETHL700
          WRITE     HTMLFILE;HLCODES;
          GOTO      HL7ITM99
.
HL7ITM10  WRITE     HTMLFILE;HL7COD;
          GOTO      HL7ITM99
.
HL7ITM99  RETURN
.------------------------------------------------------------
. Get Code Description
.------------------------------------------------------------
GETHL700  MOVE      SP70,HLCODES
          MATCH     SP70,HL7COD
          GOTO      GETHL799 IF EQUAL
          PACK      KEY14,HL7TAB,HL7COD
          CALL      RDHLCO1
          IF        OVRCD=1
            MOVE      SP70,HLCODES
          ENDIF
GETHL799  RETURN
.------------------------------------------------------------
. Output Result Detail Table
.------------------------------------------------------------
OBXTAB00  UNPACK    DIM127,D1,TABLEFMT,DIM127
          PACK      KEY21,RESULTKY,SP70
          CALL      RSREDA1
OBXTAB10  CALL      RKREDA1
          BRANCH    OVRCD,OBXTAB99
          PACK      KEY17,REDARDT,REDARTM,REDARUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      OBXTAB99 IF NOT EQUAL
          MATCH     "ED",REDAVTY  * Check for Embedded Document
          GOTO      OBXTAB10 IF EQUAL
          MATCH     "ST",REDAVTY  * Check for null String Results
          IF        @EQUAL
            MATCH     "null",REDAVST    * Ignore null results
            GOTO      OBXTAB10 IF EQUAL
          ENDIF
          CALL      GETABF00         * Get Abnormal Cell Colour
.
          MOVE      TABLEFMT,F1
          BRANCH    F1,OBXTAB21,OBXTAB22,OBXTAB23
          GOTO      OBXTAB99
.
OBXTAB21  CALL      OBXDEA00
          GOTO      OBXTAB10
.
OBXTAB22  CALL      OBXDEB00
          GOTO      OBXTAB10
.
OBXTAB23  CALL      OBXDEC00
          GOTO      OBXTAB10
.
OBXTAB99  RETURN
.------------------------------------------------------------
. Output Result Detail
.------------------------------------------------------------
OBXDEA00  MOVE      "OBX03",KEY5
          PACK      KEY32,REHALAB,KEY5,REDAOCS,REDAOTY,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MATCH     SP70,RECTDES
          IF        @EQUAL
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",RECTDES,REDAOSD;
.
          CALL      NTEDEA00
.
          MATCH     "TX",REDAVTY
          GOTO      OBXDEA10 IF EQUAL
.
          MATCH     "FT",REDAVTY
          GOTO      OBXDEA50 IF NOT EQUAL
.
OBXDEA10  WRITE     HTMLFILE;"</td><td colspan=2>";
          CALL      TXTDEB00
          WRITE     HTMLFILE;"</td>"
.
          CALL      OBXABF00         * Insert Abnormal Cell to Table
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      OBXDEA99
.
. String or Numeric Result
.------------------------------------------------------------
OBXDEA50  WRITE     HTMLFILE;"</td>";
          MATCH     SP70,ABNORCLR 
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=right class=ResultValue>",REDAVST:
                               "</td><td>",REDAUNI,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=ResultValue align=right bgcolor=":
                               ABNORCLR,">",REDAVST,"</td><td>",REDAUNI,"</td>";                   
          ENDIF
          WRITE     HTMLFILE;"<td align=center class=ResultRef>":
                             REDARFR,"</td>";
.
          CALL      OBXABF00         * Insert Abnormal Cell to Table
.
          WRITE     HTMLFILE;"</tr>"
.
OBXDEA99  RETURN
.----------------------------------------
. Insert Abnormal Cell to Table
.----------------------------------------
OBXABF00  MATCH     SP70,ABNORCLR
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",ABNORDES,"&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<td bgcolor=",ABNORCLR,">",ABNORDES,"</td>"
          ENDIF
          RETURN
.------------------------------------------------------------
. Output NTE details
.------------------------------------------------------------
NTEDEA00  PACK      KEY24,RESULTKY,SP70
          CALL      RSREDC1
NTEDEA10  CALL      RKREDC1
          BRANCH    OVRCD,NTEDEA99
          PACK      KEY21,REDCRDT,REDCRTM,REDCRUN,SP70
          MATCH     KEY21,KEY24
          GOTO      NTEDEA99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<br>",REDCTXT;
          GOTO      NTEDEA10
.
NTEDEA99  RETURN
.------------------------------------------------------------
. Output Result Detail
.------------------------------------------------------------
OBXDEB00  MOVE      "OBX03",KEY5
          PACK      KEY32,REHALAB,KEY5,REDAOCS,REDAOTY,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MATCH     SP70,RECTDES
          IF        @EQUAL
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",RECTDES,REDAOSD;
.
          CALL      NTEDEA00
.
          WRITE     HTMLFILE;"</td><td>";
.
          CALL      TXTDEB00
.
OBXDEB99  RETURN
.------------------------------------------------------------
. Output Text details
.------------------------------------------------------------
TXTDEB00  WRITE     HTMLFILE;"<pre>"
TXTDEB05  MATCH     "1",REDATFL
          IF        !@EQUAL
            WRITE     HTMLFILE;REDAVST;
            GOTO      TXTDEB50
          ENDIF
          PACK      KEY24,REDARDT,REDARTM,REDARUN,REDASID,SP70
          CALL      RSREDB1
TXTDEB10  CALL      RKREDB1
          BRANCH    OVRCD,TXTDEB50
          PACK      KEY21,REDBRDT,REDBRTM,REDBRUN,REDBSID,SP70
          MATCH     KEY21,KEY24
          GOTO      TXTDEB50 IF NOT EQUAL
.
          STRIP     REDBTXT
          MOVELPTR  REDBTXT,LENGTH
          COMPARE   ZERO,LENGTH
          IF        @EQUAL
            WRITE     HTMLFILE;SP1
          ELSE
            SFORMAT   VAR,LENGTH
            MOVE      REDBTXT,VAR
            WRITE     HTMLFILE;VAR
          ENDIF
          SFORMAT   VAR,127
.
          GOTO      TXTDEB10
.
TXTDEB50  PACK      KEY50,RECTDES,SP70
          PACK      KEY20,REDAOSD,SP70
          CALL      RKREDA1
          BRANCH    OVRCD,TXTDEB90
          PACK      KEY17,REDARDT,REDARTM,REDARUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      TXTDEB90 IF NOT EQUAL
          MATCH     ANSD,REDASTA       * Dont display deleted records
          GOTO      TXTDEB90 IF EQUAL
          MATCH     "TX",REDAVTY
          GOTO      TXTDEB80 IF EQUAL
          MATCH     "FT",REDAVTY
          GOTO      TXTDEB80 IF EQUAL
          GOTO      TXTDEB90
.
TXTDEB80  MOVE      "OBX03",KEY5
          PACK      KEY32,REHALAB,KEY5,REDAOCS,REDAOTY,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MATCH     KEY50,RECTDES
          GOTO      TXTDEB90 IF NOT EQUAL
          MATCH     KEY20,REDAOSD
          GOTO      TXTDEB05 IF EQUAL
.
TXTDEB90  CALL      RPREDA1
          WRITE     HTMLFILE;"</pre>"
          RETURN
.------------------------------------------------------------
. Output Result Detail
.------------------------------------------------------------
OBXDEC00  MOVE      "OBX03",KEY5
          PACK      KEY32,REHALAB,KEY5,REDAOCS,REDAOTY,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MATCH     SP70,RECTDES
          IF        @EQUAL
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr align=center><td class=HeadingCell><b>":
                             RECTDES,REDAOSD,"</td></tr>":
                             "<tr><td>";
          CALL      TXTDEB00
          WRITE     HTMLFILE;"</td></tr>":
                             "<tr><td>";
          CALL      NTEDEA00
          WRITE     HTMLFILE;"</td></tr>";
.
OBXDEC99  RETURN
.------------------------------------------------------------
. Output Result Audit Table
.------------------------------------------------------------
AUDTAB00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell>Web User</td>":
                             "<td class=HeadingCell>Date & Time</td>":
                             "<td class=HeadingCell>Status</td>":
                             "<td class=HeadingCell>Marked as Read</td>":
                             "<td class=HeadingCell>Action</td></tr>"
.
          PACK      RESLNKFL,PREAEA,RESULTKY          * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESAUDA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      AUDTAB99 IF EQUAL                 * end I CAR 38290
.
          MOVE      WBSEUID,SAVEWUID
          PACK      KEY40,RESULTKY,Z70
          CALL      RSREAU1
AUDTAB10  CALL      RPREAU1
          BRANCH    OVRCD,AUDTAB99
          PACK      KEY17,REAURDT,REAURTM,REAURUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      AUDTAB99 IF NOT EQUAL
.
          UNPACK    REAUSDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      REAUUID,KEY10
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      REAUUID,WBSENAM
          ENDIF
          MOVE      "No ",YESNO
          MATCH     "1",REAUMRK
          IF        @EQUAL
            MOVE      "Yes",YESNO
          ENDIF
          MOVE      "0123",HLCOTID
          MOVE      REAURST,HLCODES
          PACK      KEY14,HLCOTID,REAURST,SP70
          CALL      RDHLCO1
          MOVE      SP70,TDESC
          MATCH     SP70,REAUACD
          IF        !@EQUAL
            MOVE      "wm",KEY2
            PACK      KEY5,KEY2,REAUACD,SP70
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"<tr><td>",WBSENAM,"</td>":
                                 "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 " at ",REAUSTM,"</td>":
                                 "<td>",HLCODES,"</td>":
                                 "<td>",YESNO,"</td>":
                                 "<td>",TDESC,SP1,REAUACM,"&nbsp;</td></tr>"
          GOTO      AUDTAB10
.
AUDTAB99  MOVE      SAVEWUID,KEY10
          CALL      RDWBSE1
          RETURN
.------------------------------------------------------------
. Cumulative Details
.------------------------------------------------------------
OBXCUM00  MOVE      ZERO,EXIT 
          CALL      SETCOL00
          BRANCH    EXIT,OBXCUM99
.
          PACK      KEY21,RESULTKY,SP70
          CALL      RSREDA1
OBXCUM10  CALL      RKREDA1
          BRANCH    OVRCD,OBXCUM99
          PACK      KEY17,REDARDT,REDARTM,REDARUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      OBXCUM99 IF NOT EQUAL
          MATCH     "ED",REDAVTY  * Check for Embedded Document
          GOTO      OBXCUM10 IF EQUAL
          MATCH     "ST",REDAVTY  * Check for null String Results
          IF        @EQUAL
            MATCH     "null",REDAVST    * Ignore null results
            GOTO      OBXCUM10 IF EQUAL
          ENDIF
.
          CALL      SETROW00
.
          GOTO      OBXCUM10
.
OBXCUM99  RETURN
.------------------------------------------------------------
. Set Column for Cumulative Results
.------------------------------------------------------------
SETCOL00  MOVE    ZERO,EXIT
          MOVE    ONE,CUMLROW
          MOVE    ONE,CUMLCOL
SETCOL10  ADD     ONE,CUMLCOL
          MATCH   SP70,CUMLREST[CUMLROW][CUMLCOL]
          GOTO    SETCOL90 IF EQUAL
          MATCH   RESULTKY,CUMLREST[CUMLROW][CUMLCOL]
          GOTO    SETCOL80 IF EQUAL 
          IF      CUMLCOL>6
            MOVE    ONE,EXIT
            GOTO    SETCOL99
          ENDIF
          GOTO    SETCOL10
         
SETCOL80  MOVE    CUMLCOL,SETCOL
          GOTO    SETCOL99
.
SETCOL90  MOVE    RESULTKY,CUMLREST[CUMLROW][CUMLCOL]
          MOVE    CUMLCOL,SETCOL
.
SETCOL99  RETURN
.------------------------------------------------------------
. Update Value for Cumulative Results
.------------------------------------------------------------
SETROW00  MOVE    ONE,CUMLROW
          MOVE    ONE,CUMLCOL
          PACK    KEY24,REDAOTY,REDAOCS
SELROW10  ADD     ONE,CUMLROW
          MATCH   SP70,CUMLREST[CUMLROW][CUMLCOL]
          GOTO    SELROW90 IF EQUAL 
          MATCH   KEY24,CUMLREST[CUMLROW][CUMLCOL]
          GOTO    SELROW80 IF EQUAL 
          IF      CUMLROW>99
            GOTO    SELROW99 
          ENDIF
          GOTO    SELROW10 
.
SELROW80  PACK    KEY21,REDARDT,REDARTM,REDARUN,REDASID,SP70
          MOVE    KEY21,CUMLREST[CUMLROW][SETCOL]
          GOTO    SELROW99
.
SELROW90  MOVE    KEY24,CUMLREST[CUMLROW][CUMLCOL]
          PACK    KEY21,REDARDT,REDARTM,REDARUN,REDASID,SP70
          MOVE    KEY21,CUMLREST[CUMLROW][SETCOL]
          MOVE    REDARFR,CUMLREST[CUMLROW][7]
          MOVE    REDAUNI,CUMLREST[CUMLROW][8]
.
SELROW99  RETURN
.
.------------------------------------------------------------
. Output Result Detail Table
.------------------------------------------------------------
OBXTAC00  MOVE      ZERO,FIRSTFLG
          UNPACK    DIM127,D1,TABLEFMT,DIM127
          PACK      KEY21,RESULTKY,SP70
          CALL      RSREDA1
OBXTAC10  CALL      RKREDA1
          BRANCH    OVRCD,OBXTAC90
          PACK      KEY17,REDARDT,REDARTM,REDARUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      OBXTAC90 IF NOT EQUAL
.
          MATCH     ANSD,REDASTA       * Dont display deleted records
          GOTO      OBXTAC10 IF EQUAL
.
          MATCH     "ED",REDAVTY  * Check for Embedded Document
          GOTO      OBXTAC10 IF EQUAL
          MATCH     "ST",REDAVTY  * Check for null String Results
          IF        @EQUAL
            MATCH     "null",REDAVST    * Ignore null results
            GOTO      OBXTAC10 IF EQUAL
          ENDIF
          CALL      GETABF00         * Get Abnormal Cell Colour
.
          MOVE      "OBX03",KEY5
          PACK      KEY32,REHALAB,KEY5,REDAOCS,REDAOTY,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MATCH     SP70,RECTDES
          IF        @EQUAL
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MOVE      SP70,STATNAME
          MOVE      REDASTA,HLCODES
          MOVE      "0085",HLCOTID
          PACK      KEY14,HLCOTID,REDASTA,SP70
          CALL      RDHLCO1
          MOVE      HLCODES,STATNAME
.
          MATCH     "TX",REDAVTY
          GOTO      OBXTAC20 IF EQUAL
.
          MATCH     "FT",REDAVTY
          GOTO      OBXTAC20 IF EQUAL
.
. String or Numeric Result
.------------------------------------------------------------
          IF        FIRSTFLG=0
            MOVE      ONE,FIRSTFLG
            WRITE     HTMLFILE;"<tr><td class=HeadingCell>":
                                    "Observation</td>":
                                    "<td class=HeadingCell align=right>":
                                    "Result</td>":
                                    "<td class=HeadingCell>":
                                    "Units</td>":
                                    "<td class=HeadingCell align=center>":
                                    "Ref. Range</td>":
                                    "<td class=HeadingCell>":
                                    "Status</td>":
                                    "<td class=HeadingCell>":
                                    "Abnormal Flag</td>":
                               "</tr>"
          ENDIF
          WRITE     HTMLFILE;"<tr><td>",RECTDES,REDAOSD,"</td>";
          MATCH     SP70,ABNORCLR
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=right class=ResultValue>",REDAVST:
                               "</td><td>",REDAUNI,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=ResultValue align=right bgcolor=":
                               ABNORCLR,">",REDAVST,"</td><td>",REDAUNI,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=center class=ResultRef>":
                             REDARFR,"</td>":
                             "<td>",STATNAME,"</td>";
          CALL      OBXABF00         * Insert Abnormal Cell to Table
          WRITE     HTMLFILE;"</tr>"
          GOTO      OBXTAC10
.
OBXTAC20  IF        TEXTFMT=0
            WRITE     HTMLFILE;"<tr><td class=HeadingCell align=center":
                               " colspan=6>",RECTDES,REDAOSD,"</td></tr>":
                               "<tr><td colspan=6>";
          ELSE
            WRITE     HTMLFILE;"<tr><td class=ResultID>",RECTDES,REDAOSD,"</td>":
                               "    <td class=ResultTX colspan=5>";
          ENDIF
          CALL      TXTDEB00
.
          WRITE     HTMLFILE;"</td></tr><tr>"
          CALL      ABOBX000         * Insert Abnormal Cell to Table
          WRITE     HTMLFILE;"</tr>"
          GOTO      OBXTAC10
.
.  Write NTE segments
.
OBXTAC90  PACK      KEY24,RESULTKY,SP70
          CALL      RSREDC1
          CALL      RKREDC1
          BRANCH    OVRCD,OBXTAC99    * Note does not exist
          PACK      KEY17,REDCRDT,REDCRTM,REDCRUN,SP70
          MATCH     RESULTKY,KEY17
          GOTO      OBXTAC99 IF NOT EQUAL
.
          IF        TEXTFMT=0
            WRITE     HTMLFILE;"<tr><td class=HeadingCell align=center ":
                               "colspan=6>Notes":
                               "</td></tr><tr><td colspan=6>";
          ELSE
            WRITE     HTMLFILE;"<tr><td class=ResultID>Notes</td>":
                               "<td colspan=5>";
          ENDIF
          CALL      NTEDEA00           * Notes Details Table
          WRITE     HTMLFILE;"</td></tr>"
.
OBXTAC99  RETURN
.----------------------------------------
. Insert Abnormal Cell to Table
.----------------------------------------
ABOBX000  MATCH     SP70,REDAABF
          GOTO      ABOBX999 IF EQUAL
          MATCH     SP70,ABNORCLR
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td colspan=6>Abnormal Flag : ": 
                               ABNORDES,"&nbsp;</td></tr>"
          ELSE
            WRITE     HTMLFILE;"<tr><td colspan=6 bgcolor=",ABNORCLR:
                               ">Abnormal Flag : ",ABNORDES,"</td></tr>"
          ENDIF
ABOBX999  RETURN
.
GETABF00  MOVE      "0078",KEY4
          MOVE      SP70,ABNORCLR
          MOVE      REDAABF,ABNORDES
          MATCH     SP70,REDAABF
          GOTO      GETABF99 IF EQUAL
          PACK      KEY14,KEY4,REDAABF,SP70
          CALL      RDHLCO1
          IF        OVRCD=0
            MOVE      HLCOBGC,ABNORCLR
            MOVE      HLCODES,ABNORDES
          ENDIF
.
GETABF99  RETURN
.------------------------------------------------------------
. Output Result Detail Table
.------------------------------------------------------------
COLSUM00  MOVE      ZERO,FIRSTFLG
          UNPACK    DIM127,D1,TABLEFMT,DIM127
          UNPACK    RESULTKY,REDARDT,REDARTM
          PACK      KEY21,REDARDT,REDARTM,SP70
          MOVE      SP70,LASTRUN
          MOVE      REHADSS,COLLDSS
          MOVE      REHAPID,COLLPID
          CALL      RSREDA1
COLSUM10  CALL      RKREDA1
          BRANCH    OVRCD,COLSUM99
          PACK      KEY13,REDARDT,REDARTM,SP70
          MATCH     RESULTKY,KEY13
          GOTO      COLSUM99 IF NOT EQUAL
          MATCH     "ED",REDAVTY  * Check for Embedded Document
          GOTO      COLSUM10 IF EQUAL
          MATCH     "ST",REDAVTY  * Check for null String Results
          IF        @EQUAL
            MATCH     "null",REDAVST    * Ignore null results
            GOTO      COLSUM10 IF EQUAL
          ENDIF
.
          MOVE      ZERO,EXIT
          MATCH     LASTRUN,REDARUN
          CALL      COLHED00 IF NOT EQUAL
          BRANCH    EXIT,COLSUM10
.
          CALL      GETABF00         * Get Abnormal Cell Colour
.
          MOVE      "OBX03",KEY5
          PACK      KEY32,REHALAB,KEY5,REDAOCS,REDAOTY,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MATCH     SP70,RECTDES
          IF        @EQUAL
            PACK      RECTDES,REDAOTY,SP70
          ENDIF
          MOVE      SP70,STATNAME
          MOVE      REDASTA,HLCODES
          MOVE      "0085",HLCOTID
          PACK      KEY14,HLCOTID,REDASTA,SP70
          CALL      RDHLCO1
          MOVE      HLCODES,STATNAME
.
          MATCH     "TX",REDAVTY
          GOTO      COLSUM20 IF EQUAL
.
          MATCH     "FT",REDAVTY
          GOTO      COLSUM20 IF EQUAL
.
. String or Numeric Result
.------------------------------------------------------------
          IF        FIRSTFLG=0
            MOVE      ONE,FIRSTFLG
            WRITE     HTMLFILE;"<tr><td class=HeadingCell>":
                                    "Observation</td>":
                                    "<td class=HeadingCell align=right>":
                                    "Result</td>":
                                    "<td class=HeadingCell>":
                                    "Units</td>":
                                    "<td class=HeadingCell align=center>":
                                    "Ref. Range</td>":
                                    "<td class=HeadingCell>":
                                    "Status</td>":
                                    "<td class=HeadingCell>":
                                    "Abnormal Flag</td>":
                               "</tr>"
          ENDIF
          WRITE     HTMLFILE;"<tr><td>",RECTDES,REDAOSD,"</td>";
          MATCH     SP70,ABNORCLR
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=right class=ResultValue>",REDAVST:
                               "</td><td>",REDAUNI,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=ResultValue align=right bgcolor=":
                               ABNORCLR,">",REDAVST,"</td><td>",REDAUNI,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=center class=ResultRef>":
                             REDARFR,"</td>":
                             "<td>",STATNAME,"</td>";
          CALL      OBXABF00         * Insert Abnormal Cell to Table
          WRITE     HTMLFILE;"</tr>"
          GOTO      COLSUM10
.
COLSUM20  IF        TEXTFMT=0
            WRITE     HTMLFILE;"<tr><td class=HeadingCell align=center":
                               " colspan=6>",RECTDES,REDAOSD,"</td></tr>":
                               "<tr><td colspan=6>";
          ELSE
            WRITE     HTMLFILE;"<tr><td class=ResultID>",RECTDES,REDAOSD,"</td>":
                               "    <td class=ResultTX colspan=5>";
          ENDIF
          CALL      TXTDEB00
.
          WRITE     HTMLFILE;"</td></tr><tr>"
.
          CALL      ABOBX000         * Insert Abnormal Cell to Table
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      COLSUM10
.
COLSUM99  PACK      KEY17,RESULTKY
          MOVE      RESULTKY,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          CALL      RESOPN00 IF NOT EQUAL
          IF        OVRCD<>1
            CALL      RDREHA1
          ENDIF
          RETURN
.
. Output Header for Change in Result Run No
.
COLHED00  MOVE      ZERO,EXIT
          MOVE      REDARUN,LASTRUN
          PACK      KEY17,REDARDT,REDARTM,REDARUN
          MOVE      REDARDT,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          CALL      RESOPN00 IF NOT EQUAL
          BRANCH    OVRCD,COLHED90
          CALL      RDREHA1
          BRANCH    OVRCD,COLHED90
          MATCH     COLLPID,REHAPID
          GOTO      COLHED90 IF NOT EQUAL
          MATCH     COLLDSS,REHADSS
          GOTO      COLHED90 IF NOT EQUAL
.
          MATCH     RESULTKY,KEY17
          CALL      SUMAUD00 IF NOT EQUAL
.
          MOVE      "OBR04",KEY5
          PACK      KEY32,REHALAB,KEY5,REHAUCS,REHAUSC,SP70
          CALL      RDRECT1
          IF        OVRCD=1
            PACK      RECTDES,REHAUSC,SP70
          ENDIF
          MATCH     SP70,RECTDES
          IF        @EQUAL
            PACK      RECTDES,REHAUSC,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell":
                                  " align=center colspan=6>",RECTDES:
                                  " - ",REHAFOR,"</td></tr>"
          CALL      HEDNOT00
.
          MOVE      ZERO,MARKFLAG
.
          MOVE      ZERO,EXIT
          GOTO      COLHED99
.
COLHED90  PACK      KEY21,REHARDT,REHARTM,REHARUN,Z70
          CALL      RSREDA1
          MOVE      ONE,EXIT
.
COLHED99  RETURN
.
.
HEDNOT00  MOVE      ZERO,FSTNOTE
          PACK      KEY20,REHARDT,REHARTM,REHARUN,SP70
          CALL      RSREHB1
HEDNOT10  CALL      RKREHB1
          BRANCH    OVRCD,HEDNOT90
          PACK      KEY20,REHARDT,REHARTM,REHARUN,SP70
          PACK      KEY17,REHBRDT,REHBRTM,REHBRUN,SP70
          MATCH     KEY20,KEY17
          GOTO      HEDNOT90 IF NOT EQUAL
          IF        FSTNOTE=0
            MOVE      ONE,FSTNOTE
            WRITE     HTMLFILE;"<tr><td colspan=6><pre>"
          ENDIF
          STRIP     REHBTXT
          MOVELPTR  REHBTXT,LENGTH
          COMPARE   ZERO,LENGTH
          IF        @EQUAL
            WRITE     HTMLFILE;SP1
          ELSE
            SFORMAT   VAR,LENGTH
            MOVE      REHBTXT,VAR
            WRITE     HTMLFILE;VAR
          ENDIF
          SFORMAT   VAR,127
          GOTO      HEDNOT10
.
HEDNOT90  COMPARE   ZERO,FSTNOTE
          GOTO      HEDNOT99 IF EQUAL
          WRITE     HTMLFILE;"</pre></td></tr>"
.
HEDNOT99  RETURN
.------------------------------------------------------------
. Write Audit Record for who has seen the records
.------------------------------------------------------------
SUMAUD00  MOVE      WBSEUID,REAUUID
          PACK      KEY40,REHARDT,REHARTM,REHARUN,REAUSDT,REAUSTM,REAUUID,SP70
          UNPACK    KEY40,REAURDT,REAURTM,REAURUN,REAUSDT,REAUSTM,REAUUID
          MOVE      KEY40,AUDITKEY
          MOVE      REHARST,REAURST
          MOVE      ZERO,REAUMRK
          MOVE      SP70,REAUACD
          MOVE      SP70,REAUACM
          MOVE      SP70,REAUSPA
.
          PACK      RESLNKFL,PREAEA,REAURDT           * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESAUDA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      SUMAUD99 IF EQUAL                 * end I CAR 38290
.
          CALL      RAREAU1
          IF        OVRCD=1
            CALL      WRREAU1
          ENDIF
SUMAUD99  RETURN
.------------------------------------------------------------
. Mark a Range of Collection
.------------------------------------------------------------
SUMMRK00  UNPACK    AUDITKEY,RESULTKY,AUDDATE,AUDTIME,AUDUSER
          MOVE      RESULTKY,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          CALL      RESOPN00 IF NOT EQUAL
          BRANCH    OVRCD,SUMMRK90
.
          PACK      KEY17,RESULTKY,SP70
          CALL      RDREHA1
          PACK      MARKKEY,REHARDT,REHARTM,SP70
          MOVE      REHADSS,COLLDSS
          MOVE      REHAPID,COLLPID
          PACK      KEY17,REHARDT,REHARTM,SP70
          CALL      RSREHA1
SUMMRK10  CALL      RKREHA1
          BRANCH    OVRCD,SUMMRK90
          PACK      KEY13,REHARDT,REHARTM,SP70
          MATCH     MARKKEY,KEY13
          GOTO      SUMMRK90 IF NOT EQUAL
          MATCH     COLLPID,REHAPID
          GOTO      SUMMRK10 IF NOT EQUAL
          MATCH     COLLDSS,REHADSS
          GOTO      SUMMRK10 IF NOT EQUAL
.
          PACK      AUDITKEY,REHARDT,REHARTM,REHARUN,AUDDATE,AUDTIME,AUDUSER,SP7
          MOVE      ONE,MARKEXIT
          CALL      RESMRK00
          BRANCH    EXIT,SUMMRK99
          GOTO      SUMMRK10
.
SUMMRK90  MOVE      ONE,REPORTNO
          MOVE      ONE,MARKFLAG
          CALL      WINCLS00
.
SUMMRK99  RETURN
.------------------------------------------------------------
. Action a Range 
.------------------------------------------------------------
SUMACT00  UNPACK    AUDITKEY,RESULTKY,AUDDATE,AUDTIME,AUDUSER
          MOVE      RESULTKY,RESULTYR
          MOVE      ZERO,OVRCD
          MATCH     RESULTYR,YEAROPEN
          CALL      RESOPN00 IF NOT EQUAL
          BRANCH    OVRCD,SUMACT90
.
          PACK      KEY17,RESULTKY,SP70
          CALL      RDREHA1
          MOVE      REHADSS,COLLDSS
          MOVE      REHAPID,COLLPID
          PACK      MARKKEY,REHARDT,REHARTM,SP70
          PACK      KEY17,REHARDT,REHARTM,SP70
          CALL      RSREHA1
SUMACT10  CALL      RKREHA1
          BRANCH    OVRCD,SUMACT90
          PACK      KEY13,REHARDT,REHARTM,SP70
          MATCH     MARKKEY,KEY13
          GOTO      SUMACT90 IF NOT EQUAL
          MATCH     COLLPID,REHAPID
          GOTO      SUMACT10 IF NOT EQUAL
          MATCH     COLLDSS,REHADSS
          GOTO      SUMACT10 IF NOT EQUAL
.
          PACK      AUDITKEY,REHARDT,REHARTM,REHARUN,AUDDATE,AUDTIME,AUDUSER,SP7
          MOVE      ONE,MARKEXIT
          CALL      RESACT00
          BRANCH    EXIT,SUMACT99
          GOTO      SUMACT10
.
SUMACT90  MOVE      ONE,REPORTNO
          MOVE      ONE,MARKFLAG
          CALL      WINCLS00
.
SUMACT99  RETURN
