<meta name="TemplateVersion" content="V12.00.00">
<meta name="TemplateHome"    content="standard">
<meta name="HelpFileName"    content="NoContextSet.html">
<meta name="CrossBrowser"    content="true">
<script type="text/javascript" src="../js/TableSort.js"> </script>
<script type="text/javascript">
function InitTable(TableView) {
document.title="NIHC IHI / MyHR Polling List";
  switch (TableView) {
    case 0: {
      t = new Table(1,0,2,"100%","center",25,35);
      t.addColumn("Unique ID","String",7,7,"left","","",65)
      t.addColumn("Count","String",0,0,"left","","",15)
      t.addColumn("Request Date/Time","DateTime",1,1,"left","","",55)
      t.addColumn("Hospital","String",2,2,"left","","",50)
      t.addColumn("Request Type","String",3,3,"left","","",40)
      t.addColumn("Request Code","String",4,4,"left","","",70)
      t.addColumn("Request Status","String",5,5,"left","","",40)
      t.addColumn("Request User Id","String",6,6,"left","","",40)
      t.addColumn("Update Date/Time","DateTime",11,11,"left","","",40)
      t.addColumn("Update User Id","String",12,12,"left","","",40)
      t.addColumn("Error Description","String",8,8,"left","","",90)
      AddTableRows()
      TableOutput(2,2);    // Order Column,Asc Dsc
      break;
    }
  }
}
function JSONPopupFrame(urnumber,ireqdate,ireqtime,ireqcntr) {
  DFrameStart()

  linkurl="../cgi-bin/comweb06.pbl?reportno=07&template=001"+
          "&urnumber=" + urnumber +
          "&ireqdate=" + ireqdate +
          "&ireqtime=" + ireqtime +
          "&ireqcntr=" + ireqcntr ;
  Left=(document.body.clientWidth-1400)/2
  DFrameLink(linkurl,0,Left,1400,1000)
}
function MedicareRequestPopupFrame(ireqtype,ireqcode,ireqdate,ireqtime) {
  DFrameStart()

  linkurl="../cgi-bin/comweb06.pbl?reportno=08&template=001"+
          "&ireqtype=" + ireqtype +
          "&ireqcode=" + ireqcode +
          "&ireqdate=" + ireqdate +
          "&ireqtime=" + ireqtime +
          "&urnumber=" + document.AddForm.urnumber.value;
  Left=(document.body.clientWidth-800)/2
  DFrameLink(linkurl,0,Left,800,610)
}
function MedicareResultPopupFrame(ireqtype,ireqcode,ireqdate,ireqtime) {
  DFrameStart()

  linkurl="../cgi-bin/comweb06.pbl?reportno=09&template=001"+
          "&ireqtype=" + ireqtype +
          "&ireqcode=" + ireqcode +
          "&ireqdate=" + ireqdate +
          "&ireqtime=" + ireqtime +
          "&urnumber=" + document.AddForm.urnumber.value;
  Left=(document.body.clientWidth-800)/2
  DFrameLink(linkurl,0,Left,800,860)
}
function invokeNIHCSummary() {

//   //Check if there is a successful IHI Lookup within X hours (PTCNIHIV)
//  var serverURL  = "../cgi-bin/ihiweb04.pbl?reportno=1" +
//              "&valdurno=" + document.getElementById('nihcurno').value.replace(/ /g,"+") +
//              "&valdtype=3";
//  //alert(serverURL);
//  var returnValue = RSExecute(serverURL);
//  if (returnValue.status!=0) {return;}

  //Get Generated JWT Auth Token
  var serverURL  = "../cgi-bin/ihiweb04.pbl?reportno=1" +
              "&valdhosp=" + trim(document.getElementById('nihchosp').value) +
              "&valduser=" + trim(document.getElementById('nihcuser').value) +
              "&valdrole=" + trim(document.getElementById('nihcrole').value) +
              "&valdtaud=NIHC-UI" +
              "&valdurno=" + trim(document.getElementById('nihcurno').value) +
              "&valdtype=1";

  //alert(serverURL);
  var returnValue = RSExecute(serverURL);
  if (returnValue.status==0) {
    getNIHCSummary(returnValue.return_value.substring(11));
  }
}
function getNIHCSummary(token) {

  var urlNIHCSummary = trim(document.getElementById('nihcpurl').value) +
                      "/Hospitals/" +
                      trim(document.getElementById('nihchosp').value) +
                      "/Patients/" +
                      trim(document.getElementById('nihcurno').value) +
                      "/PatientLanding" +
                      "?token=" + token;

    window.open(urlNIHCSummary, "_blank", "noreferrer");
}
function invokeMyHRViewer() {

   //Check if there is a successful IHI Lookup within X hours (PTCNIHIV)
  var serverURL  = "../cgi-bin/ihiweb04.pbl?reportno=1" +
              "&valdurno=" + document.getElementById('nihcurno').value.replace(/ /g,"+") +
              "&valdtype=3";
  //alert(serverURL);
  var returnValue = RSExecute(serverURL);
  if (returnValue.status!=0) {return;}

  //Get Generated JWT Auth Token
  var serverURL  = "../cgi-bin/ihiweb04.pbl?reportno=1" +
              "&valdhosp=" + trim(document.getElementById('nihchosp').value) +
              "&valduser=" + trim(document.getElementById('nihcuser').value) +
              "&valdrole=" + trim(document.getElementById('nihcrole').value) +
              "&valdtaud=MYHR" +
              "&valdurno=" + trim(document.getElementById('nihcurno').value) +
              "&valdtype=1";

  //alert(serverURL);
  var returnValue = RSExecute(serverURL);
  if (returnValue.status==0) {
    getMyHRViewer(returnValue.return_value.substring(11));
  }
}
function getMyHRViewer(token) {
    //alert(token);

    //fetch("https://jsonplaceholder.typicode.com/posts")
    //.then((response) => response.json())
    //.then((json) => {
    //    alert(JSON.stringify(json))
    //  }
    //);

//    var url = 'http://www.google.com';
//
//    var myHeaders = new Headers();
//    myHeaders.set('Authentication', 'Bearer ' + token);
//
//    var requestObj = {
//      method: 'GET',
//      headers: myHeaders,
//      mode: 'no-cors',
//      cache: 'default'
//    };
//
//    var myRequest = new Request(url, requestObj);
//
//    fetch(myRequest)
//      .then((response) => response.blob())
//      .then((blob) => { 
//        var _url = window.URL.createObjectURL(blob);
//        window.open(_url); // window.open + focus
//      }).catch((err) => {
//        console.log(err);
//      });

//    window.open("http://wauedpbunihc01.ad.dedalusapac.com/PcehrView/" +
//                "Hospitals/BoxHillHospital/Patients/BOWENKAMAHL000001/"+
//                "PatientSummary");



  var urlMyHRViewer = trim(document.getElementById('nihcmurl').value) +
                      "/Hospitals/" + 
                      trim(document.getElementById('nihchosp').value) + 
                      "/Patients/" +
                      trim(document.getElementById('nihcurno').value) +
                      "/PatientSummary" +
                      "?token=" + token; 

  //alert(urlMyHRViewer);

    window.open(urlMyHRViewer, "_blank", "noreferrer");

//  var req = new XMLHttpRequest();
//  req.open('GET', urlMyHRViewer, true); 
//  req.onreadystatechange = function (aEvt) {
//    if (req.readyState == 4) {
//      if(req.status == 200) {
//        alert(req.responseText);
//      } else {
//        alert("Error loading page\n");
//      }
//    }
//  };
//  req.setRequestHeader('Authorization', 'Bearer ' + token);
//  req.setRequestHeader('Access-Control-Allow-Origin', '*');
//  req.send();




}

function GetNIHCIHIMyHRUploadCOOKIE() {
  if (GetCookieData("NIHCIHIMyHRUploadCOOKIE") != "unknown") {
    //alert(GetCookieData("NIHCIHIMyHRUploadCOOKIE"));
    ExpireCookiePath("NIHCIHIMyHRUploadCOOKIE");
    setTimeout(LaunchNIHCIHIMyHRUpload, 5000);
  }

}

function LaunchNIHCIHIMyHRUpload() {

  if (isWhitespace(document.getElementById('nihcvisn').value)) {
    alert("A visit must be in context.");
    return;
  }

   //Check if there is a successful IHI Lookup within X hours (PTCNIHIV)
  var serverURL  = "../cgi-bin/ihiweb04.pbl?reportno=1" +
              "&valdurno=" + document.getElementById('nihcurno').value.replace(/ /g,"+") + 
              "&valdtype=3";
  //alert(serverURL);
  var returnValue = RSExecute(serverURL);
  if (returnValue.status!=0) {return;}


   //Get Generated JWT Auth Token
  var serverURL  = "../cgi-bin/ihiweb04.pbl?reportno=1" +
              "&valdhosp=" + trim(document.getElementById('nihchosp').value) +
              "&valduser=" + trim(document.getElementById('nihcuser').value) +
              "&valdrole=" + trim(document.getElementById('nihcrole').value) +
              "&valdtaud=NIHC-UI" +
              "&valdurno=" + trim(document.getElementById('nihcurno').value) +
              "&valdvisn=" + trim(document.getElementById('nihcvisn').value) +
              "&valdtype=2";

  //alert(serverURL);
  var returnValue = RSExecute(serverURL);
  if (returnValue.status==0) {
    getNIHCIHIMyHRUpload(returnValue.return_value.substring(11));
  }
}

function getNIHCIHIMyHRUpload(token) {

  var urlNIHCIHIMyHRUpload = trim(document.getElementById('nihchurl').value) +
                      "/Hospitals/" +
                      trim(document.getElementById('nihchosp').value) +
                      "/Patients/" +
                      trim(document.getElementById('nihcurno').value) +
                      "/Episode/" +
                      trim(document.getElementById('nihcvisn').value) +
                      "/DischargeSummaryUI" +
                      "?token=" + token;

    //console.log(urlNIHCIHIMyHRUpload);
    window.open(urlNIHCIHIMyHRUpload, "_blank", "noreferrer");
}
function MyHRRequestPopupFrame(ireqtype,ireqcode,ireqdate,ireqtime) {
  DFrameStart()

  linkurl="../cgi-bin/comweb06.pbl?reportno=10&template=001"+
          "&ireqtype=" + ireqtype +
          "&ireqcode=" + ireqcode +
          "&ireqdate=" + ireqdate +
          "&ireqtime=" + ireqtime +
          "&urnumber=" + document.AddForm.urnumber.value;
  Left=(document.body.clientWidth-800)/2
  DFrameLink(linkurl,0,Left,800,610)
}
function MyHRResultPopupFrame(ireqtype,ireqcode,ireqdate,ireqtime) {
  DFrameStart()

  linkurl="../cgi-bin/comweb06.pbl?reportno=11&template=001"+
          "&ireqtype=" + ireqtype +
          "&ireqcode=" + ireqcode +
          "&ireqdate=" + ireqdate +
          "&ireqtime=" + ireqtime +
          "&urnumber=" + document.AddForm.urnumber.value;
  Left=(document.body.clientWidth-800)/2
  DFrameLink(linkurl,0,Left,800,860)
}
</script>
</head>
%START.OF.PAGE
<body onload="PageLoad(event);InitTable(0);GetNIHCIHIMyHRUploadCOOKIE();">
<div id=PatientHeading></div>
<script type="text/javascript">
PatientURN="%COMWEB06.06.003";
PatientVIS="%COMWEB06.06.081";
PatientNAM="%COMWEB06.06.002";
PatientSTA="%COMWEB06.06.086.078";
PatientALT="%COMWEB06.06.084";
PatientSEX="%COMWEB06.06.019";
PatientDOB="%COMWEB06.06.020";
PatientAGE="%COMWEB06.06.021";
PatientLOC="%COMWEB06.06.083";
PatientPRI="%COMWEB06.06.086.066.1";
PatientUNT="%COMWEB06.06.066.0";
DoctorCOD="%COMWEB06.06.082.003";
DoctorNAM="%COMWEB06.06.082.002";
PatientAID="%COMWEB06.06.086.090";
PatientIND="%COMWEB06.06.086.091";
PatientCUR="%COMWEB06.06.086.092";
PatientCLC="%COMWEB06.06.086.093.1";
PatientCLH="%STANDARD.01.017.CL";
PatientHFT="%COMWEB06.06.086.094";
PatientCDM="%COMWEB06.06.086.095";
PatientVDH="%COMWEB06.06.086.099.015";
InsertPatientHeader()
</script>
<div id=PatientMenu></div>
<table width=100% cellpadding=1 cellspacing=0 border=0>
<tr>
    <td class=HeadingCell align=right>
    <input type=button value="Discharge Summary UI" class=largebutton id="DisSummaryButton"
     onclick="tempDisable(this);LaunchNIHCIHIMyHRUpload();">
    <input type=button value="NIHC Summary" class=button id="NIHCSummaryButton"
     onclick="tempDisable(this);invokeNIHCSummary();">
    <input type=button value="MyHR Viewer" class=button id="MyHRViewerButton"
     onclick="tempDisable(this);invokeMyHRViewer();">
    <input type=button value="Refresh Page" class=button
     onclick="location.href='%COMWEB06.06.001.comweb06.06.001'">
    <input type=button value="Clear IHI" class=button 
     name=clearbut id=clearbut
     onclick="tempDisable(this);
              alert('NIHC IHI webservice Clear Sent');
              AddForm.updttype.value = 'C';
              AddForm.submit();"> 
    <input type=button value="Get IHI" class=button
     name=getbut id=getbut
     onclick="tempDisable(this);
              alert('NIHC IHI webservice Get Sent');
              AddForm.updttype.value = 'G';
              AddForm.submit();">
    </td>
</table>
<div id=TableLocation></div>

<script type="text/javascript">
function AddTableRows() {
%COMWEB06.06.101
}
</script>

<form name=AddForm action="comweb06.pbl" method=get>
<input type=hidden name=reportno value=6>
<input type=hidden name=template value=001>
<input type=hidden name=updttype value="C">
<input type=hidden name=redirect value="%COMWEB06.06.001.comweb06.06.001">
<input type=hidden name=urnumber value="%COMWEB06.06.003">
<input type=hidden name=admissno value="%COMWEB06.06.081">
<input type=hidden name=nextpage value="1">
</form>

<form name=PatientLinks method=get>
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=001>
<input type=hidden name=urnumber value="%COMWEB06.06.003">
<input type=hidden name=admissno value="%COMWEB06.06.081">
<input type=hidden name=MenuType value="%COMWEB06.06.088">
</form>

<form name=NIHCIHIForm>
<input type=hidden name=nihcurno id=nihcurno value="%COMWEB06.06.003">
<input type=hidden name=nihcvisn id=nihcvisn value="%COMWEB06.06.081">
<input type=hidden name=nihchosp id=nihchosp value="%COMWEB06.06.102">
<input type=hidden name=nihcrole id=nihcrole value="%COMWEB06.06.103">
<input type=hidden name=nihcuser id=nihcuser value="%STANDARD.01.008">
<input type=hidden name=nihcmurl id=nihcmurl value="%COMWEB06.06.104">
<input type=hidden name=nihcpurl id=nihcpurl value="%COMWEB06.06.105">
<input type=hidden name=nihchurl id=nihchurl value="%COMWEB06.06 106">
</form>
