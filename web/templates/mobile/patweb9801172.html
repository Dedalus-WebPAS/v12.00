Content-Type: text/html
Cache-Control: no-cache


%START.OF.PAGE
//jsVersion  : V12.00.00
//========================================================================
// Program   : patweb9801172.html
//
// Written   : 24.10.2014 Brian Ackland
//
// Function  : Functions Used in medchart
//
// Version   :
//
// V11.03.01 07/02/2023  Don Nguyen     TSK 0912141
//           Modified to use iPad-styled dialog box for alerts instead of the
//           browser's standard alert dialog.
// V10.07.01 14.10.2015  B.G.Ackland    CAR 322680
//           Medication without Form causing javascript error
// V10.05.01 24/10/2014  B.G.Ackland    CAR 308538
//           MedChart Medication Sort Order Change 
//========================================================================
var jsonMedications;
function MedicationListView() {
  urnumber="%PATWEB98.01.003";
  admissno="%PATWEB98.01.081";
  wurl="MedchartServices.php?reportno=1"+
       "&urnumber="+urnumber.replace(/ /g,"") +
       "&admissno="+admissno.replace(/ /g,"") + 
       "&httprand=" + Math.random();
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", wurl, false);
  xmlHttp.send();
  if (xmlHttp.responseText.substr(0,5)=="ERROR"&&xmlHttp.status == 200) {
    alertify.alert(xmlHttp.responseText);
  } else {
    if (xmlHttp.responseText!=""&&xmlHttp.status == 200) {
      jsonMedications = eval("("+xmlHttp.responseText+")"); //convert text to javascript object
      ShowMedications();
    } else {
      alertify.alert("Medication Web Service Not available (MedchartServices.php): "+xmlHttp.status);
    }
  } 
}
function ShowMedications() {
 var rowCount=0;
 var Meds = new Table();
 for (var ErrorMessage in jsonMedications) {
   var ErrorCode=jsonMedications[ErrorMessage]['ErrorCode'];
   var ErrorMessage=jsonMedications[ErrorMessage]['Message'];
   if (!isWhitespace(ErrorCode)) {
     alertify.alert("MEDCHART RETURNED ERROR\n "+ErrorCode+"  =   "+ErrorMessage);
   }
 }
 for (var Medication in jsonMedications['SimpleMedications']) {
   var MedName=jsonMedications['SimpleMedications'][Medication]['Description'];
   var Form=jsonMedications['SimpleMedications'][Medication]['Form'];
   var LineStatus=jsonMedications['SimpleMedications'][Medication]['Status'].split(",");
   var PrescribedBy=jsonMedications['SimpleMedications'][Medication]['PrescribedBy']['DisplayName'];
   var Scheduled=jsonMedications['SimpleMedications'][Medication]['Schedule']['Description'];
   var FreqType=jsonMedications['SimpleMedications'][Medication]['Schedule']['FrequencyType'];
   var StartOn=jsonMedications['SimpleMedications'][Medication]['Schedule']['StartsOn'];
   StartDate=netDate(StartOn,"datetime");
   MedStat=LineStatus[0];
   RevStat=LineStatus[1];
   BlockStat=LineStatus[2];
   MedTypeCD='0';
   if (FreqType.match(/PRN/)) { MedTypeCD='1'; }
   if (typeof Form == "string") {
     if (Form.match(/Infusion/)) { MedTypeCD='2'; }
   } else {
     Form="";
   }
   Meds.addRow(MedTypeCD+MedName,MedName,MedStat,RevStat,
               BlockStat,PrescribedBy,Scheduled,StartDate,FreqType,Form);
 }
 SortOrderBy=0;
 SortSequence=0;
 Meds.rows.sort(StringSort);
 OS="<ul class=ListRes>" 
 OS += "<li class='ItemRes'><span class=MedType>Scheduled Medications</span></li>" 
 MedType="2";
 for (var i=0;i<Meds.rows.length;i++) {
   if (Meds.rows[i][2].match(/current/)) {
     if (MedType!=Meds.rows[i][0].substr(0,1)) {
        MedType=Meds.rows[i][0].substr(0,1);
        if (MedType=="1") {
          OS += "<li class='ItemRes'><span class=MedType>PRN Medications</span></li>" 
        }
        if (MedType=="2") {
          OS += "<li class='ItemRes'><span class=MedType>Infusion Medications</span></li>" 
        }
     }
     rowCount++;
     iconType='Pill';
     if (Meds.rows[i][9].match(/mouth wash/i)) iconType='Flask';
     if (Meds.rows[i][9].match(/oral liq/i))   iconType='Flask';
     if (Meds.rows[i][9].match(/inject/i))     iconType='Needle';
     if (Meds.rows[i][9].match(/infusion/i))   iconType='Drip';
     if (Meds.rows[i][9].match(/eye drop/i))   iconType='Dropper';
     OS += "<li class='ItemRes'>" +
           "<span class=show"+iconType+"Icon style='float:left;'></span>"+Meds.rows[i][1]+
           "<span class=ntWhen>"+Meds.rows[i][5]+"</span><br>" +
           "<span class=ntTimeframe>"+Meds.rows[i][6]+"</span>"+
           "<span class=ntWhen>"+Meds.rows[i][3]+"</span><br>"+
           "<span class=ntTimeframe>"+FormatCommentAge(Meds.rows[i][7])+"</span>"  +
           "<span class=ntWhen>"+FormatDate(Meds.rows[i][7])+"</span>"  +
           "</li>"
   }
 }
 if (rowCount==0) {
   ListLocation.innerHTML = "<ul class=ListNote>" +
       "<li class=ItemNote style='text-align:center;'>" + 
       "No Medications Found for this Patient Visit</li></ul>";
 } else {
   OS+="</ul>";
   ListLocation.innerHTML = OS;
 }
}
function FormatCommentAge(datetime) {
 if (isWhitespace(datetime)) { return "" }
 yyyy = datetime.substr(0,4);
 mm = datetime.substr(4,2);
 dd = datetime.substr(6,2);
 hh = datetime.substr(8,2);
 mi = datetime.substr(11,2);
 if (isWhitespace(hh)) hh="00"
 if (isWhitespace(mi)) hh="01"
 var thisDate= new Date(yyyy,parseInt(mm,10)-1,dd,hh,mi);
 var today= new Date();
 if (isWhitespace(clientOffsetTime)) { setServerDateTime(); }
 today.setTime(today.getTime() + parseInt(trim(clientOffsetTime),10));
 var one_min=1000*60
 var one_hour=1000*60*60
 var one_day=1000*60*60*24
 var one_week=1000*60*60*24*7
 var one_month=1000*60*60*24*30
 var one_year=1000*60*60*24*365
 mid=Math.ceil((today.getTime()-thisDate.getTime())/(one_min))
 hrd=Math.ceil((today.getTime()-thisDate.getTime())/(one_hour))
 dyd=Math.ceil((today.getTime()-thisDate.getTime())/(one_day))
 wkd=Math.ceil((today.getTime()-thisDate.getTime())/(one_week))
 mtd=Math.ceil((today.getTime()-thisDate.getTime())/(one_month))
 ytd=Math.ceil((today.getTime()-thisDate.getTime())/(one_year))
 if (ytd>2) return 'Scheduled '+ytd+' years ago';
 if (mtd>2) return 'Scheduled '+mtd+' months ago';
 if (wkd>2) return 'Scheduled '+wkd+' weeks ago';
 if (dyd>2) return 'Scheduled '+dyd+' days ago';
 if (hrd>2) return 'Scheduled '+hrd+' hours ago';
 if (-ytd>2) return "Start in "+ (-ytd)+' years';
 if (-mtd>2) return "Start in "+ (-mtd)+' months';
 if (-wkd>2) return "Start in "+ (-wkd)+' weeks';
 if (-dyd>2) return "Start in "+ (-dyd)+' days';
 if (-hrd>2) return "Start in "+ (-hrd)+' hours';
 if (mid<0) return  (-mid)+' minutes';
 return mid+' minutes ago';
}
