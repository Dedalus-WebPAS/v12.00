Content-Type: text/html
Cache-Control: no-cache

<!DOCTYPE HTML>
%START.OF.PAGE
<head>
<!--"TemplateVersion"  : "V12.00.00"
    "TemplateHome"     : "mobile"-->
<title>Create Clinical Document</title>
<link   rel="stylesheet"     href="../html/ipad/ipad.css" type="text/css" />
<link   rel="stylesheet"     href="../html/ipad/AutoSuggestionPopup/AutoSuggestionPopup.css" type="text/css"/>
<script type="text/javascript" src="../html/ipad/ipad.js"></script>
<script type="text/javascript" src="../html/ipad/AutoSuggestionPopup/AutoSuggestionPopup.class.js"></script>
<script type="text/javascript" src="../html/ipad/ipadform.js"></script>
<script type="text/javascript" src="../js/PrinterMapping.js"></script>
<script type="text/javascript" src="../js/CustomPrint.js"></script>
<script type="text/javascript" src="../js/CustomDocumentTemplates.js"></script>
<style type=text/css>
.selectAppend {
 position:absolute;
 width:420px;
 border:0px solid black;
 border-radius: 8px 8px;
 background:-webkit-gradient(linear, left top, left bottom, color-stop(0, #0e162a), color-stop(1, #000000));
}
.appendContent {
 background-color:white;
 width:390px;
 border-radius: 5px 5px;
 margin:10px;
 border:5px solid transparent;
}
</style>
</head>
<body id=root onload='init()' onunload='unLoadPage();'>
<div class=subMenu style='position:relative;display:none;' id=DocumentAction>
<form name="DocumentActions" action=patweb99.pbl method=get>
<span class=NavButton onclick='AppendResults();'>Latest Results</span>
<span class=NavButton onclick='SelectFromList("cliweb03.pbl",1,8);'>Selected Results</span>
<span class=NavButton onclick='SelectFromList("cliweb06.pbl",1,16);'>Selected Notes</span>
<span class=MenuLogo></span>
</form>
</div>

<div id=LetterContentSection style='display:none;width:100%;'>
  <form name=DataEntry>
    <textarea class=TinyMCE id=letterContent name=letterContent></textarea>
  </form>
</div>

<span id=LetterHeader>
<ul class='sectionList' style="margin-bottom:0px;">
  <li class='sectionItem'>
    <div style='text-align:center;font-family:Arial;' onclick='location.reload();'>
      %PATWEB98.01.002
      (%PATWEB98.01.019,  %PATWEB98.01.020,  %PATWEB98.01.021, %PATWEB98.01.003) <br />
    </div>
  </li>
</ul>

<form name=UpdateForm action=cliweb08.pbl method=post>
<input type=hidden name=reportno value="1">
<input type=hidden name=template value="1">
<input type=hidden name=nextpage value="1">
<input type=hidden name=redirect value="PROCESSING|OK">
<input type=hidden name=updttype value="A">
<input type=hidden name=draftdoc value="">
<input type=hidden name=sendfaxb value="1">
<input type=hidden name=save2pdf value="1">
<input type=hidden name=urnumber value="%PATWEB98.01.003">
<input type=hidden name=admissno value="%PATWEB98.01.081">
<input type=hidden name=corsp002 value="%STANDARD.01.015">
<input type=hidden name=corsp004 value="%STANDARD.01.016">
<input type=hidden name=corsp009 value='%STANDARD.01.009'>
<input type=hidden name=copyfkey value="">
<input type=hidden name=printfmt value="">
<ul class='sectionList'>
  <li class='sectionItem' id=documentTypeSection>
  <span class=labelText>document type</span>
  <span class=sectionText>
  <select class='Mandatory' name=corsp003 
   onchange='setDocumentType();' style='width:200px;'>
  <option></option>
  %STANDARD.01.007.wi
  </select>
  </span>
  </li>

  <li class='sectionItem' id=documentTemplateSection>
  <span class=labelText>template</span>
  <span class=sectionText>
  <select class='Mandatory' name=docttemp style='width:200px;'
   onchange='selectTemplate();'
   title='Document Template' ></select>
  </span>
  </li>
  <li class='sectionItem'>
  <span class=labelText>to</span>
  <span class=sectionText>
  <input type="text" size=40 id="corsp010" name="corsp010" 
   class="Mandatory" searchType="1" returnId="corsp008"
   value="" returnFn="setDocumentAddress()"
   onfocus="this.value='';" oninput="AutoSuggest();">
  <input type=hidden id=corsp008 name=corsp008 value="">
  </span>
  </li>

  <li class='sectionItem'>
  <span class=labelText>from</span>
  <span class=sectionText>%STANDARD.01.009
  </span>
  </li>

  <li class='sectionItem'>
  <span class=labelText>subject</span>
  <span class=sectionText>
  <input type=text name=corsp007 size=40 class=Mandatory>
  </span>
  </li>

  <li class='sectionItem'>
  <span class=labelText>send as</span>
  <span class=sectionText>
  <select name=sendtype title="Send Document Method" onchange='setSend(this);' class='SelectBig'>
  <option value=0></option>
  <option value=1>Fax</option>
  <option value=2>Email</option>
  </select>
  </span>
  </li>

  <li class='sectionItem' id=sendFaxNumber style='display:none'>
  <span class=labelText>fax number</span>
  <span class=sectionText>
  <input type=text name=sendtoph size=40></span>
  </li>

  <li class='sectionItem' id=sendEmailFrom style='display:none'>
  <span class=labelText>from</span>
  <span class=sectionText>
  <input type=text name=sendfrem size=40></span>
  </li>

  <li class='sectionItem' id=sendEmailTo style='display:none'>
  <span class=labelText>to</span>
  <span class=sectionText>
  <input type=text name=sendtoem size=40></span>
  </li>


  <li class='sectionItem'>
  <span class=labelText>printer</span>
  <span class=sectionText>
  <select name=selprint title="Printer" >
  <option></option>
  %STANDARD.01.001.PATWEB70.02
  </select>
  </span>
  </li>

  <li class='sectionItem'>
  <span class=labelText>copies</span>
  <span class=sectionText>
  <select name=nocopies title='Number of Copies' > </select>
  </span>
  <textarea style="display:none;" class="setLinefeeds" name=htmlline cols=195></textarea>
  </form>
  </li> 
</ul>
</span>
<form name=updateValues>
<input type=hidden name=fromName value="%STANDARD.01.009">
<input type=hidden name=signatureName value="%STANDARD.01.009">
<input type=hidden name=letterDate value="%STANDARD.01.015">
<input type=hidden name=expectedDischarge value="%PATWEB98.01.825.4">
</form>

<form name=DefaultValues style='display:none'>
 <input type=hidden name=patsname value="%PATWEB98.01.009">
 <input type=hidden name=patgname value="%PATWEB98.01.010">
 <input type=hidden name=pattitle value="%PATWEB98.01.005.1">
 <input type=hidden name=unitname value="%PATWEB98.01.124.0">
 <input type=hidden name=gpname   value="%PATWEB98.01.784.081">
 <input type=hidden name=gpcode   value="%PATWEB98.01.784.001">
 <input type=hidden name=gppname  value="%PATWEB98.01.785.004.0">
 <input type=hidden name=gppcode  value="%PATWEB98.01.785.001">
 <input type=hidden name=emvidoct value="%PATWEB98.01.887.002"> 
 <input type=hidden name=userfrom value="%STANDARD.01.009">
</form>

<form name=PatientLinks method=get>
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=004>
<input type=hidden name=urnumber value="%PATWEB98.01.003">
<input type=hidden name=admissno value="%PATWEB98.01.081">
<input type=hidden name=MenuType value="%PATWEB98.01.088">
</form>
<div id='-suggestion-panel-wrapper' style='display:none;'>
 <div id='-suggestion-panel-wrapper2' style='width:100%'>
  <ul id='-suggestion-table' style='width:100%'></ul>
 </div>
</div>
<div id="-append-list-wrapper" class=selectAppend  style='display:none;'>
 <div class="boxHeader">
  <span style="width:42px;margin-right:10px;margin-top:10px;" class="RightAlign SpanButtonBlue" 
   onclick="CloseAppend()">Close</span></div>
  <div id='-append-list' class="appendContent"></div>
</div>
<script type=text/javascript>
var PatientURN="%PATWEB98.01.003";
var PatientVIS="%PATWEB98.01.081";
var PatientNAM="%PATWEB98.01.002";
var PatientSTA="%PATWEB98.01.086.078";
var PatientALT="%PATWEB98.01.084";
var PatientSEX="%PATWEB98.01.019";
var PatientDOB="%PATWEB98.01.020";
var PatientAGE="%PATWEB98.01.021";
var PatientLOC="%PATWEB98.01.083";
var PatientPRI="%PATWEB98.01.086.066.1";
var PatientUNT="%PATWEB98.01.066.0";
var DoctorCOD="%PATWEB98.01.082.003";
var DoctorNAM="%PATWEB98.01.082.002";
var PatientAID="%PATWEB98.01.086.090";
var PatientIND="%PATWEB98.01.086.091";
var PatientCUR="%PATWEB98.01.086.092";
var PatientCLC="%PATWEB98.01.086.093.1";
var PatientCLH="%STANDARD.01.017.CL";
var PatientHFT="%PATWEB98.01.086.094";
var PatientCDM="%PATWEB98.01.086.095";
var PatientVDH="%PATWEB98.01.086.099.015";
var PatientVTY="%PATWEB98.01.905";
var PatientWRD="%PATWEB98.01.105.1";

// jsVersion  : V12.00.00
//
// Source Code:  ./ipad/patweb9801302.js
//
// Modification
//
// Version   Date       Responsible/Changes Made
//------------------------------------------------------------------------------
// V10.03.01 06.08.2013 B.G.Ackland CAR 289383
//                      New AJAXPostString2 to fix post encoding
// V10.03.04 02.07.2013 B.G.Ackland Align tran and Work Scripts
// V10.03.03 01.05.2013 B.G.Ackland Don't Hide Button CAR 284710
// V10.03.02 29.04.2013 B.G.Ackland Reset Buttons on Page Unload
// V10.01.01 04.12.2012 B.G.Ackland New Medical Record View Refresh
// V10.01.00 13/04/2012 Version change
// V10.00.00 13/04/2012 Created for Mobility Suite
//

var tinyMCE;
var enableAppendData=true;
var printFormat =new Array();
var subjectList =new Array();
var editDocument="";
var editDocumentURL="";
var editFlag=false;
var disableDraft=false;
//-----------------------------------------------------------------------------
// onload function to initial page startup
//-----------------------------------------------------------------------------
function init() {
  editDocument = top.getCookie('ClinicalDocument');
  if (editDocument!='')  editFlag=true;
  SetCopies(UpdateForm.nocopies,10);
  SetPrinterByPatient(UpdateForm.selprint,PatientVTY,PatientVIS,PatientWRD);
  showValidTypes();
  LoadPage();
  getEditDocument();
  document.body.style.height='3000px';
  document.body.style.backgroundColor='white';
  document.body.style.background='url()';
}
function DisableDraft() {
  disableDraft=true;
}
function EnableDraft() {
  disableDraft=false;
}
function DisableCarbonCopy() {
// No Carbon Copy Implemented for iPad
}
function EnableCarbonCopy() {
// No Carbon Copy Implemented for iPad
}
function DisableResults() {
  enableAppendData=false;
}
function EnableResults() {
  enableAppendData=true;
}
function setDocumentAddress() {
  if (!isWhitespace(UpdateForm.corsp008.value)) {
    theURL='patweb99.pbl?reportno=6&template=020'+
           '&pmhcp001='+UpdateForm.corsp008.value.replace(/ /g,'+')
    var xmlHttp = createHttpObject();
    xmlHttp.open("GET", theURL, false);
    xmlHttp.send();
    if (xmlHttp.status=="200") {
      setDoctorAddress(xmlHttp.responseText);
    } else {
      alertify.alert("GP Web Service Not Available or Configured")
    }
  }
}
function setDoctorAddress(hcpValues) {
  lc=document.getElementById('LetterContentSection');
  if (lc.style.display=='none') return;

  eval(hcpValues);
  var toSalutation='Dear '+trim(hcpTitle)+' '+trim(hcpSurname)+',';
  var toDoctor=trim(hcpTitle)+' '+trim(hcpGiven)+' '+trim(hcpSurname);
  var toAddress=hcpAddress1
  if (!isWhitespace(hcpAddress2)) toAddress+='<br>'+hcpAddress2
  if (!isWhitespace(hcpAddress3)) toAddress+='<br>'+hcpAddress3
  if (!isWhitespace(hcpAddress4)) toAddress+='<br>'+hcpAddress4
  toAddress+=trim(hcpAddress5)+' '+hcpPostcode
  toAddress+='<br><br>Fax : '+hcpFax
  if (tinyMCE.activeEditor) {
    tinyMCE.activeEditor.dom.setHTML('toSalutation', toSalutation);
    tinyMCE.activeEditor.dom.setHTML('toDoctor', toDoctor);
    tinyMCE.activeEditor.dom.setHTML('toAddress', toAddress);
  }
}
//------------------------------------------------------------
// Setup HTML Editor
//------------------------------------------------------------
function SetTinyMCE() {
  LoadTinyMCEResource(InitTinyMCE);
}
function InitTinyMCE() {
  var ToolBar=" undo redo | " +
              " fontselect fontsizeselect | bold italic underline strikethrough"+
              " alignleft aligncenter alignright alignjustify ";
  tinymce.init({
    resize: true,
    visual : true,
    statusbar: true,
    content_css : "../html/ipad/tinymce.css",
    fontsize_formats: "10pt 12pt 14pt 18pt 24pt 36pt",
    selector: "textarea.TinyMCE",
    paste_as_text: true,
    menubar: "",
    toolbar: ToolBar,
    plugins: [ "save preview table autoresize fullscreen template" ],
    init_instance_callback : "loadTemplate",
    custom_elements:"page-footer,page-body,page-header",
    templates: [ 
        {title: 'Clinical Notes', 
            description: 'Click Note to insert into document ', 
            url: '%EMRWEB02.01.001.patweb98.01.108'},
        {title: 'Latest Results', 
            description: 'Last 10 Diagnostic Results', 
            url: '%EMRWEB02.01.001.cliweb10.06.004'},
        {title: 'Diagnostic Results', 
            description: 'Click the Diagnostic Result to Insert or Remove Details', 
            url: '%EMRWEB02.01.001.cliweb03.01.013'}
    ]
  });
}
function getEditDocument() {
  if (editFlag) {
    theURL="cliweb08.pbl?reportno=1&template=31&detailky="+editDocument.replace(/ /g,"+")
    var xmlHttp = createHttpObject();
    xmlHttp.open("GET", theURL, false);
    xmlHttp.send();
    if (xmlHttp.status=="200") {
      UpdateForm.copyfkey.value=xmlHttp.responseText.split("|")[0];
      editDocumentURL=xmlHttp.responseText.split("|")[1];
      UpdateForm.corsp010.value=xmlHttp.responseText.split("|")[2];
      UpdateForm.corsp007.value=xmlHttp.responseText.split("|")[3];
      UpdateForm.corsp008.value=xmlHttp.responseText.split("|")[4];
      documentType=trim(xmlHttp.responseText.split("|")[5]);
      el = UpdateForm.corsp003
      for (i=0;i<el.options.length;i++) {
       if (trim(el.options[i].value.substr(0,3))==documentType) el.selectedIndex=i;
      }
      el.readonly = true;
      el.disabled = true;
      el = UpdateForm.docttemp
      el.className = "";
      el = document.getElementById('documentTemplateSection');
      el.style.display='none';

    } else {
      alertify.alert("Web Service Not Available. Check your Connection and Try Again.");
    }
  }
}
function setSend(el) {
 sendType=el.options[el.selectedIndex].value
 fs=document.getElementById("sendFaxNumber");
 fe=document.getElementById("sendEmailFrom");
 te=document.getElementById("sendEmailTo");
 fs.style.display='none';
 fe.style.display='none';
 te.style.display='none';
 if (sendType==1) {
   eval(setHCPDetails())
   fs.style.display='';
   UpdateForm.sendtoph.value=hcpFax.replace(/ /g,"");
 }
 if (sendType==2) {
   eval(setHCPDetails())
   fe.style.display='';
   te.style.display='';
   UpdateForm.sendtoem.value=hcpSurgeryEmail;
 }
}
function setHCPDetails() {
  theURL='patweb99.pbl?reportno=6&template=020'+
         '&pmhcp001='+UpdateForm.corsp008.value.replace(/ /g,'+')
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
      return xmlHttp.responseText;
  } else {
    alertify.alert("GP Web Service Not Available or Configured")
    return;
  }
}
//-----------------------------------------------------------------------------
// onload function to initial page startup
//-----------------------------------------------------------------------------
function unLoadPage() {
  var actionBtn = parent.document.getElementById('actionButton');
  actionBtn.className = actionBtn.className.replace(/Blue/g,"");
  actionBtn.innerText= 'Done';
  actionBtn.style.display = '';
  var actionBtnAlt = parent.document.getElementById('actionButtonAlt');
  actionBtnAlt.style.display = 'none';
}
function LoadPage() {
  SetCopies(UpdateForm.nocopies,10);
  var actionBtn = parent.document.getElementById('actionButton');
  if(actionBtn) {
    actionBtn.className = actionBtn.className.replace(/SpanButton/g,"");
    actionBtn.className = actionBtn.className.replace(/Blue/g,"");
    actionBtn.className = actionBtn.className + " SpanButtonBlue";
    actionBtn.innerText = "Continue";
    actionBtn.onclick = function() { editLetter() }
  }
}
function editLetter() {
  if (enableAppendData) {
    var DocumentAction = document.getElementById('DocumentAction');
    DocumentAction.style.display='';
  }
  var actionBtn = parent.document.getElementById('actionButton');
  var actionBtnAlt = parent.document.getElementById('actionButtonAlt');
  var bool = validateMandatory(UpdateForm);
  if(bool) {
    if(actionBtn) {
      actionBtn.className = actionBtn.className.replace(/SpanButton/g,"");
      actionBtn.className = actionBtn.className.replace(/Blue/g,"");
      actionBtn.className = actionBtn.className + " SpanButtonBlue";
      if (disableDraft) {
        actionBtn.innerText = "Cancel";
        actionBtn.onclick = function() { parent.CloseDocument(); }
      } else {
        actionBtn.innerText = "Save as Draft";
        actionBtn.onclick = function() { CreateDocument('D') }
      }
      actionBtn.onclick = function() { CreateDocument('D') }
      actionBtnAlt.className = actionBtnAlt.className.replace(/SpanButton/g,"");
      actionBtnAlt.className = actionBtnAlt.className.replace(/Blue/g,"");
      actionBtnAlt.className = actionBtnAlt.className + " SpanButtonBlue";
      actionBtnAlt.style.display = "";
      actionBtnAlt.innerText = "Save as Final";
      actionBtnAlt.onclick = function() { CreateDocument('F') }
    }
   el=UpdateForm.docttemp
   lh=document.getElementById('LetterHeader');
   lc=document.getElementById('LetterContentSection');
   lh.style.display='none';
   lc.style.display='';
   //lc.style.position='fixed';
   setTimeout(function() { SetTinyMCE(); },100);
  }
}
//-----------------------------------------------------------------------------
// submit list of services to server
//-----------------------------------------------------------------------------
function CreateDocument(documentStatus) {
  var bool = validateMandatory(UpdateForm);
  UpdateForm.htmlline.value = tinyMCE.get('letterContent').getContent({format : 'raw'});
  if (documentStatus=="D") {
    UpdateForm.draftdoc.value="1";
    UpdateForm.sendtype.selectedIndex=0;
  }
  if(bool) {
    theURL=document.UpdateForm.action;
    var postStr=AJAXPostString2(document.UpdateForm)
    var xmlHttp = createHttpObject();
    xmlHttp.open("POST", theURL, false);
    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset:UTF-8");
    xmlHttp.send(postStr);
    if (xmlHttp.status=="200") {
      if (xmlHttp.responseText.match(/PROCESSING|OK/i)) {
        parent.frames['PatFrame'].refreshScreen();
        parent.CloseDocument();
      } else {
        alertify.alert(xmlHttp.responseText.replace(/.*alert../i,"").replace(/.\).*/i,""));
      }
    } else {
      alertify.alert("Web Service Not Available. Check your Connection and Try Again.");
    }
  }
  return bool
}
//-----------------------------------------------------------------------------
// set options for number of copies
//-----------------------------------------------------------------------------
function SetCopies(ListItem,MaxCopy) {
  for (i=1;i<MaxCopy;i++) {
    ListItem.options[ListItem.options.length]=new Option(i,i);
  }
}
function updateDocumentValues() {
  el=document.updateValues
  for (i=0;i<el.length;i++) {
    tinyMCE.activeEditor.dom.setHTML(el[i].name, el[i].value);
  }
}
function selectTemplate() {
    el=UpdateForm.docttemp;
    UpdateForm.printfmt.value=printFormat[el.selectedIndex];
    setSubjectTo("TEXT",subjectList[el.selectedIndex]);
}
function loadTemplate() {
//  tinyMCE.execCommand('mceFullScreen');
  if (editFlag) {
      var xmlHttp = createHttpObject();
      xmlHttp.open("GET", editDocumentURL, false);
      xmlHttp.send();
      tinyMCE.get('letterContent').setContent(xmlHttp.responseText);
      updateDocumentValues();
      setDocumentAddress();
  } else {
    lc=document.getElementById('LetterContentSection');
    if (lc.style.display=='none') return;
    el=UpdateForm.docttemp;
    page=el.options[el.selectedIndex].value;
    UpdateForm.printfmt.value=printFormat[el.selectedIndex];
    setSubjectTo("TEXT",subjectList[el.selectedIndex]);
    if (isWhitespace(page)) return;
    theURL=page+'&urnumber='+UpdateForm.urnumber.value.replace(/ /g,"+")+
           '&admissno='+UpdateForm.admissno.value.replace(/ /g,"+")
    var xmlHttp = createHttpObject();
    xmlHttp.open("GET", theURL, false);
    xmlHttp.send();
    if (xmlHttp.status=="200") {
      tinyMCE.get('letterContent').setContent(xmlHttp.responseText);
      setDocumentAddress();
    } else {
      alertify.alert("Web Service Not Available. Check your Connection and Try Again.");
    }
  }
}
function setSubjectTo(typeStr,valueStr) {
  if (!isWhitespace(valueStr)) {
    el=UpdateForm.corsp007
    switch (typeStr) {
      case "TEXT":
        el.value=valueStr;
        break;
      case "UNIT":
        el.value=trim(DefaultValues.unitname.value) + " " + valueStr;
        break;
    }
  }
}
function setSendTo(typeStr,valueStr) {
  el=UpdateForm.corsp010
  switch (typeStr) {
    case "TEXT":
      el.value=valueStr;
      el.onfocus="";
      el.oninput="";
      break;
    case "HCP":
      el.value=DefaultValues.gpname.value;
      UpdateForm.corsp008.value=DefaultValues.gpcode.value;
      el.onfocus=function () { this.value=''; } ;
      el.oninput=function () { AutoSuggest(); };
      break;
    case "PATIENT":
      el.value=trim(DefaultValues.pattitle.value) + " " +
               trim(DefaultValues.patgname.value) + " " +
               trim(DefaultValues.patsname.value)
      el.onfocus=""
      el.oninput="";
      break;
  }
}
function clearDocumentTemplate() {
  el=UpdateForm.docttemp
  el.options.length=0;
  printFormat.length=0;
  subjectList.length=0;
}
function addDocumentTemplate(nameStr,valueStr,printFmt,subjectTxt) {
  el=UpdateForm.docttemp
  printFormat[el.options.length]=printFmt;
  subjectList[el.options.length]=subjectTxt;
  el.options[el.options.length]=new Option(nameStr,valueStr);
}
function EditDocument(DocumentURL) {
  theURL=DocumentURL;
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    tinyMCE.get('letterContent').setContent(xmlHttp.responseText);
  } else {
    alertify.alert("Web Service Not Available. Check your Connection and Try Again.");
  }
}

//
// Append Notes/Results
//
function RemoveSingle(theURL) {
  resultKey=theURL.replace(/.*resultky=/,"")
  tinyMCE.activeEditor.dom.remove('cr'+resultKey);
}
function AddClinicalNote(theField, theKey,theText) {
    if (theField.style.backgroundColor!="") {
      theField.style.backgroundColor="";
      tinyMCE.activeEditor.dom.remove('cn'+theKey);
    } else {
      theField.style.backgroundColor="grey";
      var el=tinyMCE.activeEditor.dom.get('clinicalNotes');
      if (el == null) {
        tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 
        'span', {id : 'cr'+resultKey}, xmlHttp.responseText);
      } else {
        tinyMCE.activeEditor.dom.add(el, 'span', {id : 'cn'+theKey}, theText);
      }
      var myNode = tinyMCE.activeEditor.getDoc().getElementById('cn'+theKey)
      myNode.scrollIntoView(false);
    }
}
function AppendSingle(theURL) {
  var resultKey=theURL.replace(/.*resultky=/,"")
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    var el=tinyMCE.activeEditor.dom.get('clinicalResultsSection');
    if (el == null) {
      tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 
       'span', {id : 'cr'+resultKey}, xmlHttp.responseText);
    } else {
      tinyMCE.activeEditor.dom.add(el, 'span', {id : 'cr'+resultKey}, xmlHttp.responseText);
    }
    var myNode = tinyMCE.activeEditor.getDoc().getElementById('cr'+resultKey)
    myNode.scrollIntoView(false);
  } else {
    alert("Results Web Service Not Available or Configured")
  }
}
function AppendResults() {
  var xmlHttp = createHttpObject();
  var confirmMsg="This will append the latest 10 clinical results for this patient visit.\n"+
             "It should be done after you have completed the rest of the discharge summary.\n"+
             "Click Ok to Continue"
  alertify.confirm(confirmMsg, function (e) {    
    if (e) {        
      page="cliweb10.pbl?reportno=06&template=004"
      theURL=page+'&urnumber='+UpdateForm.urnumber.value.replace(/ /g,"+")+
                  '&admissno='+UpdateForm.admissno.value.replace(/ /g,"+")
      xmlHttp.open("GET", theURL, false);
      xmlHttp.send();
      if (xmlHttp.status=="200") {
        var el=tinyMCE.activeEditor.dom.get('clinicalResultsSection');
        if (el == null) {
          tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 
            'span', {id : 'clinicalResults'}, xmlHttp.responseText);
        } else {
          tinyMCE.activeEditor.dom.add(el, 'span', {id : 'clinicalResults'}, xmlHttp.responseText);
        }
        var myNode = tinyMCE.activeEditor.getDoc().getElementById('clinicalResults')
        myNode.scrollIntoView(false);
      } else {
        alertify.alert("Results Web Service Not Available or Configured")
      }
    }
  } );
}
function SelectFromList(ws,wr,wt) {
  wurl=ws+"?reportno="+wr+"&template="+wt+
       "&urnumber=" + document.PatientLinks.urnumber.value.replace(/ /g,"+") +
       "&admissno=" + document.PatientLinks.admissno.value.replace(/ /g,"+") +
       "&reslnkyr=ally" + 
       "&httprand=" + Math.random();
  var h = document.getElementsByTagName("head")[0];
  var s = document.createElement("script");
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", wurl, false);
  xmlHttp.send();
  if (xmlHttp.responseText!=""&&xmlHttp.status == 200) {
    s.type="text/javascript";
    h.appendChild(s);
    s.text=xmlHttp.responseText;
    if (ws=="cliweb03.pbl") {
      ShowResultsList();
    } else {
      ShowNotesList();
    }
  } else {
    alert("Notes Web Service Not available cliweb06.pbl");
  }
}
function ShowNotesList() {
 t = new Table();
 AddNoteRows();
 SortOrderBy=0;
 t.rows.sort(RevStringSort);
 OS= "<ul class=ListNote>" 
 for(var i = 0; i < t.rows.length; i++) {
   theText="<b>Entered by " +t.rows[i][1]+" at "+ FormatDateTime(t.rows[i][0]) + "</b>" +
           "<br>"+ t.rows[i][10].replace(/\'/g,"`");  
   if (typeof appendNotesFormat != "undefined") {
     if (appendNotesFormat=="1") {
       theText="<b>"+t.rows[i][9]+" Note:</b><br>" +
               "<br>"+ t.rows[i][10].replace(/\'/g,"`");
     } 
   } 
   OS += "<li class=ItemNote onclick=\"AddClinicalNote(this,'"+i+"','"+theText+"');\">" +
         "<div class=ntRow><span class=ntWho>"+t.rows[i][1]+"</span>" +
         "<span class=ntType>"+t.rows[i][9]+"</span></div><br>" 
   OS += "<span class=ntWhat>"
   if (!isWhitespace(t.rows[i][5]))  OS += t.rows[i][5]
   if (!isWhitespace(t.rows[i][6]))  OS += ", "+t.rows[i][6]
   if (!isWhitespace(t.rows[i][7]))  OS += ", "+t.rows[i][7]
   if (!isWhitespace(t.rows[i][8]))  OS += ", "+t.rows[i][8]
   if (!isWhitespace(t.rows[i][10])) OS += "\n"+t.rows[i][10].replace(/<br>/gi," ")
   OS += "</span>"  +
         "<div class=ntRow><span class=ntTimeframe>"+FormatCommentAge(t.rows[i][0])+"</span>"  +
         "<span class=ntWhen>"+FormatDateTime(t.rows[i][0])+"</span></div>"  
   OS += "</li>"
 }
 OS+='</ul>';

 var lp = document.getElementById("-append-list-wrapper");
 var ll = document.getElementById("-append-list");
 lp.style.position = "absolute";
 lp.style.display = "";
 lp.style.top = "1px";
 lp.style.right = "1px";
 lp.style.marginRight = "1px";
 lp.style.marginTop = "1px";
 lp.style.width = "420px";
 ll.style.width = "390px";
 ll.innerHTML = OS;
 if (t.rows.length == 0) {
   ll.innerHTML += "<ul class=ListNote>" +
                             "<li class=ItemNote style='text-align:center;'>" + 
                             "No Notes Recorded for this Patient</li>"+
                             "<li class=ItemRes></li></ul>"
 }
}
function ResultLink(el,url) {
  if (el.style.backgroundColor=="") {
    el.style.backgroundColor="grey";
    AppendSingle(url);
  } else {
    el.style.backgroundColor="";
    RemoveSingle(url);
  }
}
function ShowResultsList() {
 t = new Table();
 AddResults();
 SortOrderBy=0;
 t.rows.sort(RevStringSort);
 OS= "<ul class=ListNote>" 
 for(var i = 0; i < t.rows.length; i++) {
   linkURL="'cliweb10.pbl?reportno=06&template=005&"+
           t.rows[i][0].replace(/.*resultky/,"resultky")+"'";
   OS += "<li class=ItemNote onclick=\"ResultLink(this,"+linkURL+");\">" +
         "<div class=ntRow>"+
         "<span style='display:inline-block' "+
         "class='showResultIcon"+t.rows[i][6].replace(/ /g,"")+"'></span>"+
         "<span class=ntWho>"+t.rows[i][2]+"</span>" +
         "<span class=ntType>"+t.rows[i][5]+"</span></div>" +
         "<span class=ntWhat>"+ t.rows[i][10]+ "</span>"  +
         "<span style='display:inline-block;float:right;' "+
         "class='showResultStatus"+t.rows[i][3]+"'></span>"  +
         "<div class=ntRow><span class=ntTimeframe>"+FormatCommentAge(t.rows[i][1])+"</span>"  +
         "<span class=ntWhen>"+FormatDateTime(t.rows[i][1])+"</span></div>"  +
         "</li>"
 }
 OS+='</ul>'

 var lp = document.getElementById("-append-list-wrapper");
 var ll = document.getElementById("-append-list");
 lp.style.position = "absolute";
 lp.style.display = "";
 lp.style.top = "1px";
 lp.style.right = "1px";
 lp.style.marginRight = "1px";
 lp.style.marginTop = "1px";
 lp.style.width = "420px";
 ll.style.width = "390px";
 ll.innerHTML = OS;

 if (t.rows.length == 0) {
   ll.innerHTML += "<ul class=ListNote>" +
                   "<li class=ItemNote style='text-align:center;'>" + 
                   "No Result Recorded for this Patient </li>"
                   "<li class=ItemRes></li></ul>"
 }
}
function CloseAppend() {
 var lp = document.getElementById("-append-list-wrapper");
 var ll = document.getElementById("-append-list");
 lp.style.display="none";
 ll.innerHTML="";
}


</script>
</body>
