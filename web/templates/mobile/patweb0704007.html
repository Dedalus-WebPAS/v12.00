Content-Type: text/html
Cache-Control: no-cache

<!doctype html>
<html>
<head>	
<!--"TemplateVersion"  : "V12.00.00"
    "TemplateHome"     : "mobile"-->
<script type="text/javascript" src="../html/ipad/ipad.js"> </script>
<script type="text/javascript" src="../html/ipad/ipadform.js"> </script>
<link   rel="stylesheet" href="../html/ipad/ipad.css" type="text/css">
%START.OF.PAGE
</head>
<body onload="setButtons();">
<ul class=sectionList>
  <li class=sectionItem>
  <div style='text-align:center;font-family:Arial;'>
  %PATWEB07.04.002
  (%PATWEB07.04.019,  %PATWEB07.04.020,  %PATWEB07.04.021, %PATWEB07.04.003) <br />
  </div>
  </li>
</ul>


<form name=UpdateForm action="patweb07.pbl" method=post >
<input type=hidden name=reportno value="4">
<input type=hidden name=template value=2>
<input type=hidden name=updttype value="A">
<input type=hidden name=nextpage value="5">
<input type=hidden name=urnumber value="%PATWEB07.04.003" id=urnumber>
<input type=hidden name=ccardno >
<input type=hidden name=currdate value="%STANDARD.01.013" id=currdate>
<input type=hidden name=admissno value="%PATWEB07.04.081" id=admission>
<ul class=sectionList>

  <li class=sectionItem>
  <span class="labelText">Concession Card Type </span>
  <span class="sectionText">
    <select name=pmccd002 class=Mandatory title="Card Type" 
     id=pmccd002 onChange='ChooseType();'>
    <option></option>
    %STANDARD.01.007.ct
    </select>
  </span></li>

  <li class=sectionItem>
  <span class="labelText">Concession Card Number</span>
  <span class="sectionText">
    <input type=text name=pmccd003 size=25 maxlength=20 
    id=pmccd003 class="Mandatory" title="Card Number" >
  </span></li>

  <li class=sectionItem>
  <span class="labelText">Card Expiry Date</span>
  <span class="sectionText">
    <input type=text name=pmccd004 size=12 maxlength=11 id=pmccd004
     class="Mandatory FutureDate" title="Card Expiry Date"
     onblur="checkDate(this,'Card Expiry Date')">
  </span></li>

  <li class=sectionItem id=DVAColor style='display:none'>
  <span class="labelText">DVA Card Colour</span>
  <span class="sectionText">
    <select name=pmccd005 title="DVA Card Colour" id=pmccd005>
    <option></option>
    %PATWEB07.04.106.2
   </select>
  </span></li>

</form>
</ul>

<ul class=sectionList>
  <li class=sectionItem>
  <div id=ListLocation></div>
  </li>
</ul>

<div id='-suggestion-panel-wrapper' style='display:none;'>
 <div id='-suggestion-panel-wrapper2' style='width:100%'>
  <ul id='-suggestion-table' style='width:100%'></ul>
 </div>
</div>
</body>
<script type="text/javascript">
function setButtons() {
 ShowList();
 var actionBtn = parent.document.getElementById('actionButton');
  if(actionBtn) {
    actionBtn.className = actionBtn.className.replace(/SpanButton/g,"");
    actionBtn.className = actionBtn.className.replace(/Blue/g,"");
    actionBtn.className = actionBtn.className + " SpanButtonBlue";
    actionBtn.innerText = "Save";
    actionBtn.onclick = function() {
        SubmitRequest();
     }
  }
}
function ShowList() {
 OS='<ul class=ListRes>'
 for(var i = 0; i < concessionCards.length; i++) {
   OS += "<li class=ItemRes onclick='setUpdate("+i+");'>" +
         "<span> "+concessionCards[i]['cardName']+"</span><br/>"+
         "<span class=subscriptLeft>Card No : "+concessionCards[i]['cardNo']+"  "+
         concessionCards[i]['cardColor']+"</span>"  +
         "<span class=subscriptRight>Expiry Date: "+
          FormatDate(concessionCards[i]['cardExpiry'])+"</span>"+
         "</li>"
 }
 OS+='</ul>'
 var ListLocation=document.getElementById("ListLocation");
 ListLocation.innerHTML = OS;
 if (concessionCards.length == 0) {
   ListLocation.style.display="none";
 }
}
function SubmitRequest() {
  if (ValidateCardType()) {
    var el;
    el=document.getElementById("pmccd002");
    var cardType=el.options[el.selectedIndex].value;
    var cardNo=document.getElementById("pmccd003").value;
    var cardExpiry=document.getElementById("pmccd004").value;
    if (isWhitespace(cardType)) {
      alertify.alert("Please Enter a Card Type");
      return
    }
    if (isWhitespace(cardNo)) {
      alertify.alert("Please Enter a Card Number");
      return
    }
    el=document.getElementById("pmccd005");
    var cardColor=el.options[el.selectedIndex].value;
    var PatientURN=document.getElementById("urnumber").value;
    var existingRecord=false;
    for (var i = 0; i < concessionCards.length; i++) {
      if (trim(cardType.substr(0,3))==trim(concessionCards[i]['cardType'].substr(0,3))) {
        var msgText="Click Ok to Replace Existing Concession Card Details.";
        existingRecord=true;
        var cardIndex=i;
        alertify.confirm(msgText, function(e) { 
          if (e) { 
            var deleteURL='patweb07.pbl?reportno=4&template=6&calltype=1&updttype=D'+
                          '&urnumber='+PatientURN.replace(/ /g,"+")+
                          '&pmccd002='+concessionCards[cardIndex]['cardType'].replace(/ /g,"+")+
                          '&pmccd003='+concessionCards[cardIndex]['cardNo'].replace(/ /g,"+")+
                          '&pmccd004='+concessionCards[cardIndex]['cardExpiry'].replace(/ /g,"+");
            var returnValue=RSExecute(deleteURL);
            if (returnValue.status==0) {
              var addURL='patweb07.pbl?reportno=4&template=6&calltype=1&updttype=A'+
                         '&urnumber='+PatientURN.replace(/ /g,"+")+
                         '&pmccd002='+cardType.replace(/ /g,"+")+
                         '&pmccd003='+cardNo.replace(/ /g,"+")+
                         '&pmccd004='+cardExpiry+
                         '&pmccd005='+cardColor;
              returnValue = RSExecute(addURL);
              if (returnValue.status==0) {
                location.reload();
              }
            }
          } 
        } );
      }
    }
    if (!existingRecord) {
      var addURL='patweb07.pbl?reportno=4&template=6&calltype=1&updttype=A'+
                 '&urnumber='+PatientURN.replace(/ /g,"+")+
                 '&pmccd002='+cardType.replace(/ /g,"+")+
                 '&pmccd003='+cardNo.replace(/ /g,"+")+
                 '&pmccd004='+cardExpiry+
                 '&pmccd005='+cardColor;
      var returnValue = RSExecute(addURL);
      if (returnValue.status==0) {
        location.reload();
      }
    }
  }
}
function setUpdate(i) {
  var cardType = document.getElementById('pmccd002');
  for (var j=0;j<cardType.options.length;j++) {
    if (cardType.options[j].value.substr(0,3)==concessionCards[i]['cardType'].substr(0,3)) {
      cardType.selectedIndex=j;
    }
  }
  ChooseType()
}
function ChooseType() {
  var cardType = document.getElementById('pmccd002');
  var cardTypeCode = cardType.options[cardType.selectedIndex].value;
  var currdate = document.getElementById('currdate');
  DefaultDate(cardTypeCode,currdate);
  var expiryIndicator = cardTypeCode.substring(6,7); // expire not mandatory if = 1
  var dvaIndicator=cardTypeCode.substr(3,1);
  var dvaField = document.getElementById('DVAColor');
  var ExpDate = document.getElementById('pmccd004');
  dvaField.style.display='none';
  if(dvaIndicator == "3") { 
    dvaField.style.display='';
  }
  if(expiryIndicator == "1") { 
    ExpDate.className = "FutureDate"
  } else {
    ExpDate.className = "Mandatory FutureDate";
  }
  var cardNo=document.getElementById("pmccd003");
  var cardExpiry=document.getElementById("pmccd004");
  var cardColor=document.getElementById("pmccd005");
  cardNo.value="";
  cardExpiry.value="";
  cardColor.selectedIndex=0;
  for(var i = 0; i < concessionCards.length; i++) {
    if (concessionCards[i]['cardType'].substr(0,3)==cardTypeCode.substr(0,3)){
      cardNo.value=concessionCards[i]['cardNo'];
      cardExpiry.value=FormatDate(concessionCards[i]['cardExpiry']);
      for (var j=0;j<cardColor.options.length;j++) {
        if (cardColor.options[j].text.replace(/ /g,'')==concessionCards[i]['cardColor'].replace(/ /g,'')) {
          cardColor.selectedIndex=j;
        }
      }
    }
  }
}
function DefaultDate(ctyp,cdate) {
  if(ctyp.substr(3,1)=="2") {
    document.UpdateForm.pmccd004.value=("31 Dec " + cdate.value.substr(0,4));
  }
}
function ValidateCardType() {
  p=document.UpdateForm
  p.pmccd003.value=p.pmccd003.value.replace(/ /g,"");
  p.pmccd003.value=p.pmccd003.value.toUpperCase();
  p.ccardno.value=p.pmccd003.value.replace(/\+/g,"@");
  p.ccardno.value=p.ccardno.value.replace(/\%/g,"@");
  var serverURL = "../cgi-bin/comweb80.pbl?reportno=76" +
                  "&valdcode="+p.pmccd002.value.replace(/ /g,"+") +
                  "&valdcod2="+p.ccardno.value.replace(/&/g,"@")
  var returnValue = RSExecute(serverURL);
  if (returnValue.status!=0){
     return false;
  }
  return true;
}
var concessionCards=eval(%PATWEB07.04.111);
</script>
</body>
