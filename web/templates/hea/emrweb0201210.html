Content-Type: text/html
Cache-Control: no-cache

%START.OF.PAGE
<!DOCTYPE HTML>
<html>
<head>
<title>Emergency Discharge Summary</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="TemplateVersion" content="V12.00.00">
<meta name="TemplateHome" content="hea">
<meta name="CrossBrowser" content="true">
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&key=%STANDARD.01.044.124.161.050"></script>
<script type="text/javascript" src="../js/GoogleLibrary.js"> </script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/Standard.js"></script>
<script type="text/javascript" src="../js/Custom.js"></script>
<script type="text/javascript" src="../js/AutoSuggestionPopup/AutoSuggestionPopup.class.js"></script>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="../js/AutoSuggestionPopup/AutoSuggestionPopup.css" type="text/css">
<style type=text/css>
body { background-color:#eee; }
</style>
</head>
<body role=document onload="init();">
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid" role="main">
<div class="row">
 <div class="col-lg-1  hidden-md hidden-sm hidden-xs"></div>
 <div class="col-lg-10 col-md-12 col-sm-12 col-xs-12" style='background-color:white'>
 <div class="page-header">
  <h3>Emergency Patient Discharge Summary
   <small class='hidden-xs pull-right'>Attending Doctor: %EMRWEB02.01.172.002</small>
  </h3>
  <h5>%EMRWEB02.01.002 (%EMRWEB02.01.019, %EMRWEB02.01.020, %EMRWEB02.01.021)
   <span class='pull-right'>UR %EMRWEB02.01.003</span></h5>
  <h5>Arrived : %EMRWEB02.01.101.0 %EMRWEB02.01.102
   <span class='pull-right'>Visit %EMRWEB02.01.081</span> </h5>
 </div>
 </div>
 <div class="col-lg-1  hidden-md hidden-sm hidden-xs"></div>
</div>
<div class="row">
 <div class="col-lg-1  hidden-md hidden-sm hidden-xs"></div>
 <div class="col-lg-10 col-md-12 col-sm-12 col-xs-12" style='background-color:white'>
 <div class="row">
  <div class="col-md-3">
   <form name=UpdateForm action=cliweb08.pbl method=post>
    <input type=hidden name=reportno value="1">
    <input type=hidden name=template value="1">
    <input type=hidden name=nextpage value="1">
    <input type=hidden name=redirect value="PROCESSING|OK">
    <input type=hidden name=updttype value="A">
    <input type=hidden name=draftdoc value="">
    <input type=hidden name=sendfaxb value="1">
    <input type=hidden name=save2pdf value="1">
    <input type=hidden name=urnumber value="%EMRWEB02.01.003">
    <input type=hidden name=admissno value="%EMRWEB02.01.081">
    <input type=hidden name=corsp002 value="%STANDARD.01.015">
    <input type=hidden name=corsp003>
    <input type=hidden name=corsp004 value="%STANDARD.01.016">
    <input type=hidden name=copyfkey value="">
    <input type=hidden name=printfmt value="EDS01">
    <input type=hidden name=setdfprg value="EMRWEB02">
    <input type=hidden name=setdfrpt value="21">
    <input type=hidden name=sendtype value="0">

     <div class="form-group form-group-sm">
       <label class="control-label" for="corsp010">To</label>
        <input type="text" size=40 id="corsp010" name="corsp010" tabindex="6"
         class="mandatory form-control input-md" title="To"
         searchType="1" returnId="corsp008" returnFn="setDocumentAddress();"
         onclick='this.select();' onkeyup="AutoSuggest();">
        <input type=hidden id=corsp008 name=corsp008 value="">
      </div>

     <div class="form-group form-group-sm">
       <label class=control-label for=sendtoph>Fax Number</label>
       <input type=text name=sendtoph size=40 class="form-control input-md"
        title="Fax Number" value="" maxlength=20>
     </div>

     <div class="form-group form-group-sm">
       <label class="control-label" for="carbonCopy">2nd Copy To</label>
        <input type="text" size=40 id="carbonCopy" name="carbonCopy"
         tabindex="8" title="2nd Copy To" value=""
         class="form-control input-md"
         searchType="1" returnId="carbonCopyID" returnFn="setCarbonCopy();"
         onfocus="this.value='';" onkeyup="AutoSuggest();">
        <input type=hidden id=carbonCopyID name=carbonCopyID value="">
      </div>

     <div class="form-group form-group-sm">
       <label class=control-label for=copytoph>2nd Copy To Fax Number</label>
       <input type=text name=copytoph size=40 class="form-control input-md"
        title="2nd Copy To Fax Number" value="" maxlength=20>
     </div>

     <div class="form-group form-group-sm">
       <label class="control-label" for="carbonCopy3">3rd Copy To</label>
        <input type="text" size=40 id="carbonCopy3" name="carbonCopy3"
          tabindex="8"
          searchType="1" returnId="carbonCopyID3" title="3rd Copy To"
          value="" returnFn="setCarbonCopy3();" class="form-control input-md"
          onfocus="this.value='';" onkeyup="AutoSuggest();">
        <input type=hidden id=carbonCopyID3 name=carbonCopyID3 value="">
      </div>

     <div class="form-group form-group-sm">
       <label class=control-label for=copytop3>3rd Copy To Fax Number</label>
       <input type=text name=copytop3 size=40 class="form-control input-md"
        title="3rd Copy To Fax Number" value="" maxlength=20>
     </div>

     <div class="form-group form-group-sm">
       <label class=control-label for=corsp009>From</label>
       <input type=text name=corsp009 size=40 class="form-control input-md Mandatory" 
        title="Subject" readonly value='%STANDARD.01.009'>
     </div>

     <div class="form-group form-group-sm">
       <label class=control-label for=corsp007>Subject</label>
       <input type=text name=corsp007 size=40 class="form-control input-md Mandatory" 
        title="Subject" value='Emergency Attendance %STANDARD.01.015'>
     </div>

     <div class="form-group form-group-sm">
      <label for="DocumentType">Printer</label>
        <select class=form-control title=Printer name=selprint> 
        <option selected></option>
          %STANDARD.01.001.EMRWEB02.21
        </select>
     </div>

     <div class="form-group form-group-sm">
      <label for="nocopies">Copies</label>
      <select class=form-control id=nocopies name=nocopies title='Number of Copies'></select>
    </div>

    <textarea style="display:none;" class="setLinefeeds" cols=195
     name=htmlline id=htmlline></textarea>
   </form>
  </div>
   
   <div class="col-md-9">
    <form name=Editor>
        <textarea class=TinyMCE id=documentContent name=documentContent style='width:100%;'></textarea>
    </form>
   </div>

  </div>

  <div class='well well-sm' style='margin-top:20px;'>
    CSC Enterprise Health Solutions &copy; 2015
   <img src=../images/csc_44x25.png class='pull-right'>
  </div>

 </div>
 <div class="col-lg-1  hidden-md hidden-sm hidden-xs"></div>
</div>
</div>

<form name=DefaultValues style='display:none'>
 <input type=hidden name=patsname value="%EMRWEB02.01.009">
 <input type=hidden name=patgname value="%EMRWEB02.01.010">
 <input type=hidden name=pattitle value="%EMRWEB02.01.005.1">
 <input type=hidden name=unitname value="Emergency">
 <input type=hidden name=gpname   value="%EMRWEB02.01.684.081">
 <input type=hidden name=gpcode   value="%EMRWEB02.01.684.001">
 <input type=hidden name=gppname  value="%EMRWEB02.01.684.004.0">
 <input type=hidden name=gppcode  value="%EMRWEB02.01.684.001">
 <input type=hidden name=emvidoct value="%EMRWEB02.01.027.0">
 <input type=hidden name=userfrom value="%STANDARD.01.009">
 <input type=hidden name=gp_code   value="%EMRWEB02.01.684.001">
 <input type=hidden name=gp_practice value="%EMRWEB02.01.685.001">
 <input type=hidden name=gp_fax value="%EMRWEB02.01.684.040">
 <input type=hidden name=gp_prac_fax value="%EMRWEB02.01.685.016">
</form>

<form name=updateValues style='display:none'>
 <input type=hidden name=letterDate value="%STANDARD.01.015">
 <input type=hidden name=expectedDischarge value="%STANDARD.01.015">
</form>

<form name=PatientLinks method=get>
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=004>
<input type=hidden name=regexstm value=102>
<input type=hidden name=newstand value=1>
<input type=hidden name=urnumber value="%EMRWEB02.01.003">
<input type=hidden name=admissno value="%EMRWEB02.01.081">
<input type=hidden name=MenuType value="%EMRWEB02.01.088">
<input type=hidden name=emrgflag value="Y">
<input type=hidden name=nextpage value="4">
</form>

<div id='-suggestion-panel-wrapper' style='display:none;margin-top:20px;'>
 <div id='-suggestion-panel-wrapper2' style='width:100%'>
  <ul id='-suggestion-table' style='width:100%'></ul>
 </div>
</div>
<div class="modal fade" id=modalPage>
 <div class="modal-dialog">
  <div class="modal-content">
   <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">
    <span aria-hidden="true">&times;</span>
    <span class="sr-only">Close</span></button>
    <h4 class="modal-title" id=ModalTitle></h4>
   </div>
   <div class="modal-body" id=ModalBody>
    <iframe style='border:0' border=0 width="100%" height="480px" 
     name="ModalFrame" id="ModalFrame"></iframe>
   </div>
  </div>
 </div>
</div>

<script type=text/javascript>
var printFormat = new Array();
var subjectList = new Array();

function init() {
  SetAdmissionGP();
  SetCopies(UpdateForm.nocopies,10);

  document.UpdateForm.corsp003.value=EmergencyDischargeSummaryType;
  document.UpdateForm.corsp010.value=DefaultValues.gpname.value;
  document.UpdateForm.corsp008.value=DefaultValues.gpcode.value;

  if(!isWhitespace(DefaultValues.gp_practice.value)) {
    document.UpdateForm.sendtoph.value=DefaultValues.gp_prac_fax.value;
  } else {
    document.UpdateForm.sendtoph.value=DefaultValues.gp_fax.value;
  }

  LoadTinyMCEResource(InitTinyMCE);
}
function InitTinyMCE() {
  var ToolBar=" undo redo | " +
              " fontselect fontsizeselect | bullist bold italic underline strikethrough forecolor "+
              " backcolor alignleft aligncenter alignright alignjustify | fullscreen";
  tinymce.init({
    visual : false,
    content_css : "../html/tinymce-emrweb0201210-1.css", 
    fontsize_formats: "10pt 12pt 14pt 18pt 24pt 36pt",
    selector: "textarea.TinyMCE",
    paste_as_text: true,
    browser_spellcheck : true,
    menubar: "file tools table format view insert edit",
    plugins: [ "save preview table autoresize fullscreen template textcolor lists advlist" ],
    templates: [ 
        {title: 'Presentation Details', 
            description: 'Emergency Department Presentation Details',
            url: '%EMRWEB02.01.001.emrweb02.01.211'},
        {title: 'Medical History', 
            description: 'Patient Medical History',
            url: '%EMRWEB02.01.001.cliweb06.03.006'},
        {title: 'Medication Summary', 
            description: 'Discharge Medication Summary',
            url: '%EMRWEB02.01.001.cliweb06.01.018'},
        {title: 'Examinations', 
            description: 'Click Examination to insert into document ', 
            url: '../html/TemplateExaminations.html'},
        {title: 'Investigations', 
            description: 'Click Investigation to insert into document ', 
            url: '../html/TemplateInvestigations.html'},
        {title: 'Imaging', 
            description: 'Click Imaging to insert into document ', 
            url: '../html/TemplateImaging.html'},
//      {title: 'Clinical Notes', 
//          description: 'Click Note to insert into document ', 
//          url: '%EMRWEB02.01.001.patweb98.01.108'},
        {title: 'Clinical Notes', 
            description: 'Click Notes ', 
            url: '%EMRWEB02.01.001.cliweb06.05.006'},
        {title: 'Diagnostic Results', 
            description: 'Click the Diagnostic Result to Insert or Remove Details', 
            url: '%EMRWEB02.01.001.cliweb03.01.013'}
    ],
    table_default_styles: {
        width: '100%', border: '1px solid silver'
    },
    table_default_attributes: {
        border: '1', cellspacing: '0',cellpadding: '1'
    },
    toolbar: ToolBar,
    init_instance_callback : "LoadDocument",
    statusbar: true,
    removed_menuitems: "newdocument",
    custom_elements:"page-footer,page-body,page-header",

/*
    setup: function(ed) {
      ed.addMenuItem('results', {
        text: 'Append Latest Results',
        context: 'insert',
        onclick: function() {
          AppendResults();
        }
      });
      ed.addMenuItem('draft', {
        text:'Save as Draft',
        context: 'file',
        onclick: function() { CreateDocument('D'); }
      });
//    ed.addMenuItem('print', {
//      text:'Print and Save Draft',
//      context: 'file',
//      onclick: function() { CreateDocument('P'); }
//    });
//    ed.addMenuItem('save', {
//      text:'Print and Finalise',
//      context: 'file',
//      onclick: function() { CreateDocument('F'); }
//    });
      ed.addMenuItem('send', {
        text:'Finalise, Print and Send',
        context: 'file',
        onclick: function() { CreateDocument('S'); }
      });
      ed.addMenuItem('exit', {
        text:'Exit',
        context: 'file',
        onclick: function() { window.close(); }
      });
    }
*/

    //
    // TinyMCE 5 ...
    //
    menu: {
      file: { title: "File", items: "preview separator draft print save send separator exit" },
      insert: { title: "Insert", items: "template separator results" }
    },

    setup: function (ed) {
      /*
      ed.ui.registry.addMenuItem("save", {
        text: "Save",
        icon: "save",
        disabled: true,
        onSetup: function(api) {
          if (tinymce.activeEditor.isDirty()==true) {
            api.setDisabled(false);
          }
        },
        onAction: function() {
          tinymce.activeEditor.execCommand("mceSave");
        }
      });
      */


      // Separator menu item
      ed.ui.registry.addMenuItem("separator", {
        text: "|"
      });


      //
      // Insert menu items
      //
      ed.ui.registry.addMenuItem("results", {
        text: "Append Latest Results",
        icon: "plus",
        onAction: function() {
          AppendResults();
        }
      });


      //
      // File menu items
      //
      ed.ui.registry.addMenuItem("draft", {
        text: "Save as Draft",
        icon: "save",
        onAction: function() {
          CreateDocument('D');
        }
      });

      ed.ui.registry.addMenuItem("send", {
        text: "Finalise, Print and Send",
        icon: "checkmark",
        onAction: function() {
          CreateDocument('S');
        }
      });

      ed.ui.registry.addMenuItem("exit", {
        text: "Exit",
        icon: "close",
        onAction: function() {
          window.close();
        }
      });
    }
  });
}
function SetGpAddressNoPractice() {
  if(!isWhitespace(DefaultValues.gp_practice.value)) {  
    return; }
  if(isWhitespace(DefaultValues.gp_code.value)) {
    return; }
  if(DefaultValues.gpcode.value != DefaultValues.gp_code.value) {
     return;
  }
  setDocumentAddress();
}
function SetAdmissionGP() {
  var theURL="cliweb06.pbl?reportno=9&template=299"+
             "&urnumber="+document.PatientLinks.urnumber.value.replace(/ /g,"+")+
             "&admissno="+document.PatientLinks.admissno.value.replace(/ /g,"+");
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    var responseValue= xmlHttp.responseText.split('|');
    if (!isWhitespace(responseValue[0])) {
      document.DefaultValues.gpname.value=responseValue[0].replace(/\s+$/g,"") + ' ' +
                                          responseValue[1].replace(/\s+$/g,"") + ' ' +
                                          responseValue[2].replace(/\s+$/g,"") ;
      document.DefaultValues.gpcode.value=responseValue[3];
      document.UpdateForm.corsp010.value=DefaultValues.gpname.value;
      document.UpdateForm.corsp008.value=DefaultValues.gpcode.value;
      setDocumentAddress();
    }
  }
}
function LoadDocument() { 
  var theURL   = "cliweb08.pbl?reportno=7"+
                 "&docttype="+document.UpdateForm.corsp003.value+"&doctstat=3"+
                 "&urnumber="+document.PatientLinks.urnumber.value.replace(/ /g,"+")+
                 "&admissno="+document.PatientLinks.admissno.value.replace(/ /g,"+");
  var returnValue = RSExecute(theURL);
  if (returnValue.status == 0&&!isWhitespace(returnValue.return_value)) {
    LoadDraft(returnValue.return_value);
  } else {
    var theURL   = "emrweb02.pbl?reportno=1&template=303"+
                   "&urnumber="+document.PatientLinks.urnumber.value.replace(/ /g,"+")+
                   "&admissno="+document.PatientLinks.admissno.value.replace(/ /g,"+");
    var xmlHttp=new XMLHttpRequest(); // Firefox, Opera 8.0+, Safari
    xmlHttp.open("GET", theURL, false);
    xmlHttp.send();
    if (xmlHttp.status == 200) {
      tinyMCE.get('documentContent').setContent(xmlHttp.responseText);
    }
  }
  tinyMCE.activeEditor.selection.select(tinyMCE.activeEditor.dom.select('span#startElement')[0]);
  SetGpAddressNoPractice()
}
function DocumentAppend() {
  el=UpdateForm.appendDocument
  switch (el.options[el.selectedIndex].value) {
     case "1": {
       AppendResults();
       break; }
     case "2": {
       SelectFromList("cliweb03.pbl",1,13);
       break; }
     case "3": {
       SelectFromList("patweb98.pbl",1,108);
       break; }
  }

}
function SelectFromList(Server,ServerOpt,ServerTmp) {
  var t = document.getElementById('ModalTitle');
  t.innerText="Clinical Notes";
  PatientLinks.action=Server;
  PatientLinks.reportno.value=ServerOpt;
  PatientLinks.template.value=ServerTmp;
  PatientLinks.target="ModalFrame";
  PatientLinks.submit();
  $('#modalPage').modal("show");
}
function AddTextValue(id,text) {
  var el=tinyMCE.activeEditor.dom.get(id);
  tinyMCE.activeEditor.dom.setHTML(el, text);
}
function AddClinicalNote(theField, theKey,theText) {
    if (theField.style.backgroundColor=="grey") {
      tinyMCE.activeEditor.dom.remove('cn'+theKey);
      theField.style.backgroundColor=theField.getAttribute("saveBGC");
    } else {
      theField.setAttribute("saveBGC",theField.style.backgroundColor);
      theField.style.backgroundColor="grey";
      var el=tinyMCE.activeEditor.dom.get('clinicalNotes');
      if (el == null) {
         tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 
                                 'span', {id : 'cn'+theKey}, theText);
      } else {
        tinyMCE.activeEditor.dom.add(el, 'span', {id : 'cn'+theKey}, theText);
      }
      var myNode = tinyMCE.activeEditor.getDoc().getElementById('cn'+theKey) 
      myNode.scrollIntoView(false);
    }
}
function AppendSingle(theURL) {
  resultKey=theURL.replace(/.*resultky=/,"")
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    var el=tinyMCE.activeEditor.dom.get('clinicalResultsSection');
    if (el == null) {
      tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 
                   'span', {id : 'cr'+resultKey}, xmlHttp.responseText);
    } else {
      tinyMCE.activeEditor.dom.add(el, 'span', {id : 'cr'+resultKey}, xmlHttp.responseText);
    }
    var myNode = tinyMCE.activeEditor.getDoc().getElementById('cr'+resultKey) 
    myNode.scrollIntoView(false);
  } else {
    alert("Results Web Service Not Available or Configured")
  }
}
function RemoveSingle(theURL) {
  resultKey=theURL.replace(/.*resultky=/,"")
  tinyMCE.activeEditor.dom.remove('cr'+resultKey);
}
function AppendResults() {
  confirmMsg="This will append the latest 10 clinical results for this patient visit.\n"+
             "It should be done after you have completed the rest of the discharge summary.\n"+
             "Click Ok to Continue"
  if (confirm(confirmMsg)) {
    page="cliweb10.pbl?reportno=06&template=004"
    theURL=page+'&urnumber='+UpdateForm.urnumber.value.replace(/ /g,"+")+
                '&admissno='+UpdateForm.admissno.value.replace(/ /g,"+")
    xmlHttp.open("GET", theURL, false);
    xmlHttp.send();
    if (xmlHttp.status=="200") {
      var el=tinyMCE.activeEditor.dom.get('clinicalResultsSection');
      if (el == null) {
        tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(),   
              'span', {id : 'clinicalResults'}, xmlHttp.responseText);
      } else {
        tinyMCE.activeEditor.dom.add(el, 'span', {id : 'clinicalResults'}, xmlHttp.responseText);
      }
      var myNode = tinyMCE.activeEditor.getDoc().getElementById('clinicalResults') 
      myNode.scrollIntoView(false);
    } else {
      alert("Results Web Service Not Available or Configured")
    }
  }
}
function setDocumentAddress() {
  theURL='patweb99.pbl?reportno=6&template=020'+
         '&pmhcp001='+UpdateForm.corsp008.value.replace(/ /g,'+')
  xmlHttp = createHttpObject(); 
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    setDoctorAddress(xmlHttp.responseText);
  } else {
    alert("GP Web Service Not Available or Configured")
  }
}
function setDoctorAddress(hcpValues) {
  eval(hcpValues)
  insStr=trim(hcpTitle)+' '+trim(hcpGiven)+' '+trim(hcpSurname);
  tinyMCE.activeEditor.dom.setHTML('toDoctor', insStr);
  insStr='Dear '+trim(hcpTitle)+' '+trim(hcpSurname)+',';
  tinyMCE.activeEditor.dom.setHTML('toSalutation', insStr);
  insStr=hcpAddress1
  if (!isWhitespace(hcpAddress2)) insStr+='<br>'+hcpAddress2
  if (!isWhitespace(hcpAddress3)) insStr+='<br>'+hcpAddress3
  if (!isWhitespace(hcpAddress4)) insStr+='<br>'+hcpAddress4
  insStr+=trim(hcpAddress5)+' '+hcpPostcode
  insStr+='<br><br>Fax : '+hcpFax
  tinyMCE.activeEditor.dom.setHTML('toAddress', insStr);
  if(document.UpdateForm.sendtoph!=undefined) {
    document.UpdateForm.sendtoph.value=hcpFax;
  }
}
function setCarbonCopy() {
  if  (isWhitespace(UpdateForm.carbonCopyID.value)) {
    return; }
  theURL='patweb99.pbl?reportno=6&template=020'+
         '&pmhcp001='+UpdateForm.carbonCopyID.value.replace(/ /g,'+')
  xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    setCarbonCopyAddress(xmlHttp.responseText);
  } else {
    alert("GP Web Service Not Available or Configured")
  }
}
function setCarbonCopyAddress(hcpValues) {
  eval(hcpValues)
  insStr='CC: '+trim(hcpTitle)+' '+hcpGiven.substr(0,1)+' '+trim(hcpSurname)+'<br>';
  tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 'span', {id : 'ccName'+hcpSurname}, insStr);
  insStr=hcpAddress1
  if (!isWhitespace(hcpAddress2)) insStr+='<br>'+hcpAddress2
  if (!isWhitespace(hcpAddress3)) insStr+='<br>'+hcpAddress3
  if (!isWhitespace(hcpAddress4)) insStr+=',  '+hcpAddress4
  insStr+=trim(hcpAddress5)+' '+hcpPostcode+'<br><br>'
  tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 'span', {id : 'ccAddress'}, insStr);
  var myNode = tinyMCE.activeEditor.getDoc().getElementById('ccName'+hcpSurname)
  myNode.scrollIntoView(false);
  if(document.UpdateForm.copytoph!=undefined) {
    document.UpdateForm.copytoph.value=hcpFax;
  }
}
function setCarbonCopy3() {
  if  (isWhitespace(UpdateForm.carbonCopyID3.value)) {
    return; }
  theURL='patweb99.pbl?reportno=6&template=020'+
         '&pmhcp001='+UpdateForm.carbonCopyID3.value.replace(/ /g,'+')
  xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    setCarbonCopyAddress3(xmlHttp.responseText);
  } else {
    alert("GP Web Service Not Available or Configured")
  }
}
function setCarbonCopyAddress3(hcpValues) {
  eval(hcpValues)
  insStr='CC: '+trim(hcpTitle)+' '+hcpGiven.substr(0,1)+' '+trim(hcpSurname)+'<br>';
  tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 'span', {id : 'ccName3'+hcpSurname}, insStr);
  insStr=hcpAddress1
  if (!isWhitespace(hcpAddress2)) insStr+='<br>'+hcpAddress2
  if (!isWhitespace(hcpAddress3)) insStr+='<br>'+hcpAddress3
  if (!isWhitespace(hcpAddress4)) insStr+=',  '+hcpAddress4
  insStr+=trim(hcpAddress5)+' '+hcpPostcode+'<br><br>'
  tinyMCE.activeEditor.dom.add(tinyMCE.activeEditor.getBody(), 'span', {id : 'ccAddress3'}, insStr);
  var myNode = tinyMCE.activeEditor.getDoc().getElementById('ccName3'+hcpSurname)
  myNode.scrollIntoView(false);
  if(document.UpdateForm.copytop3!=undefined) {
    document.UpdateForm.copytop3.value=hcpFax;
  }
}
function LoadDraft(documentKey) {
  theURL="cliweb08.pbl?reportno=1&template=31&detailky="+documentKey.replace(/ /g,"+")
  xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
    UpdateForm.copyfkey.value=xmlHttp.responseText.split("|")[0];
    theURL=xmlHttp.responseText.split("|")[1];
    UpdateForm.corsp010.value=xmlHttp.responseText.split("|")[2];
    UpdateForm.corsp007.value=xmlHttp.responseText.split("|")[3];
    UpdateForm.corsp008.value=xmlHttp.responseText.split("|")[4].split("^")[0];
    UpdateForm.printfmt.value=xmlHttp.responseText.split("|")[4].split("^")[1];
    documentType=trim(xmlHttp.responseText.split("|")[5]);
    document.UpdateForm.corsp003.value=documentType;
    el = UpdateForm.docttemp
    xmlHttp.open("GET", theURL, false);
    xmlHttp.send();
    tinyMCE.get('documentContent').setContent(xmlHttp.responseText);
    updateDocumentValues();
  } else {
    alert("Web Service Not Available. Check your Connection and Try Again.");
  }
}
function updateDocumentValues() {
  el=document.updateValues
  for (i=0;i<el.length;i++) {
    tinyMCE.activeEditor.dom.setHTML(el[i].name, el[i].value);
  }
}
function setHCPDetails() {
  theURL='patweb99.pbl?reportno=6&template=020'+
         '&pmhcp001='+UpdateForm.corsp008.value.replace(/ /g,'+')
  el=UpdateForm.corsp010
  if (el.searchType=="8") {
    var cod=UpdateForm.corsp008.value.split("|")[0];
    var cnt=UpdateForm.corsp008.value.split("|")[1];
    theURL='patweb99.pbl?reportno=5&template=020'+
           '&pmhcg001='+cod.replace(/ /g,'+')
           '&pmhcg002='+cnt.replace(/ /g,'+')
  }
  xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
  if (xmlHttp.status=="200") {
      return xmlHttp.responseText;
  } else {
    alert("GP Web Service Not Available or Configured")
    return;
  }
}
//-----------------------------------------------------------------------------
// submit list of services to server
//-----------------------------------------------------------------------------
function CreateDocument(documentStatus) {
  tinyMCE.activeEditor.setProgressState(true);
  setTimeout(function() {SaveDocument(documentStatus);},50);
}
function SaveDocument(documentStatus) {
  var bool = validateMandatory(UpdateForm);
  if (documentStatus=="D") {
    UpdateForm.selprint.selectedIndex=0; // Disable Print of a Draft
  }
  if (documentStatus=="D"||documentStatus=="P") {
    UpdateForm.corsp008.value=UpdateForm.corsp008.value.replace(/ /g,"")+"^"+UpdateForm.printfmt.value
    UpdateForm.draftdoc.value="1";
  }
  UpdateForm.htmlline.value = tinyMCE.get('documentContent').getContent({format : 'raw'});
  //alert(UpdateForm.htmlline.value);
  if(bool) {
    theURL=document.UpdateForm.action;
//
    if ((documentStatus=='F'||documentStatus=="P"||documentStatus=="S")&&
         UpdateForm.selprint.selectedIndex<1) {
      if (!confirm("You have NOT selected a printer.\n Click Ok to Continue without Printing")) {
         tinyMCE.activeEditor.setProgressState(false);
         return;
      }
    }
    UpdateForm.sendtype.value="0";
    if(documentStatus=='S') {
       if(isWhitespace(document.UpdateForm.sendtoph.value)) {
         if(!confirm("You have NOT selected a fax number.\n" +
                     "Click Ok to Continue without sending a fax")) {
           tinyMCE.activeEditor.setProgressState(false);
           return;
         }
       }
       UpdateForm.sendtype.value="5";  // Finalise and fax 
    }
    var postStr=AJAXPostString(document.UpdateForm)
    xmlHttp = createHttpObject();
    xmlHttp.open("POST", theURL, false);
    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset:UTF-8");
    xmlHttp.send(postStr);
    if (xmlHttp.status=="200") {
      if (xmlHttp.responseText.match(/PROCESSING|OK/i)) {
        history.back();
      } else {
        alert(xmlHttp.responseText.replace(/.*alert../i,"").replace(/.\).*/i,""));
      }
    } else {
      alert("Web Service Not Available. Check your Connection and Try Again.");
      tinyMCE.activeEditor.setProgressState(false);
      return bool;
    }
    window.close();
  }
  return bool
}
//-----------------------------------------------------------------------------
// set options for number of copies
//-----------------------------------------------------------------------------
function SetCopies(ListItem,MaxCopy) {
  for (i=1;i<MaxCopy;i++) {
    ListItem.options[ListItem.options.length]=new Option(i,i);
  }
}
//========================================================================
// Format POST String for AJAX Form Post
//========================================================================
function AJAXPostString(el) {
  parameters="";
  for (i=0;i<el.length;i++) {
    switch (el[i].type) {
     case 'radio': {
       if (el[i].checked) {
         parameters+=el[i].name+"="+el[i].value+"&";
       }
       break; }
     case 'checkbox': {
       if (el[i].checked) {
         parameters+=el[i].name+"="+el[i].value+"&";
       }
       break; }
     case 'hidden': {
       parameters+=el[i].name+"="+el[i].value+"&";
       break; }
     case 'select-one': {
       if (el[i].selectedIndex!=-1) {
         parameters+=el[i].name+"="+el[i].options[el[i].selectedIndex].value +"&";
       }
       break; }
     case 'text': {
       parameters+=el[i].name+"="+el[i].value+"&";
       break; }
     case 'textarea': {
       if (el[i].className=="setLinefeeds") {
         textareaValue=setLinefeeds(el[i].value,el[i].cols);
         parameters+=el[i].name+"="+textareaValue+"&";
       } else {
         parameters+=el[i].name+"="+el[i].value+"&";
       }
       break; }
    }
  }
  parameters+='1=1';
  return parameters;
}
function setLinefeeds(textValue,colLength) {
  returnValue="";
  while (textValue.length>colLength) {
    if (textValue.lastIndexOf("\n",colLength)>0) {
      returnValue+=encodeURIComponent(textValue.substr(0,textValue.lastIndexOf("\n",colLength)))+"\n";
      textValue=textValue.substr(textValue.lastIndexOf("\n",colLength));
      continue;
    }
    if (textValue.lastIndexOf("\r",colLength)>0) {
      returnValue+=encodeURIComponent(textValue.substr(0,textValue.lastIndexOf("\r",colLength)))+"\n";
      textValue=textValue.substr(textValue.lastIndexOf("\r",colLength));
      continue;
    }
    if (textValue.lastIndexOf(" ",colLength)>0) {
      returnValue+=encodeURIComponent(textValue.substr(0,textValue.lastIndexOf(" ",colLength)))+"\n";
      textValue=textValue.substr(textValue.lastIndexOf(" ",colLength));
      continue;
    }
    if (textValue.lastIndexOf("&nbsp;",colLength)>0) {
      returnValue+=encodeURIComponent(textValue.substr(0,textValue.lastIndexOf("&nbsp;",colLength)))+"\n";
      textValue=textValue.substr(textValue.lastIndexOf("&nbsp;",colLength));
      continue;
    }
    returnValue+=encodeURIComponent(textValue.substr(0,colLength)+"\n");
    textValue=textValue.substr(colLength);
  }
  returnValue+=encodeURIComponent(textValue);
  return returnValue;
}
</script>
</body>
</html>
